<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/default-index/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="X14Nuy">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/default-index/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"default-index/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">X14Nuy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/10/xhs%E5%8E%BB%E6%B0%B4%E5%8D%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/10/xhs%E5%8E%BB%E6%B0%B4%E5%8D%B0/" class="post-title-link" itemprop="url">xhs去水印</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-10 09:02:43 / 修改时间：09:14:26" itemprop="dateCreated datePublished" datetime="2025-07-10T09:02:43+08:00">2025-07-10</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>293</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>跟着朋友的博客，复现了一下，找回了学安卓逆向的一点快乐&#x2F;(ㄒoㄒ)&#x2F;~~</p>
<p><a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-2044329-1-1.html">https://www.52pojie.cn/thread-2044329-1-1.html</a></p>
<p>简单来说，为图片添加水印用到了下面几个api。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1、Bitmap.compress：保存图片到磁盘时调用</span><br><span class="line"></span><br><span class="line">2、FileOutputStream.write：底层文件写</span><br><span class="line"></span><br><span class="line">3、Canvas.drawText：画布上写文字</span><br><span class="line"></span><br><span class="line">4、Canvas.drawBitmap：画布上绘制bitmap图像</span><br></pre></td></tr></table></figure>
<p>之后对这几个函数进行hook，将水印图片进行绕过。</p>
<p>若要持久化，把脚本改写成xposed模块即可。（下图无水印了）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250710091331057.png" alt="image-20250710091331057"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/09/%E6%9F%90%E7%BD%91%E7%AB%99%E8%A7%86%E9%A2%91%E7%88%AC%E5%8F%96-day3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/09/%E6%9F%90%E7%BD%91%E7%AB%99%E8%A7%86%E9%A2%91%E7%88%AC%E5%8F%96-day3/" class="post-title-link" itemprop="url">某网站视频爬取(day3)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-09 17:44:13 / 修改时间：17:44:52" itemprop="dateCreated datePublished" datetime="2025-07-09T17:44:13+08:00">2025-07-09</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="视频网站的工作原理"><a href="#视频网站的工作原理" class="headerlink" title="视频网站的工作原理"></a>视频网站的工作原理</h1><p>用用户上传一个视频，并不会被一次性保存，而是经过下面这几步。</p>
<p>**编码：**编码成不同质量级别、分辨率的多个版本。</p>
<p>**分块：**每个版本的视频都会被分割成连续的小视频片段，通常只有几秒钟，这些小片段通常采用<code>.ts</code>格式，也就是<code>MPEG</code>传输流。</p>
<p>**创建清单文件：**网站会创建一个“播放列表”文件作为索引，清单文件会告知视频播放器<code>.ts</code>数据块的顺序，一般使用的是<code>M3U8</code>文件作为清单文件。</p>
<p>**通过 CDN 分发：**所有这些 <code>.ts</code> 数据块和 <code>.m3u8</code> 播放列表都会上传到内容分发网络 (CDN)，该网络的服务器遍布全球。这确保了无论用户身在何处，都能快速交付。</p>
<h1 id="抓取流程分析"><a href="#抓取流程分析" class="headerlink" title="抓取流程分析"></a>抓取流程分析</h1><ol>
<li>找到m3u8文件。</li>
<li>通过m3u8下载所有ts文件。</li>
<li>合并ts文件。</li>
</ol>
<h1 id="爬取"><a href="#爬取" class="headerlink" title="爬取"></a>爬取</h1><h2 id="手工测试"><a href="#手工测试" class="headerlink" title="手工测试"></a>手工测试</h2><p>我选了一个视频网站进行爬取。——<a target="_blank" rel="noopener" href="https://www.ssrfun.com/">https://www.ssrfun.com</a></p>
<p><img src="/./assets/image-20250709143157935.png" alt="image-20250709143157935"></p>
<p>先不写脚本，看看能不能找到<code>.ts</code>文件的下载链接。</p>
<p>通过<code>XHR</code>过滤和抓包，能找到<code>index.m3u8</code>和<code>mixed.m3u8</code>。</p>
<p><img src="/./assets/image-20250709143337420.png" alt="image-20250709143337420"></p>
<p>先下载index.m3u8，存放了mixed.m3u8的地址。</p>
<p><img src="/./assets/image-20250709143528542.png" alt="image-20250709143528542"></p>
<p>再下载mixed.m3u8，这回可以找到视频的<code>.ts</code>文件了。</p>
<img src="./assets/image-20250709143556855.png" alt="image-20250709143556855" style="zoom:80%;" />

<p>下载其中一个<code>.ts</code>，得到的是视频的一个片段。</p>
<p><img src="/./assets/image-20250709143706618.png" alt="image-20250709143706618"></p>
<h2 id="脚本爬取"><a href="#脚本爬取" class="headerlink" title="脚本爬取"></a>脚本爬取</h2><p>分析一下脚本流程：</p>
<ol>
<li>获得视频链接，在返回的html中，存在m3u8文件的链接。</li>
<li>获得m3u8文件（A），读取并下载另一个m3u8文件（B）。</li>
<li>获得文件B，并解析获得ts文件的链接。</li>
<li>下载并合并所有ts文件。</li>
</ol>
<p>没有反爬、没有风控，还是很简单的。</p>
<p><img src="/./assets/image-20250709163057151.png" alt="image-20250709163057151"></p>
<p>之后使用ffmpeg进行合并。</p>
<p><img src="/./assets/image-20250709162152669.png" alt="image-20250709162152669"></p>
<p>顺带补了一下<code>asyncio.run</code>和<code>asyncio的事件循环</code>的关系。</p>
<p>在python3.7之前，需要手动创建事件循环并运行一个协程。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;World&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 手动挡操作 ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 获取（或创建）一个事件循环</span></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 2. 命令循环运行一个任务直到它完成</span></span><br><span class="line">    loop.run_until_complete(main())</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="comment"># 3. 手动关闭事件循环</span></span><br><span class="line">    loop.close()</span><br></pre></td></tr></table></figure>

<p>而async.run相当于自动挡，封装好了步骤。</p>
<ol>
<li><p>它会自动创建一个<strong>新的</strong>事件循环。</p>
</li>
<li><p>它会自动调用 <code>loop.run_until_complete()</code> 来运行你指定的协程。</p>
</li>
<li><p>它会自动处理所有后续的清理工作。</p>
</li>
<li><p>最后，它会自动<strong>关闭</strong>事件循环。</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/08/%E5%A3%81%E7%BA%B8%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E5%8D%8F%E7%A8%8B%E7%88%AC%E5%8F%96-day2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/08/%E5%A3%81%E7%BA%B8%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E5%8D%8F%E7%A8%8B%E7%88%AC%E5%8F%96-day2/" class="post-title-link" itemprop="url">壁纸多线程+协程爬取(day2)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-08 23:40:29 / 修改时间：23:42:23" itemprop="dateCreated datePublished" datetime="2025-07-08T23:40:29+08:00">2025-07-08</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h1><p>简单来说，协程可以把同步操作变成异步操作。</p>
<p>比方说，在写爬虫时，发送请求和等待回应会触发IO堵塞，如果是同步操作，线程就会一直等；而如果是异步操作，线程会切换到其它任务执行，而不是“闲等”。</p>
<p>常见的requests.get是同步操作，如果想切换成异步，需要安装aiohttp。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install aiohttp</span><br></pre></td></tr></table></figure>

<p>除此之外，关于一些其它的io操作也可以用协程，如：读写文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install aiofile</span><br></pre></td></tr></table></figure>

<p>关于python的asyncio的实现，其实就是使用select、poll、epoll等机制，监控文件描述符的状态，避免线程堵塞。</p>
<p>自Java21起，虚拟线程就是Java的协程实现。</p>
<p>协程可以极大的提高爬取的速率。</p>
<h1 id="爬取壁纸"><a href="#爬取壁纸" class="headerlink" title="爬取壁纸"></a>爬取壁纸</h1><p>我在网上找了一个壁纸网站。</p>
<p><a target="_blank" rel="noopener" href="https://haowallpaper.com/">https://haowallpaper.com</a></p>
<p>尝试用多线程、协程的方式，去爬取壁纸。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250708212829946.png" alt="image-20250708212829946"></p>
<p>单线程的爬取流程如下：</p>
<ol>
<li>解析每一页中，所有图片所在的子链接；</li>
<li>获取子链接中，图片的下载链接；</li>
<li>下载图片。</li>
</ol>
<p>在单线程的代码基础上把代码改成多线程，再将子链接分配给了具有4个线程的线程池，90张图片，花了将近160s。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250708221253143.png" alt="image-20250708221253143" style="zoom:80%;" />

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用ThreadPoolExecutor来管理线程</span></span><br><span class="line">       <span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=MAX_WORKERS) <span class="keyword">as</span> executor:</span><br><span class="line">           <span class="comment"># 将下载任务提交给线程池</span></span><br><span class="line">           <span class="comment"># executor.submit会立即返回一个future对象，代表这个未完成的操作</span></span><br><span class="line">           future_to_url = &#123;executor.submit(download_image, link): link <span class="keyword">for</span> link <span class="keyword">in</span> all_links&#125;</span><br><span class="line">           </span><br><span class="line">           <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(future_to_url):</span><br><span class="line">               url = future_to_url[future]</span><br><span class="line">               <span class="keyword">try</span>:</span><br><span class="line">                   result = future.result()</span><br><span class="line">               <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">                   <span class="built_in">print</span>(<span class="string">f&quot;链接 <span class="subst">&#123;url&#125;</span> 的任务执行时产生了一个异常: <span class="subst">&#123;exc&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>之所以如此之慢，因为每个线程在下载一个图片时，线程会等待I&#x2F;O设备接收完图片，再进行下一步处理。（I&#x2F;O堵塞）。</p>
<p>可以把协程视作I&#x2F;O多路复用的高级实现，每一个被async修饰的地方，相当于一个被监听描述符。</p>
<p>在I&#x2F;O堵塞时，使用协程的方式编程，线程便可以去做别的事情。比如：在下载图片时，线程能够切换任务，去发送另一个图片下载请求，这样一来，在同一时间内，这些图片同时下载，便可以节约大量时间。</p>
<p>在python中，要使用协程，在定义函数时、异步资源请求要使用async，而等待结果用await。</p>
<p>下面的代码仅供参考。</p>
<p><code>asyncio.gather</code>：可以接收1个或多个对象，然后放入事件循环中运行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">download_image_async</span>(<span class="params">session: aiohttp.ClientSession, sub_link: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    (异步) 工作协程，用于从给定的子链接下载单张图片。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        session (aiohttp.ClientSession): aiohttp的会话对象.</span></span><br><span class="line"><span class="string">        sub_link (str): 壁纸详情页的相对路径.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        filename = sub_link.split(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>] + <span class="string">&quot;.jpg&quot;</span></span><br><span class="line">        filepath = os.path.join(OUTPUT_DIR, filename)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(filepath):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;已存在: <span class="subst">&#123;filename&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        full_url = BASE_URL + sub_link</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 异步请求壁纸详情页</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(full_url, timeout=<span class="number">15</span>) <span class="keyword">as</span> response:</span><br><span class="line">            response.raise_for_status()</span><br><span class="line">            html_content = <span class="keyword">await</span> response.text()</span><br><span class="line"></span><br><span class="line">        soup = BeautifulSoup(html_content, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">        meta_tag = soup.find(<span class="string">&#x27;meta&#x27;</span>, attrs=&#123;<span class="string">&quot;property&quot;</span>: <span class="string">&quot;og:image&quot;</span>&#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> meta_tag <span class="keyword">or</span> <span class="keyword">not</span> meta_tag.get(<span class="string">&#x27;content&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;未找到链接: <span class="subst">&#123;sub_link&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        img_url = meta_tag.get(<span class="string">&#x27;content&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 异步请求并下载真实的图片文件</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(img_url, timeout=<span class="number">30</span>) <span class="keyword">as</span> img_response:</span><br><span class="line">            img_response.raise_for_status()</span><br><span class="line">            image_data = <span class="keyword">await</span> img_response.read()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 使用 aiofiles 异步写入文件</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(filepath, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">await</span> f.write(image_data)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;成功: <span class="subst">&#123;filename&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> asyncio.TimeoutError:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;超时错误: <span class="subst">&#123;sub_link&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">except</span> aiohttp.ClientError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;网络错误: <span class="subst">&#123;sub_link&#125;</span> - <span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;未知错误: <span class="subst">&#123;sub_link&#125;</span> - <span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">download_batch_async</span>(<span class="params">links_batch: <span class="type">List</span>[<span class="built_in">str</span>]</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    (异步) 创建一个 aiohttp 会话并并发执行一批下载任务。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession(headers=HEADERS) <span class="keyword">as</span> session:</span><br><span class="line">        tasks = [download_image_async(session, link) <span class="keyword">for</span> link <span class="keyword">in</span> links_batch]</span><br><span class="line">        results = <span class="keyword">await</span> asyncio.gather(*tasks, return_exceptions=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 打印结果用于调试</span></span><br><span class="line">        success_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> r <span class="keyword">in</span> results <span class="keyword">if</span> <span class="built_in">isinstance</span>(r, <span class="built_in">str</span>) <span class="keyword">and</span> r.startswith(<span class="string">&quot;成功&quot;</span>))</span><br><span class="line">        exist_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> r <span class="keyword">in</span> results <span class="keyword">if</span> <span class="built_in">isinstance</span>(r, <span class="built_in">str</span>) <span class="keyword">and</span> r.startswith(<span class="string">&quot;已存在&quot;</span>))</span><br><span class="line">        fail_count = <span class="built_in">len</span>(results) - success_count - exist_count</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;本批次处理完成 - 成功: <span class="subst">&#123;success_count&#125;</span>, 已存在: <span class="subst">&#123;exist_count&#125;</span>, 失败: <span class="subst">&#123;fail_count&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_thread_worker</span>(<span class="params">links_batch: <span class="type">List</span>[<span class="built_in">str</span>]</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    (同步) 每个线程的入口函数。</span></span><br><span class="line"><span class="string">    它会创建一个新的 asyncio 事件循环来运行分配给它的那批下载任务。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 在新线程中创建并设置新的事件循环</span></span><br><span class="line">    loop = asyncio.new_event_loop()</span><br><span class="line">    asyncio.set_event_loop(loop)</span><br><span class="line">    <span class="comment"># 运行异步任务直到完成</span></span><br><span class="line">    loop.run_until_complete(download_batch_async(links_batch))</span><br><span class="line">    loop.close()</span><br></pre></td></tr></table></figure>

<p>在加了协程后，任务会完成得非常快。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250708224844658.png" alt="image-20250708224844658" style="zoom:80%;" />

<p>我还做了个小实验，用“纯多线程”和“多线程 &amp; 单一协程”两种结构进行爬取，在这样的设置下，哪个下载速度会更快？（这里的后者含义是：每个线程只有一个协程）</p>
<p>答案是后者，来看看大模型给出的理由。</p>
<p>大致意思是：由于图片很小，本来一下子就能下载完，但普通的多线程下载涉及到I&#x2F;O堵塞，线程&#x2F;进程会被操作系统加入到堵塞线程队列中，然后操作系统会去执行其它的线程&#x2F;进程，等待I&#x2F;O设备的唤醒和操作系统的下一次调度；而在“多线程 &amp; 单一协程”的模式中，线程并没有被堵塞，而是会去执行事件循环，等到操作系统的通知——监听的事件是否完成，如果完成则立即处理。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250708232024160.png" alt="image-20250708232024160"></p>
<p>最后，看看壁纸！</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250708233913024.png" alt="image-20250708233913024"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/07/emo%E4%BA%91%E7%88%AC%E5%8F%96%E8%AF%84%E8%AE%BA-day1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/07/emo%E4%BA%91%E7%88%AC%E5%8F%96%E8%AF%84%E8%AE%BA-day1/" class="post-title-link" itemprop="url">emo云爬取评论(day1)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-07-07 23:44:59" itemprop="dateCreated datePublished" datetime="2025-07-07T23:44:59+08:00">2025-07-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-07-08 10:26:01" itemprop="dateModified" datetime="2025-07-08T10:26:01+08:00">2025-07-08</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>学习爬虫的第一天，目标：获得网易云音乐的评论信息。</p>
<h1 id="定位"><a href="#定位" class="headerlink" title="定位"></a>定位</h1><p>查看网页和框架的源代码，发现源代码中并没有评论信息，评论信息大概率是通过js后续加载的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707203651749.png" alt="image-20250707203651749" style="zoom:80%;" />

<p>浏览器在渲染了html文件后，会执行其中的js文件，这些js代码会向特定的api接口发送请求，比如下图，发送请求评论的请求。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707204113720.png" alt="image-20250707204113720"></p>
<p>请求头是这样的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707204929052.png" alt="image-20250707204929052" style="zoom:80%;" />

<p>负载是这样的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707204959521.png" alt="image-20250707204959521"></p>
<p>如果要爬取评论，需要完成下面3件事情。</p>
<ol>
<li>找到未加密的参数来源。</li>
<li>对参数进行加密（符合网易的加密逻辑），充当负载部分。</li>
<li>发送请求，获得评论。</li>
</ol>
<h1 id="参数来源"><a href="#参数来源" class="headerlink" title="参数来源"></a>参数来源</h1><p>在浏览器的开发工具中，启动器可以查看发出这个请求之前，执行了哪些js脚本。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707210446871.png" alt="image-20250707210446871"></p>
<p>点开了最后一个执行的js文件，下断点。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707213804782.png" alt="image-20250707213804782" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707213703557.png" alt="image-20250707213703557"></p>
<p>一路跳过不匹配的包，直到匹配目标url。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707223728212.png" alt="image-20250707223728212" style="zoom:80%;" />

<p>我发现js的调用堆栈有个好处，记录了调用时的值。</p>
<p>一路翻看调用堆栈，直到翻到data处于明文的时候。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707223831766.png" alt="image-20250707223831766"></p>
<p>发现处于下面这个匿名调用时，Ce2x的内容尚未加密，说明加密点在t6n.be6Y。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707224251028.png" alt="image-20250707224251028"></p>
<p>在be6Y中下了一个断点，发现：当执行完<code>window.asrsea(JSON.stringify(i6c), bsC7v([&quot;流泪&quot;, &quot;强&quot;]), bsC7v(BA1x.md), bsC7v([&quot;爱心&quot;, &quot;女孩&quot;, &quot;惊恐&quot;, &quot;大笑&quot;]));</code>后，数据就加密完了，这个window.asrsea就是加密点。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707225004805.png" alt="image-20250707225004805"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707225137666.png" alt="image-20250707225137666" style="zoom:80%;" />

<p>将明文导出来。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;rid&quot;</span>: <span class="string">&quot;R_SO_4_2722391361&quot;</span>,</span><br><span class="line">    <span class="string">&quot;threadId&quot;</span>: <span class="string">&quot;R_SO_4_2722391361&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pageNo&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pageSize&quot;</span>: <span class="string">&quot;20&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cursor&quot;</span>: <span class="string">&quot;-1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;offset&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;orderType&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;csrf_token&quot;</span>: <span class="string">&quot;fb96f04e2bf711be4bf31bba80bf766a&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="加密算法"><a href="#加密算法" class="headerlink" title="加密算法"></a>加密算法</h1><p>差一个加密流程，就可以构造报文发包了。</p>
<p>加密函数是<code>window.asrsea</code>，搜索一下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707230102711.png" alt="image-20250707230102711" style="zoom:80%;" />

<p>对下面的内容进行分析，获得加密方式。</p>
<p>函数a：获得长度为a的字符串。</p>
<p>函数b：AES对称加密，数据是a、密钥是b。</p>
<p>函数c：利用服务器的公钥b和c对数据a进行RSA加密，b是公钥、c是模数。</p>
<p>函数d：负责调用函数a&#x2F;b&#x2F;c，得到结果。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">a</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> d, e, b = <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>, c = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (d = <span class="number">0</span>; a &gt; d; d += <span class="number">1</span>)</span><br><span class="line">        e = <span class="title class_">Math</span>.<span class="title function_">random</span>() * b.<span class="property">length</span>,</span><br><span class="line">        e = <span class="title class_">Math</span>.<span class="title function_">floor</span>(e),</span><br><span class="line">        c += b.<span class="title function_">charAt</span>(e);</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">b</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> c = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(b)</span><br><span class="line">      , d = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(<span class="string">&quot;0102030405060708&quot;</span>)</span><br><span class="line">      , e = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(a)</span><br><span class="line">      , f = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">encrypt</span>(e, c, &#123;</span><br><span class="line">        <span class="attr">iv</span>: d,</span><br><span class="line">        <span class="attr">mode</span>: <span class="title class_">CryptoJS</span>.<span class="property">mode</span>.<span class="property">CBC</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> f.<span class="title function_">toString</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">c</span>(<span class="params">a, b, c</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> d, e;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">setMaxDigits</span>(<span class="number">131</span>),</span><br><span class="line">    d = <span class="keyword">new</span> <span class="title class_">RSAKeyPair</span>(b,<span class="string">&quot;&quot;</span>,c),</span><br><span class="line">    e = <span class="title function_">encryptedString</span>(d, a)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d</span>(<span class="params">d, e, f, g</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> h = &#123;&#125;</span><br><span class="line">      , i = <span class="title function_">a</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">return</span> h.<span class="property">encText</span> = <span class="title function_">b</span>(d, g),</span><br><span class="line">    h.<span class="property">encText</span> = <span class="title function_">b</span>(h.<span class="property">encText</span>, i),</span><br><span class="line">    h.<span class="property">encSecKey</span> = <span class="title function_">c</span>(i, e, f),</span><br><span class="line">    h</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">e</span>(<span class="params">a, b, d, e</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> f = &#123;&#125;;</span><br><span class="line">    <span class="keyword">return</span> f.<span class="property">encText</span> = <span class="title function_">c</span>(a + e, b, d),</span><br><span class="line">    f</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">asrsea</span> = d,</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">ecnonasr</span> = e</span><br></pre></td></tr></table></figure>

<p>这个加密流程调用了函数d，函数d的4个参数有3个是固定值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707232333262.png" alt="image-20250707232333262"></p>
<p>将上述流程转换成python代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 核心加密类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NeteaseEncrypt</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    这个类封装了网易云音乐API请求加密所需的所有方法。</span></span><br><span class="line"><span class="string">    - 对应JS函数a: _create_random_key</span></span><br><span class="line"><span class="string">    - 对应JS函数b: _aes_encrypt</span></span><br><span class="line"><span class="string">    - 对应JS函数c: _rsa_encrypt</span></span><br><span class="line"><span class="string">    - 对应JS函数d (asrsea): encrypt</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 这些是网易云音乐API中硬编码的、固定的值</span></span><br><span class="line">        <span class="variable language_">self</span>.MODULUS = <span class="string">&quot;00e0b509f6259df8642dbc35662901477df22677ec152b5ff68ace615bb7b725152b3ab17a876aea8a5aa76d2e417629ec4ee341f56135fccf695280104e0312ecbda92557c93870114af6c9d05c4f7f0c3685b7a46bee255932575cce10b424d813cfe4875d3e82047b97ddef52741d546b8e289dc6935b3ece0462db0a22b8e7&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.NONCE = <span class="string">&quot;010001&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.PUBKEY = <span class="string">&quot;0CoJUm6Qyw8W8jud&quot;</span>  <span class="comment"># 预设的AES密钥 (JS函数d里的g)</span></span><br><span class="line">        <span class="variable language_">self</span>.IV = <span class="string">&quot;0102030405060708&quot;</span>      <span class="comment"># AES加密的初始化向量 (JS函数b里的d)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_create_random_key</span>(<span class="params">self, size: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        对应JavaScript函数 a: 生成指定长度的随机字符串</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        char_set = string.ascii_letters + string.digits</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(random.choices(char_set, k=size))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_aes_encrypt</span>(<span class="params">self, text: <span class="built_in">str</span>, key: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        对应JavaScript函数 b: 进行AES加密</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        key_bytes = key.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">        iv_bytes = <span class="variable language_">self</span>.IV.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">        <span class="comment"># PKCS7填充：确保数据长度是16字节的倍数</span></span><br><span class="line">        pad = <span class="number">16</span> - <span class="built_in">len</span>(text) % <span class="number">16</span></span><br><span class="line">        text_padded = text + pad * <span class="built_in">chr</span>(pad)</span><br><span class="line">        text_padded_bytes = text_padded.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建AES加密器</span></span><br><span class="line">        cipher = AES.new(key_bytes, AES.MODE_CBC, iv_bytes)</span><br><span class="line">        <span class="comment"># 加密并进行Base64编码</span></span><br><span class="line">        encrypted_bytes = cipher.encrypt(text_padded_bytes)</span><br><span class="line">        <span class="keyword">return</span> base64.b64encode(encrypted_bytes).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_rsa_encrypt</span>(<span class="params">self, text: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        对应JavaScript函数 c: 进行RSA加密</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># RSA加密过程的核心是模幂运算: (plaintext ^ exponent) % modulus</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. 将随机密钥反转并转为十六进制字节</span></span><br><span class="line">        text_bytes = text.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        reversed_text_hex = text_bytes[::-<span class="number">1</span>].<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. 将十六进制字符串、公钥、模数都转换为大整数</span></span><br><span class="line">        plaintext_int = <span class="built_in">int</span>(reversed_text_hex, <span class="number">16</span>)</span><br><span class="line">        pubkey_int = <span class="built_in">int</span>(<span class="variable language_">self</span>.NONCE, <span class="number">16</span>)</span><br><span class="line">        modulus_int = <span class="built_in">int</span>(<span class="variable language_">self</span>.MODULUS, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. 执行模幂运算</span></span><br><span class="line">        encrypted_int = <span class="built_in">pow</span>(plaintext_int, pubkey_int, modulus_int)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. 将结果转为十六进制字符串，并补足256位</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">format</span>(encrypted_int, <span class="string">&#x27;x&#x27;</span>).zfill(<span class="number">256</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">self, data: <span class="built_in">dict</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        对应JavaScript函数 d (asrsea): 执行完整的混合加密流程</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 将Python字典转换为JSON字符串</span></span><br><span class="line">        data_json = json.dumps(data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. 生成16位随机密钥 (对应JS函数i = a(16))</span></span><br><span class="line">        random_key = <span class="variable language_">self</span>._create_random_key(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. 第一次AES加密: 使用预设密钥(PUBKEY)加密业务数据</span></span><br><span class="line">        enc_text_part1 = <span class="variable language_">self</span>._aes_encrypt(data_json, <span class="variable language_">self</span>.PUBKEY)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. 第二次AES加密: 使用随机密钥加密第一次的结果</span></span><br><span class="line">        enc_text = <span class="variable language_">self</span>._aes_encrypt(enc_text_part1, random_key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4. RSA加密: 加密随机密钥</span></span><br><span class="line">        enc_sec_key = <span class="variable language_">self</span>._rsa_encrypt(random_key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 返回最终的两个加密参数</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;params&quot;</span>: enc_text,</span><br><span class="line">            <span class="string">&quot;encSecKey&quot;</span>: enc_sec_key</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h1 id="爬取评论"><a href="#爬取评论" class="headerlink" title="爬取评论"></a>爬取评论</h1><p>跑脚本。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707233034845.png" alt="image-20250707233034845"></p>
<p>发现不需要”csrf_token”也可以获得返回值。</p>
<p>之后修改了一下代码，爬取结果变好看了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250707234252552.png" alt="image-20250707234252552"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/06/%E6%9F%90%E7%AB%99%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/06/%E6%9F%90%E7%AB%99%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">某站分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-06 16:16:23 / 修改时间：16:22:27" itemprop="dateCreated datePublished" datetime="2025-07-06T16:16:23+08:00">2025-07-06</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>33k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:01</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="查壳"><a href="#查壳" class="headerlink" title="查壳"></a>查壳</h1><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702142910863.png" alt="image-20250702142910863"></p>
<p>在jadx中，基本什么都看得到，应该没有加整体壳。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702144423594.png" alt="image-20250702144423594" style="zoom:80%;" />

<h1 id="抓包（-x-resource-fingerprint）"><a href="#抓包（-x-resource-fingerprint）" class="headerlink" title="抓包（&#x2F;x&#x2F;resource&#x2F;fingerprint）"></a>抓包（&#x2F;x&#x2F;resource&#x2F;fingerprint）</h1><h2 id="url"><a href="#url" class="headerlink" title="url"></a>url</h2><p>抓的包，访问链接如下。——指纹接口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://app.bilibili.com/x/resource/fingerprint?appkey=1d8b6e7d45233436&amp;build=8480300&amp;c_locale=zh_CN&amp;channel=vivo&amp;disable_rcmd=0&amp;mobi_app=android&amp;platform=android&amp;s_locale=zh_CN&amp;statistics=%7B%22appId%22%3A1%2C%22platform%22%3A3%2C%22version%22%3A%228.48.0%22%2C%22abtest%22%3A%22%22%7D&amp;ts=1751439861&amp;sign=9168aa232e8a21024f1276dabbd6682a</span><br></pre></td></tr></table></figure>

<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>参数如下。</p>
<p>appkey一般是一个app固定的东西；</p>
<p>build是版本号；</p>
<p>statistics记录了一些基本信息。</p>
<p>sign是一个签名。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702152113602.png" alt="image-20250702152113602" style="zoom:80%;" />

<p>对一些参数进行删减，发现只要留下platform和sign便能获得正确的响应。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702152435767.png" alt="image-20250702152435767"></p>
<h2 id="请求头"><a href="#请求头" class="headerlink" title="请求头"></a>请求头</h2><p>请求头如下。</p>
<p>fp_local是本地指纹；</p>
<p>buvid似乎也是指纹。</p>
<p>两者有什么区别呢：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">一个形象的比喻，假设进入一个高级俱乐部需要验证身份：</span><br><span class="line">    buvid 就像是你的会员卡。这张卡一旦办好，上面的会员号是固定不变的。你每次来，出示这张卡，俱乐部就知道你是谁，你过往的消费记录是怎样的。</span><br><span class="line">    fp_local 就像是门口的人脸识别+安检。你每次进门时，系统会实时扫描你的脸、你的穿着打扮、你有没有带危险品（即你当前的设备环境）。这个扫描结果就是你的fp_local。</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702152135444.png" alt="image-20250702152135444" style="zoom:80%;" />

<p>请求头全撤了，也能得到正确响应。（这样可能会触发风控，毕竟请求头太奇怪了）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702152831312.png" alt="image-20250702152831312"></p>
<h2 id="请求体"><a href="#请求体" class="headerlink" title="请求体"></a>请求体</h2><p>请求体包含2个部分，key和content，稍微动1个字节都会引发错误。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;key&quot;: &quot;B5592D6C3EC9EDB4A217370C2502098C71296E7A91A922F90F01F1AD1C4FFD9D7A140879D503DB12E153E4AB41051B413E95C7C5F6AC4681EA65FF7EA8055F0B336EA750E31980F70DAD33448607D3A8CAFA3D149D106758296B8EA448498C967452D58EF5E01694CBE128686C6ECCC98593895E01981CC33AE043288BDFE520&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;7F85A3076EFCDB1CE8B2951DD3976F7994BFF8A62D51EC62D8F6F5773E3AE4DAB9DCE2F6BE8BC149C6C7F26B635430E23B7E005AC9A241A530BD0D2A73A9BDA6CF126CCBB2CB1EEE3805A2E96D617E9B48D3569E697DD28B377A4459B24FE7CA7BDEB77B433C91C968937ABB2F6E561AEB0AD07335CF7F40B4A8C3B48B65B59DBFB57358DA9D0541064C852A6FC8F455062276BAA8496DA656A9DF365D444EBB3DC3711AC44D248F05DE6DAE34101AF8FA3E179E87F86F3AA001DD28CBF21F852B39E8D7C98B7ECBBC85AFB3C52C8C7ED9E01279F7D650E39BBBD821DC556C40F83669785AA90C024B73EADFD8F28D2B9C1C2608B22B3684AD9116E4BC4163DB60C058F23BF3F1E7D56A481C6F4BB9373EE771D61608295ADB1B3F205C0DD2E8EC24A693C2B9C555C35E537F5B19D6C9F5B71CC111858E2D321ACDFB269003EA45D191FB9C56D359386F79B245C1697F145976F05E43195968A54423C041CFC7990FF7E8B632138F699F473DADA2CB8280225A96D311574B89337BFCE30DFF16A42D19324D9244E1714DDB6B36A7F46B21168F41E9CD3FBF380EEC915A7C12EECEC3973F38343192862009A85B182AD1233AEBC1434EA2C4770A636F6DF093003B96F0A017E04DB157D5228DE72246BC5FC90D222B217794F94D5EC8CF5BDAF4C95B34F89AEABD8A7979403BBC48329B6FB23D72A54DF3882D758D7AB68E25DA76FE94A140458BAF4CC3530854BCC5A231D5D941CA579EE94E83A89F1792A4595EC405E291A55A060EE0DEE5014CC9A1CC1CF7AB9987FE3E52F88FBD1A043679D0A7DEC997789F2136253BA806C744DDB9E9A0422AAF564D8E7F58F28D086D74CE430E6FAF084982BC12339A7CE6EBE94A96555FC7CCDEBC69E3E7F481BC224617384D0F4F5D2470A2BCB5944B22DEB878EAA2C2844F8ABE7F12592664BB37ECA47509B84D77716B0BAC584B7FBB150E6820BF4D423FB618A74B2CC7719D728B9D8D39D029C5B45396736F10618CB21CAA14355FB0B42D464774AEE05F7AEEDBFFE910DEC069FA9E32617CCEDBEDA4708D9FA1D9BC96753F8017969A5EBEB1D8B933D3C50D8574DD2A84DA2AE71D48761A1AF265770A8EE49F551A10C41BD0552048438834EE2EEBCA62458DB2C2836DEFFD1ECA41B344A0C03166FCA7E4CE8BB52967B686B9DF6CD8AB879945547A7C2FE627B3302AE5CE1AA65C68668D6784124BA0713F55D4BEC45E5E5DFD5B691DC8D36ABD821C5E2E24A3EB06B0D8F14E124BA0713F55D4BEC45E5E5DFD5B691DAC207D15F7A1AF2B8A0E5A4580582A33F32CBC20343B9E708171A98B4159E62BBA6A7C8038EB3AA26812372744A1C4C2F5F5EACAC455F30E53BCF52EAA140EADFB4E5CCB01971968A245974EA19BC7F0669AB681037B4BB8F903260124AC0FB504E9C87229D636431329E8F205CFCA0D7A80E08DA78061F0EB9D1AF16DB730C1AE0E80DDB2DFB3156B18D334618CCDDE233AEBC1434EA2C4770A636F6DF09300E2F550F90EEADBE814F221EBE00164664F0A34D5FF8B32C09E5A24D40D6D45B3612B17C41FBA51ABB86251E3B1CB357A299E8879C6D8BCAD98733D71A38C2B8EEFFD1ECA41B344A0C03166FCA7E4CE8BD9DAC74C881D6B1CFC5BA3746DDB48C4F1ED8C56135C4984CBE8209E1F60449C708C783AB8959B30CBF3F77BE5AAE7FB097BF936EC59600DF4FC8DCF6FC9DB82309AB89A1644437A65F55E12FEA82784AE0E80DDB2DFB3156B18D334618CCDDE967DAC2FD4C167D08163840E5071E353350E14A04FC182249A7A3C8060EBDFB0645F65777CD5A68D3281CB8488B99F22CF6985310DE6D2BBDAF8362F58130FE561693D7C8015E047220EC786D06B26238B6EB3084D301EF70BE8082D0D3FBE15EB30475F9A7B6876B8447B9A911D7749F5F5EACAC455F30E53BCF52EAA140EAD99E5E18A77E0D7BB1E62CC846D9CC80D8B6EB3084D301EF70BE8082D0D3FBE15EB30475F9A7B6876B8447B9A911D7749F5F5EACAC455F30E53BCF52EAA140EAD99E5E18A77E0D7BB1E62CC846D9CC80DABC395E3E9307A63EBA8450C10F4AAAD967328FA7CA7638A2C066A0336736A3D13A5240B265E5581E245783309027F6372F0C59E74017138EE33D195BCAD06FAE32B80709A8CE080116413E53F5A326A5AE85FAF47F6FA5FE444EAF448D3C1B04F35288C7D045CD2D8C79F021E365359651EF28CA3616A16F9FFD4D56C3EA514218CE945CD85C054B8AD8C3ECE3C4CB4C183C48A12686422A696335A261FB96F8CCE36CFCE08EA98F0F32ECEEFB22FF23B6CA3D801D9DDEFE2DF37463FB28488EE0061406C2FC4346E5DEB30040D1712C76B625C4A680653FACD92931ED78474459AF115761AD515AB0499B8F50C06D44CE11766B8779712E014BD49ADD1D5306C3BD2CB4671C9CE2B1AB77F13F80163A3ADD2E4B89D09C03B6AFF1F428B5AEDB410689D8777D91B22A5B46C4C9005D112A1CFF7A854B4964364C5BCD5485D0D2A9C65DFB61D444D52E79B71BC74DA4416ECEAEAFEEB6F5328FD4757CD5C0C42F6D5BBE3EE085F8ED98281DC8BEB62E9DEE934628A9142DB00121DCACAB5A0365B84200CD99B9E8ED6FE2FC27702C73831A2E70EE2301EB5305FE37D30AA20757F77C9878833E7A412AA0FFDD4C5A2651926698143B617115960874EDEC9634C625EC3C20E342278C8B37F348AD6B1FD610F2835414B2C3113048D20A3D02146B9BF3B60128731ABCA77639B0DA6337314C3F3ACC92F338429B0AEE68ACC0E13B4B78572B43C0B92A24DE330684131ABDF26CEF3BC27CD978E29570E1E0690DA8F6648384F435659F89E4F0FA04A38A78C9E532B0C5307F2306A46497F37BBCA703923C03B8ECD34B958BF0804181B0776B284248B199FAD99CF1BD3773FC9DA6FDA6B0B3FEDAE5ECB0C95A66E0D79020A198887E43EF87328073071BE14575470E41E8CBA4D151F3F9B0E454431A9684EA68D7DC4A1942ED3D09A8C0006FD04B4C2A0F899B3C09B054D6A3405145A74958B3FF19FE13E48C4F679E09D490FCA261BAFDBD972BCA0056FD9B41C8F4D141678018968B450DEA5C6694FE97C93EACFFD79AFD23FB1D690ECD5A62D55645D636B6A87E3C8339390B8B52E36CF07179848B079E6CB4E39AA7E7B98F172020068B6DCD9E83E8ACE3B07099394EEB82BCC7899413C8A7B549A539D58906DA39F2E837088AFA0DD81D838216DD32178F13B901968946AE5C6190D509FF9A353AC5AD8E5AD03B7F44A705B925B43EF5866217CE62D5550C1D6107F525A965901FF90615E64155E218DFF821A2D8B51DDF2F402B5C63A8E67D125945165D9FEC3235DFCDE63C1B40D8816B7F3E517F0430EEB9C28F75EAAE9A06DB745ECC8868931B6A989620AEBACBD5B98DA2453895961F01116D824F062C0AD3AC7EDC14DA06579B8FDF57A93D49349CE9481532B5CABD8690FEDAC8BFBBCA039A1F602C49DB8D0AF0BBAFC185EEE22F78EE10C73257C050A6EDF181DDEEBAA0C37552CAAC0F8672ABF5DFE7767C70C5A44EF6D5827F820EF44B5D693D086629675A2047B6B422DE2CA91F7C16F48FCDC542DBDC64B47442519DABE3841B6136BFEEB6B32D1207FDF8752833CFDF1D407A1C16E777D6A3AD4A49F54F87408A5E69A83DBB852DB9F19A665512CA75BCA1EF9050D18BF152882409AEC92D05BFD5F35FEE6C9BF62056EC7AD830A00CC10BF8270621BC04CCE5D2018569A86E00A99C4D60020A8F3E56756F83168C01918C1AF35941DC2EAC18BE904F19650D8231CE8B30C9E2BB2BDB77A57BA980F3601D4D50C1D52997D65B99622AC53E5D5DD7258F72B1EA2DEEE40E1B3CAAD1EF087C7024E30E6266200600A39CDC7B065CDDB6D206797D5F2AA5F263A3D8B1ED0A077283607CFEF32412EFB7B6E6C59AFB4FA0BEF1D257FA2EB57AB611B4ACFCCB6DED51F207B3E328A7DDE85FED7C98058F0E5E6D8E493FB3DD2C59DB9F1F5E8621702B843DF8E52F5A00894FAA0363BFC77AB70D6B57995F39684DE8F61EA2BB96A642F4B545B17984C653106FEBC7610E0B7F451ADC97CF36A9A668D617521AF056A5C5EEF07B603054FC4D1412F54129CBE4BBCD7A8142114D8A27F35DCFDC8095A56AC245691A8B783D594EC52015261A2E95724988B5A3A3647059A289B614511CD0DB44080E39D1C0EACDD65BCCC2B68C6B8938FCDE02E2A725263F4C321938AE9BFB886D9291C06790124113BAB08659A4BC2268875396FE8F63661CB977A05652A31C91CA27D2C4072424907DAB05DB6A6E9F3518F78A8172B6C9D1611C3463A38786FCFCC2363AA37CF8D34F93A944C40D463CD4A6C6F2698E41AAF48F362D4591F9B4BBE667B8EA4A1A211DF167585E7ACE6E8B2CB35D1C43B236C70C92A8DB47DDC869603C60ADFD523B5BB08F0B765F9B91DA7D05097E7109F540C05DEC099864D773DF8E5D7D3A187826747581587B3D22D6210F47FC719F94E1E98824A210B0E7AB543EBFC745C102B36B9EA78D64CF2B379C6A63A8E0B302CEF681192AB859DD8911D25AAAA248896ED60D58E041E799D4F0E9DBD97D1D3A6B63D40F009EA23523AA7C708AB2087F5C48EB54DFECB021B11D6B8BE54F43B47ECDC4B9D4383EC9AFA1A32B3731DEDFF782092F5964D8D0437ADB689383099E66F2A0AC8BA89E5A5CBF1FCA8538680197F192760786EAF620B7F985F4729FB5AEAF2BAF379F5312EAC0D871F92FB804D1E4E1F14DB95D30A93D31A59586B74359A8A6A29065D13BB52F79C76E455478813A64B90DD8B934690F216C4507D52B831B446ACA320A868F7BA56AC36A4BA7B214139F87833CC05402D9935318D0365C7385B8DB1BD6CA8903FC5FE4F5308282325AD9687DBCBFF90F216C4507D52B831B446ACA320A868F7BA56AC36A4BA7B214139F87833CC058697B471918C0617C7D803FDFA858C591E248919900FA678E012FC5506487500803904EA509B6FD8C2929B0D7877714B5FB09985B271C74B23190BD05C3A456FAAA0AA148DD944A260602CA2AACA921CE5D96574541C128C2020FAC184F77BCD7FFE6BCD1D64CC81231BFCDBD7CE287B4082823E00E2444CC849241D5C39B7D3255947FC810018EE959BF8394E3FCCFB65130A34669E46EAD066732074E79747D431D002AF22CBF26A841E1C7FAB86177D21C5EE6A1AFA900D5456093D4B3FF52F763A23EA1989D19972264B3F4A062C1D7677D67F39D6B88AAE8EE0CD4287C0F38B3C8E3D1775833F9B7626FA29635F2A841A307BBE3B0F41DB1337C0DBAD90264D07B0895F15E0D6E7DBEE9DE1C4158EB801501463144F5ADA11F92E11D49F1116FA7B7B8CB23A627F386F190D188E79BEA5D1198624C95D1D57E3FA7D161B93B005CD7DAD5DF83F3511B661037E0D64047B878719F91D79ABA3AF7F648852D431D002AF22CBF26A841E1C7FAB8617C025D907EE2B4EB63ACA4A09ABFF63AAE56434A3F4B817C8A777516C0E36DAC28F27C6849012F2C9076CEB858703B65B5BC400A5A8A69ACFD306E6F03EECE46A9B1758FADB344B3D04BA2CAF3154B7817D559BB2F4804197B6D4E1D07822BEDE60A17CBFE9472AABE53C26EB59255E20BF13763A8506CABCEBB1935BAADF8D85A54668E34F90CDF76CF9CC847FE13BD2049A1160D1C4233BC169FF56CCEAEA98FB062EEB196D72C00789C1C285C2CF276A462822E7C6687A008C146EC5AAA5038691173224E333FE75EB0048E7845E10200FA230DB98527DAA52653A6268505FA47213686A10BEF7161E9E87E2081BDBD6E90FFB5A08EFFAFF503C920D1BBFB2AFF95ED457151A079FF72FFFC5B31726DACD78F6977E058A22994BCA11A0B3AD670585D20C78C2073A330ED0CB887169DCC5D8D86217F7942281B090229E95B552F79C76E455478813A64B90DD8B934690F216C4507D52B831B446ACA320A868F7BA56AC36A4BA7B214139F87833CC0512B2F35E34DE7B5206536BBE032D1E9EF66ED808D2D49E56A1AA95516E1891D854DBD0AC494B97BA69A58764F7F23C61BEBC9B79C6CCAF16394826FE821E51FF6CC43B9CE055C233C1C99D2C1CA1087D5093182C53F3D02845FCE5EC25C181C10C4824278D939141214CF5FA7ECDA61564798BD8BFD35FD13E2B32A19BB2F956AFF95ED457151A079FF72FFFC5B31726DACD78F6977E058A22994BCA11A0B3AD670585D20C78C2073A330ED0CB8871692E78FA6D57EABFB67D8E1E686105F86B2F763A23EA1989D19972264B3F4A062C1D7677D67F39D6B88AAE8EE0CD4287C0F7576A8B19E3BF43D3A2971BF442011509B3BD74082A0FCF146D6A78EA24C8AC9BBF2DFD10FD15A52C99A6156E07477358D88A8B98601F48DA57C00D965683974820AE18C30361DABD484814725D375AB3F94B005A2C5D1B8A366D5B0BC72534BA59C741098827EC5EB9E97A2BA7D1907451D0DD902ECBACE0B517378CA336A422DFB7584EAD89DE11AB8BFA8892D4B0592DCBC99532291CCE62C371CF04097AED4A731185D1DA84B09DC80A36063D1FB2F75C3E35BFDF632E0F744FC375DE5654B994472D4672609FFC89F42C8BD54802B6C3EF67BA8151E7D1FDAA652713E47DAC46EB2E104C6DBE00B610124ABED49312F05F9DEFB3CF615B041EEBC9B17A8592A2BB61CEE4D414379A5002817539946EF55B0A3FBE6AE3335F59885F854D1116FA7B7B8CB23A627F386F190D188E79BEA5D1198624C95D1D57E3FA7D161B93B005CD7DAD5DF83F3511B661037E0DB578A5B853194C93102747A93880CDB7330EDFAB19CB0F4D236C719F16B3A1E4C88E0A5D9079F543BBBA77F1C6F46121A47F9C6C3A9FB8D2841551694B63B959E5E7A6F9B89952712A70BF4D076AD5A35F110FC835C3C50A651AB561D1A4A54C048D963DEEADFEA593E31105A3BB946B68C3FC15C250D8AF21CF2A84A21838C6193C67A66273137919E7EB826D2DA9B0F30525856B9B541B8A59086F6F010B0CEA9565E9E3D343A0C1D60FA90D86D90A8BAB40D3DFDEDED112AF81B12646346242C0B2BDFA0FC9BF7F80E00469C7F05D9796FBBBEE3EFD9A6A3B7F41949415F58F7AE7408FE60D6C1EA948F29676A338764FDC0784D7C4BD44E750327DC42B3732854E85030BE75BC38517038A6D7D5E37850C04060E9F762BA59458B529D0B5BE6E19E3B28925ABDDF0B44CE193643233F204B702C98BD59E95D5CC7958E212A3CBE0388F4CE165E85A4E7817446CCE64B3D43347E44253B3E8ECC56F5C540FC275E018BBD4F18C0C8B35D66E03E897CA1962A1BFBCC8E56B9E4E080F0BE1A02B02AB2EBE47C79D412953E521546FDBC0DA8794806032FB02D08BF362A0031E5E893F4E76E0F31B0B722C488AC6AA4704E76670F962A076569018B432957613F1918D983CBD8A9442FD18ADDBC875C63EF572F8B71CEDAA3EB89AA867D9404D2CDB3404FF7D7B5ED1687BE040A545B26075E1AD333A83817D6B637AC29089FF2F475E08BB441316B070F26E2C704545C774337BB11ABB9FBCEA5367F16D1F94DCBF9A73909FD721B80E34CEEBA05C4F2315FCC1DEF4D42BCBD11F3657FE3ABF49B60AB75656F420F4DFBBD1938D5B574C86F0EB7489560AB14360B4CB6486F80BF32A0F12D5C8A01C6932790B9CDE5C2D1DAFED1BED9D2BA68260CA7EF276B202BB6B07463B9BC1E742E21469C0AB854BEC04B9591404D3F735329D0790952EFDDEC1A39B258225A07160D07A408DC048D9FABE95ED977F5118061FD04047CB8A4E74EA59E63C26410DBA0E1A823FBC4987C78DFFF74DCB200F80A18BFE9D6A3D4F8D56ABC56E5DCB42EE66781D27B812943CE033B30047097F09E4B321C6AA5069D0D8DC4E26E6D95D8412B21942C88CB0630CEF9F085706B735DE23811DD58282667AC678CD05A1A305BAC6C3D537C49F9238596FF288B714F6C72BA8EE52969541AA2854BB10C475262B70468F34F0ED0760126FD6F393F270AE2A989BE79796FBBBEE3EFD9A6A3B7F41949415F58F7AE7408FE60D6C1EA948F29676A338764FDC0784D7C4BD44E750327DC42B3732854E85030BE75BC38517038A6D7D5EE1920129351D7A87A3568292B97634C7F76F507C7B60E2DF46A6640C042A0007FD1C0CB373F1AE9B1639B73EE1AA52D090C163B806800272CFCBB01448ECBBEF4DB053CD6ED476771DCA2EDF38DA9C7A434656F2162366371B3B339E410F5933872DA250E1BBE272DCB9E64E558DD6C350EF72C5A6D32D2757DA895688753EBC98914B0DD995B2F6E9F710848701D53162E8D7D3A9E37E81A7A8085B1C3A888CB1AF1CFD34A576586755B75E9212E0CA7DBC31904EC4F642DEDA26591F3930D530CB5DFCBE8A372502F078B4DD362DBAC42F2A6934867CC4826C01053F889ADC8B65A0A5BD8D73DED629BB31A0FB7E356BEC8457DE280DE526245B300A531FA5AC0D871F92FB804D1E4E1F14DB95D30ADEB8EA1819B7776C2CD72B34FFF9E58651C80573692057C11B36665040911EA76BEC8457DE280DE526245B300A531FA5AC0D871F92FB804D1E4E1F14DB95D30AAD8DC62CBF41603C2D14927A6ED34748DDD1C9FDE82A77596C5A53A47ECAABEFA47213686A10BEF7161E9E87E2081BDBA1D2C1A759A48D0E980FA2A94596483AD0F2223FB34863E18C8D645F65939FEAE56434A3F4B817C8A777516C0E36DAC28F27C6849012F2C9076CEB858703B65B7EC0B3C3CDCFE853BD0E30057DE415F81980E7CDA20DBC456C9CB91651BF56968CDAFDBFF0BF245545C414379631F58190F216C4507D52B831B446ACA320A868F7BA56AC36A4BA7B214139F87833CC0512B2F35E34DE7B5206536BBE032D1E9EF66ED808D2D49E56A1AA95516E1891D854DBD0AC494B97BA69A58764F7F23C61830C92C5CE40223E5304364425E45B438C21A6ACCD12E1AFD6FBE2F1520C1E03E3FB0BEB7F296E67E5079FD5981B1022AFB31669008C97E0E6A02851A0F1EA9AD431D002AF22CBF26A841E1C7FAB8617C025D907EE2B4EB63ACA4A09ABFF63AAE56434A3F4B817C8A777516C0E36DAC28F27C6849012F2C9076CEB858703B65B0E0DC728B6E62B8D88D3339B4D21B1AE52F79C76E455478813A64B90DD8B934690F216C4507D52B831B446ACA320A868F7BA56AC36A4BA7B214139F87833CC05F5B9A999A0DBE02758EA72ED13696CBBF286017310041599A883D4DABE274A77A4DCAD501F455B12681AEC9849DB184D289C29C29C4278476469E9CD6D8B3624EEC8C18B684CC96D8C88AB8B643064615BEFF17663ACCAF9D14B5D184DD5174488F595F6C272C3B79BF618E35F94A431D5A9F27BA257FF0A87E5ED254BC3776F52E128F15820BD2811002A0C966401FEA91407BDF5AB44130504AB47D185817C01CF0C8D6A03692C1AA0823130C645722C5C692D4E83607E89934A9B0F6EE62452F79C76E455478813A64B90DD8B934690F216C4507D52B831B446ACA320A868F7BA56AC36A4BA7B214139F87833CC0512B2F35E34DE7B5206536BBE032D1E9EF66ED808D2D49E56A1AA95516E1891D854DBD0AC494B97BA69A58764F7F23C61BEBC9B79C6CCAF16394826FE821E51FF6CC43B9CE055C233C1C99D2C1CA1087D5093182C53F3D02845FCE5EC25C181C10C4824278D939141214CF5FA7ECDA6152FCEB8E9B4F2679507AB8F6EE8C8649B011AC4357EAB4AB809E47204D530CF25DACD78F6977E058A22994BCA11A0B3AD670585D20C78C2073A330ED0CB887169FC5F8563B42D8073925BDCD46662B2B4E56434A3F4B817C8A777516C0E36DAC28F27C6849012F2C9076CEB858703B65BC42F2A6934867CC4826C01053F889ADC8B65A0A5BD8D73DED629BB31A0FB7E356BEC8457DE280DE526245B300A531FA5AC0D871F92FB804D1E4E1F14DB95D30ADF7C6268E7333C414E1392B824F7FAC8F66ED808D2D49E56A1AA95516E1891D854DBD0AC494B97BA69A58764F7F23C61830C92C5CE40223E5304364425E45B438C21A6ACCD12E1AFD6FBE2F1520C1E03E3FB0BEB7F296E67E5079FD5981B1022A8B1E0BA166D2A6BC4C6B072328FF8D284B97E0DDB4E80788AA697C39738BCFE64494B3F07CB23980E07D4FCC9420D3F152B7B018EC814374E39E35BF8DE5DA494F8D3FC222859AFDD74A2F85BE3F51A0CD09A2E1593CC720A54847078F4B9F8D4EA2E3C326E3C0CF04072BE12E8F31E7AA3E24A3EC3297965C7411F12047C63B97C6AD81218F8FEB6A9B6915DB00F4427C9BE44C90DCEEB22C78C937DD8CA8089F1ED2BBEC0EC1D1BFD38B6D19A235C7C694B533072FF10DA6EA3331ED033738087B0C0D85274D237CDF89692978ADB1A5EB84649B7429EF1208903DAE675EB3F2E7DB4B4FF8825E88B52696CF3292895DB9341B69677D13461AEA83D226C55869A332CAE9864C9B229E92A699E026C95262993FBE69FAED08C91A5690A7135C749CCD38B9195491ED06A976C483FD6955A64914DACB7185D2BB0896A7064C55AA752A2AA265147D595BE7B9748F6CDC464C679F1A4A262DCE5D69EDD327513009157CA19CABC43DA6E60C96C6B1B953E81060F3914E65611575656F8F2749CBD92D9B888F16FEE47B23CE4316E2811D5A35D01A55990BA69CBF8EF84CFC89D910007F5A865008E54112B24EAAE4D6F990FF7E8B632138F699F473DADA2CB8280225A96D311574B89337BFCE30DFF16515FF2B9A9E1AC75D9B6F91815342A7B34C6C223EF4598C95E72CBCF67B2FEE0F007C666F86B4B1CF4C603F45BEEFF6226B862E138BF6B55CF6B158AC27667BAE89DF3F79A55F503341377934F5E21F70A23207A28F73CF9533FBB68D79B63F2669EE99C2000C303C42652222C2FA5B44EE38CFD95E15D74FAA06E436D7440573E563BE3CFEC54820627A81723A9728608131F51FBCCC1644342E3D0CD6ECCED0429A869421B4EA013898819B95F25093C049A8127762F7123B898CE94D25B863E563BE3CFEC54820627A81723A97286C7F1A1AC18B6E21AFA00B26C8CA6208485F99FE3E7D7EA97C8C29AEFFB290144B3D007675DF82A1CB9A17858002F128F41C609545EDDA2F5C35AA94A0E357A2A70F2BEB5AF1F9F03C5EA20050470C68EC749ED4DDDC698261434B427A25F779B350E14A04FC182249A7A3C8060EBDFB00426904FCBBCD599C1C103DEE57EB3E2C4A771A6DE8A67164CDD0CEDD817B1768934785E1DC8B65BD041CECE58833229A1081B01B60850C082EA8E4A0DAF5E0ECD480D0B5A44499A54F068DD9FEF62C7A13DC7453679EEC3D34A92D623B79C1695837A08BB0A70AF44EB26157E245810B3B504D38D01887E7504DB48C50DE25743E370CC84795AC30462BB98D52389DEC3D886D7708C85A695C4948151F750BC3B5F329B53BCDCC6B2955FCE3D085A9BEB8A9F633D835F1683CDE65D1D7ED96DE900EFAB99920C130890A8BD1BC32AB24834AF46B416425960290B1DAE5AD342990C4CFA73024DB060D102953BE7754160DFED9F3FBFB8AD2634D947BE5A2277CFF6FBABDB7BF5625F4D118DE8831567ACCDF7E99711816A7FBBE3F64E3D7539B4A910155CC09ED3C446EFC943791E750FEBE34B70120440DA4D943A292FCCE6AAC66FF9453D8A93B27A6AA1C9BA22E8EDCBE8B7EB1D13F23BF126735484AAF78F87CBE64E42597605496F171F271D499466F0E4FA8C35A512898CA691ECAD8712161855BAA8048238C3C5F6071699892D64FDA860F3DB3B06FFA4D531A8550154C05CDAF670729893520B353997F4F21F0EBE2ACF8B6DBD4D119349F1C2B55822CFADA906DF04C7C4634F23BDE01248219D2040CD9A023E76337F3E9A7F6D80C40A7CF35D401794CB67D20DC8B4FA0476B69083C49488F84F4A3EEB4A055655ADBDDA111E057860AFD9E1783FB60598B84E7C1E476EC6162845FACDD40EB4F81F44D272D220B1D1C32955B83BA2B570DB7CD9781F24F0FC9BE8263ED8F25AC2280A32C9E98EC2815567781B354B9FC41F2317E4408F4BBD21873702B8EEE20255A377E556EE8957654F9B844B89939F198B03EE20713E0087FED15C18209B07FD867520B219D7E9FE363DE8BF0AC52F299E8879C6D8BCAD98733D71A38C2B8E513A1263E66577B119DC9FFAAE6D71DEF33E9C205139F616CEAD1B5103265AF8D21887509E4F4AAD0EC33363B0E7BEC0A13536F30BA922B5E69DBE82B26C57C0FA06EC07C3D189D1669A012DB69AADCF01B3538E97B92717A50A155AD6969ACFD1270330C8F13CB8C2101CF0D1A565BE22AC93F289EF8A9F361C74F044E7F9A069F6E36F599EE92C075127436F47BAFF6FA5D3B0202070FF8D2DD28394FA90D74CCDFBC68B9CD373AFBAF2C4222D7A47F7BF867B2CDC7AC061B1043CA97943C37A94E7B48ED6CD54393029AB13D4552E43B74082368D126191B6BC65349A5CCE3F745B985260B09EDACA9F4FF73E12EB0ED09B1C8B9ED97C89A96260108FB5DE218014E9B2BB56209DC6F81794D441C11113C302D5ACB1841A2587E5451EF6DC5A37FAF69B16D5D3106F910530B125CD04D570485800C141CA0472465E8A133399132AC5010580B9BB12ED9BD806782EE252906AF40328C78AA796A1694B024FAB3A7233D6867E8C596BB4A0F1FBF12B40DD890CF0C6F341CB7671DF45121D8A6E13342262CE2F1F4316BA5C048B5F8ED4D6886003A8D7064A20D8514F236A4BADF428FBA859FFDD73E76A375E5A14682853503ACDEB68E94B1C205D866A79683526681FF6D1716CA1F4546F79942BD4FF67F8EF442A12BBA5469D5346116720055ED4C1EA045E8197FB19A2DB29094CE2B55C82F6F0579445795A789FB0ECFBB977DF9ACB0E47C1F74DAF91B5067EF4CE5802614939937D810C499A52B09961FBD05FD9A037FE1EC198D0B3B11896BABB33EFFD1DE1A90EAC55627692ABBF51A298A525E781E21F968152A4C099699693782A99AAAF1E0EF532BA1267F77B841379317DA46003B0290662DAE14E0932A03EE4CC7C683E5C87F9E39F5D6179FFECF9C829FA4E367612C92E83AA9553175B8524031F9603605341A123352FD0C24902B576C941A52284231B6444E07466E4B1A7E9902C025A5F09B0A393EA5B4D438AAD2543EBF16A0E6259BBB8074B1CC43C8AE82F612E9F90B42682C66CA629BE45193CAA1C03BC5D7F7081C22303DFD97F175E39CD61024DAFBBDBA4F583B10F0B369E7E5F2108F158337F27ACBFD3B97445886BDE144247E126412C83E5D10DB679C5825791F5D8741516DE7A4F23FD9ACDAE467C777BFE5B92723C727AE450D171FA7767796FE2507220B556DDE1513A1263E66577B119DC9FFAAE6D71DEF35D6F5D790F8EB8D9C19B28A02CE8DAD19A5E6FC3FB1CE43CAE1EF463E5732140CA6675B54613959F3F94B4BADFCE7C6CC18404F876E19058CEF811397E3B127B94616943EE56F7D3C441B8B1118F8C1558C05C805833404B1842F874A78FD7ABCF40EB9BCBCE04F3699B9EDF76AD2AF1BC07AD6433D6E87E184F597DA6EECB1FFE259DA6E1F55A79015F277739E9383720114437DE6FEC41A7E947A2DD75ADD635029FB2A171CD19E89309E855100E1F6705214B1948DB9DC0552296FCA1C71341861323D969940606D8946A8AEC0EFDF9AB76C3267E23D6C67632B1F166997EF5133CD0CAC7FE675026AD18B8433973ACC2B9BC3C32B826FF1C4BD38CC43E04FE07014A6436EFC7C61C74D80E6A6BF9B8B7A2EC01E12A96033058EE0DC66B31BFF59C2EECEB10CF1CB1825FC5A0F77EA7DC0D5776A89784D964FF5EFE53362CDC3E3B5B98D35D19BD36E8D405CCF342B5B629559D043D226FD75CEA9CCB67841419D5FFA5B83BF998AD247F6575B66E9E955F896AF9EC883F25924916995C604C960EA1A5A00111478FE0DF5EF4EF59CFD49350F21945908EF8F6E7CCD0697EF5133CD0CAC7FE675026AD18B843394C800E525DE5CE0E129177076FDF3317FC6ADA0E175617915D442315995597F4E08D005B7465081D9E2559846F86570AADF428FBA859FFDD73E76A375E5A14682853503ACDEB68E94B1C205D866A7968E11B47C293D302BD46CE11FFF86F221F50EFBBA289DB3536202CE84D28CDE4777D0B9E358D1FE70EE8A1E0ACE9FDD52819387497C9D2E481EFA38D5BF94DF5CA028BA2CF09F373A68F982CCE730C90EDBB43B1C640894A29120832C002D080C6A930D729459493D0C90DCA8FCA05AB4FF9BA6D9DB62860033799C36C66EF82CFEDD02FCC183036E7A4A06482561103F7A7A049BE0A2FF7CBD64D9C670454E00EC1CADD682476355376E4829629CE5CFAA3DADDE2932EAA9440712C917271EBB524E1E42ECD79B3C4AD4BD42200896EBB12161855BAA8048238C3C5F607169989B9E355AB5A185958D3FB2E683036B892A6649FEB89991CDD04E674796F1694255413DC21014288390831A2A804766D0867ED42CF0F205640EBAD43213654A11577B80A3A85C3A035EA09E76BF9928AF900C33A09ADD2E29B122863651E3CC19E156F47DB9439FC26C94140C7F695C625BB6A9E6EACB868A60295AD65112AA6F3C1D0DCA16A145D2E86F60F76885532B044B4E0C44004CB3E4580EC09685D41650F1AD22B10496957D32F785528E9DAD95EDD17EBC44F8D6AA844FC042F20E392184BC74C2C961C0954DD803BC478C4C231F254B1E4475AC320AF4CA704CB7C56C384856016A9ED9802FB123FE742312B2C3F10BF6248EE16FCC3DDC2FE9D5D8ECB61196820452F596F86B102FD6B32D7633299BAA63E6D86D191BEC72EBE01A21796D1F0D05ACC88731A7CBA22ACA4B0D022C3CE3B90375A77E165C5DD8F9B26C5227CD2E2F8F230A73E1B81716322DB1946D7E308D0037C3D62CEA2AF8A44483475895B06E94FB432ED3D3116585321B8F8BECB205BF98180DC7E65B10911A6F2ED58EF4CB672D467F9A65539C3B66E59C4C1FC28B02EC7663B38E5FF372FE58ED6E24D389D200232F8AAADD040D3BB181AD5F3195254B3DF0C3D54951155114E0D8B990A65D2A08696E611C4F14ECA0DE32C2CE98E05254D60DBCEF66241B27761E6BA22E1BAB346E8B8779B4786B18A2E38C4D6ED6476045B2BADBFD4F00FEA66A0A35F738D8DDF8168BADB8B8004CC0D11759C1AA2CF6AB35D9CD4703F85E9CA8E80D45D6224B8CD8407293EC7BA2450B9A8DB75C7884D772295E0DF56669453E6B95C6B0D6499D16CA077AE924E725513DAEE088A327D23EF0ED6C7701EADE8616851F5EDEA0DD8D9F6E2E66065C3879181AFCD0ABFB6D5563BF4107EB7B8607E32EDB07D2D750C6B0C6A9830B1A6409EBECC53AF3000AA5203E562B9BB5506B9CFD7F29F8C7ECEEECE41C84189AD7863335A06E42D630D58E7BE7DCB3045859143B070AE4E2BF3C8366837964380D7F62651E7969A66C46DFABC7976F25787EBC6B0318C9A399566D2BB9119BA048AB3E35693C129AF6A90241E99AA2E8CD95B8EB308A49DDB98582AC10CE1ADC59C7E5664DA8C1920087C974615E11E793346968C73FC6286F157682E62ADEB48EDAC158A2126E50FED5A7B4D0B0E34&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706122050601.png" alt="image-20250706122050601" style="zoom:80%;" />

<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><h2 id="sign"><a href="#sign" class="headerlink" title="sign"></a>sign</h2><h3 id="定位"><a href="#定位" class="headerlink" title="定位"></a>定位</h3><p>常规操作，在jadx中搜索”sign”，观察能否直接定位到目标代码。</p>
<p>根据包名，这几个出现”sign”的地方，似乎都不是为sign写入加密数据的地方。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702160544721.png" alt="image-20250702160544721"></p>
<p>那就使用frida，hook函数java.util.Map。</p>
<p>然鹅，遇到了frida检测。</p>
<p>绕过了反调后，依旧没有打印内容，说明不是使用java.util.Map存储键值对的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702162534783.png" alt="image-20250702162534783" style="zoom:80%;" />

<p>还有两个办法。</p>
<p>一是抓包，打印调用栈，对着调用栈分析sign的加密点；</p>
<p>二是在jadx中搜索关于<code>sign</code>的其它字符串，因为之前搜索的是<code>&quot;sign&quot;</code>，如果去掉双引号，得到的结果会更多。——有可能用的是字符串拼接的方式。</p>
<p>由于分析调用栈太麻烦，这里先尝试搜索<code>sign=</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702163434803.png" alt="image-20250702163434803"></p>
<p>发现结果相比搜索<code>&quot;sign&quot;</code>多了许多，从上图的结果来看，大概率使用的就是字符串拼接，进一步缩小范围：<code>&amp;sign=</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702165711046.png" alt="image-20250702165711046"></p>
<p>有两处比较像加密点。</p>
<p>一个是：</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702172119873.png" alt="image-20250702172119873" style="zoom:80%;" />

<p>hook了这个函数，结果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702174112995.png" alt="image-20250702174112995"></p>
<p>根据比对，这个sign大概率是访问&#x2F;x&#x2F;push&#x2F;token时的签名，而不是访问&#x2F;x&#x2F;resource&#x2F;fingerprint时的签名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702174940303.png" alt="image-20250702174940303"></p>
<p>另一个是：</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702172423703.png" alt="image-20250702172423703" style="zoom:80%;" />

<p>对它进行hook。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">actionKey=appkey&amp;appkey=1d8b6e7d45233436&amp;build=8480300&amp;c_locale=zh_CN&amp;channel=vivo&amp;device=android&amp;disable_rcmd=0&amp;mobi_app=android&amp;platform=android&amp;s_locale=zh_CN&amp;statistics=%7B%22appId%22%3A1%2C%22platform%22%3A3%2C%22version%22%3A%228.48.0%22%2C%22abtest%22%3A%22%22%7D&amp;ts=1751452489&amp;version=8.48.0&amp;sign=f7f2223690261f5c1c79da1725187a14</span><br></pre></td></tr></table></figure>

<p>可以发现，大部分内容基本一致，基本可以确认，这里的this.sign就是目标sign。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702183707225.png" alt="image-20250702183707225" style="zoom:80%;" />

<p>根据交叉引用，this.sign的赋值来自SignedQuery的构造函数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702175203684.png" alt="image-20250702175203684"></p>
<p>而构造函数在java层无任何引用，大概率是在native层创建的实例。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702175420469.png" alt="image-20250702175420469" style="zoom:80%;" />

<p>根据追踪，signQuery会返回一个SignedQuery实例，</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702180420898.png"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702180520275.png" style="zoom:80%;" />

<p>对应的库名是libbili.so。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702181915154.png" alt="image-20250702181915154" style="zoom:80%;" />

<p>如何定位函数s在native层的动态绑定地址呢？</p>
<p>方法1：</p>
<p>如果要hook RegisterNatives，由于存在反调试，在处理完反调试之前，是不能hook RegisterNatives的——反调不是在第一时间就能hook绕过的；如果在处理完反调之后，再hook RegisterNatives，又会错过一些JNI函数的注册。这个hook的时机不好把握。</p>
<p>方法2：</p>
<p>又或者用Unidbg模拟执行libbili.so，但只是为了看注册地址就去补环境，有点杀鸡用牛刀的感觉。</p>
<p>方法3：</p>
<p>这里有一个点子。</p>
<p>每一个Java函数都对应着C&#x2F;C++的一个ArtMethod结构体实例，可以遍历类的所有函数，然后拿到它们的handle句柄（ArtMethod地址），然后通过偏移，在ArtMethod的成员变量中找到绑定的Native地址，然后根据这个地址，判断位于哪个模块，函数的实际地址再减去模块基址，就可以得到文件内偏移地址了。</p>
<p>这个方式相对于前面2种方式，优点在于：可以任意时机获得偏移地址（也就是说，可以绕过反调再获得）；而且不用大费周章补环境。</p>
<p>实现效果如下，还不错。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[+] Java Method: com.bilibili.nativelibrary.LibBili.s(java.util.SortedMap)</span><br><span class="line">  |-- Method Handle: 0x9f149638</span><br><span class="line">  |-- Native Address: 0x797cf0a050</span><br><span class="line">  `-- Symbol Details: 0x9050 (offset: 0x9050 in libbili.so)</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702224745879.png" alt="image-20250702224745879" style="zoom:80%;" />

<h3 id="解密字符串"><a href="#解密字符串" class="headerlink" title="解密字符串"></a>解密字符串</h3><p>.datadiv_decodexxxxx是ollvm对字符串加密的特征。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702225223476.png" alt="image-20250702225223476" style="zoom:80%;" />

<p>在dump完并且修复后，字符串基本都解密完了，多了300多个字符串 。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250702230000335.png" alt="image-20250702230000335" style="zoom:80%;" />

<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>来到sub_9050。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250703142225026.png" alt="image-20250703142225026" style="zoom:80%;" />

<p>进入sub_162A8，从return倒推。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250703142607218.png" alt="image-20250703142607218"></p>
<p>v21和v7应该对应于str、str2。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250703142655119.png" alt="image-20250703142655119" style="zoom:80%;" />

<p>倒推，分析sub_18FF0。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250703150044293.png" alt="image-20250703150044293" style="zoom:80%;" />

<p>一路往里找加密算法，最后来到sub_106C4。</p>
<p>各种位移、异或、与、非操作，大概率是md5。</p>
<p>注意到，第248行有一个<code>-680876936</code>，转换成十六进制，相当于<code>0xD76AA478</code>，这正是MD5的T盒中的常数之一。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250703150219723.png" alt="image-20250703150219723"></p>
<p>同时，注意到存在<code>(v5 &gt;&gt; 3) &amp; 63</code>的操作，在md5中，这一般是获得字节数的操作。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250703150614129.png" alt="image-20250703150614129" style="zoom:80%;" />

<p>同时，在函数sub_FFAC发现了魔数赋值的地方。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250703153739699.png" alt="image-20250703153739699" style="zoom:80%;" />

<p>上述种种说明，这是一个md5运算，就是不知道有没有魔改。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">输入：</span><br><span class="line">			 0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F  0123456789ABCDEF</span><br><span class="line">7b4fb95310  61 63 63 65 73 73 5f 6b 65 79 3d 26 61 70 70 6b  access_key=&amp;appk</span><br><span class="line">7b4fb95320  65 79 3d 31 64 38 62 36 65 37 64 34 35 32 33 33  ey=1d8b6e7d45233</span><br><span class="line">7b4fb95330  34 33 36 26 62 72 61 6e 64 3d 4f 6e 65 50 6c 75  436&amp;brand=OnePlu</span><br><span class="line">7b4fb95340  73 26 62 75 69 6c 64 3d 38 34 38 30 33 30 30 26  s&amp;build=8480300&amp;</span><br><span class="line">7b4fb95350  63 5f 6c 6f 63 61 6c 65 3d 7a 68 5f 43 4e 26 63  c_locale=zh_CN&amp;c</span><br><span class="line">7b4fb95360  68 61 6e 6e 65 6c 3d 76 69 76 6f 26 64 69 73 61  hannel=vivo&amp;disa</span><br><span class="line">7b4fb95370  62 6c 65 5f 72 63 6d 64 3d 30 26 6d 56 65 72 73  ble_rcmd=0&amp;mVers</span><br><span class="line">7b4fb95380  69 6f 6e 3d 33 30 39 26 6d 61 6c 6c 56 65 72 73  ion=309&amp;mallVers</span><br><span class="line">7b4fb95390  69 6f 6e 3d 38 34 38 30 33 30 30 26 6d 6f 62 69  ion=8480300&amp;mobi</span><br><span class="line">7b4fb953a0  5f 61 70 70 3d 61 6e 64 72 6f 69 64 26 70 6c 61  _app=android&amp;pla</span><br><span class="line">7b4fb953b0  74 66 6f 72 6d 3d 61 6e 64 72 6f 69 64 26 73 5f  tform=android&amp;s_</span><br><span class="line">7b4fb953c0  6c 6f 63 61 6c 65 3d 7a 68 5f 43 4e 26 73 74 61  locale=zh_CN&amp;sta</span><br><span class="line">7b4fb953d0  74 69 73 74 69 63 73 3d 25 37 42 25 32 32 61 70  tistics=%7B%22ap</span><br><span class="line">7b4fb953e0  70 49 64 25 32 32 25 33 41 31 25 32 43 25 32 32  pId%22%3A1%2C%22</span><br><span class="line">7b4fb953f0  70 6c 61 74 66 6f 72 6d 25 32 32 25 33 41 33 25  platform%22%3A3%</span><br><span class="line">7b4fb95400  32 43 25 32 32 76 65 72 73 69 6f 6e 25 32 32 25  2C%22version%22%</span><br><span class="line">7b4fb95410  33 41 25 32 32 38 2e 34 38 2e 30 25 32 32 25 32  3A%228.48.0%22%2</span><br><span class="line">7b4fb95420  43 25 32 32 61 62 74 65 73 74 25 32 32 25 33 41  C%22abtest%22%3A</span><br><span class="line">7b4fb95430  25 32 32 25 32 32 25 37 44 26 74 72 69 62 65 56  %22%22%7D&amp;tribeV</span><br><span class="line">7b4fb95440  65 72 73 69 6f 6e 3d 30 26 74 73 3d 31 37 35 31  ersion=0&amp;ts=1751</span><br><span class="line">7b4fb95450  35 32 37 36 37 33                                527673</span><br><span class="line">输出：</span><br><span class="line">             0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F  0123456789ABCDEF</span><br><span class="line">7991c96590  31 35 31 30 66 39 39 39 62 33 62 39 38 38 31 37  1510f999b3b98817</span><br><span class="line">7991c965a0  39 39 61 30 33 34 33 64 32 64 38 62 38 63 64 62  99a0343d2d8b8cdb</span><br></pre></td></tr></table></figure>

<p>与标准的MD5结果不同，说明魔改了？（后来发现并没有）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250703153234782.png" alt="image-20250703153234782"></p>
<p>魔数和M盒赋值并没有魔改。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">v202 = *a1;</span><br><span class="line">  v2 = a1[<span class="number">1</span>];</span><br><span class="line">  v3 = a1[<span class="number">2</span>];</span><br><span class="line">  v4 = a1[<span class="number">3</span>];                                   <span class="comment">// 魔数，状态矩阵</span></span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v203 = v4;</span><br><span class="line">  <span class="keyword">while</span> ( v5 &lt; <span class="number">0x40</span> )                           <span class="comment">// M盒赋值</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0x180DFC9C</span>; i != <span class="number">0x94D2D6E7</span>; i = <span class="number">0x94D2D6E7</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(&amp;v207 + v6) = (*(<span class="type">unsigned</span> __int8 *)(a2 + v5 + <span class="number">3</span>) &lt;&lt; <span class="number">24</span>) | (*(<span class="type">unsigned</span> __int8 *)(a2 + v5 + <span class="number">1</span>) &lt;&lt; <span class="number">8</span>) ^ <span class="number">0xF91793FF</span> ^ ~*(<span class="type">unsigned</span> __int8 *)(a2 + v5) &amp; <span class="number">0xF91793FF</span> | (*(<span class="type">unsigned</span> __int8 *)(a2 + v5 + <span class="number">2</span>) &lt;&lt; <span class="number">16</span>);</span><br><span class="line">      v205 = v6 + <span class="number">1</span>;</span><br><span class="line">      v206 = v5 + <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v6 = v205;</span><br><span class="line">    v5 = v206;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>根据分析，在1-64轮中：第11轮的|变成了^；</p>
<p>第16轮的|变成了^；</p>
<p>第19轮的|变成了^；</p>
<p>第25轮不是魔改，因为位移后，使用<code>^</code>或者<code>|</code>，效果都一样，图中是我弄错了。</p>
<p>第31轮的|变成了^；</p>
<p>至于11、16、19、31轮，经过试验，发现<code>^</code>和<code>|</code>的效果是一样的，也就是说，编译器和混淆的结果，并不是魔改。</p>
<p>所以，sub_1046C是标准的MD5 transform，基本可以判定MD5是标准的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250704142231384.png"></p>
<p>分析了函数sub_18ff0后，发现是加了IV，所以导致结果不同。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250704173552945.png" alt="image-20250704173552945" style="zoom: 67%;" />

<p>IV如下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250704171007419.png" alt="image-20250704171007419" style="zoom:80%;" />

<p>验证，这回对上了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250704173755773.png" alt="image-20250704173755773" style="zoom:80%;" />

<h2 id="buvid"><a href="#buvid" class="headerlink" title="buvid"></a>buvid</h2><h3 id="定位-分析"><a href="#定位-分析" class="headerlink" title="定位 &amp;&amp; 分析"></a>定位 &amp;&amp; 分析</h3><p>先定位到getBuvid。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705162000190.png" alt="image-20250705162000190" style="zoom:80%;" />

<p><code>this.f136924d.m467330e()</code>会得到<code>buvid_remote</code>。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705162053958.png" alt="image-20250705162053958" style="zoom:80%;" />

<p>如果没有<code>buvid_remote</code>，就调用<code>this.f136923c.m467322e()</code>。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705162138693.png" alt="image-20250705162138693" style="zoom:80%;" />

<p><code>this.f403543a.get_buvid()</code>会获得存储的<code>buvid</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705162159918.png" alt="image-20250705162159918"></p>
<p>如果没存储，再调用<code>m467316f()</code>，获得<code>buvid_compat</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705162259284.png" alt="image-20250705162259284"></p>
<p>如果没存储，再调用<code>m467317g()</code>，获得<code>buvid_local</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705162341372.png" alt="image-20250705162341372"></p>
<p>如果上述哪个<code>buvid</code>是存储了的，会将它存放在<code>buvid</code>字段里。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705162444492.png" alt="image-20250705162444492" style="zoom:80%;" />

<p><code>buvid_remote</code>是服务器发的官方buvid；<code>buvid_compat</code>是兼容旧版的buvid；<code>buvid_local</code>是设备本身生成的临时buvid；而<code>buvid</code>是当前有效的buvid。</p>
<p>这里主要去分析<code>buvid_local</code>是如何生成的。</p>
<p>追踪下面这个函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705163516022.png" alt="image-20250705163516022" style="zoom: 80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705163619468.png" alt="image-20250705163619468" style="zoom:80%;" />

<p>存在3个引用。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705163640002.png" alt="image-20250705163640002"></p>
<p>这里追踪第1个，如果找不到加密点，再追踪第2个。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705163823887.png" alt="image-20250705163823887" style="zoom:80%;" />

<p>查看引用。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705163858895.png" alt="image-20250705163858895" style="zoom:80%;" />

<p>其中，<code>String strM467289e = this.f403533a instanceof AbstractC140824n.c ? this.f403534b.m467289e() : &quot;&quot;;</code>这一行代码是在获得存储的<code>buvid2</code>，我们的目标是计算获得buvid，所以这里继续追踪<code>strM467289e = this.f403537e.mo367721a();</code>。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705163953270.png" alt="image-20250705163953270" style="zoom:80%;" />

<p><code>this.f403537e</code>是一个接口实例，它的赋值来自于这。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705164238315.png" alt="image-20250705164238315"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705164347535.png" alt="image-20250705164347535"></p>
<p>而<code>InterfaceC107263b.f281975a.m367723a</code>会返回一个类<code>C109665c</code>的实例。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705164454544.png" alt="image-20250705164454544" style="zoom:80%;" />

<p>这个实例覆写了函数a、b，并且调用了interfaceC107265d接口对象中的函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705164517923.png" alt="image-20250705164517923" style="zoom:80%;" />

<p><code>interfaceC107265d</code>接口是如何实现的呢？追踪函数<code>C140819i</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705165004609.png" alt="image-20250705165004609"></p>
<p>再查看<code>this.f403544b</code>的赋值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705165036976.png" alt="image-20250705165036976"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705165048708.png" alt="image-20250705165048708"></p>
<p>查看<code>C140822l</code>的引用。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705165114935.png" alt="image-20250705165114935"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705165122875.png" alt="image-20250705165122875"></p>
<p>实现<code>interfaceC107265d</code>接口的对象是<code>new C134862b(null, 1, null)</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705165238685.png" alt="image-20250705165238685"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705165328400.png" alt="image-20250705165328400"></p>
<p>接下来读代码，分析函数<code>mo367721a()</code>。</p>
<p>获得实现接口实例的函数a。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InterfaceC107262a</span> <span class="variable">interfaceC107262aMo367726a</span> <span class="operator">=</span> <span class="built_in">this</span>._interface.mo367726a();</span><br></pre></td></tr></table></figure>

<p>而函数a返回了一个接口实例对象。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705170716282.png" alt="image-20250705170716282" style="zoom:80%;" />

<p>只有类C109664b实现了这个接口，在new的时候，并没有对这个接口进行初始化，所以这里<code>interfaceC107262aMo367726a</code>只会得到null。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705170618809.png" alt="image-20250705170618809"></p>
<p>继续往下看，这回进行初始化了，传的接口是getLogger。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (interfaceC107262aMo367726a == <span class="literal">null</span>) &#123;</span><br><span class="line">    interfaceC107262aMo367726a = <span class="keyword">new</span> <span class="title class_">C109664b</span>(<span class="built_in">this</span>._interface.getLogger());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705170947476.png" alt="image-20250705170947476" style="zoom:80%;" />

<p>而getLogger的返回值是<code>this.f378652a</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705171019147.png" alt="image-20250705171019147"></p>
<p>所以相当于调用了<code>new C109664b(null)</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705171107943.png" alt="image-20250705171107943"></p>
<p>继续往下看，获得了一个迭代器，根据当前的sdk版本，获得不同的接口列表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Iterator&lt;InterfaceC107264c&gt; it = this._interface.mo367728c().iterator();</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705171428333.png" alt="image-20250705171428333"></p>
<p>我手机的版本是32，之后分析listListOf的接口列表。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705171648413.png" alt="image-20250705171648413"></p>
<p>接着分析下面的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Iterator&lt;InterfaceC107264c&gt; it = <span class="built_in">this</span>._interface.mo367728c().iterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">strMo367720a</span> <span class="operator">=</span> interfaceC107262aMo367726a.mo367720a(it.next());</span><br><span class="line">            <span class="keyword">if</span> (strMo367720a.length() != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">this</span>._interface.mo367727b().contains(strMo367720a)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> strMo367720a;</span><br><span class="line">                &#125;</span><br><span class="line">                Function1&lt;String, Unit&gt; logger = <span class="built_in">this</span>._interface.getLogger();</span><br><span class="line">                <span class="keyword">if</span> (logger != <span class="literal">null</span>) &#123;</span><br><span class="line">                    logger.invoke(Intrinsics.stringPlus(strMo367720a, <span class="string">&quot; is bad buvid&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>上述代码中，只有下面2条关键语句——获得当前设备的buvid，如果不在黑名单中，便返回，作为buvid_local。</p>
<p><code>String strMo367720a = interfaceC107262aMo367726a.mo367720a(it.next());</code>：获得接口函数处理后的字符串。</p>
<p><code>this._interface.mo367727b()</code>：获得黑名单buvid。</p>
<p>来看看是如何生成str的，由3部分组成。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705173702892.png" alt="image-20250705173702892"></p>
<p>以其中1个接口为例。</p>
<p>前缀是<code>XU</code>，调用<code>mo367725d</code>可以获得<code>drmID</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705174511495.png" alt="image-20250705174511495"></p>
<p>来看看<code>String strM375856c = C109666d.m375856c(strMo367725d</code>，这是一个标准的MD5算法。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705175253222.png" alt="image-20250705175253222"></p>
<p>再看看<code>C109666d.m375857d(strM375856c)</code>，取出md5结果的第2、12、22字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705175440025.png" alt="image-20250705175440025"></p>
<p>最终结果是：”&lt;前缀&gt; + &lt;md5的2&#x2F;12&#x2F;22字节&gt; + &lt;md5结果&gt;”。</p>
<p>最后，看看除了drmId，其它接口返回的是什么内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705180003034.png" alt="image-20250705180003034" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705175903494.png" alt="image-20250705175903494" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705175918943.png" alt="image-20250705175918943" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705175930811.png" alt="image-20250705175930811" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705175941542.png" alt="image-20250705175941542" style="zoom:80%;" />

<h2 id="fp-local"><a href="#fp-local" class="headerlink" title="fp_local"></a>fp_local</h2><h3 id="定位-分析-1"><a href="#定位-分析-1" class="headerlink" title="定位 &amp;&amp; 分析"></a>定位 &amp;&amp; 分析</h3><p>搜出来的结果很少，可以一个一个看。由于大部分都是getXXX，这里直接可以锁定这一行。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705193709147.png" alt="image-20250705193709147"></p>
<p>函数m199614l中出现的字符串说明，fp_local与buvid有关。追踪<code>C144128a.m475557a</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705194458500.png" alt="image-20250705194458500"></p>
<p>函数<code>C144128a.m475557a</code>长这个样子。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705222536516.png" alt="image-20250705222536516"></p>
<p>再看<code>m475561e</code>，是一个md5加密，对“buvid + 设备型号 + 基带版本信息”字符串进行md5运算。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705222626793.png" alt="image-20250705222626793"></p>
<p>而C105446f.m362260e是将hex字符串转换成字节数组。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705223716486.png" alt="image-20250705223716486"></p>
<p>函数<code>m475563g</code>返回了一个时间。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705223735653.png" alt="image-20250705223735653"></p>
<p>函数<code>m475562f</code>返回了随机的8个字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250705223804073.png" alt="image-20250705223804073"></p>
<p>这就是本地指纹（fingerprint）的生成方式。</p>
<h2 id="请求体分析（protobuf）"><a href="#请求体分析（protobuf）" class="headerlink" title="请求体分析（protobuf）"></a>请求体分析（protobuf）</h2><p>分析关于<code>/x/resource/fingerprint</code>的请求体。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706122230382.png" alt="image-20250706122230382"></p>
<h3 id="定位-分析-2"><a href="#定位-分析-2" class="headerlink" title="定位 &amp;&amp; 分析"></a>定位 &amp;&amp; 分析</h3><p>搜索<code>/x/resource/fingerprint</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706122619513.png" alt="image-20250706122619513"></p>
<p>对接口交叉引用，来到如下图所示的位置。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706122719041.png" alt="image-20250706122719041"></p>
<p>逐步分析。</p>
<p><code>ServiceGenerator.createService(InterfaceC9422e.class)</code>：创建一个网络请求服务的实例，ServiceGenrator是一个工厂类，用于生成实现了InterfaceC9422e接口的代理对象。</p>
<p><code>.fingerprint(str, ...)</code>：对应一个具体的api，str是请求参数，而另一个参数是http请求体，我们要分析的就是请求体。</p>
<p>这里的fingerprint并不涉及实现，只是告诉retrofit设置str作为查询参数到url中；设置requestBody作为POST请求的主体等。</p>
<p><code>RequestBody.create(MediaType.parse(&quot;application/json&quot;), str2)</code>：创建了一个http请求体。</p>
<p>据上面的分析，可以知道str是请求参数字符串，str2是处理后的请求体，因此，下一步交叉引用<code>m34466b</code>，查看str2的来源。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706130307666.png" alt="image-20250706130307666" style="zoom:80%;" />

<p><code>this.f29694a</code>和<code>this.f29695b</code>来自于<code>RunnableC9421d</code>，继续查询引用。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706130359335.png" alt="image-20250706130359335"></p>
<p><code>new PostBodyModel(str2, str3).toJsonString()</code>是请求体。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706130448309.png" alt="image-20250706130448309"></p>
<p>继续追踪<code>m34467c</code>的引用，请求体和入参的str、data有关，继续追踪<code>m27200a</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706130803899.png" alt="image-20250706130803899"></p>
<p>str来自于<code>m199614l()</code>，而data来自于<code>C145722b.m479556b(Source.INIT)</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706131050898.png" alt="image-20250706131050898"></p>
<p>str取值为<code>fp_local</code>，至于fp_local的计算方式，之前分析过。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706131148767.png" alt="image-20250706131148767" style="zoom:80%;" />

<p>直接看return的内容，尝试获得main、property、sys数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">return new Data(</span><br><span class="line">    setEmptySet.contains(&quot;main&quot;) ? MapsKt.emptyMap() : m479558d(setEmptySet, source),</span><br><span class="line">    setEmptySet.contains(&quot;property&quot;) ? MapsKt.emptyMap() : C147370e.m483853a(),</span><br><span class="line">    setEmptySet.contains(&quot;system&quot;) ? MapsKt.emptyMap() : C147367b.m483842f()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706131238466.png" alt="image-20250706131238466"></p>
<p>main的数据如下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706141006523.png" alt="image-20250706141006523" style="zoom:80%;" />

<p>property的数据在native层获得。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706141120362.png" alt="image-20250706141120362" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706141143607.png" alt="image-20250706141143607"></p>
<p>sys的数据如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706141224013.png" alt="image-20250706141224013"></p>
<p>可以将main、property、sys都视作设备指纹。</p>
<p>查看函数<code>C98559a.m342912b(local_fp, data)</code>做了什么。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706143006180.png" alt="image-20250706143006180" style="zoom:80%;" />

<p>函数m342911a长这个样子，点入任意一个c55998aNewBuilder的函数中，会发现跳转到了类com.bilibili.datacenter.hakase.protobuf.AndroidDeviceInfo$DeviceInfo。</p>
<p>这一步是将明文指纹转换成 protobuf编码。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706143037404.png" alt="image-20250706143037404"></p>
<p>再来看函数<code>C101015b.m349014a</code>，它将protobuf编码的字节数组进行了加密。</p>
<p><code>RSA.loadPublicKey(BiliContext.application().getAssets().open(&quot;rsa_public_key.pem&quot;));</code>：获得rsa公钥。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706143923544.png" alt="image-20250706143923544"></p>
<p><code>C101014a.m349012e()</code>：获得随机的128位数据，作为AES密钥。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706144110172.png" alt="image-20250706144110172" style="zoom:80%;" />

<p><code>RSA.encryptByPublicKey(strM349012e, rSAPublicKeyLoadPublicKey)</code>：用rsa公钥对aes密钥进行加密。</p>
<p><code>C101014a.m349009b(bArr, strM349012e)</code>：对protobuf编码的字节数组，进行aes加密。</p>
<p><code>new Pair&lt;&gt;(strEncryptByPublicKey, strM349009b</code>：返回rsa加密的aes密钥和aes加密的protobuf数组。</p>
<p>之后就没什么好分析的了，将key和content转换成json格式传到服务器。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706144505630.png" alt="image-20250706144505630"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250706144718229.png" alt="image-20250706144718229" style="zoom:80%;" />

<h3 id="伪造指纹"><a href="#伪造指纹" class="headerlink" title="伪造指纹"></a>伪造指纹</h3><p>先用frida hook关键点，得到protobuf数据。</p>
<p>再使用blackboxprotobuf对protobuf数据进行解析，修改字段值，修改后转回protobuf。</p>
<p>然后生成aes密钥，对protobuf内容加密。</p>
<p>用assets文件夹下的rsa公钥，对生成的aes密钥进行加密。</p>
<p>最后，将构造好的内容，替换掉正常包的请求体。</p>
<h1 id="学习点"><a href="#学习点" class="headerlink" title="学习点"></a>学习点</h1><p>1.blackboxprotobuf的使用，定义proto文件。</p>
<p>2.mitmproxy可以抓取并解析protobuf报文。</p>
<p>3.reqable可以抓包、修改字段、发包、导出发包代码（python等语言）等。</p>
<p>4.如何定位关键字段的生成代码。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/01/ks-sig3%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/01/ks-sig3%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">ks/sig3分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-01 10:51:01 / 修改时间：11:00:51" itemprop="dateCreated datePublished" datetime="2025-07-01T10:51:01+08:00">2025-07-01</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>18k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>32 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>分析字段：__NS_sig3</p>
<h1 id="初步分析"><a href="#初步分析" class="headerlink" title="初步分析"></a>初步分析</h1><h2 id="查壳-查反调等"><a href="#查壳-查反调等" class="headerlink" title="查壳&#x2F;查反调等"></a>查壳&#x2F;查反调等</h2><p>利用工具，对apk进行一个初步判断。</p>
<p>似乎没有壳，那就不用脱壳了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250623150600246.png" alt="image-20250623150600246"></p>
<p>即便不做什么处理，我root后的手机，还是可以正常打开快手。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250623151926210.png" alt="image-20250623151926210" style="zoom:80%;" />

<h2 id="定位-NS-sig3的生成函数"><a href="#定位-NS-sig3的生成函数" class="headerlink" title="定位__NS_sig3的生成函数"></a>定位__NS_sig3的生成函数</h2><p>先在jadx中搜索，看看能否直接找到__NS_sig3的相关代码；如果不行，再试试hook HaspMap的put。</p>
<p>直接搜到了，那就直接再jadx中追踪了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250623153109921.png" alt="image-20250623153109921"></p>
<p>从这段代码中，可以知道__NS_sig3的长度是32字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250623184110143.png" alt="image-20250623184110143"></p>
<p>hook函数m160592a，获得request。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250623193413808.png" alt="image-20250623193413808"></p>
<p>下面这些请求路径不需要字段__NS_sig3。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;/rest/system/startup&quot;</span>, <span class="string">&quot;/rest/n/system/abtest/config&quot;</span>, <span class="string">&quot;/rest/system/keyconfig&quot;</span>, <span class="string">&quot;/rest/n/system/realtime/startup&quot;</span>, <span class="string">&quot;/rest/n/live/config/startup&quot;</span>, <span class="string">&quot;/rest/n/feed/hotFast&quot;</span>, <span class="string">&quot;/rest/n/feed/selectionFast&quot;</span>, <span class="string">&quot;/rest/n/encourage/startup&quot;</span>, <span class="string">&quot;/rest/zt/share/system/startup&quot;</span>, <span class="string">&quot;/rest/system/startup&quot;</span>, <span class="string">&quot;/rest/im/wd/user/startup/push&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>在分析__NS_sig3的加密流程之前，注意到，加密函数m160594c的输入是encodePath + str，encodePath不必多说，而这里的str是一个长度为32的字符串（相当于16字节，大概率是md5），接下来分析它是从哪里来的。</p>
<h3 id="sig"><a href="#sig" class="headerlink" title="sig"></a>sig</h3><p>下列图表示我的追踪“轨迹”。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250623200734680.png" alt="image-20250623200734680"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250623200903209.png" alt="image-20250623200903209" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250623200927145.png" alt="image-20250623200927145" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250623200949608.png" alt="image-20250623200949608"></p>
<p>假如要使用Sig3，需要清空bodyParam。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250623201121861.png" alt="image-20250623201121861" style="zoom: 67%;" />

<p>用IDA打开getClock对应的libcore。</p>
<p>函数sub_1908出现了md5魔数。——md5_init。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624133213139.png" alt="image-20250624133213139" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624133427607.png" alt="image-20250624133427607" style="zoom:80%;" />

<p>函数sub_1934是md5_update，函数sub_1A4C是md5_transform。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624134812613.png" alt="image-20250624134812613" style="zoom:80%;" />

<p>函数sub_19C0是md5_final。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624135258494.png" alt="image-20250624135258494" style="zoom:80%;" />

<p>所以，sig就是urlParams、bodyParams、sdk_version等数据经过md5处理的结果，这里就不去验证是不是标准md5了。</p>
<h3 id="函数m160599c"><a href="#函数m160599c" class="headerlink" title="函数m160599c"></a>函数m160599c</h3><p>下列图为追踪顺序。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624142448019.png" alt="image-20250624142448019" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624142722093.png" alt="image-20250624142722093"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624142754170.png" alt="image-20250624142754170" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624142908780.png" alt="image-20250624142908780"></p>
<p>追踪函数m33365b。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624143324879.png" alt="image-20250624143324879" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624143338678.png" alt="image-20250624143338678" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624143355293.png" alt="image-20250624143355293"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624152425956.png" alt="image-20250624152425956" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624152503255.png" alt="image-20250624152503255"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624152818814.png" alt="image-20250624152818814"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624152838913.png" alt="image-20250624152838913"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624152902265.png" alt="image-20250624152902265"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624152938725.png" alt="image-20250624152938725"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624152954664.png" alt="image-20250624152954664" style="zoom: 80%;" />

<p>在函数doCommandNative处hook，打印调用栈。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624154205541.png" alt="image-20250624154205541"></p>
<p>hook一下函数doCommandNative的参数，看看是什么。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> (String) <span class="built_in">this</span>.f46796k.mo33427a().mo33476a(</span><br><span class="line">    <span class="number">10418</span>, </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="keyword">new</span> <span class="title class_">String</span>(abstractC16338n.mo33447e()).trim()&#125;, <span class="comment">// strEncodePath + str</span></span><br><span class="line">    C16278b.m33236i().m33242j().mo33327a(), </span><br><span class="line">    -<span class="number">1</span>, </span><br><span class="line">    Boolean.FALSE, </span><br><span class="line">    C16278b.m33236i().m33242j().mo33328c(), </span><br><span class="line">    <span class="literal">null</span>, </span><br><span class="line">    Boolean.valueOf(abstractC16338n.mo33448f()), </span><br><span class="line">    abstractC16338n.mo33455m()); <span class="comment">// 空字符串</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624170504631.png" alt="image-20250624170504631"></p>
<h2 id="定位生成函数位于的so（-去除花指令）"><a href="#定位生成函数位于的so（-去除花指令）" class="headerlink" title="定位生成函数位于的so（&amp;&amp; 去除花指令）"></a>定位生成函数位于的so（&amp;&amp; 去除花指令）</h2><p>跑一下脚本，看看doCommandNative在哪个so里。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250624175134710.png" alt="image-20250624175134710"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[RegisterNatives] java_class: com.kuaishou.android.security.internal.dispatch.JNICLibrary name: doCommandNative sig: (I[Ljava/lang/Object;)Ljava/lang/Object; fnPtr: <span class="number">0xa3cd0435</span>  fnOffset: <span class="number">0xa3cd0435</span> libkwsgmain.so!<span class="number">0x46435</span>  callee: <span class="number">0xa3cd77fb</span> libkwsgmain.so!<span class="number">0x4d7fb</span></span><br></pre></td></tr></table></figure>

<p>位于libkwsgmain.so，偏移0x46435。</p>
<p>好像存在一些加密代码？试一下从内存中dump下来，然后修补。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250625111639967.png" alt="image-20250625111639967" style="zoom:80%;" />

<p>dump。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250625115313177.png" alt="image-20250625115313177"></p>
<p>修复。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250625115717885.png" alt="image-20250625115717885"></p>
<p>突然想起来，偏移0x46435，说明是thumb指令，应该从0x46434开始算起。</p>
<p>上来就是BL跳转。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250625144418429.png" alt="image-20250625144418429"></p>
<p>在sub_B764中，LR &#x3D; 0x46448，而R0是未知的，需要回到0x46434查找。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250625161434306.png" alt="image-20250625161434306" style="zoom:80%;" />

<p>R0 &#x3D; 0x1fa。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250625162034294.png" alt="image-20250625162034294"></p>
<p>R1 &#x3D; [0x46c30]</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250625162534946.png" alt="image-20250625162534946"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250625162834178.png" alt="image-20250625162834178"></p>
<p>而0x46448 + 0x5C60 &#x3D;&#x3D; 0x4C0A8，PC &#x3D; 0x4C0A8。</p>
<p>然而，0x4C0A8处也没有函数定义，这样不好分析。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250625170120530.png" alt="image-20250625170120530"></p>
<p>然而，在最新版本的快手中，不是这个样子的方式跳转的。</p>
<p>重新跑了1次hook RegisterNatives的脚本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[RegisterNatives] java_class: com.kuaishou.android.security.internal.dispatch.JNICLibrary name: doCommandNative sig: (I[Ljava/lang/Object;)Ljava/lang/Object; fnPtr: 0x7bb8184cd4  fnOffset: 0x7bb8184cd4 libkwsgmain.so!0x40cd4  callee: 0x7bb818a164 libkwsgmain.so!0x46164</span><br></pre></td></tr></table></figure>

<p>BR混淆。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250627112711210.png" alt="image-20250627112711210"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250627112737959.png" alt="image-20250627112737959" style="zoom:80%;" />

<p>上述的计算，可以整理成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">X0, X1放入栈中</span><br><span class="line"></span><br><span class="line">; 下面计算X9的值</span><br><span class="line">STP X2, X30, [SP + 0x10]	;[SP+0x18] = X30</span><br><span class="line">ADR	X1, dword_40cfc			;X1 = 0x40cfc</span><br><span class="line">X1 = X1 - 0x4</span><br><span class="line">X0 = X1</span><br><span class="line">X0 = X0 + 0x14</span><br><span class="line">[SP+0x18] = X0</span><br><span class="line">LDP X2, X9, [SP + 0x10]</span><br><span class="line"></span><br><span class="line">X0, X1 = 原来的内容</span><br><span class="line">BR X9</span><br></pre></td></tr></table></figure>

<p>只要我们知道X30的值，就可以利用keypatch将BR X9改成B xxxx。</p>
<p>JNI_OnLoad也是这样的混淆。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250627114224817.png" alt="image-20250627114224817"></p>
<p>直接用一个IDA脚本，遍历so文件。——获得3个操作数，然后在BR X9处进行修改。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> keystone</span><br><span class="line"><span class="keyword">from</span> keystone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pattern_search</span>(<span class="params">pattern</span>):</span><br><span class="line">    match_list = []</span><br><span class="line">    addr = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        addr = ida_bytes.bin_search(addr, idc.BADADDR, <span class="built_in">bytes</span>.fromhex(pattern), <span class="literal">None</span>, </span><br><span class="line">                                idaapi.BIN_SEARCH_FORWARD, idaapi.BIN_SEARCH_NOCASE)</span><br><span class="line">        <span class="keyword">if</span> addr == idc.BADADDR:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            match_list.append(addr)</span><br><span class="line">            addr = addr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> match_list</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_jumpout_addr</span>(<span class="params">addr</span>):</span><br><span class="line">    data1 = idc.get_operand_value(addr + <span class="number">8</span>, <span class="number">1</span>)</span><br><span class="line">    data2 = idc.get_operand_value(addr + <span class="number">12</span>, <span class="number">2</span>)</span><br><span class="line">    data3 = idc.get_operand_value(addr + <span class="number">20</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> data1 - data2 + data3</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_asm</span>(<span class="params">code, addr</span>):</span><br><span class="line">    ks = Ks(keystone.KS_ARCH_ARM64, keystone.KS_MODE_LITTLE_ENDIAN)</span><br><span class="line">    encode, count = ks.asm(code, addr)</span><br><span class="line">    <span class="keyword">return</span> encode</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    match_list = pattern_search(<span class="string">&quot;E0 07 BE A9 E2 7B 01 A9&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">len</span>(match_list))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(match_list)):</span><br><span class="line">        encode_b = generate_asm(<span class="string">&quot;B &quot;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(get_jumpout_addr(match_list[i]))), match_list[i])</span><br><span class="line">        encode_nop = generate_asm(<span class="string">&quot;nop&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        ida_bytes.patch_bytes(match_list[i], <span class="built_in">bytes</span>(encode_b))</span><br><span class="line">        ida_bytes.patch_bytes(match_list[i] + <span class="number">4</span>, <span class="built_in">bytes</span>(encode_nop) * <span class="number">9</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>执行完后是这样的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250627152421719.png" alt="image-20250627152421719"></p>
<h1 id="Unidbg补环境"><a href="#Unidbg补环境" class="headerlink" title="Unidbg补环境"></a>Unidbg补环境</h1><p>先搭最基本的架子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.AndroidEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.backend.Unicorn2Factory;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.array.ArrayObject;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.wrapper.DvmBoolean;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.wrapper.DvmInteger;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.virtualmodule.android.AndroidModule;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.virtualmodule.android.JniGraphics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">sig3</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Memory memory;</span><br><span class="line"></span><br><span class="line">    sig3()&#123;</span><br><span class="line">        emulator = AndroidEmulatorBuilder.for64Bit()</span><br><span class="line">                .setProcessName(<span class="string">&quot;com.smile.gifmaker&quot;</span>)</span><br><span class="line">                .addBackendFactory(<span class="keyword">new</span> <span class="title class_">Unicorn2Factory</span>(<span class="literal">true</span>))  <span class="comment">// 处理器类型</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置执行多少条指令切换一次线程</span></span><br><span class="line">        emulator.getBackend().registerEmuCountHook(<span class="number">10000</span>);</span><br><span class="line">        <span class="comment">// 开启日志</span></span><br><span class="line">        emulator.getSyscallHandler().setVerbose(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 开启线程调度器</span></span><br><span class="line">        emulator.getSyscallHandler().setEnableThreadDispatcher(<span class="literal">true</span>);</span><br><span class="line">        memory = emulator.getMemory(); <span class="comment">// 模拟器的内存操作接口</span></span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>)); <span class="comment">// 设置系统类库解</span></span><br><span class="line">        <span class="comment">//创建虚拟机并指定APK文件</span></span><br><span class="line">        vm = emulator.createDalvikVM(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/resources/ks_pack/ks.apk&quot;</span>));</span><br><span class="line">        <span class="comment">// 设置是否打印Jni调用细节</span></span><br><span class="line">        vm.setVerbose(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 补jni方法</span></span><br><span class="line">        vm.setJni(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载so</span></span><br><span class="line">        <span class="type">DalvikModule</span> <span class="variable">dm</span> <span class="operator">=</span> vm.loadLibrary(<span class="string">&quot;kwsgmain&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 加载好的libkwsgmain.so对应为一个模块</span></span><br><span class="line">        <span class="keyword">module</span> = dm.getModule();</span><br><span class="line">        <span class="comment">// 手动执行JNI_OnLoad函数</span></span><br><span class="line">        dm.callJNI_OnLoad(emulator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">sig3</span> <span class="variable">_sig3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">sig3</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对照着之前的调用参数，添加调用doCommandNative的代码。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250627184717187.png" alt="image-20250627184717187"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">get_Sig3</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">DvmClass</span> <span class="variable">JNICLibrary</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com.kuaishou.android.security.internal.dispatch.JNICLibrary&quot;</span>);</span><br><span class="line">    <span class="type">StringObject</span> <span class="variable">urlObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;xianyu&quot;</span>);</span><br><span class="line">    <span class="type">StringObject</span> <span class="variable">appkey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;d7b7d042-d4f2-4012-be60-d97ff2429c17&quot;</span>);</span><br><span class="line">    <span class="type">DvmInteger</span> <span class="variable">intergetobj</span> <span class="operator">=</span> DvmInteger.valueOf(vm, -<span class="number">1</span>);</span><br><span class="line">    <span class="type">DvmBoolean</span> <span class="variable">boolobj</span> <span class="operator">=</span> DvmBoolean.valueOf(vm, <span class="literal">false</span>);</span><br><span class="line">    DvmObject&lt;?&gt; context = vm.resolveClass(<span class="string">&quot;com/yxcorp/gifshow/App&quot;</span>).newObject(<span class="literal">null</span>); <span class="comment">// context</span></span><br><span class="line">    <span class="type">StringObject</span> <span class="variable">appkey2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="type">ArrayObject</span> <span class="variable">arg2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayObject</span>(<span class="keyword">new</span> <span class="title class_">ArrayObject</span>(urlObj), appkey, intergetobj, boolobj, context, <span class="literal">null</span>, boolobj, appkey2);</span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> JNICLibrary.callStaticJniMethodObject(emulator,<span class="string">&quot;doCommandNative(I[Ljava/lang/Object;)Ljava/lang/Object;&quot;</span>,<span class="number">10418</span>,arg2).getValue().toString();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>报错如下，提示返回值是null。</p>
<p>一般这种情况，都是调用so接口的时候，没有初始化导致的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.lang.NullPointerException: Cannot invoke <span class="string">&quot;com.github.unidbg.linux.android.dvm.DvmObject.getValue()&quot;</span> because the <span class="keyword">return</span> value of <span class="string">&quot;com.github.unidbg.linux.android.dvm.DvmClass.callStaticJniMethodObject(com.github.unidbg.Emulator, String, Object[])&quot;</span> is <span class="literal">null</span></span><br><span class="line">	at com.ks.sig3.get_Sig3(sig3.java:<span class="number">63</span>)</span><br><span class="line">	at com.ks.sig3.main(sig3.java:<span class="number">69</span>)</span><br></pre></td></tr></table></figure>

<p>libkwsgmain.so里面，一共注册了5个函数，把它们hook起来，不过似乎并没有什么关联。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[RegisterNatives] java_class: com.kuaishou.android.security.internal.dispatch.JNICLibrary name: doCommandNative sig: (I[Ljava/lang/Object;)Ljava/lang/Object; fnPtr: <span class="number">0x7bb8184cd4</span>  fnOffset: <span class="number">0x7bb8184cd4</span> libkwsgmain.so!<span class="number">0x40cd4</span>  callee: <span class="number">0x7bb818a164</span> libkwsgmain.so!<span class="number">0x46164</span></span><br><span class="line">[RegisterNatives] java_class: com.kuaishou.android.security.internal.dispatch.JNICLibrary name: gDBF sig: ()J fnPtr: <span class="number">0x7bb81848a4</span>  fnOffset: <span class="number">0x7bb81848a4</span> libkwsgmain.so!<span class="number">0x408a4</span>  callee: <span class="number">0x7bb818a164</span> libkwsgmain.so!<span class="number">0x46164</span></span><br><span class="line">[RegisterNatives] java_class: com.kuaishou.android.security.internal.dispatch.JNICLibrary name: dCaBk sig: (ILjava/lang/String;[BI)V fnPtr: <span class="number">0x7bb8184948</span>  fnOffset: <span class="number">0x7bb8184948</span> libkwsgmain.so!<span class="number">0x40948</span>  callee: <span class="number">0x7bb818a164</span> libkwsgmain.so!<span class="number">0x46164</span></span><br><span class="line">[RegisterNatives] java_class: com.kuaishou.android.security.internal.dispatch.JNICLibrary name: gDGI sig: ()[Ljava/lang/String; fnPtr: <span class="number">0x7bb81843bc</span>  fnOffset: <span class="number">0x7bb81843bc</span> libkwsgmain.so!<span class="number">0x403bc</span>  callee: <span class="number">0x7bb818a164</span> libkwsgmain.so!<span class="number">0x46164</span></span><br><span class="line">[RegisterNatives] java_class: com.kuaishou.android.security.internal.dispatch.JNICLibrary name: gKSF sig: ()J fnPtr: <span class="number">0x7bb81847f0</span>  fnOffset: <span class="number">0x7bb81847f0</span> libkwsgmain.so!<span class="number">0x407f0</span>  callee: <span class="number">0x7bb818a164</span> libkwsgmain.so!<span class="number">0x46164</span></span><br></pre></td></tr></table></figure>

<p>同时，注意到Command ID也是有不同的，打印一下args[2]。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250627215223529.png" alt="image-20250627215223529"></p>
<p>可以发现，在第一时间内只会调用1次command ID &#x3D; 0x28ac，这大概率是初始化的一部分。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250627215156751.png" alt="image-20250627215156751" style="zoom:80%;" />

<p>所以，加一个执行10412的函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">moduleInit</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">DvmClass</span> <span class="variable">JNICLibrary</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com.kuaishou.android.security.internal.dispatch.JNICLibrary&quot;</span>);</span><br><span class="line">    <span class="type">StringObject</span> <span class="variable">appkey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;d7b7d042-d4f2-4012-be60-d97ff2429c17&quot;</span>);</span><br><span class="line">    DvmObject&lt;?&gt; context = vm.resolveClass(<span class="string">&quot;com/yxcorp/gifshow/App&quot;</span>).newObject(<span class="literal">null</span>); <span class="comment">// context</span></span><br><span class="line">    <span class="type">ArrayObject</span> <span class="variable">arg2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayObject</span>(<span class="literal">null</span>, appkey, <span class="literal">null</span>, <span class="literal">null</span>, context, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    JNICLibrary.callStaticJniMethodObject(emulator,<span class="string">&quot;doCommandNative(I[Ljava/lang/Object;)Ljava/lang/Object;&quot;</span>,<span class="number">10412</span>,arg2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后遇到缺少类的错误。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">callStaticVoidMethodV</span><span class="params">(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;com/kuaishou/android/security/internal/common/ExceptionProxy-&gt;nativeReport(ILjava/lang/String;)V&quot;</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; callStaticObjectMethodV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;com/kuaishou/android/security/internal/common/ExceptionProxy-&gt;getProcessName(Landroid/content/Context;)Ljava/lang/String;&quot;</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;com.smile.gifmaker&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.callStaticObjectMethodV(vm, dvmClass, signature, vaList);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;com/yxcorp/gifshow/App-&gt;getPackageCodePath()Ljava/lang/String;&quot;</span>: &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;/data/app/com.smile.gifmaker-VZhzinzcefoqqzJZ47EE0A==/base.apk&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;com/yxcorp/gifshow/App-&gt;getPackageName()Ljava/lang/String;&quot;</span>: &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;com.smile.gifmaker&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;com/yxcorp/gifshow/App-&gt;getAssets()Landroid/content/res/AssetManager;&quot;</span>: &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AssetManager</span>(vm, signature);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;com/yxcorp/gifshow/App-&gt;getPackageManager()Landroid/content/pm/PackageManager;&quot;</span>: &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;android.content.pm.PackageManager&quot;</span>).newObject(signature);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>仍然报错空指针，对比了一些和其它人博客的区别。</p>
<p>补了一句↓，这样就可以正常跑出结果了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">AndroidModule</span>(emulator, vm).register(memory);</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250628144948500.png" alt="image-20250628144948500"></p>
<p>每跑一次，都会有一个新结果，为了固定结果，需要将时间戳、随机数导致的，修改下面这个文件的currentTimeMillis()。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/main/java/com/github/unidbg/unix/UnixSyscallHandler.java</span><br></pre></td></tr></table></figure>

<p>固定一下，时间固定成1751095318144。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250628152206220.png" alt="image-20250628152206220"></p>
<p>结果固定为c4d5a086d88864b88c8c8f8ef7c6668e830cc8fe919d9385。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250628152444173.png" alt="image-20250628152444173"></p>
<p>trace指令流。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">traceCode</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">traceFile</span> <span class="operator">=</span> <span class="string">&quot;unidbg-android/src/test/java/com/ks/traceCode.log&quot;</span>; <span class="comment">// 输出的路径</span></span><br><span class="line">    <span class="type">PrintStream</span> <span class="variable">traceStream</span> <span class="operator">=</span> <span class="literal">null</span>; <span class="comment">// 打印流</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        traceStream = <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(traceFile), <span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// traceCode 对代码进行监控</span></span><br><span class="line">    emulator.traceCode(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base + <span class="keyword">module</span>.size).setRedirect(traceStream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>在文件traceCode.log中，追踪结果“c4d5a086d88864b88c8c8f8ef7c6668e830cc8fe919d9385”。——这里的字符串是之前分析小红书的时候，修改Unidbg得到的。</p>
<p>第一次出现的地址在：0x13b9c，位于函数sub_13b54内。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250628155455570.png" alt="image-20250628155455570"></p>
<p>函数sub_13B54将result中的结果提取到a2中，a2是一个string类型（从sso优化看出来的）。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250628160428702.png" alt="image-20250628160428702" style="zoom:80%;" />

<p>观察trace日志，结果位于[x0+0x28]的位置，而x0是调用sub_13b54传入的入参。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250629153431870.png" alt="image-20250629153431870"></p>
<p>在函数sub_3CC28内调用了sub_13B54，对这个函数进行分析，发现a1是v9的来源，因此hook函数sub_3cc28。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250629154704114.png" alt="image-20250629154704114"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250629155642090.png" alt="image-20250629155642090" style="zoom: 67%;" />

<p>查看sub_3cc28的引用。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250629184620681.png" alt="image-20250629184620681" style="zoom:80%;" />

<p>根据日志，发现是从0x44c8c跳转过来的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250629162305374.png" alt="image-20250629162305374"></p>
<p>0x44c8c不在定义的函数内，于是我在日志中，划分了一个函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250629191029580.png" alt="image-20250629191029580" style="zoom:80%;" />

<p>这个函数的栈不平衡，但勉强可以用来分析，总比纯看汇编方便。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250629192132769.png" alt="image-20250629192132769"></p>
<p>观察v98，注意到，循环次数是23次，但最后的结果是24字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250629225110845.png" alt="image-20250629225110845"></p>
<p>对着地址0x44c04下断点。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250629225249476.png" alt="image-20250629225249476"></p>
<p>下图是第一次执行到0x44c04的结果，会发现，最后一个字节已经赋了正确的值。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250629231042590.png" alt="image-20250629231042590" style="zoom:80%;" />

<p>最后一个字节是单独赋值的，可以关注一下这里的v101。	</p>
<p>v101的高8位是：v48的低8位 | v49的高8位，v48源于前23个字节累加然后取负。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250629234640841.png" alt="image-20250629234640841"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630000912063.png" alt="image-20250630000912063"></p>
<p>而v49来自一个略微复杂的计算。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v49 = ((<span class="type">unsigned</span> __int64)qword_70910 &gt;&gt; <span class="number">53</span>) &amp; <span class="number">0x10</span> | ((<span class="type">unsigned</span> __int64)qword_70910 &gt;&gt; <span class="number">54</span>) &amp; <span class="number">0x20</span> | ((<span class="type">unsigned</span> __int64)qword_70910 &gt;&gt; <span class="number">44</span>) &amp; <span class="number">0x40</span> | v46 | <span class="number">0xD00</span>;</span><br></pre></td></tr></table></figure>

<p>对红色框里的v98进行hook，查看24个字节在异或之前是什么样的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630085152982.png" alt="image-20250630085152982"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">41 51 27 00 59 08 e7 3a 01 00 00 00 7e 4e ed 04 16 98 5f 68 00 0d 00 85</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630085317372.png" alt="image-20250630085317372"></p>
<h2 id="改变输入"><a href="#改变输入" class="headerlink" title="改变输入"></a>改变输入</h2><p>有3个可以改变的输入，url、appkey、时间戳，观察改变输入后，内容有什么不同。</p>
<h3 id="urlObj"><a href="#urlObj" class="headerlink" title="urlObj"></a>urlObj</h3><p>输入：”xianyu” -&gt; “x14nuy”。</p>
<p>v49的值未变，0xd00 -&gt; 0xd00。</p>
<p>v98的12-15字节发生了变化，最后1个字节之所以变了，是因为前23字节存在变化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">41 51 27 00 59 08 e7 3a 01 00 00 00 |7e 4e ed 04| 16 98 5f 68 00 0d 00 85</span><br><span class="line">↓↓↓</span><br><span class="line">41 51 27 00 59 08 e7 3a 01 00 00 00 |7f 7c 00 53| 16 98 5f 68 00 0d 00 f4</span><br></pre></td></tr></table></figure>

<h3 id="appkey"><a href="#appkey" class="headerlink" title="appkey"></a>appkey</h3><p>输入：”d7b7d042-d4f2-4012-be60-d97ff2429c17” -&gt; “d7b7d042-d4f2-4012-60be-d97ff2429c17”。</p>
<p>不能改，改了就报错。</p>
<h3 id="时间戳"><a href="#时间戳" class="headerlink" title="时间戳"></a>时间戳</h3><p>输入：”1751095318144L” -&gt; “1751095318145L”。</p>
<p>v49的值未变，0xd00 -&gt; 0xd00。</p>
<p>v98的值未变，可能是时间戳改动太小了？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">41 51 27 00 59 08 e7 3a 01 00 00 00 7e 4e ed 04 16 98 5f 68 00 0d 00 85</span><br><span class="line">↓↓↓</span><br><span class="line">41 51 27 00 59 08 e7 3a 01 00 00 00 7e 4e ed 04 16 98 5f 68 00 0d 00 85</span><br></pre></td></tr></table></figure>

<p>输入：”1751095318144L” -&gt; “1751105319144L”。</p>
<p>v49的值未变，0xd00 -&gt; 0xd00。</p>
<p>v98的4-7和16-17字节发生了变化，最后1个字节之所以变了，是因为前23字节存在变化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">41 51 27 00 |59 08 e7 3a| 01 00 00 00 7e 4e ed 04 |16 98| 5f 68 00 0d 00 85</span><br><span class="line">↓↓↓</span><br><span class="line">41 51 27 00 |b6 ca a0 0e| 01 00 00 00 7e 4e ed 04 |27 bf| 5f 68 00 0d 00 a1</span><br></pre></td></tr></table></figure>

<p>如果输入改成”1111111111111L”。</p>
<p>v49的值未变，0xd00 -&gt; 0xd00。</p>
<p>v98的4-7和16-19字节发生了变化，最后1个字节之所以变了，是因为前23字节存在变化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">41 51 27 00 |59 08 e7 3a| 01 00 00 00 7e 4e ed 04 |16 98 5f 68| 00 0d 00 85</span><br><span class="line"></span><br><span class="line">41 51 27 00 |7c 75 c0 79| 01 00 00 00 7e 4e ed 04 |c7 35 3a 42| 00 0d 00 da</span><br></pre></td></tr></table></figure>

<h3 id="urlObj和时间戳"><a href="#urlObj和时间戳" class="headerlink" title="urlObj和时间戳"></a>urlObj和时间戳</h3><p>输入：”xianyu” -&gt; “x14nuy”。</p>
<p>输入：”1751095318144L” -&gt; “1111111111111L”。</p>
<p>v49的值未变，0xd00 -&gt; 0xd00。</p>
<p>v98的4-7、12-15、16-19字节发生了变化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">41 51 27 00 |59 08 e7 3a| 01 00 00 00 |7e 4e ed 04| |16 98 5f 68| 00 0d 00 85</span><br><span class="line">↓↓↓</span><br><span class="line">41 51 27 00 |7c 75 c0 79| 01 00 00 00 |7f 7c 00 53| |c7 35 3a 42| 00 0d 00 49</span><br></pre></td></tr></table></figure>

<h2 id="16-19字节"><a href="#16-19字节" class="headerlink" title="16-19字节"></a>16-19字节</h2><p>注意到，参与计算的时间戳是以s为单位。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630105048439.png" alt="image-20250630105048439"></p>
<p>1751095318144L是微秒，换算成秒的话，值为1751095318L，即0x68 5f 98 16，对应于v98的第16-19字节。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630105301686.png" alt="image-20250630105301686" style="zoom: 67%;" />

<h2 id="20-23字节"><a href="#20-23字节" class="headerlink" title="20-23字节"></a>20-23字节</h2><p>前面分析了，v49的值恒定为0xd00，不管输入的urlObjc和时间戳如何变化，都为这个值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v49 = ((<span class="type">unsigned</span> __int64)qword_70910 &gt;&gt; <span class="number">53</span>) &amp; <span class="number">0x10</span> | ((<span class="type">unsigned</span> __int64)qword_70910 &gt;&gt; <span class="number">54</span>) &amp; <span class="number">0x20</span> | ((<span class="type">unsigned</span> __int64)qword_70910 &gt;&gt; <span class="number">44</span>) &amp; <span class="number">0x40</span> | v46 | <span class="number">0xD00</span>;</span><br></pre></td></tr></table></figure>

<p><code>((unsigned __int64)qword_70910 &gt;&gt; 53) &amp; 0x10</code>实际取了qword_70910第57位，作为v49的第4位（从0开始）。</p>
<p><code>((unsigned __int64)qword_70910 &gt;&gt; 54) &amp; 0x20</code>实际取了qword_70910第59位，作为v49的第5位。</p>
<p><code>((unsigned __int64)qword_70910 &gt;&gt; 44) &amp; 0x40</code>实际取了qword_70910第50位，作为v49的第6位。</p>
<p>hook了一下，查看qword_70910和v46的值。</p>
<p>qword_70910 &#x3D; x8 &#x3D; 0xc001000000000000，所以20-22字节固定为0x000D00。</p>
<p>而最后8位（第23字节）为前面数的总和（超过255取负）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630115638274.png" alt="image-20250630115638274"></p>
<p>我怀疑这里的dword_70910是混淆，干扰计算用的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630115957984.png" alt="image-20250630115957984" style="zoom:80%;" />

<h2 id="12-15字节"><a href="#12-15字节" class="headerlink" title="12-15字节"></a>12-15字节</h2><p>修改urlObj，可以使得12-15字节发生变化。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630143629732.png" alt="image-20250630143629732"></p>
<p>在函数sub_120D8处进行hook，</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630144152920.png" alt="image-20250630144152920"></p>
<p>x0应该是我们传入的数据，但不知道被做了什么处理。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630144807369.png" alt="image-20250630144807369" style="zoom:80%;" />

<p>x2指向的内容也不是明文。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630144825417.png" alt="image-20250630144825417" style="zoom:80%;" />

<h3 id="CRC32"><a href="#CRC32" class="headerlink" title="CRC32"></a>CRC32</h3><p>经过搜索，x2指向的内容是crc32的魔数，<code>B71DC104</code>是标准crc32算法的查找表中预计算好的一个魔数，说明函数sub_120d8跟crc32算法相关。——并且是标准的crc32算法。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630152039424.png" alt="image-20250630152039424"></p>
<h3 id="AES"><a href="#AES" class="headerlink" title="AES"></a>AES</h3><p>那么，x0的48字节是什么呢？往地址0x124ff000下写断点。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630154309863.png" alt="image-20250630154309863"></p>
<p>再hook，打印源地址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630154344863.png" alt="image-20250630154344863"></p>
<p>再下写断点。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630154454278.png" alt="image-20250630154454278" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630164254200.png" alt="image-20250630164254200" style="zoom:80%;" />

<p>存在花指令，导致地址0x1E7FC不在定义的函数内。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630182324242.png" alt="image-20250630182324242" style="zoom:80%;" />

<p>IDA识别后，把0x1E7FC也算入函数sub_1E32C的范围内了。</p>
<p>追踪src。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630165349886.png" alt="image-20250630165349886" style="zoom:80%;" />

<p>hook函数sub_1E07C。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630165825546.png" alt="image-20250630165825546"></p>
<p>等函数sub_1E07C执行完，再打印x3、x4的内容。</p>
<p>sub_1E07C执行完后，出现了目标48字节。</p>
<p>大概率是传入的第0、1个参数，它们与这48字节的生成相关。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630172928250.png" alt="image-20250630172928250" style="zoom:80%;" />

<p>看看第0、1个参数，x1的内容有点像加密后的字符串。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630201746906.png" alt="image-20250630201746906" style="zoom:80%;" />

<p>进入函数sub_1E07C，关注函数sub_26024。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630192948412.png" alt="image-20250630192948412" style="zoom:80%;" />

<p>根据hook的结果，sub_26024只执行了1次。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630194424809.png" alt="image-20250630194424809"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630194443002.png" alt="image-20250630194443002" style="zoom:80%;" />

<p>a4指向v18</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630194505551.png" alt="image-20250630194505551" style="zoom:80%;" />

<p>v17指向一块堆内存，v18通过赋值，也指向这块内存。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630194532102.png" alt="image-20250630194532102" style="zoom:80%;" />

<p>其中，v24是从0开始取，每次自增1，换算过来，v25每次移动16字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630195629327.png" alt="image-20250630195629327"></p>
<p>根据分析，锁定了sub_25980。（sub_251F4没执行，它代表着AES解密，相反，sub_25980代表着加密；函数sub_2640C用来设置执行加密还是解密）</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630195951640.png" alt="image-20250630195951640" style="zoom:80%;" />

<p>下面是hook函数sub_25980所得到的参数。</p>
<p>x1指向待加密的数据，这里的数据大小是0x30，本来是0x20，多了0x10的填充。</p>
<p>x2指向加密结束的堆内存，起始地址是0x124d3330。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630202439641.png" alt="image-20250630202439641"></p>
<p>执行完3次sub_25980后，v25指向的区域是这样的，这是我们目标的48个字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630202728004.png" alt="image-20250630202728004"></p>
<p>用了什么加密呢？大概率是白盒AES，因为通过插件FindCrypt，找到了AES。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630224657562.png" alt="image-20250630224657562"></p>
<p>回到函数sub_26024，将输入改成2个一样的内容。——判断CBC还是EBC。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">debugger.addBreakPoint(<span class="keyword">module</span>.base + <span class="number">0x1E224</span>, <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line">        <span class="comment">// 2个16字节</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">hexString</span> <span class="operator">=</span> <span class="string">&quot;xianyuxianyuismexianyuxianyuisme&quot;</span>; <span class="comment">// 十六进制字符串</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = hexString.getBytes();</span><br><span class="line">        <span class="type">MemoryBlock</span> <span class="variable">newInput</span> <span class="operator">=</span> emulator.getMemory().malloc(hexString.length(), <span class="literal">true</span>);</span><br><span class="line">        newInput.getPointer().write(bytes);</span><br><span class="line">        <span class="comment">// 将x1指向我们的待加密字符串</span></span><br><span class="line">        emulator.getBackend().reg_write(Arm64Const.UC_ARM64_REG_X1, newInput.getPointer().peer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>函数执行前，x1已经指向xianyuxianyuisme的内容。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630225923022.png" alt="image-20250630225923022"></p>
<p>执行后，发现结果一模一样，说明采用EBC模式。（无IV）</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630230021753.png" alt="image-20250630230021753" style="zoom:80%;" />

<p>之前hook函数sub_25980时，填充值是0x10，符合PKCS#7的填充方式。</p>
<p>在下面else的代码块内，下了1个断点，发现每当执行1次函数sub_25980，这个代码块会执行36次。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630230744884.png" alt="image-20250630230744884"></p>
<p>为什么是36次呢？标准的AES-128有10轮运算，前9轮完全一样，每1轮需要对每列进行列变换，而共有4列，因此前9轮共有36轮列变化，刚好对应else内的代码块执行了36次。</p>
<p>为了更方便分析函数sub_259B8，用d810去除一下控制流平坦化。</p>
<p>过于清晰了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630233053889.png" alt="image-20250630233053889"></p>
<p>为了得到密钥，需要使用DFA攻击，在第8轮列混淆之后，第9轮列混淆之前，改变1个字节。</p>
<p>状态矩阵在a1。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250630233850293.png" alt="image-20250630233850293"></p>
<p>而sub_24f78是行位移操作，第9次行位移执行时，正是差分攻击的好时机。</p>
<p>编写脚本，进行差分攻击。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701013043532.png" alt="image-20250701013043532" style="zoom:80%;" />

<p>获得第10轮密钥。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701012800757.png" alt="image-20250701012800757"></p>
<p>得到初始密钥。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701012834080.png" alt="image-20250701012834080"></p>
<p>试验一下，操作没问题，和之前的hook的结果一样。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701012902860.png" alt="image-20250701012902860"></p>
<h3 id="HMAC-SHA256"><a href="#HMAC-SHA256" class="headerlink" title="HMAC-SHA256"></a>HMAC-SHA256</h3><p>进入AES加密之前，“xianyu”作为输入，会生成下面这32字节。</p>
<p>现在追踪这32字节哪里来的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701092041613.png" alt="image-20250701092041613" style="zoom:80%;" />

<p>早在函数sub_26024的时候，x1就指向了这32字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701092425536.png" alt="image-20250701092425536"></p>
<p>往回溯源，又可以找到，a2源于函数</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701092643110.png" alt="image-20250701092643110"></p>
<p>hook函数sub_1DEC0，会发现encrypt_data还不是目标32字节。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701094117337.png" alt="image-20250701094117337" style="zoom:80%;" />

<p>而a4里面，存放着的是明文xianyu。</p>
<p>点入函数sub_1DEC0进行分析，在函数217D8找到了SHA256的字眼。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701094449969.png" alt="image-20250701094449969"></p>
<p>交给大模型进行分析，分析这个是一个HMAC-SHA256函数，a5、a6是opad、ipad也确认了这一点，下图异或的密钥反了，但结果一致也说明是opad&#x2F;ipad。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701095442973.png" alt="image-20250701095442973"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701095509469.png" alt="image-20250701095509469"></p>
<p>用到了HMAC-SHA256，密钥如下，但不知道有没有魔改。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701104955510.png" alt="image-20250701104955510"></p>
<p>经过判断是标准的HMAC-SHA256。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701101620373.png" alt="image-20250701101620373"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>做个小总结，输入“xianyu”经过HMAC-SHA256，变成32字节，又经过AES变成48字节（填充也有16字节），最后经过CRC32变成4字节。</p>
<h2 id="4-7字节"><a href="#4-7字节" class="headerlink" title="4-7字节"></a>4-7字节</h2><p>第4-7字节和时间戳有关，而赋值的地方在这里。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701103945379.png" alt="image-20250701103945379"></p>
<p>交叉引用，大概率是在JNI_OnLoad里执行写的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701104322347.png" alt="image-20250701104322347"></p>
<p>在JNI_OnLoad可以看到，随机种子是time(0)，被固定了，所以随机数也被固定了，至此分析结束。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250701104851928.png" alt="image-20250701104851928"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/06/23/%E6%9F%90%E6%97%85%E6%B8%B8app%E5%88%86%E6%9E%90%EF%BC%882%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/23/%E6%9F%90%E6%97%85%E6%B8%B8app%E5%88%86%E6%9E%90%EF%BC%882%EF%BC%89/" class="post-title-link" itemprop="url">某旅游app分析（2）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-06-23 09:26:27 / 修改时间：12:15:02" itemprop="dateCreated datePublished" datetime="2025-06-23T09:26:27+08:00">2025-06-23</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>374</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="某个字段分析"><a href="#某个字段分析" class="headerlink" title="某个字段分析"></a>某个字段分析</h1><p>在前一篇博客中提到，酒店搜索列表请求报文的请求体是protobuf结构。</p>
<p>根据分析，在这个protobuf结构中，有一个编码对应的字段是head，而head也是一个protobuf结构，head里面有一个字段是clientToken，这在protobuf结构中，属于内层嵌套。</p>
<p>本次的分析目标就是clientToken，同样是简略介绍（怕被投诉）。</p>
<p>clientToken来源于服务器，客户端发送clientID，服务端返回clientToken。</p>
<p>追踪到某个so文件里，发现clientToken与md5有关，而且md5是魔改的——具体怎么魔改的就不说了，也不难。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250623120831160.png" alt="image-20250623120831160"></p>
<p>复现了魔改的md5，得到了一模一样的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250623120807868.png" alt="image-20250623120807868"></p>
<p>其实最难的地方（也不难）就在于魔改md5，其它的都是一些验证方面的设置——构造特定的clientID数值，才能拿到clientToken。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/06/20/%E6%9F%90%E6%97%85%E6%B8%B8app%E5%88%86%E6%9E%90%EF%BC%881%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/20/%E6%9F%90%E6%97%85%E6%B8%B8app%E5%88%86%E6%9E%90%EF%BC%881%EF%BC%89/" class="post-title-link" itemprop="url">某旅游app分析（1）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-06-20 15:47:13 / 修改时间：16:31:05" itemprop="dateCreated datePublished" datetime="2025-06-20T15:47:13+08:00">2025-06-20</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>648</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="sotp"><a href="#sotp" class="headerlink" title="sotp"></a>sotp</h1><p>该厂不许发布针对他们app的分析博客，好多博客都被厂商要求下架了，所以这里只是简单提几句。</p>
<p>一，利用查壳工具对apk做检测，并没有找到壳的特征，没加壳，dex文件都清晰可见。</p>
<p>二，root检测似乎不会导致app闪退与正常使用。</p>
<p>三，使用酒店搜索功能时，通过“花瓶”抓不到酒店的包，只能获得酒店的预览图，但具体价格、位置等信息都看不到，根据分析，使用了sotp协议。</p>
<p>接下来的分析关于酒店搜索功能。</p>
<h2 id="接收"><a href="#接收" class="headerlink" title="接收"></a>接收</h2><p>分析了接收报文时的调用栈：</p>
<p>报文的前8个字节代表payload长度。</p>
<p>payload要是为6个字节，则是心跳包；反之是常规业务数据包，业务数据包的前6个字节有特殊用处，前4个字节是DataHandleType，后2个字节是Version，根据这2个值分别选择解密方式和解压缩方式（AES、Xor、Gzip、Zstandard），最好进行反序列化。</p>
<p>对AES进行了分析，并没有魔改，IV和密钥都很好获得。</p>
<h2 id="发送"><a href="#发送" class="headerlink" title="发送"></a>发送</h2><p>再分析了发送报文时的调用栈：</p>
<p>对RequestBody先进行序列化，再进行压缩、加密。</p>
<p>有意思的是，RequestBody的结构是protobuf，费了一些心思，一开始用blackboxprotobuf逐步还原请求体，后来在apk中找到了关于TAG的定义，整理成proto文件，对body部分进行还原。</p>
<p>然后发现被这个字段开盒了hhhh。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250620161417461.png" alt="image-20250620161417461"></p>
<p>下一篇博客应该是对该app的某个加密字段进行分析。</p>
<p>最后，如果这个博客不允许发，可以联系我&#x2F;(ㄒoㄒ)&#x2F;~~（<a href="mailto:&#x32;&#48;&#x35;&#x30;&#51;&#x36;&#53;&#57;&#x39;&#55;&#x40;&#x71;&#x71;&#46;&#x63;&#111;&#x6d;">2050365997@qq.com</a>）</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/06/12/%E6%9F%90%E6%A2%86%E4%BC%81%E4%B8%9A%E5%A3%B3-%E8%BF%87frida%E6%A3%80%E6%B5%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/12/%E6%9F%90%E6%A2%86%E4%BC%81%E4%B8%9A%E5%A3%B3-%E8%BF%87frida%E6%A3%80%E6%B5%8B/" class="post-title-link" itemprop="url">某梆企业壳--过frida检测</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-06-12 12:47:22 / 修改时间：12:51:42" itemprop="dateCreated datePublished" datetime="2025-06-12T12:47:22+08:00">2025-06-12</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="某汽车app"><a href="#某汽车app" class="headerlink" title="某汽车app"></a>某汽车app</h1><h2 id="查壳"><a href="#查壳" class="headerlink" title="查壳"></a>查壳</h2><p>github:<a target="_blank" rel="noopener" href="https://github.com/moyuwa/ApkCheckPack">https://github.com/moyuwa/ApkCheckPack</a></p>
<p>使用查壳工具简单看一看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250611184449878.png" alt="image-20250611184449878"></p>
<h2 id="root检测"><a href="#root检测" class="headerlink" title="root检测"></a>root检测</h2><p>打开app直接闪退。</p>
<p>使用magisk，把app加入排除列表中。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250611183441372.png" alt="image-20250611183441372" style="zoom:80%;" />

<p>能正常打开了，说明对root的检测比较常规。</p>
<h2 id="frida检测"><a href="#frida检测" class="headerlink" title="frida检测"></a>frida检测</h2><p>使用frida进行注入，等了一会后，进程退出。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250611184240288.png" alt="image-20250611184240288"></p>
<p>试试使用老方法——hook pthread_create。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250611185818226.png" alt="image-20250611185818226" style="zoom:67%;" />

<p>so文件是加密的，可以从内存中dump下来，然后修复了再看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250611191050875.png" alt="image-20250611191050875"></p>
<p>但这里先不dump，先试试在libDexHelper加载的第一时刻，直接将sub_4f884替换掉。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250611194040752.png" alt="image-20250611194040752"></p>
<p>为什么会报红呢，因为在加载libDexHelper.so的时候，函数sub_4f884尚未解密，所以frida没hook上。</p>
<p>因此，需要在解密函数执行完后，再对函数sub_4f884进行hook。</p>
<p>在把libDexHelper.so dump下来以后，用sofix进行修复。</p>
<p>一般都是在init_array和JNI_OnLoad中进行解密。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250611214225402.png" alt="image-20250611214225402"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250611214444985.png" alt="image-20250611214444985"></p>
<p><strong>假设libDexHelper.so通过pthread_create创建了一个线程</strong>，这个线程要执行start_routine——sub_4f884，那么，我可以选择这样一个hook时机。</p>
<p>检查函数pthread_create的第3个参数start_routine是否指向libDexHelper.so的sub_4f884，如果指向，则在onEnter回调中，替换sub_4f884。——执行前，应该已经完成了解密。</p>
<p>然而，在将start_routine指向的函数替换后，进程还是会退出，说明除了sub_4f884，仍有检测frida的地方</p>
<p>如果想要一个进程反复检测frida的存在，那就需要创建子线程或子进程，一般来说都是创建子线程。</p>
<p>而创建线程的方法有系统调用（svc）、pthread_create（库调用）、clone（库调用）。</p>
<p><strong>之所以要写这篇博客，其实就是想讲讲clone、pthread_create、fork的区别。</strong></p>
<p>fork和pthread_create都是依靠clone创建的，根据传递不同的参数给clone，以区别创建的是进程还是线程。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250611215932607.png" alt="image-20250611215932607"></p>
<p>我hook库函数pthread_create，发现libDexHelper仅仅只创建了1个线程（sub_4f884）。</p>
<p>pthread_create在libc是这样子的，也就是说，clone的第4个参数v30，再加上96的偏移就是pthread_create的a3（start_routine）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">pthread_create</span><span class="params">(_QWORD *a1, __int64 a2, __int64 a3, __int64 a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    *(_QWORD *)(v30 + <span class="number">96</span>) = a3;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    v32 = <span class="built_in">clone</span>(__pthread_start, v18, <span class="number">4001536LL</span>, v30, v30 + <span class="number">16</span>, v22 + <span class="number">8</span>, v30 + <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后只要将下面的函数给hook掉，frida就能正常用了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250612121116232.png" alt="image-20250612121116232"></p>
<p>不过我挺好奇是如何调用的clone？——got劫持，还是说其他的方法。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/06/10/xhs%E5%88%86%E6%9E%90%E2%80%94%E2%80%94shield%E5%AD%97%E6%AE%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/10/xhs%E5%88%86%E6%9E%90%E2%80%94%E2%80%94shield%E5%AD%97%E6%AE%B5/" class="post-title-link" itemprop="url">xhs分析——shield字段</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-06-10 22:29:33 / 修改时间：22:46:06" itemprop="dateCreated datePublished" datetime="2025-06-10T22:29:33+08:00">2025-06-10</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>71k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2:09</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-分析目标"><a href="#1-分析目标" class="headerlink" title="1.分析目标"></a>1.分析目标</h1><p>要分析的字段：shield。</p>
<h1 id="2-抓包"><a href="#2-抓包" class="headerlink" title="2.抓包"></a>2.抓包</h1><p>这个字段在很多请求中有出现，比如登录验证码。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530103310169.png" alt="image-20250530103310169" style="zoom:80%;" />

<p>（ps：其实一般先抓包，然后确定分析目标，只不过在网上能找到分析shield的博客，不用孤军奋战！第一次分析大厂app，找个有资料分析的，hhhh，当然~虽然有其它人的博客，但我还是先自己分析，有不会的再看博客~）</p>
<h1 id="3-基本分析"><a href="#3-基本分析" class="headerlink" title="3.基本分析"></a>3.基本分析</h1><p>通过frida-ps获得包名。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530093701399.png" alt="image-20250530093701399" style="zoom:80%;" />

<p>从Manifest文件中获取App类名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530093929614.png" alt="image-20250530093929614"></p>
<p>看了一下，似乎没有加壳，因为什么内容都看得见，比如IndexActivityV2。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530103415270.png" alt="image-20250530103415270"></p>
<p>先直接在jadx中搜索，观察能否找到协议字段shield。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530103929768.png" alt="image-20250530103929768"></p>
<p>并没有找到，但感觉有一些类名、字段名比较可疑。——先暂时放着，如果其它方法用不了再来查看这些类与字段。</p>
<p>再尝试使用frida去hook hashMap，一般开发的时候，会用hashMap存储通信协议字段。</p>
<p>打印的调用链有点长。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">[shield] shield</span><br><span class="line">[value] XYAAQAAgAAAAEAAABTAAAAUzUWEe0xG1IbD9/c+qCLOlKGmTtFa+lG434Je+FUTaRHxIzkyONuSp3/qeYJz8Mt3Jx+2fc6EAwYGGHebLP31H5m0rFOBPBvvrx/G4l575l4LPk3</span><br><span class="line">java.lang.Throwable</span><br><span class="line">        at java.util.HashMap.put(Native Method)</span><br><span class="line">        at qd9.h1.intercept(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.a.intercept(SourceFile:5)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.m.intercept(SourceFile:6)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.d.intercept(SourceFile:7)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.h.intercept(SourceFile:4)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at sf3.b.b(SourceFile:1)</span><br><span class="line">        at sf3.b.intercept(SourceFile:25)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.r.b(SourceFile:1)</span><br><span class="line">        at wd8.r.intercept(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at com.xingin.shield.http.XhsHttpInterceptor.intercept(Native Method)</span><br><span class="line">        at com.xingin.shield.http.XhsHttpInterceptor.intercept(SourceFile:8)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at ae8.b.c(SourceFile:2)</span><br><span class="line">        at ae8.a.intercept(SourceFile:3)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.l.intercept(SourceFile:13)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.s.intercept(SourceFile:13)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.u.intercept(SourceFile:6)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at rd9.c.intercept(SourceFile:15)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at ne7.c.intercept(SourceFile:11)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.c.intercept(SourceFile:2)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at qe7.b.intercept(SourceFile:3)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at ve9.d.intercept(SourceFile:8)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at yy8.m.intercept(SourceFile:26)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at on1.b.intercept(SourceFile:2)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at on1.a.intercept(SourceFile:2)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at jf9.c.intercept(SourceFile:1)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at qd9.k.intercept(SourceFile:3)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at yd8.a.intercept(SourceFile:1)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at qd9.p1.intercept(SourceFile:1)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at nj8.j.intercept(SourceFile:5)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at nj8.g.intercept(SourceFile:5)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at hw5.b.intercept(SourceFile:2)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at rd9.e.intercept(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at rd9.b.intercept(SourceFile:12)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at rd9.d.intercept(SourceFile:26)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at yy8.b.intercept(SourceFile:2)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.o.intercept(SourceFile:33)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at ve9.e$a.intercept(SourceFile:4)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at jf9.l.intercept(SourceFile:8)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.w.intercept(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at okhttp3.RealCall.getResponseWithInterceptorChain(SourceFile:13)</span><br><span class="line">        at okhttp3.RealCall.execute(SourceFile:8)</span><br><span class="line">        at retrofit2.OkHttpCall.execute(SourceFile:8)</span><br><span class="line">        at wc8.b.e(SourceFile:14)</span><br><span class="line">        at io.reactivex.Observable.subscribe(SourceFile:14)</span><br><span class="line">        at wc8.a.e(Unknown Source:23)</span><br><span class="line">        at io.reactivex.Observable.subscribe(SourceFile:14)</span><br><span class="line">        at ms9.n0.e(Unknown Source:17)</span><br><span class="line">        at io.reactivex.Observable.subscribe(SourceFile:14)</span><br><span class="line">        at ms9.l3$b.run(Unknown Source:6)</span><br><span class="line">        at kd8.a.run(SourceFile:3)</span><br><span class="line">        at ud7.a.run(SourceFile:2)</span><br><span class="line">        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:462)</span><br><span class="line">        at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">        at uh8.h.F(Unknown Source:12)</span><br><span class="line">        at uh8.h.run(SourceFile:9)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1167)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:641)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:920)</span><br></pre></td></tr></table></figure>

<p>除此之外，进程还在执行一段时间后终止了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530105524482.png" alt="image-20250530105524482"></p>
<p>我决定先解决反调。</p>
<h1 id="4-反调"><a href="#4-反调" class="headerlink" title="4.反调"></a>4.反调</h1><p>先用常规办法，看是否能解决。</p>
<p>先hook库的加载，观察哪个库加载后会导致进程退出。</p>
<p>下面这个结果是通过hook System.loadLibrary的结果。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530110426774.png" alt="image-20250530110426774" style="zoom:80%;" />

<p>感觉不太对，就打印了一条hook记录。</p>
<p>换一个方式hook，这回hook dlopen和android_dlopen_ext。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530121032468.png" alt="image-20250530121032468"></p>
<p>在加载了libredpreload.so、libmsaoaidsec.so后，退出了。还记得bilibili和豆瓣用的也是libmsaoaidsec.so做反调。</p>
<p>当时的解决方式是：hook掉检测线程或者删掉这个库（如果小红薯没额外对这个库做检查的话），考虑到重新签名太麻烦了，还是hook线程吧。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530123104099.png" alt="image-20250530123104099" style="zoom: 80%;" />

<p>将这3个线程的目标函数替换掉，等待了一段时间，发现进程不崩溃了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530123804548.png" alt="image-20250530123804548" style="zoom:80%;" />

<p>然后整理一个绕过检测的hook脚本模板，方便之后写其它脚本，这里就不展示了。</p>
<h1 id="5-追踪字段shield"><a href="#5-追踪字段shield" class="headerlink" title="5.追踪字段shield"></a>5.追踪字段shield</h1><p>过完反调，回来继续分析shield字段。</p>
<p>避开sdk的函数，先追踪qd9.h1.intercept。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530124447630.png" alt="image-20250530124447630"></p>
<p>在函数intercept中，找到2个调用put的位置。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530130314460.png" alt="image-20250530130314460" style="zoom:80%;" />

<p>这里的intercept代码可以分成2块，上面一块在拦截和修改<strong>请求</strong>（Request），下面一块在拦截和处理<strong>响应</strong>（Response）。</p>
<p>hook一下函数intercept，观察原本的请求体和修改后的请求体。</p>
<p>我的脚本只获得了输入参数，输出结果却打印不出来——说明hook引发了某些问题，导致调用原本的intercept的时候，陷入了死循环，导致方法stack溢出。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530134630822.png" alt="image-20250530134630822"></p>
<p>又或者是下面这样的报错。（搜了一下，大致原因是：有不可序列化的内容在输出结果里）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530135606186.png" alt="image-20250530135606186"></p>
<p>但不管怎么说，通过输入参数，我们发现shield已经在传入时就加密好了，说明qd9.h1.intercept并不是我们要找的加密点。</p>
<p>观察了一下前面的调用栈，发现存在shield的字段，追踪过去看看。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">at com.xingin.shield.http.XhsHttpInterceptor.intercept(Native Method)</span><br><span class="line">at com.xingin.shield.http.XhsHttpInterceptor.intercept(SourceFile:8)</span><br></pre></td></tr></table></figure>

<p>hook后发现输入参数没有shield。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530141942891.png" alt="image-20250530141942891"></p>
<p>而hook wd8.r.intercept，发现输入参数存在shield参数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530142603508.png" alt="image-20250530142603508"></p>
<p>说明，大概率是在com.xingin.shield.http.XshHttpInterceptor.intercept添加了字段shield。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530142527896.png" alt="image-20250530142527896" style="zoom:80%;" />

<p>至此，锁定了加密点。</p>
<h1 id="6-加密分析"><a href="#6-加密分析" class="headerlink" title="6.加密分析"></a>6.加密分析</h1><p>猜测应该是根据this.cPtr生成shield，然后往chain上添加。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530143432846.png" alt="image-20250530143432846"></p>
<p>而this.cPtr的来头有点复杂，咱们不管，直接hook JNI函数intercept，查看j10的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530144122340.png" alt="image-20250530144122340"></p>
<p>多次打印，发现j10不会轻易发生改变，j10&#x3D;494045072144。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530145440602.png" alt="image-20250530145440602"></p>
<p>hook RegisterNatives，观察动态注册的函数地址，找到intercept在libxyass.so的偏移是0x9e184。</p>
<p>PS：一开始脚本写错逻辑了，我还以为是静态注册的,,ԾㅂԾ,,然后写了一个遍历文件夹下所有so的脚本，获得导出表，然后筛选我们的intercept——就当作在这里提供一个找静态注册JNI函数的思路吧。</p>
<p>PPS：要找动态注册的函数，还有一个思路，根据JNI在Java的方法名，拿到ArtMethod，然后根据ArtMethod获得JNI函数在Native层的地址，然后判断这个地址在哪个模块，而偏移量则是Native层的地址 - 模块基址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530152836580.png" alt="image-20250530152836580"></p>
<p>用IDA打开后，修改一下参数名与类型。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530154553559.png" alt="image-20250530154553559"></p>
<p>不知道到底在调用哪个函数，大概率是关于JNIEnv的函数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530155837197.png" alt="image-20250530155837197"></p>
<p>根据计算，off_AD430 + 0x753016A0 &#x3D;&#x3D; 0x6E13C，看样子是封装了CallObjectMethodV。</p>
<p>问题来了，参数传递的时候，chain为什么会是a2？a2应该是jobject类型。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530160824936.png" alt="image-20250530160824936" style="zoom: 67%;" />

<p>而且，qword_B1740等全局变量尚未被初始化，因此，我决定dump一个so文件下来看看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530165045013.png" alt="image-20250530165045013"></p>
<p>然后使用工具修复dump下来的elf文件。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530165303554.png" alt="image-20250530165303554"></p>
<p>打开IDA，来到0x9e184，可以发现qword_B1740等全局变量已经回填了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530183503982.png" alt="image-20250530183503982"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530183841508.png" alt="image-20250530183841508" style="zoom:80%;" />

<p>然而，这些jmethodID咱肯定是看不懂的。——这里有3个思路。</p>
<ol>
<li><p>将jmethodID转换成对应的函数名。（难点：先获取jmethodID，再考虑如何转换）</p>
</li>
<li><p>hook JNI函数，打印JNI函数调用序列。（难点：如何筛选sub_9E184中执行的JNI函数）</p>
</li>
<li><p>Unidbg的模拟执行可以打印调用的JNI函数序列。（难点：补环境）</p>
</li>
</ol>
<p>网上的博客都是基于Unidbg进行分析，既然别人用Unidbg，那这里我就用frida吧。——自己分析才更具挑战性嘛。</p>
<h2 id="获取JNI调用链"><a href="#获取JNI调用链" class="headerlink" title="获取JNI调用链"></a>获取JNI调用链</h2><h3 id="Ⅰ-通过jmethodID获得函数名"><a href="#Ⅰ-通过jmethodID获得函数名" class="headerlink" title="Ⅰ.通过jmethodID获得函数名"></a>Ⅰ.通过jmethodID获得函数名</h3><p>jmethodID在内存中实际上是指向ArtMethod结构的指针，也就是说，通过jmethodID可以获得ArtMethod在内存的位置。在libart中有一个函数叫PrettyMethod，往这个函数输入ArtMethod对象，可以打印出对应的函数名，而frida中就内置了这个函数的api。</p>
<p>至此，还有一个问题需要解决——PrettyMethod返回函数名存储在c++的std::string对象中，要对这个string进行合理的解析，才能获得最终的函数名。</p>
<p>安卓的arm64下，std::string类型一般占24字节，也就是3* pointerSize。</p>
<p>需要存储小的字符串时，一般会将字符串直接存在std::string的内存空间中，最多可以存24字节；而需要存储大的字符串时，会另外开辟一处堆空间，用来专门存放字符串的内容，而std::string的原24字节，会用来存储这样的结构：</p>
<ul>
<li><p>一个指向堆上字符数据的指针 (<code>char* data</code>)。</p>
</li>
<li><p>字符串的当前长度 (<code>size_t length</code>)。</p>
</li>
<li><p>当前分配的内存容量 (<code>size_t capacity</code>)。</p>
</li>
</ul>
<p>总结一下，我们输入一个jmethodID后，把它作为参数传给PrettyMethod后，需要对返回的string进行解析，获得函数名字符串地址，然后打印。</p>
<p>PS：至于如何区分小字符串存储还是大字符串存储，这里就不说咯。</p>
<p>下图是一个实现效果。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250531143219800.png" alt="image-20250531143219800" style="zoom:80%;" />

<p>在IDA中添加注释。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250531143445034.png" alt="image-20250531143445034"></p>
<h3 id="Ⅱ-hook-JNI调用"><a href="#Ⅱ-hook-JNI调用" class="headerlink" title="Ⅱ.hook JNI调用"></a>Ⅱ.hook JNI调用</h3><p>github上有大佬写过hook jni调用的frida脚本了，其原理是：hook上libart库中的函数——ArtMethod::Invoke。</p>
<p>ArtMethod::Invoke是ART中负责调用方法的核心函数，无论是Java方法还是JNI方法，最终都会通过Invoke执行。通过对这个函数的hook，可以获得整个进程的方法调用日志。</p>
<p>然而日志太杂乱了，需要筛选，我们只针对libxyass.so中的方法调用，通过反射，可以获取某个类的某个方法的jmethodID，然后反射执行；因此，我们只需要打印调用栈，只要在调用栈中，某个调用的地址在libxyass.so的映射范围内，就将这条日志记录下来。</p>
<p>大佬写的源代码没有过滤的代码，无过滤的、大量的console.log会导致进程卡死，无法获得我们想要的内容，于是我做了一些改动。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250531152135241.png" alt="image-20250531152135241"></p>
<p>其中地址0x6e1b4在CallObjectMethodV_函数的映射范围内。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250531152215305.png" alt="image-20250531152215305"></p>
<p>和我们第1个方法的日志结果一模一样。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250531152310852.png" alt="image-20250531152310852"></p>
<h2 id="分析shield加密点"><a href="#分析shield加密点" class="headerlink" title="分析shield加密点"></a>分析shield加密点</h2><p>为了获得加密函数的trace，这里有3种思路：</p>
<ol>
<li>使用IDA的trace功能；</li>
<li>使用frida-stalker的实现trace；</li>
<li>使用unidbg实现trace。</li>
</ol>
<p>我已经尝试过了第1、2种方式，耗时一天，无论怎么修改脚本，脚本始终跑得不稳定，最多一次trace了20w条指令，进程就崩溃了。</p>
<p>在这20w条指令中，没有看到shield字段的影子，那只能使用unidbg了，麻了。</p>
<h3 id="Unidbg补环境"><a href="#Unidbg补环境" class="headerlink" title="Unidbg补环境"></a>Unidbg补环境</h3><p>先照着其它项目的模板，搭建基础环境。</p>
<h4 id="1-获得ShieldLogger对象"><a href="#1-获得ShieldLogger对象" class="headerlink" title="1.获得ShieldLogger对象"></a>1.获得ShieldLogger对象</h4><p>跑起来后，遇到的第一个问题。</p>
<p>Unidbg的JNI实现调用AbstractJni子类中的getStaticObjectField来解析此字段，但Unidbg的原生实现并不能正确解析，需要子类进行覆写，也就是在我们创建的类中进行覆写。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602092607201.png" alt="image-20250602092607201"></p>
<p>找到getStaticOjectField的实现，然后模仿它的写法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; getStaticObjectField(BaseVM vm, DvmClass dvmClass, String signature) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;com/xingin/shield/http/ContextHolder-&gt;sLogger:Lcom/xingin/shield/http/ShieldLogger;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;com/xingin/shield/http/ShieldLogger&quot;</span>).newObject(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.getStaticObjectField(vm, dvmClass, signature);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后JNI_OnLoad顺利执行完了。</p>
<p>还记得这张图，在调用intercepte之前，需要先后执行initializeNative和initialize。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530144122340.png" alt="image-20250530144122340"></p>
<p>通过上述这2个函数，对so中的静态变量和传入的cPtr进行初始化。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530143432846.png" alt="image-20250530143432846"></p>
<p>因此，先要调用initializeNative和initialize。通过hook，发现initialize的参数始终是main。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602095412021.png" alt="image-20250602095412021" style="zoom:80%;" />

<p>先创建3个变量。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602095651106.png" alt="image-20250602095651106" style="zoom:80%;" />

<p>然后在构造函数中进行初始化。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602095718995.png" alt="image-20250602095718995" style="zoom:80%;" />

<p>然后创建函数initializeNative和initialize。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602094439606.png" alt="image-20250602094439606"></p>
<p>调用这2个函数，接着进行补环境。</p>
<h4 id="2-模拟nativeInitializeStart执行"><a href="#2-模拟nativeInitializeStart执行" class="headerlink" title="2.模拟nativeInitializeStart执行"></a>2.模拟nativeInitializeStart执行</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602100137366.png" alt="image-20250602100137366"></p>
<p>Unidbg 尝试调用 ShieldLogger 类中定义的原生方法 nativeInitializeStart （一个无参数的 void 方法），但该方法未在您的 AbstractJni 子类中实现或正确处理。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602101257293.png" alt="image-20250602101257293"></p>
<p>不做处理，直接返回。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602101313387.png" alt="image-20250602101313387"></p>
<h4 id="3-模拟defaultCharset执行"><a href="#3-模拟defaultCharset执行" class="headerlink" title="3.模拟defaultCharset执行"></a>3.模拟defaultCharset执行</h4><p>AbstractJni的函数callStaticObjectMethodV未能对java.nio.charset.Charset类上的静态方法defaultCharset()正确解析，因此需要补环境，模拟defaultCharset。</p>
<p>在这里，我们直接调用Charset的defaultCharset，然后转换成DvmObject的类型传回去。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602105910172.png" alt="image-20250602105910172"></p>
<h4 id="4-获得sDeviceID"><a href="#4-获得sDeviceID" class="headerlink" title="4.获得sDeviceID"></a>4.获得sDeviceID</h4><p>我们需要获得设备id，然后转换成DvmObject类型传过去。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602110612112.png" alt="image-20250602110612112"></p>
<p>通过全局搜索，查找类com.xingin.shield.http.ContextHolder。</p>
<p>由于sDeviceId是一个静态变量，可以直接通过类名获取。——518dfe96-7f6f-370a-8e80-f94f8838e6de</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602111607731.png" alt="image-20250602111607731"></p>
<p>然后覆盖AbstractJni的getStaticObjectField。</p>
<p>对于常用的java内置的数据结构，unidbg封装了特别的函数，比如StringObject，就不需要dvmClass.newObject来转换。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602111830894.png" alt="image-20250602111830894"></p>
<h4 id="5-获得sAppId"><a href="#5-获得sAppId" class="headerlink" title="5.获得sAppId"></a>5.获得sAppId</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602112110292.png" alt="image-20250602112110292"></p>
<p>与第4个补环境的流程一样。——sAppId &#x3D; -319115519</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602112306831.png" alt="image-20250602112306831"></p>
<p>覆写。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602112515324.png" alt="image-20250602112515324" style="zoom:80%;" />

<h4 id="6-模拟nativeInitializeEnd执行"><a href="#6-模拟nativeInitializeEnd执行" class="headerlink" title="6.模拟nativeInitializeEnd执行"></a>6.模拟nativeInitializeEnd执行</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602113059847.png" alt="image-20250602113059847"></p>
<p>同样不做处理，直接返回。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602113325760.png" alt="image-20250602113325760" style="zoom:80%;" />

<h4 id="7-模拟initializeStart-执行"><a href="#7-模拟initializeStart-执行" class="headerlink" title="7.模拟initializeStart()执行"></a>7.模拟initializeStart()执行</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602113535063.png" alt="image-20250602113535063"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602113701419.png" alt="image-20250602113701419"></p>
<h4 id="8-获得SharedPreferences对象"><a href="#8-获得SharedPreferences对象" class="headerlink" title="8.获得SharedPreferences对象"></a>8.获得SharedPreferences对象</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602135837739.png" alt="image-20250602135837739"></p>
<p>根据报错提示，我们要返回构造好一个SharedPreferences对象。</p>
<p><code>SharedPreferences</code> 是 Android 提供的一种轻量级的数据存储机制。它允许应用程序以<strong>键值对 (key-value pairs)</strong> 的形式持久化存储一些简单的数据类型（如布尔值、浮点数、整数、长整数和字符串）。每个 Android 应用都可以有自己的 <code>SharedPreferences</code> 文件。这些文件存储在应用的私有目录（shared_prefs目录）下，默认情况下其他应用无法访问。它是一个<strong>接口 (Interface)</strong>。这意味着它定义了一套操作规范（比如如何读取数据 <code>getString()</code>, <code>getInt()</code>，如何写入数据 <code>edit().putString().commit()</code> 等），但具体的实现则由 Android 系统提供。</p>
<p><code>Context.getSharedPreferences(name, mode)</code> 是获取或创建特定名称的 <code>SharedPreferences</code> 实例的<strong>标准途径</strong>。你调用这个方法，传入你想要操作的配置文件的名字，然后系统会返回一个实现了 <code>SharedPreferences</code> 接口的对象，你可以通过这个对象来读写数据。</p>
<p>补环境的代码如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602141349585.png" alt="image-20250602141349585"></p>
<p>注意，这里的newObject(getSharedPreferences_arg0)并不是调用构造函数，含义如下图所示。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602141224286.png" alt="image-20250602141224286" style="zoom: 50%;" />

<h4 id="9-实现函数SharedPreferences-getString"><a href="#9-实现函数SharedPreferences-getString" class="headerlink" title="9.实现函数SharedPreferences-&gt;getString()"></a>9.实现函数SharedPreferences-&gt;getString()</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602141607771.png" alt="image-20250602141607771"></p>
<p>上一步中，获得了SharedPreferences对象，这里需要通过getString获得value。</p>
<p>通过unidbg，可以打印arg0的值，是“s”。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602142002516.png" alt="image-20250602142002516"></p>
<p>因此，我们去看看xhs私有目录下有没有名为s的文件。——这些文件在原apk中没有，属于服务器下发给客户端的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602142530501.png" alt="image-20250602142530501"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602142720277.png" alt="image-20250602142720277"></p>
<p>android&#x2F;content&#x2F;SharedPreferences-&gt;getString(Ljava&#x2F;lang&#x2F;String;Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;String;的逻辑是这样的：输入2个字符串arg0、v2，输出1个字符串v1；这个函数会获取键arg0对应的值，如果没有，默认返回v2，如果找到了建arg0的值，返回v1。</p>
<p>先通过unidbg获取访问了哪些键。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602144138579.png" alt="image-20250602144138579"></p>
<p>已知main是不存在，s.xml里就放了一个main_hmac，所以可以这么写。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602144524947.png" alt="image-20250602144524947"></p>
<p>为了方便观察，我把返回的结果也打印了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602144729643.png" alt="image-20250602144729643"></p>
<h4 id="10-模拟Base64Helper-decode-执行"><a href="#10-模拟Base64Helper-decode-执行" class="headerlink" title="10.模拟Base64Helper-&gt;decode()执行"></a>10.模拟Base64Helper-&gt;decode()执行</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602144914722.png" alt="image-20250602144914722"></p>
<p>需要返回解码后的字节数组。</p>
<p>可以调用Base64类进行解码，然后通过unidbg对Byte数组的封装函数，返回回去。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602145728193.png" alt="image-20250602145728193"></p>
<h4 id="11-模拟initializedEnd-执行"><a href="#11-模拟initializedEnd-执行" class="headerlink" title="11.模拟initializedEnd()执行"></a>11.模拟initializedEnd()执行</h4><p>一样对initializedEnd()不做处理。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602164905684.png" alt="image-20250602164905684"></p>
<h4 id="12-至此，完成了对initializeNative-和initialize-的调用，接下来对intercepte进行主动调用"><a href="#12-至此，完成了对initializeNative-和initialize-的调用，接下来对intercepte进行主动调用" class="headerlink" title="12.至此，完成了对initializeNative()和initialize()的调用，接下来对intercepte进行主动调用"></a>12.至此，完成了对initializeNative()和initialize()的调用，接下来对intercepte进行主动调用</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602165136924.png" alt="image-20250602165136924"></p>
<h4 id="13-构造一个空的chain对象"><a href="#13-构造一个空的chain对象" class="headerlink" title="13.构造一个空的chain对象"></a>13.构造一个空的chain对象</h4><p>添加chain。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602175649847.png" alt="image-20250602175649847" style="zoom:80%;" />

<p>调用get_shield()。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602175726431.png" alt="image-20250602175726431"></p>
<h4 id="14-模拟com-xingin-shield-http-ShieldLogger-buildSourceStart-执行"><a href="#14-模拟com-xingin-shield-http-ShieldLogger-buildSourceStart-执行" class="headerlink" title="14.模拟com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;buildSourceStart()执行"></a>14.模拟com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;buildSourceStart()执行</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602175843374.png" alt="image-20250602175843374"></p>
<p>补环境。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602175950460.png" alt="image-20250602175950460" style="zoom:80%;" />

<h4 id="15-下载okhttp3框架，模拟okhttp3-Interceptor-Chain-request-执行"><a href="#15-下载okhttp3框架，模拟okhttp3-Interceptor-Chain-request-执行" class="headerlink" title="15.下载okhttp3框架，模拟okhttp3&#x2F;Interceptor$Chain-&gt;request()执行"></a>15.下载okhttp3框架，模拟okhttp3&#x2F;Interceptor$Chain-&gt;request()执行</h4><p>遇到报错。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602180840982.png" alt="image-20250602180840982"></p>
<p>在pom.xml中，添加okhttp3的包，注意缩进。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>保存，并构造request对象。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602180806704.png" alt="image-20250602180806704"></p>
<p>补环境。这里的request是一种标记,可以通过DvmObject.getValue()取出来request的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602181715577.png" alt="image-20250602181715577"></p>
<h4 id="16-模拟okhttp3-Interceptor-Chain-request-执行"><a href="#16-模拟okhttp3-Interceptor-Chain-request-执行" class="headerlink" title="16.模拟okhttp3&#x2F;Interceptor$Chain-&gt;request()执行"></a>16.模拟okhttp3&#x2F;Interceptor$Chain-&gt;request()执行</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602181311120.png" alt="image-20250602181311120"></p>
<p>这里的request.url也是一种标记，可以通过DvmObject.getValue()取出来request.url()的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602181727986.png" alt="image-20250602181727986"></p>
<h4 id="17-模拟执行okhttp3-HttpUrl-encodedPath"><a href="#17-模拟执行okhttp3-HttpUrl-encodedPath" class="headerlink" title="17.模拟执行okhttp3&#x2F;HttpUrl-&gt;encodedPath()"></a>17.模拟执行okhttp3&#x2F;HttpUrl-&gt;encodedPath()</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602182110508.png" alt="image-20250602182110508"></p>
<p>需要通过getValue取出具体的值，然后调用okhttp3.HttpUrl的encodedQuery()，将返回值转换为DvmObject类型返回去，由于这里是返回字符串，有专门的封装函数StringObject。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602182317628.png" alt="image-20250602182317628" style="zoom:80%;" />

<h4 id="18-模拟执行okhttp3-HttpUrl-encodedPath"><a href="#18-模拟执行okhttp3-HttpUrl-encodedPath" class="headerlink" title="18.模拟执行okhttp3&#x2F;HttpUrl-&gt;encodedPath()"></a>18.模拟执行okhttp3&#x2F;HttpUrl-&gt;encodedPath()</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602182607946.png" alt="image-20250602182607946"></p>
<p>一样的原理。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602182602826.png" alt="image-20250602182602826"></p>
<h4 id="19-空字符串异常"><a href="#19-空字符串异常" class="headerlink" title="19.空字符串异常"></a>19.空字符串异常</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602182843174.png" alt="image-20250602182843174"></p>
<p>根据提示，这里的httpUrlObj_encodedQuery.encodedQuery()返回的是空字符串，即null。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602182910797.png" alt="image-20250602182910797"></p>
<p>方法encodedQuery是用来返回url请求?后面参数用的，而我们的url没有添加?。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602183041973.png" alt="image-20250602183041973"></p>
<h4 id="20-模拟执行okhttp3-Request-body"><a href="#20-模拟执行okhttp3-Request-body" class="headerlink" title="20.模拟执行okhttp3&#x2F;Request-&gt;body()"></a>20.模拟执行okhttp3&#x2F;Request-&gt;body()</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602183118874.png" alt="image-20250602183118874"></p>
<p>复杂对象都用newObject打上标记即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;okhttp3/Request-&gt;body()Lokhttp3/RequestBody;&quot;</span>:</span><br><span class="line">	<span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/RequestBody&quot;</span>).newObject(request.body());</span><br></pre></td></tr></table></figure>

<h4 id="21-模拟执行okhttp3-Request-headers"><a href="#21-模拟执行okhttp3-Request-headers" class="headerlink" title="21.模拟执行okhttp3&#x2F;Request-&gt;headers()"></a>21.模拟执行okhttp3&#x2F;Request-&gt;headers()</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602183451505.png" alt="image-20250602183451505"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;okhttp3/Request-&gt;headers()Lokhttp3/Headers;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/Headers&quot;</span>).newObject(request.headers());</span><br></pre></td></tr></table></figure>

<h4 id="22-模拟构造函数okio-Buffer"><a href="#22-模拟构造函数okio-Buffer" class="headerlink" title="22.模拟构造函数okio&#x2F;Buffer-&gt;&lt;init&gt;()"></a>22.模拟构造函数okio&#x2F;Buffer-&gt;&lt;init&gt;()</h4><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602191745460.png" alt="image-20250602191745460" style="zoom: 67%;" />

<p>在AbstractJni.newObjectV中，实现了很多构造函数。</p>
<p>现在需要往里面添加okio.Buffer类的构造函数。</p>
<p>观察原有的构造函数实现，其实是往newObject里面存放构造函数后的初始值。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602192421858.png" alt="image-20250602192421858" style="zoom:80%;" />

<p>而okio&#x2F;Buffer-&gt;&lt;init&gt;()是无参构造函数，所以代码应该这么写。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602192939068.png" alt="image-20250602192939068" style="zoom:80%;" />

<h4 id="23-模拟okio-Buffer-writeString-Ljava-lang-String-Ljava-nio-charset-Charset-Lokio-Buffer"><a href="#23-模拟okio-Buffer-writeString-Ljava-lang-String-Ljava-nio-charset-Charset-Lokio-Buffer" class="headerlink" title="23.模拟okio&#x2F;Buffer-&gt;writeString(Ljava&#x2F;lang&#x2F;String;Ljava&#x2F;nio&#x2F;charset&#x2F;Charset;)Lokio&#x2F;Buffer;"></a>23.模拟okio&#x2F;Buffer-&gt;writeString(Ljava&#x2F;lang&#x2F;String;Ljava&#x2F;nio&#x2F;charset&#x2F;Charset;)Lokio&#x2F;Buffer;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602193106537.png" alt="image-20250602193106537"></p>
<p>函数writeString的返回值是Lokio&#x2F;Buffer，也就是说，我们可以取出Buffer实例，取出2个参数，然后调用writeString，最后将结果转换成DvmObject类型。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602193747833.png" alt="image-20250602193747833" style="zoom:80%;" />

<h4 id="24-模拟okhttp3-Headers-size-I"><a href="#24-模拟okhttp3-Headers-size-I" class="headerlink" title="24.模拟okhttp3&#x2F;Headers-&gt;size()I"></a>24.模拟okhttp3&#x2F;Headers-&gt;size()I</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602193837056.png" alt="image-20250602193837056"></p>
<p>补环境。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602194159163.png" alt="image-20250602194159163"></p>
<h4 id="25-模拟执行okhttp3-Headers-name-I-Ljava-lang-String"><a href="#25-模拟执行okhttp3-Headers-name-I-Ljava-lang-String" class="headerlink" title="25.模拟执行okhttp3&#x2F;Headers-&gt;name(I)Ljava&#x2F;lang&#x2F;String;"></a>25.模拟执行okhttp3&#x2F;Headers-&gt;name(I)Ljava&#x2F;lang&#x2F;String;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602194250684.png" alt="image-20250602194250684"></p>
<p>已经熟练补环境了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602194501997.png" alt="image-20250602194501997" style="zoom:80%;" />

<h4 id="26-模拟执行okhttp3-Headers-value-I-Ljava-lang-String"><a href="#26-模拟执行okhttp3-Headers-value-I-Ljava-lang-String" class="headerlink" title="26.模拟执行okhttp3&#x2F;Headers-&gt;value(I)Ljava&#x2F;lang&#x2F;String;"></a>26.模拟执行okhttp3&#x2F;Headers-&gt;value(I)Ljava&#x2F;lang&#x2F;String;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602194609745.png" alt="image-20250602194609745"></p>
<p>补环境。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602194728717.png" alt="image-20250602194728717" style="zoom:80%;" />

<h4 id="27-模拟执行okhttp3-RequestBody-writeTo-Lokio-BufferedSink-V"><a href="#27-模拟执行okhttp3-RequestBody-writeTo-Lokio-BufferedSink-V" class="headerlink" title="27.模拟执行okhttp3&#x2F;RequestBody-&gt;writeTo(Lokio&#x2F;BufferedSink;)V"></a>27.模拟执行okhttp3&#x2F;RequestBody-&gt;writeTo(Lokio&#x2F;BufferedSink;)V</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602194931038.png" alt="image-20250602194931038"></p>
<p>这里不能像以前一样直接返回return了，得先完成目标操作，再return。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602195806272.png" alt="image-20250602195806272"></p>
<h4 id="28-模拟执行com-xingin-shield-http-ShieldLogger-buildSourceEnd-V"><a href="#28-模拟执行com-xingin-shield-http-ShieldLogger-buildSourceEnd-V" class="headerlink" title="28.模拟执行com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;buildSourceEnd()V"></a>28.模拟执行com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;buildSourceEnd()V</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602195956838.png" alt="image-20250602195956838"></p>
<p>补环境。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602200318384.png" alt="image-20250602200318384"></p>
<h4 id="29-模拟执行com-xingin-shield-http-ShieldLogger-calculateStart-V"><a href="#29-模拟执行com-xingin-shield-http-ShieldLogger-calculateStart-V" class="headerlink" title="29.模拟执行com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;calculateStart()V"></a>29.模拟执行com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;calculateStart()V</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602200341328.png" alt="image-20250602200341328"></p>
<p>补环境。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602200309079.png" alt="image-20250602200309079"></p>
<h4 id="30-模拟执行okio-Buffer-clone-Lokio-Buffer"><a href="#30-模拟执行okio-Buffer-clone-Lokio-Buffer" class="headerlink" title="30.模拟执行okio&#x2F;Buffer-&gt;clone()Lokio&#x2F;Buffer;"></a>30.模拟执行okio&#x2F;Buffer-&gt;clone()Lokio&#x2F;Buffer;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602200445181.png" alt="image-20250602200445181"></p>
<p>补环境。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602200937658.png" alt="image-20250602200937658"></p>
<h4 id="31-模拟执行okio-Buffer-read-B-I"><a href="#31-模拟执行okio-Buffer-read-B-I" class="headerlink" title="31.模拟执行okio&#x2F;Buffer-&gt;read([B)I"></a>31.模拟执行okio&#x2F;Buffer-&gt;read([B)I</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602201000240.png" alt="image-20250602201000240"></p>
<p>补环境。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602201559098.png" alt="image-20250602201559098" style="zoom: 67%;" />

<h4 id="32-模拟执行com-xingin-shield-http-ShieldLogger-calculateEnd-V"><a href="#32-模拟执行com-xingin-shield-http-ShieldLogger-calculateEnd-V" class="headerlink" title="32.模拟执行com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;calculateEnd()V"></a>32.模拟执行com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;calculateEnd()V</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602201700874.png" alt="image-20250602201700874"></p>
<p>补环境的代码如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602201749046.png" alt="image-20250602201749046"></p>
<h4 id="33-模拟执行okhttp3-Request-newBuilder-Lokhttp3-Request-Builder"><a href="#33-模拟执行okhttp3-Request-newBuilder-Lokhttp3-Request-Builder" class="headerlink" title="33.模拟执行okhttp3&#x2F;Request-&gt;newBuilder()Lokhttp3&#x2F;Request$Builder;"></a>33.模拟执行okhttp3&#x2F;Request-&gt;newBuilder()Lokhttp3&#x2F;Request$Builder;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602201831543.png" alt="image-20250602201831543"></p>
<p>补环境的代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;okhttp3/Request$Builder-&gt;header(Ljava/lang/String;Ljava/lang/String;)Lokhttp3/Request$Builder;&quot;</span>:</span><br><span class="line">    Request.<span class="type">Builder</span> <span class="variable">builderObj_header</span> <span class="operator">=</span> (Request.Builder) dvmObject.getValue();</span><br><span class="line">    <span class="type">String</span> <span class="variable">header_arg0</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>).getValue().toString();</span><br><span class="line">    <span class="type">String</span> <span class="variable">header_arg1</span> <span class="operator">=</span> (String)vaList.getObjectArg(<span class="number">1</span>).getValue();</span><br><span class="line">    builderObj_header.header(header_arg0,header_arg1);</span><br><span class="line">    <span class="keyword">return</span> dvmObject;</span><br></pre></td></tr></table></figure>

<h4 id="34-模拟执行okhttp3-Request-newBuilder-Lokhttp3-Request-Builder"><a href="#34-模拟执行okhttp3-Request-newBuilder-Lokhttp3-Request-Builder" class="headerlink" title="34.模拟执行okhttp3&#x2F;Request-&gt;newBuilder()Lokhttp3&#x2F;Request$Builder;"></a>34.模拟执行okhttp3&#x2F;Request-&gt;newBuilder()Lokhttp3&#x2F;Request$Builder;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602201932209.png" alt="image-20250602201932209"></p>
<p>补环境的代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;okhttp3/Request-&gt;newBuilder()Lokhttp3/Request$Builder;&quot;</span>:</span><br><span class="line">    <span class="type">Request</span> <span class="variable">requestObj_newBuilder</span> <span class="operator">=</span> (Request) dvmObject.getValue();</span><br><span class="line">    <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/Request$Builder&quot;</span>).newObject(requestObj_newBuilder.newBuilder());</span><br></pre></td></tr></table></figure>

<h4 id="35-模拟执行okhttp3-Request-Builder-build-Lokhttp3-Request"><a href="#35-模拟执行okhttp3-Request-Builder-build-Lokhttp3-Request" class="headerlink" title="35.模拟执行okhttp3&#x2F;Request$Builder-&gt;build()Lokhttp3&#x2F;Request;"></a>35.模拟执行okhttp3&#x2F;Request$Builder-&gt;build()Lokhttp3&#x2F;Request;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602202115517.png" alt="image-20250602202115517"></p>
<p>补环境的代码如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602202240171.png" alt="image-20250602202240171"></p>
<h4 id="36-模拟执行okhttp3-Interceptor-Chain-proceed-Lokhttp3-Request-Lokhttp3-Response"><a href="#36-模拟执行okhttp3-Interceptor-Chain-proceed-Lokhttp3-Request-Lokhttp3-Response" class="headerlink" title="36.模拟执行okhttp3&#x2F;Interceptor$Chain-&gt;proceed(Lokhttp3&#x2F;Request;)Lokhttp3&#x2F;Response;"></a>36.模拟执行okhttp3&#x2F;Interceptor$Chain-&gt;proceed(Lokhttp3&#x2F;Request;)Lokhttp3&#x2F;Response;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602202326256.png" alt="image-20250602202326256"></p>
<p>这里不需要模拟proceed的执行，因为proceed用于发送请求，说明字段shield已经添加好了，我们不关注发包，只关注shield是如何加密的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602202508983.png" alt="image-20250602202508983"></p>
<h4 id="37-模拟状态码"><a href="#37-模拟状态码" class="headerlink" title="37.模拟状态码"></a>37.模拟状态码</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602202616539.png" alt="image-20250602202616539"></p>
<p>直接返回200。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602202657482.png" alt="image-20250602202657482" style="zoom:80%;" />

<p>至此，总算是模拟完成了——37个要补充的地方，快累死了。</p>
<h4 id="38-获得shield"><a href="#38-获得shield" class="headerlink" title="38.获得shield"></a>38.获得shield</h4><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602202919661.png" alt="image-20250602202919661" style="zoom:80%;" />

<p>然后打印的是null。</p>
<p>注意到，之前我们在模拟环境的时候，总会使用newObject创建一个新的Request对象返回去，request的值其实始终没改变，因此，我们需要知道，最后一次返回Request类型的对象是哪个函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602203351055.png" alt="image-20250602203351055" style="zoom:80%;" />

<p>来到这个代码的地方，添加一句为request赋值的语句，更新request的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602203429152.png" alt="image-20250602203429152"></p>
<p>再次查看shield，这回有结果了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602203508023.png" alt="image-20250602203508023"></p>
<p>全部代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xhs;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.AndroidEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.api.Binder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.api.Bundle;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.api.ServiceManager;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.api.Signature;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.array.ByteArray;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.wrapper.DvmBoolean;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.wrapper.DvmInteger;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> okhttp3.*;</span><br><span class="line"><span class="keyword">import</span> okio.Buffer;</span><br><span class="line"><span class="keyword">import</span> okio.BufferedSink;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.binary.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.NoSuchPaddingException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateException;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XHS_shield</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AndroidEmulator emulator; <span class="comment">// 静态属性，以后对象和类都可以直接使用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Memory memory; <span class="comment">// 内存</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> VM vm; <span class="comment">// 虚拟机</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Module <span class="keyword">module</span>; <span class="comment">// 要加载的模块</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">DvmClass</span> <span class="variable">XhsInterceptor</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DvmObject XhsInterceptorObject;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> cPtr;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">DvmObject</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">public</span> Request request;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">XHS_shield</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// 64位虚拟设备，进程名为XHS</span></span><br><span class="line">        emulator = AndroidEmulatorBuilder.for64Bit().setProcessName(<span class="string">&quot;XHS&quot;</span>).build();</span><br><span class="line">        <span class="comment">// 获得内存对象</span></span><br><span class="line">        memory = emulator.getMemory();</span><br><span class="line">        <span class="comment">// 设置安卓sdk版本</span></span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>));</span><br><span class="line">        <span class="comment">// 创建虚拟机</span></span><br><span class="line">        vm = emulator.createDalvikVM(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/resources/xhs_pack/xhs.apk&quot;</span>));</span><br><span class="line">        <span class="comment">// 开启JNI互动</span></span><br><span class="line">        vm.setJni(<span class="built_in">this</span>); <span class="comment">// 后期补环境会用，把要补的环境写到当前类中，执行这个代码即可，但是必须要继承AbstractJni</span></span><br><span class="line">        <span class="comment">// 加载目标so</span></span><br><span class="line">        <span class="type">DalvikModule</span> <span class="variable">dm</span> <span class="operator">=</span> vm.loadLibrary(<span class="string">&quot;xyass&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 调用jni_onload</span></span><br><span class="line">        dm.callJNI_OnLoad(emulator);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = dm.getModule(); <span class="comment">// 把so加载到内存后，可以获得基地址、偏移量，该变量代指so文件</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析XhsInterceptor</span></span><br><span class="line">        XhsInterceptor = vm.resolveClass(<span class="string">&quot;com/xingin/shield/http/XhsHttpInterceptor&quot;</span>);</span><br><span class="line">        <span class="comment">// 获得一个空chain</span></span><br><span class="line"><span class="comment">//        chain = vm.resolveClass(&quot;okhttp3/Interceptor$Chain&quot;).newObject(null);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造url和request</span></span><br><span class="line">        url = <span class="string">&quot;https://edith.xiaohongshu.com/api/sns/v4/user/login/password?&quot;</span>;</span><br><span class="line">        request = <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                .url(url)</span><br><span class="line">                .addHeader(<span class="string">&quot;xy-direction&quot;</span>,<span class="string">&quot;88&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;X-B3-TraceId&quot;</span>,<span class="string">&quot;4b4bdb48881d080f&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-xray-traceid&quot;</span>,<span class="string">&quot;cb1441a76a4a081ecd469a26f3706ad0&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;xy-scene&quot;</span>,<span class="string">&quot;fs=0&amp;point=1932&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-legacy-did&quot;</span>,<span class="string">&quot;f10f91f68-7db7-3a36-80c9-703abad8fee2&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-legacy-fid&quot;</span>,<span class="string">&quot;17442981081013d20c9158a0a9b29abbcbb1ed726f5b&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-legacy-sid&quot;</span>,<span class="string">&quot;session.1744300626655701629150&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-mini-gid&quot;</span>,<span class="string">&quot;7c0d68e8647a5438a2394bbad364c2bdf31b98794735944077bbfc55&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-mini-s1&quot;</span>,<span class="string">&quot;ABsAAAABKjIUDN/qnVyFrjdjCBjTNhmOGE0SjnzqstjuHWyj5wVhUjSgHTzsuqoPKuiiOhD4JesIeK1AX8w=&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-mini-sig&quot;</span>,<span class="string">&quot;a619346fd57b0f2494eb8e197cf8fe6bb33cd62241a67e03343700de0ab8b8ff&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-mini-mua&quot;</span>,<span class="string">&quot;eyJhIjoiRUNGQUFGMDEiLCJjIjo0MSwiayI6ImQzNjkxYjYzMGJhODNmODljZTM0M2Q5NDlmODU2NTcyNzY5NTg2YTA5YzhmNTJhMjgzNWNiYjhjZjYxZTAwMTciLCJwIjoiYSIsInMiOiJkZmQ0OTI4ZWZlNTA5NDg1MTg5ZmJjOGEwMGRmMmMwYyIsInQiOnsiYyI6NDgsImQiOjQsImYiOjAsInMiOjQwOTgsInQiOjE3NDY3MTQwLCJ0dCI6WzFdfSwidSI6IjAwMDAwMDAwMmMwOGQwYWI0ZDdlNjExMjM4NmU2YmEyOTljZjAzNzIiLCJ2IjoiMi44LjUifQ.r2k40ztxFkHb9YD9W-r8ktVwWcyCuRLf0MmPFBWxV-9voigXNb_Bkvc3Vf8X3qs2wwcX2CpuPWIpylpfB9dwGR_CB3GAZrG1NpfKMjoDZh3Q6VAtuROrlVc7eAi-SqcGE-Z7GoU5tDth4LC9Fg0lbTIa6w6T6WTD_7QUlGroY8huQKkU26M7Whhv7nIFZQtkleznZtw276pAfbuvqyM9zMJb6TN4vqSrPeRRBBIn-7vgTNYF5pS7sF3yeshHP9BbS5QgFACF2I5iBo-z2dSMJkPeyPltMlabkqqJcf4fAjbqECYOCZusmkHXTfFk7-bwTYTW2TzeFFOBYMXNwBWKeOXe4aRqCcqbkjQQzPnJ3EHL-rzXCnKPv7Uf63MfEVxq9LqG398kwYNbUfkRdiGeM_X3OrwBLQ54cmA9jQa25L5jNzUo_2s1dS4Heg1EsEkLtNhAD9zDYDmjRpY6lbe94i_5oWLux8USIomK6_-TbvoEm1w3A51MwcJMVtiop-klqFRHEkazDUQA-76XS1Ogptxo9JpFSSYQt-S6Wet8nvg344UHUuhmXx7bb-gPYepYR6CQOt6EuCNOmLUIDLo0GgniHf2VJNQieSDxuYUIO3EGOXiwzxxB4Lv0TeSRTdqc8U7bLOb-GPeh49my4YWFHVcWEsqRO55EawZF0MSL4aekkiC5ZMm1SpoaJ60XKKVhNfG7sYf7LmIs6kMd3tNFFjvs3CFNlFgu58falTh13_W-sGsMZS3e-Cvlh6PKHic4l36rF2NH1xa2XmbY_VJzQyPm6tlD57IX89HocmwL1emORGPUx6EkhEkgbU-ZiXKcXmEC4W3njsliIc4HY18MurQmn2szKA4Kyl0Yo05igx5DlpJedTiALaaczSuaPr9Ko5xbcrSeFzFPc682BPkwZ1z8H-Hb5ljHDi2wqdvHepBVf8f96SbPEobd52wRjKh4hgdwxuUrKiM4JD3fxlCheGkLvMByCEXL3pP3oMMk7Bjblf-a_qw8cPdjzj_XOzrlcr-gWq1y79AyoyIF3CEri04uJEvnauaNNqLYOjWUYidJiuHdfpj0hQ3o-tEv19hiA4Qx_Bn_qG8BQEpVgksCTu9iwrIaeCjCZ486-waE09M.&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;xy-common-params&quot;</span>,<span class="string">&quot;fid=17442981081013d20c9158a0a9b29abbcbb1ed726f5b&amp;gid=7c0d68e8647a5438a2394bbad364c2bdf31b98794735944077bbfc55&amp;device_model=phone&amp;tz=Asia%2FShanghai&amp;channel=Vivo&amp;versionName=8.77.0&amp;deviceId=10f91f68-7db7-3a36-80c9-703abad8fee2&amp;platform=android&amp;sid=session.1744300626655701629150&amp;identifier_flag=4&amp;project_id=ECFAAF&amp;x_trace_page_current=login_full_screen_pwd_page&amp;lang=zh-Hans&amp;app_id=ECFAAF01&amp;uis=light&amp;teenager=0&amp;active_ctry=CN&amp;cpu_name=Qualcomm+Technologies%2C+Inc+SM8150&amp;dlang=zh&amp;launch_id=1744436392&amp;overseas_channel=0&amp;mlanguage=zh_cn&amp;folder_type=none&amp;auto_trans=0&amp;t=1744436385&amp;build=8770299&amp;holder_ctry=CN&amp;did=2d351bbef1db838c5fcd6b67a4aa1db5&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;User-Agent&quot;</span>,<span class="string">&quot;Dalvik/2.1.0 (Linux; U; Android 13; Pixel 4 XL Build/TP1A.221005.002.B2) Resolution/1440*3040 Version/8.77.0 Build/8770299 Device/(Google;Pixel 4 XL) discover/8.77.0 NetType/WiFi&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;Referer&quot;</span>,<span class="string">&quot;https://app.xhs.cn/&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; getStaticObjectField(BaseVM vm, DvmClass dvmClass, String signature) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;com/xingin/shield/http/ContextHolder-&gt;sLogger:Lcom/xingin/shield/http/ShieldLogger;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;com/xingin/shield/http/ShieldLogger&quot;</span>).newObject(<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;com/xingin/shield/http/ContextHolder-&gt;sDeviceId:Ljava/lang/String;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;518dfe96-7f6f-370a-8e80-f94f8838e6de&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getStaticObjectField(vm, dvmClass, signature);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">callVoidMethodV</span><span class="params">(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;nativeInitializeStart()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;nativeInitializeStart() trap!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;nativeInitializeEnd()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;nativeInitializeEnd() trap&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;initializeStart()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;initializeStart() trap&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;initializedEnd()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;initializedEnd() trap&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;buildSourceStart()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;buildSourceStart trap&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;okhttp3/RequestBody-&gt;writeTo(Lokio/BufferedSink;)V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;writeTo trap&quot;</span>);</span><br><span class="line">            <span class="type">RequestBody</span> <span class="variable">requestBody</span> <span class="operator">=</span> (RequestBody) dvmObject.getValue();</span><br><span class="line">            <span class="type">BufferedSink</span> <span class="variable">bufferedSink</span> <span class="operator">=</span> (BufferedSink) vaList.getObjectArg(<span class="number">0</span>).getValue();</span><br><span class="line">            <span class="keyword">if</span>(requestBody == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                requestBody.writeTo(bufferedSink);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;buildSourceEnd()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;calculateStart()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;calculateEnd()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>.callVoidMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; callStaticObjectMethodV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(signature)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;java/nio/charset/Charset-&gt;defaultCharset()Ljava/nio/charset/Charset;&quot;</span>: &#123;</span><br><span class="line">                <span class="keyword">return</span> dvmClass.newObject(Charset.defaultCharset());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;com/xingin/shield/http/Base64Helper-&gt;decode(Ljava/lang/String;)[B&quot;</span>:&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">getString_arg0</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>).getValue().toString();</span><br><span class="line">                System.out.println(<span class="string">&quot;Base64Helper arg0: &quot;</span> + getString_arg0);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, Base64.decodeBase64(getString_arg0));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.callStaticObjectMethodV(vm, dvmClass, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStaticIntField</span><span class="params">(BaseVM vm, DvmClass dvmClass, String signature)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ContextHolder-&gt;sAppId:I&quot;</span>.equals(signature))&#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">319115519</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getStaticIntField(vm, dvmClass, signature);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList)&#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;android/content/Context-&gt;getSharedPreferences(Ljava/lang/String;I)Landroid/content/SharedPreferences;&quot;</span>:&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">getSharedPreferences_arg0</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>).getValue().toString();</span><br><span class="line">                System.out.println(<span class="string">&quot;arg0 = &quot;</span> + getSharedPreferences_arg0);</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;android/content/SharedPreferences&quot;</span>).newObject(getSharedPreferences_arg0);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;android/content/SharedPreferences-&gt;getString(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;&quot;</span>:&#123;</span><br><span class="line">                <span class="keyword">if</span>(dvmObject.getValue().toString().equals(<span class="string">&quot;s&quot;</span>))&#123;  <span class="comment">// 获取getSharedPreferences_arg0</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">getString_arg0</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>).getValue().toString(); <span class="comment">// 获取键</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">getString_arg1</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">1</span>).getValue().toString(); <span class="comment">// 获得默认值</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;key: &quot;</span> + getString_arg0);</span><br><span class="line">                    System.out.println(<span class="string">&quot;default_value: &quot;</span> + getString_arg1);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (getString_arg0.equals(<span class="string">&quot;main_hmac&quot;</span>)) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;SharedPreferences -&gt; getString(): &quot;</span> + <span class="string">&quot;Msm7d4eAmQVoQie97ci+UCY3fL6YKxBwT2qSuID0IOxYqWkpyRFdN6bM2LvQTlPzdQ5qkkJx/T2QMa8V/z+zkKAqh1mZevC+GYm8UJDPuZKbSI/ROWnKwlTiCvIMHEyY&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm,<span class="string">&quot;Msm7d4eAmQVoQie97ci+UCY3fL6YKxBwT2qSuID0IOxYqWkpyRFdN6bM2LvQTlPzdQ5qkkJx/T2QMa8V/z+zkKAqh1mZevC+GYm8UJDPuZKbSI/ROWnKwlTiCvIMHEyY&quot;</span>);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;SharedPreferences -&gt; getString(): &quot;</span> + getString_arg1);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, getString_arg1);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Interceptor$Chain-&gt;request()Lokhttp3/Request;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/Request&quot;</span>).newObject(request);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Request-&gt;url()Lokhttp3/HttpUrl;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/HttpUrl&quot;</span>).newObject(request.url());</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/HttpUrl-&gt;encodedQuery()Ljava/lang/String;&quot;</span>:&#123;</span><br><span class="line">                <span class="type">HttpUrl</span> <span class="variable">httpUrlObj_encodedQuery</span> <span class="operator">=</span> (HttpUrl) dvmObject.getValue();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, httpUrlObj_encodedQuery.encodedQuery());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/HttpUrl-&gt;encodedPath()Ljava/lang/String;&quot;</span>:&#123;</span><br><span class="line">                <span class="type">HttpUrl</span> <span class="variable">httpUrl</span> <span class="operator">=</span> (HttpUrl) dvmObject.getValue();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, httpUrl.encodedPath());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Request-&gt;body()Lokhttp3/RequestBody;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/RequestBody&quot;</span>).newObject(request.body());</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Request-&gt;headers()Lokhttp3/Headers;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/Headers&quot;</span>).newObject(request.headers());</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okio/Buffer-&gt;writeString(Ljava/lang/String;Ljava/nio/charset/Charset;)Lokio/Buffer;&quot;</span>:&#123;</span><br><span class="line">                <span class="type">Buffer</span> <span class="variable">buffer</span> <span class="operator">=</span> (Buffer) dvmObject.getValue(); <span class="comment">// 取出实例</span></span><br><span class="line">                <span class="comment">// 取出参数</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">arg0</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>).getValue().toString();</span><br><span class="line">                <span class="type">Charset</span> <span class="variable">arg1</span> <span class="operator">=</span> (Charset) vaList.getObjectArg(<span class="number">1</span>).getValue();</span><br><span class="line">                <span class="comment">// 调用writeString</span></span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okio/Buffer&quot;</span>).newObject(buffer.writeString(arg0, arg1));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Headers-&gt;name(I)Ljava/lang/String;&quot;</span>:&#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">arg0</span> <span class="operator">=</span> vaList.getIntArg(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, ((Headers)dvmObject.getValue()).name(arg0));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Headers-&gt;value(I)Ljava/lang/String;&quot;</span>:&#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">arg0</span> <span class="operator">=</span> vaList.getIntArg(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, ((Headers)dvmObject.getValue()).value(arg0));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okio/Buffer-&gt;clone()Lokio/Buffer;&quot;</span>:&#123;</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okio/Buffer&quot;</span>).newObject(((Buffer)dvmObject.getValue()).clone());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Request$Builder-&gt;header(Ljava/lang/String;Ljava/lang/String;)Lokhttp3/Request$Builder;&quot;</span>:&#123;</span><br><span class="line">                Request.<span class="type">Builder</span> <span class="variable">builderObj_header</span> <span class="operator">=</span> (Request.Builder) dvmObject.getValue();</span><br><span class="line">                <span class="type">String</span> <span class="variable">header_arg0</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>).getValue().toString();</span><br><span class="line">                <span class="type">String</span> <span class="variable">header_arg1</span> <span class="operator">=</span> (String)vaList.getObjectArg(<span class="number">1</span>).getValue();</span><br><span class="line">                builderObj_header.header(header_arg0,header_arg1);</span><br><span class="line">                <span class="keyword">return</span> dvmObject;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Request-&gt;newBuilder()Lokhttp3/Request$Builder;&quot;</span>:&#123;</span><br><span class="line">                <span class="type">Request</span> <span class="variable">requestObj_newBuilder</span> <span class="operator">=</span> (Request) dvmObject.getValue();</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/Request$Builder&quot;</span>).newObject(requestObj_newBuilder.newBuilder());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Request$Builder-&gt;build()Lokhttp3/Request;&quot;</span>:&#123;</span><br><span class="line">                Request.Builder builderObj_build= (Request.Builder) dvmObject.getValue();</span><br><span class="line">                <span class="type">Request</span> <span class="variable">requestObj_build</span> <span class="operator">=</span> builderObj_build.build();</span><br><span class="line">                request = requestObj_build;</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/Request&quot;</span>).newObject(requestObj_build);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Interceptor$Chain-&gt;proceed(Lokhttp3/Request;)Lokhttp3/Response;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/Response&quot;</span>).newObject(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; newObjectV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okio/Buffer-&gt;&lt;init&gt;()V&quot;</span>:&#123;</span><br><span class="line">                <span class="keyword">return</span> dvmClass.newObject(<span class="keyword">new</span> <span class="title class_">Buffer</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.newObjectV(vm, dvmClass, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">callIntMethodV</span><span class="params">(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Headers-&gt;size()I&quot;</span>:&#123;</span><br><span class="line">                <span class="keyword">return</span> ((Headers) dvmObject.getValue()).size();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okio/Buffer-&gt;read([B)I&quot;</span>:&#123;</span><br><span class="line">                <span class="type">Buffer</span> <span class="variable">buffer</span> <span class="operator">=</span> (Buffer) dvmObject.getValue();</span><br><span class="line">                <span class="type">byte</span>[] bytes = (<span class="type">byte</span>[]) vaList.getObjectArg(<span class="number">0</span>).getValue();</span><br><span class="line">                <span class="keyword">return</span> buffer.read(bytes);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Response-&gt;code()I&quot;</span>:&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">200</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.callIntMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用initialNative</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initializeNative</span><span class="params">()</span>&#123;</span><br><span class="line">        XhsInterceptor.callStaticJniMethod(emulator, <span class="string">&quot;initializeNative()V&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用initialize</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span>&#123;</span><br><span class="line">        XhsInterceptorObject = XhsInterceptor.newObject(<span class="literal">null</span>);</span><br><span class="line">        cPtr = XhsInterceptorObject.callJniMethodLong(emulator, <span class="string">&quot;initialize(Ljava/lang/String;)J&quot;</span>, <span class="string">&quot;main&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;cPtr = &quot;</span> + cPtr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用intercept</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">get_shield</span><span class="params">()</span>&#123;</span><br><span class="line">        chain = vm.resolveClass(<span class="string">&quot;okhttp3/Interceptor$Chain&quot;</span>).newObject(<span class="literal">null</span>);</span><br><span class="line">        DvmObject&lt;?&gt; response = XhsInterceptorObject.callJniMethodObject(emulator, <span class="string">&quot;intercept(Lokhttp3/Interceptor$Chain;J)Lokhttp3/Response;&quot;</span>, chain, cPtr);</span><br><span class="line">        System.out.println(<span class="string">&quot;response = &quot;</span> + response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">XHS_shield</span> <span class="variable">shield</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XHS_shield</span>();</span><br><span class="line">        shield.initializeNative();</span><br><span class="line">        shield.initialize();</span><br><span class="line">        shield.get_shield();</span><br><span class="line">        System.out.println(<span class="string">&quot;shield = &quot;</span> + shield.request.headers().get(<span class="string">&quot;shield&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>补环境补了好久，幸好有大佬们的博客，在补环境的过程中，我也逐渐学会了各式各样的unidbg补环境的方法，今天先歇一歇，明天开始trace指令流，分析加密点。——2025.6.2，晚上20:36。</p>
<h3 id="Unidbg-trace"><a href="#Unidbg-trace" class="headerlink" title="Unidbg trace"></a>Unidbg trace</h3><h4 id="获得日志"><a href="#获得日志" class="headerlink" title="获得日志"></a>获得日志</h4><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">traceCode</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">traceFile</span> <span class="operator">=</span> <span class="string">&quot;unidbg-android/src/test/java/com/xhs/traceCode.log&quot;</span>; <span class="comment">// 输出的路径</span></span><br><span class="line">    <span class="type">PrintStream</span> <span class="variable">traceStream</span> <span class="operator">=</span> <span class="literal">null</span>; <span class="comment">// 打印流</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        traceStream = <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(traceFile), <span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// traceCode 对代码进行监控</span></span><br><span class="line">    emulator.traceCode(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base + <span class="keyword">module</span>.size).setRedirect(traceStream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后从JNI_OnLoad开始trace的话，日志存了120w条指令；而从sub_9E184开始trace，只有1700多行，我们主要关注的是sub_9E184的逻辑。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603101528525.png" alt="image-20250603101528525"></p>
<p>注意到，这里把寄存器变化的值打印出来了，假如某寄存器存放着字符串的地址，这里也只是打印地址，而不会打印字符串，这样的日志不便于观察。</p>
<p>因此，我们需要修改traceCode的逻辑。</p>
<h4 id="修改Unidbg，获得带有字符串信息的日志"><a href="#修改Unidbg，获得带有字符串信息的日志" class="headerlink" title="修改Unidbg，获得带有字符串信息的日志"></a>修改Unidbg，获得带有字符串信息的日志</h4><p>注意到，日志会出现符号“&#x3D;&gt;”，于是在整个项目中搜索这个符号。然后发现，文件RegAccessPrinter.java就是我要们要修改的文件。</p>
<p>我在这里设定，每次读取寄存器的内容，当初字符串地址进行访问，如果读取后发现了连续3个可视字符，就当成字符串进行处理，打印整个字符串。</p>
<p>在Unidbg中，读取指定内存区域的字节又该怎么做呢？——我记得Unidbg动调可以访问内存地址，指令是“m”，于是在整个项目搜索“m”，然后发现是用Pointer类型进行访问，于是代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Method to check if the register value points to a readable string and print it</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkAndPrintString</span><span class="params">(<span class="type">long</span> address, StringBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取指向指定地址的 Pointer 对象</span></span><br><span class="line">            <span class="type">Pointer</span> <span class="variable">pointer</span> <span class="operator">=</span> UnidbgPointer.pointer(emulator, address);</span><br><span class="line">            <span class="keyword">if</span> (pointer == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// 地址无效，直接返回</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 从地址读取 256 字节的数据</span></span><br><span class="line">            <span class="type">byte</span>[] bytes = pointer.getByteArray(<span class="number">0</span>, <span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查是否为可打印字符串并提取</span></span><br><span class="line">            <span class="keyword">if</span> (isPrintableString(bytes)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> extractString(bytes);</span><br><span class="line">                builder.append(<span class="string">&quot; (string: \&quot;&quot;</span>).append(str).append(<span class="string">&quot;\&quot;)&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 忽略内存不可读或无效的情况</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if the first 3 bytes are printable ASCII characters</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isPrintableString</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (bytes.length &lt; <span class="number">3</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bytes[i] &lt; <span class="number">32</span> || bytes[i] &gt; <span class="number">126</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Extract the full string until a non-printable character or null terminator</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">extractString</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : bytes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (b &gt;= <span class="number">32</span> &amp;&amp; b &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">                sb.append((<span class="type">char</span>) b);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>; <span class="comment">// Stop at first non-printable character</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>将checkAndPrintString移动到函数print内部。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603121620460.png" alt="image-20250603121620460" style="zoom:80%;" />

<p>同时，由于调用UnidbgPointer.Pointer需要Emulator对象，所以还得往类RegAccessPrinter添加成员变量。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603122310517.png" alt="image-20250603122310517"></p>
<p>既然改了构造函数，还需要在调用构造函数的地方，把Emulator对象传进去。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603122457201.png" alt="image-20250603122457201"></p>
<p>重新运行，程序能正常跑了。</p>
<p>日志中出现了我们想看到的字符串。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603122547995.png" alt="image-20250603122547995"></p>
<h3 id="寻找加密点"><a href="#寻找加密点" class="headerlink" title="寻找加密点"></a>寻找加密点</h3><p>通过带有字符串信息的日志可以知道：</p>
<ol>
<li>shield最早出现在哪条指令；</li>
<li>shield的缓冲区地址在哪。</li>
</ol>
<p>于是，有2个思路去寻找加密点：</p>
<ol>
<li>根据shield最早出现的指令，朝着之前的指令进行溯源；</li>
<li>在shield的缓冲区地址设置读写断点。</li>
</ol>
<p>怎么看都是第2种方式更简单。</p>
<p>找到缓冲区地址：0x1240c000。——因为是unidbg模拟的缓冲区，所以缓冲区地址不会变。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603124025662.png" alt="image-20250603124025662"></p>
<p>我们的shield长度是134个字节，内容为：</p>
<p>XYAAQAAgAAAAEAAABTAAAAUzUWEe0xG1IbD9&#x2F;c+qCLOlKGmTtFa+lG434Je+FUTaRHxIzkyONuSp3&#x2F;qeYJz8Mt3Jx+2fc6EAwYGGHebLP31H5m0rHnmtyNNSyC55+4O2fp4TDk</p>
<p>unidbg提供了api，可以对写操作进行监控。——traceWrite。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603130831459.png" alt="image-20250603130831459"></p>
<p>可以发现，偏移0x4b024处在将正确的值写回去了。</p>
<h2 id="分析加密算法"><a href="#分析加密算法" class="headerlink" title="分析加密算法"></a>分析加密算法</h2><p>先在IDA中，来到0x4b024看看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603132235532.png" alt="image-20250603132235532"></p>
<p>用frida hook一下，查看memcpy复制的内容，发现与最后的shield相差了2个字节，有2个字节（XY）不见了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603133116946.png" alt="image-20250603133116946" style="zoom:80%;" />

<p>根据之前traceWrite日志，可以发现0x4af74单独对0x1240c000前2个字节进行了修改。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603133810826.png" alt="image-20250603133810826"></p>
<p>根据观察，0x4af70对前2个字节做了赋值，而0x4b020对132个字节进行了赋值。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603135404795.png" alt="image-20250603135404795" style="zoom: 50%;" />

<p>而且，对a1进行交叉引用，发现没有任何修改a1的地方；查看a1被传入的地方，只发现了简单的加解密，也就是说，前2个字节是固定的，根据直接的traceWrtie日志，固定为XY，因此我们分析的重点在v16。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603134655647.png" alt="image-20250603134655647"></p>
<p>而v16似乎涉及加密。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603134245833.png" alt="image-20250603134245833" style="zoom:80%;" />

<p>在Unidbg中，对v16涉及的memcpy下断点，查看源地址是什么。（已知目的地址是0x1240c002）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603142532252.png" alt="image-20250603142532252"></p>
<p>可以看到，源地址是0x1240c0a0，于是在0x1240c0a0下写断点。</p>
<p>发现，0x1240c0a0在libxyass.so偏移0x82890的地方被写入数据。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603144957562.png" alt="image-20250603144957562"></p>
<p>注意到，shield有点像是base64编码后的结果，而且0x82890的代码又是每轮取出v136的3个字节，然后赋给v138的4个字节，这是base64编码的特征。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603150611119.png" alt="image-20250603150611119" style="zoom:80%;" />

<p>在IDA中，来到汇编层，X10应该是：指向未经过base64编码的数据的地址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603151336773.png" alt="image-20250603151336773"></p>
<p>在Unidbg中下个断点，然后查看这里的值。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603151739554.png" alt="image-20250603151739554" style="zoom:80%;" />

<p>对这里的内容进行base64编码，跟我们最终的shield后134字节一模一样，坐实了这里是base64编码。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603151957773.png" alt="image-20250603151957773"></p>
<p>注意到，这个数据的地址是0x12411000，对这里下一个写断点。（编码前是99字节）</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603152310130.png" alt="image-20250603152310130" style="zoom:80%;" />

<p>注意到，99个字节的前16个字节的LR指向libxyass.so偏移0x49da0的位置，而后面83个字节来自偏移0x49db4的位置。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603152839854.png" alt="image-20250603152839854" style="zoom:80%;" />

<p>来到IDA中。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603153216623.png" alt="image-20250603153216623" style="zoom:80%;" />

<p>先后查看两个memcpy的源地址（下断点），然后对源地址下写断点。</p>
<p>先看前16字节的memcpy的x1在哪，由于我hook的地址是0x49D9C，有些数据不是我们想要的，我们只需要前16个字节是00 04 00 02…的源地址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603154925545.png" alt="image-20250603154925545"></p>
<p>第4次进入该函数后，终于找到前16个字节的源地址是0xe4ffefd9。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603155121052.png" alt="image-20250603155121052" style="zoom: 67%;" />

<p>再来找后83个字节的x1在哪。——找到后83个字节在0x123dc060。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603155314815.png" alt="image-20250603155314815" style="zoom:67%;" />

<h3 id="0x10个字节（I）"><a href="#0x10个字节（I）" class="headerlink" title="0x10个字节（I）"></a>0x10个字节（I）</h3><p>通过IDA的伪代码分析，v15是前16个字节，它来自于a1+1或者a1+16的位置。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603161446117.png" alt="image-20250603161446117" style="zoom:80%;" />

<p>hook函数sub_49CE4，查看a1内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603161608228.png" alt="image-20250603161608228" style="zoom:80%;" />

<p>确定v15来自a1+1。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603162158928.png" alt="image-20250603162158928" style="zoom:80%;" />

<p>查看交叉引用，从哪一个过来的呢。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603162635148.png" alt="image-20250603162635148" style="zoom:80%;" />

<p>根据trace日志，可以发现是从0x4a2e0跳转过来的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603163817199.png" alt="image-20250603163817199"></p>
<p>地址0x4a2e0属于函数sub_4a278，hook一下函数的入参，可以发现x0和x1分别指向16字节和83字节，而x2代表x1的长度。</p>
<p>这里继续观察 16个字节，16个字节位于栈0xe4ffefd8上。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605093906663.png" alt="image-20250605093906663" style="zoom:80%;" />

<p>因此对0xe4ffefd8下一个写断点，注意到0x8271C、0x8272C等地址会往里写目标字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605100625749.png" alt="image-20250605100625749"></p>
<p>来到0x8271C，位于函数sub_81F00的范围内。</p>
<p>下图，我对17个字节进行了分析（<strong>第0个字节是0x20，0x20并不在目标16字节内，它另有作用</strong>）。</p>
<h4 id="第0、3-4、5-8、9-12字节分析"><a href="#第0、3-4、5-8、9-12字节分析" class="headerlink" title="第0、3-4、5-8、9-12字节分析"></a>第0、3-4、5-8、9-12字节分析</h4><p>v124用来描述v127（53个字节）的长度，所以v124是0x53，经过bswap32后变成0x53 00 00 00。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605125053638.png" alt="image-20250605125053638" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605101334210.png" alt="image-20250605101334210"></p>
<p>因此，这17个字节的格式是这样的：</p>
<p>20 ?? ?? ?? ?? 00 00 00 01 53 00 00 00 ?? ?? ?? ?? </p>
<p>再来判断第1-4个字节是如何来的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603181820765.png" alt="image-20250603181820765"></p>
<p>假设v155是0xAB CD EF GH，左移16位后，0xEF GH 00 00，或上一个2后，0xEF GH 00 02，然后swap32交换次序，0x02 00 GH EF，也就是说，有2个字节是固定的，GH EF相当于原来的v155的低2个字节做了交换。</p>
<p>当前的v157是这样的：</p>
<p>20 ?? ?? 00 02 00 00 00 01 53 00 00 00 ?? ?? ?? ??</p>
<h4 id="第13-16字节分析"><a href="#第13-16字节分析" class="headerlink" title="第13-16字节分析"></a>第13-16字节分析</h4><p>暂时先不分析第1-2字节，这个难度有点高，先来看最后4个字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605144331650.png" alt="image-20250605144331650"></p>
<p>对v161进行交叉引用，发现v161 &#x3D; v35。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605144421784.png" alt="image-20250605144421784" style="zoom:80%;" />

<p>阅读下图，v161获得了sub_4A278的返回值，我们上面的图中，也出现了sub_4A278。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605144526867.png" alt="image-20250605144526867" style="zoom:80%;" />

<p>对sub_4A278进行分析，发现它是一个类似memcpy的函数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605145136195.png" alt="image-20250605145136195"></p>
<p>不同的是，target是std::string类型，而src是char数组。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605152800396.png" alt="image-20250605152800396" style="zoom:80%;" />

<p>string类型是24个字节，之前提到过string类型会对短字符串做sso优化，存储短字符串和长字符串时，string采用的结构不同。</p>
<p>v3 &amp; 1，即target的最低位与1做&amp;，如果（v3&amp;1 !&#x3D; 0）为true，则说明当前当前的string存储着长字符串，采用__long结构；而反之为false，则采用__short结构。</p>
<p>当遇到一个string类型，先判断第0位是否为1，如果是1，则采取__long结构，不用担心第0位的1会影响__cap_的值，__cap_被规定需要2字节对齐，所以第0位单纯是flag；而如果第0位是0，则采取__short结构，该结构会使用高7位表示data的大小，舍弃掉flag的1位，因为data就23个字节，最后一个字节还要存\x00，所以data的实际存储空间大小就22字节，用7位足够表示了。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">+--------+----------------+----------+</span><br><span class="line">|address |    __short     | __long   |</span><br><span class="line">+--------+----------------+----------+</span><br><span class="line">|   0    | __size_ / __lx |          |</span><br><span class="line">+--------+----------------+          |</span><br><span class="line">|   1    |                |          |</span><br><span class="line">|   2    |                |          |</span><br><span class="line">|   3    |                | __cap_   |</span><br><span class="line">|   4    |                |          |</span><br><span class="line">|   5    |                |          |</span><br><span class="line">|   6    |                |          |</span><br><span class="line">|   7    |                |          |</span><br><span class="line">+--------|                |----------+</span><br><span class="line">|   8    |                |          |</span><br><span class="line">|   9    |                |          |</span><br><span class="line">|   10   |                |          |</span><br><span class="line">|   11   |   __data_      | __size_  |</span><br><span class="line">|   12   |                |          |</span><br><span class="line">|   13   |                |          |</span><br><span class="line">|   14   |                |          |</span><br><span class="line">|   15   |                |          |</span><br><span class="line">+--------|                |----------+</span><br><span class="line">|   16   |                |          |</span><br><span class="line">|   17   |                |          |</span><br><span class="line">|   18   |                |          |</span><br><span class="line">|   19   |                | __data_  |</span><br><span class="line">|   20   |                |          |</span><br><span class="line">|   21   |                |          |</span><br><span class="line">|   22   |                |          |</span><br><span class="line">|   23   |                |          |</span><br><span class="line">+--------+----------------+----------+</span><br></pre></td></tr></table></figure>

<p>注意到，在函数sub_81F00中，一共调用了4次sub_4A278，而v34 &#x3D; sub_4A278是第3次调用，也就是说，v34里面累积存放了4个字符串——原本有1个，再通过sub_4A278追加了3个。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605155300448.png" alt="image-20250605155300448"></p>
<p>在Unidbg中模拟执行，对函数sub_4A278进行hook，可以发现：一共就调用了4次sub_81F00，所以基本可以确认，这4次调用都来自于sub_81F00。</p>
<p><strong>第一次调用sub_4A278。</strong></p>
<p>x0指向string类型对象，x1指向char数组，x2是char数组的长度。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605160706893.png" alt="image-20250605160706893"></p>
<p>第1个字节是0x21，它最低位是1，说明是__long类型；</p>
<p>第1个8字节是0x21，由于对齐，算作0x20，也就是说有32个字节的缓冲区；</p>
<p>第2个8字节说明缓冲区已经用了0x18个字节，也就是用掉了24个字节；</p>
<p>第3个8字节是缓冲区（堆）的地址。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605161157351.png" alt="image-20250605161157351" style="zoom:67%;" />

<p>查看堆里面存放的内容，正好24个字节。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605161634428.png" alt="image-20250605161634428" style="zoom:67%;" />

<p>待添加的字符串存在x1指向的地址中。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605162735679.png" alt="image-20250605162735679" style="zoom:80%;" />

<p><strong>第二次调用sub_4A278。</strong></p>
<p>x0指向string类型对象，x1指向char数组，x2是char数组的长度。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605161855783.png" alt="image-20250605161855783"></p>
<p>查看x0的内容。</p>
<p>第1个8字节是0x21，由于对齐，算作0x20，也就是说有32个字节的缓冲区。——因为之前32个字节，原本的字符串长度是24个字节，第一次调用时需要添加了7个字节，而缓冲区剩下的8个字节足够容纳，不需要重新申请空间。</p>
<p>第2个8字节由于添加了7个字节，由0x18 + 0x7变成了0x1F。</p>
<p>第3个8字节由于不用重新申请空间，所以空间地址和第一次调用时的堆地址一样，没变。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605162022804.png" alt="image-20250605162022804">z</p>
<p>查看堆里面存放的内容，可以看到已经添加上8770299了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605162517804.png" alt="image-20250605162517804"></p>
<p><strong>第三次调用sub_4A278。</strong></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605162832317.png" alt="image-20250605162832317"></p>
<p>第一个字节是0x51，说明是__long类型。</p>
<p>第1个8字节，0x51视作0x50，说明新申请的缓冲区有80字节的大小。</p>
<p>第2个8字节，0x43表示已经使用了0x43个字节。</p>
<p>第3个8字节，0x12407000是新缓冲区的地址。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605162931543.png" alt="image-20250605162931543" style="zoom:80%;" />

<p>18dfe96-7f6f-370a-8e80-f94f8838e6de已经被复制到缓冲区里了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605163247658.png" alt="image-20250605163247658" style="zoom:80%;" />

<p>sub_4A278的返回值是string对象的地址，也就是说，v161指向这4个字符串。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605163551389.png" alt="image-20250605163551389"></p>
<p>再也就是说，这里的v123实际上是在获得长度，而4个字符串的长度分别是0x18 + 0x7 + 0x24 + 0x10，和为0x53。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605144331650.png" alt="image-20250605144331650"></p>
<p>所以16字节的第9-12和13-16都是53 00 00 00，都代表着v127的长度。</p>
<p>为什么v156是17字节，而非16个字节，第0个字节为什么是0x20？很明显了，0x20说明是短字符串存储，经过sso优化，直接存储在对象内部，不用开辟堆空间。</p>
<p>砍去一个0不用，剩下的7位表示data部分使用的字节数，0x0010000就是是十进制16，也就是目标16个字节的长度。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605164202847.png" alt="image-20250605164202847"></p>
<p>言归正传，前17个字节的格式是这样的。</p>
<p>20 ?? ?? 00 02 00 00 00 01 53 00 00 00 53 00 00 00</p>
<p>只剩下第1-2字节未解决了。</p>
<h4 id="第1-2字节分析"><a href="#第1-2字节分析" class="headerlink" title="第1-2字节分析"></a>第1-2字节分析</h4><p>第1-2字节与v154有关。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605165305661.png" alt="image-20250605165305661" style="zoom:80%;" />

<p>而v154与a4有关。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605165352929.png" alt="image-20250605165352929" style="zoom:80%;" />

<p>查看函数0x81F00的引用，来到sub_6EFF0。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605165650062.png" alt="image-20250605165650062"></p>
<p>v5与a3相关。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605165701019.png" alt="image-20250605165701019"></p>
<p>函数sub_6EFF0有2个引用。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605165738153.png" alt="image-20250605165738153"></p>
<p>先不着急追踪引用，先在Unidbg中hook函数sub_6EFF0。</p>
<p>发现*a3 &#x3D; 0x4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605170228483.png" alt="image-20250605170228483"></p>
<p>搜索trace记录，判断函数sub_6EFF0来自于哪个函数调用。</p>
<p>跳转到0x9ef04。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605175855282.png" alt="image-20250605175855282"></p>
<p>v134是传入的a3。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605180034095.png" alt="image-20250605180034095"></p>
<p>在0x9ef04下断点，查看x2，因为v134是一个指针，所以用mx2查看里面的内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605183215314.png" alt="image-20250605183215314" style="zoom:80%;" />

<p>v134与v13有关，v13通过多个调用获得初始化。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605184132923.png" alt="image-20250605184132923"></p>
<p>我之前实现过：通过jmethodID获得函数名，因此可以识别这里调用了什么。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605205752942.png" alt="image-20250605205752942"></p>
<p>经过判断，调用了类的初始化函数okio.Buffer.&lt;init&gt;，还调用了writeString。</p>
<p>尝试分析，这里究竟写入了什么。这里我hook上了0x6E13C，0x6E13C封装了CallObjectMethodV，同时根据args[2]（jmethodID）筛选调用的函数，打印写入的字符串。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getStr</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libxyass.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x6E13C</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_">prettyMethod</span>(args[<span class="number">2</span>], <span class="number">0</span>) == (<span class="string">&quot;okio.Buffer.writeString&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">var</span> va1 = args[<span class="number">3</span>];</span><br><span class="line">                <span class="keyword">var</span> env = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[str]&quot;</span>, <span class="title function_">ptr</span>(env.<span class="title function_">getStringUtfChars</span>(va1)).<span class="title function_">readCString</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写了很多东西。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605210301978.png" alt="image-20250605210301978"></p>
<p>用Unidbg也可以实现类似的效果，写的时候打印一下即可。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605210419813.png" alt="image-20250605210419813"></p>
<p>然后下个断点，判断执行前后能否打印字符串。</p>
<p>成功打印字符串“&#x2F;api&#x2F;sns&#x2F;v4&#x2F;user&#x2F;login&#x2F;password”，但发现了点小问题。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605210639382.png" alt="image-20250605210639382"></p>
<p>观察我补的环境，发现这里传入了一个新的dvmObject，可能是因为这个原因。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605210713560.png" alt="image-20250605210713560" style="zoom:67%;" />

<p>改成这样子。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605210800510.png" alt="image-20250605210800510" style="zoom:67%;" />

<p>然后再跑一次，这回jobject的值一致了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605210955734.png" alt="image-20250605210955734" style="zoom:80%;" />

<p>最后v134应该指向栈上地址：0xe4fff640，但没找到v134被修改的地方。</p>
<p>只能说，只看伪代码果然不行，接下来看汇编了，前面的内容供读者图一乐，错误经验也是经验，主要是展示我个人的分析流程。</p>
<p>往栈地址0xe4fff640下一个写断点，发现是0x9eddc往0xe4fff640里写了0x4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605214533648.png" alt="image-20250605214533648"></p>
<p>在0x9eddc下一个断点，判断一下Q3、Q2哪个存放了0x4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605214730765.png" alt="image-20250605214730765"></p>
<p>q3存放0x4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605214912867.png" alt="image-20250605214912867"></p>
<p>而Q3 &#x3D; [X24 + 252]，往0x9EDC4下断点，查看X24+252和是多少，然后给X24+252下一个写断点。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605215043885.png" alt="image-20250605215043885"></p>
<p>x24 &#x3D; 0x123df000，因此在0x123df0fc下一个写断点。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605215318136.png" alt="image-20250605215318136"></p>
<p>下了断点后，发现是0x920AC的指令再往0x123df0fc里写0x4。</p>
<p>而w8的值由LDR w8,[x8]得来的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605215941273.png" alt="image-20250605215941273" style="zoom: 80%;" />

<p>而x8的值是0x123dc060。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605220036345.png" alt="image-20250605220036345"></p>
<p>再在0x123dc060下一个写断点，找是谁往0x123dc060里写入的0x4。</p>
<p>地址0x9aab8的指令往0x123dc060里写0x4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605220348565.png" alt="image-20250605220348565"></p>
<p>分析一波，如图所示。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605222117031.png" alt="image-20250605222117031"></p>
<p>可以下个断点在0x9AAA4，查看每次取的16字节来自于哪里。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605222306362.png" alt="image-20250605222306362" style="zoom:80%;" />

<p>Q1的16字节来自栈上基址（且x19指向的）0xe4fff200、Q0的16字节来自栈上基址（且x22指向的）0xe4fff148。</p>
<p>Q1和Q0只有低字节不一样，Q1是0x31，Q0是0x35。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606093410755.png" alt="image-20250606093410755" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606093422089.png" alt="image-20250606093422089" style="zoom:80%;" />

<p>先为0xe4fff200下一个写断点，判断这16个字节（31 01 32…17 66 39）是什么时候写入的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606093939190.png" alt="image-20250606093939190"></p>
<p>发现是0x92830的指令在往里面写，跳转过去看看。</p>
<p>Q0 &#x3D; [x8 + x10]，在0x92820下一个断点，查看x8与x10的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606094216659.png" alt="image-20250606094216659"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606094418843.png" alt="image-20250606094418843"></p>
<p>得出0x12019A30。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606094442596.png" alt="image-20250606094442596" style="zoom:80%;" />

<p>Unidbg的映射基地址是0x1200000，所以这里的偏移指向so文件的0x19A30。</p>
<p>发现这里是.rodata节的内容，也就是说，Q1的16字节，来自于文件中硬编码的16字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606094555033.png" alt="image-20250606094555033"></p>
<p>再追踪Q0的16字节从何而来，对0xe4fff148下一个写断点。</p>
<p>注意到，似乎对每个字节赋值的地址不同。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606100952982.png" alt="image-20250606100952982"></p>
<p>这里先追踪Q0最低字节，因为Q1和Q0只在这里有所不同。</p>
<p>来到0x9A064。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606101533687.png" alt="image-20250606101533687"></p>
<p>对这一块代码进行还原，发现有点复杂啊。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250604131821514.png" alt="image-20250604131821514"></p>
<p>借鉴了一下其它人的分析，Q0的16个字节来自于变种AES加密，因此这里先放一放，先去分析另外53个字节。</p>
<h3 id="0x53个字节"><a href="#0x53个字节" class="headerlink" title="0x53个字节"></a>0x53个字节</h3><p>前面提到，0x53个字节其实是分为4块，每块的字节数分别是0x18、0x7、0x24、0x10，</p>
<p>通过hook函数sub_4A278便可获得这4块内容。</p>
<p>下图是第3次调用sub_4A278的位置，可以在这边下一个断点，观察4个字符串未加密前是什么。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606110401435.png" alt="image-20250606110401435"></p>
<p>这是加密前的内容，位于0x1240c000。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606111137178.png" alt="image-20250606111137178"></p>
<p>在对第四次调用sub_4A278的位置下断点，这个时候里面的内容虽然也是0x53个字节，但已经加密了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606111756494.png" alt="image-20250606111756494" style="zoom:80%;" />

<p>加密点应该在第3次调用与第四次调用之间。</p>
<p>在0x123dc060下写断点，指令0x8235C处往里面写了0x35，0x8235C位于函数sub_81F00内。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606115920475.png" alt="image-20250606115920475"></p>
<p>跳转到0x8235C，看不出加密算法。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606120453309.png" alt="image-20250606120453309" style="zoom:67%;" />

<p>慢慢分析。</p>
<p>先对sub_81F00进行hook，打印入参。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606121200628.png" alt="image-20250606121200628" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606121138961.png" alt="image-20250606121138961"></p>
<p>（x0）a1 &#x3D; 1。（疑似固定值）</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606130046944.png" alt="image-20250606130046944" style="zoom:80%;" />

<p>（x1）a2是个字符数组，代表build，如下。</p>
<p>0xE表示sso存储，占用了7个字节。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606121335072.png" alt="image-20250606121335072" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606132842937.png" alt="image-20250606132842937" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606122006533.png" alt="image-20250606122006533"></p>
<p>（x2）a3来自于AppId。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606130146772.png" alt="image-20250606130146772" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606130210235.png" alt="image-20250606130210235" style="zoom:67%;" />

<p>（x3）a4为0x4；——之前q1、q2异或的0x4。</p>
<p>（x4）a5是个string类型；</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606121826620.png" alt="image-20250606121826620"></p>
<p>存放了device_id。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606121842021.png" alt="image-20250606121842021"></p>
<p>（x5）a6&#x3D;0xe4fff521，似乎存放了16个字节。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606130901638.png" alt="image-20250606130901638" style="zoom:67%;" />

<p>（x6）a7 &#x3D; 0x10，似乎代表a6的大小。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606130328066.png" alt="image-20250606130328066"></p>
<p>（x7）a8&#x3D;0x38663439662d3038，存放了8个字符“80-f94f8”。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606131755330.png" alt="image-20250606131755330"></p>
<p>似乎是device_id的一部分。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606132002394.png" alt="image-20250606132002394" style="zoom:80%;" />

<p>改一下变量名。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606132559512.png" alt="image-20250606132559512" style="zoom:80%;" />

<p>结合入参进行改名。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606134204767.png" alt="image-20250606134204767" style="zoom:80%;" />

<p>插入一个结构体，方便分析。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606134959994.png" alt="image-20250606134959994" style="zoom:80%;" />

<p>接着往下分析。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606135258040.png" alt="image-20250606135258040"></p>
<p>点进xmmword_19AA0，0x21说明了是长字符串存储，缓冲区大小是0x20个字节，已经占用了0x18个字节。（v157的前16个字节来自于xmmword_19AA0，缓冲区的地址并不是通过v157&#x3D;xmmword_19AA0得到的）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606135337277.png" alt="image-20250606135337277"></p>
<p>v157指向红色框中的这18个字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606111137178.png" alt="image-20250606111137178"></p>
<p>接着往下分析。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606143311760.png" alt="image-20250606143311760"></p>
<p>观察变量“ptr_18bytes_AND_build_id_AND_device_id_b”的值，它的值其实在之前就清空了，这里应该是复用了，因为不知道它在加密部分是什么含义，暂时没改变量名。</p>
<p>hook上0x821B0的位置，访问x9所指向的内存地址，查看内容有什么变化。（根据计算，有32次循环，记作0-31）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606144449746.png" alt="image-20250606144449746"></p>
<p>第0次循环。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606144721289.png" alt="image-20250606144721289"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606144805944.png" alt="image-20250606144805944" style="zoom:80%;" />

<p>在执行了几次循环后，如下图所示。</p>
<p>从第8个字节开始，0x0、0x1…依次递增，一次循环可以初始化8个4字节，而执行32次，也就是说，从0一直到(32*8 - 1)，也就是0x0到0xff。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606145022167.png" alt="image-20250606145022167"></p>
<p>而！RC4流密码中，在初始化状态向量时，SBox就是这么得来的，SBox的初始化的伪代码如下。</p>
<p>一般的RC4中，SBox是字节数组，而这里是4字节为单位的数组。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">    S[i] = i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果猜想是对的话，待会应该还有一段用密钥对S盒进行置换的过程，暂时先将“ptr_18bytes_AND_build_id_AND_device_id_b”重命名为“SBox”。</p>
<p>继续往下分析。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606151139575.png" alt="image-20250606151139575"></p>
<p>待会再去hook获得密钥，先来看看这个S盒置换算法。</p>
<p>下面这段代码基本可以说明，就是RC4算法，而且密钥长度为13——0到12。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606154725222.png" alt="image-20250606154725222"></p>
<p>循环64次，说明每次循环交换4次。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606154738763.png" alt="image-20250606154738763" style="zoom:80%;" />

<p>hook一下，得到密钥看看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606155337349.png" alt="image-20250606155337349"></p>
<p>x8&#x3D;0x1201b48d，说明密钥在文件偏移0x1b48d的位置。</p>
<p>试图用字符串“std::abort();”作掩护，hhhh。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606155703863.png" alt="image-20250606155703863" style="zoom:80%;" />

<p>拿去试一下，发现是个非常标准的rc4加密。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606163952156.png" alt="image-20250606163952156"></p>
<p>至此，0x53个字节分析完了。</p>
<h3 id="0x10个字节（Ⅱ）"><a href="#0x10个字节（Ⅱ）" class="headerlink" title="0x10个字节（Ⅱ）"></a>0x10个字节（Ⅱ）</h3><p>还记得，在**16个字节（Ⅰ）**中，我们分析得出，16个字节的格式如下：</p>
<p>20 ?? ?? 00 02 00 00 00 01 53 00 00 00 53 00 00 00</p>
<p>当时最大的问题是：?? ??的值由Q1与Q0异或得来，Q1是硬编码在文件中的，而Q0的值，当时只追踪了最低字节。</p>
<p>当时为了得出Q0的最低字节从何而来，我逆了一下算法，但涉及到的缓冲区有点多。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250604131821514.png" alt="image-20250604131821514"></p>
<p>所以在这一小节，我们的目标之一是<strong>还原Q0</strong>，还有一个目标是分析<strong>绿色框里的16个字节</strong>从何而来。</p>
<p>（我好像没解释过红色框，红色框的前4个字节是函数sub_81F00传入的a1，是固定值；再4个字节是app_id，0x2是根据传Q1与Q0异或的0x4判断得到的；0x7代表build的大小，0x24代表device_id的大小，0x10代表未知的16个字节）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606111137178.png" alt="image-20250606111137178"></p>
<h4 id="HMAC-MD5"><a href="#HMAC-MD5" class="headerlink" title="HMAC-MD5"></a>HMAC-MD5</h4><p>这16个字节是函数sub_81F00的入参a6，对应的缓冲区地址是0xe4fff521。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606130901638.png" alt="image-20250606130901638" style="zoom:67%;" />

<p>在0xe4fff521下一个写断点。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606175216983.png" alt="image-20250606175216983"></p>
<p>地址0x6f768处的指令对0xe4fff521进行了写。</p>
<p>0xe4fff521的值由Q0得到，Q0的值由[X29,#-0x18]得到，所以在0x6F758下断点（或者看日志）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606175711711.png" alt="image-20250606175711711"></p>
<p>x29&#x3D;0xe4fff470，所以X29 - 0x18是0xE4FFF458。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606175911851.png" alt="image-20250606175911851"></p>
<p>在0xE4FFF458下写断点，发现是0x92fd8。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606180338505.png" alt="image-20250606180338505"></p>
<p>地址0x92fd8位于函数sub_92F2C范围内。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606181133194.png" alt="image-20250606181133194" style="zoom:80%;" />

<p>我们需要的16字节存储在a2中，a2由v2赋值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606181450989.png" alt="image-20250606181450989"></p>
<p>w8是上图的a2，a2的值地址0x92FCC获得，所以在0x92FCC下一个断点，查看X20的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606182624432.png" alt="image-20250606182624432"></p>
<p>x20的值是0x123df480。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606182803621.png" alt="image-20250606182803621"></p>
<p>在x20下写断点。</p>
<p>可以看到，偏移0x93f74对0x123df480进行了写操作。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606183329672.png" alt="image-20250606183329672"></p>
<p>来到0x93f74。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607095231225.png" alt="image-20250607095231225"></p>
<p>对应于汇编的伪代码。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607095624055.png" alt="image-20250607095624055"></p>
<p>现在0x93F74下个断点，发现这个函数执行了很多次，迟迟等不到我们要看的内容，于是统计一下这个函数执行的次数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607100823567.png" alt="image-20250607100823567"></p>
<p>同时，分析算法，发现一个很有意思的点。</p>
<p>假设HIDWORD(v4) &#x3D; R，那么LODWORD(v4)也等于R，也就是说64位的高32位和低32位是一样的，都为R。</p>
<p>而v4 &gt;&gt; 17可以写成(R &lt;&lt; 32 | R) &gt;&gt; 17，进一步可以写成((R &lt;&lt; 32) &gt;&gt; 17) | R &gt;&gt; 17。</p>
<p>(R &lt;&lt; 32) &gt;&gt; 17的结果是 R 左移（32 - 17 &#x3D; 15）位，并占据了结果的高位部分。</p>
<p>R &gt;&gt; 17的结果是 R 右移17位，占据了结果的低位部分。</p>
<p>v5是一个32位的数据类型，所以当上述的两者通过或组合在一块，就相当于将R循环右移了17位。</p>
<p>而循环右移17位，等同于循环左移15位。</p>
<p>（注意这里的&lt;&lt;都是逻辑左移和逻辑右移，而不是循环左移和循环右移）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607105851010.png" alt="image-20250607105851010"></p>
<p>md5算法有4轮运算：F、G、H、I，每一轮运算要执行16次（因为有16个子分组），在I运算中，涉及循环左移6、10、15、21位；除此之外，I运算涉及异或、取反、或等操作。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607111129485.png" alt="image-20250607111129485" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607111219863.png" alt="image-20250607111219863" style="zoom:80%;" />

<p>而在sub_93F14中，发现了循环左移15位，还有循环左移21位，同时发现了一些异或、取反的操作，又考虑到这个函数执行了16次，这大概率是md5算法的II运算。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607111353373.png" alt="image-20250607111353373"></p>
<p>还发现了md5的魔数，按常理来说，II运算是第4轮运算，魔数ABCD早被修改了，但编译器似乎没对寄存器x0进行操作，魔数一直存在x0中。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607113630363.png" alt="image-20250607113630363" style="zoom: 67%;" />

<p>更加坐实了这是一个魔改的md5算法。——为什么说是魔改，之后会说。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607113813785.png" alt="image-20250607113813785" style="zoom:80%;" />

<p>分析trace日志中，0x93F74出现的地方，对应上调用了16次函数sub_93F14。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607124335780.png" alt="image-20250607124335780" style="zoom:80%;" />

<p>在第16次的时候，w28出现了未知16字节中的4个字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607124755707.png" alt="image-20250607124755707"></p>
<p>在第16次调用的trace记录，w27是魔数，w28的值来自于[0xe4fff2c0 - 0x34]，即[0xE4FFF28C]。</p>
<p>要同时追踪w27和w28吗？其实不用。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608132421218.png" alt="image-20250608132421218"></p>
<p>下图是第1次调用的trace记录，w27是一个魔数，所以只追踪w28。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607140241493.png" alt="image-20250607140241493"></p>
<p>第三轮运算最终的a、b、c、d的第四轮运算的初始a、b、c、d。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608140802816.png" alt="image-20250608140802816" style="zoom:67%;" />

<p>在0xe4fff1f0-0x34处下一个写断点，观察里面的值来自于哪，大概率是md5的HH轮运算传过来的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608142243297.png" alt="image-20250608142243297"></p>
<p>偏移0x94534位于函数sub_944A8内，符合md5的特征，看样子还是II运算。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608142607568.png" alt="image-20250608142607568" style="zoom:80%;" />

<p>结合上图和下图，有点像是MD5的第60、61、62、63、64轮运算。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608142854656.png" alt="image-20250608142854656" style="zoom:80%;" />

<p>结合标准的md5算法，md5的63、64轮明显被魔改了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608152840554.png" alt="image-20250608152840554"></p>
<p>有一个疑惑，既然这里是md5的第63、64轮加密，为什么函数sub_93F14调用了16次？我原本以为，这里魔改的II运算，结果似乎只涉及63、64轮加密，前面的分析有些误打误撞，不过确认了，使用的加密算法是md5，涉及一些变异。</p>
<p>回到函数sub_92F2C，对函数进行hook，判断v2是从什么变成16个字节。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608155657798.png" alt="image-20250608155657798" style="zoom: 67%;" />

<p>发现要加密的内容是16个字节。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608165240684.png" alt="image-20250608165240684" style="zoom:80%;" />

<p>对函数sub_92F2C进行分析，静态分析下，可能会调用了2次sub_93390，第1次调用是为了处理空间不足的情况，因为md5的每个分组是512位，要留出最后64位记录信息长度，所以实际能用来存储的空间只有56字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608165909885.png" alt="image-20250608165909885"></p>
<p>创建结构体，对变量进行修改。</p>
<p>0x80是填充值，数据长度要小于等于55，因为至少有1个字节是填充值。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608165050501.png" alt="image-20250608165050501" style="zoom: 67%;" />

<p>接下来，分析函数sub_93390，它大概率是在进行md5加密，根据统计，一共执行了5次sub_93390。——这也无法解释为什么调用了sub_93F14共计16次，再放一会吧。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608170636507.png" alt="image-20250608170636507"></p>
<p>而我hook函数sub_92F2C，这个函数执行了2次，而且每一次数据的量都没有超过55字节，说明还有其它3处地方调用了sub_93390，进行md5加密。</p>
<p>搜索trace记录，从第1次调用开始看起。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608171823863.png" alt="image-20250608171823863"></p>
<p>第一次调用来自于0x92eec。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608183325917.png" alt="image-20250608183325917"></p>
<p>这里的sub_93390没有看到参数列表。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608183652512.png" alt="image-20250608183652512" style="zoom:67%;" />

<p>根据汇编，大概有3个参数，因此可以修改函数签名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608183908545.png" alt="image-20250608183908545"></p>
<p>而且这里的v3，一看就是之前分析的那个结构，修改变量类型。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608184300820.png" alt="image-20250608184300820" style="zoom:80%;" />

<p>hook函数sub_93390，看看返回值和入参。——返回值可以通过入参a1的前16字节获得。</p>
<p>根据大量的0x36，可以判断这是一个hmac-md5算法。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608201229798.png" alt="image-20250608201229798" style="zoom:80%;" />

<p>整理一下，5次调用sub_93390的入参、返回值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">// 第1次调用</span><br><span class="line">// x0</span><br><span class="line">0000: 76 54 32 10 FE DC BA 98 89 AB CD EF 01 23 45 67    vT2..........#Eg</span><br><span class="line">// x1（key与0x36的结果）</span><br><span class="line">0000: 6A 3E 23 D6 BC E6 B7 B9 C6 D2 4B D7 6C 78 02 D9    j&gt;#.......K.lx..</span><br><span class="line">0010: 72 84 55 82 03 93 5F 6E 20 B3 32 87 75 82 F9 8D    r.U..._n .2.u...</span><br><span class="line">0020: 38 43 90 71 D4 5C B9 1A 8D 63 39 3D F7 94 59 C7    8C.q.\...c9=..Y.</span><br><span class="line">0030: 7C 27 5A FD 1D 68 77 A5 BE 4D 91 14 E5 8D 0E 51    |&#x27;Z..hw..M.....Q</span><br><span class="line">// x2</span><br><span class="line">0x1</span><br><span class="line">// 返回值</span><br><span class="line">0000: 39 0A 80 0F EC FE 50 43 EE 54 1F 5B 06 9C 47 8B    9.....PC.T.[..G.</span><br><span class="line"></span><br><span class="line">// 第2次调用</span><br><span class="line">// x0</span><br><span class="line">0000: 76 54 32 10 FE DC BA 98 89 AB CD EF 01 23 45 67    vT2..........#Eg</span><br><span class="line">// x1（key与0x5C的结果）</span><br><span class="line">0000: 00 54 49 BC D6 8C DD D3 AC B8 21 BD 06 12 68 B3    .TI.......!...h.</span><br><span class="line">0010: 18 EE 3F E8 69 F9 35 04 4A D9 58 ED 1F E8 93 E7    ..?.i.5.J.X.....</span><br><span class="line">0020: 52 29 FA 1B BE 36 D3 70 E7 09 53 57 9D FE 33 AD    R)...6.p..SW..3.</span><br><span class="line">0030: 16 4D 30 97 77 02 1D CF D4 27 FB 7E 8F E7 64 3B    .M0.w....&#x27;.~..d;</span><br><span class="line">// x2</span><br><span class="line">0x1</span><br><span class="line">// 返回值</span><br><span class="line">0000: 29 9A 8E 4B 77 48 EA 98 E3 E3 DF 8C C7 D2 4B 4A    )..KwH........KJ</span><br><span class="line"></span><br><span class="line">// 第3次调用</span><br><span class="line">// x0</span><br><span class="line">0000: 39 0A 80 0F EC FE 50 43 EE 54 1F 5B 06 9C 47 8B    9.....PC.T.[..G.</span><br><span class="line">// x1</span><br><span class="line">0000: 2F 61 70 69 2F 73 6E 73 2F 76 34 2F 75 73 65 72    /api/sns/v4/user</span><br><span class="line">0010: 2F 6C 6F 67 69 6E 2F 70 61 73 73 77 6F 72 64 66    /login/passwordf</span><br><span class="line">0020: 69 64 3D 31 37 34 34 32 39 38 31 30 38 31 30 31    id=1744298108101</span><br><span class="line">0030: 33 64 32 30 63 39 31 35 38 61 30 61 39 62 32 39    3d20c9158a0a9b29</span><br><span class="line">0040: 61 62 62 63 62 62 31 65 64 37 32 36 66 35 62 26    abbcbb1ed726f5b&amp;</span><br><span class="line">0050: 67 69 64 3D 37 63 30 64 36 38 65 38 36 34 37 61    gid=7c0d68e8647a</span><br><span class="line">0060: 35 34 33 38 61 32 33 39 34 62 62 61 64 33 36 34    5438a2394bbad364</span><br><span class="line">0070: 63 32 62 64 66 33 31 62 39 38 37 39 34 37 33 35    c2bdf31b98794735</span><br><span class="line">0080: 39 34 34 30 37 37 62 62 66 63 35 35 26 64 65 76    944077bbfc55&amp;dev</span><br><span class="line">0090: 69 63 65 5F 6D 6F 64 65 6C 3D 70 68 6F 6E 65 26    ice_model=phone&amp;</span><br><span class="line">00A0: 74 7A 3D 41 73 69 61 25 32 46 53 68 61 6E 67 68    tz=Asia%2FShangh</span><br><span class="line">00B0: 61 69 26 63 68 61 6E 6E 65 6C 3D 56 69 76 6F 26    ai&amp;channel=Vivo&amp;</span><br><span class="line">00C0: 76 65 72 73 69 6F 6E 4E 61 6D 65 3D 38 2E 37 37    versionName=8.77</span><br><span class="line">00D0: 2E 30 26 64 65 76 69 63 65 49 64 3D 31 30 66 39    .0&amp;deviceId=10f9</span><br><span class="line">00E0: 31 66 36 38 2D 37 64 62 37 2D 33 61 33 36 2D 38    1f68-7db7-3a36-8</span><br><span class="line">00F0: 30 63 39 2D 37 30 33 61 62 61 64 38 66 65 65 32    0c9-703abad8fee2</span><br><span class="line">0100: 26 70 6C 61 74 66 6F 72 6D 3D 61 6E 64 72 6F 69    &amp;platform=androi</span><br><span class="line">0110: 64 26 73 69 64 3D 73 65 73 73 69 6F 6E 2E 31 37    d&amp;sid=session.17</span><br><span class="line">0120: 34 34 33 30 30 36 32 36 36 35 35 37 30 31 36 32    4430062665570162</span><br><span class="line">0130: 39 31 35 30 26 69 64 65 6E 74 69 66 69 65 72 5F    9150&amp;identifier_</span><br><span class="line">0140: 66 6C 61 67 3D 34 26 70 72 6F 6A 65 63 74 5F 69    flag=4&amp;project_i</span><br><span class="line">0150: 64 3D 45 43 46 41 41 46 26 78 5F 74 72 61 63 65    d=ECFAAF&amp;x_trace</span><br><span class="line">0160: 5F 70 61 67 65 5F 63 75 72 72 65 6E 74 3D 6C 6F    _page_current=lo</span><br><span class="line">0170: 67 69 6E 5F 66 75 6C 6C 5F 73 63 72 65 65 6E 5F    gin_full_screen_</span><br><span class="line">0180: 70 77 64 5F 70 61 67 65 26 6C 61 6E 67 3D 7A 68    pwd_page&amp;lang=zh</span><br><span class="line">0190: 2D 48 61 6E 73 26 61 70 70 5F 69 64 3D 45 43 46    -Hans&amp;app_id=ECF</span><br><span class="line">01A0: 41 41 46 30 31 26 75 69 73 3D 6C 69 67 68 74 26    AAF01&amp;uis=light&amp;</span><br><span class="line">01B0: 74 65 65 6E 61 67 65 72 3D 30 26 61 63 74 69 76    teenager=0&amp;activ</span><br><span class="line">01C0: 65 5F 63 74 72 79 3D 43 4E 26 63 70 75 5F 6E 61    e_ctry=CN&amp;cpu_na</span><br><span class="line">01D0: 6D 65 3D 51 75 61 6C 63 6F 6D 6D 2B 54 65 63 68    me=Qualcomm+Tech</span><br><span class="line">01E0: 6E 6F 6C 6F 67 69 65 73 25 32 43 2B 49 6E 63 2B    nologies%2C+Inc+</span><br><span class="line">01F0: 53 4D 38 31 35 30 26 64 6C 61 6E 67 3D 7A 68 26    SM8150&amp;dlang=zh&amp;</span><br><span class="line">0200: 6C 61 75 6E 63 68 5F 69 64 3D 31 37 34 34 34 33    launch_id=174443</span><br><span class="line">0210: 36 33 39 32 26 6F 76 65 72 73 65 61 73 5F 63 68    6392&amp;overseas_ch</span><br><span class="line">0220: 61 6E 6E 65 6C 3D 30 26 6D 6C 61 6E 67 75 61 67    annel=0&amp;mlanguag</span><br><span class="line">0230: 65 3D 7A 68 5F 63 6E 26 66 6F 6C 64 65 72 5F 74    e=zh_cn&amp;folder_t</span><br><span class="line">0240: 79 70 65 3D 6E 6F 6E 65 26 61 75 74 6F 5F 74 72    ype=none&amp;auto_tr</span><br><span class="line">0250: 61 6E 73 3D 30 26 74 3D 31 37 34 34 34 33 36 33    ans=0&amp;t=17444363</span><br><span class="line">0260: 38 35 26 62 75 69 6C 64 3D 38 37 37 30 32 39 39    85&amp;build=8770299</span><br><span class="line">0270: 26 68 6F 6C 64 65 72 5F 63 74 72 79 3D 43 4E 26    &amp;holder_ctry=CN&amp;</span><br><span class="line">0280: 64 69 64 3D 32 64 33 35 31 62 62 65 66 31 64 62    did=2d351bbef1db</span><br><span class="line">0290: 38 33 38 63 35 66 63 64 36 62 36 37 61 34 61 61    838c5fcd6b67a4aa</span><br><span class="line">02A0: 31 64 62 35 38 38 70 6C 61 74 66 6F 72 6D 3D 61    1db588platform=a</span><br><span class="line">02B0: 6E 64 72 6F 69 64 26 62 75 69 6C 64 3D 38 37 37    ndroid&amp;build=877</span><br><span class="line">02C0: 30 32 39 39 26 64 65 76 69 63 65 49 64 3D 35 31    0299&amp;deviceId=51</span><br><span class="line">02D0: 38 64 66 65 39 36 2D 37 66 36 66 2D 33 37 30 61    8dfe96-7f6f-370a</span><br><span class="line">02E0: 2D 38 65 38 30 2D 66 39 34 66 38 38 33 38 65 36    -8e80-f94f8838e6</span><br><span class="line">02F0: 64 65 66 73 3D 30 26 70 6F 69 6E 74 3D 31 39 33    defs=0&amp;point=193</span><br><span class="line">0300: 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    2...............</span><br><span class="line">// x2</span><br><span class="line">0xc</span><br><span class="line">// 返回值</span><br><span class="line">0000: 81 97 7E 83 36 B7 43 2D 01 34 A6 A4 34 6C 32 06    ..~.6.C-.4..4l2.</span><br><span class="line"></span><br><span class="line">// 第4次调用</span><br><span class="line">// x0</span><br><span class="line">0000: 81 97 7E 83 36 B7 43 2D 01 34 A6 A4 34 6C 32 06    ..~.6.C-.4..4l2.</span><br><span class="line">// x1</span><br><span class="line">0000: 32 80 00 00 00 00 00 00 00 00 00 00 00 00 00 00    2...............</span><br><span class="line">0010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">0020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">0030: 00 00 00 00 00 00 00 00 08 1A 00 00 00 00 00 00    ................</span><br><span class="line">// x2</span><br><span class="line">0x1</span><br><span class="line">// 返回值</span><br><span class="line">0000: 8D 67 06 8C 91 18 85 7B FB 78 DB 01 59 F2 09 69    .g.....&#123;.x..Y..i</span><br><span class="line"></span><br><span class="line">// 第5次调用</span><br><span class="line">// x0</span><br><span class="line">0000: 29 9A 8E 4B 77 48 EA 98 E3 E3 DF 8C C7 D2 4B 4A    )..KwH........KJ</span><br><span class="line">// x1</span><br><span class="line">0000: 8D 67 06 8C 91 18 85 7B FB 78 DB 01 59 F2 09 69    .g.....&#123;.x..Y..i</span><br><span class="line">0010: 80 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">0020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">0030: 00 00 00 00 00 00 00 00 80 02 00 00 00 00 00 00    ................</span><br><span class="line">// x2</span><br><span class="line">0x1</span><br><span class="line">// 返回值</span><br><span class="line">0000: 72 4B A0 52 97 97 13 0E 0B C3 00 2F BF C2 C7 5F    rK.R......./..._</span><br></pre></td></tr></table></figure>

<p>注意到，第5次调用sub_93390的返回值正是我们需要的16字节。</p>
<p>同时发现：</p>
<ol>
<li>第1次调用的返回值，是第3次加密的魔数值——0x36与key异或作为输入，魔数是标准md5魔数；</li>
<li>第2次调用的返回值，是第5次加密的魔数值——0x5C与key异或作为输入，魔数是标准md5魔数；</li>
<li>第3次调用的返回值，是第4次加密的魔数值——明文url + xy-common-params + xy-direction + platform + build + deviceId + xy-scene作为输入，魔数是第1次调用的返回值；</li>
<li>第4次调用的返回值，是第5次加密的输入——第4次调用的输入是第3次加密中，末尾不足64字节的部分；如果第3次调用刚好满足每组都是64字节，第4次调用的输入将是0x80开头，然后在最后的8个字节中，会描述前面的所有块的大小。</li>
<li>第5次加密就是将第4次的16字节进行了填充得到最终的16字节。</li>
</ol>
<p>单独看每次调用，其实每次调用都是魔改MD5算法，而将5次魔改MD5的调用合在一起，就是一个HMAC-MD5调用，整个流程应该这样子理解：</p>
<p>第1次调用魔改MD5，是对**（密钥 ^ 0x36）<strong>的结果进行的魔改MD5运算，这一次调用的目的是获得用作第3次调用的魔数（16字节），这16字节并非是用来作为</strong>K’**，再次说明：密钥是64字节，不需要经过MD5运算获得16字节，再填充至64字节，这里进行MD5仅仅是为了获得第3次调用的魔数，因为第3次调用是第1次调用的延续。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608213042711.png" alt="image-20250608213042711"></p>
<p>暂时不管第2次调用。</p>
<p>第3次调用魔改MD5，是对明文进行计算MD5的值，明文长度为0x301字节，魔数是第1次调用的结果（16字节）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608213356686.png" alt="image-20250608213356686"></p>
<p>按照HMAC-MD5计算方式，K’是密钥，ipad是64个字节的0x36，两者异或后还是64字节，然后拼接上明文，再进行魔改的MD5运算，这时候，输入MD5运算的长度是0x301+0x40，即0x341字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608213042711.png" alt="image-20250608213042711"></p>
<p>而MD5运算，一次处理64字节，如果最后一组不满64字节，则填充448位，最后8字节用来表示这一次输入MD5运算的位数是多少。0x341个字节，即输入了0x1A08位数据。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608214219574.png" alt="image-20250608214219574" style="zoom:80%;" />

<p>第4次调用，单独处理1个字节，因为0x341个字节，可以分为13个64字节分组和单独1个字节，第4次调用就是处理这个字节的，注意下图，0x32后填充了一个0x80（即后面填充一个1和“无数”个0），而最后8字节是0x1A08，代表着处理的位数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608214446344.png" alt="image-20250608214446344" style="zoom:67%;" />

<p>将第1、3、4次调用放在一块看，最后获得了<strong>HMAC-MD5</strong>这一步的结果。↓</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608213042711.png" alt="image-20250608213042711"></p>
<p>第2次调用是获得（K’ ^ 0x5C）的MD5运算后的结果（16字节），用来作为第5次调用的魔数（因为在附加连接的时候，是K’在前面，说白了，魔数代表着前面几次MD5运算的结果）。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608214939057.png" alt="image-20250608214939057" style="zoom:80%;" />

<p>第5次调用，是计算H(K’ ^ 0x5C || H(K’ ^ 0x36 || 明文)) ，输入是（K’ ^ 0x5C）|| （第1、3、4次调用的结果），已知（K’ ^ 0x5C）是64字节，而（第1、3、4次调用的结果）肯定是16字节，所以一共是80字节。</p>
<p>下图中0x80是填充，最后8字节是0x280，即80字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608215911675.png" alt="image-20250608215911675"></p>
<p>到这里，也能理解之前为什么调用了16次sub_93F14。因为第1-5次调用sub_93390，分别执行了1、1、12、1、1次魔改MD5运算。</p>
<p>之所以说这是魔改MD5，是因为在个别轮次的运算，不是标准MD5的FF、GG、HH、II。</p>
<p>点开sub_93390。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609103836334.png" alt="image-20250609103836334" style="zoom:80%;" />

<p>根据日志，对sub_93390调用链进行分析，MD5一共64轮运算，将每轮运算依次与标准MD5进行对比。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609112747484.png" alt="image-20250609112747484" style="zoom: 50%;" />

<p>在日志中，追踪BR跳转，sub_94970是第1个较为“完整”的函数。（这里的完整指的是：有些函数的伪代码在IDA的分析下，显示为直接BR跳转；而这个函数会先执行一些操作再跳转）</p>
<p>根据动调，发现前4行代码加载了魔数，第5行代码加载了待加密数据的地址，具体内容写在注释上了…函数sub_94970似乎在为MD5的第一轮运算做准备。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609135943423.png" alt="image-20250609135943423"></p>
<p>接下来，来到函数sub_95080，这应该是md5的<strong>第一轮加密</strong>。循环左移7位变成了6位。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609144742615.png" alt="image-20250609144742615"></p>
<p>hook了一下v7+132的位置应该是T盒，但并不是标准的T盒。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609150053963.png" alt="image-20250609150053963"></p>
<p>函数sub_95654，为明文的第2、3个字做准备。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609152424760.png" alt="image-20250609152424760"></p>
<p>函数sub_93DD8中，MD5<strong>第二轮加密</strong>。循环左移12位变成了循环左移13位。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609154735081.png" alt="image-20250609154735081"></p>
<p>具体的不在这里一一分析，做个总结。</p>
<h5 id="魔改左移操作数"><a href="#魔改左移操作数" class="headerlink" title="魔改左移操作数"></a>魔改左移操作数</h5><p>第43轮的左移操作数被改，在地址<code>0x93AC8</code>处，<strong>原操作数为 16，被改为 11</strong></p>
<p>第42轮的左移操作数被改，在地址<code>0x93A90</code>处，<strong>原操作数为11 ，被改为 16</strong></p>
<p>第41轮的左移操作数被改，在地址<code>0x93A78</code>处，<strong>原操作数为 4，被改为 23</strong></p>
<p>第40轮的左移操作数被改，在地址<code>0x94368</code>处，<strong>原操作数为 23，被改为 4</strong></p>
<p>第14轮的左移操作数被改，在地址<code>0x9480C</code>处，<strong>原操作数为 12，被改为 13</strong></p>
<p>第11轮的左移操作数被改，在地址<code>0x94E00</code>处，<strong>原操作数为 17，被改为 16</strong></p>
<p>第8轮的左移操作数被改，在地址<code>0x93888</code>处，<strong>原操作数为 22，被改为 20</strong></p>
<p>第4轮的左移操作数被改，在地址<code>0x952E4</code>处，<strong>原操作数为 22，被改为 21</strong></p>
<p>第2轮的左移操作数被改，在地址<code>0x93E28</code>处，<strong>原操作数为 12，被改为 13</strong></p>
<p>第1轮的左移操作数被改，在地址<code>0x950F0</code>处，所属函数<code>sub_95080</code>，<strong>原操作数为 7 ，被改为 6</strong></p>
<h5 id="魔改T值"><a href="#魔改T值" class="headerlink" title="魔改T值"></a>魔改T值</h5><p>标准MD5的T值是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> t[] = &#123;</span><br><span class="line">      <span class="number">0xd76aa478</span>, <span class="number">0xe8c7b756</span>, <span class="number">0x242070db</span>, <span class="number">0xc1bdceee</span>, <span class="number">0xf57c0faf</span>, <span class="number">0x4787c62a</span>, <span class="number">0xa8304613</span>, <span class="number">0xfd469501</span>,</span><br><span class="line">      <span class="number">0x698098d8</span>, <span class="number">0x8b44f7af</span>, <span class="number">0xffff5bb1</span>, <span class="number">0x895cd7be</span>, <span class="number">0x6b901122</span>, <span class="number">0xfd987193</span>, <span class="number">0xa679438e</span>, <span class="number">0x49b40821</span>,</span><br><span class="line">      <span class="number">0xf61e2562</span>, <span class="number">0xc040b340</span>, <span class="number">0x265e5a51</span>, <span class="number">0xe9b6c7aa</span>, <span class="number">0xd62f105d</span>, <span class="number">0x02441453</span>, <span class="number">0xd8a1e681</span>, <span class="number">0xe7d3fbc8</span>,</span><br><span class="line">      <span class="number">0x21e1cde6</span>, <span class="number">0xc33707d6</span>, <span class="number">0xf4d50d87</span>, <span class="number">0x455a14ed</span>, <span class="number">0xa9e3e905</span>, <span class="number">0xfcefa3f8</span>, <span class="number">0x676f02d9</span>, <span class="number">0x8d2a4c8a</span>,</span><br><span class="line">      <span class="number">0xfffa3942</span>, <span class="number">0x8771f681</span>, <span class="number">0x6d9d6122</span>, <span class="number">0xfde5380c</span>, <span class="number">0xa4beea44</span>, <span class="number">0x4bdecfa9</span>, <span class="number">0xf6bb4b60</span>, <span class="number">0xbebfbc70</span>,</span><br><span class="line">      <span class="number">0x289b7ec6</span>, <span class="number">0xeaa127fa</span>, <span class="number">0xd4ef3085</span>, <span class="number">0x04881d05</span>, <span class="number">0xd9d4d039</span>, <span class="number">0xe6db99e5</span>, <span class="number">0x1fa27cf8</span>, <span class="number">0xc4ac5665</span>,</span><br><span class="line">      <span class="number">0xf4292244</span>, <span class="number">0x432aff97</span>, <span class="number">0xab9423a7</span>, <span class="number">0xfc93a039</span>, <span class="number">0x655b59c3</span>, <span class="number">0x8f0ccc92</span>, <span class="number">0xffeff47d</span>, <span class="number">0x85845dd1</span>,</span><br><span class="line">      <span class="number">0x6fa87e4f</span>, <span class="number">0xfe2ce6e0</span>, <span class="number">0xa3014314</span>, <span class="number">0x4e0811a1</span>, <span class="number">0xf7537e82</span>, <span class="number">0xbd3af235</span>, <span class="number">0x2ad7d2bb</span>, <span class="number">0xeb86d391</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>而魔改的T值是：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="type">56 B7 C9 E9 79 A4 1B D7 DB 81 10 24 D9 88 10 68    V</span>...y......$...h</span><br><span class="line"><span class="number">0010</span>: <span class="type">AF F7 14 9B B1 5B 1F FF BE D7 1C 88 22 61 66 66    </span>.....[......<span class="string">&quot;aff</span></span><br><span class="line"><span class="string">0020: 93 61 66 F6 9E 63 19 A6 21 09 14 49 EE CE 1D C1    .af..c..!..I....</span></span><br><span class="line"><span class="string">0030: AF 0F 1C F5 2A C6 17 47 13 46 10 A9 01 95 16 FD    ....*..G.F......</span></span><br><span class="line"><span class="string">0040: 00 25 00 F6 53 14 74 02 91 E6 21 D2 C9 11 00 E2    .%..S.t...!.....</span></span><br><span class="line"><span class="string">0050: E6 CD 61 22 97 0D D5 F2 ED 14 5A 42 05 E9 77 A2    ..a&quot;</span>......ZB..w.</span><br><span class="line"><span class="number">0060</span>: <span class="type">F9 A3 77 F2 D9 12 6F 62 9A 4C 2A 92 48 F2 39 12    </span>..w...ob.L*.H<span class="number">.9</span>.</span><br><span class="line"><span class="number">0070</span>: <span class="type">00 00 00 00 40 B3 40 C0 51 5A 5E 26 00 00 10 E9    </span>....<span class="meta">@.@.QZ^&amp;....</span></span><br><span class="line"><span class="number">0080</span>: <span class="type">5D 10 3F D6 D6 07 57 C3 42 39 FC FF 91 D6 7C 97    </span>].?...W.B9....|.</span><br><span class="line"><span class="number">0090</span>: <span class="type">44 EA BC A4 A9 CF DC 4B 70 BC BC BE C6 7E 8C 28    D</span>......Kp....~.(</span><br><span class="line"><span class="number">00</span>A0: <span class="type">60 4B CC F6 95 10 EC D4 FA 27 AC EA E5 88 DC E6    </span>`K.......<span class="string">&#x27;......</span></span><br><span class="line"><span class="string">00B0: 39 D0 DC D9 05 1D 8C 04 F9 7C A2 1F 90 F2 39 12    9........|....9.</span></span><br><span class="line"><span class="string">00C0: 00 00 00 00 22 61 9D 6D 65 56 AC C4 1C 39 E5 FD    ....&quot;a.meV...9..</span></span><br><span class="line"><span class="string">00D0: 44 22 29 F4 A7 23 94 AB 39 A0 93 F5 C3 59 5B 65    D&quot;)..#..9....Y[e</span></span><br><span class="line"><span class="string">00E0: 97 FF 2A 45 7D 24 EF F5 D1 5D 84 85 92 CC 0C 85    ..*E&#125;<span class="subst">$...]......</span></span></span><br><span class="line"><span class="subst"><span class="string">00F0: E0 26 99 F9 C0 F2 39 12 00 00 00 00 D6 A9 97 EF    .&amp;....9.........</span></span></span><br><span class="line"><span class="subst"><span class="string">0100: 4F 7E 99 F9 14 43 99 A9 82 7E 53 C5 A1 11 08 45    O~...C...~S....E</span></span></span><br><span class="line"><span class="subst"><span class="string">0110: A6 11 08 45 35 F2 3A BD 91 D3 86 EB</span></span></span><br></pre></td></tr></table></figure>

<p>为什么魔改后的T表比标准T表大呢？——多了7个4字节。</p>
<p>在函数sub_93BA4中，执行了第26、27、28轮运算，v0[59]是第27轮的t，v0[62]是第28轮的t，中间跳过了v0[60]、v0[61]，也就是2个4字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609155821938.png" alt="image-20250609155821938"></p>
<p>在函数sub_951A8中，执行了第45、46、47轮运算。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609160301578.png" alt="image-20250609160301578" style="zoom: 50%;" />

<p>而在函数sub_93A4C中，执行了第42、43、44轮运算，第45轮的t是v1[79]。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609160958764.png" alt="image-20250609160958764" style="zoom:80%;" />

<p>v1和v5基址一样，v1[79]到v5[82]，跳过了2个4字节，也就是8字节。</p>
<p>在函数sub_93CB4中，执行了第56、57、58轮运算，又跳过了3个4字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609160740608.png" alt="image-20250609160740608"></p>
<p>总共跳过了2 + 2 + 3个4字节，共计7个4字节，因此魔改后的T表多了7个4字节。</p>
<h5 id="入参顺序修改"><a href="#入参顺序修改" class="headerlink" title="入参顺序修改"></a>入参顺序修改</h5><p>假设HH的签名是HH（A，B，C，D，Mi，s，Ti）。</p>
<p>40轮：37轮结果对应为A位置，36轮结果对应B，38-39分别对应C-D，明文块取下标13</p>
<p>41轮：36轮结果对应为A位置，39轮结果对应B，38-40分别对应C-D，明文块取下标10</p>
<p>42轮：39轮结果对应为A位置，38轮结果对应B，40-41分别对应C-D，明文块取下标3</p>
<p>43轮：38轮结果对应为A位置，40轮结果对应B，41-42分别对应C-D，明文块取下标0</p>
<p>以第40轮的入参为例子。</p>
<p>标准MD5的情况下，原本第40轮的bcda分别来自于第36、39、38、37轮。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609163752074.png" alt="image-20250609163752074" style="zoom:67%;" />

<p>在函数sub_957D4中，v1-200存放着第36轮的结果b。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609164111974.png" alt="image-20250609164111974"></p>
<p>在函数sub_936C0中：</p>
<p>v2-196存放着第37轮的结果a。</p>
<p>v2-192存放着第38轮的结果d。</p>
<p>v2-188存放着第39轮的结果c。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609164347432.png" alt="image-20250609164347432"></p>
<p>正常的第40轮，应该是：HH(v-200, v-188, v-192, v-196，M10，23，tj)，展开后应该是这样子：</p>
<p>a &#x3D; (v-188) + (((v-200) + H(v-188, v-192, v-196) + M10 + tj) &lt;&lt;23)。</p>
<p>在函数sub_94344中是：HH(v-196, v-200, v-192, v-188, M13, 4, tj)。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609174510357.png" alt="image-20250609174510357"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609174519494.png" alt="image-20250609174519494"></p>
<p>同时发现，如果对第40轮取的明文进行打印，对应的M是第13块（下标），而非第10块，这里不过多赘述了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609175346841.png" alt="image-20250609175346841"></p>
<h4 id="魔改AES，还原Q0"><a href="#魔改AES，还原Q0" class="headerlink" title="魔改AES，还原Q0"></a>魔改AES，还原Q0</h4><p>现在只剩下最后2个问题：</p>
<p><strong>一是</strong>之前Q0与Q1异或的结果是0x4，Q1是硬编码在文件中的，而Q0则涉及很多内容，对栈、堆下断点，一点一点追踪Q0的内容十分困难。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250604131821514.png" alt="image-20250604131821514"></p>
<p><strong>二是</strong>HMAC-MD5的密钥是哪里来的？</p>
<p>根据后来的结果，只要解决问题二，问题一就顺带解决了。</p>
<p>x1指向的内容，是密钥与0x36异或的结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 第1次调用</span><br><span class="line">// x0</span><br><span class="line">0000: 76 54 32 10 FE DC BA 98 89 AB CD EF 01 23 45 67    vT2..........#Eg</span><br><span class="line">// x1（key与0x36的结果）</span><br><span class="line">0000: 6A 3E 23 D6 BC E6 B7 B9 C6 D2 4B D7 6C 78 02 D9    j&gt;#.......K.lx..</span><br><span class="line">0010: 72 84 55 82 03 93 5F 6E 20 B3 32 87 75 82 F9 8D    r.U..._n .2.u...</span><br><span class="line">0020: 38 43 90 71 D4 5C B9 1A 8D 63 39 3D F7 94 59 C7    8C.q.\...c9=..Y.</span><br><span class="line">0030: 7C 27 5A FD 1D 68 77 A5 BE 4D 91 14 E5 8D 0E 51    |&#x27;Z..hw..M.....Q</span><br><span class="line">// x2</span><br><span class="line">0x1</span><br><span class="line">// 返回值</span><br><span class="line">0000: 39 0A 80 0F EC FE 50 43 EE 54 1F 5B 06 9C 47 8B    9.....PC.T.[..G.</span><br></pre></td></tr></table></figure>

<p>再次异或0x36，获得key。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">5c 08 15 e0 8a d0 81 8f f0 e4 7d e1 5a 4e 34 ef </span><br><span class="line">44 b2 63 b4 35 a5 69 58 16 85 04 b1 43 b4 cf bb </span><br><span class="line">0e 75 a6 47 e2 6a 8f 2c bb 55 0f 0b c1 a2 6f f1 </span><br><span class="line">4a 11 6c cb 2b 5e 41 93 88 7b a7 22 d3 bb 38 67</span><br></pre></td></tr></table></figure>

<p>存放（密钥^0x36）的栈地址是0xe4fff320，在这里下一个写断点。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608201229798.png" alt="image-20250608201229798" style="zoom:80%;" />

<p>偏移0x91708的位置。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609181802867.png" alt="image-20250609181802867"></p>
<p>说明密钥来自于[x25, #0x24]往后的64个字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609182441095.png" alt="image-20250609182441095"></p>
<p>地址是0x123e7024。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609182616292.png" alt="image-20250609182616292"></p>
<p>对0x123e7024下一个写断点。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609182703626.png" alt="image-20250609182703626" style="zoom:80%;" />

<p>偏移0x916d0。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609182802659.png" alt="image-20250609182802659"></p>
<p>在0x926B8下断点，获得X24的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609184353374.png" alt="image-20250609184353374"></p>
<p>再对0x123e2000下一个写断点。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609184832996.png" alt="image-20250609184832996"></p>
<p>这里的偏移是0x911c8，0x1c1f8是libc的偏移，所以这里看LR寄存器。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609185526029.png" alt="image-20250609185526029"></p>
<p>hook 0x911C4，获取源地址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609185748505.png" alt="image-20250609185748505"></p>
<p>再在0xe4fff644下写断点，看看哪里往里写。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609185904231.png" alt="image-20250609185904231"></p>
<p>偏移0x9eddc。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609190228611.png" alt="image-20250609190228611"></p>
<p>在0x9edc4下断点，查看x24和x8.</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609190344879.png" alt="image-20250609190344879"></p>
<p>在0x123df100下写断点。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609190715406.png" alt="image-20250609190715406" style="zoom:80%;" />

<p>偏移0x91c84。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609191030509.png" alt="image-20250609191030509"></p>
<p>在0x91C80下断点，查看src。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609191128512.png" alt="image-20250609191128512"></p>
<p>在0x123dc070下个写断点。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609191218148.png" alt="image-20250609191218148"></p>
<p>偏移0x9aab8，之前分析第1-2字节的时候，遇到过这个偏移。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609191250304.png" alt="image-20250609191250304"></p>
<p>密钥来源于Q1、Q0的16字节异或的结果。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609191321658.png" alt="image-20250609191321658"></p>
<p>在0x9AAB4下断点，查看Q0、Q1的值。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609200150702.png" alt="image-20250609200150702" style="zoom: 67%;" />

<p>一共经历了6次地址0x9AAB4。</p>
<p>第1轮异或的结果是0x4，是我们之前想探究的2个字节的来源。</p>
<p>第2、3、4、5轮异或的结果合在一块，是密钥的64字节。</p>
<p>第6轮异或的结果像是<strong>PKCS7</strong>填充方式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">// 1</span><br><span class="line">q0=0x3966170766667a666108020434320135</span><br><span class="line">q1=0x3966170766667a666108020434320131</span><br><span class="line">// 结果</span><br><span class="line">q0=0x4</span><br><span class="line"></span><br><span class="line">// 2</span><br><span class="line">q0=0xbf8a86b75c5aa6988a18500d97aec16e</span><br><span class="line">q1=0x50bec8edbd2742680599808777bbc932</span><br><span class="line">// 结果</span><br><span class="line">q0=0xef344e5ae17de4f08f81d08ae015085c</span><br><span class="line"></span><br><span class="line">// 3</span><br><span class="line">q0=0x57ef40c30996ef5928798ead0a1f8562</span><br><span class="line">q1=0xec20f480b8926a4f70102b98be7c3726</span><br><span class="line">// 结果</span><br><span class="line">q0=0xbbcfb443b10485165869a535b463b244</span><br><span class="line"></span><br><span class="line">// 4</span><br><span class="line">q0=0x23cec11b0d7991d1bd27b2b6ecfdc56</span><br><span class="line">q1=0xf3534ed0bbd8cca6375d11c92969a958</span><br><span class="line">// 结果</span><br><span class="line">q0=0xf16fa2c10b0f55bb2c8f6ae247a6750e</span><br><span class="line"></span><br><span class="line">// 5</span><br><span class="line">q0=0xf78b842c37084a18aebc2f6959061f3f</span><br><span class="line">q1=0x90b33fff15af31903dfd7142926a0e75</span><br><span class="line">// 结果</span><br><span class="line">q0=0x6738bbd322a77b8893415e2bcb6c114a</span><br><span class="line"></span><br><span class="line">// 6</span><br><span class="line">q0=0x82a9df8040ac9909aee06a8949973ab0</span><br><span class="line">q1=0x92b9cf9050bc8919bef07a9959872aa0</span><br><span class="line">// 结果</span><br><span class="line">q0=0x10101010101010101010101010101010</span><br></pre></td></tr></table></figure>

<p>注意到，x19里面的地址，都是从x24里面取出来的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609200122406.png" alt="image-20250609200122406"></p>
<p>x24指向的内容如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609200009519.png" alt="image-20250609200009519"></p>
<p>监控一下0x120b4000。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609201052310.png" alt="image-20250609201052310"></p>
<p>发现监控不到。。。</p>
<p>在IDA的伪代码中进行追踪。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609201701983.png" alt="image-20250609201701983"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609201718228.png" alt="image-20250609201718228"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609201736475.png" alt="image-20250609201736475"></p>
<p>打印一下result。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609201816219.png" alt="image-20250609201816219" style="zoom:67%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609201833193.png" alt="image-20250609201833193" style="zoom:67%;" />

<p>后面发现，这里的x24源于hmac_main的值，hmac_main进行base64解码后的内容和它一模一样。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609200009519.png" alt="image-20250609200009519"></p>
<p>前面0x40字节在异或后是hmac-md5的密钥，而0x40-&gt;0x50字节抑或后是pkcs7填充的内容。</p>
<p>再对x22指向的0xe4fff148进行监控。（Q0）</p>
<p>之前追踪过0x9a064，找不到结果，这回追踪LR。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609205604237.png" alt="image-20250609205604237"></p>
<p>写的操作都发生在sub_994AC中，sub_994AC累积执行了6次。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609205746004.png" alt="image-20250609205746004"></p>
<p>偏移0x9a9cc位于函数sub_9A728，对这个函数分析，发现这个函数实现了一个<strong>对称分组密码</strong>的<strong>加密和解密</strong>操作，使用模式是CBC。</p>
<p>if(a6)分支实现了CBC加密模式。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609210746105.png" alt="image-20250609210746105" style="zoom:80%;" />

<p>if(a3)分支实现了CBC解密模式。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609210816395.png" alt="image-20250609210816395" style="zoom: 80%;" />

<p>根据分析，a5是IV，即初始化向量（盐），<strong>这是之前Q1的值</strong>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609211022402.png" alt="image-20250609211022402"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609211109670.png" alt="image-20250609211109670" style="zoom: 80%;" />

<p>hook函数sub_994AC，查看它的入参。</p>
<p>注意到，第1次执行，对“32 C9 BB 77 87 80 99 05 68 42 27 BD ED C8 BE 50”解密，获得了“35 01 32 34 04 02 08 61 66 7A 66 66 07 17 66 39”，而“35 01 32 34 04 02 08 61 66 7A 66 66 07 17 66 39”正是0x9AAB4第一轮异或的Q0！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">第1次执行</span><br><span class="line">X0</span><br><span class="line">32 C9 BB 77 87 80 99 05 68 42 27 BD ED C8 BE 50</span><br><span class="line">X1</span><br><span class="line">58 97 27 12 0A 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">返回值（第2次执行时的X1）</span><br><span class="line">35 01 32 34 04 02 08 61 66 7A 66 66 07 17 66 39</span><br><span class="line"></span><br><span class="line">第2次执行</span><br><span class="line">X0</span><br><span class="line">26 37 7C BE 98 2B 10 70 4F 6A 92 B8 80 F4 20 EC</span><br><span class="line">X1</span><br><span class="line">35 01 32 34 04 02 08 61 66 7A 66 66 07 17 66 39</span><br><span class="line">返回值（第3次执行时的X1）</span><br><span class="line">6E C1 AE 97 0D 50 18 8A 98 A6 5A 5C B7 86 8A BF</span><br><span class="line"></span><br><span class="line">第3次执行</span><br><span class="line">X0</span><br><span class="line">58 A9 69 29 C9 11 5D 37 A6 CC D8 BB D0 4E 53 F3</span><br><span class="line">X1</span><br><span class="line">6E C1 AE 97 0D 50 18 8A 98 A6 5A 5C B7 86 8A BF</span><br><span class="line">返回值（第4次执行时的X1）</span><br><span class="line">62 85 1F 0A AD 8E 79 28 59 EF 96 09 C3 40 EF 57</span><br><span class="line"></span><br><span class="line">第4次执行</span><br><span class="line">X0</span><br><span class="line">75 0E 6A 92 42 71 FD 3D 90 31 AF 15 FF 3F B3 90</span><br><span class="line">X1</span><br><span class="line">62 85 1F 0A AD 8E 79 28 59 EF 96 09 C3 40 EF 57</span><br><span class="line">返回值（第5次执行时的X1）</span><br><span class="line"></span><br><span class="line">第5次执行</span><br><span class="line">X0</span><br><span class="line">A0 2A 87 59 99 7A F0 BE 19 89 BC 50 90 CF B9 92</span><br><span class="line">X1</span><br><span class="line">56 DC CF 6E 2B 7B D2 1B 1D 99 D7 B0 11 EC 3C 02</span><br><span class="line">返回值（第6次执行时的X1）</span><br><span class="line">3F 1F 06 59 69 2F BC AE 18 4A 08 37 2C 84 8B F7</span><br><span class="line"></span><br><span class="line">第6次执行</span><br><span class="line">X0</span><br><span class="line">9B 48 8F D1 39 69 CA C2 54 E2 0A F2 0C 1C 4C 98</span><br><span class="line">X1</span><br><span class="line">3F 1F 06 59 69 2F BC AE 18 4A 08 37 2C 84 8B F7</span><br><span class="line">返回值</span><br><span class="line">b0 3a 97 49 89 6a3 e0 ae 09 99 ac 40 80 df a9 82</span><br></pre></td></tr></table></figure>

<p>sub_9A728采用了CBC模式，而函数sub_994AC每次处理又是16字节，这大概率是一个AES加解密。sub_994AC的第一个参数的待解密的16字节，第二个参数存放结果，第三个参数是轮密钥。</p>
<p>s.xml文件里存放的是密文。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609200009519.png" alt="image-20250609200009519"></p>
<p>第1个16字节作为密文0，在AES解密后生成<strong>中间值[0]</strong>，中间值[0]就是35 01 32 34 04 02 08 61 66 7A 66 66 07 17 66 39，中间值[0]再与盐IV “31 01 32 34 04 02 08 61 66 7A 66 66 07 17 66 39”进行异或，生成明文[0]——0x4。</p>
<p>所以说，这里的明文0x4是固定的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610101307202.png" alt="image-20250610101307202"></p>
<p>第2个16字节作为密文1，在AES解密后生成中间值[1]，中间值1就是6E C1 AE 97 0D 50 18 8A 98 A6 5A 5C B7 86 8A BF，中间值[1]再与密文0（32 C9 BB 77 87 80 99 05 68 42 27 BD ED C8 BE 50）进行异或，生成明文[1]——0xef344e5ae17de4f08f81d08ae015085c。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610101528397.png" alt="image-20250610101528397"></p>
<p>…以此类推，最后获得的内容是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 明文[0]，固定字节</span><br><span class="line">q0=0x4</span><br><span class="line"></span><br><span class="line">// 明文[1-4]，用作HMAC-MD5的密钥</span><br><span class="line">q0=0xef344e5ae17de4f08f81d08ae015085c</span><br><span class="line">q0=0xbbcfb443b10485165869a535b463b244</span><br><span class="line">q0=0xf16fa2c10b0f55bb2c8f6ae247a6750e</span><br><span class="line">q0=0x6738bbd322a77b8893415e2bcb6c114a</span><br><span class="line"></span><br><span class="line">// PKCS7填充</span><br><span class="line">q0=0x10101010101010101010101010101010</span><br></pre></td></tr></table></figure>

<p>也就是说，xhs服务器那边发来的xml文件，其实藏了0x4和MD5的密钥。</p>
<p>接下来还有2个疑惑AES是否魔改？密钥是什么？</p>
<p>为了解答疑惑，需要追踪函数sub_994AC，这个函数专门负责AES解密，难点在于，这个函数与魔改MD5一样，频繁通过BR跳转到别的函数，代码片段零零散散。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610104537106.png" alt="image-20250610104537106"></p>
<p>根据分析，每一次执行sub_994AC，最终都会调用下面这些函数。</p>
<p>0-3次循环都一样，第4次循环出现变化；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">994AC</span><br><span class="line">9a260				// 0-3字节：轮密钥加</span><br><span class="line">99e6c				// 4-7字节：轮密钥加</span><br><span class="line">9a40c				// 8-11字节：轮密钥加</span><br><span class="line">9a574				// 12-15字节：轮密钥加</span><br><span class="line">995e8</span><br><span class="line">99c40&lt;----循环0</span><br><span class="line">996d8				// 查表优化</span><br><span class="line">9a620				// 查表优化</span><br><span class="line">99a7c</span><br><span class="line">99564</span><br><span class="line">9a6ac</span><br><span class="line">9a2cc</span><br><span class="line">9991c&lt;&gt;</span><br><span class="line">9a0a0</span><br><span class="line">9a364</span><br><span class="line">99898</span><br><span class="line">9978c</span><br><span class="line">9a160</span><br><span class="line">99ee0</span><br><span class="line">99f74</span><br><span class="line">9969c</span><br><span class="line">99c40&lt;----循环1</span><br><span class="line">996d8</span><br><span class="line">9a620</span><br><span class="line">99a7c</span><br><span class="line">99564</span><br><span class="line">9a6ac</span><br><span class="line">9a2cc</span><br><span class="line">9991c&lt;&gt;</span><br><span class="line">9a0a0</span><br><span class="line">9a364</span><br><span class="line">99898</span><br><span class="line">9978c</span><br><span class="line">9a160</span><br><span class="line">99ee0</span><br><span class="line">99f74</span><br><span class="line">9969c</span><br><span class="line">99c40&lt;----循环2</span><br><span class="line">996d8</span><br><span class="line">9a620</span><br><span class="line">99a7c</span><br><span class="line">99564</span><br><span class="line">9a6ac</span><br><span class="line">9a2cc</span><br><span class="line">9991c&lt;&gt;</span><br><span class="line">9a0a0</span><br><span class="line">9a364</span><br><span class="line">99898</span><br><span class="line">9978c</span><br><span class="line">9a160</span><br><span class="line">99ee0</span><br><span class="line">99f74</span><br><span class="line">9969c</span><br><span class="line">99c40&lt;----循环3</span><br><span class="line">996d8</span><br><span class="line">9a620</span><br><span class="line">99a7c</span><br><span class="line">99564</span><br><span class="line">9a6ac</span><br><span class="line">9a2cc</span><br><span class="line">9991c&lt;&gt;</span><br><span class="line">9a0a0</span><br><span class="line">9a364</span><br><span class="line">99898</span><br><span class="line">9978c</span><br><span class="line">9a160</span><br><span class="line">99ee0</span><br><span class="line">99f74</span><br><span class="line">9969c</span><br><span class="line">99c40&lt;----循环4</span><br><span class="line">996d8</span><br><span class="line">9a620</span><br><span class="line">99a7c</span><br><span class="line">99564</span><br><span class="line">9a6ac</span><br><span class="line">9a2cc</span><br><span class="line">9991c&lt;&gt;</span><br><span class="line">9a4a0&lt;差异点&gt;</span><br><span class="line">9984c</span><br><span class="line">9a00c</span><br></pre></td></tr></table></figure>

<p>同时，之前提到的0x9a064位于函数sub_9A00C内部，0x9a064会在每次循环中，会修改下图的X22寄存器指向的地址，这间接改变了Q0的内容，而Q0指向解密后的中间值（之所以称作中间值，是因为CBC模式下，中间值还要和上一轮密文进行异或，才能得到最后的明文），这说明了执行到sub_9A00C的时候，已经完成了AES解密。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605222117031.png" alt="image-20250605222117031"></p>
<p>开始分析上述函数——从sub_9A260开始。</p>
<p>hook函数sub_994AC的时候，第3个参数是轮密钥。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610150634104.png" alt="image-20250610150634104" style="zoom:80%;" />

<p>hook函数sub_9A260，发现下面的情况。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610151800401.png" alt="image-20250610151800401"></p>
<p>这说明sub_9A260在对密文进行“轮密钥加”。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610151117804.png" alt="image-20250610151117804"></p>
<h5 id="初始密钥"><a href="#初始密钥" class="headerlink" title="初始密钥"></a>初始密钥</h5><p>加密与解密的流程是反过来的，既然a3是轮密钥，可以倒推回初始密钥。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610180411680.png" alt="image-20250610180411680"></p>
<p>在0xE4FFF398下一个写断点，观察到偏移0x981b4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610181026760.png" alt="image-20250610181026760"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610181924741.png" alt="image-20250610181924741"></p>
<p>在偏移0x981A0处下一个断点，观察x2+x8。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610182010991.png" alt="image-20250610182010991"></p>
<p>往0xe4fff2f8下一个写断点。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610182136699.png" alt="image-20250610182136699"></p>
<p>偏移0x96a44，位于函数sub_96A14中。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610182337520.png" alt="image-20250610182337520"></p>
<p>hook一下函数sub_96A14，打印a1，a1是device_id的前16字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610182455586.png" alt="image-20250610182455586"></p>
<p>因此，aes密钥的种子是device_id。</p>
<h5 id="解密——Td表（未改动）"><a href="#解密——Td表（未改动）" class="headerlink" title="解密——Td表（未改动）"></a>解密——Td表（未改动）</h5><p>稍微分析了一下，AES解密采取的方式是查T表，查表的话AES的解密速率会快很多，但没有一般的特征了（行位移、字节替换等），所以不好分析。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610161717758.png" alt="image-20250610161717758" style="zoom: 67%;" />

<p>来到函数sub_996d8，0x6a5fcc9b是标准Td[0]表的4个字节，打印一下T表。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610162437314.png" alt="image-20250610162437314"></p>
<p>和标准的Td[0]表一模一样。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610164121960.png" alt="image-20250610164121960" style="zoom:80%;" />

<p>另外3个表会基于Td[0]进行生成，简单来说就是对基础表中的每一个32位数值执行<strong>字节的循环右移</strong>，因此可以根据Td[0]生成另外3个T表。经过对比，4个T表都是标准的。</p>
<h5 id="密钥扩展"><a href="#密钥扩展" class="headerlink" title="密钥扩展"></a>密钥扩展</h5><p>这里，我们为了追踪密钥扩展的函数，可以追踪初始密钥。</p>
<p>追踪sub_96A14的执行流，寻找对device_id进行处理加密，最终获得初始密钥的位置。</p>
<p>根据分析，在函数sub_96A14、sub_95A3C、sub_97100、sub_960F8中，完成了对初始密钥的构建。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610194708525.png" alt="image-20250610194708525"></p>
<p>已知，初始密钥是W[3:0]，是根据device_id异或4个固定的4字节生成的；（0-3轮密钥）</p>
<p>而接下来的第4-39轮密钥是根据查表的方式生成的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610200719014.png" alt="image-20250610200719014"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610200923629.png" alt="image-20250610200923629" style="zoom:80%;" />

<p>在日志中，发现了一个规律——最左边框框里面的轮密钥，统一由函数sub_980ac查表获得；左2的框框统一由函数sub_97490查表获得，左3的框框统一由函数sub_97980获得、左4的框框统一由sub_973a8查表获得。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610204851290.png" alt="image-20250610204851290"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610204754405.png" alt="image-20250610204754405"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610204723149.png" alt="image-20250610204723149"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610204634679.png" alt="image-20250610204634679"></p>
<p>这4个函数都只执行9次，生成了W[39:4]，此时，还未知W[43:40]的生成方式，但应该是正常的标准扩展方式。</p>
<p>正常的密钥扩展如下图所示。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610185453688.png" alt="image-20250610185453688" style="zoom: 50%;" />

<p>我们在日志中搜索W[43:40]的轮密钥——比如：搜索0x1070c115，然后来到第1次出现的地方。注意到，eor的w9和w12中并没有出现0xf0106B39，如果是标准的扩展算法，应该会出现0xf0106B39的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610211445431.png" alt="image-20250610211445431"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610214036112.png" alt="image-20250610214036112"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610214119895.png" alt="image-20250610214119895"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610214218532.png" alt="image-20250610214218532"></p>
<p>可以看到，T函数明显被修改了，除此之外，W[43:40]的结果本来是两个轮密钥异或的结果，但在上图中，由一个轮密钥和一个未知的4字节异或得到的。</p>
<p>密钥扩展中最后4轮密钥是如何生成的？涉及到查S盒、字节替换、Rcon等——需要交叉引用96b08、96d5c。</p>
<p>这里简单过一下，具体算法还原先不做，快秋招了，得做点其它的事情，补充一下开发能力QwQ，害，怎么感觉这么难呢，我好菜。</p>
<p>以W[40]为例，W[40] &#x3D; <code>*(_DWORD *)(a1 + 60) = *(_DWORD *)(a1 + 52) ^ *(_DWORD *)(a1 + 56);</code></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610221100210.png" alt="image-20250610221100210" style="zoom:80%;" />

<p>需要hook一下，获得a1+52、a1+44、a1+48等值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610221500239.png" alt="image-20250610221500239"></p>
<p>它们的值又来源于sub_97230。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610221602792.png" alt="image-20250610221602792"></p>
<p>然后又来源于sub_97100。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610221712663.png" alt="image-20250610221712663"></p>
<p>又可以追回到sub_96A14。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610221857418.png" alt="image-20250610221857418"></p>
<p>大概意思是，W[43-40]与初始密钥相关，涉及S盒、字节交换、rcon。</p>
<p>具体关于逆T表的工作，等到以后吧，算法还原耗时但一定能解开，hhhhh。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>2025&#x2F;0610&#x2F;22:23，脑子有点晕，希望能早点找到工作。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>jidong大佬的公众号。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/default-index/page/2/">2</a><a class="page-number" href="/default-index/page/3/">3</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/default-index/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">X14Nuy</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">491k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">14:52</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
