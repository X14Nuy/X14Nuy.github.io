<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/default-index/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="X14Nuy">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/default-index/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"default-index/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">X14Nuy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/unidbg%E5%88%9D%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/unidbg%E5%88%9D%E8%AF%86/" class="post-title-link" itemprop="url">unidbg初识</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:26:53 / 修改时间：17:27:08" itemprop="dateCreated datePublished" datetime="2025-05-18T17:26:53+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>18 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Frida和Unidbg最大的区别是，Unidbg是模拟程序执行，所以可以绕过检测，而Frida面临众多检测，需要学会反检测。</p>
<p>其实在理解了Unidbg的原理之后，它还蛮简单的。</p>
<h1 id="模拟层级"><a href="#模拟层级" class="headerlink" title="模拟层级"></a>模拟层级</h1><p>Unicorn模拟了底层cpu指令模拟，相当于一台裸机。当native代码调用到系统调用的指令（如x86的syscall、arch64的svc等），会将这些触发转发给AndroidEmulator进行处理。</p>
<p>AndroidEmulator主要负责<strong>模拟安卓环境和系统环境</strong>和<strong>JNI交互</strong>，除此之外，它还负责处理Unicorn转发而来的<strong>系统调用</strong>。</p>
<h1 id="补环境实例讲解"><a href="#补环境实例讲解" class="headerlink" title="补环境实例讲解"></a>补环境实例讲解</h1><p>可以观察下面的一个需要<strong>补环境</strong>的代码。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">example</span>.<span class="property">luodst</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">AndroidEmulator</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">LibraryResolver</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">Module</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">arm</span>.<span class="property">backend</span>.<span class="property">Unicorn2Factory</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">linux</span>.<span class="property">android</span>.<span class="property">AndroidEmulatorBuilder</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">linux</span>.<span class="property">android</span>.<span class="property">AndroidResolver</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">linux</span>.<span class="property">android</span>.<span class="property">dvm</span>.*;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">linux</span>.<span class="property">android</span>.<span class="property">dvm</span>.<span class="property">array</span>.<span class="property">ByteArray</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">memory</span>.<span class="property">Memory</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">virtualmodule</span>.<span class="property">android</span>.<span class="property">AndroidModule</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">File</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">IOException</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">UnsupportedEncodingException</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">sql</span>.<span class="property">SQLOutput</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">ArrayList</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">Enumeration</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">List</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">zip</span>.<span class="property">ZipEntry</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">zip</span>.<span class="property">ZipFile</span>;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_ inherited__">AbstractJni</span> &#123;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="params"><span class="built_in">String</span>[] args</span>) &#123;</span><br><span class="line">        <span class="title class_">MainActivity</span> mainActivity = <span class="keyword">new</span> <span class="title class_">MainActivity</span>();</span><br><span class="line">        mainActivity.<span class="title function_">getHash</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 模拟器创建</span></span><br><span class="line">    private final <span class="title class_">AndroidEmulator</span> emulator;</span><br><span class="line">    <span class="comment">// 创建java虚拟机</span></span><br><span class="line">	private final <span class="variable constant_">VM</span> vm;</span><br><span class="line"></span><br><span class="line">    private final <span class="title class_">Module</span> <span class="variable language_">module</span>;</span><br><span class="line"></span><br><span class="line">    private <span class="title class_">MainActivity</span>() &#123;</span><br><span class="line">        <span class="comment">//1.创建Android模拟器实例</span></span><br><span class="line">        emulator = <span class="title class_">AndroidEmulatorBuilder</span></span><br><span class="line">                .<span class="title function_">for32Bit</span>() <span class="comment">// 32位虚拟机</span></span><br><span class="line">                .<span class="title function_">addBackendFactory</span>(<span class="keyword">new</span> <span class="title class_">Unicorn2Factory</span>(<span class="literal">true</span>)) <span class="comment">// 选择指令集，相当于选择哪台裸机，默认是unicorn</span></span><br><span class="line">                .<span class="title function_">setRootDir</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/com/example/luodst/rootfs&quot;</span>)) <span class="comment">// 设置文件系统根目录</span></span><br><span class="line">                .<span class="title function_">build</span>(); <span class="comment">// 创建</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.获取操作内存的接口</span></span><br><span class="line">        <span class="title class_">Memory</span> memory = emulator.<span class="title function_">getMemory</span>();</span><br><span class="line">        <span class="comment">//3.设置Android SDK 版本</span></span><br><span class="line">        <span class="title class_">LibraryResolver</span> resolver = <span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>);</span><br><span class="line">        memory.<span class="title function_">setLibraryResolver</span>(resolver); <span class="comment">// 加载sdk里的java类（可能会添加hook）</span></span><br><span class="line">        <span class="comment">//4.创建java虚拟机，导入apk文件</span></span><br><span class="line">        vm = emulator.<span class="title function_">createDalvikVM</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/com/example/luodst/files/DogPro.apk&quot;</span>));</span><br><span class="line">        <span class="comment">//5.是否打印日志</span></span><br><span class="line">        vm.<span class="title function_">setVerbose</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//6.将自定义的JNI处理逻辑绑定到java虚拟机上</span></span><br><span class="line">        vm.<span class="title function_">setJni</span>(<span class="variable language_">this</span>);</span><br><span class="line">        <span class="comment">// 为java环境模拟器和java虚拟机注册内存</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AndroidModule</span>(emulator, vm).<span class="title function_">register</span>(memory);</span><br><span class="line">        <span class="comment">//7.加载目标so文件，true主动执行init init_array</span></span><br><span class="line">        <span class="title class_">DalvikModule</span> dm = vm.<span class="title function_">loadLibrary</span>(<span class="string">&quot;dogpro&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//8.将so文件对应的Module存入成员变量</span></span><br><span class="line">        <span class="variable language_">module</span> = dm.<span class="title function_">getModule</span>();</span><br><span class="line">        <span class="comment">//9.主动调用JNI_OnLoad</span></span><br><span class="line">        dm.<span class="title function_">callJNI_OnLoad</span>(emulator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="keyword">void</span> <span class="title function_">getHash</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">DvmObject</span>&lt;?&gt; dvmObject = vm.<span class="title function_">resolveClass</span>(<span class="string">&quot;com/example/dogpro/MainActivity&quot;</span>).<span class="title function_">newObject</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;dvmObject = &quot;</span>+ dvmObject.<span class="title function_">toString</span>());</span><br><span class="line">        <span class="title class_">String</span> input = <span class="string">&quot;unidbg-android/src/test/java/com/example/luodst/files/DogPro.apk&quot;</span>;</span><br><span class="line">        <span class="title class_">DvmObject</span>&lt;?&gt; ret = dvmObject.<span class="title function_">callJniMethodObject</span>(emulator, <span class="string">&quot;getHash(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, input);</span><br><span class="line">        <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;result ==&gt; &quot;</span>+ret.<span class="title function_">getValue</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以这么理解Unidbg补环境的过程，so文件作为elf二进制代码，可以在unicorn上面跑，但一些JNI函数，他们的参数列表需要JNI类型的数据，有时候甚至要调用一些Java层的函数（java层给native层数据时，数据类型是JNI类型），而Unidbg就是负责处理JNI交互的。</p>
<p>Unidbg有自己的一套JNI类型，其内置的Java虚拟机中还内置了很多自定义的<strong>基本类型、引用类型</strong>的数据结果，如：外部虚拟机中的String类型，在Unidbg中是StringObject类型；外部的int、boolean类型，是Unidbg中的DvmInteger和DvmBoolean；除此之外，大部分引用类型在Unidbg都视作DvmClass类型（继承于DvmObject&lt;?&gt;类型），这些引用类型的对象都属于DvmObject&lt;?&gt;类型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DvmObject&lt;?&gt;：这是 Unidbg 中所有 Java 对象的基类，类似于真实 JVM 中的 java.lang.Object。它是一个泛型类，DvmObject&lt;T&gt; 的 T 通常表示对应的真实 Java 类型。例如，DvmObject&lt;String&gt; 表示一个 String 类型的对象。</span><br><span class="line">DvmClass：表示 Java 中的类对象（java.lang.Class 的模拟）。在 Unidbg 中，DvmClass 继承自 DvmObject&lt;Class&lt;?&gt;&gt;，用来表示类的元信息（如类名、方法、字段等）。</span><br></pre></td></tr></table></figure>

<p><img src="/./assets/image-20250320093443037.png" alt="image-20250320093443037"></p>
<p>一般情况下，不需要补环境，是因为unidbg的虚拟机中内置了很多DvmClass（解析于SDK），也内置了很多自己的处理函数，操作这些DvmObject&lt;?&gt;，但遇到一些尚未解析的DvmClass或者无法解析的DvmClass的函数，就会抛出错误，这个时候就需要为它补环境了。</p>
<p>补环境的过程如下，简单来说，就是内置的类与函数不够用了，转而使用外部java虚拟机的类与函数，只将结果转换成DvmObject&lt;?&gt;返回给内部虚拟机。</p>
<img src="./assets/image-20250320094827973.png" alt="image-20250320094827973" style="zoom: 67%;" />

<p>举个例子，下面这个报错是无法处理ZipFile的构造函数。</p>
<p><img src="/./assets/image-20250320093822376.png" alt="image-20250320093822376"></p>
<p>一直定位追踪到下面这个函数，会发现没有针对于ZipFile类型的构造函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; newObjectV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/io/ByteArrayInputStream-&gt;&lt;init&gt;([B)V&quot;</span>: &#123;</span><br><span class="line">            <span class="type">ByteArray</span> <span class="variable">array</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">assert</span> array != <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;java/io/ByteArrayInputStream&quot;</span>).newObject(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(array.value));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/lang/String-&gt;&lt;init&gt;([B)V&quot;</span>: &#123;</span><br><span class="line">            <span class="type">ByteArray</span> <span class="variable">array</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">assert</span> array != <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="keyword">new</span> <span class="title class_">String</span>(array.value));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/lang/String-&gt;&lt;init&gt;([BLjava/lang/String;)V&quot;</span>: &#123;</span><br><span class="line">            <span class="type">ByteArray</span> <span class="variable">array</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">assert</span> array != <span class="literal">null</span>;</span><br><span class="line">            <span class="type">StringObject</span> <span class="variable">charsetName</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">assert</span> charsetName != <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="keyword">new</span> <span class="title class_">String</span>(array.value, charsetName.value));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;javax/crypto/spec/SecretKeySpec-&gt;&lt;init&gt;([BLjava/lang/String;)V&quot;</span>:&#123;</span><br><span class="line">            <span class="type">byte</span>[] key = (<span class="type">byte</span>[]) vaList.getObjectArg(<span class="number">0</span>).value;</span><br><span class="line">            <span class="type">StringObject</span> <span class="variable">algorithm</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">assert</span> algorithm != <span class="literal">null</span>;</span><br><span class="line">            <span class="type">SecretKeySpec</span> <span class="variable">secretKeySpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(key, algorithm.value);</span><br><span class="line">            <span class="keyword">return</span> dvmClass.newObject(secretKeySpec);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/lang/Integer-&gt;&lt;init&gt;(I)V&quot;</span>: &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> vaList.getIntArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> DvmInteger.valueOf(vm, i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/lang/Boolean-&gt;&lt;init&gt;(Z)V&quot;</span>:&#123;</span><br><span class="line">            <span class="type">boolean</span> b;</span><br><span class="line">            b = vaList.getIntArg(<span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> DvmBoolean.valueOf(vm, b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(signature);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个时候就需要为它补环境了，如何补呢？这里的ZipFile并不是基本数据类型，在项目中也没有为它进行解析。</p>
<img src="./assets/image-20250320095402681.png" alt="image-20250320095402681" style="zoom:67%;" />

<p>因此需要将这个ZipFile类型解析到Unidbg的虚拟机中，再为它创建一个对象进行返回。</p>
<p>下面的代码中，vm.resolveClass负责解析ZipFile类，此时ZipFile类光荣的加入了Unidbg的虚拟机中，并重新定义为DvmObject&lt;ZipFile&gt;类，newObject返回了一个Unidbg内置的DvmObject&lt;ZipFile&gt;类对象。</p>
<p>这样便解解决了一个环境问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> DvmObject&lt;?&gt; newObjectV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;</span><br><span class="line">       <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;java/util/zip/ZipFile-&gt;&lt;init&gt;(Ljava/lang/String;)V&quot;</span>: &#123;</span><br><span class="line">               <span class="comment">// 正确提取 String 参数</span></span><br><span class="line">               <span class="type">StringObject</span> <span class="variable">pathObj</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>); <span class="comment">// 内部虚拟机的String</span></span><br><span class="line">               <span class="keyword">assert</span> pathObj != <span class="literal">null</span>;</span><br><span class="line">               <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> pathObj.getValue(); <span class="comment">// 获取实际java类型的String</span></span><br><span class="line"></span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="comment">// 创建虚拟的 ZipFile 对象（需提前在虚拟文件系统中补文件）</span></span><br><span class="line">                   <span class="type">ZipFile</span> <span class="variable">zipFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipFile</span>(filePath);</span><br><span class="line">                   <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;java/util/zip/ZipFile&quot;</span>).newObject(zipFile);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">super</span>.newObjectV(vm, dvmClass, signature, vaList);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>还有一个补环境的例子，下面是报错，报错理由是缺少ZipFile的entries操作。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.UnsupportedOperationException: java/util/zip/ZipFile-&gt;entries()Ljava/util/Enumeration;</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodV(DvmMethod.java:89)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.DalvikVM$32.handle(DalvikVM.java:553)</span><br></pre></td></tr></table></figure>

<p>一开始的补法是这样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/util/zip/ZipFile-&gt;entries()Ljava/util/Enumeration;&quot;</span>: &#123;</span><br><span class="line">            <span class="comment">//拿操作的对象</span></span><br><span class="line">            <span class="type">ZipFile</span> <span class="variable">zipFile</span> <span class="operator">=</span> (ZipFile) dvmObject.getValue();</span><br><span class="line">            <span class="comment">//通过对象来调用方法</span></span><br><span class="line">            Enumeration&lt;? <span class="keyword">extends</span> <span class="title class_">ZipEntry</span>&gt; entries =  zipFile.entries();</span><br><span class="line">            <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;java/util/Enumeration&quot;</span>).newObject(entries);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但之后仍会报错，提示无法将DvmObject转换为Enumeration，为什么会出现这个问题？其实DvmObject&lt;Enumeration&gt;是我们补的一个类，但Unidbg中内置了一个Enumeration类，这个类不应该补的，因为负责与与native层交互的内置虚拟机，它默认是转换内置的Enumeration &#x3D;&gt; JNI类型，而我们导入的这个类型会被忽视。</p>
<p>虽然如此，但return的这个对象很重要，这是我们通过外部虚拟机，要返回给内部虚拟机的一个Enumeration对象，如果我们返回的是它内置的com.github.unidbg.linux.android.dvm.Enumeration就没任何事，因为这是它缺少的对象，但我们返回的是com.github.unidbg.linux.android.dvm.DvmObject&lt;Enumeration&gt;，对象不一致，就要强转了，然后失败了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ClassCastException: class com.github.unidbg.linux.android.dvm.DvmObject cannot be cast to class com.github.unidbg.linux.android.dvm.Enumeration (com.github.unidbg.linux.android.dvm.DvmObject and com.github.unidbg.linux.android.dvm.Enumeration are in unnamed module of loader &#x27;app&#x27;)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:610)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:603)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.DvmMethod.callBooleanMethodV(DvmMethod.java:119)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.DalvikVM$35.handle(DalvikVM.java:630)</span><br></pre></td></tr></table></figure>

<p>我的分析得到了grok的认可，哈哈哈哈。</p>
<p><img src="/./assets/image-20250320101751847.png" alt="image-20250320101751847"></p>
<p>既然这样补不对，就需要看内置的Enumeration是如何创建的，可以看到，内置的Enumeration实现的俩函数，不过这里不是重点，重点是如何创建一个Enumeration对象。</p>
<p>通过构造函数，可以看到，需要输入一个外部java中的List对象，对象里的元素是DvmObject对象即可。</p>
<p>因此，我们需要创建一个List，然后把ZipFile对象里元素的类型（即ZipEntry）转换成DvmObject&lt;ZipEntry&gt;，然后再放入List中。</p>
<img src="./assets/image-20250320101923116.png" alt="image-20250320101923116" style="zoom: 67%;" />

<p>这样就算补好了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/util/zip/ZipFile-&gt;entries()Ljava/util/Enumeration;&quot;</span>: &#123;</span><br><span class="line">            <span class="type">ZipFile</span> <span class="variable">zipFile</span> <span class="operator">=</span> (ZipFile) dvmObject.getValue();</span><br><span class="line">            Enumeration&lt;? <span class="keyword">extends</span> <span class="title class_">ZipEntry</span>&gt; entries =  zipFile.entries();</span><br><span class="line">            <span class="comment">//return vm.resolveClass(&quot;java/util/Enumeration&quot;).newObject(entries);</span></span><br><span class="line">            List&lt;DvmObject&lt;?&gt;&gt; objs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">while</span> (entries.hasMoreElements())&#123;</span><br><span class="line">                <span class="type">ZipEntry</span> <span class="variable">zipEntry</span> <span class="operator">=</span> entries.nextElement();</span><br><span class="line">                objs.add(vm.resolveClass(<span class="string">&quot;java/util/zip/ZipEntry&quot;</span>).newObject(zipEntry));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">com</span>.github.unidbg.linux.android.dvm.Enumeration(vm, objs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="追踪读写"><a href="#追踪读写" class="headerlink" title="追踪读写"></a>追踪读写</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 监控读写 */</span></span><br><span class="line">emulator.traceRead(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base + <span class="keyword">module</span>.size);</span><br><span class="line">emulator.traceWrite(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base + <span class="keyword">module</span>.size);</span><br></pre></td></tr></table></figure>

<h1 id="读取内存"><a href="#读取内存" class="headerlink" title="读取内存"></a>读取内存</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 读取内存 */</span></span><br><span class="line">long targetAddr = <span class="variable language_">module</span>.<span class="property">base</span> + <span class="number">0xE0320</span>;</span><br><span class="line"><span class="title class_">UnidbgPointer</span> ptr = <span class="title class_">UnidbgPointer</span>.<span class="title function_">pointer</span>(emulator, targetAddr);</span><br><span class="line">byte[] data = ptr.<span class="title function_">getByteArray</span>(<span class="number">0</span>, <span class="number">0xC0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Inspector</span>.<span class="title function_">inspect</span>(data, <span class="string">&quot;Dumped Memory at 0x&quot;</span> + <span class="title class_">Long</span>.<span class="title function_">toHexString</span>(targetAddr));</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/%E7%AE%97%E6%B3%95%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E5%88%9D%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/%E7%AE%97%E6%B3%95%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E5%88%9D%E8%AF%86/" class="post-title-link" itemprop="url">算法逆向分析初识</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:23:57 / 修改时间：17:24:17" itemprop="dateCreated datePublished" datetime="2025-05-18T17:23:57+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="hellojni-2-0-7-apk"><a href="#hellojni-2-0-7-apk" class="headerlink" title="hellojni_2.0.7.apk"></a>hellojni_2.0.7.apk</h1><p>目标：还原signs的加密算法。</p>
<p>点击SIGN2按钮后，下面这个签名会发生改变。</p>
<img src="./assets/image-20250414145949279.png" alt="image-20250414145949279" style="zoom:67%;" />

<p>通过定位，发现这个签名是由JNI函数<strong>Java_com_example_hellojni_HelloJni_sign2</strong>生成的。</p>
<p>进一步，对其中的sub_1CFF0进行hook，发现其第3个参数（从1开始算）便是签名。</p>
<img src="./assets/image-20250414150401970.png" alt="image-20250414150401970" style="zoom:67%;" />

<p>hook的代码如下，将其中的addr赋值为<strong>1CFF0</strong>即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_find_target_address</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> base = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libhello-jni.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nlibhello-jni.so Baseaddr: &quot;</span> + base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> target_addr = base.<span class="title function_">add</span>(addr);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nTarget Address: &quot;</span> + target_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hook并打印参数和返回值</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nsub_&quot;</span> + addr.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;args: &quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\ninput_str: \r\n&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\ninput_str_length: &quot;</span> + <span class="variable language_">this</span>.<span class="property">arg1</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">onLeave</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\noutput_str: \r\n&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg2</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印的结果如下图所示。</p>
<img src="./assets/image-20250414150622333.png" alt="image-20250414150622333" style="zoom:80%;" />

<p>为了方便分析，这里需要将input_str和input_str_length进行固定。</p>
<p>如图所示，我将输入字符串固定为”1234567890abcdefg”。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_find_target_address</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> base = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libhello-jni.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nlibhello-jni.so Baseaddr: &quot;</span> + base);</span><br><span class="line">    <span class="keyword">var</span> target_addr = base.<span class="title function_">add</span>(addr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nTarget Address: &quot;</span> + target_addr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// hook并打印参数和返回值</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="comment">// 保存原始参数值以便打印</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nsub_&quot;</span> + addr.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; args: &quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\n原始input_str: \r\n&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>, &#123; <span class="attr">length</span>: <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>) &#125;));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\ninput_str_length: &quot;</span> + <span class="variable language_">this</span>.<span class="property">arg1</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 新字符串</span></span><br><span class="line">            <span class="keyword">var</span> new_str = <span class="string">&quot;1234567890abcdefg&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 方法1：直接写入内存</span></span><br><span class="line">            <span class="title class_">Memory</span>.<span class="title function_">writeUtf8String</span>(args[<span class="number">0</span>], new_str);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 方法2：如果需要写入二进制数据而不是UTF8字符串</span></span><br><span class="line">            <span class="comment">// var bytes = [0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x00]; // &quot;1234567890abcdef\0&quot;</span></span><br><span class="line">            <span class="comment">// Memory.writeByteArray(args[0], bytes);</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> length = new_str.<span class="property">length</span>;</span><br><span class="line">            args[<span class="number">1</span>] = <span class="title function_">ptr</span>(length);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">args1</span> = args[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\n修改后的长度: &quot;</span> + <span class="variable language_">this</span>.<span class="property">args1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\n修改后input_str: \r\n&quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">0</span>], &#123; <span class="attr">length</span>: <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">args1</span>) &#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">onLeave</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\noutput_str: \r\n&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg2</span>, &#123; <span class="attr">length</span>: <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">args1</span>) &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="./assets/image-20250414153532777.png" alt="image-20250414153532777" style="zoom:80%;" />

<p>在确保了输入字符串不变后，尝试使用IDA的trace，追踪函数sub_1CFF0。</p>
<p>先注入frida、再注入IDA server——似乎不按这个顺序，先注入IDA再注入Frida，Frida会注入失败。</p>
<p>我决定先退出Frida的hook，再进行追踪，因为我发现Frida要是已经hook了sub_1CFF0，在sub_1CFF0的函数开始的地方，会存在inline hook，跳转到Frida的跳床函数。</p>
<img src="./assets/image-20250414153913051.png" alt="image-20250414153913051" style="zoom:80%;" />

<p>通过IDA trace，走过的汇编指令会变成黄色。</p>
<p><img src="/./assets/image-20250414154156636.png" alt="image-20250414154156636"></p>
<p>追踪到的内容如下图所示，第一栏的36EE是线程id，第二栏是地址，第三栏开始就是汇编指令了，如果汇编指令修改了寄存器，则会在汇编指令后面，显示寄存器被修改后的值。</p>
<p><img src="/./assets/image-20250414154332639.png" alt="image-20250414154332639"></p>
<p>之后，我重新生成了一个trace记录，并记录了一下签名值。</p>
<img src="./assets/image-20250414162840995.png" alt="image-20250414162840995" style="zoom: 50%;" />

<p>之后进行算法逆向。</p>
<p>已知算法的输入是input_str &#x2F; input_str_length &#x2F; output_str，分别代表着X0、X1、X2。</p>
<p><img src="/./assets/image-20250414164247587.png" alt="image-20250414164247587"></p>
<p>因为X2代表着output_str的内存地址，所以追踪X2，判断有哪些指令对地址0x00000079E1720D90上的内容进行了修改。</p>
<img src="./assets/image-20250414164543132.png" alt="image-20250414164543132" style="zoom:80%;" />

<p>查找到了34个对0x00000079E1720D90进行读写的位置。</p>
<p>对其中一些指令进行还原，可以猜到。</p>
<p>X8代表：当前正在操作output的第X8个字节，也代表循环次数；</p>
<p>X5代表output的内存地址；</p>
<p>X29[var_64]是一个固定字节数组。</p>
<p>X29[var_68]也是一个固定字节数组。</p>
<p>至于var_6C，最后还是追踪到var_68上。</p>
<p><img src="/./assets/image-20250414190420796.png" alt="image-20250414190420796"></p>
<p>做了一些补充。</p>
<p><img src="/./assets/image-20250415094520831.png" alt="image-20250415094520831"></p>
<p>一直追踪[X29,#var_64]。</p>
<p><img src="/./assets/image-20250415094627344.png" alt="image-20250415094627344"></p>
<p>而一直追踪[X29,#var_68]，会发现需要追踪X2，继而追踪X2和X3，继而追踪X3和X7……</p>
<p>最后追踪到[X29,#var_88]。</p>
<p><img src="/./assets/image-20250415094751043.png" alt="image-20250415094751043"></p>
<p>最后发现，var_88这个变量是一个指针，它将地址给了X2，由X2去获取全局变量，也就是图中的xmmword_79A31EE7B0。</p>
<p><img src="/./assets/image-20250415095055847.png" alt="image-20250415095055847"></p>
<p>至此，可以将全局变量及涉及到的寄存器改写成c。</p>
<p>(解密的时候前8个字节和后8个字节的处理方式不同，可能还得逆，这里我直接贴别人逆好的代码)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">enc_function</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* input_str, <span class="type">int</span> input_len, <span class="type">char</span>* result)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* table_key1 = <span class="string">&quot;9d9107e02f0f07984956767ab1ac87e5&quot;</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> table_key2[] = &#123;<span class="number">0x37</span>, <span class="number">0x92</span>, <span class="number">0x44</span>, <span class="number">0x68</span>, <span class="number">0xA5</span>, <span class="number">0x3D</span>, <span class="number">0xCC</span>, <span class="number">0x7F</span>, <span class="number">0xBB</span>, <span class="number">0xF</span>, <span class="number">0xD9</span>, <span class="number">0x88</span>, <span class="number">0xEE</span>, <span class="number">0x9A</span>, <span class="number">0xE9</span>, <span class="number">0x5A</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; input_len; ++i) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> X2 = input_str[i];</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> key2 = table_key2[(i &amp; <span class="number">0xF</span>) &amp; <span class="number">0xFFFFFFFF</span>];</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W8 = <span class="number">0xDA</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W30 = <span class="number">0x25</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W2 = X2;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W7 = W8 &amp; (~W2);</span><br><span class="line">        W2 = W2 &amp; <span class="number">0x25</span>;</span><br><span class="line">        W2 = W7 | W2;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W3 = key2;</span><br><span class="line">        W7 = W8 &amp; (~W3);</span><br><span class="line">        W3 = W3 &amp; W30;</span><br><span class="line">        W3 = W7 | W3;</span><br><span class="line">        W2 = W2 ^ W3;</span><br><span class="line">        W3 = W2;</span><br><span class="line"></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> key1 = table_key1[(i ^ <span class="number">0xFFFFFFF8</span>) &amp; i ];</span><br><span class="line">        W2 = key1;</span><br><span class="line">        W7 = key2;</span><br><span class="line">        W30 = key2;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W1 = W2 &amp; (~W3);</span><br><span class="line">        W3 = W3 &amp; (~W2);</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W5 = W30 &amp; (~W2);</span><br><span class="line">        W2 = W2 &amp; (~W30);</span><br><span class="line">        W1 = W1 | W3;</span><br><span class="line">        W2 = W5 | W2;</span><br><span class="line">        W1 = W1 + W7;</span><br><span class="line">        W3 = W1 &amp; (~W2);</span><br><span class="line">        W1 = W2 &amp; (~W1);</span><br><span class="line">        W1 = W3 | W1;</span><br><span class="line">        result[i] = W1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">test_eq</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* buf1, <span class="type">const</span> <span class="type">char</span>* buf2, <span class="type">int</span> buf_len)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; buf_len; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (buf1[i] != buf2[i]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* input = <span class="string">&quot;0123456789abcdef0123456789abcdef&quot;</span>;</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(input);</span><br><span class="line">    <span class="type">char</span>* result = (<span class="type">char</span>*)<span class="built_in">malloc</span>(len);</span><br><span class="line">    <span class="built_in">memset</span>(result, <span class="number">0</span>, len);</span><br><span class="line">    enc_function(input, len, result);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02x&quot;</span>, (<span class="type">unsigned</span> <span class="type">char</span>)result[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\r\n%x&quot;</span>, test_eq(result, result, len));</span><br><span class="line">    <span class="built_in">free</span>(result);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/%E6%9F%90%E7%93%A3%E5%AD%97%E6%AE%B5-sig%E7%9A%84%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/%E6%9F%90%E7%93%A3%E5%AD%97%E6%AE%B5-sig%E7%9A%84%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">某瓣字段_sig的分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:21:48 / 修改时间：17:22:01" itemprop="dateCreated datePublished" datetime="2025-05-18T17:21:48+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>14k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>25 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="豆瓣"><a href="#豆瓣" class="headerlink" title="豆瓣"></a>豆瓣</h1><h2 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h2><p>先了解如何抓包，这次尝试分析某个参数的加解密过程。</p>
<p>工具是：Charles 4.6.3。</p>
<p>抓包的配置方式如下：</p>
<p>1.将pc和op放在同一局域网下，pc上打开Charles，设置Proxy-&gt;Proxy Settings，填写端口并勾选，如下图所示。</p>
<img src="./assets/image-20250310103644735.png" alt="image-20250310103644735" style="zoom:50%;" />

<p>2.之后在op上，设置网络的代理，将手机的流量转发到手机的9999端口。</p>
<img src="./assets/image-20250310103929125.png" alt="image-20250310103929125" style="zoom:67%;" />

<p>3.为pc和手机装Charles的root证书，用于CA自签名。</p>
<p><img src="/./assets/image-20250310104014250.png" alt="image-20250310104014250"></p>
<p>由于手机端的证书对文件名有要求，这个文件名需要通过计算获得，计算可以通过<code>openssl x509 -subject_hash_old -in &lt;证书&gt;</code>获得，下图是网图，它最后得到的文件名就是5cba21f7，然后后缀固定为.0，所以就是<code>5cba21f7.0</code>。</p>
<p><img src="/./assets/image-20250310104324383.png" alt="image-20250310104324383"></p>
<p>4.在安卓7以上的版本，app只接受系统证书，不接受用户证书，所以需要将证书移至&#x2F;system&#x2F;etc&#x2F;security&#x2F;cacerts，之后重启手机。</p>
<p>5.之后如图所示，设置ssl代理。</p>
<p><img src="/./assets/image-20250310104618901.png" alt="image-20250310104618901"></p>
<p>之后就可以抓到包了。——上面只考虑了单向认证，如果是双向认证，有些app的包还是会显示unknown，那就要将app的证书和密钥填写至Charles中了，不过豆瓣是单向认证。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>根据访问不同的域名，进行区别。</p>
<img src="./assets/image-20250310150823254.png" alt="image-20250310150823254" style="zoom:67%;" />

<p>其中，参数_sig是请求签名，用于验证请求的完整性和合法性，通常由参数和密钥计算得出。</p>
<p><img src="/./assets/image-20250310150909829.png" alt="image-20250310150909829"></p>
<p>这次要分析的就是如何得到这个_sig。——抓几次包，会发现每次发包的header中，就_sig的值一直在变化，所以如果想要写脚本来发包，伪造客户端，就要解决_sig构造的问题。</p>
<p>通过搜索<code>&quot;_sig&quot;</code>，似乎找到了为<code>_sig</code>赋值的地方，将pair0.first经过一些规则（HTTP的规范）后，作为值赋给_sig。</p>
<p><img src="/./assets/image-20250310151822183.png" alt="image-20250310151822183"></p>
<p>在setQueryParameter中会检查s是否为空，如果已存在，还会把它移除，重新进行签名。</p>
<p><img src="/./assets/image-20250310155727702.png" alt="image-20250310155727702"></p>
<p>之后，我想hook上面的函数，结果遇到了frida检测。</p>
<p>这次frida检测，我学到了以下几点：</p>
<p>1.frida用旧一些的版本，最新的可能不稳定；</p>
<p>2.把握好hook的时机，Interceptor.attach和Interceptor.replace的执行方式不同。attach是设置监控，监控目标地址，当执行到目标地址，才会启动对应的脚本内容；而replace是对目标地址立马进行替换，如果目标地址所在的模块尚未加载，会执行失败。</p>
<p>以下是grok的回答。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">什么是“Hook 陷阱”？</span><br><span class="line"></span><br><span class="line">“Hook 陷阱”并不是一个官方术语，而是形象地描述了 Frida 在特定时机设置 Hook 的工作方式。简单来说，它就像在目标函数的调用路径上“埋下一个陷阱”，等待程序运行到那个位置时触发，而不是立即执行 Hook 逻辑。</span><br><span class="line"></span><br><span class="line">在 Frida 中，Hook 的实现主要通过 Interceptor 模块完成：</span><br><span class="line"></span><br><span class="line"><span class="code">    Interceptor.attach：附加到目标函数的入口和出口，分别在函数调用前（onEnter）和调用后（onLeave）执行自定义逻辑。</span></span><br><span class="line"><span class="code">    Interceptor.replace：直接替换目标函数的实现，用你定义的函数逻辑覆盖原始函数。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">“陷阱”的关键在于时机：</span><br><span class="line"></span><br><span class="line"><span class="code">    Hook 的设置（比如调用 Interceptor.attach 或 Interceptor.replace）是在你的 Frida JS 脚本运行时完成的。</span></span><br><span class="line"><span class="code">    Hook 的触发（比如执行 onEnter 或替换后的函数逻辑）则是在目标函数被实际调用时发生的。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">举个例子：</span><br><span class="line">javascript</span><br><span class="line">Interceptor.attach(Module.getExportByName(&#x27;libc.so&#x27;, &#x27;open&#x27;), &#123;</span><br><span class="line"><span class="code">    onEnter: function(args) &#123;</span></span><br><span class="line"><span class="code">        console.log(&#x27;open 被调用了！&#x27;);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">&#125;);</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    脚本运行时，Interceptor.attach 会“设置陷阱”，告诉 Frida 监控 open 函数。</span></span><br><span class="line"><span class="code">    但 onEnter 里的 console.log 并不会立即执行，而是等到程序调用 open 时才打印日志。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">这种“等待触发”的机制就是“Hook 陷阱”的核心。</span><br><span class="line">替换函数的时机：脚本运行后会第一时间替换吗？</span><br><span class="line"></span><br><span class="line">你提到：“将脚本跑起来后，它难道不是第一时间将 Native 层函数替换掉吗？”答案是不完全是。让我们详细分析一下。</span><br><span class="line">Frida 替换函数的工作原理</span><br><span class="line"></span><br><span class="line">使用 Interceptor.replace 可以替换 Native 层函数的实现。例如：</span><br><span class="line">javascript</span><br><span class="line">Interceptor.replace(ptr(&#x27;0x12345678&#x27;), new NativeCallback(function() &#123;</span><br><span class="line"><span class="code">    console.log(&#x27;函数被替换了！&#x27;);</span></span><br><span class="line"><span class="code">    return 0;</span></span><br><span class="line"><span class="code">&#125;, &#x27;int&#x27;, []));</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    当脚本执行到 Interceptor.replace 时，Frida 会尝试将目标函数的地址替换为你的自定义函数。</span></span><br><span class="line"><span class="code">    但这有一个前提：目标函数所在的模块必须已经加载到内存中。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">时机的影响因素</span><br><span class="line"></span><br><span class="line"><span class="code">    模块是否已加载</span></span><br><span class="line"><span class="code">        如果你在脚本运行时要替换的函数属于某个动态加载的 .so 文件（比如 libexample.so），而这个文件在脚本启动时尚未加载，Frida 无法立即替换。</span></span><br><span class="line"><span class="code">        因为 Frida 需要知道模块的基址和函数的偏移量。如果 Process.findModuleByName(&#x27;libexample.so&#x27;) 返回 null，你就无法计算目标函数的地址，替换自然无法生效。</span></span><br><span class="line"><span class="code">    动态加载的场景</span></span><br><span class="line"><span class="code">        在 Android 中，很多 .so 文件是通过 dlopen（或 android_dlopen_ext）动态加载的。</span></span><br><span class="line"><span class="code">        如果你的目标函数在某个动态加载的模块中，你需要在模块加载后再执行替换操作。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">实际例子：你的代码可能的样子</span><br><span class="line"></span><br><span class="line">假设你想替换 libmsaoaidsec.so 中的某个函数 sub<span class="emphasis">_1b924，代码可能是这样的：</span></span><br><span class="line"><span class="emphasis">javascript</span></span><br><span class="line"><span class="emphasis">function hook_</span>sub<span class="emphasis">_1b924() &#123;</span></span><br><span class="line"><span class="emphasis">    let module = Process.findModuleByName(&#x27;libmsaoaidsec.so&#x27;);</span></span><br><span class="line"><span class="emphasis">    if (module) &#123;</span></span><br><span class="line"><span class="emphasis">        let sub_</span>1b924 = module.base.add(0x1b924);</span><br><span class="line"><span class="code">        Interceptor.replace(sub_1b924, new NativeCallback(function() &#123;</span></span><br><span class="line"><span class="code">            console.log(&#x27;sub_1b924 被替换了！&#x27;);</span></span><br><span class="line"><span class="code">            return 0;</span></span><br><span class="line"><span class="code">        &#125;, &#x27;int&#x27;, []));</span></span><br><span class="line"><span class="code">    &#125; else &#123;</span></span><br><span class="line"><span class="code">        console.log(&#x27;模块尚未加载！&#x27;);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">&#125;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    如果脚本运行时 libmsaoaidsec.so 还没加载，module 会是 null，替换不会生效。</span></span><br><span class="line"><span class="code">    你需要等待模块加载完成后再调用 hook_sub_1b924()。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">为什么不直接在脚本运行时替换？</span><br><span class="line"></span><br><span class="line">你可能会疑惑：为什么不直接在脚本启动时就完成所有替换？原因有以下几点：</span><br><span class="line"></span><br><span class="line"><span class="code">    模块未加载的问题</span></span><br><span class="line"><span class="code">        如上所述，如果目标模块没加载，Frida 无法找到函数地址，替换会失败。</span></span><br><span class="line"><span class="code">        解决办法是监控模块加载过程（比如 Hook android_dlopen_ext），在模块加载后再执行替换。</span></span><br><span class="line"><span class="code">    初始化逻辑的依赖</span></span><br><span class="line"><span class="code">        有些 .so 文件在加载后会执行初始化逻辑（比如通过 soinfo::call_constructors() 调用 .init 或 .init_array）。</span></span><br><span class="line"><span class="code">        如果你在初始化前替换函数，可能会干扰模块的正常初始化（比如反调试、校验逻辑），导致程序崩溃或行为异常。</span></span><br><span class="line"><span class="code">        通过在初始化开始前（比如 call_constructors 的 onEnter）替换函数，你可以更安全地介入。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">例如，一个常见的策略是：</span><br><span class="line">javascript</span><br><span class="line">Interceptor.attach(Module.getExportByName(&#x27;libdl.so&#x27;, &#x27;android<span class="emphasis">_dlopen_</span>ext&#x27;), &#123;</span><br><span class="line"><span class="code">    onEnter: function(args) &#123;</span></span><br><span class="line"><span class="code">        this.onLeave = function(retval) &#123;</span></span><br><span class="line"><span class="code">            hook_sub_1b924(); // 在模块加载后替换函数</span></span><br><span class="line"><span class="code">        &#125;;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">&#125;);</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    这里在 android_dlopen_ext 调用后（模块加载完成时）再执行替换，确保时机正确。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">总结：如何理解“Hook 陷阱”和替换时机</span><br><span class="line"></span><br><span class="line"><span class="code">    “Hook 陷阱”的含义</span></span><br><span class="line"><span class="code">        它是指在脚本运行时设置 Hook，但实际逻辑在目标函数调用时触发，就像“埋下陷阱”等待猎物。</span></span><br><span class="line"><span class="code">        比如通过 Interceptor.attach 设置的 onEnter 和 onLeave，都是在目标函数执行时才生效。</span></span><br><span class="line"><span class="code">    替换函数的时机</span></span><br><span class="line"><span class="code">        Interceptor.replace 在脚本运行时设置替换，但实际生效取决于模块是否加载。</span></span><br><span class="line"><span class="code">        如果目标函数所在的 .so 文件是动态加载的，你需要在模块加载后（比如通过 Hook android_dlopen_ext 或 soinfo::call_constructors()）再执行替换。</span></span><br><span class="line"><span class="code">    你的疑问解答</span></span><br><span class="line"><span class="code">        脚本运行后不会“第一时间”替换 Native 层函数，除非目标模块已经加载且函数地址可访问。</span></span><br><span class="line"><span class="code">        对于动态加载的模块，Frida 需要你手动控制替换时机，确保在正确的时间点介入。</span></span><br></pre></td></tr></table></figure>

<p>之后写的脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">fileName</span> = args[<span class="number">0</span>].<span class="title function_">readCString</span>()</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onEnter: <span class="subst">$&#123;<span class="variable language_">this</span>.fileName&#125;</span>`</span>)</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fileName</span> !== <span class="literal">undefined</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">fileName</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_linker_call_constructors</span>()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onLeave fileName: <span class="subst">$&#123;<span class="variable language_">this</span>.fileName&#125;</span>`</span>)</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fileName</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">fileName</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> JNI_OnLoad = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="variable language_">this</span>.<span class="property">fileName</span>, <span class="string">&#x27;JNI_OnLoad&#x27;</span>)</span><br><span class="line">                    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(JNI_OnLoad, &#123;</span><br><span class="line">                        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`JNI_OnLoad onLeave: <span class="subst">$&#123;retval&#125;</span>`</span>)</span><br><span class="line">                        &#125;    </span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onLeave JNI_OnLoad: <span class="subst">$&#123;JNI_OnLoad - Module.getBaseAddress(<span class="variable language_">this</span>.fileName)&#125;</span>`</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>)</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0x51BA8</span>    <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset)</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hook_linker_call_constructors onEnter&#x27;</span>)</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">// hook_pthred_create()</span></span><br><span class="line">                <span class="title function_">hook_sub_1c544</span>() <span class="comment">// 含检测</span></span><br><span class="line">                <span class="title function_">hook_sub_1b8d4</span>()</span><br><span class="line">                <span class="comment">// hook_sub_26e5c()</span></span><br><span class="line">                listener.<span class="title function_">detach</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthred_create</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libmsaoaidsec.so --- &quot;</span> + <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>).<span class="property">base</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>,<span class="string">&#x27;pthread_create&#x27;</span>),&#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> func_addr = args[<span class="number">2</span>]</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`The thread Called function address is: <span class="subst">$&#123;func_addr&#125;</span>`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_1c544</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1c544</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_1c544 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&quot;int64&quot;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_1b8d4</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1b8d4</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_1b8d4 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_26e5c</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x26e5c</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_26e5c &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;, <span class="string">&#x27;int64&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_dlopen)</span><br></pre></td></tr></table></figure>

<p>逻辑算比较清楚，之后还剩下对业务函数的hook、利用_sig构造包。</p>
<p>接着分析方法e0.d.A(Request request0)。</p>
<p><img src="/./assets/image-20250312125816408.png" alt="image-20250312125816408"></p>
<p>然后写了这个函数，每次我将这个函数放到hook_dlopen的末尾，就无法正确hook上之前的3个线程。之后我发现，可以通过cmd行输入。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sig</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> clazz_d = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;e0.d&quot;</span>);</span><br><span class="line">        clazz_d.<span class="property">A</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">request</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`request-header: <span class="subst">$&#123;request.header(<span class="string">&quot;Authorization&quot;</span>)&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">A</span>(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下。</p>
<p><img src="/./assets/image-20250312125943864.png" alt="image-20250312125943864"></p>
<p>这里就获得了Authorization的值：93f4c257daea24dfbbde470790be6e9d。</p>
<p>在方法d.z中，将url、method、authorization进行加密</p>
<p><img src="/./assets/image-20250312130152471.png" alt="image-20250312130152471"></p>
<p>这里就不进去追踪了，直接获取返回值。</p>
<p>直接获取了_sig和_ts的值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sig</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> clazz_d = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;e0.d&quot;</span>);</span><br><span class="line">        clazz_d.<span class="property">A</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">request</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`request-header: <span class="subst">$&#123;request.header(<span class="string">&quot;Authorization&quot;</span>)&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">let</span> res = <span class="variable language_">this</span>.<span class="title function_">A</span>(request);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Pair-first: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">String</span>(res.first)&#125;</span>\nPair-second: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">String</span>(res.second)&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/./assets/image-20250312131159267.png" alt="image-20250312131159267"></p>
<p>之后要利用并构造包的话，只需要添加上自己生成的_sig参数，这里用js脚本，模仿jeb的代码构造_sig，最终，完整的代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url;</span><br><span class="line"><span class="keyword">var</span> method;</span><br><span class="line"><span class="keyword">var</span> authorization;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">fileName</span> = args[<span class="number">0</span>].<span class="title function_">readCString</span>()</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onEnter: <span class="subst">$&#123;<span class="variable language_">this</span>.fileName&#125;</span>`</span>)</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fileName</span> !== <span class="literal">undefined</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">fileName</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_linker_call_constructors</span>()</span><br><span class="line">                    listener.<span class="title function_">detach</span>()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// hook_sig()</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>)</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0x51BA8</span>    <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset)</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hook_linker_call_constructors onEnter&#x27;</span>)</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">// hook_pthred_create()</span></span><br><span class="line">                <span class="title function_">hook_sub_1c544</span>()</span><br><span class="line">                <span class="title function_">hook_sub_1b8d4</span>()</span><br><span class="line">                <span class="title function_">hook_sub_26e5c</span>()</span><br><span class="line">                listener.<span class="title function_">detach</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthred_create</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libmsaoaidsec.so --- &quot;</span> + <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>).<span class="property">base</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>,<span class="string">&#x27;pthread_create&#x27;</span>),&#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> func_addr = args[<span class="number">2</span>]</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`The thread Called function address is: <span class="subst">$&#123;func_addr&#125;</span>`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_1c544</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1c544</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_1c544 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&quot;int64&quot;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_1b8d4</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1b8d4</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_1b8d4 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_26e5c</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x26e5c</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_26e5c &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;, <span class="string">&#x27;int64&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sig</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> clazz_d = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;e0.d&quot;</span>);</span><br><span class="line">        clazz_d.<span class="property">A</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">request</span>) &#123;</span><br><span class="line">            authorization = request.<span class="title function_">header</span>(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">            authorization = authorization.<span class="title function_">substring</span>(<span class="number">7</span>);</span><br><span class="line">            url = request.<span class="title function_">url</span>().<span class="title function_">toString</span>();</span><br><span class="line">            method = request.<span class="title function_">method</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`request-header: <span class="subst">$&#123;authorization&#125;</span>`</span>); <span class="comment">// 打印Authorization</span></span><br><span class="line">            <span class="keyword">let</span> res = <span class="variable language_">this</span>.<span class="title function_">A</span>(request);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Pair-first: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">String</span>(res.first.value)&#125;</span>\nPair-second: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">String</span>(res.second.value)&#125;</span>`</span>); <span class="comment">// 打印Pair</span></span><br><span class="line">            <span class="comment">// MySig，自己模仿流程写一个</span></span><br><span class="line">            <span class="title function_">getMySig</span>();</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getMySig</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">HttpUrl</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;okhttp3.HttpUrl&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">StringBuilder</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.StringBuilder&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> clazz_a = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.support.v4.media.a&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Uri</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.net.Uri&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 临时硬编码 s3</span></span><br><span class="line">    <span class="keyword">var</span> s3 = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;bf7dddc7c9cfe6f7&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!url || !method || !authorization) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;url, method, or authorization is undefined&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> stringBuilder0 = clazz_a.<span class="title function_">g</span>(method);</span><br><span class="line">    <span class="keyword">if</span> (!stringBuilder0) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;clazz_a.g(method) returned null&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> s4 = <span class="title class_">HttpUrl</span>.<span class="title function_">parse</span>(url).<span class="title function_">encodedPath</span>();</span><br><span class="line">    <span class="keyword">if</span> (!s4) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;HttpUrl.parse failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> s5 = <span class="title class_">Uri</span>.<span class="title function_">decode</span>(s4);</span><br><span class="line">    <span class="keyword">if</span> (s5.<span class="title function_">endsWith</span>(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">        s5 = clazz_a.<span class="title function_">e</span>(s5, -<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stringBuilder0.<span class="title function_">append</span>(<span class="string">&quot;&amp;&quot;</span>).<span class="title function_">append</span>(<span class="title class_">Uri</span>.<span class="title function_">encode</span>(s5)).<span class="title function_">append</span>(<span class="string">&quot;&amp;&quot;</span>).<span class="title function_">append</span>(authorization);</span><br><span class="line">    <span class="keyword">var</span> v = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.System&quot;</span>).<span class="title function_">currentTimeMillis</span>().<span class="title function_">toString</span>();</span><br><span class="line">    v = v.<span class="title function_">substring</span>(<span class="number">0</span>, v.<span class="property">length</span> - <span class="number">3</span>);</span><br><span class="line">    stringBuilder0.<span class="title function_">append</span>(<span class="string">&quot;&amp;&quot;</span>).<span class="title function_">append</span>(v);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> mac0 = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;javax.crypto.Mac&quot;</span>).<span class="title function_">getInstance</span>(<span class="string">&quot;HmacSHA1&quot;</span>);</span><br><span class="line">    mac0.<span class="title function_">init</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;javax.crypto.spec.SecretKeySpec&quot;</span>).$new(s3.<span class="title function_">getBytes</span>(), <span class="string">&quot;HmacSHA1&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Base64</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Base64&quot;</span>);</span><br><span class="line"></span><br><span class="line">    stringBuilder0.<span class="title function_">toString</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> strrr = stringBuilder0.<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`typeof strrr: <span class="subst">$&#123;<span class="keyword">typeof</span> strrr&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> bytes = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(strrr).<span class="title function_">getBytes</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`typeof Java.use(&quot;java.lang.String&quot;).$new(strrr): <span class="subst">$&#123;<span class="keyword">typeof</span> Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(strrr)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> res = mac0.<span class="title function_">doFinal</span>(bytes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> s6 = <span class="title class_">Base64</span>.<span class="title function_">encodeToString</span>(res, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 确保 s6 和 v 是正确的 Java 字符串</span></span><br><span class="line">    <span class="keyword">var</span> pair = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Pair&quot;</span>).$new(</span><br><span class="line">        s6, v);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`MySig: <span class="subst">$&#123;pair.first&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> pair;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_dlopen)</span><br></pre></td></tr></table></figure>

<p>其中，有一个问题，如下代码卡了我很久。在我眼中，这里的strrr一定是一个js代理java的String类型，是一个属于java的字符串，但被frida自动转换成了JavaScript字符串，而JS字符串没有getBytes函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stringBuilder0.<span class="title function_">toString</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> strrr = stringBuilder0.<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> bytes = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(strrr).<span class="title function_">getBytes</span>();</span><br><span class="line"><span class="comment">// 原本写的是strrr.getBytes()</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://reverseengineering.stackexchange.com/questions/32790/convert-string-to-byte-array-in-frida-js-script">https://reverseengineering.stackexchange.com/questions/32790/convert-string-to-byte-array-in-frida-js-script</a></p>
<p>通过js的函数，typeof去查看区别，可以发现stringBuilder0.toString()的类型是string，而Java.use(“java.lang.String”).$new(strrr)的类型是object。</p>
<p><img src="/./assets/image-20250313175050250.png" alt="image-20250313175050250"></p>
<p>至此，脚本也算是跑出了_sig签名。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/v380pro-apk%E7%9A%84%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/v380pro-apk%E7%9A%84%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">v380pro apk的分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:18:46 / 修改时间：17:20:07" itemprop="dateCreated datePublished" datetime="2025-05-18T17:18:46+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>436</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="v380摄像头的apk某加密数据包分析"><a href="#v380摄像头的apk某加密数据包分析" class="headerlink" title="v380摄像头的apk某加密数据包分析"></a>v380摄像头的apk某加密数据包分析</h1><p>先展示成果，原始数据内容通过了gzip压缩、AES（CBC模式）加密、base64编码，反过来就可以进行解密了。</p>
<p><img src="/./assets/440bb350e19efe0a1875d507dca14c85_.png" alt="440bb350e19efe0a1875d507dca14c85_"></p>
<p>先通过r0capture查看函数调用栈，然后在几个关键函数处，hook下来，打印对象值，看看具体是哪一块进行加密。发现call到a的过程中有一个加密。</p>
<p><img src="/./assets/ea4f083bd8f337a6af2f47321cec2ed9_.png" alt="ea4f083bd8f337a6af2f47321cec2ed9_"></p>
<p>由于call函数的过程，涉及很多对象的初始化，数据其实也在其中进行初始化了，很难分析。</p>
<p><img src="/./assets/44a00f659e44e8aed78903fb2f2eb975_.png" alt="44a00f659e44e8aed78903fb2f2eb975_"></p>
<p>这里因为打印某些对象的值（gson包），发现了加密后data属于BodyRequest的成员变量j。</p>
<p><img src="/./assets/0cbae3daf4b83043c88619535bff848b_.png" alt="0cbae3daf4b83043c88619535bff848b_"></p>
<p>追踪这个j。</p>
<p><img src="/./assets/709b8770f19f671dfa0b002c16daf2a7_.png" alt="709b8770f19f671dfa0b002c16daf2a7_"></p>
<p>判断j的赋值在Api.c(api)。这里又可以看到j的值由api.k得到的。</p>
<p><img src="/./assets/d4c09d3ffc515fa4654fbace709f3983_.png" alt="d4c09d3ffc515fa4654fbace709f3983_"></p>
<p>继续追踪k。</p>
<p><img src="/./assets/0896cd869b7a3d63589fd05f418c88c5_.png" alt="0896cd869b7a3d63589fd05f418c88c5_"></p>
<p><img src="/./assets/image-20250324104835752.png" alt="image-20250324104835752"></p>
<p><img src="/./assets/1d2f14a451e917fbeb8602ade035485e_.png" alt="1d2f14a451e917fbeb8602ade035485e_"></p>
<p>搜索了一下，Kalle是一个开源sdk，body函数是用来填充负载部分的。</p>
<p><img src="/./assets/3e69a42994b597b0ae4483e739d98f1b_.png" alt="3e69a42994b597b0ae4483e739d98f1b_"></p>
<p><img src="/./assets/b2cea87c97f306d4dd4b4125a2ad7f34_.png" alt="b2cea87c97f306d4dd4b4125a2ad7f34_"></p>
<p>这里很容易就知道AES_KEY和IV。</p>
<p><img src="/./assets/81a77f0fba59b744b843db4d595f8c6a_.png" alt="81a77f0fba59b744b843db4d595f8c6a_"></p>
<p>直接用工具。</p>
<img src="./assets/68c71f761cc84d618bc4a69b93defa06_.png" alt="68c71f761cc84d618bc4a69b93defa06_" style="zoom:67%;" />

<p>如果要尝试使用分析libapk0000.so，我觉得可以解密字符串，然后进行dump下来查看，大概就可以判断加密模式了，如果是自定义的加密模式，那可能真要逆向了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/r2pay-v0-9%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/r2pay-v0-9%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">r2pay-v0.9分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:17:28 / 修改时间：17:18:17" itemprop="dateCreated datePublished" datetime="2025-05-18T17:17:28+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>18k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>32 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="r2pay-v0-9-apk"><a href="#r2pay-v0-9-apk" class="headerlink" title="r2pay-v0.9.apk"></a>r2pay-v0.9.apk</h1><p>安装完后，一打开就闪退。</p>
<p>通过adb logcat查看日志，筛选中下面的日志记录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">02-28 10:34:38.788 11795 11795 I Magisk  : zygisk64: [re.pwnme] is on the denylist</span><br><span class="line">02-28 10:34:38.823 11795 11795 I re.pwnme: Late-enabling -Xcheck:jni</span><br><span class="line">02-28 10:34:38.845  1187  1204 I adbd    : jdwp connection from 11795</span><br><span class="line">02-28 10:34:38.867 11795 11795 D ProcessState: Binder ioctl to enable oneway spam detection failed: Invalid argument</span><br><span class="line">02-28 10:34:38.785     0     0 I binder  : 11795:11795 ioctl 40046210 7fe5e224b4 returned -22</span><br><span class="line">02-28 10:34:38.881 11795 11795 D CompatibilityChangeReporter: Compat change id reported: 171979766; UID 10137; state: DISABLED</span><br><span class="line">02-28 10:34:38.887 11795 11795 D ApplicationLoaders: Returning zygote-cached class loader: /system/framework/android.test.base.jar</span><br><span class="line">02-28 10:34:38.909 11795 11795 V GraphicsEnvironment: ANGLE Developer option for &#x27;re.pwnme&#x27; set to: &#x27;default&#x27;</span><br><span class="line">02-28 10:34:38.909 11795 11795 V GraphicsEnvironment: ANGLE GameManagerService for re.pwnme: false</span><br><span class="line">02-28 10:34:38.909 11795 11795 V GraphicsEnvironment: Neither updatable production driver nor prerelease driver is supported.</span><br><span class="line">02-28 10:34:38.911 11795 11795 D NetworkSecurityConfig: No Network Security Config specified, using platform default</span><br><span class="line">02-28 10:34:38.912 11795 11795 D NetworkSecurityConfig: No Network Security Config specified, using platform default</span><br><span class="line">02-28 10:34:39.391  2400  3117 W FrameTracker: Missing HWUI jank callback for vsyncId: 84855</span><br><span class="line">02-28 10:34:39.612 11795 11795 W re.pwnme: type=1400 audit(0.0:371): avc: denied &#123; read &#125; for name=&quot;cache&quot; dev=&quot;sda14&quot; ino=16 scontext=u:r:untrusted_app_29:s0:c137,c256,c512,c768 tcontext=u:object_r:cache_file:s0 tclass=lnk_file permissive=0 app=re.pwnme</span><br><span class="line">02-28 10:34:39.612 11795 11795 W re.pwnme: type=1400 audit(0.0:372): avc: denied &#123; read &#125; for name=&quot;cache&quot; dev=&quot;sda14&quot; ino=16 scontext=u:r:untrusted_app_29:s0:c137,c256,c512,c768 tcontext=u:object_r:cache_file:s0 tclass=lnk_file permissive=0 app=re.pwnme</span><br><span class="line">02-28 10:34:39.612 11795 11795 W re.pwnme: type=1400 audit(0.0:373): avc: denied &#123; read &#125; for name=&quot;cache&quot; dev=&quot;sda14&quot; ino=16 scontext=u:r:untrusted_app_29:s0:c137,c256,c512,c768 tcontext=u:object_r:cache_file:s0 tclass=lnk_file permissive=0 app=re.pwnme</span><br><span class="line">02-28 10:34:39.678 11795 11795 W re.pwnme: Accessing hidden method Landroid/view/View;-&gt;computeFitSystemWindows(Landroid/graphics/Rect;Landroid/graphics/Rect;)Z (unsupported, reflection, allowed)</span><br><span class="line">02-28 10:34:39.678 11795 11795 W re.pwnme: Accessing hidden method Landroid/view/ViewGroup;-&gt;makeOptionalFitsSystemWindows()V (unsupported, reflection, allowed)</span><br><span class="line">02-28 10:34:39.725 11795 11795 E RootBeer: b: a() [249] - com.topjohnwu.magisk ROOT management app detected!</span><br><span class="line">02-28 10:34:39.725 11795 11795 E QLog    : b: a() [249] - com.topjohnwu.magisk ROOT management app detected!</span><br><span class="line">02-28 10:34:39.726 11795 11795 D AndroidRuntime: Shutting down VM</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime: FATAL EXCEPTION: main</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime: Process: re.pwnme, PID: 11795</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime: java.lang.RuntimeException: Unable to start activity ComponentInfo&#123;re.pwnme/re.pwnme.MainActivity&#125;: java.lang.ArithmeticException: divide by zero</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:3707)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:3864)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:103)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:135)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:95)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.ActivityThread$H.handleMessage(ActivityThread.java:2253)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.os.Looper.loopOnce(Looper.java:201)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.os.Looper.loop(Looper.java:288)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.ActivityThread.main(ActivityThread.java:7870)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:548)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:1003)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime: Caused by: java.lang.ArithmeticException: divide by zero</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at re.pwnme.MainActivity.onCreate(SourceFile:38)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.Activity.performCreate(Activity.java:8057)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.Activity.performCreate(Activity.java:8037)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1341)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:3688)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        ... 12 more</span><br><span class="line">02-28 10:34:39.730  1045 11817 I DropBoxManagerService: add tag=data_app_crash isTagEnabled=true flags=0x2</span><br><span class="line">02-28 10:34:39.730  1045  5059 W ActivityTaskManager:   Force finishing activity re.pwnme/.MainActivity</span><br><span class="line">02-28 10:34:39.737 11795 11795 I Process : Sending signal. PID: 11795 SIG: 9</span><br></pre></td></tr></table></figure>

<p>我把日志丢给grok进行分析，似乎是调用了RootBeer库进行root检测，发现了magisk，因此退出了。</p>
<img src="./assets/image-20250228132546057.png" alt="image-20250228132546057" style="zoom:80%;" />

<p>尝试搜索字符串 ROOT management app detected，这里的try catch就是用来检测root的，如果读包错误，就说明这个包不存在，不做任何处理；如果读到“危险”包，就会继续执行b.a.a.c.a.a，并将result置为true。</p>
<img src="./assets/image-20250228134713528.png" alt="image-20250228134713528" style="zoom:67%;" />

<p>追踪b.a.a.c.a.a进去看一下，发现就写了一个Log.e。</p>
<p><img src="/./assets/image-20250228140326772.png" alt="image-20250228140326772"></p>
<p>查看方法b.a.a.b.a(List )的调用。</p>
<img src="./assets/image-20250228140623670.png" alt="image-20250228140623670" style="zoom: 80%;" />

<p>Index为0的方法b.a.a.b.a(String[] )如下，属于重载，可以看到，这里只是将字符串加入到packages里，并调用b.a.a.b.a(List )。</p>
<p><img src="/./assets/image-20250228140601697.png" alt="image-20250228140601697"></p>
<p>而Index为1的方法b.a.a.b.b(String[] )如下，它调用了b.a.a.b.a(String[] )。</p>
<p><img src="/./assets/image-20250228141911196.png" alt="image-20250228141911196"></p>
<p>之后又一直查看引用，找到b.a.a.j()，这里做了一堆检查root的内容。</p>
<img src="./assets/image-20250228142312579.png" alt="image-20250228142312579" style="zoom:80%;" />

<p>不如直接将函数j给hook了，也省得hook其它这么多函数，我观察了一下众多this.X，发现其中的this.e不仅仅在j()被调用，还在其它地方被调用。</p>
<p>总结了一下，需要hook的函数如下：</p>
<p>b.a.a.a()&#x2F;b.a.a.j()&#x2F;b.a.a.e()。</p>
<p>首先hook方法a，一般来说，可以根据参数列表不同hook特定的、存在同名的方法，但这里要hook的方法a属于无参方法，而且存在两个无参方法a。</p>
<p>下面是我找ds-r1生成的，不知道行不行得通，看得挺靠谱的，根据返回值类型来判断。（事后发现下面的脚本用不了，别学，这里作为错误示范）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> targetClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;b.a.a.b&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> methods = targetClass.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line">    </span><br><span class="line">    methods.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">method</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.<span class="title function_">getName</span>() === <span class="string">&quot;a&quot;</span> &amp;&amp; method.<span class="title function_">getParameterTypes</span>().<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> returnType = method.<span class="title function_">getReturnType</span>().<span class="title function_">getName</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Hook返回boolean的a方法</span></span><br><span class="line">            <span class="keyword">if</span> (returnType === <span class="string">&quot;boolean&quot;</span>) &#123;</span><br><span class="line">                method.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked boolean a() method&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Hook返回String数组的a方法</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (returnType === <span class="string">&quot;[Ljava.lang.String;&quot;</span>) &#123;</span><br><span class="line">                method.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked String[] a() method&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>不过既然要hook的方法都在b.a.a类中，不妨直接将hook的方法补充进上面这个脚本里，执行后，又闪退了，不过这回查看日志，并没看到之前的那几条记录了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">02-28 15:10:41.848  4531  4531 I crash_dump64: obtaining output fd from tombstoned, type: kDebuggerdTombstoneProto</span><br><span class="line">02-28 15:10:41.849   655   655 I tombstoned: received crash request for pid 4528</span><br><span class="line">02-28 15:10:41.850  4531  4531 I crash_dump64: performing dump of process 4498 (target tid = 4528)</span><br><span class="line">02-28 15:10:41.871  4531  4531 E DEBUG   : failed to read /proc/uptime: Permission denied</span><br><span class="line">02-28 15:10:42.485     0     0 I logd    : logdr: UID=10137 GID=10137 PID=4531 n tail=0 logMask=8 pid=4498 start=0ns deadline=0ns</span><br><span class="line">02-28 15:10:42.486     0     0 I logd    : logdr: UID=10137 GID=10137 PID=4531 n tail=0 logMask=1 pid=4498 start=0ns deadline=0ns</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : Build fingerprint: &#x27;OnePlus/OnePlus6/OnePlus6:8.1.0/OPM1.171019.011/06140300:user/release-keys&#x27;</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : Revision: &#x27;0&#x27;</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : ABI: &#x27;arm64&#x27;</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : Timestamp: 2025-02-28 15:10:41.870217324+0800</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : Process uptime: 0s</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : Cmdline: com.google.android.videos</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : pid: 4498, tid: 4528, name: re.pwnme  &gt;&gt;&gt; com.google.android.videos &lt;&lt;&lt;</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : uid: 10137</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0xfaba4975</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   :     x0  0000006fe4986670  x1  000000730a2a77cc  x2  00000071ceef6220  x3  0000006fe4986618</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   :     x4  00000000000010b0  x5  0000000000000001  x6  0000000000000000  x7  0000000000000000</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   :     x8  00000000000035b2  x9  00000000faba4975  x10 000000008ef93fe9  x11 000000006df6246c</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   :     x12 0000000000000001  x13 00000000fffffff6  x14 00000000cf86a786  x15 0000000000000001</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :     x16 000000730a2911f8  x17 000000730a20db40  x18 0000000000000000  x19 0000006fe4986670</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :     x20 0000000000000000  x21 0000006fe498acb0  x22 0000000000001192  x23 0000000000001192</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :     x24 0000006fe498acb0  x25 0000006fe498acb0  x26 0000006fe498aff8  x27 00000000000fc000</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :     x28 0000006fe4892000  x29 0000006fe498ac40</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :     lr  0000006fdffa2668  sp  0000006fe4986670  pc  0000006fdfe77f7c  pst 0000000060000000</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   : backtrace:</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :       #00 pc 0000000000038f7c  /data/app/~~IG0Dzbwr_V__IsLZxDqnLA==/re.pwnme-5cCb3aQP1IrcfKWzdCWgYQ==/lib/arm64/libnative-lib.so (BuildId: f87b3bd9fcae36e63939958f412d03a42e0ce406)</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :       #01 pc 00000000000b1810  /apex/com.android.runtime/lib64/bionic/libc.so!libc.so (__pthread_start(void*)+264) (BuildId: 6bfaf10f10e5ff343703efae2f1bdbdb)</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :       #02 pc 00000000000512f0  /apex/com.android.runtime/lib64/bionic/libc.so!libc.so (__start_thread+64) (BuildId: 6bfaf10f10e5ff343703efae2f1bdbdb)</span><br></pre></td></tr></table></figure>

<p>查看调用栈，锁定在libnative-lib.so，偏移量是38f7c，用ida打开后，访问那块地址，结果说函数太大，无法进行f5，没辙了，没啥思绪了，看看博客。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_61253776/article/details/140026070">https://blog.csdn.net/qq_61253776/article/details/140026070</a></p>
<p>看来我的第一步分析是正确的，将函数j a e进行了hook，避免了java层的检测，但so层好难。</p>
<p>接下来找博客一步一步做了。</p>
<p>So层的检测针对了root权限和frida注入，下面主要写分析过程。</p>
<p>在re.pwnme.MainActivity类中，静态初始化块加载了native-lib，</p>
<img src="./assets/image-20250304081920396.png" alt="image-20250304081920396" style="zoom: 80%;" />

<p>然后声明了其中的一个native函数并用于MainActivity的页面代码中。</p>
<img src="./assets/image-20250304082019387.png" alt="image-20250304082019387" style="zoom:80%;" />

<p>通过ida观察libnative-lib.so的export表，导出函数和全局变量都被加密了。</p>
<p><img src="/./assets/image-20250304082137127.png" alt="image-20250304082137127"></p>
<p>点开.datadiv_decodexxxxxx，大部分这类函数只写了一个RET，对应的字节码是C0 03 5F D6。</p>
<p><img src="/./assets/image-20250304082448246.png" alt="image-20250304082448246"></p>
<p>根据观察，其中的函数datadiv_decode4432700155380705947，它存在函数体，并且大部分操作似乎在做解密。大部分资料显示，这里是在做全局字符串的解密操作。</p>
<img src="./assets/image-20250304082642593.png" alt="image-20250304082642593" style="zoom:80%;" />

<p>除此之外，在.init_array段中，存在两个拥有函数体的函数，它们无法f5，反编译成c。</p>
<p><img src="/./assets/image-20250304082900458.png" alt="image-20250304082900458"></p>
<img src="./assets/image-20250304082937873.png" alt="image-20250304082937873" style="zoom:67%;" />

<p>过了java层后，会在so层的某处断开，地址是38f7c。</p>
<p><img src="/./assets/image-20250304083458534.png" alt="image-20250304083458534"></p>
<p>在ida中来到38f7c，一路跟踪交叉引用，最后判定，这段代码属于sub_83DC。</p>
<p>由于静态无法分析，只能动态分析了，博客中，这里使用了工具QBDI，QBDI是一个动态二进制插桩的DBI框架，可以追踪函数细节，如果只用frida的话，只能看到函数调用前的参数和调用后的结果。</p>
<p>但QBDI咋用啊，wtf，教程也太少了。</p>
<hr>
<p>时隔多天，在分析完豆瓣后，再次看看这个apk如何分析。</p>
<p>在分析豆瓣的过程中，学会了找退出点的一些方法。</p>
<p>比如：hook函数pthread_create，线程在跑起来后，如果是检测frida的线程，就会杀死frida，所以可以观察哪个线程跑起来后，导致frida退出了。因为libc.so是系统库，加载先于frida的spawn模式，无需担心过早hook。</p>
<p>对应的检测线程脚本如下，不是直接复制就能用，这里放在这仅供参考：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hook_linker_call_constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 打印模块信息</span></span><br><span class="line">            <span class="keyword">if</span> (libnative_module) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Module name: &quot;</span> + libnative_module.<span class="property">name</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Base address: 0x&quot;</span> + libnative_module.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Size: &quot;</span> + libnative_module.<span class="property">size</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Path: &quot;</span> + libnative_module.<span class="property">path</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="title function_">check_pthread_create</span>(libnative_module.<span class="property">base</span>);</span><br><span class="line">                <span class="comment">//hook_20954();</span></span><br><span class="line">                <span class="comment">//hook_7a660();</span></span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check_pthread_create</span>(<span class="params">baseaddr</span>)&#123;</span><br><span class="line">    <span class="comment">/* 找到函数pthread_create的地址 */</span></span><br><span class="line">    <span class="keyword">var</span> pthread_create = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pthread_create)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is exist&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is not exist&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* hook */</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is called&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg2: 0x&quot;</span> + (args[<span class="number">2</span>] - baseaddr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后应该就会看到几个函数的地址，然后尝试hook它们。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_20954</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(libnative_module.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x20954</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_20954 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_7a660</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(libnative_module.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x7a660</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_7a660 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再次跑frida脚本，发现提示除以0的报错，这个报错不是在之前的java层解决了吗？</p>
<p>下面<strong>这个脚本是错的</strong>，是我早期通过deepseek生成的，我还以为能用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_java</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> targetClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;b.a.a.b&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> methods = targetClass.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Methods found in b.a.a.b:&quot;</span>);</span><br><span class="line">        methods.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">method</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (method.<span class="title function_">getName</span>() === <span class="string">&quot;a&quot;</span> &amp;&amp; method.<span class="title function_">getParameterTypes</span>().<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> returnType = method.<span class="title function_">getReturnType</span>().<span class="title function_">getName</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Return type: &quot;</span> + <span class="keyword">typeof</span> returnType + <span class="string">&quot;, value: &quot;</span> + returnType);</span><br><span class="line">                <span class="keyword">if</span> (returnType === <span class="string">&quot;boolean&quot;</span>) &#123;</span><br><span class="line">                    method.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b.a.a.b.a() is called, res = &quot;</span>, <span class="variable language_">this</span>.<span class="title function_">a</span>());</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked boolean a() method&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (method.<span class="title function_">getName</span>() === <span class="string">&quot;j&quot;</span> &amp;&amp; method.<span class="title function_">getParameterTypes</span>().<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> returnType = method.<span class="title function_">getReturnType</span>().<span class="title function_">getName</span>();</span><br><span class="line">                <span class="keyword">if</span> (returnType === <span class="string">&quot;boolean&quot;</span>) &#123;</span><br><span class="line">                    method.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b.a.a.b.j() is called, res = &quot;</span>, <span class="variable language_">this</span>.<span class="title function_">j</span>());</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked boolean j() method&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (method.<span class="title function_">getName</span>() === <span class="string">&quot;e&quot;</span> &amp;&amp; method.<span class="title function_">getParameterTypes</span>().<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> returnType = method.<span class="title function_">getReturnType</span>().<span class="title function_">getName</span>();</span><br><span class="line">                <span class="keyword">if</span> (returnType === <span class="string">&quot;boolean&quot;</span>) &#123;</span><br><span class="line">                    method.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b.a.a.b.e() is called, res = &quot;</span>, <span class="variable language_">this</span>.<span class="title function_">e</span>());</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked boolean e() method&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将它修改成正常的、简单的脚本。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_java</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">var</span> targetClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;b.a.a.b&quot;</span>); </span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">a</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.a()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 强制返回 false</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">j</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.j()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">e</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.e()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后整理出来的脚本如下，执行完后能正常跑apk了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_java</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">var</span> targetClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;b.a.a.b&quot;</span>); </span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">a</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.a()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 强制返回 false</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">j</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.j()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">e</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.e()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hook_linker_call_constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 打印模块信息</span></span><br><span class="line">            <span class="keyword">if</span> (libnative_module) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Module name: &quot;</span> + libnative_module.<span class="property">name</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Base address: 0x&quot;</span> + libnative_module.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Size: &quot;</span> + libnative_module.<span class="property">size</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Path: &quot;</span> + libnative_module.<span class="property">path</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="title function_">check_pthread_create</span>(libnative_module.<span class="property">base</span>);</span><br><span class="line">                <span class="title function_">hook_20954</span>();</span><br><span class="line">                <span class="title function_">hook_7a660</span>();</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check_pthread_create</span>(<span class="params">baseaddr</span>)&#123;</span><br><span class="line">    <span class="comment">/* 找到函数pthread_create的地址 */</span></span><br><span class="line">    <span class="keyword">var</span> pthread_create = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pthread_create)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is exist&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is not exist&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* hook */</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is called&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg2: 0x&quot;</span> + (args[<span class="number">2</span>] - baseaddr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_20954</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(libnative_module.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x20954</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_20954 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_7a660</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(libnative_module.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x7a660</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_7a660 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Avoid_divide_by_zero</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> b = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;b.a.a.b&quot;</span>);</span><br><span class="line">    b[<span class="string">&quot;j&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">hook_linker_call_constructors</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_java);</span><br></pre></td></tr></table></figure>

<p>成功在豆瓣进修，hhhhhh。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/UnCrackable-Level3%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/UnCrackable-Level3%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">UnCrackable-Level3分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:16:25 / 修改时间：17:17:05" itemprop="dateCreated datePublished" datetime="2025-05-18T17:16:25+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="UnCrackable-Level3-apk"><a href="#UnCrackable-Level3-apk" class="headerlink" title="UnCrackable-Level3.apk"></a>UnCrackable-Level3.apk</h1><p>照常，安装并打开，被检测到了root，通过magisk进行root权限的隐藏。</p>
<p>之后还是输入正确的密码。</p>
<img src="./assets/image-20250226195340118.png" alt="image-20250226195340118" style="zoom:50%;" />

<p>在输入错误的Secret后，会提示Nope…That’s not it. Try again.</p>
<p>在Jeb中搜索这个字符串，发现关键点在check_code上。</p>
<img src="./assets/image-20250226195531902.png" alt="image-20250226195531902" style="zoom:67%;" />

<p>check_code调用了native层函数bar。</p>
<img src="./assets/image-20250226195605177.png" alt="image-20250226195605177" style="zoom:67%;" />

<p>在ida中，检索函数bar，一个很明显的xor解密，密钥的长度为24。</p>
<p><img src="/./assets/image-20250226195656697.png" alt="image-20250226195656697"></p>
<p>为了获得正确的secret，需要将v8和qword_15038进行xor运算，得到最终的结果。</p>
<p>不难看出，v8的值来自于sub_10E0，这里考虑对sub_10E0进行hook，然后查看v8的值。</p>
<p>结果hook的过程遇到了反frida的检测，可以根据报错的调用栈定位到goodbye函数。</p>
<img src="./assets/image-20250226195957335.png" alt="image-20250226195957335" style="zoom:67%;" />

<p>追溯到源头，发现在sub_30D0处，调用了goodbye()，检测的逻辑是，通过读取映射到内存的文件名，只要发现frida等字段就退出。</p>
<img src="./assets/image-20250226200242118.png" alt="image-20250226200242118" style="zoom:80%;" />

<p>为了能够正常使用frida进行hook，有以下几种hook的方式，绕过反frida。</p>
<p>1.hook函数sub_30D0。</p>
<p>2.hook函数strstr。</p>
<p>Ⅰ.先讲hook sub_30D0：观察过函数sub_30D0，发现它被写在了.init_array节里，这个节里面的函数，会在库加载的时候依次被调用，因此，如果想要hook这个函数，必须在System.loadLibray执行过程中——因为执行完后，frida就hook不了了；而若是还没执行，libfoo.so还没加载，当然hook不了。</p>
<p>查阅了相关博客，so层的.init_array节里的函数，都是被模块linker64中的call_array调用的，所以要hook函数call_array，当下的核心目标是获得call_array在模块linker64中的偏移量。（方法随意，可以直接在ida中进行查看）</p>
<p>在hook后，流程变成：遇到加载的so是libfoo.so，在完成了内存映射后，call_array还没有执行，这个时候去修改内存中sub_30D0的内容，之后正常执行call_array。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取linker64模块的基地址</span></span><br><span class="line">    <span class="keyword">var</span> linker64_module = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&quot;linker64&quot;</span>);</span><br><span class="line">    <span class="comment">//使用拦截器附加linker64模块的偏移地址</span></span><br><span class="line">    <span class="comment">// 7D68B58764 - 7D68B38000 = 0x20764</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(linker64_module.<span class="title function_">add</span>(<span class="number">0x20764</span>),&#123;</span><br><span class="line">        <span class="comment">// 进入函数，代码检查参数args[3]指向的字符串是否匹配libfoo.so</span></span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span>(args[<span class="number">0</span>].<span class="title function_">readCString</span>().<span class="title function_">match</span>(<span class="string">&quot;libfoo.so&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// 获取libfoo.so的基地址</span></span><br><span class="line">                <span class="keyword">var</span> libfoo_module  = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libfoo.so&#x27;</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;获取libfoo.so的基地址==&gt;&quot;</span>+libfoo_module)</span><br><span class="line">                <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(libfoo_module.<span class="title function_">add</span>(<span class="number">0x30D0</span>),<span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;,<span class="string">&#x27;void&#x27;</span>,[]));</span><br><span class="line">           &#125;</span><br><span class="line">    &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">result</span>)&#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Ⅱ.hook strstr就比较简单，判断strstr的第1个参数里有没有frida字段，如果有，之后的返回值直接强制返回。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 反frida检测</span></span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;strstr&quot;</span>), &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">haystack</span> = args[<span class="number">0</span>];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">needle</span> = args[<span class="number">1</span>];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">frida</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法 1：使用 readCString（自动处理 NULL 结尾）</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> haystack = <span class="variable language_">this</span>.<span class="property">haystack</span>.<span class="title function_">isNull</span>() ? <span class="string">&quot;&quot;</span> : <span class="variable language_">this</span>.<span class="property">haystack</span>.<span class="title function_">readCString</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (haystack &amp;&amp; (haystack.<span class="title function_">includes</span>(<span class="string">&quot;frida&quot;</span>) || haystack.<span class="title function_">includes</span>(<span class="string">&quot;xposed&quot;</span>))) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">frida</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;读取字符串失败:&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">frida</span>) &#123;</span><br><span class="line">            retval.<span class="title function_">replace</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>ok，在解决了反frida后，继续对之前提到的sub_10E0进行解密，由于这个函数没有返回值，可以判断：这个函数会在v8所指向的地址处，修改24个字节。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">function</span> <span class="title function_">hookXor</span>(<span class="params"></span>)&#123;</span><br><span class="line">           <span class="comment">// hook xor的其中一个key</span></span><br><span class="line">       <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>((<span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libfoo.so&quot;</span>)).<span class="title function_">add</span>(<span class="string">&quot;0x010E0&quot;</span>), &#123;</span><br><span class="line">           <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">               <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;onEnter: hook xor key&quot;</span>);</span><br><span class="line">               <span class="variable language_">this</span>.<span class="property">key</span> = args[<span class="number">0</span>];</span><br><span class="line">           &#125;, </span><br><span class="line">       </span><br><span class="line">           <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">               <span class="keyword">var</span> key_ = <span class="keyword">new</span> <span class="title class_">NativePointer</span>(<span class="variable language_">this</span>.<span class="property">key</span>);</span><br><span class="line">               <span class="keyword">var</span> arr = key_.<span class="title function_">readByteArray</span>(<span class="number">24</span>);</span><br><span class="line">               <span class="variable language_">console</span>.<span class="title function_">log</span>(arr);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="built_in">setTimeout</span>(hookXor, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>这里为了避免hookXor未执行，特意延迟了1000ms再进行注入（方法比较简单）。</p>
<p>还有其它方法，在保证加载了libfoo.so后立马进行hook，而不用等待1000ms。（同样是在加载器上做文章，不过这里hook的是System.loadLibrary）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">System</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.System&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Runtime</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">SystemLoad</span>_2 = <span class="title class_">System</span>.<span class="property">loadLibrary</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">VMStack</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;dalvik.system.VMStack&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">SystemLoad</span>_2.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">library</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Loading dynamic library =&gt; &quot;</span> + library);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> loaded =     <span class="title class_">Runtime</span>.<span class="title function_">getRuntime</span>().<span class="title function_">loadLibrary0</span>( <span class="title class_">VMStack</span>.<span class="title function_">getCallingClassLoader</span>(), library);</span><br><span class="line">          <span class="keyword">if</span>(library.<span class="title function_">includes</span>(<span class="string">&quot;foo&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">//function that gets the xored value </span></span><br><span class="line">            <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libfoo.so&quot;</span>).<span class="title function_">add</span>(<span class="string">&#x27;0x00000fa0&#x27;</span>),&#123;</span><br><span class="line">              <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;getting other_key value&quot;</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">other_key_address</span> = args[<span class="number">0</span>];</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> other_key = <span class="keyword">new</span> <span class="title class_">NativePointer</span>(<span class="variable language_">this</span>.<span class="property">other_key_address</span>);</span><br><span class="line">                <span class="keyword">var</span> arr = other_key.<span class="title function_">readByteArray</span>(<span class="number">24</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(arr);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> loaded;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(ex) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(ex);</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(ex.<span class="property">stack</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>最后得到的结果如下，即：1d 08 11 13…</p>
<img src="./assets/image-20250226204101246.png" alt="image-20250226204101246" style="zoom:80%;" />

<p>同时，另一个密钥key是qword_15038，追踪后，发现是通过init函数进行初始化的，这个函数是一个jni函数，根据代码，可以发现它的值由java层传递。</p>
<p><img src="/./assets/image-20250226204325745.png" alt="image-20250226204325745"></p>
<p>因此，另一个key的值是pizzapizzapizzapizzapizz。</p>
<img src="./assets/image-20250226204444346.png" alt="image-20250226204444346" style="zoom:80%;" />

<p>将两者做异或运算。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">xor_bytes</span>(<span class="params">str1, bytes2</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    对两个24字节的数据进行逐字节的异或运算。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">    str1: 长度为24字节的字符串</span></span><br><span class="line"><span class="string">    bytes2: 长度为24字节的字节数组</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">    result: 异或运算后的字节数组</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 确保输入长度为24字节</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(str1) != <span class="number">24</span> <span class="keyword">or</span> <span class="built_in">len</span>(bytes2) != <span class="number">24</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;输入必须是24字节长&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将字符串转换为字节数组</span></span><br><span class="line">    bytes1 = str1.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 进行逐字节的异或运算</span></span><br><span class="line">    result = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> b1, b2 <span class="keyword">in</span> <span class="built_in">zip</span>(bytes1, bytes2):</span><br><span class="line">        result.append(b1 ^ b2)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例用法</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 输入字符串和字节数组</span></span><br><span class="line">    str_input = <span class="string">&quot;pizzapizzapizzapizzapizz&quot;</span>  <span class="comment"># 24字节字符串</span></span><br><span class="line">    bytes_input = <span class="built_in">bytes</span>([<span class="number">0x1d</span>, <span class="number">0x08</span>, <span class="number">0x11</span>, <span class="number">0x13</span>, <span class="number">0x0f</span>, <span class="number">0x17</span>, <span class="number">0x49</span>, <span class="number">0x15</span>, <span class="number">0x0d</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x19</span>, <span class="number">0x5a</span>, <span class="number">0x1d</span>, <span class="number">0x13</span>, <span class="number">0x15</span>, <span class="number">0x08</span>, <span class="number">0x0e</span>, <span class="number">0x5a</span>, <span class="number">0x00</span>, <span class="number">0x17</span>, <span class="number">0x08</span>, <span class="number">0x13</span>, <span class="number">0x14</span>])  <span class="comment"># 24字节的字节数组 [0, 1, 2, ..., 23]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 执行异或运算</span></span><br><span class="line">    result = xor_bytes(str_input, bytes_input)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出结果</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;异或运算结果:&quot;</span>, result)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;十六进制表示:&quot;</span>, result.<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>

<img src="./assets/image-20250226205334111.png" alt="image-20250226205334111" style="zoom:67%;" />

<p>阿这，这个解密出来的结果有点6。</p>
<img src="./assets/image-20250226205420426.png" alt="image-20250226205420426" style="zoom:67%;" />

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/UnCrackable-Level2%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/UnCrackable-Level2%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">UnCrackable-Level2分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:15:48 / 修改时间：17:16:16" itemprop="dateCreated datePublished" datetime="2025-05-18T17:15:48+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="UnCrackable-Level2-apk"><a href="#UnCrackable-Level2-apk" class="headerlink" title="UnCrackable-Level2.apk"></a>UnCrackable-Level2.apk</h1><p>直接安装+打开，又是解密。</p>
<img src="./assets/image-20250224185514939.png" alt="image-20250224185514939" style="zoom:67%;" />

<p>搜索Nope，定位到this.m.a(s)。</p>
<img src="./assets/image-20250224185646063.png" alt="image-20250224185646063" style="zoom:67%;" />

<p>在类MainActivity中，有一个私有对象m，m属于类CodeCheck，调用了函数a，最后调用了native层函数bar。</p>
<img src="./assets/image-20250224185828483.png" alt="image-20250224185828483" style="zoom:67%;" />

<p>native层需要ida进行静态分析，这里将apk进行解压，取出其中的arm64架构的so库放入ida中，可以看到两个导出函数。</p>
<p>Java_包名_类名_函数名，可以看出bar就是我们要找的函数。</p>
<p><img src="/./assets/image-20250224190249451.png" alt="image-20250224190249451"></p>
<p>一眼看出，v7对应的字符串就是正确的secret。</p>
<img src="./assets/image-20250224191818314.png" alt="image-20250224191818314" style="zoom:67%;" />

<p>再看看导出的init函数，这里ida并没有给出JNIEnv和jobect，应该是反编译失误——这俩参数没用到，可能被优化了。</p>
<img src="./assets/image-20250224192734132.png" alt="image-20250224192734132" style="zoom:80%;" />

<p>在sub_918中，可以发现：fork出子进程，然后子进程通过ptrace附加到父进程，使得父进程无法其它调试器被再次附加，一个反调试技术。</p>
<img src="./assets/image-20250224193151757.png" alt="image-20250224193151757" style="zoom:67%;" />

<p>Frida通过Interceptor模块，可以支持对Native层函数的hook。</p>
<p>下面这个脚本，先通过Module.findBaseAddress找到so模块的基地址，然后通过导出表符号Java_sg_vantagepoint_uncrackable2_MainActivity_init，找到它的函数地址，然后根据在文件中计算的文件偏移量，计算出要hook的无符号函数的地址。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">LIB_NAME</span> = <span class="string">&#x27;libfoo.so&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">EXPORT_SYMBOL</span> = <span class="string">&#x27;Java_sg_vantagepoint_uncrackable2_MainActivity_init&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">OFFSET</span> = <span class="title function_">ptr</span>(-<span class="number">1140</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">tryHook</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 获得模块基地址</span></span><br><span class="line">        <span class="keyword">const</span> moduleBase = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="variable constant_">LIB_NAME</span>);</span><br><span class="line">        <span class="keyword">if</span> (!moduleBase) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[!] <span class="subst">$&#123;LIB_NAME&#125;</span> 未加载，等待...`</span>);</span><br><span class="line">            <span class="built_in">setTimeout</span>(tryHook, <span class="number">1000</span>); <span class="comment">// 每秒检查一次</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] 模块基地址: <span class="subst">$&#123;moduleBase&#125;</span>`</span>);</span><br><span class="line">        <span class="comment">// 通过符号名获得函数实际地址</span></span><br><span class="line">        <span class="keyword">const</span> exportAddress = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="variable constant_">LIB_NAME</span>, <span class="variable constant_">EXPORT_SYMBOL</span>);</span><br><span class="line">        <span class="keyword">if</span> (!exportAddress) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[!] 未找到导出函数 <span class="subst">$&#123;EXPORT_SYMBOL&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] 导出函数地址: <span class="subst">$&#123;exportAddress&#125;</span>`</span>);</span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 根据偏移计算目标地址</span></span><br><span class="line">        <span class="keyword">const</span> targetAddress = exportAddress.<span class="title function_">add</span>(<span class="variable constant_">OFFSET</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] 目标函数地址: <span class="subst">$&#123;targetAddress&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印目标地址的前5个字节</span></span><br><span class="line">        <span class="keyword">const</span> bytes = <span class="title class_">Memory</span>.<span class="title function_">readByteArray</span>(targetAddress, <span class="number">5</span>);</span><br><span class="line">        <span class="keyword">const</span> byteArray = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(bytes);</span><br><span class="line">        <span class="keyword">const</span> hexBytes = <span class="title class_">Array</span>.<span class="title function_">from</span>(byteArray).<span class="title function_">map</span>(<span class="function"><span class="params">b</span> =&gt;</span> b.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)).<span class="title function_">join</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] 前5个字节: <span class="subst">$&#123;hexBytes&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(targetAddress, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`\n=== 函数调用开始 ===`</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="title class_">Process</span>.<span class="property">arch</span> === <span class="string">&#x27;arm64&#x27;</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`X0: <span class="subst">$&#123;args[<span class="number">0</span>]&#125;</span>, X1: <span class="subst">$&#123;args[<span class="number">1</span>]&#125;</span>, X2: <span class="subst">$&#123;args[<span class="number">2</span>]&#125;</span>`</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`R0: <span class="subst">$&#123;args[<span class="number">0</span>]&#125;</span>, R1: <span class="subst">$&#123;args[<span class="number">1</span>]&#125;</span>, R2: <span class="subst">$&#123;args[<span class="number">2</span>]&#125;</span>`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`返回值: <span class="subst">$&#123;retval&#125;</span>`</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`=== 函数调用结束 ===\n`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[√] Hook 安装成功`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setTimeout</span>(tryHook, <span class="number">1000</span>); <span class="comment">// 延迟1秒开始检查</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>然而还不够，即便hook住了这个函数，但这个函数早已经在MainActivity.onCreate阶段执行了，hook了也没用，因为已经执行过了一遍。</p>
<p>针对执行时机的问题，有以下解决方法：</p>
<p>1.使用spawn模式，默认的frida -U -f是“fork-and-attach”模式，可能错过早期逻辑。使用“spawn”模式可以在应用进程创建时注入Frida。</p>
<p>如：frida -U -l script.js –no-pause -f com.example.app –spawn</p>
<p>–spawn: 在进程创建时注入，而不是附加到已有进程。</p>
<p>2.hook系统类System，然后对loadLibrary做手脚，如果加载的是其它库，不做处理；如果加载的是foo.so，则立马进行覆盖。<strong>这个hook的时机发生在静态初始化块执行之前</strong>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">LIB_NAME</span> = <span class="string">&#x27;libfoo.so&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">EXPORT_SYMBOL</span> = <span class="string">&#x27;Java_sg_vantagepoint_uncrackable2_MainActivity_init&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">OFFSET</span> = <span class="title function_">ptr</span>(-<span class="number">1140</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hook System.loadLibrary</span></span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.System&#x27;</span>).<span class="property">loadLibrary</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">libName</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] 加载库: <span class="subst">$&#123;libName&#125;</span>`</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">loadLibrary</span>(libName); <span class="comment">// 调用原始方法</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (libName === <span class="string">&#x27;foo&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> moduleBase = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="variable constant_">LIB_NAME</span>);</span><br><span class="line">            <span class="keyword">if</span> (!moduleBase) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> exportAddress = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="variable constant_">LIB_NAME</span>, <span class="variable constant_">EXPORT_SYMBOL</span>);</span><br><span class="line">            <span class="keyword">const</span> targetAddress = exportAddress.<span class="title function_">add</span>(<span class="variable constant_">OFFSET</span>);</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(targetAddress, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`sub_918 被调用并覆盖`</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">            &#125;, <span class="string">&#x27;int64&#x27;</span>, []));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[√] sub_918 已替换`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>3.Hook MainActivity.onCreat。</p>
<p>所以接下来这段脚本执行时机如下，在静态初始化块执行后（System.loadLibrary导入libfoo.so），在onCreate执行前（调用Java_sg_vantagepoint_uncrackable2_MainActivity_init之前），hook了类MainActivity，然后在它执行前，将sub_918的内容做了替换。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">LIB_NAME</span> = <span class="string">&#x27;libfoo.so&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">EXPORT_SYMBOL</span> = <span class="string">&#x27;Java_sg_vantagepoint_uncrackable2_MainActivity_init&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">OFFSET</span> = <span class="title function_">ptr</span>(-<span class="number">1140</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">MainActivity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;sg.vantagepoint.uncrackable2.MainActivity&#x27;</span>);</span><br><span class="line">    <span class="title class_">MainActivity</span>.<span class="property">onCreate</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">savedInstanceState</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] MainActivity.onCreate 被调用&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在 onCreate 执行前替换 sub_918</span></span><br><span class="line">        <span class="keyword">const</span> moduleBase = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="variable constant_">LIB_NAME</span>);</span><br><span class="line">        <span class="keyword">if</span> (moduleBase) &#123;</span><br><span class="line">            <span class="keyword">const</span> exportAddress = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="variable constant_">LIB_NAME</span>, <span class="variable constant_">EXPORT_SYMBOL</span>);</span><br><span class="line">            <span class="keyword">const</span> targetAddress = exportAddress.<span class="title function_">add</span>(<span class="variable constant_">OFFSET</span>);</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(targetAddress, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`sub_918 被调用并覆盖`</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">            &#125;, <span class="string">&#x27;int64&#x27;</span>, []));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[√] sub_918 已替换`</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用原始 onCreate</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onCreate</span>(savedInstanceState);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>下图是安卓的初始化过程以及注入时机。</p>
<img src="./assets/image-20250225150528070.png" alt="image-20250225150528070" style="zoom: 67%;" />

<img src="./assets/image-20250225150505066.png" alt="image-20250225150505066" style="zoom:67%;" />

<p>之后尝试一下hook是否执行成功，先将脚本断掉，直接通过jeb调试进程。</p>
<img src="./assets/image-20250225150747031.png" alt="image-20250225150747031" style="zoom:67%;" />

<p>再试试通过frida进行hook后，能否attach上去调试。</p>
<img src="./assets/image-20250225150907624.png" alt="image-20250225150907624" style="zoom:80%;" />

<p>确实是attach上去了，但是手机上显示被检测到了调试，根据字符串搜索，发现问题来自于下图。</p>
<img src="./assets/image-20250225151147999.png" alt="image-20250225151147999" style="zoom:67%;" />

<p>有一个持续检测的进程，阿这，这么防着咱。。。</p>
<p>只需要hook Debug.isDebuggerConnected()即可，让它一直返回false，这里就不写了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/UnCrackable-Level1%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/UnCrackable-Level1%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">UnCrackable-Level1分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:13:45 / 修改时间：17:15:40" itemprop="dateCreated datePublished" datetime="2025-05-18T17:13:45+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="UnCrackable-Level1-apk"><a href="#UnCrackable-Level1-apk" class="headerlink" title="UnCrackable-Level1.apk"></a>UnCrackable-Level1.apk</h1><p>下载并安装，打开；一上来就被检测出root权限了。</p>
<img src="./assets/image-20250224152934808.png" alt="image-20250224152934808" style="zoom:50%;" />

<p>将apk丢入jeb中查看，通过<code>ctrl + f</code>搜索字符串。</p>
<img src="./assets/image-20250224153359358.png" alt="image-20250224153359358" style="zoom: 67%;" />

<p>c.a()、c.b()、c.c()的逻辑如下图，我发现，在我的&#x2F;system&#x2F;bin中，确实有一个su。</p>
<img src="./assets/image-20250224153529149.png" alt="image-20250224153529149" style="zoom:67%;" />

<p>方案1，粗暴的解决方案，修改dex文件并重新签名。在onCreate的第一个if处，将判断结果改成false；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> root = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;sg.vantagepoint.util.RootDetection&quot;</span>);</span><br><span class="line">	root.<span class="property">checkRoot1</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	root.<span class="property">checkRoot2</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	root.<span class="property">checkRoot3</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>方案2，hook掉exit函数或者hook掉相关函数；</p>
<p>方案3，面具magisk里直接屏蔽掉UnCrackable-Level1.apk的root权限，让它检测不到root。</p>
<p>这里介绍一下第二个方法，js脚本如下，执行方法也如下，然后就绕过去了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">frida -U -f owasp.mstg.uncrackable1 -l .\uncrackable-level1.js</span></span><br><span class="line"></span><br><span class="line">Java.perform(function()&#123;</span><br><span class="line">    var temp = Java.use(&quot;java.lang.System&quot;); # 获得System类</span><br><span class="line">    # exit是静态函数，不需要实例化后再调用</span><br><span class="line">    # overload指定具体的重载版本</span><br><span class="line">    temp.exit.overload(&#x27;int&#x27;).implementation = function(arg0)&#123;</span><br><span class="line">        console.log(&quot;Exit called with &quot; + arg0);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="/./assets/image-20250224160548124.png" alt="image-20250224160548124"></p>
<p>通过jeb，可以发现在类a中，函数a会根据输入的内容进行比较，随后得出是否正确的答案。</p>
<p><img src="/./assets/image-20250224183527518.png" alt="image-20250224183527518"></p>
<p>下面是写的一个js脚本，直接return true，或者通过sg.vantagepoint.a.a.a得到解密的明文。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"># 直接改为<span class="literal">true</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获取目标类</span></span><br><span class="line">    <span class="keyword">var</span> targetClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;sg.vantagepoint.uncrackable1.a&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook 静态方法 a(String)</span></span><br><span class="line">    targetClass.<span class="property">a</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">s</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n[*] 拦截验证方法调用&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 打印原始输入</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;原始输入: &quot;</span> + s);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调用原始方法获取结果</span></span><br><span class="line">        <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">a</span>(s); <span class="comment">// [!code focus]</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 打印原始验证结果</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;原始验证结果: &quot;</span> + result);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 强制返回 true（绕过验证）</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] 强制返回 true&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 若需保留原始逻辑，直接返回 result</span></span><br><span class="line">        <span class="comment">// return result;</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"># 观察正确的输入</span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获取加密工具类</span></span><br><span class="line">    <span class="keyword">var</span> crypto = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;sg.vantagepoint.a.a&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取验证类</span></span><br><span class="line">    <span class="keyword">var</span> checker = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;sg.vantagepoint.uncrackable1.a&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook a() 方法获取密钥和密文</span></span><br><span class="line">    checker.<span class="property">a</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">s</span>) &#123;</span><br><span class="line">        <span class="comment">// 原始密文（Base64）</span></span><br><span class="line">        <span class="keyword">var</span> ciphertext_b64 = <span class="string">&quot;5UJiFctbmgbDoLXmpL12mkno8HT4Lv8dlat8FxR2GOc=&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 硬编码密钥（处理负数为无符号字节）</span></span><br><span class="line">        <span class="keyword">var</span> key_bytes = [<span class="number">0x8D</span>, <span class="number">0x12</span>, <span class="number">0x76</span>, <span class="number">0x84</span>, <span class="number">0xCB</span>, <span class="number">0xC3</span>, <span class="number">0x7C</span>, <span class="number">0x17</span>, </span><br><span class="line">                         <span class="number">0x61</span>, <span class="number">0x6D</span>, <span class="number">0x80</span>, <span class="number">0x6C</span>, <span class="number">0xF5</span>, <span class="number">0x04</span>, <span class="number">0x73</span>, <span class="number">0xCC</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将密钥转换为 Java byte[]</span></span><br><span class="line">        <span class="keyword">var</span> jKey = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, key_bytes);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Base64 解码密文</span></span><br><span class="line">        <span class="keyword">var</span> ciphertext = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;android.util.Base64&#x27;</span>).<span class="title function_">decode</span>(ciphertext_b64, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 调用解密方法</span></span><br><span class="line">            <span class="keyword">var</span> decrypted_bytes = crypto.<span class="title function_">a</span>(jKey, ciphertext);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 转换为字符串</span></span><br><span class="line">            <span class="keyword">var</span> plaintext = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).$new(decrypted_bytes);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n[+] 解密成功！Secret String: &quot;</span> + plaintext);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[-] 解密失败: &quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回原始验证结果（或强制返回 true）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">a</span>(s);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行，得到结果。</p>
<p><img src="/./assets/image-20250224185351087-1747559716287-11.png" alt="image-20250224185351087"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E4%B8%8E%E8%84%B1%E5%A3%B3%E6%9C%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E4%B8%8E%E8%84%B1%E5%A3%B3%E6%9C%BA/" class="post-title-link" itemprop="url">类加载与脱壳机</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:11:40 / 修改时间：17:12:24" itemprop="dateCreated datePublished" datetime="2025-05-18T17:11:40+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>12 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>自制脱壳机，将公开了源码的Fart6移植到Fart10，同时去除一些Fart特征。</p>
<h1 id="loadClass的过程"><a href="#loadClass的过程" class="headerlink" title="loadClass的过程"></a>loadClass的过程</h1><p>loadClass的过程可以总结成：1.判断是否是当前类加载器加载了此类；2.若不是，让父加载器加载此类；3.若父加载器加载失败，由当前加载器加载。</p>
<p>一般实现类加载，同时使用ClassLoader的实例调用loadClass。</p>
<p><img src="/./assets/image-20250423193342573.png" alt="image-20250423193342573"></p>
<p>可以看到，ClassLoader.loadClass(String className)间接调用重载函数，resolve在这里不起作用，在JVM中，如果resolve为true，表示加载类之后是否需要立即进行<strong>链接操作</strong>中的<strong>解析</strong>步骤。（链接包括：验证、准备（分配空间）、解析），而在安卓虚拟机中，这里忽略resolve。</p>
<img src="./assets/image-20250423193434035.png" alt="image-20250423193434035" style="zoom:67%;" />

<h2 id="1-findLoadedClass（ClassLoader）——查询当前加载器是否加载了目标类"><a href="#1-findLoadedClass（ClassLoader）——查询当前加载器是否加载了目标类" class="headerlink" title="1 findLoadedClass（ClassLoader）——查询当前加载器是否加载了目标类"></a>1 findLoadedClass（ClassLoader）——查询当前加载器是否加载了目标类</h2><p>findLoadedClass是用来检查缓存的，这个方法会检查当前ClassLoader实例是否已经加载过名为className的类，每个ClassLoader实例都有一个缓存区，用来存放已经加载过的类。</p>
<p>如果当前实例是启动类加载器，则将局部变量 <code>loader</code> 设为 <code>null</code>。这是因为查询启动类加载器加载的类通常需要通过 VM 的特殊 native 接口，并使用 <code>null</code> 来代表它。</p>
<p>如果当前实例<strong>不是</strong>启动类加载器（比如是 AppClassLoader 或 PathClassLoader 等），则将 <code>loader</code> 设置为 <code>this</code>，即当前 ClassLoader 实例本身。</p>
<p><img src="/./assets/image-20250423194242183.png" alt="image-20250423194242183"></p>
<h3 id="findLoadedClass（VMClassaLoader、JNI函数）"><a href="#findLoadedClass（VMClassaLoader、JNI函数）" class="headerlink" title="findLoadedClass（VMClassaLoader、JNI函数）"></a>findLoadedClass（VMClassaLoader、JNI函数）</h3><p>这里的VMClassLoader.findLoadedClass是一个static的JNI函数，具体实现在native层，目录为：&#x2F;art&#x2F;runtime&#x2F;native&#x2F;java_lang_VMClassLoader.cc。</p>
<p>这个 C++ 函数 <code>VMClassLoader_findLoadedClass</code> 的核心目的是：接收一个 Java 层的 <code>ClassLoader</code> 对象和一个类名字符串，然后在 ART 虚拟机内部的数据结构中查找，判断这个特定的 <code>ClassLoader</code> <strong>是否已经加载并解析</strong>了具有该名称的类。如果找到了并且类是可用状态（已解析），就返回对应的 Java <code>Class</code> 对象 (jclass)；否则返回 <code>nullptr</code>。</p>
<p>现在来简单解释一下下图的函数VMClassLoader_findLoadedClass。</p>
<p>第31行，env是标准的JNI的接口，提供java与native之间的交互。soa可以理解为ART对JNI交互的封装与简化，它的底层还是使用env来工作，但自动管理线程状态，更安全、方便。</p>
<p>第32行，将Java层的jobject javaLoader解码成ART内部表示的mirror::ClassaLoader*指针loader，这里的mirror是ART中表示Java堆对象的类的命名空间。</p>
<p>第33行，将javaName从java的jstring转换成c&#x2F;c++使用的UTF-8编码字符串。</p>
<p>第37行，获取ClassLinker实例，ClassLinker实例要负责类的<strong>加载</strong>、<strong>链接</strong>（验证、准备、解析）、<strong>初始化</strong>。所有类查找、类定义、解析相关的操作，都要经过ClassLinker。</p>
<p>第38行，将点分格式的类名转换成虚拟机内部使用的描述符，即斜杠格式。</p>
<p>第39行，将类描述符转换成唯一的哈希值。</p>
<p>第40行，根据<strong>哈希值、loader、类描述符、当前的线程</strong>（soa.Self()返回线程Thread<em>指针），来去找*<em>唯一的类</em></em>。</p>
<p>这里重点关注LookupClass。</p>
<img src="./assets/image-20250423195152864.png" alt="image-20250423195152864" style="zoom:80%;" />

<h4 id="LookupClass"><a href="#LookupClass" class="headerlink" title="LookupClass"></a>LookupClass</h4><p>在LookupClass中。</p>
<p><strong>第一阶段，查主表。（缓存查找）</strong></p>
<p>使用 <code>ReaderMutexLock</code> 获取对 <code>ClassLinker</code> 内部类表的读取锁，保证线程安全。</p>
<p>调用 <code>LookupClassFromTableLocked</code> 在主要的类表（包括 Zygote 预加载表 <code>pre_zygote_class_table_</code> 和运行时表 <code>class_table_</code>）中查找。</p>
<p>如果在表中找到了匹配的类 (<code>result != nullptr</code>)，就立即返回结果。锁会自动释放。</p>
<p><strong>第二阶段，查启动镜像（启动类加载器）。</strong></p>
<p>仅当第一阶段失败、查找的是启动类加载器 (<code>class_loader == nullptr</code>)、<strong>且</strong>需要查找镜像时，才执行这里。</p>
<p>调用 <code>LookupClassFromImage(descriptor)</code> 尝试在 dex_caches_ 中查找。</p>
<p>如果找到了 (<code>result != nullptr</code>): 调用 <code>InsertClass</code> 将其加入主类表（可能是 <code>class_table_</code>），起到缓存作用，然后返回找到的 <code>result</code>。</p>
<p>如果还没找到 (<code>result == nullptr</code>): 增加查找镜像失败的计数器。如果失败次数超过阈值 (<code>kMaxFailedDexCacheLookups</code>)，则触发一个优化操作 <code>MoveImageClassesToClassTable()</code>，将所有启动镜像中的类都添加到主类表中，以加速后续查找。最后返回 <code>nullptr</code>。</p>
<p><img src="/./assets/image-20250423203016909.png" alt="image-20250423203016909"></p>
<h5 id="LookupClassFromTableLocked"><a href="#LookupClassFromTableLocked" class="headerlink" title="LookupClassFromTableLocked"></a>LookupClassFromTableLocked</h5><p>在LookupClassFromTableLocked中，pre_zygote_class_table_记录着预加载的类（Zygote进程在创建时，初始化了虚拟机并加载了一系列预加载的动态链接库，这些动态链接库里的类记录在这个预加载类表里）。而class_table_则是动态类表，它存储了 Zygote 之后由各种 ClassLoader 加载的类，以及从启动镜像（image）查找到并缓存起来的类。</p>
<p><img src="/./assets/image-20250423203338637.png" alt="image-20250423203338637"></p>
<h5 id="LookupClassFromImage"><a href="#LookupClassFromImage" class="headerlink" title="LookupClassFromImage"></a>LookupClassFromImage</h5><p>函数LookupClassFromImage是从启动类加载器的dex_cache中找目标类，DexCache类用于关联DexFile对象。</p>
<p><img src="/./assets/image-20250424093826619.png" alt="image-20250424093826619"></p>
<img src="./assets/image-20250424104135348.png" alt="image-20250424104135348" style="zoom:67%;" />

<h2 id="2-parent-loadClass——委托父加载器加载"><a href="#2-parent-loadClass——委托父加载器加载" class="headerlink" title="2 parent.loadClass——委托父加载器加载"></a>2 parent.loadClass——委托父加载器加载</h2><p>上述流程已经把如何寻找一个类讲得很详细了，接下来讲委派双亲机制。</p>
<p>下图中，在findLoadedClass找不到className后，就会尝试执行parent.loadClass，让父加载器去加载，父加载器的执行流程也是：findLoadedClass、parent.loadClass、findClass。</p>
<p>所以，这里不细讲委派机制（双亲委派机制不难），直接讲如何加载一个未加载的类。</p>
<img src="./assets/image-20250423193434035.png" alt="image-20250423193434035" style="zoom:67%;" />

<h2 id="3-findClass——自己加载"><a href="#3-findClass——自己加载" class="headerlink" title="3 findClass——自己加载"></a>3 findClass——自己加载</h2><p>这里分析的是BaseDexClassLoader的findClass，一般整体壳都绕不开BaseDexClassLoader，BaseDexClassLoader的父类是ClassLoader，我们之前分析的findLoadedClass和parent.loadClass都是ClassLoader类中，loadClass里出现的函数。BaseDexClassLoader并没有实现自己的loadClass，所以loadClass都是从ClassLoader继承过来的。</p>
<p>但ClassLoader的findClass已经被BaseDexClassLoader覆写了，我们这里就需要分析findClass。</p>
<p><code>findClass</code> 函数的核心职责就是：<strong>在当前 ClassLoader 管理的一系列 Dex 文件中，按顺序查找指定的类，如果找到，就加载并定义它。</strong></p>
<p>下图中，pathList是个老熟人了。</p>
<p><img src="/./assets/image-20250423213829616.png" alt="image-20250423213829616"></p>
<h3 id="pathList——属于类DexPathList"><a href="#pathList——属于类DexPathList" class="headerlink" title="pathList——属于类DexPathList"></a>pathList——属于类DexPathList</h3><p>pathList是BaseDexClassLoader声明的一个DexPathList类型的私有成员变量。</p>
<p><img src="/./assets/image-20250423215020680.png" alt="image-20250423215020680"></p>
<p>关于DexPathList，从字面上来看，它是存储Dex路径列表的一个变量，从功能上来说，它存储的路径包括：apk的路径、dex的路径、jar的路径、class的路径等。然而，类DexPathList存储路径的列表（成员变量）叫dexElements，这一度让我以为——“一个Element实例代表一个Dex文件路径”，这个概念其实是错的。</p>
<p>通过注释，其实可以知道，这个成员变量应该叫pathElements，结果因为Facebook app改了名字，What can I say。</p>
<p>纠正一下上面的概念，这里的dexElements是一个Element数组，每个Element实例存储的是一个路径，这个路径要是指向apk，可能包含不止一个Dex，所以一个Element实例代表一个Dex文件路径的概念是错误的。</p>
<img src="./assets/image-20250423220734893.png" alt="image-20250423220734893" style="zoom:67%;" />

<p>接着看看DexPathList的findClass。</p>
<p>可以看到，这里取出了每个Element实例，并取出了element.dexFile赋给dex，然后调用了dex.loadClassBinaryName去找目标类是否在当前的文件（apk&#x2F;dex&#x2F;jar&#x2F;class）中。</p>
<p><img src="/./assets/image-20250423221852117.png" alt="image-20250423221852117"></p>
<h4 id="dexElements——属于类Element"><a href="#dexElements——属于类Element" class="headerlink" title="dexElements——属于类Element"></a>dexElements——属于类Element</h4><p>类Element是定义在DexPathList的静态内部类，从成员变量中可以看出，它存储的类型有apk&#x2F;zip&#x2F;dex等，还有一个很关键的成员变量dexFile。</p>
<img src="./assets/image-20250423222628102.png" alt="image-20250423222628102" style="zoom:80%;" />

<h5 id="mCookie——属于类DexFile"><a href="#mCookie——属于类DexFile" class="headerlink" title="mCookie——属于类DexFile"></a>mCookie——属于类DexFile</h5><p>DexFile的mCookie很重要，在native层中，通过相关函数的调用，可以利用mCookie去获取DexFile（可以理解为PathFile）里存放的所有Dex文件。</p>
<img src="./assets/image-20250423223224521.png" alt="image-20250423223224521" style="zoom:80%;" />

<p>阅读DexFile.java中的代码，会发现mCookie的值由jni函数openDexFileNative获得。</p>
<p><img src="/./assets/image-20250423223802545.png" alt="image-20250423223802545"></p>
<img src="./assets/image-20250423224106202.png" alt="image-20250423224106202" style="zoom: 67%;" />

<p>java层openDexFileNative对应着native层的DexFile_openDexFileNative。</p>
<p>第154-161行，将输入的jstring转换成c&#x2F;c++的const char*来使用。</p>
<p>第163行，获取ART运行时的ClassLinker实例，打开Dex文件和处理OAT文件是ClassLinker的职责之一。</p>
<p>第164行，创建一个std::vector，用于存放成功打开的DexFile对象。</p>
<p>第165行，创建error_msgs用于收集打开过程中可能出现的错误信息。</p>
<p>第167行，可以理解为OpenDexFilesFromOat将已打开的Dex文件(们)的内部句柄打包成一个long[]数组，返回给dex_files。</p>
<p>第170行，将这些句柄从native类型转换成JNI类型，赋值给array，array会通过return赋给Java层的mCookie。</p>
<img src="./assets/image-20250423224207810.png" alt="image-20250423224207810" style="zoom:80%;" />

<p>于是我们知道了，mCookie是已打开的Dex文件们的句柄数组指针。</p>
<h5 id="loadClassBinaryName——属于类DexFile"><a href="#loadClassBinaryName——属于类DexFile" class="headerlink" title="loadClassBinaryName——属于类DexFile"></a>loadClassBinaryName——属于类DexFile</h5><p>回到这张图，讲DexFile的loadClassBinaryName。</p>
<p><img src="/./assets/image-20250423221852117.png" alt="image-20250423221852117"></p>
<p>直接跳转到defineClass。</p>
<p><img src="/./assets/image-20250423230919815.png" alt="image-20250423230919815"></p>
<p>再跳转到defineClassNative。</p>
<img src="./assets/image-20250423231002943.png" alt="image-20250423231002943" style="zoom:67%;" />

<p>defineClassNative是一个静态JNI函数。</p>
<p>第220行，眼熟吧，将cookie转换回了dex_files句柄数组。</p>
<p>第234行，遍历每一个打开的Dex文件句柄。</p>
<p>第235行，通过函数FindClassDef，去每个Dex文件里寻找目标Class是否存在。</p>
<p>第236行，如果存在，则通过ClassLinker的实例class_linker，对这个Dex文件进行注册，加入dex_caches。</p>
<p><img src="/./assets/image-20250423231252117.png" alt="image-20250423231252117"></p>
<h6 id="FindClassDef——找到类定义"><a href="#FindClassDef——找到类定义" class="headerlink" title="FindClassDef——找到类定义"></a>FindClassDef——找到类定义</h6><p>这个函数的核心目的是：<strong>在当前的 <code>DexFile</code> 对象所代表的 Dex 文件内部，根据给定的类描述符 (descriptor) 字符串和其哈希值，查找并返回对应的 <code>DexFile::ClassDef</code> 结构体指针。</strong></p>
<p>其中，第481-485行，在解析一个Dex文件，获得Class的数量。</p>
<p>第486-499行，遍历类定义表，根据类定义结构的class_idx_是指向type索引表，这里通过描述符descriptor获取到了type_idx，然后和每个类的class_idx_进行比较，以此找出类。</p>
<img src="./assets/image-20250424105954640.png" alt="image-20250424105954640" style="zoom:80%;" />

<p>下图是ClassDef的结构。</p>
<img src="./assets/image-20250424140948995.png" alt="image-20250424140948995" style="zoom:80%;" />

<h6 id="RegisterDexFile——将DexFile加入缓存"><a href="#RegisterDexFile——将DexFile加入缓存" class="headerlink" title="RegisterDexFile——将DexFile加入缓存"></a>RegisterDexFile——将DexFile加入缓存</h6><p>dex_cache会被加入ClassLinker中的dex_caches_中（通过dex_caches_.push_back），ClassLinker会通过这个列表跟踪所有已注册的Dex缓存，建立了dex_cache和dex_file之间的连接（dex_cache-&gt;SetDexFile(&amp;dex_file)）。</p>
<p>这个过程确保了每个被 ART 管理的 Dex 文件都有一个对应的 DexCache，并且 ClassLinker 能够找到并管理这些缓存。</p>
<img src="./assets/image-20250424142218357.png" alt="image-20250424142218357" style="zoom:80%;" />

<h6 id="DefineClass——类的加载、链接、初始化"><a href="#DefineClass——类的加载、链接、初始化" class="headerlink" title="DefineClass——类的加载、链接、初始化"></a>DefineClass——类的加载、链接、初始化</h6><p>这个函数是<strong>实际定义一个新类</strong>的核心逻辑。它接收一个在 <code>dex_file</code> 中找到的类定义 <code>dex_class_def</code>，以及要使用的 <code>class_loader</code>，然后负责创建对应的运行时 <code>mirror::Class</code> 对象，并执行加载和链接的关键步骤。</p>
<img src="./assets/image-20250424144226011.png" alt="image-20250424144226011" style="zoom:67%;" />

<p>第1816行-1829行，处理特殊的类。</p>
<p>第1831-1841行，分配内存创建Class对象。</p>
<p>第1842行，将DexFile对应的DexCache设置到Class对象中。</p>
<p>第1844行，用ClassDef和ClassLoader信息填充Class对象。</p>
<p>第1847-1850行，为String类专门进设置标志。——没深入分析。</p>
<p>第1853-1854行，获得这个类的锁，防止并发初始化，记录当前线程为类的初始化线程。</p>
<p><img src="/./assets/image-20250424144506020.png" alt="image-20250424144506020"></p>
<p>第1857行，根据描述符、Class对象.Get()、类描述符的hash值插入一个新加载的类到类表class_table_中。</p>
<p>第1858-1862行，插入失败，说明被其它线程插入了，使用已存在的Class对象并确保它已经被解析。</p>
<p>第1868-1876行，加载类的成员（字段和方法信息），如果失败，标志Class状态为Error。</p>
<p>第1878-1879行，此时类状态应该为Loaded（成员已经加载，但父类&#x2F;接口未连接）。</p>
<p>第1880行，加载并链接父类和接口。</p>
<p>第1894行，执行链接（验证、准备、解析字段&#x2F;方法、设置vtable&#x2F;iftable等）。</p>
<p><img src="/./assets/image-20250424145459019.png" alt="image-20250424145459019"></p>
<p>最后返回的是一个定义并链接好的Class对象。</p>
<img src="./assets/image-20250424150802221.png" alt="image-20250424150802221" style="zoom:80%;" />

<p>整个逻辑如下图所示。</p>
<img src="./assets/image-20250424150959405.png" alt="image-20250424150959405" style="zoom:80%;" />

<p>（注：说明一下，Java的DexFile类和C&#x2F;C++的DexFile类不一样，Java的DexFile通常指向一个APK文件或JAR文件或Dex文件等等，所以一个DexFile类可能会存储着许多个Dex文件；而C&#x2F;C++的DexFile类指向一个Dex文件）</p>
<p>一个 Java <code>DexFile</code> 对象虽然是基于一个<strong>单一的源文件路径 (APK&#x2F;JAR)</strong> 创建的，但它内部通过 <code>mCookie</code> (一个 <code>long[]</code> 数组) 可以管理从该源文件或其对应的 OAT 文件中加载出来的<strong>一个或多个</strong>底层的 C++ <code>art::DexFile</code> 实例。这对于支持 Android 的 MultiDex 机制至关重要。</p>
<h1 id="Fart的逻辑"><a href="#Fart的逻辑" class="headerlink" title="Fart的逻辑"></a>Fart的逻辑</h1><p>Fart脱壳的步骤主要分为3步：</p>
<p>1.找到合适的点，通过DexFile结构脱下完整的dex；</p>
<p>2.主动调用类中的每一个方法，并实现对CodeItem的dump；</p>
<p>3.修复Dex。</p>
<h2 id="整体壳"><a href="#整体壳" class="headerlink" title="整体壳"></a>整体壳</h2><p>下图是Fart的第1点的逻辑。</p>
<p>一个类的初始化函数是不会被直接编译成OAT代码的，而一个Java的Method，除了走OAT代码模式，就必须走解释器模式，解释器模式必须经过函数Execute，因此，可以在Execute里针对<clinit>进行dump，以完成整个dex的dump。</p>
<p><img src="/./assets/image-20250424201851497.png" alt="image-20250424201851497"></p>
<h2 id="抽取壳"><a href="#抽取壳" class="headerlink" title="抽取壳"></a>抽取壳</h2><p>下图是Fart的第2点逻辑。</p>
<p><img src="/./assets/image-20250424193856630.png" alt="image-20250424193856630"></p>
<p>之后，又有人写了一个FartExt，逻辑如下。</p>
<img src="./制作脱壳机.assets/659397_VSXS7G8WNMTJTVH.png" alt="659397_VSXS7G8WNMTJTVH" style="zoom:80%;" />

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/17/baidu%E5%85%8D%E8%B4%B9%E5%A3%B3%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/17/baidu%E5%85%8D%E8%B4%B9%E5%A3%B3%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">baidu免费壳分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-17 20:02:05 / 修改时间：22:19:43" itemprop="dateCreated datePublished" datetime="2025-05-17T20:02:05+08:00">2025-05-17</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>129k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3:55</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="libbaiduprotect-so加载分析"><a href="#libbaiduprotect-so加载分析" class="headerlink" title="libbaiduprotect.so加载分析"></a>libbaiduprotect.so加载分析</h1><p>通过Manifest可以看到<strong>包名</strong>和第一个加载的<strong>app类</strong>。——“com.example.test”和“com.baidu.protect.StubApplication”。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508082508430.png" alt="image-20250508082508430"></p>
<p>在原来的lib下，多出了一个libbaiduprotect.so，而在assets下面也多了几个文件。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508082719470.png" alt="image-20250508082719470"></p>
<p>猜测是libbaiduprotect.so将assets下的文件解密出了dex，然后进行加载。</p>
<p>下面开始分析。</p>
<p>根据app类的名称，找到app类，一般整体壳，app类会对attachBaseContext和onCreate进行覆写。</p>
<p>先看attachBaseContext。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508083159829.png" alt="image-20250508083159829" style="zoom:80%;" />

<p>其中，StubApplication.loadLibrary实际上是加载了libbaiduprotect.so，因此，接下来用ida查看libbaiduprotect.so。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508083312421.png" alt="image-20250508083312421"></p>
<p>搜索函数“init_proc”并没有搜到，接下来查看.init_array节，存在以下在加载so阶段会执行的函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508083540297.png" alt="image-20250508083540297" style="zoom:80%;" />

<p>先来看sub_88060，一眼混淆，本来靠着NOP，去掉了几个虚假控制流和不透明谓词，但还是太多了，直接使用d810进行处理。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508083806546.png" alt="image-20250508083806546"></p>
<p>处理完后，算上default的话，有32个case选项，看样子是在做解密操作。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508084218294.png" alt="image-20250508084218294"></p>
<p>再来看JNI_OnLoad，会发现被加密了，可以猜到是sub_88060对它进行了加密。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508091104891.png" alt="image-20250508091104891"></p>
<p>下面是一个frida脚本，用于在sub_88060解完密后，第一时间dump整个so。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 要hook的函数offset</span></span><br><span class="line"><span class="keyword">var</span> offset = <span class="number">0x88060</span>;</span><br><span class="line"><span class="comment">// so文件的大小</span></span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 要hook的so的名字</span></span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获得linker64的地址</span></span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>)</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>    <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call)</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="comment">// 判断是否可以通过findModuleByName查找到目标so文件</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>)</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>)&#123;</span><br><span class="line">                module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                <span class="comment">// 第一时间hook</span></span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(offset), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="comment">// 在执行完某个函数后，立马进行dump</span></span><br><span class="line">            <span class="title function_">dump</span>(baseaddr, module_size);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump</span>(<span class="params">begin_addr, dump_size</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[name] &quot;</span>, module_name);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[base] &quot;</span>, begin_addr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[size] &quot;</span>, <span class="string">&quot;0x&quot;</span> + dump_size.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">    <span class="keyword">var</span> file_path = <span class="string">&quot;/data/data/com.example.test/zzc_&quot;</span> + begin_addr + <span class="string">&quot;_0x&quot;</span> + dump_size.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;.so&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="title function_">ptr</span>(begin_addr), dump_size, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> libso_buffer = <span class="title function_">ptr</span>(begin_addr).<span class="title function_">readByteArray</span>(dump_size);</span><br><span class="line">        file_handle.<span class="title function_">write</span>(libso_buffer);</span><br><span class="line">        file_handle.<span class="title function_">flush</span>();</span><br><span class="line">        file_handle.<span class="title function_">close</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump] &quot;</span>, file_path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors)</span><br></pre></td></tr></table></figure>

<p>将dump下来的so文件，通过soFixer进行修复。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SoFixer-Windows-64.exe -s .\zzc_0x6f7471a000_0xc1000.so -o .\zzc_0x6f7471a000_0xc1000.sofixer.so -m 0x6f7471a000 -d</span><br></pre></td></tr></table></figure>

<p>可以看到，JNI_OnLoad已经恢复正常了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508091410337.png" alt="image-20250508091410337"></p>
<p>接下来看其它的在.init_array上的函数（在加密so的中查看）。</p>
<p>查看sub_6FC4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508091509137.png" alt="image-20250508091509137"></p>
<p>可以看出来，qword_28c28s是一个函数指针，它在解密后面那一串内容。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508091601327.png" alt="image-20250508091601327"></p>
<p>点开地址28c28的位置，发现存在加密的内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508091851238.png" alt="image-20250508091851238" style="zoom: 50%;" />

<p>这说明这个函数也需要得到解密，那就只能是在sub_88060里了，去另一个解密的so文件看一眼，发现果然解密了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508091913526.png" alt="image-20250508091913526" style="zoom: 50%;" />

<p>通过hook解密后的sub_28c28，可以得到解密字符串，脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 要hook的函数offset</span></span><br><span class="line"><span class="keyword">var</span> offset = <span class="number">0x88060</span>;</span><br><span class="line"><span class="comment">// so文件的大小</span></span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 要hook的so的名字</span></span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获得linker64的地址</span></span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>)</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>    <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call)</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="comment">// 判断是否可以通过findModuleByName查找到目标so文件</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>)</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>)&#123;</span><br><span class="line">                module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                <span class="comment">// 第一时间hook</span></span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(offset), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="comment">// 第一个函数解密完后，才能hook sub_28c28</span></span><br><span class="line">            <span class="title function_">decrypt_28c28</span>(baseaddr);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">decrypt_28c28</span>(<span class="params">baseaddr</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(<span class="number">0x28c28</span>), &#123;</span><br><span class="line">            <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[sub_28c28] &quot;</span>, <span class="string">&quot;arg = &quot;</span>, <span class="title function_">ptr</span>(args[<span class="number">0</span>]).<span class="title function_">readCString</span>());</span><br><span class="line">            &#125;, <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[sub_28c28] &quot;</span>, <span class="string">&quot;retval = &quot;</span>, <span class="title function_">ptr</span>(retval).<span class="title function_">readCString</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors)</span><br></pre></td></tr></table></figure>

<p>执行的结果如下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508092118543.png" alt="image-20250508092118543" style="zoom:80%;" />

<p>写了一个ida脚本，给这些字符串的地方添加注释。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"></span><br><span class="line"># 加密/明文映射</span><br><span class="line">mappings = &#123;</span><br><span class="line">    <span class="string">&quot;710E34DFB3D273975E0936FBB4CF62BE541F3CC4A8&quot;</span>: <span class="string">&quot;FeatureLibcProtection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;530A39DDAFCB39A84E1821CEAB8F52BE4F3B34DFAEEC7FA843&quot;</span>: <span class="string">&quot;dalvik/system/DexPathList&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 函数列表（地址或函数名）</span><br><span class="line">func_list = [</span><br><span class="line">    <span class="number">0x28c28</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">def <span class="title function_">find_string_addr</span>(search_str):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;查找字符串的地址&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> addr <span class="keyword">in</span> idautils.<span class="title class_">Strings</span>():</span><br><span class="line">        <span class="keyword">if</span> <span class="title function_">str</span>(addr) == <span class="attr">search_str</span>:</span><br><span class="line">            <span class="keyword">return</span> addr.<span class="property">ea</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">None</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">resolve_func_addr</span>(func_entry):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;将函数名或地址转换为地址&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="title function_">isinstance</span>(func_entry, int):</span><br><span class="line">        <span class="keyword">return</span> func_entry</span><br><span class="line">    elif <span class="title function_">isinstance</span>(func_entry, str):</span><br><span class="line">        func_addr = idaapi.<span class="title function_">get_name_ea_simple</span>(func_entry)</span><br><span class="line">        <span class="keyword">if</span> func_addr == idaapi.<span class="property">BADADDR</span>:</span><br><span class="line">            <span class="title function_">print</span>(f<span class="string">&quot;Function not found: &#123;func_entry&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">None</span></span><br><span class="line">        <span class="keyword">return</span> func_addr</span><br><span class="line">    <span class="attr">else</span>:</span><br><span class="line">        <span class="title function_">print</span>(f<span class="string">&quot;Invalid function entry: &#123;func_entry&#125;&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">None</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">add_comments_to_strings</span>():</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;为 .rodata 中的字符串添加解密注释和重命名&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> encrypted, decrypted <span class="keyword">in</span> mappings.<span class="title function_">items</span>():</span><br><span class="line">        str_addr = <span class="title function_">find_string_addr</span>(encrypted)</span><br><span class="line">        <span class="keyword">if</span> <span class="attr">str_addr</span>:</span><br><span class="line">            idaapi.<span class="title function_">set_cmt</span>(str_addr, f<span class="string">&quot;Decrypted: &#123;decrypted&#125;&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            # 重命名字符串，替换特殊字符以符合命名规则</span><br><span class="line">            safe_name = f<span class="string">&quot;str_&#123;decrypted.replace(&#x27;/&#x27;, &#x27;_&#x27;).replace(&#x27; &#x27;, &#x27;_&#x27;)&#125;&quot;</span></span><br><span class="line">            idaapi.<span class="title function_">set_name</span>(str_addr, safe_name, idaapi.<span class="property">SN_FORCE</span>)</span><br><span class="line">            <span class="title function_">print</span>(f<span class="string">&quot;Added comment at 0x&#123;str_addr:x&#125;: &#123;encrypted&#125; -&gt; &#123;decrypted&#125;&quot;</span>)</span><br><span class="line">        <span class="attr">else</span>:</span><br><span class="line">            <span class="title function_">print</span>(f<span class="string">&quot;String not found in .rodata: &#123;encrypted&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">def <span class="title function_">add_comments_to_function</span>(func_addr):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;为指定函数添加注释，扫描加载字符串的指令&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    func = idaapi.<span class="title function_">get_func</span>(func_addr)</span><br><span class="line">    <span class="keyword">if</span> not <span class="attr">func</span>:</span><br><span class="line">        <span class="title function_">print</span>(f<span class="string">&quot;Function at 0x&#123;func_addr:x&#125; not found or invalid&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    # 添加函数注释</span><br><span class="line">    func_name = idaapi.<span class="title function_">get_func_name</span>(func_addr)</span><br><span class="line">    idaapi.<span class="title function_">set_func_cmt</span>(func_addr, f<span class="string">&quot;Decrypts strings (e.g., &#123;&#x27;, &#x27;.join(f&#x27;&#123;k&#125;-&gt;&#123;v&#125;&#x27; for k, v in mappings.items())&#125;)&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="title function_">print</span>(f<span class="string">&quot;Processing function: &#123;func_name&#125; at 0x&#123;func_addr:x&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    # 扫描函数指令，查找加载字符串的指令</span><br><span class="line">    <span class="keyword">for</span> ea <span class="keyword">in</span> idautils.<span class="title class_">FuncItems</span>(func.<span class="property">start_ea</span>):</span><br><span class="line">        disasm = idaapi.<span class="title function_">generate_disasm_line</span>(ea, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;LDR&quot;</span> <span class="keyword">in</span> <span class="attr">disasm</span>:  # 检查加载指令</span><br><span class="line">            <span class="keyword">for</span> enc, dec <span class="keyword">in</span> mappings.<span class="title function_">items</span>():</span><br><span class="line">                <span class="keyword">if</span> enc <span class="keyword">in</span> <span class="attr">disasm</span>:</span><br><span class="line">                    idaapi.<span class="title function_">set_cmt</span>(ea, f<span class="string">&quot;Loads &#123;enc&#125; -&gt; &#123;dec&#125;&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                    <span class="title function_">print</span>(f<span class="string">&quot;Added comment at 0x&#123;ea:x&#125;: &#123;enc&#125; -&gt; &#123;dec&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">def <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;主函数：处理字符串和函数列表&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    # 处理 .<span class="property">rodata</span> 中的字符串</span><br><span class="line">    <span class="title function_">print</span>(<span class="string">&quot;Processing strings in .rodata...&quot;</span>)</span><br><span class="line">    <span class="title function_">add_comments_to_strings</span>()</span><br><span class="line"></span><br><span class="line">    # 处理函数列表</span><br><span class="line">    <span class="title function_">print</span>(<span class="string">&quot;\nProcessing functions...&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> func_entry <span class="keyword">in</span> <span class="attr">func_list</span>:</span><br><span class="line">        func_addr = <span class="title function_">resolve_func_addr</span>(func_entry)</span><br><span class="line">        <span class="keyword">if</span> func_addr is not <span class="title class_">None</span>:</span><br><span class="line">            <span class="title function_">add_comments_to_function</span>(func_addr)</span><br><span class="line">        <span class="attr">else</span>:</span><br><span class="line">            <span class="title function_">print</span>(f<span class="string">&quot;Skipping invalid function: &#123;func_entry&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"># 执行脚本</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="title function_">main</span>()</span><br></pre></td></tr></table></figure>

<p>ida脚本的执行情况如下，自动添加注释并对字符串重命名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508092227454.png" alt="image-20250508092227454"></p>
<p>回到sub_6FC4的位置，710….代表FeatureLibcProtection。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508092616184.png" alt="image-20250508092616184"></p>
<p>函数sub_3E590也被加密了，通过解密的so文件查看，它似乎是在赋值？a1是一个全局变量，a2是解密后的字符串，a3是1，似乎是一个索引。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508092711397.png" alt="image-20250508092711397" style="zoom:80%;" />

<p>BB9B0是一个函数指针，存放着的内容是sub_811B8的地址（也就是811B8）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508093513610.png" alt="image-20250508093513610"></p>
<p>这里创建一个结构体，由于函数指针和字符串指针都是指针，这里定义为__int64*。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508094125599.png" alt="image-20250508094125599"></p>
<p>结构就比较容易懂了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508094428716.png" alt="image-20250508094428716"></p>
<p>因此，sub_6FC4可以理解为在做函数注册。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508100357713.png" alt="image-20250508100357713"></p>
<p>会根据index，在对应的槽位注册。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508100323592.png" alt="image-20250508100323592" style="zoom: 67%;" />

<p>根据分析，注册了8个函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508095355396.png" alt="image-20250508095355396" style="zoom:80%;" />

<p>整理一下，注册关系大致如下。</p>
<p>sub_B3B4 -&gt; 索引1 -&gt; global_func_list[1]。</p>
<p>sub_3E29C -&gt; 索引3 -&gt; global_func_list[3]。</p>
<p>sub_40CF8 -&gt; 索引6 -&gt; global_func_list[6]。</p>
<p>sub_3DFC4 -&gt; 索引7 -&gt; global_func_list[7]。</p>
<p>sub_11F5C -&gt; 索引8 -&gt; global_func_list[8]。</p>
<p>sub_45964 -&gt; 索引9 -&gt; global_func_list[9]。</p>
<p>sub_3E96C -&gt; 索引10 -&gt; global_func_list[10]。</p>
<p>sub_42388 -&gt; 索引13 -&gt; global_func_list[13]。</p>
<p>之后开始分析JNI_onLoad，由于加密的so中，JNI_onLoad没有解密，所以这里根据解密的so的JNI_onLoad进行分析。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508103142823.png" alt="image-20250508103142823" style="zoom: 50%;" />

<p>上来就看到一大堆混淆，用d810处理一下。</p>
<p>可能是由于从内存中dump出来的缘故，反汇编伪代码的效果不是很好，连vm都看不到在哪里使用了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508103810153.png" alt="image-20250508103810153" style="zoom:80%;" />

<p>先看sub_91D8，十分眼熟，+48，基本可以确认a1是JNIEnv*的类型了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508103914736.png" alt="image-20250508103914736" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508104015382.png" alt="image-20250508104015382" style="zoom:80%;" />

<p>之后再看sub_7BC4，槽位0是经过初始化的，但没存前面的函数（应该被sub_82254初始化了），如果0号元素的内容为空，则调用sub_3E5A8进行清空。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508104607048.png" alt="image-20250508104607048" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508104938793.png" alt="image-20250508104938793" style="zoom:50%;" />

<p>所以，可以把函数sub_7BC4理解为，判断函数是否注册完毕。</p>
<p>接着看函数sub_3E628，没搞明白v11、v12在做什么，但能看得出来，是在调用函数列表里的函数，第一个参数是自己的地址，第二个参数是1（JNI_OnLoad传入的a2）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130255689.png" alt="image-20250508130255689"></p>
<p>先来观察函数列表的index为1的函数sub_B3B4。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130512877.png" alt="image-20250508130512877" style="zoom: 67%;" />

<p>如果a2不为1，直接返回，说明sub_B3B4只接受a2&#x3D;&#x3D;1的情况。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130621090.png" alt="image-20250508130621090"></p>
<p>sub_B3B4对很多字符串进行了解密，同时连接了很多字符串。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130801265.png" alt="image-20250508130801265" style="zoom: 50%;" />

<p>配合着脚本，实现了对这些字符串的解密。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 要hook的函数offset</span></span><br><span class="line"><span class="keyword">var</span> offset = <span class="number">0x88060</span>;</span><br><span class="line"><span class="comment">// so文件的大小</span></span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 要hook的so的名字</span></span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解密函数的偏移列表（从 sub_28AD0 到 sub_28A24）</span></span><br><span class="line"><span class="keyword">var</span> decrypt_offsets = [</span><br><span class="line">    <span class="number">0x28AD0</span>, <span class="number">0x25E78</span>, <span class="number">0x25F24</span>, <span class="number">0x25FD0</span>, <span class="number">0x2607C</span>, <span class="number">0x26128</span>, <span class="number">0x261D4</span>, <span class="number">0x26280</span>,</span><br><span class="line">    <span class="number">0x2632C</span>, <span class="number">0x263D8</span>, <span class="number">0x26484</span>, <span class="number">0x26530</span>, <span class="number">0x265DC</span>, <span class="number">0x26688</span>, <span class="number">0x26734</span>, <span class="number">0x267E0</span>,</span><br><span class="line">    <span class="number">0x2688C</span>, <span class="number">0x26938</span>, <span class="number">0x269E4</span>, <span class="number">0x26A90</span>, <span class="number">0x26B3C</span>, <span class="number">0x26BE8</span>, <span class="number">0x26C94</span>, <span class="number">0x26D40</span>,</span><br><span class="line">    <span class="number">0x26DEC</span>, <span class="number">0x26E98</span>, <span class="number">0x26F44</span>, <span class="number">0x26FF0</span>, <span class="number">0x2709C</span>, <span class="number">0x27148</span>, <span class="number">0x271F4</span>, <span class="number">0x272A0</span>,</span><br><span class="line">    <span class="number">0x2734C</span>, <span class="number">0x273F8</span>, <span class="number">0x274A4</span>, <span class="number">0x27550</span>, <span class="number">0x275FC</span>, <span class="number">0x276A8</span>, <span class="number">0x27754</span>, <span class="number">0x27800</span>,</span><br><span class="line">    <span class="number">0x278AC</span>, <span class="number">0x27958</span>, <span class="number">0x27A04</span>, <span class="number">0x27AB0</span>, <span class="number">0x27B5C</span>, <span class="number">0x27C08</span>, <span class="number">0x27CB4</span>, <span class="number">0x27D60</span>,</span><br><span class="line">    <span class="number">0x27E0C</span>, <span class="number">0x27EB8</span>, <span class="number">0x27F64</span>, <span class="number">0x28010</span>, <span class="number">0x280BC</span>, <span class="number">0x28168</span>, <span class="number">0x28214</span>, <span class="number">0x282C0</span>,</span><br><span class="line">    <span class="number">0x2836C</span>, <span class="number">0x28418</span>, <span class="number">0x284C4</span>, <span class="number">0x28570</span>, <span class="number">0x2861C</span>, <span class="number">0x286C8</span>, <span class="number">0x28774</span>, <span class="number">0x28820</span>,</span><br><span class="line">    <span class="number">0x288CC</span>, <span class="number">0x28A24</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获得linker64的地址</span></span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>;    <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="comment">// 判断是否可以通过findModuleByName查找到目标so文件</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                <span class="comment">// 第一时间hook</span></span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(offset), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[target_func] onEnter, offset:&quot;</span>, offset.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[target_func] onLeave, retval:&quot;</span>, retval);</span><br><span class="line">            <span class="comment">// 第一个函数解密完后，Hook 所有解密函数</span></span><br><span class="line">            <span class="title function_">hook_decrypt_funcs</span>(baseaddr);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_decrypt_funcs</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="comment">// Hook sub_28C28（保持原有逻辑）</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(<span class="number">0x28C28</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[sub_28C28] arg =&quot;</span>, <span class="title function_">ptr</span>(args[<span class="number">0</span>]).<span class="title function_">readCString</span>());</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[sub_28C28] retval =&quot;</span>, <span class="title function_">ptr</span>(retval).<span class="title function_">readCString</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 循环 Hook 所有解密函数</span></span><br><span class="line">    decrypt_offsets.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> func_name = <span class="string">&quot;sub_&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">toUpperCase</span>();</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(offset), &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] arg =&quot;</span>, <span class="title function_">ptr</span>(args[<span class="number">0</span>]).<span class="title function_">readCString</span>());</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] retval =&quot;</span>, <span class="title function_">ptr</span>(retval).<span class="title function_">readCString</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>用ida进行修改并添加注释。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加密/明文映射（从 Frida 输出中提取）</span></span><br><span class="line">mappings = &#123;</span><br><span class="line">    <span class="string">&quot;710E34DFB3D273975E0936FBB4CF62BE541F3CC4A8&quot;</span>: <span class="string">&quot;FeatureLibcProtection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;530A39DDAFCB39A84E1821CEAB8F52BE4F3B34DFAEEC7FA843&quot;</span>: <span class="string">&quot;dalvik/system/DexPathList&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3D7CDAABED5340D60976CFBAFB5560E80D70C9B0F64C40E80F&quot;</span>: <span class="string">&quot;FeatureProtectEnvironment&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5227DBB22926DA554467C6EF2433D6524567F7&quot;</span>: <span class="string">&quot;com/baidu/protect/A&quot;</span>,</span><br><span class="line">    <span class="string">&quot;14D64606364E3C6D&quot;</span>: <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5A483597E76FC0D170423682FE54CBF073&quot;</span>: <span class="string">&quot;FeatureGlobalInfo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;47986CBE0A46F6EE6F8968AD0D5DE7DE429568A914&quot;</span>: <span class="string">&quot;FeatureIntegrityCheck&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5227DBB22926DA554467C6EF2433D6524567F5EF2A34DB795026D2F12E35&quot;</span>: <span class="string">&quot;com/baidu/protect/CrashHandler&quot;</span>,</span><br><span class="line">    <span class="string">&quot;02D740473B583B0914975D1A364D370E15976F&quot;</span>: <span class="string">&quot;com/baidu/protect/B&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0406D0C873B03D581246CD957EA5315F1346FC9761983A5A08&quot;</span>: <span class="string">&quot;com/baidu/protect/AppInfo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C7D432A325E854F696D43CFF27BF03F7&quot;</span>: <span class="string">&quot;c07954f5209e7c14&quot;</span>,</span><br><span class="line">    <span class="string">&quot;67C538FE4857A6C4309F39AB4B06A5C5&quot;</span>: <span class="string">&quot;f8547c5c1b4a426b&quot;</span>,</span><br><span class="line">    <span class="string">&quot;260714BFA582481D715D15EAA6D34B1C785B43B8F385444A705E15EAF3D54C4B&quot;</span>: <span class="string">&quot;f8547c5c1b4a426b8db3ad940a4aa415&quot;</span>,</span><br><span class="line">    <span class="string">&quot;57585C810030ABC6530C06D65363FF9C545A5CD60367A9CD545400D45430A8C9&quot;</span>: <span class="string">&quot;359b71797ac5dbcc07954f5209e7c146&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7E6EA364435927F7&quot;</span>: <span class="string">&quot;.suuid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3148B69D4B47B331&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;61B82D685939526D&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;065A40FFE793182D255C54F9FB95042D0474&quot;</span>: <span class="string">&quot;FeatureSecuritySDK&quot;</span>,</span><br><span class="line">    <span class="string">&quot;1901FAF72A31D21E5D29D8FA6408D15B542BC2A6100BD950472999F12A29D41E7E2ADCF82833881867&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;49F16102384F33420DD9430F7676300704DB59530275380C17D90204385735422EDA470D3A4D69443B&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4F20F18D70A735130B08D3803E9E3656020AC9DC4A9D3E5D1108928B70BF3313280BD78272A56F1525&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)B&quot;</span>,</span><br><span class="line">    <span class="string">&quot;8CAD49F071AA53ECC8856BFD3F9350A9C18771A14B9058A2D2852AF671B255ECEB866FFF73A809EAE7&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)C&quot;</span>,</span><br><span class="line">    <span class="string">&quot;29B441A01E42F2886D9C63AD507BF1CD649E79F12478F9C6779C22A61E5AF4884E9F67AF1C40A88E52&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)S&quot;</span>,</span><br><span class="line">    <span class="string">&quot;68766DE1F3971C512C5E4FECBDAE1F14255C55B0C9AD171F365E0EE7F38F1A510F5D4BEEF195465709&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)I&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4C2429895677FDD0080C0B84184EFE95010E11D86C4DF69E120C4A8F566FFBD02B0F0F865475A7D62E&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)J&quot;</span>,</span><br><span class="line">    <span class="string">&quot;78549A7B4B4B46D83C7CB8760572459D357EA22A71714D96267CF97D4B5340D81F7FBC7449491CDE16&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)F&quot;</span>,</span><br><span class="line">    <span class="string">&quot;8F4502F0DDCDC5C2CB6D20FD93F4C687C26F3AA1E7F7CE8CD16D61F6DDD5C3C2E86E24FFDFCF9FC4E3&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)D&quot;</span>,</span><br><span class="line">    <span class="string">&quot;A34B5090CFED8214E763729D81D48151EE6168C1F5D7895AFD633396CFF58414C460769FCDEFD812C7687D8CCFB48F5AE56533B5CCF18658FF39&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2E68C02CC53A063D255DD337C42D001F0162CF&quot;</span>: <span class="string">&quot;FeatureVMProtection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;F48398ED31542B0E&quot;</span>: <span class="string">&quot;libc.so&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6E2DCEF43F47B331&quot;</span>: <span class="string">&quot;_exit&quot;</span>,</span><br><span class="line">    <span class="string">&quot;04C0441C5939526D&quot;</span>: <span class="string">&quot;exit&quot;</span>,</span><br><span class="line">    <span class="string">&quot;171DD59574B03063041BD88665B4&quot;</span>: <span class="string">&quot;pthread_create&quot;</span>,</span><br><span class="line">    <span class="string">&quot;D4906DE875BD569CCE8B6CF4&quot;</span>: <span class="string">&quot;pthread_join&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6C9860A90F4D93A7&quot;</span>: <span class="string">&quot;memcpy&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2D5E4DE7FD827D7E&quot;</span>: <span class="string">&quot;malloc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;070C098F58629CFF&quot;</span>: <span class="string">&quot;calloc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3D78BB624F4927F7&quot;</span>: <span class="string">&quot;memset&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C1633EFFD2BBA4ED&quot;</span>: <span class="string">&quot;fopen&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ED617095DDFEE33B&quot;</span>: <span class="string">&quot;fclose&quot;</span>,</span><br><span class="line">    <span class="string">&quot;E24E68C72ED3BB4E&quot;</span>: <span class="string">&quot;fgets&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4EFE6FC425A325B6&quot;</span>: <span class="string">&quot;strtoul&quot;</span>,</span><br><span class="line">    <span class="string">&quot;30640DB4A5A47CCE&quot;</span>: <span class="string">&quot;strtoull&quot;</span>,</span><br><span class="line">    <span class="string">&quot;59CA0B1C240EE666&quot;</span>: <span class="string">&quot;strstr&quot;</span>,</span><br><span class="line">    <span class="string">&quot;B3783A25593967C1&quot;</span>: <span class="string">&quot;ptrace&quot;</span>,</span><br><span class="line">    <span class="string">&quot;715D268CE678C6E2&quot;</span>: <span class="string">&quot;mprotect&quot;</span>,</span><br><span class="line">    <span class="string">&quot;678568CC1272D9F4&quot;</span>: <span class="string">&quot;strlen&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4333E40A59E92B6B&quot;</span>: <span class="string">&quot;sscanf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;20C396763EB607CE&quot;</span>: <span class="string">&quot;free&quot;</span>,</span><br><span class="line">    <span class="string">&quot;59EFF51F63070DB8&quot;</span>: <span class="string">&quot;strdup&quot;</span>,</span><br><span class="line">    <span class="string">&quot;1B79D33BDD38636B&quot;</span>: <span class="string">&quot;strcmp&quot;</span>,</span><br><span class="line">    <span class="string">&quot;11EDA0D862CA71BA0FE9&quot;</span>: <span class="string">&quot;strcasecmp&quot;</span>,</span><br><span class="line">    <span class="string">&quot;AD1C8CA1863C3CF3&quot;</span>: <span class="string">&quot;utime&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7F7567B6D496D9AC&quot;</span>: <span class="string">&quot;mkdir&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3F4E6764B2499D86&quot;</span>: <span class="string">&quot;open&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7838B71CCAAF75C6&quot;</span>: <span class="string">&quot;close&quot;</span>,</span><br><span class="line">    <span class="string">&quot;04B2CD050F9C47EE&quot;</span>: <span class="string">&quot;unlink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;086DDAAB98212586&quot;</span>: <span class="string">&quot;stat&quot;</span>,</span><br><span class="line">    <span class="string">&quot;E2292D97D01141B6&quot;</span>: <span class="string">&quot;time&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6E4AC4CB291788D4&quot;</span>: <span class="string">&quot;snprintf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;302FD3054ECECD91&quot;</span>: <span class="string">&quot;strchr&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C65AB9D5625867A8&quot;</span>: <span class="string">&quot;strncmp&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0C8A9ABA3559D876189B86A93350&quot;</span>: <span class="string">&quot;pthread_detach&quot;</span>,</span><br><span class="line">    <span class="string">&quot;B4D5455E4F6B8C3BB7C4414A&quot;</span>: <span class="string">&quot;pthread_self&quot;</span>,</span><br><span class="line">    <span class="string">&quot;A832C433D41105B4&quot;</span>: <span class="string">&quot;opendir&quot;</span>,</span><br><span class="line">    <span class="string">&quot;63C7D8A1855BE1D1&quot;</span>: <span class="string">&quot;readdir&quot;</span>,</span><br><span class="line">    <span class="string">&quot;DD596595BC74408E&quot;</span>: <span class="string">&quot;closedir&quot;</span>,</span><br><span class="line">    <span class="string">&quot;711BD780E966683E&quot;</span>: <span class="string">&quot;mmap&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3B70EDB05642EDB6&quot;</span>: <span class="string">&quot;munmap&quot;</span>,</span><br><span class="line">    <span class="string">&quot;31F4B35BA15DF8D9&quot;</span>: <span class="string">&quot;lseek&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3A7B1DDB8EAEEB3C&quot;</span>: <span class="string">&quot;fstat&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2DC5B93C51DE4E8C&quot;</span>: <span class="string">&quot;read&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CD3E5AC4CE4EB523&quot;</span>: <span class="string">&quot;select&quot;</span>,</span><br><span class="line">    <span class="string">&quot;9C6E379605B933C39F71&quot;</span>: <span class="string">&quot;bsd_signal&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C489B09443666A3D&quot;</span>: <span class="string">&quot;fork&quot;</span>,</span><br><span class="line">    <span class="string">&quot;266DF31562D26748&quot;</span>: <span class="string">&quot;prctl&quot;</span>,</span><br><span class="line">    <span class="string">&quot;176E4794FD670E8110&quot;</span>: <span class="string">&quot;setrlimit&quot;</span>,</span><br><span class="line">    <span class="string">&quot;50660A65A953F202&quot;</span>: <span class="string">&quot;getppid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;9B333E341D4B67D8&quot;</span>: <span class="string">&quot;getpid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;68D77BE990FA40DB&quot;</span>: <span class="string">&quot;waitpid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;03B093571B66B5A9&quot;</span>: <span class="string">&quot;kill&quot;</span>,</span><br><span class="line">    <span class="string">&quot;75F6DC484BF43E44&quot;</span>: <span class="string">&quot;flock&quot;</span>,</span><br><span class="line">    <span class="string">&quot;795BD9475A856CF3&quot;</span>: <span class="string">&quot;write&quot;</span>,</span><br><span class="line">    <span class="string">&quot;BE66196673ACF758&quot;</span>: <span class="string">&quot;execve&quot;</span>,</span><br><span class="line">    <span class="string">&quot;296C25084100FFA8&quot;</span>: <span class="string">&quot;execv&quot;</span>,</span><br><span class="line">    <span class="string">&quot;164C148245E50A35&quot;</span>: <span class="string">&quot;execl&quot;</span>,</span><br><span class="line">    <span class="string">&quot;FEF19D484641B9EC&quot;</span>: <span class="string">&quot;sysconf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;E215844F2E808FC7E23A85592D9198DEC415905329&quot;</span>: <span class="string">&quot;__system_property_get&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C033AAA8B3EE1BBFC3&quot;</span>: <span class="string">&quot;ftruncate&quot;</span>,</span><br><span class="line">    <span class="string">&quot;D818528B9AD01DD0&quot;</span>: <span class="string">&quot;gettid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2E1331FA88B61B58&quot;</span>: <span class="string">&quot;pread64&quot;</span>,</span><br><span class="line">    <span class="string">&quot;8F6EB5FBB011CE0A&quot;</span>: <span class="string">&quot;pwrite64&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3DFBFF6E535AF038&quot;</span>: <span class="string">&quot;pread&quot;</span>,</span><br><span class="line">    <span class="string">&quot;B2D06CEC09B428DF&quot;</span>: <span class="string">&quot;pwrite&quot;</span>,</span><br><span class="line">    <span class="string">&quot;326FA0A56FCADBAB&quot;</span>: <span class="string">&quot;statvfs&quot;</span>,</span><br><span class="line">    <span class="string">&quot;09598DD611D1543C&quot;</span>: <span class="string">&quot;n001&quot;</span>,</span><br><span class="line">    <span class="string">&quot;8CA86FFB66BD1DAFC58A62B543A840AACA833ED67ABD44A28B8864F477F361B7D68D6BFD2B9058A2D2852AF671B255ECF79077F37EBB098FCE8573FB3FB053ADC3CB56EE62B55CA49FAD5FB346&quot;</span>: <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;IZ)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6FCD3DF87F3493A7&quot;</span>: <span class="string">&quot;n002&quot;</span>,</span><br><span class="line">    <span class="string">&quot;687340E5F6931217241042E4FC951810341062E4FC951806340408DD&quot;</span>: <span class="string">&quot;(Landroid/content/Context;)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0A5D55D037019CFF&quot;</span>: <span class="string">&quot;n003&quot;</span>,</span><br><span class="line">    <span class="string">&quot;783480112A3D27F7&quot;</span>: <span class="string">&quot;()V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;226212F6FEFC669A22&quot;</span>: <span class="string">&quot;arm64-v8a&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4819CF8872FE27590B0F928A70A127&quot;</span>: <span class="string">&quot;/proc/self/maps&quot;</span>,</span><br><span class="line">    <span class="string">&quot;D6E4059A10DC32C3&quot;</span>: <span class="string">&quot;r&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6D946FAE0959BDD46E&quot;</span>: <span class="string">&quot;libdvm.so&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2C5643EAE095530D2F&quot;</span>: <span class="string">&quot;libart.so&quot;</span>,</span><br><span class="line">    <span class="string">&quot;080407955A6AF59B3B01008E4273B28C0B&quot;</span>: <span class="string">&quot;libvmkid_lemur.so&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3C74B470455E09843F&quot;</span>: <span class="string">&quot;libaoc.so&quot;</span>,</span><br><span class="line">    <span class="string">&quot;54AFA16C61F747EE&quot;</span>: <span class="string">&quot;%s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;44CB02463B5D3E0202D3&quot;</span>: <span class="string">&quot;%s/.bdlock&quot;</span>,</span><br><span class="line">    <span class="string">&quot;050301915868F8D007020B97526FE8D014004AB05E66F29E10181786&quot;</span>: <span class="string">&quot;android/content/pm/Signature&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3173B263455443D83372B8654F5353D82070F9414B5E4C9637789F7F4C52&quot;</span>: <span class="string">&quot;android/content/pm/PackageInfo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C6622AE8D3D2C0C2C46320EED9D5D0C2D76161CADDD8CF8CC06903FBD2DAC388D5&quot;</span>: <span class="string">&quot;android/content/pm/PackageManager&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EA6C7888C1F28714EA726CD5EFF89752FD6B6883FAF3915EEA66&quot;</span>: <span class="string">&quot;android/app/ActivityThread&quot;</span>,</span><br><span class="line">    <span class="string">&quot;E54769C132BADF61E5597D9C1EBCD53AE15179FA30A3D7&quot;</span>: <span class="string">&quot;android/app/ContextImpl&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5AEF69E333A53DD350C972DE3EB331C2&quot;</span>: <span class="string">&quot;getSystemContext&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6B3933A1A4B562CD2A7450A1BAA13FE12C7E0BA5B2A559CF337C44&quot;</span>: <span class="string">&quot;()Landroid/app/ContextImpl;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;49CB0B1D3512922749CA101939089F3242CC1C0E34&quot;</span>: <span class="string">&quot;currentActivityThread&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EB250425543815AEAA6867254A2C4880A078213253281E95AB7E2D255E67&quot;</span>: <span class="string">&quot;()Landroid/app/ActivityThread;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7B4820B3F37ECEF77B481982FC7CC2F36E&quot;</span>: <span class="string">&quot;getPackageManager&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3CD856C11978AB9B7D9535C31872AD917A8535D01A338995779A7BC71251B89A75967FD24C&quot;</span>: <span class="string">&quot;()Landroid/content/pm/PackageManager;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5725F33B56EC400A5725CE0551E0&quot;</span>: <span class="string">&quot;getPackageInfo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6EFD997248D728A227DF943C6DC275A728D6C85A17FA66A022C39C7A5A9964A128C5967D4A9977A369E1927055D760AB0FDF957C05&quot;</span>: <span class="string">&quot;(Ljava/lang/String;I)Landroid/content/pm/PackageInfo;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;59F2E015770378CA4FE8&quot;</span>: <span class="string">&quot;signatures&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3341C036D43A0C020C22C237DE3C06051C22D1359F1B0A0C066CD52DC22D58&quot;</span>: <span class="string">&quot;[Landroid/content/pm/Signature;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;16F690C277DC55AB10F8AB&quot;</span>: <span class="string">&quot;toByteArray&quot;</span>,</span><br><span class="line">    <span class="string">&quot;F041BE8EE33C3CF3&quot;</span>: <span class="string">&quot;()[B&quot;</span>,</span><br><span class="line">    <span class="string">&quot;376D2CF19796D9AC&quot;</span>: <span class="string">&quot;%s/.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;754D2D248366B8F5&quot;</span>: <span class="string">&quot;%s/.1/%s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EA6C7888C1F28714E47133B8DBF28F5F&quot;</span>: <span class="string">&quot;android/os/Build&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C96649F611D3BB4E&quot;</span>: <span class="string">&quot;MODEL&quot;</span>,</span><br><span class="line">    <span class="string">&quot;71E07CC62BF925D753ED32E33EA420D85AB1&quot;</span>: <span class="string">&quot;Ljava/lang/String;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;E67F6728533E67C1&quot;</span>: <span class="string">&quot;%s/lib&quot;</span>,</span><br><span class="line">    <span class="string">&quot;395E7BCDB779A596&quot;</span>: <span class="string">&quot;%s/.%d&quot;</span>,</span><br><span class="line">    <span class="string">&quot;758269C5036FF69675987ED5076EB68071926E851332B39566&quot;</span>: <span class="string">&quot;assets/baiduprotect%d.jar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;1F71A90156FD2B6B&quot;</span>: <span class="string">&quot;/1.jar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;69D29F724DC562BD68DB9261&quot;</span>: <span class="string">&quot;/classes.jar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;05F8EB1A650468CB04FFE203&quot;</span>: <span class="string">&quot;/classes.dex&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4769C02CD167070A1C6C8E7DC3674D4E0C22C234D13B100E1B23CB39C2&quot;</span>: <span class="string">&quot;/data/data/%s/.%d/classes.jar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4DFDB3CF629670B816F8FD9E70963AFC06B6B1D762CA67BC11B7B6DE7B&quot;</span>: <span class="string">&quot;/data/data/%s/.%d/classes.dex&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0DD14F092B4D300C12DD031B36&quot;</span>: <span class="string">&quot;libartbase.so&quot;</span>,</span><br><span class="line">    <span class="string">&quot;1E38C4F22868C0545D2E99F02A37C0&quot;</span>: <span class="string">&quot;/proc/self/maps&quot;</span>,</span><br><span class="line">    <span class="string">&quot;13B82D685939526D&quot;</span>: <span class="string">&quot;r&quot;</span>,</span><br><span class="line">    <span class="string">&quot;1544909711D1543C&quot;</span>: <span class="string">&quot;r--p&quot;</span>,</span><br><span class="line">    <span class="string">&quot;819725BF63FC17E9D7C420B063FC17E9D7C420E9&quot;</span>: <span class="string">&quot;%s %s %*s %*s %*s %s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;73D075BA7F3493A7&quot;</span>: <span class="string">&quot;r-xp&quot;</span>,</span><br><span class="line">    <span class="string">&quot;FBBB64F474AE5DAAC0BB69F5778342B1CD8A71&quot;</span>: <span class="string">&quot;__android_log_print&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2D5240FB92E17D7E&quot;</span>: <span class="string">&quot;mmap&quot;</span>,</span><br><span class="line">    <span class="string">&quot;503BC5F83F349C535021D2E83B35DC45542BC2B82F69D95043&quot;</span>: <span class="string">&quot;assets/baiduprotect%d.jar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0900049337019CFF&quot;</span>: <span class="string">&quot;mmap&quot;</span>,</span><br><span class="line">    <span class="string">&quot;D2290DB35DD3BB4E&quot;</span>: <span class="string">&quot;V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;678A1DB04AD649B6&quot;</span>: <span class="string">&quot;Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;01107FC0CAD110A2&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">    <span class="string">&quot;69BE796F507CE666&quot;</span>: <span class="string">&quot;C&quot;</span>,</span><br><span class="line">    <span class="string">&quot;900C48443A5C67C1&quot;</span>: <span class="string">&quot;S&quot;</span>,</span><br><span class="line">    <span class="string">&quot;552D54E3921DA596&quot;</span>: <span class="string">&quot;I&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5EF11AA0771CD9F4&quot;</span>: <span class="string">&quot;J&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7640876B378F2B6B&quot;</span>: <span class="string">&quot;F&quot;</span>,</span><br><span class="line">    <span class="string">&quot;02B1F3133EB607CE&quot;</span>: <span class="string">&quot;D&quot;</span>,</span><br><span class="line">    <span class="string">&quot;669B877B16770DB8&quot;</span>: <span class="string">&quot;L&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6A0EB69D4B47B331&quot;</span>: <span class="string">&quot;[F&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3AFC2D685939526D&quot;</span>: <span class="string">&quot;[D&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0D08CB863EBD35520046FF887EBD315D09&quot;</span>: <span class="string">&quot;java/lang/Boolean&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CE8573FB3FB053ADC3CB47E364B9&quot;</span>: <span class="string">&quot;java/lang/Byte&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6B9C7BAB5058F2C966D24EA21E46F2C475987F&quot;</span>: <span class="string">&quot;java/lang/Character&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2A5E57EABD8D1C10271072E3FD9309&quot;</span>: <span class="string">&quot;java/lang/Short&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0E0C1382186DFD9103422C8D4364FB9A16&quot;</span>: <span class="string">&quot;java/lang/Integer&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3A7CA0700551469937329A7E445A&quot;</span>: <span class="string">&quot;java/lang/Long&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CD6D38FB93D7C583C02308F6D3DAD0&quot;</span>: <span class="string">&quot;java/lang/Float&quot;</span>,</span><br><span class="line">    <span class="string">&quot;E1636A9B81F78255EC2D5895DBF98F5E&quot;</span>: <span class="string">&quot;java/lang/Double&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EE487BD272BFDA20E30642D137B6D83A&quot;</span>: <span class="string">&quot;java/lang/Object&quot;</span>,</span><br><span class="line">    <span class="string">&quot;01E373D93EE849B6&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6B4A5696CAD110A2&quot;</span>: <span class="string">&quot;(Z)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;16D717062442E666&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EB4E61123A5C67C1&quot;</span>: <span class="string">&quot;(B)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;20443A8AE623A596&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3CB233F6771CD9F4&quot;</span>: <span class="string">&quot;(C)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0C29E90243B12B6B&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6EE2DA453EB607CE&quot;</span>: <span class="string">&quot;(S)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;16F2E91262490DB8&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4044880EB048636B&quot;</span>: <span class="string">&quot;(I)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5EF0BCD2778714D9&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;F022CC9AE33C3CF3&quot;</span>: <span class="string">&quot;(J)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2E776DB6D2A8D9AC&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;78782B5CB2499D86&quot;</span>: <span class="string">&quot;(F)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;273DB606DB9175C6&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5998883A61F747EE&quot;</span>: <span class="string">&quot;(D)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;1976D4B3FD404BD01A75CEBA&quot;</span>: <span class="string">&quot;booleanValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;BE691AF2D01141B6&quot;</span>: <span class="string">&quot;()Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7F5DC0DC161890C778&quot;</span>: <span class="string">&quot;byteValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6B72E36626BCCD91&quot;</span>: <span class="string">&quot;()B&quot;</span>,</span><br><span class="line">    <span class="string">&quot;D646AAC957547BDDD0&quot;</span>: <span class="string">&quot;charValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;54D7B1C85038BC29&quot;</span>: <span class="string">&quot;()C&quot;</span>,</span><br><span class="line">    <span class="string">&quot;B7C9425E5E5C8908B1C4&quot;</span>: <span class="string">&quot;shortValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EF6BF25DB07877B4&quot;</span>: <span class="string">&quot;()S&quot;</span>,</span><br><span class="line">    <span class="string">&quot;78CCCD93805EE6B4&quot;</span>: <span class="string">&quot;intValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;961C43E6D91029FC&quot;</span>: <span class="string">&quot;()I&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7019D897BF07044B79&quot;</span>: <span class="string">&quot;longValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7E2CC9DD3732EDB6&quot;</span>: <span class="string">&quot;()J&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3BEBB95FBE0B99B528E2&quot;</span>: <span class="string">&quot;floatValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;74212FBAFAAEEB3C&quot;</span>: <span class="string">&quot;()F&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3BCFAD3A3DBB18ED33D5BD&quot;</span>: <span class="string">&quot;doubleValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;967272A1AD3AB523&quot;</span>: <span class="string">&quot;()D&quot;</span>,</span><br><span class="line">    <span class="string">&quot;947C25A859BC35C3993200BD04B93ACA&quot;</span>: <span class="string">&quot;java/lang/String&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CB88B69A31086A3D&quot;</span>: <span class="string">&quot;intern&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7E36DC0B6FA406673A7EFE062181133A3F71F75A&quot;</span>: <span class="string">&quot;()Ljava/lang/String;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0406D0C873B03D581246C59479B831500346DC843E891C&quot;</span>: <span class="string">&quot;com/baidu/xshield/ac/XH&quot;</span>,</span><br><span class="line">    <span class="string">&quot;8CA864F474AE5DAAC0CB66F57EA857ADD0CB46F57EA857BBD0DF49F071AA53ECC8856BFD3F8F46B1CD8A62A15CB653B5C5CB69FB7EBB1D90D0966CF477E7698A8DB2&quot;</span>: <span class="string">&quot;(Landroid/content/Context;Ljava/lang/String;Ljava/lang/String;[I)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;689364BE7F3493A7&quot;</span>: <span class="string">&quot;init&quot;</span>,</span><br><span class="line">    <span class="string">&quot;503BC5F83F349C535021D2E83B35DC45542BC2B326&quot;</span>: <span class="string">&quot;assets/baiduprotect.m&quot;</span>,</span><br><span class="line">    <span class="string">&quot;44CB2D685939526D&quot;</span>: <span class="string">&quot;%s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3E27F603C0CC1EC6&quot;</span>: <span class="string">&quot;%s.lock&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 函数列表（从 Frida 输出中提取涉及的函数地址）</span></span><br><span class="line">func_list = [</span><br><span class="line">    <span class="number">0x28C28</span>,  <span class="comment"># sub_28C28</span></span><br><span class="line">    <span class="number">0x2709C</span>,  <span class="comment"># sub_2709C</span></span><br><span class="line">    <span class="number">0x25E78</span>,  <span class="comment"># sub_25E78</span></span><br><span class="line">    <span class="number">0x25F24</span>,  <span class="comment"># sub_25F24</span></span><br><span class="line">    <span class="number">0x25FD0</span>,  <span class="comment"># sub_25FD0</span></span><br><span class="line">    <span class="number">0x2607C</span>,  <span class="comment"># sub_2607C</span></span><br><span class="line">    <span class="number">0x26128</span>,  <span class="comment"># sub_26128</span></span><br><span class="line">    <span class="number">0x261D4</span>,  <span class="comment"># sub_261D4</span></span><br><span class="line">    <span class="number">0x26280</span>,  <span class="comment"># sub_26280</span></span><br><span class="line">    <span class="number">0x2632C</span>,  <span class="comment"># sub_2632C</span></span><br><span class="line">    <span class="number">0x263D8</span>,  <span class="comment"># sub_263D8</span></span><br><span class="line">    <span class="number">0x26484</span>,  <span class="comment"># sub_26484</span></span><br><span class="line">    <span class="number">0x26BE8</span>,  <span class="comment"># sub_26BE8</span></span><br><span class="line">    <span class="number">0x28AD0</span>   <span class="comment"># sub_28AD0</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_string_addr</span>(<span class="params">search_str</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;查找字符串的地址&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> addr <span class="keyword">in</span> idautils.Strings():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">str</span>(addr) == search_str:</span><br><span class="line">            <span class="keyword">return</span> addr.ea</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resolve_func_addr</span>(<span class="params">func_entry</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;将函数名或地址转换为地址&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(func_entry, <span class="built_in">int</span>):</span><br><span class="line">        <span class="keyword">return</span> func_entry</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(func_entry, <span class="built_in">str</span>):</span><br><span class="line">        func_addr = idaapi.get_name_ea_simple(func_entry)</span><br><span class="line">        <span class="keyword">if</span> func_addr == idaapi.BADADDR:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Function not found: <span class="subst">&#123;func_entry&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> func_addr</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Invalid function entry: <span class="subst">&#123;func_entry&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_comments_to_strings</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;为 .rodata 中的字符串添加解密注释和重命名&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> encrypted, decrypted <span class="keyword">in</span> mappings.items():</span><br><span class="line">        str_addr = find_string_addr(encrypted)</span><br><span class="line">        <span class="keyword">if</span> str_addr:</span><br><span class="line">            idaapi.set_cmt(str_addr, <span class="string">f&quot;Decrypted: <span class="subst">&#123;decrypted&#125;</span>&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            <span class="comment"># 重命名字符串，替换特殊字符以符合命名规则</span></span><br><span class="line">            safe_name = <span class="string">f&quot;str_<span class="subst">&#123;decrypted.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;_&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;_&#x27;</span>).replace(<span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;_&#x27;</span>).replace(<span class="string">&#x27;)&#x27;</span>, <span class="string">&#x27;_&#x27;</span>).replace(<span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;_&#x27;</span>).replace(<span class="string">&#x27;[&#x27;</span>, <span class="string">&#x27;_&#x27;</span>).replace(<span class="string">&#x27;]&#x27;</span>, <span class="string">&#x27;_&#x27;</span>)&#125;</span>&quot;</span></span><br><span class="line">            idaapi.set_name(str_addr, safe_name, idaapi.SN_FORCE)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Added comment at 0x<span class="subst">&#123;str_addr:x&#125;</span>: <span class="subst">&#123;encrypted&#125;</span> -&gt; <span class="subst">&#123;decrypted&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;String not found in .rodata: <span class="subst">&#123;encrypted&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_comments_to_function</span>(<span class="params">func_addr</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;为指定函数添加注释，扫描加载字符串的指令&quot;&quot;&quot;</span></span><br><span class="line">    func = idaapi.get_func(func_addr)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> func:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Function at 0x<span class="subst">&#123;func_addr:x&#125;</span> not found or invalid&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加函数注释</span></span><br><span class="line">    func_name = idaapi.get_func_name(func_addr)</span><br><span class="line">    idaapi.set_func_cmt(func_addr, <span class="string">f&quot;Decrypts strings (e.g., <span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(<span class="string">f&#x27;<span class="subst">&#123;k&#125;</span>-&gt;<span class="subst">&#123;v&#125;</span>&#x27;</span> <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">list</span>(mappings.items())[:<span class="number">5</span>])&#125;</span>...)&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Processing function: <span class="subst">&#123;func_name&#125;</span> at 0x<span class="subst">&#123;func_addr:x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 扫描函数指令，查找加载字符串的指令</span></span><br><span class="line">    <span class="keyword">for</span> ea <span class="keyword">in</span> idautils.FuncItems(func.start_ea):</span><br><span class="line">        disasm = idaapi.generate_disasm_line(ea, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;LDR&quot;</span> <span class="keyword">in</span> disasm:  <span class="comment"># 检查加载指令</span></span><br><span class="line">            <span class="keyword">for</span> enc, dec <span class="keyword">in</span> mappings.items():</span><br><span class="line">                <span class="keyword">if</span> enc <span class="keyword">in</span> disasm:</span><br><span class="line">                    idaapi.set_cmt(ea, <span class="string">f&quot;Loads <span class="subst">&#123;enc&#125;</span> -&gt; <span class="subst">&#123;dec&#125;</span>&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;Added comment at 0x<span class="subst">&#123;ea:x&#125;</span>: <span class="subst">&#123;enc&#125;</span> -&gt; <span class="subst">&#123;dec&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主函数：处理字符串和函数列表&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 处理 .rodata 中的字符串</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Processing strings in .rodata...&quot;</span>)</span><br><span class="line">    add_comments_to_strings()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 处理函数列表</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nProcessing functions...&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> func_entry <span class="keyword">in</span> func_list:</span><br><span class="line">        func_addr = resolve_func_addr(func_entry)</span><br><span class="line">        <span class="keyword">if</span> func_addr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            add_comments_to_function(func_addr)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Skipping invalid function: <span class="subst">&#123;func_entry&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行脚本</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>效果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508133149140.png" alt="image-20250508133149140"></p>
<p>由于解密我在hook的脚本里，设置第一个参数是字符串，而在sub_b3b4中，有些解密函数的参数是字节码，因此还需要补充5个解密函数的hook。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 要 hook 的 so 文件名字</span></span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"><span class="comment">// so 文件的大小</span></span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 默认的目标函数偏移</span></span><br><span class="line"><span class="keyword">var</span> target_offset = <span class="number">0x88060</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要 hook 的字节码解密函数偏移列表</span></span><br><span class="line"><span class="keyword">var</span> bytecode_decrypt_offsets = [</span><br><span class="line">    <span class="number">0x267e0</span>, <span class="number">0x26A90</span>, <span class="number">0x27550</span>, <span class="number">0x27800</span>, <span class="number">0x28418</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook linker64 的 call_constructors，检测目标 so 文件加载</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                <span class="comment">// 第一时间 hook 目标函数</span></span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 目标函数（触发后续字节码解密函数的 hook）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(target_offset), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[target_func] onEnter, offset: 0x&quot;</span> + target_offset.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[target_func] onLeave, retval: &quot;</span> + retval);</span><br><span class="line">            <span class="comment">// 在目标函数退出时，hook 所有字节码解密函数</span></span><br><span class="line">            <span class="title function_">hook_bytecode_decrypt_funcs</span>(baseaddr);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 指定的字节码解密函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_bytecode_decrypt_funcs</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    bytecode_decrypt_offsets.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> func_name = <span class="string">&quot;sub_&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">toUpperCase</span>();</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(offset), &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> input_ptr = args[<span class="number">0</span>]; <span class="comment">// 捕获输入指针（指向字节数组）</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] Input pointer: &quot;</span> + input_ptr);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 读取以 0x00 结尾的字节数组</span></span><br><span class="line">                <span class="keyword">let</span> bytes = [];</span><br><span class="line">                <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> byte = <span class="title class_">Memory</span>.<span class="title function_">readU8</span>(input_ptr.<span class="title function_">add</span>(i));</span><br><span class="line">                    <span class="keyword">if</span> (byte === <span class="number">0x00</span>) <span class="keyword">break</span>; <span class="comment">// 遇到 0x00 停止</span></span><br><span class="line">                    bytes.<span class="title function_">push</span>(byte.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                    i++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] Input bytes: &quot;</span> + bytes.<span class="title function_">join</span>(<span class="string">&quot;, &quot;</span>));</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="comment">// 捕获返回值（解密后的字符串）</span></span><br><span class="line">                <span class="keyword">let</span> output_str = retval.<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] Output string: &quot;</span> + output_str);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主逻辑：启动 hook</span></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>看得出来，sub_b3b4负责解密字符串，因此改名成这个。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508133416118.png" alt="image-20250508133416118"></p>
<p>接下来看其它的函数，根据分析，当a2&#x3D;&#x3D;1时，只执行sub_B3B4。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130512877.png" alt="image-20250508130512877" style="zoom: 67%;" />

<p>回到JNI_OnLoad，继续分析sub_91E4。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508134058128.png" alt="image-20250508134058128" style="zoom:67%;" />

<p>可以看出来，在进行JNI动态注册，所以给它改了些函数名及变量名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508134858811.png" alt="image-20250508134858811"></p>
<p>回到JNI_OnLoad，我一直很好奇剩下的fread是什么东西？下图是别人对同样的so文件的分析，它这里伪代码是gettimeofday，那就很好理解了，在计算时间差，一般计算时间差是为了反调试，博主说这里只是收集信息。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/745332_UJ2HKKKE2VPQ7PW.png" alt="745332_UJ2HKKKE2VPQ7PW"></p>
<p>接下来可以分析第a2&#x3D;&#x3D;2的时候，会调用什么内容。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508140130462.png" alt="image-20250508140130462"></p>
<p>已知B3B4只当a2&#x3D;&#x3D;1时才调用，这里从3E29C开始分析。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130512877.png" alt="image-20250508130512877" style="zoom: 67%;" />

<p>直接分析3E36C。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508140313511.png" alt="image-20250508140313511" style="zoom:80%;" />

<p>再进入3E3F0。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508142124937.png" alt="image-20250508142124937" style="zoom: 67%;" />

<p>3E3F0这两个函数很奇怪，似乎是我dump出现了点bug？</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508142155835.png" alt="image-20250508142155835"></p>
<p>和博主dump下来的so不太一样呢。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508142103062.png" alt="image-20250508142103062"></p>
<p>用博主的图来讲函数3E3F0，大概是通过&#x2F;proc&#x2F;self&#x2F;maps获取进程虚拟机类型。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508142607362.png" alt="image-20250508142607362"></p>
<p>这样子分析下去有点难受，我重新dump了一个，还是这样子，难道是壳做了什么手脚？——保留疑惑。看了一下修复的soFixer，它github写着。——阿这。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508144748157.png" alt="image-20250508144748157"></p>
<p>之后换了一个so修复的程序，需要自己编译。</p>
<p>链接：<a target="_blank" rel="noopener" href="https://github.com/maiyao1988/elf-dump-fix">https://github.com/maiyao1988/elf-dump-fix</a></p>
<p>再次查看3e3f0，这回终于没问题了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508171016443.png" alt="image-20250508171016443" style="zoom:67%;" />

<p>继续看函数列表，发现当a2&#x3D;&#x3D;2时，只执行了3E29C。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130512877.png" alt="image-20250508130512877" style="zoom: 67%;" />

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此，libbaiduprotect.so加载完了，总结一下：</p>
<ol>
<li>在.init_array的sub_88060进行解密，对so里的一些关键函数进行恢复。</li>
<li>下述这些函数，统统在<strong>全局函数列表</strong>处进行注册添加，等待调用。</li>
</ol>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130512877.png" alt="image-20250508130512877" style="zoom: 67%;" />

<ol start="3">
<li><p>在JNI_OnLoad处。</p>
<p>sub_B3B4（a2&#x3D;&#x3D;1）解密了一些libc常用的函数地址，存在全局变量中。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508180536833.png" alt="image-20250508180536833" style="zoom:50%;" />

<p>sub_91E4处，进行JNI动态注册，注册了n001、n002、n003共3个JNI函数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508180647854.png" alt="image-20250508180647854"></p>
<p>sub_3E29C（a2&#x3D;&#x3D;2）执行了下面的内容，获取最大IO向量数量并获得虚拟机类型。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508191242049.png" alt="image-20250508191242049"></p>
</li>
</ol>
<h1 id="JNI函数分析（attachBaseContext-onCreate）"><a href="#JNI函数分析（attachBaseContext-onCreate）" class="headerlink" title="JNI函数分析（attachBaseContext&#x2F;onCreate）"></a>JNI函数分析（attachBaseContext&#x2F;onCreate）</h1><h2 id="n001"><a href="#n001" class="headerlink" title="n001"></a>n001</h2><p>Java层的n001，对应于sub_91E4注册的3个函数的第1个函数。</p>
<p>通过分析，得知n001属于类com.baidu.protect.A。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508192514683.png" alt="image-20250508192514683" style="zoom:67%;" />

<p>然后在com.baidu.protect.StubApplication类的attachBaseContext中进行调用。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508192627062.png" alt="image-20250508192627062"></p>
<p>接下来进入native层进行分析。</p>
<p>首先简单的改了一下名字和类型。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508194738777.png" alt="image-20250508194738777" style="zoom:67%;" />

<p>下图中，还原了一些函数名。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509141717335.png" alt="image-20250509141717335" style="zoom: 67%;" />

<p>先来分析sub_95B4。</p>
<p>下面两个图中，可以看到函数sub_968C的参数列表不一样。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509142032751.png" alt="image-20250509142032751" style="zoom: 67%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509142046768.png" alt="image-20250509142046768" style="zoom: 67%;" />

<p>在sub_95B4调用sub_968C的地方，进入汇编层分析。</p>
<p>可以看到，前sub_968C的前两个参数是sub_9584的前两个参数，而X2 &#x3D; X19 + X1 &#x3D; strlen(X1) + X1，因此，sub_968C的参数列表应该是3个参数，第3个参数是a2字符串的结束地址。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509142257558.png" alt="image-20250509142257558" style="zoom:67%;" />

<p>修改后是这样。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509142546267.png" alt="image-20250509142546267" style="zoom:80%;" />

<p>进入sub_968C进行分析，修改了一些变量名后，如下图所示。</p>
<p>它大致是一个管理缓冲区的函数，将字符串复制到目标缓冲区，并防止缓冲区溢出，重命名为buffer_manager。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509142702869.png" alt="image-20250509142702869"></p>
<p>回到n001的JNI函数，继续往下分析，尝试hook decrypt_str2，观察返回值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509163101547.png" alt="image-20250509163101547"></p>
<p>hook的脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 要 hook 的 so 文件名字</span></span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"><span class="comment">// so 文件的大小</span></span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 默认的目标函数偏移</span></span><br><span class="line"><span class="keyword">var</span> target_offset = <span class="number">0x88060</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要 hook 的字节码解密函数偏移列表</span></span><br><span class="line"><span class="keyword">var</span> bytecode_decrypt_offsets = [</span><br><span class="line">    <span class="number">0x95F4</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook linker64 的 call_constructors，检测目标 so 文件加载</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                <span class="comment">// 第一时间 hook 目标函数</span></span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 目标函数（触发后续字节码解密函数的 hook）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(target_offset), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[target_func] onEnter, offset: 0x&quot;</span> + target_offset.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[target_func] onLeave, retval: &quot;</span> + retval);</span><br><span class="line">            <span class="comment">// 在目标函数退出时，hook 所有字节码解密函数</span></span><br><span class="line">            <span class="title function_">hook_bytecode_decrypt_funcs</span>(baseaddr);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 指定的字节码解密函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_bytecode_decrypt_funcs</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    bytecode_decrypt_offsets.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> func_name = <span class="string">&quot;sub_&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">toUpperCase</span>();</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(offset), &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> input_ptr = args[<span class="number">0</span>]; <span class="comment">// 捕获输入指针（指向字节数组）</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] Input pointer: &quot;</span> + input_ptr);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 读取以 0x00 结尾的字节数组</span></span><br><span class="line">                <span class="keyword">let</span> bytes = [];</span><br><span class="line">                <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> byte = <span class="title class_">Memory</span>.<span class="title function_">readU8</span>(input_ptr.<span class="title function_">add</span>(i));</span><br><span class="line">                    <span class="keyword">if</span> (byte === <span class="number">0x00</span>) <span class="keyword">break</span>; <span class="comment">// 遇到 0x00 停止</span></span><br><span class="line">                    bytes.<span class="title function_">push</span>(byte.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                    i++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] Input bytes: &quot;</span> + bytes.<span class="title function_">join</span>(<span class="string">&quot;, &quot;</span>));</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="comment">// 捕获返回值（解密后的字符串）</span></span><br><span class="line">                <span class="keyword">let</span> output_str = retval.<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] Output string: &quot;</span> + output_str);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主逻辑：启动 hook</span></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>打印的结果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509163338561.png" alt="image-20250509163338561"></p>
<p>打印了几个字符串，BCDB0[0]的值是BE660，因此可以确定，&#x2F;data&#x2F;user&#x2F;0&#x2F;com.example.test是我们要找的解密字符串。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509163951244.png" alt="image-20250509163951244" style="zoom:67%;" />

<p>之后又调用函数sub_95FC。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509170223847.png" alt="image-20250509170223847"></p>
<p>在这个函数中，创建了文件&#x2F;data&#x2F;user&#x2F;0&#x2F;com.example.test&#x2F;.bdlock，然后通过flock函数上锁（文件锁）。更名为open_and_lock。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509170400314.png" alt="image-20250509170400314"></p>
<p>之后再分析sub_781C，又有混淆，通过d810去一下混淆，又调用函数列表，这回调用a2&#x3D;&#x3D;3的情况。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509183928072.png" alt="image-20250509183928072" style="zoom:80%;" />

<p>观察函数列表的函数，先整理出有哪些函数当a2&#x3D;&#x3D;3的时候执行。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130512877.png" alt="image-20250508130512877" style="zoom: 67%;" />

<p>经过整理，会执行3E29C、40CF8（与java层传入的arg5有关）、3DFC4、11F5C、45964。</p>
<h3 id="sub-3E29C-a2-3"><a href="#sub-3E29C-a2-3" class="headerlink" title="sub_3E29C(a2&#x3D;&#x3D;3)"></a>sub_3E29C(a2&#x3D;&#x3D;3)</h3><p>先分析3E29C。</p>
<p>查看call_funcs_list，传入的参数为：a1是函数列表，a2是3，a3是env。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509191538468.png" alt="image-20250509191538468" style="zoom: 67%;" />

<p>进入sub_13880进行查看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509194725564.png" alt="image-20250509194725564"></p>
<p>解密了很多系统库中的函数名，通过JNI进行调用。</p>
<p>这一块代码有点怪，v29应该传入getPackageInfo的函数参数里的，可以从汇编看看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509194808323.png" alt="image-20250509194808323"></p>
<p>如下图所示，应该有5个参数。（arm64支持X0-X7传递参数）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509195624108.png" alt="image-20250509195624108"></p>
<p>但这里不能修改一下callxxxxx的函数签名，因为他是一个不定长的函数调用。但我们知道，a2是一个字符串（包名，稍微追踪一下，发现是在JNI_OnLoad赋值的，当时没改名字，现在苦苦分析）。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509200504526.png" alt="image-20250509200504526" style="zoom:80%;" />

<p>flags的值是0x40，代表返回PackageInfo的PackageInfo对象，包含签名信息。（如果不填0x40，返回的PackageInfo对象中的signatures字段将会是null）</p>
<p>继续分析，为他们修改注释和变量名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509204903121.png" alt="image-20250509204903121"></p>
<p>进入sub_3AE58，直接返回16字节，有点像md5的初始化常量。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509205051133.png" alt="image-20250509205051133"></p>
<p>借助大模型的力量，我成功识别了md5的相关函数，不过也说明了算法是我的薄弱点，得找时间好好看看。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509211428955.png" alt="image-20250509211428955" style="zoom:80%;" />

<p>分析完了，sub_13880的行为：根据签名数组的第0个签名生成md5，赋值给a3并返回。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509212723680.png" alt="image-20250509212723680"></p>
<p>接着看sub_66064。</p>
<p>在sub_65E94中，会根据md5的值，在result地址+8的为止，根据md5，累积异或产生了16个新字节（假如记作buf1）。</p>
<p>在sub_64A50中，result将指向ptr_result+1的位置，也就是result &#x3D; buf1，然后在sub_64A50中，根据buf1的最后4个字节，又生成了160个字节，也就是说，result指向的字节数组大小为176。</p>
<p>因此，将sub_66064命名为md5_extend_176。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510094601966.png" alt="image-20250510094601966"></p>
<p>整理一下，sub_3E29C得到了一个md5和一个基于md5的176字节。</p>
<h3 id="sub-40cf8-a2-3"><a href="#sub-40cf8-a2-3" class="headerlink" title="sub_40cf8(a2&#x3D;&#x3D;3)"></a>sub_40cf8(a2&#x3D;&#x3D;3)</h3><p>继续看，下一个看40CF8——3E29C、40CF8（与java层传入的arg5有关）、3DFC4、11F5C、45964。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510095619450.png" alt="image-20250510095619450"></p>
<p>这里的BCE28，和n001传入的arg5有关。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510095704606.png" alt="image-20250510095704606"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510095818583.png" alt="image-20250510095818583"></p>
<p>为了确定这个值，尝试hook一下Java层的n001，脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_n001</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> clazz_A = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.baidu.protect.A&quot;</span>);</span><br><span class="line">        clazz_A.<span class="property">n001</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">arg0, arg1, arg2, arg3, arg4, arg5</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[arg0] &quot;</span>, arg0);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[arg1] &quot;</span>, arg1);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[arg2] &quot;</span>, arg2);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[arg3] &quot;</span>, arg3);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[arg4] &quot;</span>, arg4);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[arg5] &quot;</span>, arg5);</span><br><span class="line">            <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">n001</span>(arg0,arg1,arg2,arg3,arg4,arg5);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_n001);</span><br></pre></td></tr></table></figure>

<p>结果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510101348916.png" alt="image-20250510101348916"></p>
<p>从调用的地方可以猜到含义，分别代表着：包名、app名、apk路径、数据路径、sdk版本、是否报崩溃的错误。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510101848906.png" alt="image-20250510101848906"></p>
<p>回到40CF8，这回知道了off_BCE28的含义了，用来判断是否上报crash信息的，那40CF8的这段代码，应该是用来处理崩溃信息上传的？</p>
<p>在调用call_funcs_list这个函数中，调用函数列表每个函数的传参方式是：函数地址、a2、env、a4、a5、a6。（a3就是env）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510103253286.png" alt="image-20250510103253286"></p>
<p>因此，在40CF8中，sub_409E0和sub_40F38的传参就好懂了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510102611433.png" alt="image-20250510102611433" style="zoom: 67%;" />

<p>先进入409E0，修改a2的类型，看样子是注册了两个函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510103527181.png" alt="image-20250510103527181" style="zoom: 67%;" />

<p>交叉引用qword_BE808，找到它赋值的位置，发现它是一个之前的解密字符串，“com&#x2F;baidu&#x2F;protect&#x2F;CrashHandler”。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510105100608.png" alt="image-20250510105100608"></p>
<p>鉴于sub_7398、sub_409E0等函数还存在字符串未解密，这里先把它们的解密字符串收集起来，就不提供脚本了，脚本都大差不差。</p>
<p>回到409e0。</p>
<p>有些搞不明白这里的v10与v11的关系，v11按理来说应该是异常的回调函数，但这里的写法我确实没看懂。</p>
<p>总之，sub_409E0动态注册了com.baidu.protect.CrashHandler.a()和com.baidu.protect.CrashHandler.b(Ljava&#x2F;lang&#x2F;String)。</p>
<p>同时，注册了一个统一的自定义处理函数sub_40bd0，负责处理异常。</p>
<p>综上所述，直接将这个函数改名成处理异常。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510120359482.png" alt="image-20250510120359482"></p>
<p>回到40cf8，这个函数在a2&#x3D;&#x3D;3时，做了下面的操作，接着看下一个函数列表的函数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510140228861.png" alt="image-20250510140228861"></p>
<h3 id="sub-3DFC4-a2-3"><a href="#sub-3DFC4-a2-3" class="headerlink" title="sub_3DFC4(a2&#x3D;&#x3D;3)"></a>sub_3DFC4(a2&#x3D;&#x3D;3)</h3><p>该看3DFC4了——3E29C、40CF8（与java层传入的arg5有关）、3DFC4、11F5C、45964。</p>
<p>先将a3的类型改为JNIEnv*，然后尝试阅读一下代码。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510143523604.png" alt="image-20250510143523604"></p>
<p>这一个函数的难度，比我想象中难很多啊，博客说，3D6AC是3DFC4的关键函数…点进去一看，不知道3D6AC在做什么，ptr_buf的大小是0x13E80，不妨hook sub_3d6ac，观察结束后，ptr_buf的内容是多少。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510143621535.png" alt="image-20250510143621535"></p>
<p>脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Frida脚本：hexdump sub_3D6AC的第一个参数ptr_buf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 请将 &quot;libyourtarget.so&quot; 替换为目标SO文件的实际名称</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">TARGET_MODULE_NAME</span> = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 这是 sub_3D6AC 函数在SO文件中的偏移地址</span></span><br><span class="line"><span class="comment">//    如果 &quot;sub_3D6AC&quot; 是一个导出的函数名，你可以尝试使用 Module.findExportByName()</span></span><br><span class="line"><span class="comment">//    但通常这种 &quot;sub_XXXXX&quot; 格式的名称是IDA反编译后基于地址命名的，所以使用偏移量更可靠。</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FUNCTION_OFFSET</span> = <span class="number">0x3D6AC</span>; <span class="comment">// 函数 sub_3D6AC 的偏移地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ptr_buf 指向的内存区域大小</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">BUFFER_SIZE</span> = <span class="number">0x13e80</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (可选) 你想在hexdump中实际打印的最大字节数，以防BUFFER_SIZE过大导致控制台输出混乱</span></span><br><span class="line"><span class="comment">// 如果你想打印全部内容，可以将MAX_DUMP_SIZE设置为BUFFER_SIZE</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MAX_DUMP_SIZE</span> = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable constant_">BUFFER_SIZE</span>); <span class="comment">// 例如，最多打印1024字节</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获得linker64的地址</span></span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>;    <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="comment">// 判断是否可以通过findModuleByName查找到目标so文件</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="variable constant_">TARGET_MODULE_NAME</span>);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 第一时间hook</span></span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(<span class="number">0x88060</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="comment">// 第一个函数解密完后，才能hook sub_28c28</span></span><br><span class="line">            <span class="title function_">main</span>(baseaddr);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params">base</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> moduleBase = base;</span><br><span class="line">    <span class="keyword">if</span> (!moduleBase) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] 模块 &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot; 未找到。请确保模块名正确且已加载。&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> targetFunctionAddr = moduleBase.<span class="title function_">add</span>(<span class="variable constant_">FUNCTION_OFFSET</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] 目标函数 sub_3D6AC 地址: &quot;</span> + targetFunctionAddr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] ptr_buf 大小: 0x&quot;</span> + <span class="variable constant_">BUFFER_SIZE</span>.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; (&quot;</span> + <span class="variable constant_">BUFFER_SIZE</span> + <span class="string">&quot; bytes)&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] hexdump 将显示最多: 0x&quot;</span> + <span class="variable constant_">MAX_DUMP_SIZE</span>.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; (&quot;</span> + <span class="variable constant_">MAX_DUMP_SIZE</span> + <span class="string">&quot; bytes)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(targetFunctionAddr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="comment">// args[0] 是第一个参数 (__int64 a1, 即 ptr_buf)</span></span><br><span class="line">            <span class="comment">// args[1] 是第二个参数 (JNIEnv *env)</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ptr_buf</span> = args[<span class="number">0</span>]; <span class="comment">// 保存 ptr_buf 的指针以在 onLeave 中使用</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">jniEnv</span> = args[<span class="number">1</span>];  <span class="comment">// 保存 JNIEnv 指针</span></span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n[*] 进入 sub_3D6AC:&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    ptr_buf (a1): &quot;</span> + <span class="variable language_">this</span>.<span class="property">ptr_buf</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    JNIEnv* (a2): &quot;</span> + <span class="variable language_">this</span>.<span class="property">jniEnv</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] 离开 sub_3D6AC. 返回值: &quot;</span> + retval);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">ptr_buf</span> &amp;&amp; !<span class="variable language_">this</span>.<span class="property">ptr_buf</span>.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] ptr_buf (&quot;</span> + <span class="variable language_">this</span>.<span class="property">ptr_buf</span> + <span class="string">&quot;) 内容 (前 &quot;</span> + <span class="variable constant_">MAX_DUMP_SIZE</span> + <span class="string">&quot; 字节):&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// Memory.readByteArray(pointer, length) 返回一个 ArrayBuffer</span></span><br><span class="line">                    <span class="keyword">const</span> bufferContent = <span class="title class_">Memory</span>.<span class="title function_">readByteArray</span>(<span class="variable language_">this</span>.<span class="property">ptr_buf</span>, <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable constant_">BUFFER_SIZE</span>, <span class="variable constant_">MAX_DUMP_SIZE</span>));</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(bufferContent, &#123;</span><br><span class="line">                        <span class="attr">offset</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="attr">length</span>: <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable constant_">BUFFER_SIZE</span>, <span class="variable constant_">MAX_DUMP_SIZE</span>), <span class="comment">// 确保hexdump长度与读取长度一致</span></span><br><span class="line">                        <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">                        <span class="attr">ansi</span>: <span class="literal">true</span> <span class="comment">// 如果你的控制台支持，可以开启颜色高亮</span></span><br><span class="line">                    &#125;));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 如果你想保存整个缓冲区到文件（这部分比较复杂，通常建议在PC端Python脚本中处理）</span></span><br><span class="line">                    <span class="comment">// 你可以在这里发送 bufferContent (或者 this.ptr_buf 和 BUFFER_SIZE) 到你的Python脚本</span></span><br><span class="line">                    <span class="comment">// 例如: send(&#123; ptr: this.ptr_buf.toString(), size: BUFFER_SIZE &#125;);</span></span><br><span class="line">                    <span class="comment">// 然后在Python端接收并保存：</span></span><br><span class="line">                    <span class="comment">// def on_message(message, data):</span></span><br><span class="line">                    <span class="comment">//     if message[&#x27;type&#x27;] == &#x27;send&#x27;:</span></span><br><span class="line">                    <span class="comment">//         payload = message[&#x27;payload&#x27;]</span></span><br><span class="line">                    <span class="comment">//         ptr = int(payload[&#x27;ptr&#x27;], 16)</span></span><br><span class="line">                    <span class="comment">//         size = payload[&#x27;size&#x27;]</span></span><br><span class="line">                    <span class="comment">//         print(f&quot;Receiving buffer from &#123;hex(ptr)&#125; with size &#123;size&#125;&quot;)</span></span><br><span class="line">                    <span class="comment">//         buffer_data = process.read_bytes(ptr, size)</span></span><br><span class="line">                    <span class="comment">//         with open(f&quot;ptr_buf_dump_&#123;hex(ptr)&#125;.bin&quot;, &quot;wb&quot;) as f_out:</span></span><br><span class="line">                    <span class="comment">//             f_out.write(buffer_data)</span></span><br><span class="line">                    <span class="comment">//         print(f&quot;Buffer dumped to ptr_buf_dump_&#123;hex(ptr)&#125;.bin&quot;)</span></span><br><span class="line">                    <span class="comment">// script.on(&#x27;message&#x27;, on_message)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] 读取或hexdump ptr_buf 时发生错误: &quot;</span> + e);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;    错误详情: &quot;</span> + e.<span class="property">stack</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] ptr_buf 在 onLeave 时为 null 或无效。&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;--- 结束 sub_3D6AC 打印 ---&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 确保在Java环境准备好后执行main函数，尤其是在attach模式下早期hook时</span></span><br><span class="line"><span class="comment">// 对于 Android SO 文件中的函数，通常直接调用 main() 即可，</span></span><br><span class="line"><span class="comment">// 或者使用 setImmediate(main) 来确保主循环已准备好</span></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br><span class="line"><span class="comment">// 或者对于某些情况，特别是应用启动非常早期的hook，可能需要等待Java VM加载完毕</span></span><br><span class="line"><span class="comment">// Java.perform(function() &#123;</span></span><br><span class="line"><span class="comment">//     console.log(&quot;[+] Java VM 已加载，开始执行 main()&quot;);</span></span><br><span class="line"><span class="comment">//     main();</span></span><br><span class="line"><span class="comment">// &#125;);</span></span><br></pre></td></tr></table></figure>

<p>打印的结果如下图所示，文件还挺大的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510174628687.png" alt="image-20250510174628687"></p>
<p>回到3DFC4，验证一下我们之前的分析，第0x721个元素存放了目录路径的个数。0x721 x 4 &#x3D; 0x1C84，因此到0x1C84去读取个数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510174732047.png" alt="image-20250510174732047"></p>
<p>读4个字节，02 00 00 00，即为2。因此会创建2个文件夹，再来到第0x744个元素（也就是0x744 x 4 &#x3D; 0x1D10），去读取目录字符串。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510174841862.png" alt="image-20250510174841862"></p>
<p>也就是说，第一个目录字符串的地址存放再0x7969adfcc0处，下一个地址则是0x7969adfd20。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510175058363.png" alt="image-20250510175058363"></p>
<p>要获取这2个字符串，即去读取ptr_buf + 0x1D10和ptr_buf + 0x1D40，修改一下脚本。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">TARGET_MODULE_NAME</span> = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FUNCTION_OFFSET</span> = <span class="number">0x3D6AC</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">BUFFER_SIZE</span> = <span class="number">0x13e80</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MAX_DUMP_SIZE</span> = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable constant_">BUFFER_SIZE</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="variable constant_">TARGET_MODULE_NAME</span>);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(<span class="number">0x88060</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;&#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="title function_">main</span>(baseaddr);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params">base</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> moduleBase = base;</span><br><span class="line">    <span class="keyword">if</span> (!moduleBase) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] 模块 &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot; 未找到。请确保模块名正确且已加载。&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> targetFunctionAddr = moduleBase.<span class="title function_">add</span>(<span class="variable constant_">FUNCTION_OFFSET</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] 目标函数 sub_3D6AC 地址: &quot;</span> + targetFunctionAddr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] ptr_buf 大小: 0x&quot;</span> + <span class="variable constant_">BUFFER_SIZE</span>.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; (&quot;</span> + <span class="variable constant_">BUFFER_SIZE</span> + <span class="string">&quot; bytes)&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] hexdump 将显示最多: 0x&quot;</span> + <span class="variable constant_">MAX_DUMP_SIZE</span>.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; (&quot;</span> + <span class="variable constant_">MAX_DUMP_SIZE</span> + <span class="string">&quot; bytes)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(targetFunctionAddr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ptr_buf</span> = args[<span class="number">0</span>]; <span class="comment">// 保存 ptr_buf 的指针</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">jniEnv</span> = args[<span class="number">1</span>];  <span class="comment">// 保存 JNIEnv 指针</span></span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n[*] 进入 sub_3D6AC:&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    ptr_buf (a1): &quot;</span> + <span class="variable language_">this</span>.<span class="property">ptr_buf</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    JNIEnv* (a2): &quot;</span> + <span class="variable language_">this</span>.<span class="property">jniEnv</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] 离开 sub_3D6AC. 返回值: &quot;</span> + retval);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">ptr_buf</span> &amp;&amp; !<span class="variable language_">this</span>.<span class="property">ptr_buf</span>.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] ptr_buf (&quot;</span> + <span class="variable language_">this</span>.<span class="property">ptr_buf</span> + <span class="string">&quot;) 内容:&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 读取目录个数 (ptr_buf[0x721])</span></span><br><span class="line">                    <span class="keyword">const</span> dirCount = <span class="variable language_">this</span>.<span class="property">ptr_buf</span>.<span class="title function_">add</span>(<span class="number">0x721</span> * <span class="number">4</span>).<span class="title function_">readU32</span>();</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] 目录个数 (ptr_buf[0x721]): &quot;</span> + dirCount);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 从 0x744 开始遍历目录结构</span></span><br><span class="line">                    <span class="keyword">let</span> dirOffset = <span class="number">0x744</span> * <span class="number">4</span>; <span class="comment">// 字节偏移</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dirCount; i++) &#123;</span><br><span class="line">                        <span class="keyword">const</span> dirEntry = <span class="variable language_">this</span>.<span class="property">ptr_buf</span>.<span class="title function_">add</span>(dirOffset);</span><br><span class="line">                        <span class="keyword">const</span> dirPathPtr = dirEntry.<span class="title function_">readPointer</span>(); <span class="comment">// 读取目录路径指针</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">const</span> dirPath = dirPathPtr.<span class="title function_">readCString</span>();</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[Dir <span class="subst">$&#123;i&#125;</span>] <span class="subst">$&#123;dirPathPtr&#125;</span>: <span class="subst">$&#123;dirPath&#125;</span>`</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[Dir <span class="subst">$&#123;i&#125;</span>] <span class="subst">$&#123;dirPathPtr&#125;</span>: (无法读取字符串: <span class="subst">$&#123;e&#125;</span>)`</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        dirOffset += <span class="number">48</span>; <span class="comment">// 每个目录结构 48 字节</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 可选：打印整个缓冲区 (注释掉，避免输出过多)</span></span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    const bufferContent = Memory.readByteArray(this.ptr_buf, Math.min(BUFFER_SIZE, MAX_DUMP_SIZE));</span></span><br><span class="line"><span class="comment">                    console.log(hexdump(bufferContent, Math.min(BUFFER_SIZE, MAX_DUMP_SIZE)));</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] 读取 ptr_buf 时发生错误: &quot;</span> + e);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;    错误详情: &quot;</span> + e.<span class="property">stack</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] ptr_buf 在 onLeave 时为 null 或无效。&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;--- 结束 sub_3D6AC 打印 ---&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>打印的结果如下图所示，创建了2个目录。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511140930719.png" alt="image-20250511140930719"></p>
<p>至于sub_3DFC4d剩下的内容就不分析了，因为sdk版本之前打印好像是32。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511141315957.png" alt="image-20250511141315957"></p>
<h3 id="sub-11F5C-a2-3"><a href="#sub-11F5C-a2-3" class="headerlink" title="sub_11F5C(a2&#x3D;&#x3D;3)"></a>sub_11F5C(a2&#x3D;&#x3D;3)</h3><p>接着看11F5C。——3E29C、40CF8（与java层传入的arg5有关）、3DFC4、11F5C、45964。</p>
<p>直接调用sub_BC60。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511141842306.png" alt="image-20250511141842306" style="zoom:67%;" />

<p>在sub_BC60中，根据sdk版本，执行不同的代码块，我记得之前打印过，sdk_version是32，因此这里只关注需要执行的函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511143526110.png" alt="image-20250511143526110" style="zoom:50%;" />

<p>来看看sub_188AC，用d810去一下混淆。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511143722434.png" alt="image-20250511143722434" style="zoom: 50%;" />

<p>hook这些字符串，打印看看什么含义，似乎没打印出来，说明没执行到。v0是一个指针，存储着BCEB8。我猜测，这里是在根据sdk，选择对应的so。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511145520335.png" alt="image-20250511145520335" style="zoom: 67%;" />

<p>我知道libart.so，但libartbase.so是什么呢？</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511150550133.png" alt="image-20250511150550133" style="zoom: 67%;" />

<p>接着看sub_4029c，进行一定分析，修改变量名，写注释，如下图所示。</p>
<p>看上去，sub_4029C是一个处理内存映射的函数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511152105188.png" alt="image-20250511152105188"></p>
<p>整理一下：</p>
<ol>
<li><strong>读取 &#x2F;proc&#x2F;self&#x2F;maps</strong>：</li>
</ol>
<ul>
<li>打开 &#x2F;proc&#x2F;self&#x2F;maps 文件，获取当前进程的内存映射信息。</li>
</ul>
<ol start="2">
<li><strong>查找目标模块（str）</strong>：</li>
</ol>
<ul>
<li>在内存映射中查找包含 str（例如 “libartbase.so”）的条目。</li>
</ul>
<ol start="3">
<li><strong>修改内存权限</strong>：</li>
</ol>
<ul>
<li>对于目标模块的内存段，修改其权限（mprotect）：<ul>
<li>如果段权限是 r–p（只读），改为 r-x（可读可执行）。</li>
<li>如果段权限是 r-xp（可读可执行），改为 rwx（可读可写可执行）。</li>
</ul>
</li>
</ul>
<ol start="4">
<li><strong>存储基地址</strong>：</li>
</ol>
<ul>
<li>将目标模块的基地址存储到 a1 中。</li>
</ul>
<p>回到sub_188AC，继续分析，将sub_4029C改名成get_so_baseaddr_AND_change_flags。</p>
<p>我之前hook过sub_25E78，但这里似乎并没有对6A6DC5A……进行解密，大概率是没执行，这里分析else分支，继续分析sub_3FF9C。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511153622384.png" alt="image-20250511153622384"></p>
<p>baseaddr是libartbase.so的基址，这里看上去是在解析ELF文件。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511154637350.png" alt="image-20250511154637350" style="zoom:67%;" />

<p>随便打开一个普通的so文件看看，寻找第0x38个字节和0x20个字节的含义。——先取指针，后进行运算，所以这里用0x38*8。</p>
<p>第0x38字节的含义：e_phnum_NUMBER_OF_PROGRAM_HEADER_ENTRIES，代表PHT的个数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511160146292.png" alt="image-20250511160146292"></p>
<p>第0x20字节的含义：e_phoff_PROGRAM_HEADER_OFFSET_IN_FILE，代表PHT在文件中的偏移量。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511160307043.png" alt="image-20250511160307043"></p>
<p>除此之外，还有访问pht + 16位置的代码段…这里就不贴图了，直接修改变量名。</p>
<p>这个函数手动解析了ELF动态信息，这种方式可以绕过一些针对标准<code>dlsym</code>的Hook，或者在某些特殊环境中加载和解析符号。</p>
<p>那么，sub_3FF9C看似是在解析动态链接库，并找到对应的符号。——当然不是这样，继续往下看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511164204307.png" alt="image-20250511164204307"></p>
<p>可以注意到，函数3FAE0和3F924出现在了switch-case结构中，这里简单介绍这俩函数的作用。</p>
<p>函数sub_3FAE0负责处理<strong>标准的ELF重定位表</strong>（如 <code>.rela.dyn</code> 用于数据重定位，<code>.rela.plt</code> 用于过程链接表PLT的函数调用重定位）。它查找对目标符号的引用，并将这些引用重定向到a3（调用时提供的“空函数”地址，伏笔）。</p>
<p>函数sub_3FAE0负责处理一个<strong>自定义的、以”APS2”开头的特殊数据结构</strong>。这个结构中也包含了对某些符号的引用信息（可能是为了处理更复杂的场景，如与符号版本控制相关的重定位，或者是一些内部模块间的链接）。它同样查找对目标符号的引用，并将这些引用重定向到提供的“空函数”地址。</p>
<p>这里的空函数，指的是sub_1B044，这是一个空函数，点进去只有一个return。（这里的redirect_func_to_a3是sub_3FF9C，被我改名了）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511191508810.png" alt="image-20250511191508810"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511191528201.png" alt="image-20250511191528201" style="zoom:67%;" />

<p>在sub_188AC中，除了将__android_log_print进行hook，重定位到一个空函数，还将mmap进行了hook，重定位到了sub_1B070，博主说，这里在加载Dex的时候有用。那就待会再来看sub_1B070吧。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511191747476.png" alt="image-20250511191747476"></p>
<p>回到sub_BC60，总结一下sub_188AC，它将__android_log_print和mmap进行了hook。</p>
<p>因为我们的sdk是32，再继续分析sub_11AB0。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511193723418.png" alt="image-20250511193723418" style="zoom: 67%;" />

<p>还有好多未解密的字符串，写个脚本打印一下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511193921095.png" alt="image-20250511193921095" style="zoom: 67%;" />

<p>打印的结果如下，涉及动态加载。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511201719617.png" alt="image-20250511201719617"></p>
<p>有个很奇怪的现象，可能是我没分析到？当把未解密的so文件放入ida中，跳转到11ab0，是可以看到循环的（和博客一致）。而解密后的so文件在查看时，没有for循环，不知道是什么导致的。麻了，因为这个so文件我没添加注释，没改变量名，有些东西乍一看看不出来。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511203419140.png" alt="image-20250511203419140" style="zoom:80%;" />

<p>直接拿博客的图来用一下吧，好糊。</p>
<p>简单说一下思路，将jar文件转换成dex文件，然后通过InMemoryDexClassLoader进行加载，然后将两个加载器的Element数组合并，重新设置成原加载器的Element数组（为了之后加载的类，可以被原始类加载器加载，热更新），随后将Dex文件的信息，在baidu设置的0x13E80个字节的缓冲区里进行更新——也不知道更新什么东西？费这么大信息，hook上mmap函数，最后只是为了拿到mmap分配的地址，给到函数update_dex_info_to_baidu_struct。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511211536106.png" alt="image-20250511211536106" style="zoom:80%;" />

<p>回到sub_bc60，再次总结一下，在hook mmap之后，会加载jar文件（目标dex文件），然后去除mmap的hook。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511213147216.png" alt="image-20250511213147216" style="zoom:80%;" />

<p>至此，sub_bc60分析完了——我没特意分析具体是如何解密出dex文件的，感觉很复杂——之前的签名扩展的176字节，会被用来当密钥，也就是说，如果这个apk被修改后重新签名，是无法打开的，因为Dex文件解不开。</p>
<p>要想得到这个Dex文件，可以通过hook sub_3BA90，在onLeave时dump第3个参数，而dump的大小是第4个参数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511213343307.png" alt="image-20250511213343307" style="zoom:80%;" />

<h3 id="sub-45964-a2-3"><a href="#sub-45964-a2-3" class="headerlink" title="sub_45964(a2&#x3D;&#x3D;3)"></a>sub_45964(a2&#x3D;&#x3D;3)</h3><p>最后，分析sub_45964。——3E29C、40CF8（与java层传入的arg5有关）、3DFC4、11F5C、45964。</p>
<p>做了一下简单的分析。</p>
<p>在RegisterNative_10item的函数中，注册了10个JNI函数，10个JNI函数全部注册到了1个Native地址上。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511215230452.png" alt="image-20250511215230452"></p>
<p>10个函数全部注册到1个地址，说明是vmp。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511215317797.png" alt="image-20250511215317797"></p>
<p>下图来自未解密的so文件，又有do-while没被检测出来。在函数sub_42D8C中，会对每个Dex文件去解析附加数据3。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511222646400.png" alt="image-20250511222646400"></p>
<p>下图是每个Jar文件的内容。sub_42D8C负责处理其中的附加数据3。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511222818162.png" alt="image-20250511222818162"></p>
<p>这里直接引用博主的分析，如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511223003506.png" alt="image-20250511223003506"></p>
<p>如何分析出来的呢？过几天来看看。</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>至此，n001分析完了，总结一下。</p>
<p>sub_3E29C取出了签名数组，取了数组的第0个元素，通过md5得到了16个字节，再把这16字节扩展成了176字节。</p>
<p>sub_40cf8注册的函数异常处理有关，大致是负责异常处理。</p>
<p>sub_3DFC4创建了两个目录，分别是&#x2F;data&#x2F;user&#x2F;0&#x2F;com.example.test&#x2F;.1和&#x2F;data&#x2F;user&#x2F;0&#x2F;com.example.test&#x2F;.2，这两个目录应该是与dex、jar相关，为sub_11f5c服务的。——我发现了一些字符串，&#x2F;data&#x2F;data&#x2F;包名&#x2F; &#x3D;&#x3D; &#x2F;data&#x2F;user&#x2F;0&#x2F;包名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511221807574.png" alt="image-20250511221807574"></p>
<p>sub_11f5C hook了两个函数，一个是__android_log_print，一个是mmap，然后解密加载了业务dex文件（需要用到sub_3E29C签名扩展的176字节进行解密），加载完后，删除了mmap的hook。</p>
<p>sub_4596c注册了10个JNI函数，解析了vmp的方法数组和指令替换表。</p>
<h2 id="n002"><a href="#n002" class="headerlink" title="n002"></a>n002</h2><p>n002函数是在onCreate函数中调用的，也是启动app的流程必经的函数之一。</p>
<p>在n002中，又是调用函数列表上的函数，这回的a2&#x3D;&#x3D;4。</p>
<p>通过分析，会有sub_ 40CF8、sub_ 3E96C、sub_ 42388这3个函数执行。</p>
<p>sub_ 40CF8调用CrashHandler.asynRun方法，向<a target="_blank" rel="noopener" href="https://apkprotect.baidu.com/apklog%E5%8F%91%E9%80%81%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF%E3%80%82">https://apkprotect.baidu.com/apklog发送统计信息。</a></p>
<p>sub_ 3E96C assets&#x2F;baiduprotect.m检查dex的完整性，该文件中存有加密的dex MD5，如果修改dex进行重新签名，会导致app打不开。——应该还有对调试器的检测，因为使用frida和IDA的时候会异常退出。</p>
<p>sub_ 42388注册com.baidu.xshield.jni.Asc和com.baidu.xshield.utility.KeyUtil的本地函数，调用com.baidu.xshield.ac.XH.init方法。</p>
<p>至此，app启动流程涉及到的n001和n002分析完了。</p>
<h1 id="vmp分析"><a href="#vmp分析" class="headerlink" title="vmp分析"></a>vmp分析</h1><p>先把dex dump下来，下面是脚本，hook sub_3BA90，在onLeave时进行dump。</p>
<p>脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">TARGET_MODULE_NAME</span> = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="variable constant_">TARGET_MODULE_NAME</span>);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(<span class="number">0x88060</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;&#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="comment">// hook sub_3BA90</span></span><br><span class="line">            <span class="title function_">hook_3BA90</span>(baseaddr);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_3BA90</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(<span class="number">0x3BA90</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="comment">// 保存指针地址</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">dexPtr</span> = args[<span class="number">2</span>]; <span class="comment">// &amp;dex_ 的地址</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">sizePtr</span> = args[<span class="number">3</span>]; <span class="comment">// &amp;v6 的地址</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] sub_3BA90 - dexPtr:&quot;</span>, <span class="variable language_">this</span>.<span class="property">dexPtr</span>, <span class="string">&quot;sizePtr:&quot;</span>, <span class="variable language_">this</span>.<span class="property">sizePtr</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Call stack:\n&quot;</span>, <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">ACCURATE</span>).<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&quot;\n&quot;</span>));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 读取 dex_ 和 v6 的值</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">ptr</span> = <span class="variable language_">this</span>.<span class="property">dexPtr</span>.<span class="title function_">readPointer</span>(); <span class="comment">// *dexPtr, 即 dex_ 的值</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">size</span> = <span class="variable language_">this</span>.<span class="property">sizePtr</span>.<span class="title function_">readU64</span>().<span class="title function_">toNumber</span>(); <span class="comment">// *sizePtr, 即 v6 的值</span></span><br><span class="line"></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] DEX dump - ptr:&quot;</span>, <span class="variable language_">this</span>.<span class="property">ptr</span>, <span class="string">&quot;size:&quot;</span>, <span class="variable language_">this</span>.<span class="property">size</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">ptr</span> &amp;&amp; !<span class="variable language_">this</span>.<span class="property">ptr</span>.<span class="title function_">isNull</span>() &amp;&amp; <span class="variable language_">this</span>.<span class="property">size</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">size</span> &lt; <span class="number">0x10000000</span>) &#123; <span class="comment">// 限制最大 256MB</span></span><br><span class="line">                    <span class="comment">// 修改内存权限</span></span><br><span class="line">                    <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="variable language_">this</span>.<span class="property">ptr</span>, <span class="variable language_">this</span>.<span class="property">size</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] 内存权限已修改为 rwx&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 读取 DEX 文件内容</span></span><br><span class="line">                    <span class="keyword">const</span> dexData = <span class="title class_">Memory</span>.<span class="title function_">readByteArray</span>(<span class="variable language_">this</span>.<span class="property">ptr</span>, <span class="variable language_">this</span>.<span class="property">size</span>);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] 成功读取 DEX 数据&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 生成唯一的文件名</span></span><br><span class="line">                    <span class="keyword">const</span> filename = <span class="string">`/data/data/com.example.test/dex_dump_<span class="subst">$&#123;<span class="variable language_">this</span>.ptr.toString(<span class="number">16</span>)&#125;</span>_<span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span>.dex`</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 写入文件</span></span><br><span class="line">                    <span class="keyword">const</span> file = <span class="keyword">new</span> <span class="title class_">File</span>(filename, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (file) &#123;</span><br><span class="line">                        file.<span class="title function_">write</span>(dexData);</span><br><span class="line">                        file.<span class="title function_">flush</span>();</span><br><span class="line">                        file.<span class="title function_">close</span>();</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] DEX 文件成功保存到:&quot;</span>, filename);</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] 无法打开文件:&quot;</span>, filename);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] 无效的 ptr 或 size:&quot;</span>, <span class="variable language_">this</span>.<span class="property">ptr</span>, <span class="variable language_">this</span>.<span class="property">size</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>打印的结果如下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512102740207.png" alt="image-20250512102740207" style="zoom:80%;" />

<p>这里图方便，分析onCreate函数（vmp化），需要判断它在哪个dex文件里。</p>
<p>通过这个指令：<strong>grep -r “MainActivity” .&#x2F;dex_dump</strong> 可以找到。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512103001280.png" alt="image-20250512103001280"></p>
<p>算了，直接将2个dex都pull出来，丢进行jadx里看看。</p>
<p>成功找到了类MainActivity，onCreate明显被vmp动过。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512103150789.png" alt="image-20250512103150789" style="zoom:80%;" />

<p>-1426063360即为0xAB00 0000。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512103506171.png" alt="image-20250512103506171" style="zoom:67%;" />

<p>来到之前注册V的函数的地方，函数列表很怪，按理来说，应该有5个参数，前2个是JNIEnv和jclass，然后是A.V传的3个参数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512105550561.png" alt="image-20250512105550561"></p>
<p>把签名改成我期待的样子。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512105617334.png" alt="image-20250512105617334"></p>
<p>再看这个sub_4A458，很不正常，连传了3个BYTE(a3)，还是看汇编吧。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512124624278.png" alt="image-20250512124624278"></p>
<p>通过汇编的还原，调用的参数列表应该是这样子的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512124116293.png" alt="image-20250512124116293" style="zoom:80%;" />

<p>接下来，进入sub_4a458。看一眼就累了，很多函数的参数都是瞎传递的，ida没正确识别。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512131633429.png" alt="image-20250512131633429"></p>
<p>试试用ida的trace，由于vmp这一块代码是加密的，要等到解密后才方便下断点。因此，还是使用frida进行trace吧。</p>
<p>但是frida trace受挫了，似乎有反调？我之前尝试使用jnitrace也是执行到特定时候就会退出。</p>
<p>之后尝试绕过。——hook pthread_create的线程函数，置为空，然后重新使用hook_libart.js来查看调用的JNI函数，看看会不会退出。</p>
<p>好消息，成功了，脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> offset = <span class="number">0x88060</span>;</span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> base_addr = <span class="literal">null</span>; <span class="comment">// To store the base address of libbaiduprotect.so</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an empty function</span></span><br><span class="line"><span class="keyword">var</span> empty_func = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                base_addr = secmodule.<span class="property">base</span>; <span class="comment">// Save the base address</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libbaiduprotect.so base: &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> target_addr = baseaddr.<span class="title function_">add</span>(offset);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Target function at &quot;</span> + target_addr + <span class="string">&quot; entered&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libbaiduprotect.so base address: &quot;</span> + baseaddr);</span><br><span class="line">            <span class="title function_">hook_pthread_create</span>();</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthread_create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> pthread_create_addr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> func_addr = args[<span class="number">2</span>];</span><br><span class="line">            <span class="keyword">let</span> target_func_addr = base_addr.<span class="title function_">add</span>(<span class="number">0x3E9F0</span>); <span class="comment">// Calculate the target function address</span></span><br><span class="line">            <span class="keyword">if</span> (func_addr.<span class="title function_">equals</span>(target_func_addr)) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Replacing func_addr &quot;</span> + func_addr + <span class="string">&quot; with empty function&quot;</span>);</span><br><span class="line">                args[<span class="number">2</span>] = empty_func; <span class="comment">// Replace with the empty function</span></span><br><span class="line">                <span class="title function_">hook_libart</span>(); <span class="comment">// Execute hook_libart</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(func_addr);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">module</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span> === module_name) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create called in libbaiduprotect.so, function address: &quot;</span> + func_addr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="comment">// Optionally log return value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">STD_STRING_SIZE</span> = <span class="number">3</span> * <span class="title class_">Process</span>.<span class="property">pointerSize</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StdString</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">handle</span> = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="variable constant_">STD_STRING_SIZE</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> [data, isTiny] = <span class="variable language_">this</span>.<span class="title function_">_getData</span>();</span><br><span class="line">        <span class="keyword">if</span> (!isTiny) &#123;</span><br><span class="line">            <span class="title class_">Java</span>.<span class="property">api</span>.$delete(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">disposeToString</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="variable language_">this</span>.<span class="title function_">toString</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">dispose</span>();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">toString</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> [data] = <span class="variable language_">this</span>.<span class="title function_">_getData</span>();</span><br><span class="line">        <span class="keyword">return</span> data.<span class="title function_">readUtf8String</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">_getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> str = <span class="variable language_">this</span>.<span class="property">handle</span>;</span><br><span class="line">        <span class="keyword">const</span> isTiny = (str.<span class="title function_">readU8</span>() &amp; <span class="number">1</span>) === <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">const</span> data = isTiny ? str.<span class="title function_">add</span>(<span class="number">1</span>) : str.<span class="title function_">add</span>(<span class="number">2</span> * <span class="title class_">Process</span>.<span class="property">pointerSize</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">        <span class="keyword">return</span> [data, isTiny];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">prettyMethod</span>(<span class="params">method_id, withSignature</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">new</span> <span class="title class_">StdString</span>();</span><br><span class="line">    <span class="title class_">Java</span>.<span class="property">api</span>[<span class="string">&#x27;art::ArtMethod::PrettyMethod&#x27;</span>](result, method_id, withSignature ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> result.<span class="title function_">disposeToString</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_libart</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> symbols = <span class="title class_">Module</span>.<span class="title function_">enumerateSymbolsSync</span>(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> addrGetStringUTFChars = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrNewStringUTF = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrFindClass = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetMethodID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetStaticMethodID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetFieldID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetStaticFieldID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrRegisterNatives = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> so_name = <span class="string">&quot;lib&quot;</span>;      <span class="comment">// <span class="doctag">TODO:</span> Specify the SO to filter</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;art&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;JNI&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) &lt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;_ZN3art3JNIILb0&quot;</span>) &gt;= <span class="number">0</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;GetStringUTFChars&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrGetStringUTFChars = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;GetStringUTFChars is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;NewStringUTF&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrNewStringUTF = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;NewStringUTF is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;FindClass&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrFindClass = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;FindClass is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;GetMethodID&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrGetMethodID = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;GetMethodID is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;GetStaticMethodID&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrGetStaticMethodID = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;GetStaticMethodID is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;GetFieldID&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrGetFieldID = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;GetFieldID is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;GetStaticFieldID&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrGetStaticFieldID = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;GetStaticFieldID is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;RegisterNatives&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrRegisterNatives = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;RegisterNatives is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CallStatic&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;CallStatic is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">                <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(symbol.<span class="property">address</span>, &#123;</span><br><span class="line">                    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> java_class = args[<span class="number">1</span>];</span><br><span class="line">                            <span class="keyword">var</span> mid = args[<span class="number">2</span>];</span><br><span class="line">                            <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(java_class);</span><br><span class="line">                            <span class="keyword">if</span> (class_name.<span class="title function_">indexOf</span>(<span class="string">&quot;java.&quot;</span>) == -<span class="number">1</span> &amp;&amp; class_name.<span class="title function_">indexOf</span>(<span class="string">&quot;android.&quot;</span>) == -<span class="number">1</span>) &#123;</span><br><span class="line">                                <span class="keyword">var</span> method_name = <span class="title function_">prettyMethod</span>(mid, <span class="number">1</span>);</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&lt;&gt;CallStatic:&quot;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>), class_name, method_name);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CallNonvirtual&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;CallNonvirtual is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">                <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(symbol.<span class="property">address</span>, &#123;</span><br><span class="line">                    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> jobject = args[<span class="number">1</span>];</span><br><span class="line">                            <span class="keyword">var</span> jclass = args[<span class="number">2</span>];</span><br><span class="line">                            <span class="keyword">var</span> jmethodID = args[<span class="number">3</span>];</span><br><span class="line">                            <span class="keyword">var</span> obj_class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getObjectClassName</span>(jobject);</span><br><span class="line">                            <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(jclass);</span><br><span class="line">                            <span class="keyword">if</span> (class_name.<span class="title function_">indexOf</span>(<span class="string">&quot;java.&quot;</span>) == -<span class="number">1</span> &amp;&amp; class_name.<span class="title function_">indexOf</span>(<span class="string">&quot;android.&quot;</span>) == -<span class="number">1</span>) &#123;</span><br><span class="line">                                <span class="keyword">var</span> method_name = <span class="title function_">prettyMethod</span>(jmethodID, <span class="number">1</span>);</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&lt;&gt;CallNonvirtual:&quot;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>), class_name, obj_class_name, method_name);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;Call&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;Method&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Call&lt;&gt;Method is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">                <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(symbol.<span class="property">address</span>, &#123;</span><br><span class="line">                    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> java_class = args[<span class="number">1</span>];</span><br><span class="line">                            <span class="keyword">var</span> mid = args[<span class="number">2</span>];</span><br><span class="line">                            <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getObjectClassName</span>(java_class);</span><br><span class="line">                            <span class="keyword">if</span> (class_name.<span class="title function_">indexOf</span>(<span class="string">&quot;java.&quot;</span>) == -<span class="number">1</span> &amp;&amp; class_name.<span class="title function_">indexOf</span>(<span class="string">&quot;android.&quot;</span>) == -<span class="number">1</span>) &#123;</span><br><span class="line">                                <span class="keyword">var</span> method_name = <span class="title function_">prettyMethod</span>(mid, <span class="number">1</span>);</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&lt;&gt;Call&lt;&gt;Method:&quot;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>), class_name, method_name);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addrGetStringUTFChars != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrGetStringUTFChars, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (retval != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> bytes = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(retval);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetStringUTFChars] result:&quot;</span> + bytes, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (addrNewStringUTF != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrNewStringUTF, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args[<span class="number">1</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> string = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">1</span>]);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[NewStringUTF] bytes:&quot;</span> + string, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addrFindClass != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrFindClass, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args[<span class="number">1</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">1</span>]);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[FindClass] name:&quot;</span> + name, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (addrGetMethodID != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrGetMethodID, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args[<span class="number">2</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> clazz = args[<span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(clazz);</span><br><span class="line">                    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">2</span>]);</span><br><span class="line">                        <span class="keyword">if</span> (args[<span class="number">3</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">3</span>]);</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetMethodID] class_name:&quot;</span> + class_name + <span class="string">&quot; name:&quot;</span> + name + <span class="string">&quot;, sig:&quot;</span> + sig, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetMethodID] class_name:&quot;</span> + class_name + <span class="string">&quot; name:&quot;</span> + name, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (addrGetStaticMethodID != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrGetStaticMethodID, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args[<span class="number">2</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> clazz = args[<span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(clazz);</span><br><span class="line">                    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">2</span>]);</span><br><span class="line">                        <span class="keyword">if</span> (args[<span class="number">3</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">3</span>]);</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetStaticMethodID] class_name:&quot;</span> + class_name + <span class="string">&quot; name:&quot;</span> + name + <span class="string">&quot;, sig:&quot;</span> + sig, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetStaticMethodID] class_name:&quot;</span> + class_name + <span class="string">&quot; name:&quot;</span> + name, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (addrGetFieldID != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrGetFieldID, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args[<span class="number">2</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">2</span>]);</span><br><span class="line">                        <span class="keyword">if</span> (args[<span class="number">3</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">3</span>]);</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetFieldID] name:&quot;</span> + name + <span class="string">&quot;, sig:&quot;</span> + sig, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetFieldID] name:&quot;</span> + name, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (addrGetStaticFieldID != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrGetStaticFieldID, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args[<span class="number">2</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">2</span>]);</span><br><span class="line">                        <span class="keyword">if</span> (args[<span class="number">3</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">3</span>]);</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetStaticFieldID] name:&quot;</span> + name + <span class="string">&quot;, sig:&quot;</span> + sig, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetStaticFieldID] name:&quot;</span> + name, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addrRegisterNatives != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrRegisterNatives, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[RegisterNatives] method_count:&quot;</span>, args[<span class="number">3</span>], <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                <span class="keyword">var</span> env = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">var</span> java_class = args[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(java_class);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> methods_ptr = <span class="title function_">ptr</span>(args[<span class="number">2</span>]);</span><br><span class="line">                <span class="keyword">var</span> method_count = <span class="built_in">parseInt</span>(args[<span class="number">3</span>]);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; method_count; i++) &#123;</span><br><span class="line">                    <span class="keyword">var</span> name_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span>));</span><br><span class="line">                    <span class="keyword">var</span> sig_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span>));</span><br><span class="line">                    <span class="keyword">var</span> fnPtr_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(name_ptr);</span><br><span class="line">                    <span class="keyword">var</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(sig_ptr);</span><br><span class="line">                    <span class="keyword">var</span> find_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(fnPtr_ptr);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[RegisterNatives] java_class:&quot;</span>, class_name, <span class="string">&quot;name:&quot;</span>, name, <span class="string">&quot;sig:&quot;</span>, sig, <span class="string">&quot;fnPtr:&quot;</span>, fnPtr_ptr, <span class="string">&quot;module_name:&quot;</span>, find_module.<span class="property">name</span>, <span class="string">&quot;module_base:&quot;</span>, find_module.<span class="property">base</span>, <span class="string">&quot;offset:&quot;</span>, <span class="title function_">ptr</span>(fnPtr_ptr).<span class="title function_">sub</span>(find_module.<span class="property">base</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">hook_linker_call_constructors</span>();</span><br></pre></td></tr></table></figure>

<p>成功打印出jni调用的函数，也就是说，离frida trace所有vmp的指令又进一步。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512194612007.png" alt="image-20250512194612007"></p>
<p>暂时先到这吧，明天面携程，先复习一下加解密算法，之后继续复现vmp。</p>
<p> ok，继续分析，也不知道携程能不能有个善终——20250514 09:28。</p>
<p>我将jni调用的日志输出到文件中，慢慢看。</p>
<p>我们要分析的被vmp的函数是onCreate，不妨猜测它会调用super.onCreate，而要实现super.onCreate，不能只靠vmp的解释器进行解释执行，还需要用到jni调用，因此可以在日志中搜索onCreate，于是得到下面的日志。</p>
<p>于是，我们能确定了解释器是在哪里获取的onCreate的jmethod_id（0x5df18）和在哪里真正调用onCreate函数的（0x54370）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[GetMethodID] class_name:androidx.appcompat.app.AppCompatActivity name:onCreate, sig:(Landroid/os/Bundle;)V 0x743fd08f18 libbaiduprotect.so!0x5df18</span><br><span class="line">[GetMethodID] class_name:android.system.StructStatVfs name:&lt;init&gt;, sig:(JJJJJJJJJJJ)V 0x744a5310b4 libjavacore.so!0x310b4</span><br><span class="line">&lt;&gt;CallNonvirtual: 0x743fcff370 libbaiduprotect.so!0x54370 androidx.appcompat.app.AppCompatActivity com.example.test.MainActivity void androidx.appcompat.app.AppCompatActivity.onCreate(android.os.Bundle)</span><br></pre></td></tr></table></figure>

<p>不妨想想如何倒推——如果没有被vmp化，原onCreate中，大概率要执行super.onCreate，对应的smali指令，大概率是invoke-super，通过invoke-super调用父类的onCreate。</p>
<p>先尝试将指令trace下来吧，试了一下，即便先绕过反调，仍然无法trace下来，那是什么原因呢？</p>
<p>追踪指令流，发现执行到sub_45EBC后，程序便不会返回到BL sub_45EBC的下一条指令了，而sub_45EBC的最后一条指令是，将栈指针寄存器变成了0x1，难怪会退出——为什么使用frida-stalker之后，会出现这种问题呢？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov wsp, #1</span><br></pre></td></tr></table></figure>

<p>整理一下现有的信息，我知道：</p>
<ol>
<li><p>哪里调用了onCreate。</p>
</li>
<li><p>执行sub_45EBC就会崩溃。</p>
</li>
</ol>
<p>那我是否可以根据onCreate的交叉引用，一步一步回推是哪个跳转出现了问题，最后进入了sub_45EBC退出的。</p>
<p>已知0x5df18处会获取onCreate的method_id，而0x54370会调用onCreate，交叉引用一下这两个地址，发现两个函数都追踪到了.data节，除此之外，没有其它函数引用了它们。</p>
<p>把函数地址存放在.data节中，而且不只一个函数地址，大概率是通过BLR或BR指令跳转的。</p>
<p>BL和BLR的区别在，前者是通过PC相对偏移量跳转到目标函数在内存中的地址，而后者是跳转到寄存器中存储的地址，也就是说，BL的跳转地址基本是硬编码在指令里的，是编译时就确定的，而BLR可以根据寄存器的内容进行跳转，在运行时决定。这里这么多个地址放在一块，大概率在执行时要跳转很多个函数，所以使用有R的跳转指令。</p>
<p>这里继续交叉引用off_BD040。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514154101276.png" alt="image-20250514154101276" style="zoom:80%;" />

<p>BR X8，符合上面的分析。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514155831323.png" alt="image-20250514155831323" style="zoom: 67%;" />

<p>回到函数列表中，突然发现它有256个函数地址，smali的操作码是1个字节，对应256种操作，这里会不会就是vmp解释器模拟smali指令的地方？读取解密后的vmp_code_item，然后根据vmp_code_item里的每一条指令，模拟执行对应的函数。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></td><td class="code"><pre><span class="line">.data:00000000000BD040 58 CD 04 00 00 00 00 00 off<span class="emphasis">_BD040       DCQ sub_</span>4CD58           ; DATA XREF: sub<span class="emphasis">_4CC20+C4↑o</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD048 8C CD 04 00 00 00 00 00                 DCQ sub_</span>4CD8C</span><br><span class="line">.data:00000000000BD050 E0 CD 04 00 00 00 00 00                 DCQ sub<span class="emphasis">_4CDE0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD058 34 CE 04 00 00 00 00 00                 DCQ sub_</span>4CE34</span><br><span class="line">.data:00000000000BD060 84 CE 04 00 00 00 00 00                 DCQ sub<span class="emphasis">_4CE84</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD068 D4 CE 04 00 00 00 00 00                 DCQ sub_</span>4CED4</span><br><span class="line">.data:00000000000BD070 24 CF 04 00 00 00 00 00                 DCQ sub<span class="emphasis">_4CF24</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD078 70 CF 04 00 00 00 00 00                 DCQ sub_</span>4CF70</span><br><span class="line">.data:00000000000BD080 C0 CF 04 00 00 00 00 00                 DCQ sub<span class="emphasis">_4CFC0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD088 10 D0 04 00 00 00 00 00                 DCQ sub_</span>4D010</span><br><span class="line">.data:00000000000BD090 5C D0 04 00 00 00 00 00                 DCQ sub<span class="emphasis">_4D05C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD098 C0 D0 04 00 00 00 00 00                 DCQ sub_</span>4D0C0</span><br><span class="line">.data:00000000000BD0A0 2C D1 04 00 00 00 00 00                 DCQ sub<span class="emphasis">_4D12C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0A8 98 D1 04 00 00 00 00 00                 DCQ sub_</span>4D198</span><br><span class="line">.data:00000000000BD0B0 DC 46 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_546DC           ; jumptable 0000000000053D00 cases 69,71,72,75,77-82,84,85,87-89</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0B0                                                                 ; jumptable 0000000000053D50 cases 69,71,72,75,77-82,84,85,87-89</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0B0                                                                 ; jumptable 0000000000053DAC cases 69,71,72,75,77-82,84,85,87-89</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0B8 BC 46 05 00 00 00 00 00                 DCQ loc_</span>546BC</span><br><span class="line">.data:00000000000BD0C0 14 D2 04 00 00 00 00 00                 DCQ sub<span class="emphasis">_4D214</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0C8 14 D2 04 00 00 00 00 00                 DCQ sub_</span>4D214</span><br><span class="line">.data:00000000000BD0D0 34 D2 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D234</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0D8 80 D2 04 00 00 00 00 00                 DCQ loc_</span>4D280</span><br><span class="line">.data:00000000000BD0E0 D0 D2 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D2D0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0E8 24 D3 04 00 00 00 00 00                 DCQ loc_</span>4D324</span><br><span class="line">.data:00000000000BD0F0 74 D3 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D374</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0F8 C0 D3 04 00 00 00 00 00                 DCQ loc_</span>4D3C0</span><br><span class="line">.data:00000000000BD100 18 D4 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D418</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD108 7C D4 04 00 00 00 00 00                 DCQ loc_</span>4D47C</span><br><span class="line">.data:00000000000BD110 CC D4 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D4CC</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD118 44 D5 04 00 00 00 00 00                 DCQ loc_</span>4D544</span><br><span class="line">.data:00000000000BD120 C4 D5 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D5C4</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD128 40 D6 04 00 00 00 00 00                 DCQ loc_</span>4D640</span><br><span class="line">.data:00000000000BD130 A8 D6 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D6A8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD138 24 D7 04 00 00 00 00 00                 DCQ loc_</span>4D724</span><br><span class="line">.data:00000000000BD140 C4 D7 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D7C4</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD148 68 D8 04 00 00 00 00 00                 DCQ loc_</span>4D868</span><br><span class="line">.data:00000000000BD150 E0 D8 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D8E0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD158 C0 DA 04 00 00 00 00 00                 DCQ loc_</span>4DAC0</span><br><span class="line">.data:00000000000BD160 90 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53390</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD168 28 DC 04 00 00 00 00 00                 DCQ loc_</span>4DC28</span><br><span class="line">.data:00000000000BD170 30 DC 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4DC30</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD178 AC DC 04 00 00 00 00 00                 DCQ loc_</span>4DCAC</span><br><span class="line">.data:00000000000BD180 E8 DC 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4DCE8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD188 24 DD 04 00 00 00 00 00                 DCQ loc_</span>4DD24</span><br><span class="line">.data:00000000000BD190 60 DD 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4DD60</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD198 A4 DD 04 00 00 00 00 00                 DCQ loc_</span>4DDA4</span><br><span class="line">.data:00000000000BD1A0 24 DE 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4DE24</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD1A8 A4 DE 04 00 00 00 00 00                 DCQ loc_</span>4DEA4</span><br><span class="line">.data:00000000000BD1B0 30 DF 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4DF30</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD1B8 B0 DF 04 00 00 00 00 00                 DCQ loc_</span>4DFB0</span><br><span class="line">.data:00000000000BD1C0 34 E0 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E034</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD1C8 AC E0 04 00 00 00 00 00                 DCQ loc_</span>4E0AC</span><br><span class="line">.data:00000000000BD1D0 28 E1 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E128</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD1D8 14 E2 04 00 00 00 00 00                 DCQ loc_</span>4E214</span><br><span class="line">.data:00000000000BD1E0 00 E3 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E300</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD1E8 94 E3 04 00 00 00 00 00                 DCQ loc_</span>4E394</span><br><span class="line">.data:00000000000BD1F0 28 E4 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E428</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD1F8 BC E4 04 00 00 00 00 00                 DCQ loc_</span>4E4BC</span><br><span class="line">.data:00000000000BD200 50 E5 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E550</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD208 D4 E5 04 00 00 00 00 00                 DCQ loc_</span>4E5D4</span><br><span class="line">.data:00000000000BD210 58 E6 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E658</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD218 E0 E6 04 00 00 00 00 00                 DCQ loc_</span>4E6E0</span><br><span class="line">.data:00000000000BD220 68 E7 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E768</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD228 F0 E7 04 00 00 00 00 00                 DCQ loc_</span>4E7F0</span><br><span class="line">.data:00000000000BD230 78 E8 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E878</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD238 78 E8 04 00 00 00 00 00                 DCQ loc_</span>4E878</span><br><span class="line">.data:00000000000BD240 78 E8 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E878</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD248 78 E8 04 00 00 00 00 00                 DCQ loc_</span>4E878</span><br><span class="line">.data:00000000000BD250 78 E8 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E878</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD258 78 E8 04 00 00 00 00 00                 DCQ loc_</span>4E878</span><br><span class="line">.data:00000000000BD260 78 E8 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E878</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD268 A4 E9 04 00 00 00 00 00                 DCQ loc_</span>4E9A4</span><br><span class="line">.data:00000000000BD270 A4 EA 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4EAA4</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD278 30 EC 04 00 00 00 00 00                 DCQ loc_</span>4EC30</span><br><span class="line">.data:00000000000BD280 1C ED 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4ED1C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD288 E0 ED 04 00 00 00 00 00                 DCQ loc_</span>4EDE0</span><br><span class="line">.data:00000000000BD290 A0 EE 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4EEA0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD298 64 EF 04 00 00 00 00 00                 DCQ loc_</span>4EF64</span><br><span class="line">.data:00000000000BD2A0 60 F0 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4F060</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD2A8 50 F1 04 00 00 00 00 00                 DCQ loc_</span>4F150</span><br><span class="line">.data:00000000000BD2B0 F4 F1 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4F1F4</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD2B8 9C F2 04 00 00 00 00 00                 DCQ loc_</span>4F29C</span><br><span class="line">.data:00000000000BD2C0 44 F3 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4F344</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD2C8 EC F3 04 00 00 00 00 00                 DCQ loc_</span>4F3EC</span><br><span class="line">.data:00000000000BD2D0 94 F4 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4F494</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD2D8 6C F5 04 00 00 00 00 00                 DCQ loc_</span>4F56C</span><br><span class="line">.data:00000000000BD2E0 30 F6 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4F630</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD2E8 A4 F7 04 00 00 00 00 00                 DCQ loc_</span>4F7A4</span><br><span class="line">.data:00000000000BD2F0 4C F8 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4F84C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD2F8 F8 F8 04 00 00 00 00 00                 DCQ loc_</span>4F8F8</span><br><span class="line">.data:00000000000BD300 A0 F9 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4F9A0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD308 4C FA 04 00 00 00 00 00                 DCQ loc_</span>4FA4C</span><br><span class="line">.data:00000000000BD310 0C FB 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4FB0C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD318 C8 FB 04 00 00 00 00 00                 DCQ loc_</span>4FBC8</span><br><span class="line">.data:00000000000BD320 68 FC 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4FC68</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD328 0C FD 04 00 00 00 00 00                 DCQ loc_</span>4FD0C</span><br><span class="line">.data:00000000000BD330 B0 FD 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4FDB0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD338 54 FE 04 00 00 00 00 00                 DCQ loc_</span>4FE54</span><br><span class="line">.data:00000000000BD340 F8 FE 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4FEF8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD348 C0 FF 04 00 00 00 00 00                 DCQ loc_</span>4FFC0</span><br><span class="line">.data:00000000000BD350 78 00 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50078</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD358 E8 01 05 00 00 00 00 00                 DCQ loc_</span>501E8</span><br><span class="line">.data:00000000000BD360 88 02 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50288</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD368 2C 03 05 00 00 00 00 00                 DCQ loc_</span>5032C</span><br><span class="line">.data:00000000000BD370 CC 03 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_503CC</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD378 70 04 05 00 00 00 00 00                 DCQ loc_</span>50470</span><br><span class="line">.data:00000000000BD380 24 05 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50524</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD388 D4 05 05 00 00 00 00 00                 DCQ loc_</span>505D4</span><br><span class="line">.data:00000000000BD390 6C 06 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_5066C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD398 08 07 05 00 00 00 00 00                 DCQ loc_</span>50708</span><br><span class="line">.data:00000000000BD3A0 A4 07 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_507A4</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD3A8 40 08 05 00 00 00 00 00                 DCQ loc_</span>50840</span><br><span class="line">.data:00000000000BD3B0 74 37 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53774</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD3B8 C4 37 05 00 00 00 00 00                 DCQ loc_</span>537C4</span><br><span class="line">.data:00000000000BD3C0 9C 38 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_5389C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD3C8 CC 39 05 00 00 00 00 00                 DCQ loc_</span>539CC</span><br><span class="line">.data:00000000000BD3D0 44 38 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53844</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD3D8 70 37 05 00 00 00 00 00                 DCQ loc_</span>53770</span><br><span class="line">.data:00000000000BD3E0 70 37 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53770</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD3E8 C0 37 05 00 00 00 00 00                 DCQ loc_</span>537C0</span><br><span class="line">.data:00000000000BD3F0 DC 08 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_508DC</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD3F8 C8 39 05 00 00 00 00 00                 DCQ loc_</span>539C8</span><br><span class="line">.data:00000000000BD400 40 38 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53840</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD408 F4 08 05 00 00 00 00 00                 DCQ loc_</span>508F4</span><br><span class="line">.data:00000000000BD410 F4 08 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_508F4</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD418 F4 08 05 00 00 00 00 00                 DCQ loc_</span>508F4</span><br><span class="line">.data:00000000000BD420 4C 09 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_5094C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD428 A4 09 05 00 00 00 00 00                 DCQ loc_</span>509A4</span><br><span class="line">.data:00000000000BD430 F8 09 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_509F8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD438 4C 0A 05 00 00 00 00 00                 DCQ loc_</span>50A4C</span><br><span class="line">.data:00000000000BD440 AC 0A 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50AAC</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD448 00 0B 05 00 00 00 00 00                 DCQ loc_</span>50B00</span><br><span class="line">.data:00000000000BD450 54 0B 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50B54</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD458 B4 0B 05 00 00 00 00 00                 DCQ loc_</span>50BB4</span><br><span class="line">.data:00000000000BD460 10 0C 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50C10</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD468 68 0C 05 00 00 00 00 00                 DCQ loc_</span>50C68</span><br><span class="line">.data:00000000000BD470 C4 0C 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50CC4</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD478 18 0D 05 00 00 00 00 00                 DCQ loc_</span>50D18</span><br><span class="line">.data:00000000000BD480 B8 0D 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50DB8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD488 50 0E 05 00 00 00 00 00                 DCQ loc_</span>50E50</span><br><span class="line">.data:00000000000BD490 A8 0E 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50EA8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD498 44 0F 05 00 00 00 00 00                 DCQ loc_</span>50F44</span><br><span class="line">.data:00000000000BD4A0 D8 0F 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50FD8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD4A8 34 10 05 00 00 00 00 00                 DCQ loc_</span>51034</span><br><span class="line">.data:00000000000BD4B0 88 10 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51088</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD4B8 DC 10 05 00 00 00 00 00                 DCQ loc_</span>510DC</span><br><span class="line">.data:00000000000BD4C0 30 11 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51130</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD4C8 98 11 05 00 00 00 00 00                 DCQ loc_</span>51198</span><br><span class="line">.data:00000000000BD4D0 00 12 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51200</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD4D8 68 12 05 00 00 00 00 00                 DCQ loc_</span>51268</span><br><span class="line">.data:00000000000BD4E0 0C 13 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_5130C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD4E8 98 13 05 00 00 00 00 00                 DCQ loc_</span>51398</span><br><span class="line">.data:00000000000BD4F0 00 14 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51400</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD4F8 68 14 05 00 00 00 00 00                 DCQ loc_</span>51468</span><br><span class="line">.data:00000000000BD500 D0 14 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_514D0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD508 3C 15 05 00 00 00 00 00                 DCQ loc_</span>5153C</span><br><span class="line">.data:00000000000BD510 A8 15 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_515A8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD518 14 16 05 00 00 00 00 00                 DCQ loc_</span>51614</span><br><span class="line">.data:00000000000BD520 74 16 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51674</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD528 D4 16 05 00 00 00 00 00                 DCQ loc_</span>516D4</span><br><span class="line">.data:00000000000BD530 34 17 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51734</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD538 C4 17 05 00 00 00 00 00                 DCQ loc_</span>517C4</span><br><span class="line">.data:00000000000BD540 48 18 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51848</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD548 A8 18 05 00 00 00 00 00                 DCQ loc_</span>518A8</span><br><span class="line">.data:00000000000BD550 08 19 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51908</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD558 68 19 05 00 00 00 00 00                 DCQ loc_</span>51968</span><br><span class="line">.data:00000000000BD560 D0 19 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_519D0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD568 38 1A 05 00 00 00 00 00                 DCQ loc_</span>51A38</span><br><span class="line">.data:00000000000BD570 A0 1A 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51AA0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD578 10 1B 05 00 00 00 00 00                 DCQ loc_</span>51B10</span><br><span class="line">.data:00000000000BD580 80 1B 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51B80</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD588 F0 1B 05 00 00 00 00 00                 DCQ loc_</span>51BF0</span><br><span class="line">.data:00000000000BD590 60 1C 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51C60</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD598 F0 1C 05 00 00 00 00 00                 DCQ loc_</span>51CF0</span><br><span class="line">.data:00000000000BD5A0 50 1D 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51D50</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD5A8 B0 1D 05 00 00 00 00 00                 DCQ loc_</span>51DB0</span><br><span class="line">.data:00000000000BD5B0 10 1E 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51E10</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD5B8 70 1E 05 00 00 00 00 00                 DCQ loc_</span>51E70</span><br><span class="line">.data:00000000000BD5C0 F0 1E 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51EF0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD5C8 50 1F 05 00 00 00 00 00                 DCQ loc_</span>51F50</span><br><span class="line">.data:00000000000BD5D0 B0 1F 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51FB0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD5D8 10 20 05 00 00 00 00 00                 DCQ loc_</span>52010</span><br><span class="line">.data:00000000000BD5E0 A0 20 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_520A0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD5E8 24 21 05 00 00 00 00 00                 DCQ loc_</span>52124</span><br><span class="line">.data:00000000000BD5F0 84 21 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52184</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD5F8 E4 21 05 00 00 00 00 00                 DCQ loc_</span>521E4</span><br><span class="line">.data:00000000000BD600 44 22 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52244</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD608 A8 22 05 00 00 00 00 00                 DCQ loc_</span>522A8</span><br><span class="line">.data:00000000000BD610 0C 23 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_5230C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD618 70 23 05 00 00 00 00 00                 DCQ loc_</span>52370</span><br><span class="line">.data:00000000000BD620 CC 23 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_523CC</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD628 28 24 05 00 00 00 00 00                 DCQ loc_</span>52428</span><br><span class="line">.data:00000000000BD630 84 24 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52484</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD638 0C 25 05 00 00 00 00 00                 DCQ loc_</span>5250C</span><br><span class="line">.data:00000000000BD640 88 25 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52588</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD648 E4 25 05 00 00 00 00 00                 DCQ loc_</span>525E4</span><br><span class="line">.data:00000000000BD650 40 26 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52640</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD658 9C 26 05 00 00 00 00 00                 DCQ loc_</span>5269C</span><br><span class="line">.data:00000000000BD660 00 27 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52700</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD668 64 27 05 00 00 00 00 00                 DCQ loc_</span>52764</span><br><span class="line">.data:00000000000BD670 C8 27 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_527C8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD678 2C 28 05 00 00 00 00 00                 DCQ loc_</span>5282C</span><br><span class="line">.data:00000000000BD680 90 28 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52890</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD688 F4 28 05 00 00 00 00 00                 DCQ loc_</span>528F4</span><br><span class="line">.data:00000000000BD690 58 29 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52958</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD698 DC 29 05 00 00 00 00 00                 DCQ loc_</span>529DC</span><br><span class="line">.data:00000000000BD6A0 38 2A 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52A38</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD6A8 94 2A 05 00 00 00 00 00                 DCQ loc_</span>52A94</span><br><span class="line">.data:00000000000BD6B0 F0 2A 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52AF0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD6B8 4C 2B 05 00 00 00 00 00                 DCQ loc_</span>52B4C</span><br><span class="line">.data:00000000000BD6C0 C8 2B 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52BC8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD6C8 24 2C 05 00 00 00 00 00                 DCQ loc_</span>52C24</span><br><span class="line">.data:00000000000BD6D0 80 2C 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52C80</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD6D8 DC 2C 05 00 00 00 00 00                 DCQ loc_</span>52CDC</span><br><span class="line">.data:00000000000BD6E0 70 2D 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52D70</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD6E8 F8 2D 05 00 00 00 00 00                 DCQ loc_</span>52DF8</span><br><span class="line">.data:00000000000BD6F0 54 2E 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52E54</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD6F8 B0 2E 05 00 00 00 00 00                 DCQ loc_</span>52EB0</span><br><span class="line">.data:00000000000BD700 0C 2F 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52F0C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD708 6C 2F 05 00 00 00 00 00                 DCQ loc_</span>52F6C</span><br><span class="line">.data:00000000000BD710 D0 2F 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52FD0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD718 34 30 05 00 00 00 00 00                 DCQ loc_</span>53034</span><br><span class="line">.data:00000000000BD720 C8 30 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_530C8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD728 50 31 05 00 00 00 00 00                 DCQ loc_</span>53150</span><br><span class="line">.data:00000000000BD730 B0 31 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_531B0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD738 10 32 05 00 00 00 00 00                 DCQ loc_</span>53210</span><br><span class="line">.data:00000000000BD740 70 32 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53270</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD748 D0 32 05 00 00 00 00 00                 DCQ loc_</span>532D0</span><br><span class="line">.data:00000000000BD750 30 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53330</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD758 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD760 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD768 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD770 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD778 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD780 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD788 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD790 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD798 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD7A0 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD7A8 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD7B0 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD7B8 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD7C0 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD7C8 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD7D0 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD7D8 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD7E0 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD7E8 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD7F0 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD7F8 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD800 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD808 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD810 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD818 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD820 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD828 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD830 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD838 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br></pre></td></tr></table></figure>

<p>继续交叉引用sub_4CC20，来到了关键的地方，基本可以确认sub_4CC20就是解释器了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514160856292.png" alt="image-20250514160856292"></p>
<p>hook了一些libc的open、strstr、read、strcmp之类的函数，并没有发现对frida的检测，好奇怪，那为什么会执行到sub_45EBC就崩溃呢？</p>
<p>对着sub_45EBC进行分析，发现一个比较关键的地方。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514210759485.png" alt="image-20250514210759485"></p>
<p>这个时候，可以打开我们之前trace的汇编指令，究竟是谁让w8变成了0。从0x4ad0c往上找，关于x8&#x2F;w8的赋值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514211854347.png" alt="image-20250514211854347"></p>
<p>很容易就找到，x11存放了一个地址，而x10的值为0，因此w8变成了0，继续追踪x10&#x2F;x11的含义。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514212027583.png" alt="image-20250514212027583"></p>
<p>可以根据减去基址，看看x8和x0的含义，基址是0x743fc99000。</p>
<p>x0对应0x2F38BFB0，x8对应0x2D40FEC78，看来调用的不是libbaiduprotect.so的函数，应该是别的库，所以减错了基址。</p>
<p>我在ida中还原过这个地方，x8是malloc的运行地址，所以这里的x0是分配到的空间地址，和我想得不太一样啊？</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514212503520.png" alt="image-20250514212503520"></p>
<p>这说明，进入sub_45EBC函数后，应该是能正常出来的。</p>
<p>其实仔细观察，为什么会发生崩溃呢？MOV WSP, #1虽然将栈顶寄存器指向了一个会奇怪的地方，但下一条指令很快的覆盖了SP的内容，因此应该不会造成崩溃，那问题只能处在frida-stalker了，它是不是在插桩的时候用到了SP？</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514222207967.png" alt="image-20250514222207967"></p>
<p>我们来看一下frida-stalker的原理。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514222454544.png" alt="image-20250514222454544"></p>
<p>离我们的猜想很近，如果插桩的黄色代码中，使用到了sp寄存器，就会把程序弄崩溃，我们试试能不能在识别到MOV WSP, #1时候将它NOP掉，不执行，避免产生这样的问题。</p>
<p>代码如下，下面这个代码可以绕过这一条指令，继续打印追踪的流程。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> offset = <span class="number">0x88060</span>;</span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> base_addr = <span class="literal">null</span>; <span class="comment">// To store the base address of libbaiduprotect.so</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an empty function</span></span><br><span class="line"><span class="keyword">var</span> empty_func = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// console.log(&quot;[Anti-Debug] Empty function executed.&quot;); // 可选日志</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 为提高健壮性，建议使用更完善的 linker 及 call_constructors 查找逻辑</span></span><br><span class="line">    <span class="comment">// 但为保持与你原始脚本的结构，暂时保留这种直接方式</span></span><br><span class="line">    <span class="keyword">let</span> linker_module_name = <span class="title class_">Process</span>.<span class="property">arch</span> === <span class="string">&#x27;arm64&#x27;</span> ? <span class="string">&#x27;linker64&#x27;</span> : <span class="string">&#x27;linker&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(linker_module_name);</span><br><span class="line">    <span class="keyword">if</span> (!linker64_base_addr) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] Failed to get &quot;</span> + linker_module_name + <span class="string">&quot; base address. Trying to find module directly later.&quot;</span>);</span><br><span class="line">        <span class="comment">// Fallback if linker not found</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!base_addr) &#123; <span class="comment">// Check if already found</span></span><br><span class="line">                <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">                <span class="keyword">if</span> (secmodule) &#123;</span><br><span class="line">                    base_addr = secmodule.<span class="property">base</span>;</span><br><span class="line">                    module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot; base (fallback): &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                    <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] &quot;</span> + module_name + <span class="string">&quot; not found via fallback. Cannot proceed.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1500</span>); <span class="comment">// Delay slightly</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv - 这个偏移非常依赖系统</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Attempting to attach to linker&#x27;s call_constructors at &quot;</span> + call_constructors);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="comment">// console.log(&#x27;[linker] Call_Constructors onEnter&#x27;);</span></span><br><span class="line">                <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">                <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (base_addr === <span class="literal">null</span>) &#123; <span class="comment">// 确保只初始化一次</span></span><br><span class="line">                        module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                        base_addr = secmodule.<span class="property">base</span>; <span class="comment">// Save the base address</span></span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot; base: &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// *** 在这里也可以考虑直接打补丁已知崩溃点, 但Stalker内处理更灵活些 ***</span></span><br><span class="line">                        <span class="comment">// patchInstructionToNop(base_addr, 0x48AC0, 4);</span></span><br><span class="line">                        <span class="comment">// patchInstructionToNop(base_addr, 0x4ABB8, 4);</span></span><br><span class="line"></span><br><span class="line">                        <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                        listener.<span class="title function_">detach</span>();</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Detached from linker hook.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Failed to attach to linker&#x27;s call_constructors: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    Will rely on fallback to find module &quot;</span> + module_name);</span><br><span class="line">         <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="comment">// 与上面的 fallback 逻辑类似</span></span><br><span class="line">            <span class="keyword">if</span> (!base_addr) &#123;</span><br><span class="line">                <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">                <span class="keyword">if</span> (secmodule) &#123;</span><br><span class="line">                    base_addr = secmodule.<span class="property">base</span>;</span><br><span class="line">                    module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot; base (fallback after attach error): &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                    <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Fallback after attach error: &quot;</span> + module_name + <span class="string">&quot; not found.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1500</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">current_base_addr</span>) &#123; <span class="comment">// 使用 current_base_addr 区分全局 base_addr</span></span><br><span class="line">    <span class="keyword">if</span> (!current_base_addr || current_base_addr.<span class="title function_">isNull</span>())&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] hook_target_func: current_base_addr is invalid.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> target_addr = current_base_addr.<span class="title function_">add</span>(offset); <span class="comment">// offset = 0x88060</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking target function at &quot;</span> + target_addr + <span class="string">&quot; (offset 0x&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Target function &quot;</span> + module_name + <span class="string">&quot;!0x&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; entered. Called from: &quot;</span> + <span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot;!0x&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; onLeave. Base address: &quot;</span> + current_base_addr);</span><br><span class="line">                <span class="keyword">if</span> (base_addr &amp;&amp; !base_addr.<span class="title function_">isNull</span>()) &#123; <span class="comment">// 确保全局base_addr有效</span></span><br><span class="line">                    <span class="title function_">hook_pthread_create</span>();</span><br><span class="line">                    <span class="title class_">StalkerTrace</span>(base_addr); <span class="comment">// 传递正确的模块基址给StalkerTrace</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Global base_addr not set in hook_target_func onLeave. Cannot start Stalker / pthread hook.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Detached from target_func hook at &quot;</span> + target_addr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Failed to attach to target_func at &quot;</span> + target_addr + <span class="string">&quot;: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthread_create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!base_addr || base_addr.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] hook_pthread_create: Global base_addr is null.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> pthread_create_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pthread_create_addr) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking pthread_create at &quot;</span> + pthread_create_addr);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create_addr, &#123;</span><br><span class="line">                <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> func_addr = args[<span class="number">2</span>];</span><br><span class="line">                    <span class="keyword">let</span> target_func_addr = base_addr.<span class="title function_">add</span>(<span class="number">0x3E9F0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (func_addr.<span class="title function_">equals</span>(target_func_addr)) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Anti-Debug] Replacing thread start_routine &quot;</span> + func_addr + <span class="string">&quot; with empty function.&quot;</span>);</span><br><span class="line">                        args[<span class="number">2</span>] = empty_func;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Failed to attach to pthread_create: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] pthread_create not found in libc.so. Hook skipped.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">TARGET_MODULE_NAME</span> = <span class="string">&quot;libbaiduprotect.so&quot;</span>; <span class="comment">// 等同于 module_name</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_diff_regs</span>(<span class="params">context, pre_regs</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> diff_regs = &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> current_regs_snapshot = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(context));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> reg_name_orig <span class="keyword">in</span> current_regs_snapshot) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current_regs_snapshot.<span class="title function_">hasOwnProperty</span>(reg_name_orig)) &#123;</span><br><span class="line">            <span class="keyword">const</span> reg_name = reg_name_orig.<span class="title function_">toLowerCase</span>();</span><br><span class="line">            <span class="keyword">if</span> (reg_name !== <span class="string">&quot;pc&quot;</span> &amp;&amp; !reg_name.<span class="title function_">startsWith</span>(<span class="string">&quot;q&quot;</span>) &amp;&amp; reg_name !== <span class="string">&quot;sp&quot;</span>) &#123; <span class="comment">// 也可以过滤掉sp</span></span><br><span class="line">                <span class="keyword">if</span> (pre_regs[reg_name_orig] !== current_regs_snapshot[reg_name_orig]) &#123;</span><br><span class="line">                    pre_regs[reg_name_orig] = current_regs_snapshot[reg_name_orig];</span><br><span class="line">                    diff_regs[reg_name_orig] = current_regs_snapshot[reg_name_orig];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> diff_regs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_involved_regs</span>(<span class="params">instruction</span>) &#123; <span class="comment">/* ... (保持不变) ... */</span></span><br><span class="line">    <span class="keyword">const</span> involved_regs = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">    instruction.<span class="property">operands</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">op</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (op.<span class="property">type</span> === <span class="string">&#x27;reg&#x27;</span>) &#123; involved_regs.<span class="title function_">add</span>(op.<span class="property">value</span>); &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (op.<span class="property">type</span> === <span class="string">&#x27;mem&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (op.<span class="property">value</span>.<span class="property">base</span>) &#123; involved_regs.<span class="title function_">add</span>(op.<span class="property">value</span>.<span class="property">base</span>); &#125;</span><br><span class="line">            <span class="keyword">if</span> (op.<span class="property">value</span>.<span class="property">index</span>) &#123; involved_regs.<span class="title function_">add</span>(op.<span class="property">value</span>.<span class="property">index</span>); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(involved_regs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =======================================================================================</span></span><br><span class="line"><span class="comment">// 修改 StalkerTrace 函数</span></span><br><span class="line"><span class="comment">// =======================================================================================</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">StalkerTrace</span>(<span class="params">current_module_baseaddr</span>) &#123; <span class="comment">// 确保传入的是正确的模块基地址</span></span><br><span class="line">    <span class="keyword">var</span> stalker_target_func_offset = <span class="number">0x4a458</span>; <span class="comment">// 这是你希望Stalker开始追踪的函数偏移</span></span><br><span class="line">    <span class="keyword">var</span> sub_42598_addr = current_module_baseaddr.<span class="title function_">add</span>(stalker_target_func_offset);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] StalkerTrace will target &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; at actual address: &quot;</span> + sub_42598_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> module_stalk_target = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(sub_42598_addr);</span><br><span class="line">    <span class="keyword">if</span> (!module_stalk_target || module_stalk_target.<span class="property">name</span> !== <span class="variable constant_">TARGET_MODULE_NAME</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] StalkerTrace: Module for target function (&quot;</span> + sub_42598_addr + <span class="string">&quot;) is not &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> +</span><br><span class="line">                      <span class="string">&quot;. Found: &quot;</span> + (module_stalk_target ? module_stalk_target.<span class="property">name</span> : <span class="string">&quot;none&quot;</span>) +</span><br><span class="line">                      <span class="string">&quot;. Ensure base address and offset are correct. Stalker might not work as expected.&quot;</span>);</span><br><span class="line">        <span class="comment">// 如果模块名不匹配，我们可能不应该继续，或者用传入的 baseaddr 作为module_start/end的依据</span></span><br><span class="line">        <span class="keyword">if</span> (!current_module_baseaddr || current_module_baseaddr.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] StalkerTrace: No valid base address to proceed with module bounds.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">         module_stalk_target = &#123; <span class="attr">base</span>: current_module_baseaddr, <span class="attr">size</span>: module_size, <span class="attr">name</span>: <span class="variable constant_">TARGET_MODULE_NAME</span> &#125;; <span class="comment">// module_size 是全局的</span></span><br><span class="line">         <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] StalkerTrace: Using passed base_addr for module bounds for Stalker.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> module_start = module_stalk_target.<span class="property">base</span>;</span><br><span class="line">    <span class="keyword">const</span> module_end = module_stalk_target.<span class="property">base</span>.<span class="title function_">add</span>(module_stalk_target.<span class="property">size</span>); <span class="comment">// Stalker只记录此模块内的指令</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Stalker module bounds: Start=&quot;</span> + module_start + <span class="string">&quot;, End=&quot;</span> + module_end);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(sub_42598_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">tid</span> = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Stalker: Entered &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; (TID: &quot;</span> + <span class="variable language_">this</span>.<span class="property">tid</span> + <span class="string">&quot;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> local_pre_regs = &#123;&#125;;</span><br><span class="line">            <span class="keyword">const</span> initial_context_snapshot = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">context</span>));</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> reg_name_orig <span class="keyword">in</span> initial_context_snapshot) &#123;</span><br><span class="line">                <span class="keyword">if</span> (initial_context_snapshot.<span class="title function_">hasOwnProperty</span>(reg_name_orig)) &#123;</span><br><span class="line">                    <span class="keyword">const</span> reg_name = reg_name_orig.<span class="title function_">toLowerCase</span>();</span><br><span class="line">                    <span class="keyword">if</span> (reg_name !== <span class="string">&quot;pc&quot;</span> &amp;&amp; !reg_name.<span class="title function_">startsWith</span>(<span class="string">&quot;q&quot;</span>)) &#123;</span><br><span class="line">                        local_pre_regs[reg_name_orig] = initial_context_snapshot[reg_name_orig];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// === 新增：用于直接patch的已知崩溃点 ===</span></span><br><span class="line">            <span class="comment">// 这些地址相对于 current_module_baseaddr (即 libbaiduprotect.so 的基地址)</span></span><br><span class="line">            <span class="keyword">const</span> knownCrashOffsets = [<span class="number">0x48AC0</span>, <span class="number">0x4ABB8</span>]; <span class="comment">// 把已知的都列出来</span></span><br><span class="line">            knownCrashOffsets.<span class="title function_">forEach</span>(<span class="function"><span class="params">offset</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> patchAddr = current_module_baseaddr.<span class="title function_">add</span>(offset);</span><br><span class="line">                    <span class="comment">// 读取指令，确认是否是 MOV WSP, #1</span></span><br><span class="line">                    <span class="keyword">const</span> instrBytes = patchAddr.<span class="title function_">readByteArray</span>(<span class="number">4</span>);</span><br><span class="line">                    <span class="comment">// MOV WSP, #1 (MOVZ W31, #1, LSL #0) -&gt; FF 03 00 32 (Little Endian: 320003FF)</span></span><br><span class="line">                    <span class="keyword">if</span> (instrBytes &amp;&amp; instrBytes[<span class="number">0</span>] === <span class="number">0x32</span> &amp;&amp; instrBytes[<span class="number">1</span>] === <span class="number">0x00</span> &amp;&amp; instrBytes[<span class="number">2</span>] === <span class="number">0x03</span> &amp;&amp; instrBytes[<span class="number">3</span>] === <span class="number">0xFF</span>) &#123;</span><br><span class="line">                        <span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(patchAddr, <span class="number">4</span>, <span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">                            <span class="keyword">const</span> writer = <span class="keyword">new</span> <span class="title class_">Arm64Writer</span>(code, &#123; <span class="attr">pc</span>: patchAddr &#125;);</span><br><span class="line">                            writer.<span class="title function_">putNop</span>();</span><br><span class="line">                            writer.<span class="title function_">flush</span>();</span><br><span class="line">                        &#125;);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[MemoryPatch] Stalker&#x27;s onEnter: NOPped known crash (MOV WSP, #1) at &quot;</span> + module_name + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(offset) + <span class="string">&quot; (&quot;</span>+ patchAddr + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// console.log(&quot;[MemoryPatch] Stalker&#x27;s onEnter: Instruction at &quot; + module_name + &quot;!&quot; + ptr(offset) + &quot; is not MOV WSP, #1. Bytes: &quot; + Array.from(new Uint8Array(instrBytes)).map(b =&gt; b.toString(16).padStart(2,&#x27;0&#x27;)).join(&#x27;&#x27;));</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[MemoryPatch] Stalker&#x27;s onEnter: Error patching &quot;</span> + module_name + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(offset) + <span class="string">&quot;: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// =====================================</span></span><br><span class="line"></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">follow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>, &#123;</span><br><span class="line">                <span class="attr">events</span>: &#123; <span class="attr">call</span>: <span class="literal">false</span>, <span class="attr">ret</span>: <span class="literal">false</span>, <span class="attr">exec</span>: <span class="literal">true</span>, <span class="attr">block</span>: <span class="literal">false</span>, <span class="attr">compile</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">                <span class="title function_">transform</span>(<span class="params">iterator</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> instruction = iterator.<span class="title function_">next</span>();</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="keyword">const</span> currentAddress = instruction.<span class="property">address</span>;</span><br><span class="line">                        <span class="keyword">let</span> patchedThisInstruction = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 通用的 MOV WSP/SP, #1 检测和NOP逻辑 (作为补充)</span></span><br><span class="line">                        <span class="keyword">const</span> mnemonic = instruction.<span class="property">mnemonic</span>.<span class="title function_">toLowerCase</span>();</span><br><span class="line">                        <span class="keyword">if</span> ((mnemonic === <span class="string">&#x27;mov&#x27;</span> || mnemonic === <span class="string">&#x27;movz&#x27;</span>) &amp;&amp; instruction.<span class="property">operands</span>.<span class="property">length</span> &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                            <span class="keyword">const</span> destOperand = instruction.<span class="property">operands</span>[<span class="number">0</span>];</span><br><span class="line">                            <span class="keyword">const</span> srcOperand = instruction.<span class="property">operands</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (destOperand.<span class="property">type</span> === <span class="string">&#x27;reg&#x27;</span> &amp;&amp;</span><br><span class="line">                                (destOperand.<span class="property">value</span> === <span class="string">&#x27;wsp&#x27;</span> || destOperand.<span class="property">value</span> === <span class="string">&#x27;sp&#x27;</span> ||</span><br><span class="line">                                 destOperand.<span class="property">value</span> === <span class="string">&#x27;w31&#x27;</span> || destOperand.<span class="property">value</span> === <span class="string">&#x27;x31&#x27;</span>) &amp;&amp;</span><br><span class="line">                                srcOperand.<span class="property">type</span> === <span class="string">&#x27;imm&#x27;</span> &amp;&amp;</span><br><span class="line">                                <span class="built_in">parseInt</span>(srcOperand.<span class="property">value</span>.<span class="title function_">toString</span>()) === <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[StalkerTransform] Identified &#x27;&quot;</span> + instruction.<span class="title function_">toString</span>() + <span class="string">&quot;&#x27; at &quot;</span> + currentAddress + <span class="string">&quot;. Replacing with NOP.&quot;</span>);</span><br><span class="line">                                iterator.<span class="title function_">putNop</span>();</span><br><span class="line">                                patchedThisInstruction = <span class="literal">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (!patchedThisInstruction) &#123;</span><br><span class="line">                            <span class="comment">// 仅在模块代码范围内执行putCallout，减少日志量并避免干扰其他模块</span></span><br><span class="line">                            <span class="keyword">const</span> is_module_code = currentAddress.<span class="title function_">compare</span>(module_start) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                                   currentAddress.<span class="title function_">compare</span>(module_end) &lt; <span class="number">0</span>;</span><br><span class="line">                            <span class="keyword">if</span> (is_module_code) &#123;</span><br><span class="line">                                iterator.<span class="title function_">putCallout</span>(<span class="keyword">function</span> (<span class="params">context</span>) &#123;</span><br><span class="line">                                    <span class="keyword">var</span> pc = context.<span class="property">pc</span>;</span><br><span class="line">                                    <span class="comment">// module_start, module_end, TARGET_MODULE_NAME, get_diff_regs, local_pre_regs</span></span><br><span class="line">                                    <span class="comment">// 这些变量需要能被这个闭包访问到。local_pre_regs 是 onEnter 作用域的。</span></span><br><span class="line">                                    <span class="comment">// module_start 等可以考虑从外部作用域传入或再次获取。</span></span><br><span class="line">                                    <span class="comment">// 为简化，假设它们可访问。</span></span><br><span class="line">                                    <span class="keyword">var</span> current_callout_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(pc);</span><br><span class="line">                                    <span class="keyword">if</span> (current_callout_module &amp;&amp; current_callout_module.<span class="property">name</span> === <span class="variable constant_">TARGET_MODULE_NAME</span>) &#123;</span><br><span class="line">                                        <span class="keyword">const</span> instrToLog = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(pc);</span><br><span class="line">                                        <span class="keyword">const</span> diff_regs = <span class="title function_">get_diff_regs</span>(context, local_pre_regs);</span><br><span class="line">                                        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">                                            current_callout_module.<span class="property">name</span> + <span class="string">&quot;!&quot;</span> + pc.<span class="title function_">sub</span>(current_callout_module.<span class="property">base</span>),</span><br><span class="line">                                            instrToLog.<span class="title function_">toString</span>(),</span><br><span class="line">                                            <span class="string">&quot;\t\t&quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(diff_regs)</span><br><span class="line">                                        );</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;);</span><br><span class="line">                            &#125;</span><br><span class="line">                            iterator.<span class="title function_">keep</span>();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((instruction = iterator.<span class="title function_">next</span>()) !== <span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; onLeave, TID:&quot;</span>, <span class="variable language_">this</span>.<span class="property">tid</span>);</span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">unfollow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>); <span class="comment">// 在函数退出时明确停止Stalker是个好习惯</span></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">garbageCollect</span>();   <span class="comment">// 回收Stalker资源</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Script starting for &quot;</span> + module_name + <span class="string">&quot;...&quot;</span>);</span><br><span class="line">    <span class="title function_">hook_linker_call_constructors</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Script loaded. Waiting for &quot;</span> + module_name + <span class="string">&quot;...&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>听说frida-sktrace实现了字符串（连续有4个可显示的字符时，打印字符串）的打印，而且更美观一些，这里试试使用frida-sktrace，但似乎不支持spawn模式附加进程，而且hook的时机还得修改，我决定在我原有的代码上添加这个功能。——我改成了，存在连续3个可视字符时，把指针内容当成字符串地址。</p>
<p>下面是让大模型帮我写的代码，不过也太长了吧。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// =======================================================================================</span></span><br><span class="line"><span class="comment">// Modified StalkerTrace Function (FIXED local_pre_regs access)</span></span><br><span class="line"><span class="comment">// =======================================================================================</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">StalkerTrace</span>(<span class="params">current_module_baseaddr</span>) &#123; <span class="comment">// Ensure the correct module base address is passed</span></span><br><span class="line">    <span class="comment">// Use the global module_size which should be set by now</span></span><br><span class="line">    <span class="keyword">if</span> (!current_module_baseaddr || current_module_baseaddr.<span class="title function_">isNull</span>() || module_size === <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] StalkerTrace: Invalid module base address or size. Cannot proceed.&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> stalker_target_func_offset = <span class="number">0x4a458</span>; <span class="comment">// The offset of the function you want Stalker to trace</span></span><br><span class="line">    <span class="keyword">var</span> stalker_start_addr = current_module_baseaddr.<span class="title function_">add</span>(stalker_target_func_offset);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] StalkerTrace will target &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; at actual address: &quot;</span> + stalker_start_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define the module bounds for Stalker logging</span></span><br><span class="line">    <span class="keyword">const</span> module_start = current_module_baseaddr;</span><br><span class="line">    <span class="keyword">const</span> module_end = current_module_baseaddr.<span class="title function_">add</span>(module_size);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Stalker module bounds: Start=&quot;</span> + module_start + <span class="string">&quot;, End=&quot;</span> + module_end);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(stalker_start_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="comment">// Stalker operates per thread. Get the current thread ID.</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">tid</span> = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Stalker: Entered &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; (TID: &quot;</span> + <span class="variable language_">this</span>.<span class="property">tid</span> + <span class="string">&quot;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize previous register state *for this specific thread*.</span></span><br><span class="line">            <span class="comment">// This variable is local to this onEnter call but will be captured by the closure.</span></span><br><span class="line">            <span class="keyword">const</span> local_pre_regs = &#123;&#125;; </span><br><span class="line">            <span class="comment">// Populate initial state, excluding filtered registers</span></span><br><span class="line">            <span class="keyword">const</span> initial_context_snapshot = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">context</span>));</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> reg_name_orig <span class="keyword">in</span> initial_context_snapshot) &#123;</span><br><span class="line">                <span class="keyword">if</span> (initial_context_snapshot.<span class="title function_">hasOwnProperty</span>(reg_name_orig)) &#123;</span><br><span class="line">                    <span class="keyword">const</span> reg_name_lower = reg_name_orig.<span class="title function_">toLowerCase</span>();</span><br><span class="line">                     <span class="keyword">if</span> (reg_name_lower !== <span class="string">&quot;pc&quot;</span> &amp;&amp; reg_name_lower !== <span class="string">&quot;sp&quot;</span> &amp;&amp; !reg_name_lower.<span class="title function_">startsWith</span>(<span class="string">&quot;q&quot;</span>) &amp;&amp; !reg_name_lower.<span class="title function_">startsWith</span>(<span class="string">&quot;v&quot;</span>)) &#123;</span><br><span class="line">                        local_pre_regs[reg_name_orig] = initial_context_snapshot[reg_name_orig];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// *** REMOVE THIS LINE *** this.local_pre_regs = local_pre_regs; </span></span><br><span class="line">            <span class="comment">// The variable &#x27;local_pre_regs&#x27; is already in scope for the transform/callout closures.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// === Patch known crashing instructions on entering the traced function ===</span></span><br><span class="line">            <span class="comment">// These addresses are relative to the module base address (current_module_baseaddr)</span></span><br><span class="line">            <span class="keyword">const</span> knownCrashOffsets = [<span class="number">0x48AC0</span>, <span class="number">0x4ABB8</span>]; <span class="comment">// List of known problematic instruction offsets</span></span><br><span class="line">            knownCrashOffsets.<span class="title function_">forEach</span>(<span class="function"><span class="params">offset</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> patchAddr = current_module_baseaddr.<span class="title function_">add</span>(offset);</span><br><span class="line">                    <span class="comment">// Read instruction bytes to verify it&#x27;s the expected &#x27;MOV WSP, #1&#x27;</span></span><br><span class="line">                    <span class="comment">// ARM64: MOV WSP, #1 is 320003FF (little endian)</span></span><br><span class="line">                    <span class="keyword">const</span> expectedBytes = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0x32</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>]);</span><br><span class="line">                    <span class="keyword">const</span> instrBytes = patchAddr.<span class="title function_">readByteArray</span>(<span class="number">4</span>);</span><br><span class="line">                    <span class="keyword">const</span> actualBytes = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(instrBytes);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">let</span> matchesExpected = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (actualBytes.<span class="property">length</span> === <span class="number">4</span>) &#123;</span><br><span class="line">                         <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">4</span>; i++) &#123;</span><br><span class="line">                              <span class="keyword">if</span> (actualBytes[i] !== expectedBytes[i]) &#123;</span><br><span class="line">                                   matchesExpected = <span class="literal">false</span>;</span><br><span class="line">                                   <span class="keyword">break</span>;</span><br><span class="line">                              &#125;</span><br><span class="line">                         &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         matchesExpected = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (matchesExpected) &#123;</span><br><span class="line">                         <span class="comment">// If it matches, NOP it</span></span><br><span class="line">                         <span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(patchAddr, <span class="number">4</span>, <span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">                             <span class="keyword">const</span> writer = <span class="keyword">new</span> <span class="title class_">Arm64Writer</span>(code, &#123; <span class="attr">pc</span>: patchAddr &#125;);</span><br><span class="line">                             writer.<span class="title function_">putNop</span>(); <span class="comment">// Replace the instruction with NOP</span></span><br><span class="line">                             writer.<span class="title function_">flush</span>();</span><br><span class="line">                         &#125;);</span><br><span class="line">                         <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[MemoryPatch] Stalker&#x27;s onEnter: NOPped known crash (MOV WSP, #1) at &quot;</span> + module_name + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(offset) + <span class="string">&quot; (&quot;</span>+ patchAddr + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         <span class="comment">// console.log(&quot;[MemoryPatch] Stalker&#x27;s onEnter: Instruction at &quot; + module_name + &quot;!&quot; + ptr(offset) + &quot; is not MOV WSP, #1. Bytes: &quot; + Array.from(actualBytes).map(b =&gt; b.toString(16).padStart(2,&#x27;0&#x27;)).join(&#x27;&#x27;)); // Optional log</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[MemoryPatch] Stalker&#x27;s onEnter: Error patching &quot;</span> + module_name + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(offset) + <span class="string">&quot;: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// ==================================================================</span></span><br><span class="line"></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">follow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>, &#123;</span><br><span class="line">                 <span class="comment">// Configure events to trace. exec=true traces every executed instruction.</span></span><br><span class="line">                <span class="attr">events</span>: &#123; <span class="attr">call</span>: <span class="literal">false</span>, <span class="attr">ret</span>: <span class="literal">false</span>, <span class="attr">exec</span>: <span class="literal">true</span>, <span class="attr">block</span>: <span class="literal">false</span>, <span class="attr">compile</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">                 <span class="comment">// The transform callback allows inspecting/rewriting instruction blocks</span></span><br><span class="line">                <span class="title function_">transform</span>(<span class="params">iterator</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> instruction = iterator.<span class="title function_">next</span>();</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="keyword">const</span> currentAddress = instruction.<span class="property">address</span>;</span><br><span class="line">                        <span class="keyword">let</span> patchedThisInstruction = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Check if the instruction is within the target module&#x27;s bounds</span></span><br><span class="line">                        <span class="keyword">const</span> is_module_code = currentAddress.<span class="title function_">compare</span>(module_start) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                               currentAddress.<span class="title function_">compare</span>(module_end) &lt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                         <span class="comment">// === Universal MOV WSP/SP, #1 detection and NOP logic ===</span></span><br><span class="line">                         <span class="comment">// This is a fallback/alternative to the onEnter patch</span></span><br><span class="line">                         <span class="comment">// It happens per block compiled by Stalker</span></span><br><span class="line">                        <span class="keyword">if</span> (is_module_code) &#123; <span class="comment">// Only patch instructions within the target module</span></span><br><span class="line">                            <span class="keyword">const</span> mnemonic = instruction.<span class="property">mnemonic</span>.<span class="title function_">toLowerCase</span>();</span><br><span class="line">                             <span class="comment">// Check for MOV or MOVZ with SP/WSP as destination and immediate 1</span></span><br><span class="line">                             <span class="keyword">if</span> ((mnemonic === <span class="string">&#x27;mov&#x27;</span> || mnemonic === <span class="string">&#x27;movz&#x27;</span>) &amp;&amp; instruction.<span class="property">operands</span>.<span class="property">length</span> &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                                 <span class="keyword">const</span> destOperand = instruction.<span class="property">operands</span>[<span class="number">0</span>];</span><br><span class="line">                                 <span class="keyword">const</span> srcOperand = instruction.<span class="property">operands</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                                 <span class="keyword">if</span> (destOperand.<span class="property">type</span> === <span class="string">&#x27;reg&#x27;</span> &amp;&amp;</span><br><span class="line">                                     (destOperand.<span class="property">value</span> === <span class="string">&#x27;wsp&#x27;</span> || destOperand.<span class="property">value</span> === <span class="string">&#x27;sp&#x27;</span> ||</span><br><span class="line">                                      destOperand.<span class="property">value</span> === <span class="string">&#x27;w31&#x27;</span> || destOperand.<span class="property">value</span> === <span class="string">&#x27;x31&#x27;</span>) &amp;&amp; <span class="comment">// w31/x31 are aliases for wsp/sp</span></span><br><span class="line">                                     srcOperand.<span class="property">type</span> === <span class="string">&#x27;imm&#x27;</span> &amp;&amp;</span><br><span class="line">                                     <span class="built_in">parseInt</span>(srcOperand.<span class="property">value</span>.<span class="title function_">toString</span>()) === <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">                                     <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[StalkerTransform] Identified potential crash instruction &#x27;&quot;</span> + instruction.<span class="title function_">toString</span>() + <span class="string">&quot;&#x27; at &quot;</span> + currentAddress + <span class="string">&quot;. Replacing with NOP.&quot;</span>);</span><br><span class="line">                                     iterator.<span class="title function_">putNop</span>(); <span class="comment">// Replace the instruction with NOP</span></span><br><span class="line">                                     patchedThisInstruction = <span class="literal">true</span>;</span><br><span class="line">                                 &#125;</span><br><span class="line">                             &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// =========================================================</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">// If the instruction wasn&#x27;t NOPped by the above check, add a callout for logging</span></span><br><span class="line">                        <span class="keyword">if</span> (!patchedThisInstruction) &#123;</span><br><span class="line">                            <span class="comment">// Only add callout for instructions within the target module</span></span><br><span class="line">                            <span class="keyword">if</span> (is_module_code) &#123;</span><br><span class="line">                                <span class="comment">// &#x27;local_pre_regs&#x27; is accessible here via closure</span></span><br><span class="line">                                iterator.<span class="title function_">putCallout</span>(<span class="keyword">function</span> (<span class="params">context</span>) &#123;</span><br><span class="line">                                    <span class="comment">// Access local_pre_regs directly from the outer scope (captured by closure)</span></span><br><span class="line">                                    <span class="keyword">const</span> thread_pre_regs = local_pre_regs; </span><br><span class="line">                                    <span class="keyword">const</span> pc = context.<span class="property">pc</span>;</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// Get the register differences after this instruction executes</span></span><br><span class="line">                                    <span class="comment">// get_diff_regs modifies thread_pre_regs in place</span></span><br><span class="line">                                    <span class="keyword">const</span> diff_regs = <span class="title function_">get_diff_regs</span>(context, thread_pre_regs);</span><br><span class="line">                                    </span><br><span class="line">                                    <span class="comment">// Find the module info again (can be optimized by caching, but this is reliable)</span></span><br><span class="line">                                    <span class="keyword">var</span> current_callout_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(pc);</span><br><span class="line"></span><br><span class="line">                                     <span class="comment">// Ensure we are logging code from the target module</span></span><br><span class="line">                                     <span class="keyword">if</span> (current_callout_module &amp;&amp; current_callout_module.<span class="property">name</span> === <span class="variable constant_">TARGET_MODULE_NAME</span>) &#123;</span><br><span class="line">                                         <span class="keyword">const</span> instrToLog = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(pc);</span><br><span class="line">                                         <span class="keyword">let</span> logLine = <span class="string">`<span class="subst">$&#123;current_callout_module.name&#125;</span>!<span class="subst">$&#123;pc.sub(current_callout_module.base)&#125;</span> <span class="subst">$&#123;instrToLog.toString()&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">                                         <span class="comment">// Append changed registers and potential strings</span></span><br><span class="line">                                         <span class="keyword">const</span> diffRegKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(diff_regs);</span><br><span class="line">                                         <span class="keyword">if</span> (diffRegKeys.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                              logLine += <span class="string">`\t\t| Changed Regs: `</span>;</span><br><span class="line">                                              <span class="keyword">let</span> firstReg = <span class="literal">true</span>;</span><br><span class="line">                                              <span class="keyword">for</span> (<span class="keyword">const</span> regName <span class="keyword">of</span> diffRegKeys) &#123;</span><br><span class="line">                                                   <span class="keyword">if</span> (!firstReg) logLine += <span class="string">&quot;, &quot;</span>;</span><br><span class="line">                                                   firstReg = <span class="literal">false</span>;</span><br><span class="line">                                                   <span class="keyword">const</span> regValue = diff_regs[regName]; <span class="comment">// The new value of the register</span></span><br><span class="line">                                                   logLine += <span class="string">`<span class="subst">$&#123;regName&#125;</span>=<span class="subst">$&#123;regValue&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">                                                   <span class="comment">// --- Check if the register value points to a string ---</span></span><br><span class="line">                                                   <span class="keyword">const</span> potentialString = <span class="title function_">tryReadString</span>(regValue);</span><br><span class="line">                                                   <span class="keyword">if</span> (potentialString !== <span class="literal">null</span>) &#123;</span><br><span class="line">                                                       <span class="comment">// Truncate long strings for readability</span></span><br><span class="line">                                                       <span class="keyword">const</span> displayString = potentialString.<span class="property">length</span> &gt; <span class="number">60</span> ? potentialString.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">57</span>) + <span class="string">&quot;...&quot;</span> : potentialString;</span><br><span class="line">                                                       <span class="comment">// Escape potential quotes in the string for cleaner output</span></span><br><span class="line">                                                       <span class="keyword">const</span> escapedString = displayString.<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;\\&quot;&#x27;</span>).<span class="title function_">replace</span>(<span class="regexp">/\n/g</span>, <span class="string">&#x27;\\n&#x27;</span>).<span class="title function_">replace</span>(<span class="regexp">/\r/g</span>, <span class="string">&#x27;\\r&#x27;</span>);</span><br><span class="line">                                                        logLine += <span class="string">` (&quot;<span class="subst">$&#123;escapedString&#125;</span>&quot;)`</span>;</span><br><span class="line">                                                   &#125;</span><br><span class="line">                                                   <span class="comment">// ----------------------------------------------------------</span></span><br><span class="line">                                              &#125;</span><br><span class="line">                                         &#125;</span><br><span class="line"></span><br><span class="line">                                         <span class="variable language_">console</span>.<span class="title function_">log</span>(logLine);</span><br><span class="line">                                     &#125;</span><br><span class="line">                                &#125;);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// Keep the original instruction</span></span><br><span class="line">                            iterator.<span class="title function_">keep</span>();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((instruction = iterator.<span class="title function_">next</span>()) !== <span class="literal">null</span>); <span class="comment">// Process next instruction in the block</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; onLeave, TID:&quot;</span>, <span class="variable language_">this</span>.<span class="property">tid</span>);</span><br><span class="line">             <span class="comment">// Stop stalking this thread when the function exits</span></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">unfollow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>);</span><br><span class="line">             <span class="comment">// Clean up Stalker&#x27;s compiled code cache</span></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">garbageCollect</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... (rest of the script remains the same)</span></span><br><span class="line"><span class="comment">// hook_linker_call_constructors();</span></span><br><span class="line"><span class="comment">// hook_target_func(base_addr); // Called from linker hook or fallback</span></span><br><span class="line"><span class="comment">// hook_pthread_create(); // Called from hook_target_func onLeave</span></span><br><span class="line"><span class="comment">// tryReadString() // Helper function defined above</span></span><br><span class="line"><span class="comment">// get_diff_regs() // Helper function defined above</span></span><br><span class="line"><span class="comment">// get_involved_regs() // Helper function defined above</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> offset = <span class="number">0x88060</span>;</span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>; <span class="comment">// Will be populated when module is found</span></span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> base_addr = <span class="literal">null</span>; <span class="comment">// To store the base address of libbaiduprotect.so</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an empty function</span></span><br><span class="line"><span class="keyword">var</span> empty_func = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// console.log(&quot;[Anti-Debug] Empty function executed.&quot;); // Optional log</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- Helper function to attempt reading a string ---</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">tryReadString</span>(<span class="params">address, minPrintableBytes = <span class="number">3</span>, maxReadLength = <span class="number">256</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!address) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// Cannot read from null address</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Step 1: Read the first few bytes to see if they look like printable ASCII</span></span><br><span class="line">        <span class="keyword">const</span> preliminaryBytes = address.<span class="title function_">readByteArray</span>(minPrintableBytes);</span><br><span class="line">        <span class="keyword">if</span> (!preliminaryBytes) &#123;</span><br><span class="line">             <span class="comment">// Can&#x27;t read the initial bytes (e.g., invalid address)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> uint8Array = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(preliminaryBytes);</span><br><span class="line">        <span class="keyword">let</span> allPrintable = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; uint8Array.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> byte = uint8Array[i];</span><br><span class="line">            <span class="comment">// Basic check for printable ASCII (0x20 to 0x7E)</span></span><br><span class="line">            <span class="keyword">if</span> (byte &lt; <span class="number">0x20</span> || byte &gt; <span class="number">0x7E</span>) &#123;</span><br><span class="line">                allPrintable = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (allPrintable) &#123;</span><br><span class="line">            <span class="comment">// Step 2: If they look printable, attempt to read a C-string</span></span><br><span class="line">            <span class="comment">// readCString reads until null terminator or max length</span></span><br><span class="line">            <span class="keyword">const</span> str = address.<span class="title function_">readCString</span>(maxReadLength);</span><br><span class="line">             <span class="comment">// Filter out empty strings or strings that only contained non-null printable chars but no null terminator early on</span></span><br><span class="line">            <span class="keyword">if</span> (str &amp;&amp; str.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> str;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="comment">// Reading failed (e.g., invalid memory access)</span></span><br><span class="line">        <span class="comment">// console.warn(&quot;[-] Failed to read memory at &quot; + address + &quot; for string check: &quot; + e.message); // Optional: Log errors</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// Did not pass the checks or failed to read</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 为提高健壮性，建议使用更完善的 linker 及 call_constructors 查找逻辑</span></span><br><span class="line">    <span class="comment">// 但为保持与你原始脚本的结构，暂时保留这种直接方式</span></span><br><span class="line">    <span class="keyword">let</span> linker_module_name = <span class="title class_">Process</span>.<span class="property">arch</span> === <span class="string">&#x27;arm64&#x27;</span> ? <span class="string">&#x27;linker64&#x27;</span> : <span class="string">&#x27;linker&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(linker_module_name);</span><br><span class="line">    <span class="keyword">if</span> (!linker64_base_addr) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] Failed to get &quot;</span> + linker_module_name + <span class="string">&quot; base address. Trying to find module directly later.&quot;</span>);</span><br><span class="line">        <span class="comment">// Fallback if linker not found</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!base_addr) &#123; <span class="comment">// Check if already found</span></span><br><span class="line">                <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">                <span class="keyword">if</span> (secmodule) &#123;</span><br><span class="line">                    base_addr = secmodule.<span class="property">base</span>;</span><br><span class="line">                    module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot; base (fallback): &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                    <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] &quot;</span> + module_name + <span class="string">&quot; not found via fallback. Cannot proceed.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1500</span>); <span class="comment">// Delay slightly</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> This offset is highly dependent on the system/Android version and linker variant!</span></span><br><span class="line">    <span class="comment">// A more robust approach would involve scanning for the function signature.</span></span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// Example: __dl__ZN6soinfo17call_constructorsEv on some systems</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Attempting to attach to linker&#x27;s call_constructors at &quot;</span> + call_constructors);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="comment">// console.log(&#x27;[linker] Call_Constructors onEnter&#x27;);</span></span><br><span class="line">                <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">                <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (base_addr === <span class="literal">null</span>) &#123; <span class="comment">// Ensure initialized only once</span></span><br><span class="line">                        module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                        base_addr = secmodule.<span class="property">base</span>; <span class="comment">// Save the base address</span></span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot; base: &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// *** Consider patching known points here or within Stalker ***</span></span><br><span class="line">                        <span class="comment">// Patching here happens earlier, might be safer for some anti-debug</span></span><br><span class="line">                        <span class="comment">// patchInstructionToNop(base_addr, 0x48AC0, 4); // Example offset</span></span><br><span class="line">                        <span class="comment">// patchInstructionToNop(base_addr, 0x4ABB8, 4); // Example offset</span></span><br><span class="line"></span><br><span class="line">                        <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                        listener.<span class="title function_">detach</span>(); <span class="comment">// Detach once the module is found</span></span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Detached from linker hook.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// No onLeave needed for just finding the module base</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Failed to attach to linker&#x27;s call_constructors: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    Will rely on fallback to find module &quot;</span> + module_name);</span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="comment">// Similar fallback logic as above</span></span><br><span class="line">              <span class="keyword">if</span> (!base_addr) &#123;</span><br><span class="line">                  <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">                  <span class="keyword">if</span> (secmodule) &#123;</span><br><span class="line">                      base_addr = secmodule.<span class="property">base</span>;</span><br><span class="line">                      module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                      <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot; base (fallback after attach error): &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                      <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Fallback after attach error: &quot;</span> + module_name + <span class="string">&quot; not found.&quot;</span>);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;, <span class="number">1500</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">current_base_addr</span>) &#123; <span class="comment">// Use current_base_addr to distinguish from global base_addr</span></span><br><span class="line">    <span class="keyword">if</span> (!current_base_addr || current_base_addr.<span class="title function_">isNull</span>())&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] hook_target_func: current_base_addr is invalid.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> target_addr = current_base_addr.<span class="title function_">add</span>(offset); <span class="comment">// offset = 0x88060</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking target function at &quot;</span> + target_addr + <span class="string">&quot; (offset 0x&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Use attachOnce if you only need it to trigger once</span></span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Target function &quot;</span> + module_name + <span class="string">&quot;!0x&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; entered. Called from: &quot;</span> + <span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot;!0x&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; onLeave. Base address: &quot;</span> + current_base_addr);</span><br><span class="line">                <span class="comment">// IMPORTANT: Use the global base_addr here as it should be set by now and is needed by StalkerTrace/pthread hook</span></span><br><span class="line">                <span class="keyword">if</span> (base_addr &amp;&amp; !base_addr.<span class="title function_">isNull</span>()) &#123; </span><br><span class="line">                    <span class="title function_">hook_pthread_create</span>();</span><br><span class="line">                    <span class="title class_">StalkerTrace</span>(base_addr); <span class="comment">// Pass the correct module base address to StalkerTrace</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Global base_addr not set in hook_target_func onLeave. Cannot start Stalker / pthread hook.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                 <span class="comment">// No need to detach here if using attachOnce, but if using attach, you might detach</span></span><br><span class="line">                 <span class="comment">// listener.detach();</span></span><br><span class="line">                 <span class="comment">// console.log(&quot;[i] Detached from target_func hook at &quot; + target_addr);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">         <span class="comment">// Note: Interceptor.attachOnce is often better if you only need the onLeave logic once</span></span><br><span class="line">         <span class="comment">// However, let&#x27;s stick to attach and detach in onLeave for now based on your original code structure.</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Failed to attach to target_func at &quot;</span> + target_addr + <span class="string">&quot;: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthread_create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Ensure base_addr is set before hooking pthread_create as it&#x27;s needed for comparison</span></span><br><span class="line">    <span class="keyword">if</span> (!base_addr || base_addr.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] hook_pthread_create: Global base_addr is null. Skipping hook.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> pthread_create_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pthread_create_addr) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking pthread_create at &quot;</span> + pthread_create_addr);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create_addr, &#123;</span><br><span class="line">                <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                    <span class="comment">// pthread_create signature:</span></span><br><span class="line">                    <span class="comment">// int pthread_create(pthread_t *thread, const pthread_attr_t *attr, void *(*start_routine) (void *), void *arg);</span></span><br><span class="line">                    <span class="comment">// start_routine is the 3rd argument (index 2)</span></span><br><span class="line">                    <span class="keyword">let</span> func_addr = args[<span class="number">2</span>]; </span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Target function address within libbaiduprotect.so</span></span><br><span class="line">                    <span class="comment">// This offset (0x3E9F0) might also need dynamic finding</span></span><br><span class="line">                    <span class="keyword">let</span> target_func_offset_pthread = <span class="number">0x3E9F0</span>; </span><br><span class="line">                    <span class="keyword">let</span> target_func_addr = base_addr.<span class="title function_">add</span>(target_func_offset_pthread);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Check if the thread being created is the one we want to intercept</span></span><br><span class="line">                    <span class="keyword">if</span> (func_addr.<span class="title function_">equals</span>(target_func_addr)) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Anti-Debug] Replacing thread start_routine &quot;</span> + func_addr + <span class="string">&quot; with empty function.&quot;</span>);</span><br><span class="line">                        <span class="comment">// Replace the actual start routine pointer with our empty function&#x27;s pointer</span></span><br><span class="line">                        args[<span class="number">2</span>] = empty_func; </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Failed to attach to pthread_create: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] pthread_create not found in libc.so. Hook skipped.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">TARGET_MODULE_NAME</span> = <span class="string">&quot;libbaiduprotect.so&quot;</span>; <span class="comment">// Same as module_name for clarity with Stalker</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_diff_regs</span>(<span class="params">context, pre_regs</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> diff_regs = &#123;&#125;;</span><br><span class="line">    <span class="comment">// Create a snapshot of the current context&#x27;s general-purpose registers</span></span><br><span class="line">    <span class="keyword">const</span> current_regs_snapshot = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(context)); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Iterate through the original register names from the snapshot</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> reg_name_orig <span class="keyword">in</span> current_regs_snapshot) &#123;</span><br><span class="line">        <span class="comment">// Ensure it&#x27;s a direct property, not inherited</span></span><br><span class="line">        <span class="keyword">if</span> (current_regs_snapshot.<span class="title function_">hasOwnProperty</span>(reg_name_orig)) &#123;</span><br><span class="line">            <span class="keyword">const</span> reg_name_lower = reg_name_orig.<span class="title function_">toLowerCase</span>();</span><br><span class="line">            <span class="comment">// Filter out PC, SP, and floating-point/vector registers (q* or v*)</span></span><br><span class="line">            <span class="keyword">if</span> (reg_name_lower !== <span class="string">&quot;pc&quot;</span> &amp;&amp; reg_name_lower !== <span class="string">&quot;sp&quot;</span> &amp;&amp; !reg_name_lower.<span class="title function_">startsWith</span>(<span class="string">&quot;q&quot;</span>) &amp;&amp; !reg_name_lower.<span class="title function_">startsWith</span>(<span class="string">&quot;v&quot;</span>)) &#123; </span><br><span class="line">                <span class="comment">// Compare with the previous snapshot</span></span><br><span class="line">                <span class="keyword">if</span> (pre_regs[reg_name_orig] !== current_regs_snapshot[reg_name_orig]) &#123;</span><br><span class="line">                    <span class="comment">// If the value has changed, update the previous snapshot and record the difference</span></span><br><span class="line">                    pre_regs[reg_name_orig] = current_regs_snapshot[reg_name_orig];</span><br><span class="line">                    diff_regs[reg_name_orig] = current_regs_snapshot[reg_name_orig]; <span class="comment">// Store the NEW value</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> diff_regs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This function is defined but not currently used in the logging. Keeping it as it was in the original code.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_involved_regs</span>(<span class="params">instruction</span>) &#123; </span><br><span class="line">    <span class="keyword">const</span> involved_regs = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">    instruction.<span class="property">operands</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">op</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (op.<span class="property">type</span> === <span class="string">&#x27;reg&#x27;</span>) &#123; involved_regs.<span class="title function_">add</span>(op.<span class="property">value</span>); &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (op.<span class="property">type</span> === <span class="string">&#x27;mem&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (op.<span class="property">value</span>.<span class="property">base</span>) &#123; involved_regs.<span class="title function_">add</span>(op.<span class="property">value</span>.<span class="property">base</span>); &#125;</span><br><span class="line">            <span class="keyword">if</span> (op.<span class="property">value</span>.<span class="property">index</span>) &#123; involved_regs.<span class="title function_">add</span>(op.<span class="property">value</span>.<span class="property">index</span>); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(involved_regs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =======================================================================================</span></span><br><span class="line"><span class="comment">// Modified StalkerTrace Function (FIXED local_pre_regs access)</span></span><br><span class="line"><span class="comment">// =======================================================================================</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">StalkerTrace</span>(<span class="params">current_module_baseaddr</span>) &#123; <span class="comment">// Ensure the correct module base address is passed</span></span><br><span class="line">    <span class="comment">// Use the global module_size which should be set by now</span></span><br><span class="line">    <span class="keyword">if</span> (!current_module_baseaddr || current_module_baseaddr.<span class="title function_">isNull</span>() || module_size === <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] StalkerTrace: Invalid module base address or size. Cannot proceed.&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> stalker_target_func_offset = <span class="number">0x4a458</span>; <span class="comment">// The offset of the function you want Stalker to trace</span></span><br><span class="line">    <span class="keyword">var</span> stalker_start_addr = current_module_baseaddr.<span class="title function_">add</span>(stalker_target_func_offset);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] StalkerTrace will target &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; at actual address: &quot;</span> + stalker_start_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define the module bounds for Stalker logging</span></span><br><span class="line">    <span class="keyword">const</span> module_start = current_module_baseaddr;</span><br><span class="line">    <span class="keyword">const</span> module_end = current_module_baseaddr.<span class="title function_">add</span>(module_size);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Stalker module bounds: Start=&quot;</span> + module_start + <span class="string">&quot;, End=&quot;</span> + module_end);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(stalker_start_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="comment">// Stalker operates per thread. Get the current thread ID.</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">tid</span> = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Stalker: Entered &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; (TID: &quot;</span> + <span class="variable language_">this</span>.<span class="property">tid</span> + <span class="string">&quot;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize previous register state *for this specific thread*.</span></span><br><span class="line">            <span class="comment">// This variable is local to this onEnter call but will be captured by the closure.</span></span><br><span class="line">            <span class="keyword">const</span> local_pre_regs = &#123;&#125;; </span><br><span class="line">            <span class="comment">// Populate initial state, excluding filtered registers</span></span><br><span class="line">            <span class="keyword">const</span> initial_context_snapshot = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">context</span>));</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> reg_name_orig <span class="keyword">in</span> initial_context_snapshot) &#123;</span><br><span class="line">                <span class="keyword">if</span> (initial_context_snapshot.<span class="title function_">hasOwnProperty</span>(reg_name_orig)) &#123;</span><br><span class="line">                    <span class="keyword">const</span> reg_name_lower = reg_name_orig.<span class="title function_">toLowerCase</span>();</span><br><span class="line">                     <span class="keyword">if</span> (reg_name_lower !== <span class="string">&quot;pc&quot;</span> &amp;&amp; reg_name_lower !== <span class="string">&quot;sp&quot;</span> &amp;&amp; !reg_name_lower.<span class="title function_">startsWith</span>(<span class="string">&quot;q&quot;</span>) &amp;&amp; !reg_name_lower.<span class="title function_">startsWith</span>(<span class="string">&quot;v&quot;</span>)) &#123;</span><br><span class="line">                        local_pre_regs[reg_name_orig] = initial_context_snapshot[reg_name_orig];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// *** REMOVE THIS LINE *** this.local_pre_regs = local_pre_regs; </span></span><br><span class="line">            <span class="comment">// The variable &#x27;local_pre_regs&#x27; is already in scope for the transform/callout closures.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// === Patch known crashing instructions on entering the traced function ===</span></span><br><span class="line">            <span class="comment">// These addresses are relative to the module base address (current_module_baseaddr)</span></span><br><span class="line">            <span class="keyword">const</span> knownCrashOffsets = [<span class="number">0x48AC0</span>, <span class="number">0x4ABB8</span>]; <span class="comment">// List of known problematic instruction offsets</span></span><br><span class="line">            knownCrashOffsets.<span class="title function_">forEach</span>(<span class="function"><span class="params">offset</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> patchAddr = current_module_baseaddr.<span class="title function_">add</span>(offset);</span><br><span class="line">                    <span class="comment">// Read instruction bytes to verify it&#x27;s the expected &#x27;MOV WSP, #1&#x27;</span></span><br><span class="line">                    <span class="comment">// ARM64: MOV WSP, #1 is 320003FF (little endian)</span></span><br><span class="line">                    <span class="keyword">const</span> expectedBytes = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0x32</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>]);</span><br><span class="line">                    <span class="keyword">const</span> instrBytes = patchAddr.<span class="title function_">readByteArray</span>(<span class="number">4</span>);</span><br><span class="line">                    <span class="keyword">const</span> actualBytes = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(instrBytes);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">let</span> matchesExpected = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (actualBytes.<span class="property">length</span> === <span class="number">4</span>) &#123;</span><br><span class="line">                         <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">4</span>; i++) &#123;</span><br><span class="line">                              <span class="keyword">if</span> (actualBytes[i] !== expectedBytes[i]) &#123;</span><br><span class="line">                                   matchesExpected = <span class="literal">false</span>;</span><br><span class="line">                                   <span class="keyword">break</span>;</span><br><span class="line">                              &#125;</span><br><span class="line">                         &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         matchesExpected = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (matchesExpected) &#123;</span><br><span class="line">                         <span class="comment">// If it matches, NOP it</span></span><br><span class="line">                         <span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(patchAddr, <span class="number">4</span>, <span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">                             <span class="keyword">const</span> writer = <span class="keyword">new</span> <span class="title class_">Arm64Writer</span>(code, &#123; <span class="attr">pc</span>: patchAddr &#125;);</span><br><span class="line">                             writer.<span class="title function_">putNop</span>(); <span class="comment">// Replace the instruction with NOP</span></span><br><span class="line">                             writer.<span class="title function_">flush</span>();</span><br><span class="line">                         &#125;);</span><br><span class="line">                         <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[MemoryPatch] Stalker&#x27;s onEnter: NOPped known crash (MOV WSP, #1) at &quot;</span> + module_name + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(offset) + <span class="string">&quot; (&quot;</span>+ patchAddr + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         <span class="comment">// console.log(&quot;[MemoryPatch] Stalker&#x27;s onEnter: Instruction at &quot; + module_name + &quot;!&quot; + ptr(offset) + &quot; is not MOV WSP, #1. Bytes: &quot; + Array.from(actualBytes).map(b =&gt; b.toString(16).padStart(2,&#x27;0&#x27;)).join(&#x27;&#x27;)); // Optional log</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[MemoryPatch] Stalker&#x27;s onEnter: Error patching &quot;</span> + module_name + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(offset) + <span class="string">&quot;: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// ==================================================================</span></span><br><span class="line"></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">follow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>, &#123;</span><br><span class="line">                 <span class="comment">// Configure events to trace. exec=true traces every executed instruction.</span></span><br><span class="line">                <span class="attr">events</span>: &#123; <span class="attr">call</span>: <span class="literal">false</span>, <span class="attr">ret</span>: <span class="literal">false</span>, <span class="attr">exec</span>: <span class="literal">true</span>, <span class="attr">block</span>: <span class="literal">false</span>, <span class="attr">compile</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">                 <span class="comment">// The transform callback allows inspecting/rewriting instruction blocks</span></span><br><span class="line">                <span class="title function_">transform</span>(<span class="params">iterator</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> instruction = iterator.<span class="title function_">next</span>();</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="keyword">const</span> currentAddress = instruction.<span class="property">address</span>;</span><br><span class="line">                        <span class="keyword">let</span> patchedThisInstruction = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Check if the instruction is within the target module&#x27;s bounds</span></span><br><span class="line">                        <span class="keyword">const</span> is_module_code = currentAddress.<span class="title function_">compare</span>(module_start) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                               currentAddress.<span class="title function_">compare</span>(module_end) &lt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                         <span class="comment">// === Universal MOV WSP/SP, #1 detection and NOP logic ===</span></span><br><span class="line">                         <span class="comment">// This is a fallback/alternative to the onEnter patch</span></span><br><span class="line">                         <span class="comment">// It happens per block compiled by Stalker</span></span><br><span class="line">                        <span class="keyword">if</span> (is_module_code) &#123; <span class="comment">// Only patch instructions within the target module</span></span><br><span class="line">                            <span class="keyword">const</span> mnemonic = instruction.<span class="property">mnemonic</span>.<span class="title function_">toLowerCase</span>();</span><br><span class="line">                             <span class="comment">// Check for MOV or MOVZ with SP/WSP as destination and immediate 1</span></span><br><span class="line">                             <span class="keyword">if</span> ((mnemonic === <span class="string">&#x27;mov&#x27;</span> || mnemonic === <span class="string">&#x27;movz&#x27;</span>) &amp;&amp; instruction.<span class="property">operands</span>.<span class="property">length</span> &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                                 <span class="keyword">const</span> destOperand = instruction.<span class="property">operands</span>[<span class="number">0</span>];</span><br><span class="line">                                 <span class="keyword">const</span> srcOperand = instruction.<span class="property">operands</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                                 <span class="keyword">if</span> (destOperand.<span class="property">type</span> === <span class="string">&#x27;reg&#x27;</span> &amp;&amp;</span><br><span class="line">                                     (destOperand.<span class="property">value</span> === <span class="string">&#x27;wsp&#x27;</span> || destOperand.<span class="property">value</span> === <span class="string">&#x27;sp&#x27;</span> ||</span><br><span class="line">                                      destOperand.<span class="property">value</span> === <span class="string">&#x27;w31&#x27;</span> || destOperand.<span class="property">value</span> === <span class="string">&#x27;x31&#x27;</span>) &amp;&amp; <span class="comment">// w31/x31 are aliases for wsp/sp</span></span><br><span class="line">                                     srcOperand.<span class="property">type</span> === <span class="string">&#x27;imm&#x27;</span> &amp;&amp;</span><br><span class="line">                                     <span class="built_in">parseInt</span>(srcOperand.<span class="property">value</span>.<span class="title function_">toString</span>()) === <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">                                     <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[StalkerTransform] Identified potential crash instruction &#x27;&quot;</span> + instruction.<span class="title function_">toString</span>() + <span class="string">&quot;&#x27; at &quot;</span> + currentAddress + <span class="string">&quot;. Replacing with NOP.&quot;</span>);</span><br><span class="line">                                     iterator.<span class="title function_">putNop</span>(); <span class="comment">// Replace the instruction with NOP</span></span><br><span class="line">                                     patchedThisInstruction = <span class="literal">true</span>;</span><br><span class="line">                                 &#125;</span><br><span class="line">                             &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// =========================================================</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">// If the instruction wasn&#x27;t NOPped by the above check, add a callout for logging</span></span><br><span class="line">                        <span class="keyword">if</span> (!patchedThisInstruction) &#123;</span><br><span class="line">                            <span class="comment">// Only add callout for instructions within the target module</span></span><br><span class="line">                            <span class="keyword">if</span> (is_module_code) &#123;</span><br><span class="line">                                <span class="comment">// &#x27;local_pre_regs&#x27; is accessible here via closure</span></span><br><span class="line">                                iterator.<span class="title function_">putCallout</span>(<span class="keyword">function</span> (<span class="params">context</span>) &#123;</span><br><span class="line">                                    <span class="comment">// Access local_pre_regs directly from the outer scope (captured by closure)</span></span><br><span class="line">                                    <span class="keyword">const</span> thread_pre_regs = local_pre_regs; </span><br><span class="line">                                    <span class="keyword">const</span> pc = context.<span class="property">pc</span>;</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// Get the register differences after this instruction executes</span></span><br><span class="line">                                    <span class="comment">// get_diff_regs modifies thread_pre_regs in place</span></span><br><span class="line">                                    <span class="keyword">const</span> diff_regs = <span class="title function_">get_diff_regs</span>(context, thread_pre_regs);</span><br><span class="line">                                    </span><br><span class="line">                                    <span class="comment">// Find the module info again (can be optimized by caching, but this is reliable)</span></span><br><span class="line">                                    <span class="keyword">var</span> current_callout_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(pc);</span><br><span class="line"></span><br><span class="line">                                     <span class="comment">// Ensure we are logging code from the target module</span></span><br><span class="line">                                     <span class="keyword">if</span> (current_callout_module &amp;&amp; current_callout_module.<span class="property">name</span> === <span class="variable constant_">TARGET_MODULE_NAME</span>) &#123;</span><br><span class="line">                                         <span class="keyword">const</span> instrToLog = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(pc);</span><br><span class="line">                                         <span class="keyword">let</span> logLine = <span class="string">`<span class="subst">$&#123;current_callout_module.name&#125;</span>!<span class="subst">$&#123;pc.sub(current_callout_module.base)&#125;</span> <span class="subst">$&#123;instrToLog.toString()&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">                                         <span class="comment">// Append changed registers and potential strings</span></span><br><span class="line">                                         <span class="keyword">const</span> diffRegKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(diff_regs);</span><br><span class="line">                                         <span class="keyword">if</span> (diffRegKeys.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                              logLine += <span class="string">`\t\t| Changed Regs: `</span>;</span><br><span class="line">                                              <span class="keyword">let</span> firstReg = <span class="literal">true</span>;</span><br><span class="line">                                              <span class="keyword">for</span> (<span class="keyword">const</span> regName <span class="keyword">of</span> diffRegKeys) &#123;</span><br><span class="line">                                                   <span class="keyword">if</span> (!firstReg) logLine += <span class="string">&quot;, &quot;</span>;</span><br><span class="line">                                                   firstReg = <span class="literal">false</span>;</span><br><span class="line">                                                   <span class="keyword">const</span> regValue = diff_regs[regName]; <span class="comment">// The new value of the register</span></span><br><span class="line">                                                   logLine += <span class="string">`<span class="subst">$&#123;regName&#125;</span>=<span class="subst">$&#123;regValue&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">                                                   <span class="comment">// --- Check if the register value points to a string ---</span></span><br><span class="line">                                                   <span class="keyword">const</span> potentialString = <span class="title function_">tryReadString</span>(regValue);</span><br><span class="line">                                                   <span class="keyword">if</span> (potentialString !== <span class="literal">null</span>) &#123;</span><br><span class="line">                                                       <span class="comment">// Truncate long strings for readability</span></span><br><span class="line">                                                       <span class="keyword">const</span> displayString = potentialString.<span class="property">length</span> &gt; <span class="number">60</span> ? potentialString.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">57</span>) + <span class="string">&quot;...&quot;</span> : potentialString;</span><br><span class="line">                                                       <span class="comment">// Escape potential quotes in the string for cleaner output</span></span><br><span class="line">                                                       <span class="keyword">const</span> escapedString = displayString.<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;\\&quot;&#x27;</span>).<span class="title function_">replace</span>(<span class="regexp">/\n/g</span>, <span class="string">&#x27;\\n&#x27;</span>).<span class="title function_">replace</span>(<span class="regexp">/\r/g</span>, <span class="string">&#x27;\\r&#x27;</span>);</span><br><span class="line">                                                        logLine += <span class="string">` (&quot;<span class="subst">$&#123;escapedString&#125;</span>&quot;)`</span>;</span><br><span class="line">                                                   &#125;</span><br><span class="line">                                                   <span class="comment">// ----------------------------------------------------------</span></span><br><span class="line">                                              &#125;</span><br><span class="line">                                         &#125;</span><br><span class="line"></span><br><span class="line">                                         <span class="variable language_">console</span>.<span class="title function_">log</span>(logLine);</span><br><span class="line">                                     &#125;</span><br><span class="line">                                &#125;);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// Keep the original instruction</span></span><br><span class="line">                            iterator.<span class="title function_">keep</span>();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((instruction = iterator.<span class="title function_">next</span>()) !== <span class="literal">null</span>); <span class="comment">// Process next instruction in the block</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; onLeave, TID:&quot;</span>, <span class="variable language_">this</span>.<span class="property">tid</span>);</span><br><span class="line">             <span class="comment">// Stop stalking this thread when the function exits</span></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">unfollow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>);</span><br><span class="line">             <span class="comment">// Clean up Stalker&#x27;s compiled code cache</span></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">garbageCollect</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start the script execution by hooking the linker</span></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Script starting for &quot;</span> + module_name + <span class="string">&quot;...&quot;</span>);</span><br><span class="line">    <span class="title function_">hook_linker_call_constructors</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Script loaded. Waiting for &quot;</span> + module_name + <span class="string">&quot; to be loaded...&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>接下来又遇到一个问题，在trace到sub_5AE5C内部的时候，会在随机某处地址断开trace。由于是随机断开的，没搞清楚到底是为什么？头疼。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516124234164.png" alt="image-20250516124234164" style="zoom:67%;" />

<p>先通过下面这个脚本，hook上了sub_5AE5C，跑起来没问题。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> offset = <span class="number">0x88060</span>;</span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> base_addr = <span class="literal">null</span>; <span class="comment">// To store the base address of libbaiduprotect.so</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an empty function</span></span><br><span class="line"><span class="keyword">var</span> empty_func = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                base_addr = secmodule.<span class="property">base</span>; <span class="comment">// Save the base address</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libbaiduprotect.so base: &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> target_addr = baseaddr.<span class="title function_">add</span>(offset);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Target function at &quot;</span> + target_addr + <span class="string">&quot; entered&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libbaiduprotect.so base address: &quot;</span> + baseaddr);</span><br><span class="line">            <span class="title function_">hook_pthread_create</span>();</span><br><span class="line">            <span class="title function_">hook_sub_5ae5c</span>(baseaddr); <span class="comment">// Hook sub_5AE5C after target function</span></span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthread_create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> pthread_create_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> func_addr = args[<span class="number">2</span>];</span><br><span class="line">            <span class="keyword">let</span> target_func_addr = base_addr.<span class="title function_">add</span>(<span class="number">0x3E9F0</span>); <span class="comment">// Calculate the target function address</span></span><br><span class="line">            <span class="keyword">if</span> (func_addr.<span class="title function_">equals</span>(target_func_addr)) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Replacing func_addr &quot;</span> + func_addr + <span class="string">&quot; with empty function&quot;</span>);</span><br><span class="line">                args[<span class="number">2</span>] = empty_func; <span class="comment">// Replace with the empty function</span></span><br><span class="line">                <span class="comment">// hook_libart(); // Commented out as it was not provided</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(func_addr);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">module</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span> === module_name) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create called in libbaiduprotect.so, function address: &quot;</span> + func_addr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="comment">// Optionally log return value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_5ae5c</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!baseaddr || baseaddr.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] hook_sub_5ae5c: Invalid base address. Cannot proceed.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> target_addr = baseaddr.<span class="title function_">add</span>(<span class="number">0x5AE5C</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking sub_5AE5C at &quot;</span> + target_addr);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[sub_5AE5C] onEnter&quot;</span>);</span><br><span class="line">            <span class="comment">// Dump args[0] (pointer to _QWORD)</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!args[<span class="number">0</span>].<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[0] (*_QWORD at &quot;</span> + args[<span class="number">0</span>] + <span class="string">&quot;):&quot;</span>);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">0</span>], &#123; <span class="attr">length</span>: <span class="number">64</span>, <span class="attr">ansi</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;args[0] is null&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;Failed to hexdump args[0]: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Dump args[2] (data + 8)</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!args[<span class="number">2</span>].<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[2] (data + 8 at &quot;</span> + args[<span class="number">2</span>] + <span class="string">&quot;):&quot;</span>);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">2</span>], &#123; <span class="attr">length</span>: <span class="number">64</span>, <span class="attr">ansi</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;args[2] is null&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;Failed to hexdump args[2]: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Store pointers for comparison in onLeave</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[sub_5AE5C] onLeave, Return value: &quot;</span> + retval);</span><br><span class="line">            <span class="comment">// Dump args[0] again to check for changes</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">arg0</span>.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[0] (*_QWORD at &quot;</span> + <span class="variable language_">this</span>.<span class="property">arg0</span> + <span class="string">&quot;) after execution:&quot;</span>);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>, &#123; <span class="attr">length</span>: <span class="number">64</span>, <span class="attr">ansi</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;args[0] is null in onLeave&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;Failed to hexdump args[0] in onLeave: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Dump args[2] again to check for changes</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">arg2</span>.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[2] (data + 8 at &quot;</span> + <span class="variable language_">this</span>.<span class="property">arg2</span> + <span class="string">&quot;) after execution:&quot;</span>);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg2</span>, &#123; <span class="attr">length</span>: <span class="number">64</span>, <span class="attr">ansi</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;args[2] is null in onLeave&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;Failed to hexdump args[2] in onLeave: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Script starting for &quot;</span> + module_name + <span class="string">&quot;...&quot;</span>);</span><br><span class="line">    <span class="title function_">hook_linker_call_constructors</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Script loaded. Waiting for &quot;</span> + module_name + <span class="string">&quot; to be loaded...&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>可以看到，after execution的args[2]中，存放的内容是一大片地址，将这些地址减去libbaiduprotect.so的基地址，可以发现这些地址都是vmp__funcs_256这个表上的地址。也就是说，经过函数sub_5ae5c，会从第一个参数中，获得到实现JNI函数所需要的的vmp指令集合列表。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516152914009.png" alt="image-20250516152914009"></p>
<p>既然trace不了函数5ae5c，那就从sub_5ae5c的汇编代码分析吧。</p>
<p>基本块1。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516164415682.png" alt="image-20250516164415682"></p>
<p>基本块2。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516164434265.png" alt="image-20250516164434265"></p>
<p>基本块3。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516164454468.png" alt="image-20250516164454468"></p>
<p>基本块4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516164512194.png" alt="image-20250516164512194"></p>
<p>基本块5。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516164532311.png" alt="image-20250516164532311"></p>
<p>基本块6。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516191356570.png" alt="image-20250516191356570"></p>
<p>基本块7。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516172701443.png" alt="image-20250516172701443" style="zoom:80%;" />

<p>基本块7的下一个块又是基本块4，也就是说，将上述流程写成伪代码的话，如下所示。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> index = <span class="number">0</span>; index &lt; <span class="number">256</span>; index++)&#123;</span><br><span class="line">	a2 + (*(((byte*)a0) + <span class="number">64</span> + index*<span class="number">4</span>)) * <span class="number">8</span> = *(a1 + index*<span class="number">8</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和ida做一个对比，会发现ida的伪代码看不懂。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516192214983.png" alt="image-20250516192214983"></p>
<p>通过这个伪代码，我们可以得知，a0是一个已知的数据源，它的64字节大小的offset偏移处，存放着解密后的vmp_code映射表，比方说，读取一个 a0 + 64 + index*4，命名为v1，然后将vmp_funcs_list的从0到255，把每一个元素，依次赋给 v1*8 + a2 的内存地址上，注意，这里的v1并不是逐增的。</p>
<p>↑我把我的表述扔给gemini，哈哈哈，得到认可了，看来没分析错。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516193401944.png" alt="image-20250516193401944"></p>
<p>我将函数sub_5ae5c命名为：from_DecodeVmpCode_map_to_SimulateSmaliCode。</p>
<p>分析完它之后，不妨再分析sub_4A458，我想分析vmp_explain传入的参数的含义是什么。</p>
<p>IDA的伪代码问题太大了，传入2个v19很明显没意义。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516221417532.png" alt="image-20250516221417532" style="zoom:80%;" />

<p>基本块1。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516221732841.png" alt="image-20250516221732841"></p>
<p>基本块2。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517102406624.png" alt="image-20250517102406624"></p>
<p>基本块3，调用了sub_5cb98([[qword_BED18地址 + (vmp_method_code &amp; 0xFF0000)&gt;&gt;16]], vmp_method_code &amp; 0xFFFF)</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517114642368.png" alt="image-20250517114642368"></p>
<p>基本块4，sub_5cb98的操作如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517114339893.png" alt="image-20250517114339893"></p>
<p>基本块5。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517120326446.png" alt="image-20250517120326446" style="zoom:80%;" />

<p>基本块6。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517124953190.png" alt="image-20250517124953190" style="zoom:80%;" />

<p>基本块7。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517125335092.png" alt="image-20250517125335092" style="zoom:67%;" />

<p>基本块8。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517130438972.png" alt="image-20250517130438972"></p>
<p>基本块9，sub_45EBC比较复杂，暂时先不分析，待会hook一下这个函数，可以不费吹灰之力获得——</p>
<ol>
<li><p>[[[qword_BED18地址 + (vmp_method_code &amp; 0xFF0000)&gt;&gt;16] + 0x38] + (vmp_method_code &amp; 0xFFFF)*8]</p>
</li>
<li><p>[原SP-0x40]</p>
</li>
<li><p>bundle数组的内容</p>
</li>
<li><p>malloc1的内容</p>
</li>
<li><p>malloc2的内容</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517132004904.png" alt="image-20250517132004904"></p>
<p>基本块10。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517132244136.png" alt="image-20250517132244136" style="zoom:80%;" />

<p>基本块11。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517152311463.png" alt="image-20250517152311463"></p>
<p>后面还要分析好多函数，暂时先分析到这。——2025&#x2F;05&#x2F;17。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-257926.htm#msg_header_h1_3">https://bbs.kanxue.com/thread-257926.htm#msg_header_h1_3</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-257926.htm#msg_header_h1_2">https://bbs.kanxue.com/thread-257926.htm#msg_header_h1_2</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">X14Nuy</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">194k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">5:53</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
