<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/default-index/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="X14Nuy">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/default-index/page/3/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"default-index/page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">X14Nuy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/r2pay-v0-9%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/r2pay-v0-9%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">r2pay-v0.9分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:17:28 / 修改时间：17:30:49" itemprop="dateCreated datePublished" datetime="2025-05-18T17:17:28+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>18k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>32 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="r2pay-v0-9-apk"><a href="#r2pay-v0-9-apk" class="headerlink" title="r2pay-v0.9.apk"></a>r2pay-v0.9.apk</h1><p>安装完后，一打开就闪退。</p>
<p>通过adb logcat查看日志，筛选中下面的日志记录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">02-28 10:34:38.788 11795 11795 I Magisk  : zygisk64: [re.pwnme] is on the denylist</span><br><span class="line">02-28 10:34:38.823 11795 11795 I re.pwnme: Late-enabling -Xcheck:jni</span><br><span class="line">02-28 10:34:38.845  1187  1204 I adbd    : jdwp connection from 11795</span><br><span class="line">02-28 10:34:38.867 11795 11795 D ProcessState: Binder ioctl to enable oneway spam detection failed: Invalid argument</span><br><span class="line">02-28 10:34:38.785     0     0 I binder  : 11795:11795 ioctl 40046210 7fe5e224b4 returned -22</span><br><span class="line">02-28 10:34:38.881 11795 11795 D CompatibilityChangeReporter: Compat change id reported: 171979766; UID 10137; state: DISABLED</span><br><span class="line">02-28 10:34:38.887 11795 11795 D ApplicationLoaders: Returning zygote-cached class loader: /system/framework/android.test.base.jar</span><br><span class="line">02-28 10:34:38.909 11795 11795 V GraphicsEnvironment: ANGLE Developer option for &#x27;re.pwnme&#x27; set to: &#x27;default&#x27;</span><br><span class="line">02-28 10:34:38.909 11795 11795 V GraphicsEnvironment: ANGLE GameManagerService for re.pwnme: false</span><br><span class="line">02-28 10:34:38.909 11795 11795 V GraphicsEnvironment: Neither updatable production driver nor prerelease driver is supported.</span><br><span class="line">02-28 10:34:38.911 11795 11795 D NetworkSecurityConfig: No Network Security Config specified, using platform default</span><br><span class="line">02-28 10:34:38.912 11795 11795 D NetworkSecurityConfig: No Network Security Config specified, using platform default</span><br><span class="line">02-28 10:34:39.391  2400  3117 W FrameTracker: Missing HWUI jank callback for vsyncId: 84855</span><br><span class="line">02-28 10:34:39.612 11795 11795 W re.pwnme: type=1400 audit(0.0:371): avc: denied &#123; read &#125; for name=&quot;cache&quot; dev=&quot;sda14&quot; ino=16 scontext=u:r:untrusted_app_29:s0:c137,c256,c512,c768 tcontext=u:object_r:cache_file:s0 tclass=lnk_file permissive=0 app=re.pwnme</span><br><span class="line">02-28 10:34:39.612 11795 11795 W re.pwnme: type=1400 audit(0.0:372): avc: denied &#123; read &#125; for name=&quot;cache&quot; dev=&quot;sda14&quot; ino=16 scontext=u:r:untrusted_app_29:s0:c137,c256,c512,c768 tcontext=u:object_r:cache_file:s0 tclass=lnk_file permissive=0 app=re.pwnme</span><br><span class="line">02-28 10:34:39.612 11795 11795 W re.pwnme: type=1400 audit(0.0:373): avc: denied &#123; read &#125; for name=&quot;cache&quot; dev=&quot;sda14&quot; ino=16 scontext=u:r:untrusted_app_29:s0:c137,c256,c512,c768 tcontext=u:object_r:cache_file:s0 tclass=lnk_file permissive=0 app=re.pwnme</span><br><span class="line">02-28 10:34:39.678 11795 11795 W re.pwnme: Accessing hidden method Landroid/view/View;-&gt;computeFitSystemWindows(Landroid/graphics/Rect;Landroid/graphics/Rect;)Z (unsupported, reflection, allowed)</span><br><span class="line">02-28 10:34:39.678 11795 11795 W re.pwnme: Accessing hidden method Landroid/view/ViewGroup;-&gt;makeOptionalFitsSystemWindows()V (unsupported, reflection, allowed)</span><br><span class="line">02-28 10:34:39.725 11795 11795 E RootBeer: b: a() [249] - com.topjohnwu.magisk ROOT management app detected!</span><br><span class="line">02-28 10:34:39.725 11795 11795 E QLog    : b: a() [249] - com.topjohnwu.magisk ROOT management app detected!</span><br><span class="line">02-28 10:34:39.726 11795 11795 D AndroidRuntime: Shutting down VM</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime: FATAL EXCEPTION: main</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime: Process: re.pwnme, PID: 11795</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime: java.lang.RuntimeException: Unable to start activity ComponentInfo&#123;re.pwnme/re.pwnme.MainActivity&#125;: java.lang.ArithmeticException: divide by zero</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:3707)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:3864)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:103)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:135)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:95)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.ActivityThread$H.handleMessage(ActivityThread.java:2253)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.os.Looper.loopOnce(Looper.java:201)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.os.Looper.loop(Looper.java:288)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.ActivityThread.main(ActivityThread.java:7870)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:548)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:1003)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime: Caused by: java.lang.ArithmeticException: divide by zero</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at re.pwnme.MainActivity.onCreate(SourceFile:38)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.Activity.performCreate(Activity.java:8057)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.Activity.performCreate(Activity.java:8037)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1341)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:3688)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        ... 12 more</span><br><span class="line">02-28 10:34:39.730  1045 11817 I DropBoxManagerService: add tag=data_app_crash isTagEnabled=true flags=0x2</span><br><span class="line">02-28 10:34:39.730  1045  5059 W ActivityTaskManager:   Force finishing activity re.pwnme/.MainActivity</span><br><span class="line">02-28 10:34:39.737 11795 11795 I Process : Sending signal. PID: 11795 SIG: 9</span><br></pre></td></tr></table></figure>

<p>我把日志丢给grok进行分析，似乎是调用了RootBeer库进行root检测，发现了magisk，因此退出了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250228132546057.png" alt="image-20250228132546057" style="zoom:80%;" />

<p>尝试搜索字符串 ROOT management app detected，这里的try catch就是用来检测root的，如果读包错误，就说明这个包不存在，不做任何处理；如果读到“危险”包，就会继续执行b.a.a.c.a.a，并将result置为true。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250228134713528.png" alt="image-20250228134713528" style="zoom:67%;" />

<p>追踪b.a.a.c.a.a进去看一下，发现就写了一个Log.e。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250228140326772.png" alt="image-20250228140326772"></p>
<p>查看方法b.a.a.b.a(List )的调用。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250228140623670.png" alt="image-20250228140623670" style="zoom: 80%;" />

<p>Index为0的方法b.a.a.b.a(String[] )如下，属于重载，可以看到，这里只是将字符串加入到packages里，并调用b.a.a.b.a(List )。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250228140601697.png" alt="image-20250228140601697"></p>
<p>而Index为1的方法b.a.a.b.b(String[] )如下，它调用了b.a.a.b.a(String[] )。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250228141911196.png" alt="image-20250228141911196"></p>
<p>之后又一直查看引用，找到b.a.a.j()，这里做了一堆检查root的内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250228142312579.png" alt="image-20250228142312579" style="zoom:80%;" />

<p>不如直接将函数j给hook了，也省得hook其它这么多函数，我观察了一下众多this.X，发现其中的this.e不仅仅在j()被调用，还在其它地方被调用。</p>
<p>总结了一下，需要hook的函数如下：</p>
<p>b.a.a.a()&#x2F;b.a.a.j()&#x2F;b.a.a.e()。</p>
<p>首先hook方法a，一般来说，可以根据参数列表不同hook特定的、存在同名的方法，但这里要hook的方法a属于无参方法，而且存在两个无参方法a。</p>
<p>下面是我找ds-r1生成的，不知道行不行得通，看得挺靠谱的，根据返回值类型来判断。（事后发现下面的脚本用不了，别学，这里作为错误示范）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> targetClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;b.a.a.b&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> methods = targetClass.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line">    </span><br><span class="line">    methods.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">method</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.<span class="title function_">getName</span>() === <span class="string">&quot;a&quot;</span> &amp;&amp; method.<span class="title function_">getParameterTypes</span>().<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> returnType = method.<span class="title function_">getReturnType</span>().<span class="title function_">getName</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Hook返回boolean的a方法</span></span><br><span class="line">            <span class="keyword">if</span> (returnType === <span class="string">&quot;boolean&quot;</span>) &#123;</span><br><span class="line">                method.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked boolean a() method&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Hook返回String数组的a方法</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (returnType === <span class="string">&quot;[Ljava.lang.String;&quot;</span>) &#123;</span><br><span class="line">                method.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked String[] a() method&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>不过既然要hook的方法都在b.a.a类中，不妨直接将hook的方法补充进上面这个脚本里，执行后，又闪退了，不过这回查看日志，并没看到之前的那几条记录了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">02-28 15:10:41.848  4531  4531 I crash_dump64: obtaining output fd from tombstoned, type: kDebuggerdTombstoneProto</span><br><span class="line">02-28 15:10:41.849   655   655 I tombstoned: received crash request for pid 4528</span><br><span class="line">02-28 15:10:41.850  4531  4531 I crash_dump64: performing dump of process 4498 (target tid = 4528)</span><br><span class="line">02-28 15:10:41.871  4531  4531 E DEBUG   : failed to read /proc/uptime: Permission denied</span><br><span class="line">02-28 15:10:42.485     0     0 I logd    : logdr: UID=10137 GID=10137 PID=4531 n tail=0 logMask=8 pid=4498 start=0ns deadline=0ns</span><br><span class="line">02-28 15:10:42.486     0     0 I logd    : logdr: UID=10137 GID=10137 PID=4531 n tail=0 logMask=1 pid=4498 start=0ns deadline=0ns</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : Build fingerprint: &#x27;OnePlus/OnePlus6/OnePlus6:8.1.0/OPM1.171019.011/06140300:user/release-keys&#x27;</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : Revision: &#x27;0&#x27;</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : ABI: &#x27;arm64&#x27;</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : Timestamp: 2025-02-28 15:10:41.870217324+0800</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : Process uptime: 0s</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : Cmdline: com.google.android.videos</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : pid: 4498, tid: 4528, name: re.pwnme  &gt;&gt;&gt; com.google.android.videos &lt;&lt;&lt;</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : uid: 10137</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0xfaba4975</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   :     x0  0000006fe4986670  x1  000000730a2a77cc  x2  00000071ceef6220  x3  0000006fe4986618</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   :     x4  00000000000010b0  x5  0000000000000001  x6  0000000000000000  x7  0000000000000000</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   :     x8  00000000000035b2  x9  00000000faba4975  x10 000000008ef93fe9  x11 000000006df6246c</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   :     x12 0000000000000001  x13 00000000fffffff6  x14 00000000cf86a786  x15 0000000000000001</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :     x16 000000730a2911f8  x17 000000730a20db40  x18 0000000000000000  x19 0000006fe4986670</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :     x20 0000000000000000  x21 0000006fe498acb0  x22 0000000000001192  x23 0000000000001192</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :     x24 0000006fe498acb0  x25 0000006fe498acb0  x26 0000006fe498aff8  x27 00000000000fc000</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :     x28 0000006fe4892000  x29 0000006fe498ac40</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :     lr  0000006fdffa2668  sp  0000006fe4986670  pc  0000006fdfe77f7c  pst 0000000060000000</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   : backtrace:</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :       #00 pc 0000000000038f7c  /data/app/~~IG0Dzbwr_V__IsLZxDqnLA==/re.pwnme-5cCb3aQP1IrcfKWzdCWgYQ==/lib/arm64/libnative-lib.so (BuildId: f87b3bd9fcae36e63939958f412d03a42e0ce406)</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :       #01 pc 00000000000b1810  /apex/com.android.runtime/lib64/bionic/libc.so!libc.so (__pthread_start(void*)+264) (BuildId: 6bfaf10f10e5ff343703efae2f1bdbdb)</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :       #02 pc 00000000000512f0  /apex/com.android.runtime/lib64/bionic/libc.so!libc.so (__start_thread+64) (BuildId: 6bfaf10f10e5ff343703efae2f1bdbdb)</span><br></pre></td></tr></table></figure>

<p>查看调用栈，锁定在libnative-lib.so，偏移量是38f7c，用ida打开后，访问那块地址，结果说函数太大，无法进行f5，没辙了，没啥思绪了，看看博客。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_61253776/article/details/140026070">https://blog.csdn.net/qq_61253776/article/details/140026070</a></p>
<p>看来我的第一步分析是正确的，将函数j a e进行了hook，避免了java层的检测，但so层好难。</p>
<p>接下来找博客一步一步做了。</p>
<p>So层的检测针对了root权限和frida注入，下面主要写分析过程。</p>
<p>在re.pwnme.MainActivity类中，静态初始化块加载了native-lib，</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304081920396.png" alt="image-20250304081920396" style="zoom: 80%;" />

<p>然后声明了其中的一个native函数并用于MainActivity的页面代码中。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304082019387.png" alt="image-20250304082019387" style="zoom:80%;" />

<p>通过ida观察libnative-lib.so的export表，导出函数和全局变量都被加密了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304082137127.png" alt="image-20250304082137127"></p>
<p>点开.datadiv_decodexxxxxx，大部分这类函数只写了一个RET，对应的字节码是C0 03 5F D6。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304082448246.png" alt="image-20250304082448246"></p>
<p>根据观察，其中的函数datadiv_decode4432700155380705947，它存在函数体，并且大部分操作似乎在做解密。大部分资料显示，这里是在做全局字符串的解密操作。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304082642593.png" alt="image-20250304082642593" style="zoom:80%;" />

<p>除此之外，在.init_array段中，存在两个拥有函数体的函数，它们无法f5，反编译成c。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304082900458.png" alt="image-20250304082900458"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304082937873.png" alt="image-20250304082937873" style="zoom:67%;" />

<p>过了java层后，会在so层的某处断开，地址是38f7c。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304083458534.png" alt="image-20250304083458534"></p>
<p>在ida中来到38f7c，一路跟踪交叉引用，最后判定，这段代码属于sub_83DC。</p>
<p>由于静态无法分析，只能动态分析了，博客中，这里使用了工具QBDI，QBDI是一个动态二进制插桩的DBI框架，可以追踪函数细节，如果只用frida的话，只能看到函数调用前的参数和调用后的结果。</p>
<p>但QBDI咋用啊，wtf，教程也太少了。</p>
<hr>
<p>时隔多天，在分析完豆瓣后，再次看看这个apk如何分析。</p>
<p>在分析豆瓣的过程中，学会了找退出点的一些方法。</p>
<p>比如：hook函数pthread_create，线程在跑起来后，如果是检测frida的线程，就会杀死frida，所以可以观察哪个线程跑起来后，导致frida退出了。因为libc.so是系统库，加载先于frida的spawn模式，无需担心过早hook。</p>
<p>对应的检测线程脚本如下，不是直接复制就能用，这里放在这仅供参考：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hook_linker_call_constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 打印模块信息</span></span><br><span class="line">            <span class="keyword">if</span> (libnative_module) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Module name: &quot;</span> + libnative_module.<span class="property">name</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Base address: 0x&quot;</span> + libnative_module.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Size: &quot;</span> + libnative_module.<span class="property">size</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Path: &quot;</span> + libnative_module.<span class="property">path</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="title function_">check_pthread_create</span>(libnative_module.<span class="property">base</span>);</span><br><span class="line">                <span class="comment">//hook_20954();</span></span><br><span class="line">                <span class="comment">//hook_7a660();</span></span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check_pthread_create</span>(<span class="params">baseaddr</span>)&#123;</span><br><span class="line">    <span class="comment">/* 找到函数pthread_create的地址 */</span></span><br><span class="line">    <span class="keyword">var</span> pthread_create = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pthread_create)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is exist&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is not exist&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* hook */</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is called&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg2: 0x&quot;</span> + (args[<span class="number">2</span>] - baseaddr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后应该就会看到几个函数的地址，然后尝试hook它们。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_20954</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(libnative_module.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x20954</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_20954 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_7a660</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(libnative_module.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x7a660</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_7a660 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再次跑frida脚本，发现提示除以0的报错，这个报错不是在之前的java层解决了吗？</p>
<p>下面<strong>这个脚本是错的</strong>，是我早期通过deepseek生成的，我还以为能用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_java</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> targetClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;b.a.a.b&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> methods = targetClass.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Methods found in b.a.a.b:&quot;</span>);</span><br><span class="line">        methods.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">method</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (method.<span class="title function_">getName</span>() === <span class="string">&quot;a&quot;</span> &amp;&amp; method.<span class="title function_">getParameterTypes</span>().<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> returnType = method.<span class="title function_">getReturnType</span>().<span class="title function_">getName</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Return type: &quot;</span> + <span class="keyword">typeof</span> returnType + <span class="string">&quot;, value: &quot;</span> + returnType);</span><br><span class="line">                <span class="keyword">if</span> (returnType === <span class="string">&quot;boolean&quot;</span>) &#123;</span><br><span class="line">                    method.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b.a.a.b.a() is called, res = &quot;</span>, <span class="variable language_">this</span>.<span class="title function_">a</span>());</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked boolean a() method&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (method.<span class="title function_">getName</span>() === <span class="string">&quot;j&quot;</span> &amp;&amp; method.<span class="title function_">getParameterTypes</span>().<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> returnType = method.<span class="title function_">getReturnType</span>().<span class="title function_">getName</span>();</span><br><span class="line">                <span class="keyword">if</span> (returnType === <span class="string">&quot;boolean&quot;</span>) &#123;</span><br><span class="line">                    method.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b.a.a.b.j() is called, res = &quot;</span>, <span class="variable language_">this</span>.<span class="title function_">j</span>());</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked boolean j() method&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (method.<span class="title function_">getName</span>() === <span class="string">&quot;e&quot;</span> &amp;&amp; method.<span class="title function_">getParameterTypes</span>().<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> returnType = method.<span class="title function_">getReturnType</span>().<span class="title function_">getName</span>();</span><br><span class="line">                <span class="keyword">if</span> (returnType === <span class="string">&quot;boolean&quot;</span>) &#123;</span><br><span class="line">                    method.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b.a.a.b.e() is called, res = &quot;</span>, <span class="variable language_">this</span>.<span class="title function_">e</span>());</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked boolean e() method&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将它修改成正常的、简单的脚本。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_java</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">var</span> targetClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;b.a.a.b&quot;</span>); </span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">a</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.a()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 强制返回 false</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">j</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.j()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">e</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.e()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后整理出来的脚本如下，执行完后能正常跑apk了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_java</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">var</span> targetClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;b.a.a.b&quot;</span>); </span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">a</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.a()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 强制返回 false</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">j</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.j()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">e</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.e()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hook_linker_call_constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 打印模块信息</span></span><br><span class="line">            <span class="keyword">if</span> (libnative_module) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Module name: &quot;</span> + libnative_module.<span class="property">name</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Base address: 0x&quot;</span> + libnative_module.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Size: &quot;</span> + libnative_module.<span class="property">size</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Path: &quot;</span> + libnative_module.<span class="property">path</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="title function_">check_pthread_create</span>(libnative_module.<span class="property">base</span>);</span><br><span class="line">                <span class="title function_">hook_20954</span>();</span><br><span class="line">                <span class="title function_">hook_7a660</span>();</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check_pthread_create</span>(<span class="params">baseaddr</span>)&#123;</span><br><span class="line">    <span class="comment">/* 找到函数pthread_create的地址 */</span></span><br><span class="line">    <span class="keyword">var</span> pthread_create = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pthread_create)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is exist&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is not exist&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* hook */</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is called&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg2: 0x&quot;</span> + (args[<span class="number">2</span>] - baseaddr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_20954</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(libnative_module.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x20954</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_20954 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_7a660</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(libnative_module.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x7a660</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_7a660 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Avoid_divide_by_zero</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> b = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;b.a.a.b&quot;</span>);</span><br><span class="line">    b[<span class="string">&quot;j&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">hook_linker_call_constructors</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_java);</span><br></pre></td></tr></table></figure>

<p>成功在豆瓣进修，hhhhhh。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/UnCrackable-Level3%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/UnCrackable-Level3%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">UnCrackable-Level3分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:16:25 / 修改时间：17:31:31" itemprop="dateCreated datePublished" datetime="2025-05-18T17:16:25+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="UnCrackable-Level3-apk"><a href="#UnCrackable-Level3-apk" class="headerlink" title="UnCrackable-Level3.apk"></a>UnCrackable-Level3.apk</h1><p>照常，安装并打开，被检测到了root，通过magisk进行root权限的隐藏。</p>
<p>之后还是输入正确的密码。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226195340118.png" alt="image-20250226195340118" style="zoom:50%;" />

<p>在输入错误的Secret后，会提示Nope…That’s not it. Try again.</p>
<p>在Jeb中搜索这个字符串，发现关键点在check_code上。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226195531902.png" alt="image-20250226195531902" style="zoom:67%;" />

<p>check_code调用了native层函数bar。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226195605177.png" alt="image-20250226195605177" style="zoom:67%;" />

<p>在ida中，检索函数bar，一个很明显的xor解密，密钥的长度为24。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226195656697.png" alt="image-20250226195656697"></p>
<p>为了获得正确的secret，需要将v8和qword_15038进行xor运算，得到最终的结果。</p>
<p>不难看出，v8的值来自于sub_10E0，这里考虑对sub_10E0进行hook，然后查看v8的值。</p>
<p>结果hook的过程遇到了反frida的检测，可以根据报错的调用栈定位到goodbye函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226195957335.png" alt="image-20250226195957335" style="zoom:67%;" />

<p>追溯到源头，发现在sub_30D0处，调用了goodbye()，检测的逻辑是，通过读取映射到内存的文件名，只要发现frida等字段就退出。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226200242118.png" alt="image-20250226200242118" style="zoom:80%;" />

<p>为了能够正常使用frida进行hook，有以下几种hook的方式，绕过反frida。</p>
<p>1.hook函数sub_30D0。</p>
<p>2.hook函数strstr。</p>
<p>Ⅰ.先讲hook sub_30D0：观察过函数sub_30D0，发现它被写在了.init_array节里，这个节里面的函数，会在库加载的时候依次被调用，因此，如果想要hook这个函数，必须在System.loadLibray执行过程中——因为执行完后，frida就hook不了了；而若是还没执行，libfoo.so还没加载，当然hook不了。</p>
<p>查阅了相关博客，so层的.init_array节里的函数，都是被模块linker64中的call_array调用的，所以要hook函数call_array，当下的核心目标是获得call_array在模块linker64中的偏移量。（方法随意，可以直接在ida中进行查看）</p>
<p>在hook后，流程变成：遇到加载的so是libfoo.so，在完成了内存映射后，call_array还没有执行，这个时候去修改内存中sub_30D0的内容，之后正常执行call_array。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取linker64模块的基地址</span></span><br><span class="line">    <span class="keyword">var</span> linker64_module = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&quot;linker64&quot;</span>);</span><br><span class="line">    <span class="comment">//使用拦截器附加linker64模块的偏移地址</span></span><br><span class="line">    <span class="comment">// 7D68B58764 - 7D68B38000 = 0x20764</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(linker64_module.<span class="title function_">add</span>(<span class="number">0x20764</span>),&#123;</span><br><span class="line">        <span class="comment">// 进入函数，代码检查参数args[3]指向的字符串是否匹配libfoo.so</span></span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span>(args[<span class="number">0</span>].<span class="title function_">readCString</span>().<span class="title function_">match</span>(<span class="string">&quot;libfoo.so&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// 获取libfoo.so的基地址</span></span><br><span class="line">                <span class="keyword">var</span> libfoo_module  = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libfoo.so&#x27;</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;获取libfoo.so的基地址==&gt;&quot;</span>+libfoo_module)</span><br><span class="line">                <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(libfoo_module.<span class="title function_">add</span>(<span class="number">0x30D0</span>),<span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;,<span class="string">&#x27;void&#x27;</span>,[]));</span><br><span class="line">           &#125;</span><br><span class="line">    &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">result</span>)&#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Ⅱ.hook strstr就比较简单，判断strstr的第1个参数里有没有frida字段，如果有，之后的返回值直接强制返回。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 反frida检测</span></span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;strstr&quot;</span>), &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">haystack</span> = args[<span class="number">0</span>];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">needle</span> = args[<span class="number">1</span>];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">frida</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法 1：使用 readCString（自动处理 NULL 结尾）</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> haystack = <span class="variable language_">this</span>.<span class="property">haystack</span>.<span class="title function_">isNull</span>() ? <span class="string">&quot;&quot;</span> : <span class="variable language_">this</span>.<span class="property">haystack</span>.<span class="title function_">readCString</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (haystack &amp;&amp; (haystack.<span class="title function_">includes</span>(<span class="string">&quot;frida&quot;</span>) || haystack.<span class="title function_">includes</span>(<span class="string">&quot;xposed&quot;</span>))) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">frida</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;读取字符串失败:&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">frida</span>) &#123;</span><br><span class="line">            retval.<span class="title function_">replace</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>ok，在解决了反frida后，继续对之前提到的sub_10E0进行解密，由于这个函数没有返回值，可以判断：这个函数会在v8所指向的地址处，修改24个字节。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">function</span> <span class="title function_">hookXor</span>(<span class="params"></span>)&#123;</span><br><span class="line">           <span class="comment">// hook xor的其中一个key</span></span><br><span class="line">       <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>((<span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libfoo.so&quot;</span>)).<span class="title function_">add</span>(<span class="string">&quot;0x010E0&quot;</span>), &#123;</span><br><span class="line">           <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">               <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;onEnter: hook xor key&quot;</span>);</span><br><span class="line">               <span class="variable language_">this</span>.<span class="property">key</span> = args[<span class="number">0</span>];</span><br><span class="line">           &#125;, </span><br><span class="line">       </span><br><span class="line">           <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">               <span class="keyword">var</span> key_ = <span class="keyword">new</span> <span class="title class_">NativePointer</span>(<span class="variable language_">this</span>.<span class="property">key</span>);</span><br><span class="line">               <span class="keyword">var</span> arr = key_.<span class="title function_">readByteArray</span>(<span class="number">24</span>);</span><br><span class="line">               <span class="variable language_">console</span>.<span class="title function_">log</span>(arr);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="built_in">setTimeout</span>(hookXor, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>这里为了避免hookXor未执行，特意延迟了1000ms再进行注入（方法比较简单）。</p>
<p>还有其它方法，在保证加载了libfoo.so后立马进行hook，而不用等待1000ms。（同样是在加载器上做文章，不过这里hook的是System.loadLibrary）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">System</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.System&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Runtime</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">SystemLoad</span>_2 = <span class="title class_">System</span>.<span class="property">loadLibrary</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">VMStack</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;dalvik.system.VMStack&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">SystemLoad</span>_2.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">library</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Loading dynamic library =&gt; &quot;</span> + library);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> loaded =     <span class="title class_">Runtime</span>.<span class="title function_">getRuntime</span>().<span class="title function_">loadLibrary0</span>( <span class="title class_">VMStack</span>.<span class="title function_">getCallingClassLoader</span>(), library);</span><br><span class="line">          <span class="keyword">if</span>(library.<span class="title function_">includes</span>(<span class="string">&quot;foo&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">//function that gets the xored value </span></span><br><span class="line">            <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libfoo.so&quot;</span>).<span class="title function_">add</span>(<span class="string">&#x27;0x00000fa0&#x27;</span>),&#123;</span><br><span class="line">              <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;getting other_key value&quot;</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">other_key_address</span> = args[<span class="number">0</span>];</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> other_key = <span class="keyword">new</span> <span class="title class_">NativePointer</span>(<span class="variable language_">this</span>.<span class="property">other_key_address</span>);</span><br><span class="line">                <span class="keyword">var</span> arr = other_key.<span class="title function_">readByteArray</span>(<span class="number">24</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(arr);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> loaded;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(ex) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(ex);</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(ex.<span class="property">stack</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>最后得到的结果如下，即：1d 08 11 13…</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226204101246.png" alt="image-20250226204101246" style="zoom:80%;" />

<p>同时，另一个密钥key是qword_15038，追踪后，发现是通过init函数进行初始化的，这个函数是一个jni函数，根据代码，可以发现它的值由java层传递。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226204325745.png" alt="image-20250226204325745"></p>
<p>因此，另一个key的值是pizzapizzapizzapizzapizz。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226204444346.png" alt="image-20250226204444346" style="zoom:80%;" />

<p>将两者做异或运算。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">xor_bytes</span>(<span class="params">str1, bytes2</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    对两个24字节的数据进行逐字节的异或运算。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">    str1: 长度为24字节的字符串</span></span><br><span class="line"><span class="string">    bytes2: 长度为24字节的字节数组</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">    result: 异或运算后的字节数组</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 确保输入长度为24字节</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(str1) != <span class="number">24</span> <span class="keyword">or</span> <span class="built_in">len</span>(bytes2) != <span class="number">24</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;输入必须是24字节长&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将字符串转换为字节数组</span></span><br><span class="line">    bytes1 = str1.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 进行逐字节的异或运算</span></span><br><span class="line">    result = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> b1, b2 <span class="keyword">in</span> <span class="built_in">zip</span>(bytes1, bytes2):</span><br><span class="line">        result.append(b1 ^ b2)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例用法</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 输入字符串和字节数组</span></span><br><span class="line">    str_input = <span class="string">&quot;pizzapizzapizzapizzapizz&quot;</span>  <span class="comment"># 24字节字符串</span></span><br><span class="line">    bytes_input = <span class="built_in">bytes</span>([<span class="number">0x1d</span>, <span class="number">0x08</span>, <span class="number">0x11</span>, <span class="number">0x13</span>, <span class="number">0x0f</span>, <span class="number">0x17</span>, <span class="number">0x49</span>, <span class="number">0x15</span>, <span class="number">0x0d</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x19</span>, <span class="number">0x5a</span>, <span class="number">0x1d</span>, <span class="number">0x13</span>, <span class="number">0x15</span>, <span class="number">0x08</span>, <span class="number">0x0e</span>, <span class="number">0x5a</span>, <span class="number">0x00</span>, <span class="number">0x17</span>, <span class="number">0x08</span>, <span class="number">0x13</span>, <span class="number">0x14</span>])  <span class="comment"># 24字节的字节数组 [0, 1, 2, ..., 23]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 执行异或运算</span></span><br><span class="line">    result = xor_bytes(str_input, bytes_input)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出结果</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;异或运算结果:&quot;</span>, result)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;十六进制表示:&quot;</span>, result.<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226205334111.png" alt="image-20250226205334111" style="zoom:67%;" />

<p>阿这，这个解密出来的结果有点6。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226205420426.png" alt="image-20250226205420426" style="zoom:67%;" />

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/UnCrackable-Level2%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/UnCrackable-Level2%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">UnCrackable-Level2分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:15:48 / 修改时间：17:31:15" itemprop="dateCreated datePublished" datetime="2025-05-18T17:15:48+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="UnCrackable-Level2-apk"><a href="#UnCrackable-Level2-apk" class="headerlink" title="UnCrackable-Level2.apk"></a>UnCrackable-Level2.apk</h1><p>直接安装+打开，又是解密。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224185514939.png" alt="image-20250224185514939" style="zoom:67%;" />

<p>搜索Nope，定位到this.m.a(s)。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224185646063.png" alt="image-20250224185646063" style="zoom:67%;" />

<p>在类MainActivity中，有一个私有对象m，m属于类CodeCheck，调用了函数a，最后调用了native层函数bar。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224185828483.png" alt="image-20250224185828483" style="zoom:67%;" />

<p>native层需要ida进行静态分析，这里将apk进行解压，取出其中的arm64架构的so库放入ida中，可以看到两个导出函数。</p>
<p>Java_包名_类名_函数名，可以看出bar就是我们要找的函数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224190249451.png" alt="image-20250224190249451"></p>
<p>一眼看出，v7对应的字符串就是正确的secret。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224191818314.png" alt="image-20250224191818314" style="zoom:67%;" />

<p>再看看导出的init函数，这里ida并没有给出JNIEnv和jobect，应该是反编译失误——这俩参数没用到，可能被优化了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224192734132.png" alt="image-20250224192734132" style="zoom:80%;" />

<p>在sub_918中，可以发现：fork出子进程，然后子进程通过ptrace附加到父进程，使得父进程无法其它调试器被再次附加，一个反调试技术。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224193151757.png" alt="image-20250224193151757" style="zoom:67%;" />

<p>Frida通过Interceptor模块，可以支持对Native层函数的hook。</p>
<p>下面这个脚本，先通过Module.findBaseAddress找到so模块的基地址，然后通过导出表符号Java_sg_vantagepoint_uncrackable2_MainActivity_init，找到它的函数地址，然后根据在文件中计算的文件偏移量，计算出要hook的无符号函数的地址。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">LIB_NAME</span> = <span class="string">&#x27;libfoo.so&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">EXPORT_SYMBOL</span> = <span class="string">&#x27;Java_sg_vantagepoint_uncrackable2_MainActivity_init&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">OFFSET</span> = <span class="title function_">ptr</span>(-<span class="number">1140</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">tryHook</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 获得模块基地址</span></span><br><span class="line">        <span class="keyword">const</span> moduleBase = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="variable constant_">LIB_NAME</span>);</span><br><span class="line">        <span class="keyword">if</span> (!moduleBase) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[!] <span class="subst">$&#123;LIB_NAME&#125;</span> 未加载，等待...`</span>);</span><br><span class="line">            <span class="built_in">setTimeout</span>(tryHook, <span class="number">1000</span>); <span class="comment">// 每秒检查一次</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] 模块基地址: <span class="subst">$&#123;moduleBase&#125;</span>`</span>);</span><br><span class="line">        <span class="comment">// 通过符号名获得函数实际地址</span></span><br><span class="line">        <span class="keyword">const</span> exportAddress = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="variable constant_">LIB_NAME</span>, <span class="variable constant_">EXPORT_SYMBOL</span>);</span><br><span class="line">        <span class="keyword">if</span> (!exportAddress) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[!] 未找到导出函数 <span class="subst">$&#123;EXPORT_SYMBOL&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] 导出函数地址: <span class="subst">$&#123;exportAddress&#125;</span>`</span>);</span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 根据偏移计算目标地址</span></span><br><span class="line">        <span class="keyword">const</span> targetAddress = exportAddress.<span class="title function_">add</span>(<span class="variable constant_">OFFSET</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] 目标函数地址: <span class="subst">$&#123;targetAddress&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印目标地址的前5个字节</span></span><br><span class="line">        <span class="keyword">const</span> bytes = <span class="title class_">Memory</span>.<span class="title function_">readByteArray</span>(targetAddress, <span class="number">5</span>);</span><br><span class="line">        <span class="keyword">const</span> byteArray = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(bytes);</span><br><span class="line">        <span class="keyword">const</span> hexBytes = <span class="title class_">Array</span>.<span class="title function_">from</span>(byteArray).<span class="title function_">map</span>(<span class="function"><span class="params">b</span> =&gt;</span> b.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)).<span class="title function_">join</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] 前5个字节: <span class="subst">$&#123;hexBytes&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(targetAddress, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`\n=== 函数调用开始 ===`</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="title class_">Process</span>.<span class="property">arch</span> === <span class="string">&#x27;arm64&#x27;</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`X0: <span class="subst">$&#123;args[<span class="number">0</span>]&#125;</span>, X1: <span class="subst">$&#123;args[<span class="number">1</span>]&#125;</span>, X2: <span class="subst">$&#123;args[<span class="number">2</span>]&#125;</span>`</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`R0: <span class="subst">$&#123;args[<span class="number">0</span>]&#125;</span>, R1: <span class="subst">$&#123;args[<span class="number">1</span>]&#125;</span>, R2: <span class="subst">$&#123;args[<span class="number">2</span>]&#125;</span>`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`返回值: <span class="subst">$&#123;retval&#125;</span>`</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`=== 函数调用结束 ===\n`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[√] Hook 安装成功`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setTimeout</span>(tryHook, <span class="number">1000</span>); <span class="comment">// 延迟1秒开始检查</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>然而还不够，即便hook住了这个函数，但这个函数早已经在MainActivity.onCreate阶段执行了，hook了也没用，因为已经执行过了一遍。</p>
<p>针对执行时机的问题，有以下解决方法：</p>
<p>1.使用spawn模式，默认的frida -U -f是“fork-and-attach”模式，可能错过早期逻辑。使用“spawn”模式可以在应用进程创建时注入Frida。</p>
<p>如：frida -U -l script.js –no-pause -f com.example.app –spawn</p>
<p>–spawn: 在进程创建时注入，而不是附加到已有进程。</p>
<p>2.hook系统类System，然后对loadLibrary做手脚，如果加载的是其它库，不做处理；如果加载的是foo.so，则立马进行覆盖。<strong>这个hook的时机发生在静态初始化块执行之前</strong>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">LIB_NAME</span> = <span class="string">&#x27;libfoo.so&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">EXPORT_SYMBOL</span> = <span class="string">&#x27;Java_sg_vantagepoint_uncrackable2_MainActivity_init&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">OFFSET</span> = <span class="title function_">ptr</span>(-<span class="number">1140</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hook System.loadLibrary</span></span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.System&#x27;</span>).<span class="property">loadLibrary</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">libName</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] 加载库: <span class="subst">$&#123;libName&#125;</span>`</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">loadLibrary</span>(libName); <span class="comment">// 调用原始方法</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (libName === <span class="string">&#x27;foo&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> moduleBase = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="variable constant_">LIB_NAME</span>);</span><br><span class="line">            <span class="keyword">if</span> (!moduleBase) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> exportAddress = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="variable constant_">LIB_NAME</span>, <span class="variable constant_">EXPORT_SYMBOL</span>);</span><br><span class="line">            <span class="keyword">const</span> targetAddress = exportAddress.<span class="title function_">add</span>(<span class="variable constant_">OFFSET</span>);</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(targetAddress, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`sub_918 被调用并覆盖`</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">            &#125;, <span class="string">&#x27;int64&#x27;</span>, []));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[√] sub_918 已替换`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>3.Hook MainActivity.onCreat。</p>
<p>所以接下来这段脚本执行时机如下，在静态初始化块执行后（System.loadLibrary导入libfoo.so），在onCreate执行前（调用Java_sg_vantagepoint_uncrackable2_MainActivity_init之前），hook了类MainActivity，然后在它执行前，将sub_918的内容做了替换。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">LIB_NAME</span> = <span class="string">&#x27;libfoo.so&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">EXPORT_SYMBOL</span> = <span class="string">&#x27;Java_sg_vantagepoint_uncrackable2_MainActivity_init&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">OFFSET</span> = <span class="title function_">ptr</span>(-<span class="number">1140</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">MainActivity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;sg.vantagepoint.uncrackable2.MainActivity&#x27;</span>);</span><br><span class="line">    <span class="title class_">MainActivity</span>.<span class="property">onCreate</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">savedInstanceState</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] MainActivity.onCreate 被调用&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在 onCreate 执行前替换 sub_918</span></span><br><span class="line">        <span class="keyword">const</span> moduleBase = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="variable constant_">LIB_NAME</span>);</span><br><span class="line">        <span class="keyword">if</span> (moduleBase) &#123;</span><br><span class="line">            <span class="keyword">const</span> exportAddress = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="variable constant_">LIB_NAME</span>, <span class="variable constant_">EXPORT_SYMBOL</span>);</span><br><span class="line">            <span class="keyword">const</span> targetAddress = exportAddress.<span class="title function_">add</span>(<span class="variable constant_">OFFSET</span>);</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(targetAddress, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`sub_918 被调用并覆盖`</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">            &#125;, <span class="string">&#x27;int64&#x27;</span>, []));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[√] sub_918 已替换`</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用原始 onCreate</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onCreate</span>(savedInstanceState);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>下图是安卓的初始化过程以及注入时机。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250225150528070.png" alt="image-20250225150528070" style="zoom: 67%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250225150505066.png" alt="image-20250225150505066" style="zoom:67%;" />

<p>之后尝试一下hook是否执行成功，先将脚本断掉，直接通过jeb调试进程。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250225150747031.png" alt="image-20250225150747031" style="zoom:67%;" />

<p>再试试通过frida进行hook后，能否attach上去调试。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250225150907624.png" alt="image-20250225150907624" style="zoom:80%;" />

<p>确实是attach上去了，但是手机上显示被检测到了调试，根据字符串搜索，发现问题来自于下图。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250225151147999.png" alt="image-20250225151147999" style="zoom:67%;" />

<p>有一个持续检测的进程，阿这，这么防着咱。。。</p>
<p>只需要hook Debug.isDebuggerConnected()即可，让它一直返回false，这里就不写了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/UnCrackable-Level1%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/UnCrackable-Level1%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">UnCrackable-Level1分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:13:45 / 修改时间：17:30:58" itemprop="dateCreated datePublished" datetime="2025-05-18T17:13:45+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="UnCrackable-Level1-apk"><a href="#UnCrackable-Level1-apk" class="headerlink" title="UnCrackable-Level1.apk"></a>UnCrackable-Level1.apk</h1><p>下载并安装，打开；一上来就被检测出root权限了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224152934808.png" alt="image-20250224152934808" style="zoom:50%;" />

<p>将apk丢入jeb中查看，通过<code>ctrl + f</code>搜索字符串。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224153359358.png" alt="image-20250224153359358" style="zoom: 67%;" />

<p>c.a()、c.b()、c.c()的逻辑如下图，我发现，在我的&#x2F;system&#x2F;bin中，确实有一个su。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224153529149.png" alt="image-20250224153529149" style="zoom:67%;" />

<p>方案1，粗暴的解决方案，修改dex文件并重新签名。在onCreate的第一个if处，将判断结果改成false；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> root = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;sg.vantagepoint.util.RootDetection&quot;</span>);</span><br><span class="line">	root.<span class="property">checkRoot1</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	root.<span class="property">checkRoot2</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	root.<span class="property">checkRoot3</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>方案2，hook掉exit函数或者hook掉相关函数；</p>
<p>方案3，面具magisk里直接屏蔽掉UnCrackable-Level1.apk的root权限，让它检测不到root。</p>
<p>这里介绍一下第二个方法，js脚本如下，执行方法也如下，然后就绕过去了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">frida -U -f owasp.mstg.uncrackable1 -l .\uncrackable-level1.js</span></span><br><span class="line"></span><br><span class="line">Java.perform(function()&#123;</span><br><span class="line">    var temp = Java.use(&quot;java.lang.System&quot;); # 获得System类</span><br><span class="line">    # exit是静态函数，不需要实例化后再调用</span><br><span class="line">    # overload指定具体的重载版本</span><br><span class="line">    temp.exit.overload(&#x27;int&#x27;).implementation = function(arg0)&#123;</span><br><span class="line">        console.log(&quot;Exit called with &quot; + arg0);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224160548124.png" alt="image-20250224160548124"></p>
<p>通过jeb，可以发现在类a中，函数a会根据输入的内容进行比较，随后得出是否正确的答案。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224183527518.png" alt="image-20250224183527518"></p>
<p>下面是写的一个js脚本，直接return true，或者通过sg.vantagepoint.a.a.a得到解密的明文。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"># 直接改为<span class="literal">true</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获取目标类</span></span><br><span class="line">    <span class="keyword">var</span> targetClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;sg.vantagepoint.uncrackable1.a&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook 静态方法 a(String)</span></span><br><span class="line">    targetClass.<span class="property">a</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">s</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n[*] 拦截验证方法调用&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 打印原始输入</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;原始输入: &quot;</span> + s);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调用原始方法获取结果</span></span><br><span class="line">        <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">a</span>(s); <span class="comment">// [!code focus]</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 打印原始验证结果</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;原始验证结果: &quot;</span> + result);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 强制返回 true（绕过验证）</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] 强制返回 true&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 若需保留原始逻辑，直接返回 result</span></span><br><span class="line">        <span class="comment">// return result;</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"># 观察正确的输入</span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获取加密工具类</span></span><br><span class="line">    <span class="keyword">var</span> crypto = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;sg.vantagepoint.a.a&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取验证类</span></span><br><span class="line">    <span class="keyword">var</span> checker = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;sg.vantagepoint.uncrackable1.a&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook a() 方法获取密钥和密文</span></span><br><span class="line">    checker.<span class="property">a</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">s</span>) &#123;</span><br><span class="line">        <span class="comment">// 原始密文（Base64）</span></span><br><span class="line">        <span class="keyword">var</span> ciphertext_b64 = <span class="string">&quot;5UJiFctbmgbDoLXmpL12mkno8HT4Lv8dlat8FxR2GOc=&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 硬编码密钥（处理负数为无符号字节）</span></span><br><span class="line">        <span class="keyword">var</span> key_bytes = [<span class="number">0x8D</span>, <span class="number">0x12</span>, <span class="number">0x76</span>, <span class="number">0x84</span>, <span class="number">0xCB</span>, <span class="number">0xC3</span>, <span class="number">0x7C</span>, <span class="number">0x17</span>, </span><br><span class="line">                         <span class="number">0x61</span>, <span class="number">0x6D</span>, <span class="number">0x80</span>, <span class="number">0x6C</span>, <span class="number">0xF5</span>, <span class="number">0x04</span>, <span class="number">0x73</span>, <span class="number">0xCC</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将密钥转换为 Java byte[]</span></span><br><span class="line">        <span class="keyword">var</span> jKey = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, key_bytes);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Base64 解码密文</span></span><br><span class="line">        <span class="keyword">var</span> ciphertext = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;android.util.Base64&#x27;</span>).<span class="title function_">decode</span>(ciphertext_b64, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 调用解密方法</span></span><br><span class="line">            <span class="keyword">var</span> decrypted_bytes = crypto.<span class="title function_">a</span>(jKey, ciphertext);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 转换为字符串</span></span><br><span class="line">            <span class="keyword">var</span> plaintext = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).$new(decrypted_bytes);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n[+] 解密成功！Secret String: &quot;</span> + plaintext);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[-] 解密失败: &quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回原始验证结果（或强制返回 true）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">a</span>(s);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行，得到结果。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224185351087-1747559716287-11.png" alt="image-20250224185351087"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E4%B8%8E%E8%84%B1%E5%A3%B3%E6%9C%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E4%B8%8E%E8%84%B1%E5%A3%B3%E6%9C%BA/" class="post-title-link" itemprop="url">类加载与脱壳机</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:11:40 / 修改时间：17:34:54" itemprop="dateCreated datePublished" datetime="2025-05-18T17:11:40+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>12 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>自制脱壳机，将公开了源码的Fart6移植到Fart10，同时去除一些Fart特征。</p>
<h1 id="loadClass的过程"><a href="#loadClass的过程" class="headerlink" title="loadClass的过程"></a>loadClass的过程</h1><p>loadClass的过程可以总结成：1.判断是否是当前类加载器加载了此类；2.若不是，让父加载器加载此类；3.若父加载器加载失败，由当前加载器加载。</p>
<p>一般实现类加载，同时使用ClassLoader的实例调用loadClass。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423193342573.png" alt="image-20250423193342573"></p>
<p>可以看到，ClassLoader.loadClass(String className)间接调用重载函数，resolve在这里不起作用，在JVM中，如果resolve为true，表示加载类之后是否需要立即进行<strong>链接操作</strong>中的<strong>解析</strong>步骤。（链接包括：验证、准备（分配空间）、解析），而在安卓虚拟机中，这里忽略resolve。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423193434035.png" alt="image-20250423193434035" style="zoom:67%;" />

<h2 id="1-findLoadedClass（ClassLoader）——查询当前加载器是否加载了目标类"><a href="#1-findLoadedClass（ClassLoader）——查询当前加载器是否加载了目标类" class="headerlink" title="1 findLoadedClass（ClassLoader）——查询当前加载器是否加载了目标类"></a>1 findLoadedClass（ClassLoader）——查询当前加载器是否加载了目标类</h2><p>findLoadedClass是用来检查缓存的，这个方法会检查当前ClassLoader实例是否已经加载过名为className的类，每个ClassLoader实例都有一个缓存区，用来存放已经加载过的类。</p>
<p>如果当前实例是启动类加载器，则将局部变量 <code>loader</code> 设为 <code>null</code>。这是因为查询启动类加载器加载的类通常需要通过 VM 的特殊 native 接口，并使用 <code>null</code> 来代表它。</p>
<p>如果当前实例<strong>不是</strong>启动类加载器（比如是 AppClassLoader 或 PathClassLoader 等），则将 <code>loader</code> 设置为 <code>this</code>，即当前 ClassLoader 实例本身。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423194242183.png" alt="image-20250423194242183"></p>
<h3 id="findLoadedClass（VMClassaLoader、JNI函数）"><a href="#findLoadedClass（VMClassaLoader、JNI函数）" class="headerlink" title="findLoadedClass（VMClassaLoader、JNI函数）"></a>findLoadedClass（VMClassaLoader、JNI函数）</h3><p>这里的VMClassLoader.findLoadedClass是一个static的JNI函数，具体实现在native层，目录为：&#x2F;art&#x2F;runtime&#x2F;native&#x2F;java_lang_VMClassLoader.cc。</p>
<p>这个 C++ 函数 <code>VMClassLoader_findLoadedClass</code> 的核心目的是：接收一个 Java 层的 <code>ClassLoader</code> 对象和一个类名字符串，然后在 ART 虚拟机内部的数据结构中查找，判断这个特定的 <code>ClassLoader</code> <strong>是否已经加载并解析</strong>了具有该名称的类。如果找到了并且类是可用状态（已解析），就返回对应的 Java <code>Class</code> 对象 (jclass)；否则返回 <code>nullptr</code>。</p>
<p>现在来简单解释一下下图的函数VMClassLoader_findLoadedClass。</p>
<p>第31行，env是标准的JNI的接口，提供java与native之间的交互。soa可以理解为ART对JNI交互的封装与简化，它的底层还是使用env来工作，但自动管理线程状态，更安全、方便。</p>
<p>第32行，将Java层的jobject javaLoader解码成ART内部表示的mirror::ClassaLoader*指针loader，这里的mirror是ART中表示Java堆对象的类的命名空间。</p>
<p>第33行，将javaName从java的jstring转换成c&#x2F;c++使用的UTF-8编码字符串。</p>
<p>第37行，获取ClassLinker实例，ClassLinker实例要负责类的<strong>加载</strong>、<strong>链接</strong>（验证、准备、解析）、<strong>初始化</strong>。所有类查找、类定义、解析相关的操作，都要经过ClassLinker。</p>
<p>第38行，将点分格式的类名转换成虚拟机内部使用的描述符，即斜杠格式。</p>
<p>第39行，将类描述符转换成唯一的哈希值。</p>
<p>第40行，根据<strong>哈希值、loader、类描述符、当前的线程</strong>（soa.Self()返回线程Thread<em>指针），来去找*<em>唯一的类</em></em>。</p>
<p>这里重点关注LookupClass。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423195152864.png" alt="image-20250423195152864" style="zoom:80%;" />

<h4 id="LookupClass"><a href="#LookupClass" class="headerlink" title="LookupClass"></a>LookupClass</h4><p>在LookupClass中。</p>
<p><strong>第一阶段，查主表。（缓存查找）</strong></p>
<p>使用 <code>ReaderMutexLock</code> 获取对 <code>ClassLinker</code> 内部类表的读取锁，保证线程安全。</p>
<p>调用 <code>LookupClassFromTableLocked</code> 在主要的类表（包括 Zygote 预加载表 <code>pre_zygote_class_table_</code> 和运行时表 <code>class_table_</code>）中查找。</p>
<p>如果在表中找到了匹配的类 (<code>result != nullptr</code>)，就立即返回结果。锁会自动释放。</p>
<p><strong>第二阶段，查启动镜像（启动类加载器）。</strong></p>
<p>仅当第一阶段失败、查找的是启动类加载器 (<code>class_loader == nullptr</code>)、<strong>且</strong>需要查找镜像时，才执行这里。</p>
<p>调用 <code>LookupClassFromImage(descriptor)</code> 尝试在 dex_caches_ 中查找。</p>
<p>如果找到了 (<code>result != nullptr</code>): 调用 <code>InsertClass</code> 将其加入主类表（可能是 <code>class_table_</code>），起到缓存作用，然后返回找到的 <code>result</code>。</p>
<p>如果还没找到 (<code>result == nullptr</code>): 增加查找镜像失败的计数器。如果失败次数超过阈值 (<code>kMaxFailedDexCacheLookups</code>)，则触发一个优化操作 <code>MoveImageClassesToClassTable()</code>，将所有启动镜像中的类都添加到主类表中，以加速后续查找。最后返回 <code>nullptr</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423203016909.png" alt="image-20250423203016909"></p>
<h5 id="LookupClassFromTableLocked"><a href="#LookupClassFromTableLocked" class="headerlink" title="LookupClassFromTableLocked"></a>LookupClassFromTableLocked</h5><p>在LookupClassFromTableLocked中，pre_zygote_class_table_记录着预加载的类（Zygote进程在创建时，初始化了虚拟机并加载了一系列预加载的动态链接库，这些动态链接库里的类记录在这个预加载类表里）。而class_table_则是动态类表，它存储了 Zygote 之后由各种 ClassLoader 加载的类，以及从启动镜像（image）查找到并缓存起来的类。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423203338637.png" alt="image-20250423203338637"></p>
<h5 id="LookupClassFromImage"><a href="#LookupClassFromImage" class="headerlink" title="LookupClassFromImage"></a>LookupClassFromImage</h5><p>函数LookupClassFromImage是从启动类加载器的dex_cache中找目标类，DexCache类用于关联DexFile对象。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250424093826619.png" alt="image-20250424093826619"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250424104135348.png" alt="image-20250424104135348" style="zoom:67%;" />

<h2 id="2-parent-loadClass——委托父加载器加载"><a href="#2-parent-loadClass——委托父加载器加载" class="headerlink" title="2 parent.loadClass——委托父加载器加载"></a>2 parent.loadClass——委托父加载器加载</h2><p>上述流程已经把如何寻找一个类讲得很详细了，接下来讲委派双亲机制。</p>
<p>下图中，在findLoadedClass找不到className后，就会尝试执行parent.loadClass，让父加载器去加载，父加载器的执行流程也是：findLoadedClass、parent.loadClass、findClass。</p>
<p>所以，这里不细讲委派机制（双亲委派机制不难），直接讲如何加载一个未加载的类。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423193434035.png" alt="image-20250423193434035" style="zoom:67%;" />

<h2 id="3-findClass——自己加载"><a href="#3-findClass——自己加载" class="headerlink" title="3 findClass——自己加载"></a>3 findClass——自己加载</h2><p>这里分析的是BaseDexClassLoader的findClass，一般整体壳都绕不开BaseDexClassLoader，BaseDexClassLoader的父类是ClassLoader，我们之前分析的findLoadedClass和parent.loadClass都是ClassLoader类中，loadClass里出现的函数。BaseDexClassLoader并没有实现自己的loadClass，所以loadClass都是从ClassLoader继承过来的。</p>
<p>但ClassLoader的findClass已经被BaseDexClassLoader覆写了，我们这里就需要分析findClass。</p>
<p><code>findClass</code> 函数的核心职责就是：<strong>在当前 ClassLoader 管理的一系列 Dex 文件中，按顺序查找指定的类，如果找到，就加载并定义它。</strong></p>
<p>下图中，pathList是个老熟人了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423213829616.png" alt="image-20250423213829616"></p>
<h3 id="pathList——属于类DexPathList"><a href="#pathList——属于类DexPathList" class="headerlink" title="pathList——属于类DexPathList"></a>pathList——属于类DexPathList</h3><p>pathList是BaseDexClassLoader声明的一个DexPathList类型的私有成员变量。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423215020680.png" alt="image-20250423215020680"></p>
<p>关于DexPathList，从字面上来看，它是存储Dex路径列表的一个变量，从功能上来说，它存储的路径包括：apk的路径、dex的路径、jar的路径、class的路径等。然而，类DexPathList存储路径的列表（成员变量）叫dexElements，这一度让我以为——“一个Element实例代表一个Dex文件路径”，这个概念其实是错的。</p>
<p>通过注释，其实可以知道，这个成员变量应该叫pathElements，结果因为Facebook app改了名字，What can I say。</p>
<p>纠正一下上面的概念，这里的dexElements是一个Element数组，每个Element实例存储的是一个路径，这个路径要是指向apk，可能包含不止一个Dex，所以一个Element实例代表一个Dex文件路径的概念是错误的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423220734893.png" alt="image-20250423220734893" style="zoom:67%;" />

<p>接着看看DexPathList的findClass。</p>
<p>可以看到，这里取出了每个Element实例，并取出了element.dexFile赋给dex，然后调用了dex.loadClassBinaryName去找目标类是否在当前的文件（apk&#x2F;dex&#x2F;jar&#x2F;class）中。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423221852117.png" alt="image-20250423221852117"></p>
<h4 id="dexElements——属于类Element"><a href="#dexElements——属于类Element" class="headerlink" title="dexElements——属于类Element"></a>dexElements——属于类Element</h4><p>类Element是定义在DexPathList的静态内部类，从成员变量中可以看出，它存储的类型有apk&#x2F;zip&#x2F;dex等，还有一个很关键的成员变量dexFile。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423222628102.png" alt="image-20250423222628102" style="zoom:80%;" />

<h5 id="mCookie——属于类DexFile"><a href="#mCookie——属于类DexFile" class="headerlink" title="mCookie——属于类DexFile"></a>mCookie——属于类DexFile</h5><p>DexFile的mCookie很重要，在native层中，通过相关函数的调用，可以利用mCookie去获取DexFile（可以理解为PathFile）里存放的所有Dex文件。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423223224521.png" alt="image-20250423223224521" style="zoom:80%;" />

<p>阅读DexFile.java中的代码，会发现mCookie的值由jni函数openDexFileNative获得。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423223802545.png" alt="image-20250423223802545"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423224106202.png" alt="image-20250423224106202" style="zoom: 67%;" />

<p>java层openDexFileNative对应着native层的DexFile_openDexFileNative。</p>
<p>第154-161行，将输入的jstring转换成c&#x2F;c++的const char*来使用。</p>
<p>第163行，获取ART运行时的ClassLinker实例，打开Dex文件和处理OAT文件是ClassLinker的职责之一。</p>
<p>第164行，创建一个std::vector，用于存放成功打开的DexFile对象。</p>
<p>第165行，创建error_msgs用于收集打开过程中可能出现的错误信息。</p>
<p>第167行，可以理解为OpenDexFilesFromOat将已打开的Dex文件(们)的内部句柄打包成一个long[]数组，返回给dex_files。</p>
<p>第170行，将这些句柄从native类型转换成JNI类型，赋值给array，array会通过return赋给Java层的mCookie。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423224207810.png" alt="image-20250423224207810" style="zoom:80%;" />

<p>于是我们知道了，mCookie是已打开的Dex文件们的句柄数组指针。</p>
<h5 id="loadClassBinaryName——属于类DexFile"><a href="#loadClassBinaryName——属于类DexFile" class="headerlink" title="loadClassBinaryName——属于类DexFile"></a>loadClassBinaryName——属于类DexFile</h5><p>回到这张图，讲DexFile的loadClassBinaryName。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423221852117.png" alt="image-20250423221852117"></p>
<p>直接跳转到defineClass。</p>
<p><img src="/./assets/image-20250423230919815.png" alt="image-20250423230919815"></p>
<p>再跳转到defineClassNative。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423231002943.png" alt="image-20250423231002943" style="zoom:67%;" />

<p>defineClassNative是一个静态JNI函数。</p>
<p>第220行，眼熟吧，将cookie转换回了dex_files句柄数组。</p>
<p>第234行，遍历每一个打开的Dex文件句柄。</p>
<p>第235行，通过函数FindClassDef，去每个Dex文件里寻找目标Class是否存在。</p>
<p>第236行，如果存在，则通过ClassLinker的实例class_linker，对这个Dex文件进行注册，加入dex_caches。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250423231252117.png" alt="image-20250423231252117"></p>
<h6 id="FindClassDef——找到类定义"><a href="#FindClassDef——找到类定义" class="headerlink" title="FindClassDef——找到类定义"></a>FindClassDef——找到类定义</h6><p>这个函数的核心目的是：<strong>在当前的 <code>DexFile</code> 对象所代表的 Dex 文件内部，根据给定的类描述符 (descriptor) 字符串和其哈希值，查找并返回对应的 <code>DexFile::ClassDef</code> 结构体指针。</strong></p>
<p>其中，第481-485行，在解析一个Dex文件，获得Class的数量。</p>
<p>第486-499行，遍历类定义表，根据类定义结构的class_idx_是指向type索引表，这里通过描述符descriptor获取到了type_idx，然后和每个类的class_idx_进行比较，以此找出类。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250424105954640.png" alt="image-20250424105954640" style="zoom:80%;" />

<p>下图是ClassDef的结构。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250424140948995.png" alt="image-20250424140948995" style="zoom:80%;" />

<h6 id="RegisterDexFile——将DexFile加入缓存"><a href="#RegisterDexFile——将DexFile加入缓存" class="headerlink" title="RegisterDexFile——将DexFile加入缓存"></a>RegisterDexFile——将DexFile加入缓存</h6><p>dex_cache会被加入ClassLinker中的dex_caches_中（通过dex_caches_.push_back），ClassLinker会通过这个列表跟踪所有已注册的Dex缓存，建立了dex_cache和dex_file之间的连接（dex_cache-&gt;SetDexFile(&amp;dex_file)）。</p>
<p>这个过程确保了每个被 ART 管理的 Dex 文件都有一个对应的 DexCache，并且 ClassLinker 能够找到并管理这些缓存。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250424142218357.png" alt="image-20250424142218357" style="zoom:80%;" />

<h6 id="DefineClass——类的加载、链接、初始化"><a href="#DefineClass——类的加载、链接、初始化" class="headerlink" title="DefineClass——类的加载、链接、初始化"></a>DefineClass——类的加载、链接、初始化</h6><p>这个函数是<strong>实际定义一个新类</strong>的核心逻辑。它接收一个在 <code>dex_file</code> 中找到的类定义 <code>dex_class_def</code>，以及要使用的 <code>class_loader</code>，然后负责创建对应的运行时 <code>mirror::Class</code> 对象，并执行加载和链接的关键步骤。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250424144226011.png" alt="image-20250424144226011" style="zoom:67%;" />

<p>第1816行-1829行，处理特殊的类。</p>
<p>第1831-1841行，分配内存创建Class对象。</p>
<p>第1842行，将DexFile对应的DexCache设置到Class对象中。</p>
<p>第1844行，用ClassDef和ClassLoader信息填充Class对象。</p>
<p>第1847-1850行，为String类专门进设置标志。——没深入分析。</p>
<p>第1853-1854行，获得这个类的锁，防止并发初始化，记录当前线程为类的初始化线程。</p>
<p><img src="/./assets/image-20250424144506020.png" alt="image-20250424144506020"></p>
<p>第1857行，根据描述符、Class对象.Get()、类描述符的hash值插入一个新加载的类到类表class_table_中。</p>
<p>第1858-1862行，插入失败，说明被其它线程插入了，使用已存在的Class对象并确保它已经被解析。</p>
<p>第1868-1876行，加载类的成员（字段和方法信息），如果失败，标志Class状态为Error。</p>
<p>第1878-1879行，此时类状态应该为Loaded（成员已经加载，但父类&#x2F;接口未连接）。</p>
<p>第1880行，加载并链接父类和接口。</p>
<p>第1894行，执行链接（验证、准备、解析字段&#x2F;方法、设置vtable&#x2F;iftable等）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250424145459019.png" alt="image-20250424145459019"></p>
<p>最后返回的是一个定义并链接好的Class对象。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250424150802221.png" alt="image-20250424150802221" style="zoom:80%;" />

<p>整个逻辑如下图所示。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250424150959405.png" alt="image-20250424150959405" style="zoom:80%;" />

<p>（注：说明一下，Java的DexFile类和C&#x2F;C++的DexFile类不一样，Java的DexFile通常指向一个APK文件或JAR文件或Dex文件等等，所以一个DexFile类可能会存储着许多个Dex文件；而C&#x2F;C++的DexFile类指向一个Dex文件）</p>
<p>一个 Java <code>DexFile</code> 对象虽然是基于一个<strong>单一的源文件路径 (APK&#x2F;JAR)</strong> 创建的，但它内部通过 <code>mCookie</code> (一个 <code>long[]</code> 数组) 可以管理从该源文件或其对应的 OAT 文件中加载出来的<strong>一个或多个</strong>底层的 C++ <code>art::DexFile</code> 实例。这对于支持 Android 的 MultiDex 机制至关重要。</p>
<h1 id="Fart的逻辑"><a href="#Fart的逻辑" class="headerlink" title="Fart的逻辑"></a>Fart的逻辑</h1><p>Fart脱壳的步骤主要分为3步：</p>
<p>1.找到合适的点，通过DexFile结构脱下完整的dex；</p>
<p>2.主动调用类中的每一个方法，并实现对CodeItem的dump；</p>
<p>3.修复Dex。</p>
<h2 id="整体壳"><a href="#整体壳" class="headerlink" title="整体壳"></a>整体壳</h2><p>下图是Fart的第1点的逻辑。</p>
<p>一个类的初始化函数是不会被直接编译成OAT代码的，而一个Java的Method，除了走OAT代码模式，就必须走解释器模式，解释器模式必须经过函数Execute，因此，可以在Execute里针对<clinit>进行dump，以完成整个dex的dump。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250424201851497.png" alt="image-20250424201851497"></p>
<h2 id="抽取壳"><a href="#抽取壳" class="headerlink" title="抽取壳"></a>抽取壳</h2><p>下图是Fart的第2点逻辑。</p>
<p><img src="/./assets/image-20250424193856630.png" alt="image-20250424193856630"></p>
<p>之后，又有人写了一个FartExt，逻辑如下。</p>
<img src="./制作脱壳机.assets/659397_VSXS7G8WNMTJTVH.png" alt="659397_VSXS7G8WNMTJTVH" style="zoom:80%;" />

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/default-index/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/default-index/">1</a><a class="page-number" href="/default-index/page/2/">2</a><span class="page-number current">3</span>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">X14Nuy</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">491k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">14:53</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
