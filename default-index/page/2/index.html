<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/default-index/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="X14Nuy">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/default-index/page/2/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"default-index/page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">X14Nuy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/06/10/xhs%E5%88%86%E6%9E%90%E2%80%94%E2%80%94shield%E5%AD%97%E6%AE%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/10/xhs%E5%88%86%E6%9E%90%E2%80%94%E2%80%94shield%E5%AD%97%E6%AE%B5/" class="post-title-link" itemprop="url">xhs分析——shield字段</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-06-10 22:29:33 / 修改时间：22:46:06" itemprop="dateCreated datePublished" datetime="2025-06-10T22:29:33+08:00">2025-06-10</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>71k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2:09</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-分析目标"><a href="#1-分析目标" class="headerlink" title="1.分析目标"></a>1.分析目标</h1><p>要分析的字段：shield。</p>
<h1 id="2-抓包"><a href="#2-抓包" class="headerlink" title="2.抓包"></a>2.抓包</h1><p>这个字段在很多请求中有出现，比如登录验证码。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530103310169.png" alt="image-20250530103310169" style="zoom:80%;" />

<p>（ps：其实一般先抓包，然后确定分析目标，只不过在网上能找到分析shield的博客，不用孤军奋战！第一次分析大厂app，找个有资料分析的，hhhh，当然~虽然有其它人的博客，但我还是先自己分析，有不会的再看博客~）</p>
<h1 id="3-基本分析"><a href="#3-基本分析" class="headerlink" title="3.基本分析"></a>3.基本分析</h1><p>通过frida-ps获得包名。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530093701399.png" alt="image-20250530093701399" style="zoom:80%;" />

<p>从Manifest文件中获取App类名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530093929614.png" alt="image-20250530093929614"></p>
<p>看了一下，似乎没有加壳，因为什么内容都看得见，比如IndexActivityV2。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530103415270.png" alt="image-20250530103415270"></p>
<p>先直接在jadx中搜索，观察能否找到协议字段shield。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530103929768.png" alt="image-20250530103929768"></p>
<p>并没有找到，但感觉有一些类名、字段名比较可疑。——先暂时放着，如果其它方法用不了再来查看这些类与字段。</p>
<p>再尝试使用frida去hook hashMap，一般开发的时候，会用hashMap存储通信协议字段。</p>
<p>打印的调用链有点长。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">[shield] shield</span><br><span class="line">[value] XYAAQAAgAAAAEAAABTAAAAUzUWEe0xG1IbD9/c+qCLOlKGmTtFa+lG434Je+FUTaRHxIzkyONuSp3/qeYJz8Mt3Jx+2fc6EAwYGGHebLP31H5m0rFOBPBvvrx/G4l575l4LPk3</span><br><span class="line">java.lang.Throwable</span><br><span class="line">        at java.util.HashMap.put(Native Method)</span><br><span class="line">        at qd9.h1.intercept(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.a.intercept(SourceFile:5)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.m.intercept(SourceFile:6)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.d.intercept(SourceFile:7)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.h.intercept(SourceFile:4)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at sf3.b.b(SourceFile:1)</span><br><span class="line">        at sf3.b.intercept(SourceFile:25)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.r.b(SourceFile:1)</span><br><span class="line">        at wd8.r.intercept(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at com.xingin.shield.http.XhsHttpInterceptor.intercept(Native Method)</span><br><span class="line">        at com.xingin.shield.http.XhsHttpInterceptor.intercept(SourceFile:8)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at ae8.b.c(SourceFile:2)</span><br><span class="line">        at ae8.a.intercept(SourceFile:3)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.l.intercept(SourceFile:13)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.s.intercept(SourceFile:13)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.u.intercept(SourceFile:6)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at rd9.c.intercept(SourceFile:15)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at ne7.c.intercept(SourceFile:11)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.c.intercept(SourceFile:2)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at qe7.b.intercept(SourceFile:3)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at ve9.d.intercept(SourceFile:8)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at yy8.m.intercept(SourceFile:26)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at on1.b.intercept(SourceFile:2)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at on1.a.intercept(SourceFile:2)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at jf9.c.intercept(SourceFile:1)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at qd9.k.intercept(SourceFile:3)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at yd8.a.intercept(SourceFile:1)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at qd9.p1.intercept(SourceFile:1)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at nj8.j.intercept(SourceFile:5)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at nj8.g.intercept(SourceFile:5)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at hw5.b.intercept(SourceFile:2)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at rd9.e.intercept(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at rd9.b.intercept(SourceFile:12)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at rd9.d.intercept(SourceFile:26)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at yy8.b.intercept(SourceFile:2)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.o.intercept(SourceFile:33)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at ve9.e$a.intercept(SourceFile:4)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at jf9.l.intercept(SourceFile:8)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at wd8.w.intercept(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:10)</span><br><span class="line">        at okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:1)</span><br><span class="line">        at okhttp3.RealCall.getResponseWithInterceptorChain(SourceFile:13)</span><br><span class="line">        at okhttp3.RealCall.execute(SourceFile:8)</span><br><span class="line">        at retrofit2.OkHttpCall.execute(SourceFile:8)</span><br><span class="line">        at wc8.b.e(SourceFile:14)</span><br><span class="line">        at io.reactivex.Observable.subscribe(SourceFile:14)</span><br><span class="line">        at wc8.a.e(Unknown Source:23)</span><br><span class="line">        at io.reactivex.Observable.subscribe(SourceFile:14)</span><br><span class="line">        at ms9.n0.e(Unknown Source:17)</span><br><span class="line">        at io.reactivex.Observable.subscribe(SourceFile:14)</span><br><span class="line">        at ms9.l3$b.run(Unknown Source:6)</span><br><span class="line">        at kd8.a.run(SourceFile:3)</span><br><span class="line">        at ud7.a.run(SourceFile:2)</span><br><span class="line">        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:462)</span><br><span class="line">        at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">        at uh8.h.F(Unknown Source:12)</span><br><span class="line">        at uh8.h.run(SourceFile:9)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1167)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:641)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:920)</span><br></pre></td></tr></table></figure>

<p>除此之外，进程还在执行一段时间后终止了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530105524482.png" alt="image-20250530105524482"></p>
<p>我决定先解决反调。</p>
<h1 id="4-反调"><a href="#4-反调" class="headerlink" title="4.反调"></a>4.反调</h1><p>先用常规办法，看是否能解决。</p>
<p>先hook库的加载，观察哪个库加载后会导致进程退出。</p>
<p>下面这个结果是通过hook System.loadLibrary的结果。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530110426774.png" alt="image-20250530110426774" style="zoom:80%;" />

<p>感觉不太对，就打印了一条hook记录。</p>
<p>换一个方式hook，这回hook dlopen和android_dlopen_ext。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530121032468.png" alt="image-20250530121032468"></p>
<p>在加载了libredpreload.so、libmsaoaidsec.so后，退出了。还记得bilibili和豆瓣用的也是libmsaoaidsec.so做反调。</p>
<p>当时的解决方式是：hook掉检测线程或者删掉这个库（如果小红薯没额外对这个库做检查的话），考虑到重新签名太麻烦了，还是hook线程吧。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530123104099.png" alt="image-20250530123104099" style="zoom: 80%;" />

<p>将这3个线程的目标函数替换掉，等待了一段时间，发现进程不崩溃了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530123804548.png" alt="image-20250530123804548" style="zoom:80%;" />

<p>然后整理一个绕过检测的hook脚本模板，方便之后写其它脚本，这里就不展示了。</p>
<h1 id="5-追踪字段shield"><a href="#5-追踪字段shield" class="headerlink" title="5.追踪字段shield"></a>5.追踪字段shield</h1><p>过完反调，回来继续分析shield字段。</p>
<p>避开sdk的函数，先追踪qd9.h1.intercept。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530124447630.png" alt="image-20250530124447630"></p>
<p>在函数intercept中，找到2个调用put的位置。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530130314460.png" alt="image-20250530130314460" style="zoom:80%;" />

<p>这里的intercept代码可以分成2块，上面一块在拦截和修改<strong>请求</strong>（Request），下面一块在拦截和处理<strong>响应</strong>（Response）。</p>
<p>hook一下函数intercept，观察原本的请求体和修改后的请求体。</p>
<p>我的脚本只获得了输入参数，输出结果却打印不出来——说明hook引发了某些问题，导致调用原本的intercept的时候，陷入了死循环，导致方法stack溢出。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530134630822.png" alt="image-20250530134630822"></p>
<p>又或者是下面这样的报错。（搜了一下，大致原因是：有不可序列化的内容在输出结果里）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530135606186.png" alt="image-20250530135606186"></p>
<p>但不管怎么说，通过输入参数，我们发现shield已经在传入时就加密好了，说明qd9.h1.intercept并不是我们要找的加密点。</p>
<p>观察了一下前面的调用栈，发现存在shield的字段，追踪过去看看。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">at com.xingin.shield.http.XhsHttpInterceptor.intercept(Native Method)</span><br><span class="line">at com.xingin.shield.http.XhsHttpInterceptor.intercept(SourceFile:8)</span><br></pre></td></tr></table></figure>

<p>hook后发现输入参数没有shield。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530141942891.png" alt="image-20250530141942891"></p>
<p>而hook wd8.r.intercept，发现输入参数存在shield参数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530142603508.png" alt="image-20250530142603508"></p>
<p>说明，大概率是在com.xingin.shield.http.XshHttpInterceptor.intercept添加了字段shield。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530142527896.png" alt="image-20250530142527896" style="zoom:80%;" />

<p>至此，锁定了加密点。</p>
<h1 id="6-加密分析"><a href="#6-加密分析" class="headerlink" title="6.加密分析"></a>6.加密分析</h1><p>猜测应该是根据this.cPtr生成shield，然后往chain上添加。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530143432846.png" alt="image-20250530143432846"></p>
<p>而this.cPtr的来头有点复杂，咱们不管，直接hook JNI函数intercept，查看j10的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530144122340.png" alt="image-20250530144122340"></p>
<p>多次打印，发现j10不会轻易发生改变，j10&#x3D;494045072144。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530145440602.png" alt="image-20250530145440602"></p>
<p>hook RegisterNatives，观察动态注册的函数地址，找到intercept在libxyass.so的偏移是0x9e184。</p>
<p>PS：一开始脚本写错逻辑了，我还以为是静态注册的,,ԾㅂԾ,,然后写了一个遍历文件夹下所有so的脚本，获得导出表，然后筛选我们的intercept——就当作在这里提供一个找静态注册JNI函数的思路吧。</p>
<p>PPS：要找动态注册的函数，还有一个思路，根据JNI在Java的方法名，拿到ArtMethod，然后根据ArtMethod获得JNI函数在Native层的地址，然后判断这个地址在哪个模块，而偏移量则是Native层的地址 - 模块基址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530152836580.png" alt="image-20250530152836580"></p>
<p>用IDA打开后，修改一下参数名与类型。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530154553559.png" alt="image-20250530154553559"></p>
<p>不知道到底在调用哪个函数，大概率是关于JNIEnv的函数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530155837197.png" alt="image-20250530155837197"></p>
<p>根据计算，off_AD430 + 0x753016A0 &#x3D;&#x3D; 0x6E13C，看样子是封装了CallObjectMethodV。</p>
<p>问题来了，参数传递的时候，chain为什么会是a2？a2应该是jobject类型。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530160824936.png" alt="image-20250530160824936" style="zoom: 67%;" />

<p>而且，qword_B1740等全局变量尚未被初始化，因此，我决定dump一个so文件下来看看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530165045013.png" alt="image-20250530165045013"></p>
<p>然后使用工具修复dump下来的elf文件。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530165303554.png" alt="image-20250530165303554"></p>
<p>打开IDA，来到0x9e184，可以发现qword_B1740等全局变量已经回填了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530183503982.png" alt="image-20250530183503982"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530183841508.png" alt="image-20250530183841508" style="zoom:80%;" />

<p>然而，这些jmethodID咱肯定是看不懂的。——这里有3个思路。</p>
<ol>
<li><p>将jmethodID转换成对应的函数名。（难点：先获取jmethodID，再考虑如何转换）</p>
</li>
<li><p>hook JNI函数，打印JNI函数调用序列。（难点：如何筛选sub_9E184中执行的JNI函数）</p>
</li>
<li><p>Unidbg的模拟执行可以打印调用的JNI函数序列。（难点：补环境）</p>
</li>
</ol>
<p>网上的博客都是基于Unidbg进行分析，既然别人用Unidbg，那这里我就用frida吧。——自己分析才更具挑战性嘛。</p>
<h2 id="获取JNI调用链"><a href="#获取JNI调用链" class="headerlink" title="获取JNI调用链"></a>获取JNI调用链</h2><h3 id="Ⅰ-通过jmethodID获得函数名"><a href="#Ⅰ-通过jmethodID获得函数名" class="headerlink" title="Ⅰ.通过jmethodID获得函数名"></a>Ⅰ.通过jmethodID获得函数名</h3><p>jmethodID在内存中实际上是指向ArtMethod结构的指针，也就是说，通过jmethodID可以获得ArtMethod在内存的位置。在libart中有一个函数叫PrettyMethod，往这个函数输入ArtMethod对象，可以打印出对应的函数名，而frida中就内置了这个函数的api。</p>
<p>至此，还有一个问题需要解决——PrettyMethod返回函数名存储在c++的std::string对象中，要对这个string进行合理的解析，才能获得最终的函数名。</p>
<p>安卓的arm64下，std::string类型一般占24字节，也就是3* pointerSize。</p>
<p>需要存储小的字符串时，一般会将字符串直接存在std::string的内存空间中，最多可以存24字节；而需要存储大的字符串时，会另外开辟一处堆空间，用来专门存放字符串的内容，而std::string的原24字节，会用来存储这样的结构：</p>
<ul>
<li><p>一个指向堆上字符数据的指针 (<code>char* data</code>)。</p>
</li>
<li><p>字符串的当前长度 (<code>size_t length</code>)。</p>
</li>
<li><p>当前分配的内存容量 (<code>size_t capacity</code>)。</p>
</li>
</ul>
<p>总结一下，我们输入一个jmethodID后，把它作为参数传给PrettyMethod后，需要对返回的string进行解析，获得函数名字符串地址，然后打印。</p>
<p>PS：至于如何区分小字符串存储还是大字符串存储，这里就不说咯。</p>
<p>下图是一个实现效果。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250531143219800.png" alt="image-20250531143219800" style="zoom:80%;" />

<p>在IDA中添加注释。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250531143445034.png" alt="image-20250531143445034"></p>
<h3 id="Ⅱ-hook-JNI调用"><a href="#Ⅱ-hook-JNI调用" class="headerlink" title="Ⅱ.hook JNI调用"></a>Ⅱ.hook JNI调用</h3><p>github上有大佬写过hook jni调用的frida脚本了，其原理是：hook上libart库中的函数——ArtMethod::Invoke。</p>
<p>ArtMethod::Invoke是ART中负责调用方法的核心函数，无论是Java方法还是JNI方法，最终都会通过Invoke执行。通过对这个函数的hook，可以获得整个进程的方法调用日志。</p>
<p>然而日志太杂乱了，需要筛选，我们只针对libxyass.so中的方法调用，通过反射，可以获取某个类的某个方法的jmethodID，然后反射执行；因此，我们只需要打印调用栈，只要在调用栈中，某个调用的地址在libxyass.so的映射范围内，就将这条日志记录下来。</p>
<p>大佬写的源代码没有过滤的代码，无过滤的、大量的console.log会导致进程卡死，无法获得我们想要的内容，于是我做了一些改动。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250531152135241.png" alt="image-20250531152135241"></p>
<p>其中地址0x6e1b4在CallObjectMethodV_函数的映射范围内。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250531152215305.png" alt="image-20250531152215305"></p>
<p>和我们第1个方法的日志结果一模一样。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250531152310852.png" alt="image-20250531152310852"></p>
<h2 id="分析shield加密点"><a href="#分析shield加密点" class="headerlink" title="分析shield加密点"></a>分析shield加密点</h2><p>为了获得加密函数的trace，这里有3种思路：</p>
<ol>
<li>使用IDA的trace功能；</li>
<li>使用frida-stalker的实现trace；</li>
<li>使用unidbg实现trace。</li>
</ol>
<p>我已经尝试过了第1、2种方式，耗时一天，无论怎么修改脚本，脚本始终跑得不稳定，最多一次trace了20w条指令，进程就崩溃了。</p>
<p>在这20w条指令中，没有看到shield字段的影子，那只能使用unidbg了，麻了。</p>
<h3 id="Unidbg补环境"><a href="#Unidbg补环境" class="headerlink" title="Unidbg补环境"></a>Unidbg补环境</h3><p>先照着其它项目的模板，搭建基础环境。</p>
<h4 id="1-获得ShieldLogger对象"><a href="#1-获得ShieldLogger对象" class="headerlink" title="1.获得ShieldLogger对象"></a>1.获得ShieldLogger对象</h4><p>跑起来后，遇到的第一个问题。</p>
<p>Unidbg的JNI实现调用AbstractJni子类中的getStaticObjectField来解析此字段，但Unidbg的原生实现并不能正确解析，需要子类进行覆写，也就是在我们创建的类中进行覆写。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602092607201.png" alt="image-20250602092607201"></p>
<p>找到getStaticOjectField的实现，然后模仿它的写法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; getStaticObjectField(BaseVM vm, DvmClass dvmClass, String signature) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;com/xingin/shield/http/ContextHolder-&gt;sLogger:Lcom/xingin/shield/http/ShieldLogger;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;com/xingin/shield/http/ShieldLogger&quot;</span>).newObject(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.getStaticObjectField(vm, dvmClass, signature);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后JNI_OnLoad顺利执行完了。</p>
<p>还记得这张图，在调用intercepte之前，需要先后执行initializeNative和initialize。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530144122340.png" alt="image-20250530144122340"></p>
<p>通过上述这2个函数，对so中的静态变量和传入的cPtr进行初始化。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250530143432846.png" alt="image-20250530143432846"></p>
<p>因此，先要调用initializeNative和initialize。通过hook，发现initialize的参数始终是main。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602095412021.png" alt="image-20250602095412021" style="zoom:80%;" />

<p>先创建3个变量。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602095651106.png" alt="image-20250602095651106" style="zoom:80%;" />

<p>然后在构造函数中进行初始化。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602095718995.png" alt="image-20250602095718995" style="zoom:80%;" />

<p>然后创建函数initializeNative和initialize。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602094439606.png" alt="image-20250602094439606"></p>
<p>调用这2个函数，接着进行补环境。</p>
<h4 id="2-模拟nativeInitializeStart执行"><a href="#2-模拟nativeInitializeStart执行" class="headerlink" title="2.模拟nativeInitializeStart执行"></a>2.模拟nativeInitializeStart执行</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602100137366.png" alt="image-20250602100137366"></p>
<p>Unidbg 尝试调用 ShieldLogger 类中定义的原生方法 nativeInitializeStart （一个无参数的 void 方法），但该方法未在您的 AbstractJni 子类中实现或正确处理。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602101257293.png" alt="image-20250602101257293"></p>
<p>不做处理，直接返回。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602101313387.png" alt="image-20250602101313387"></p>
<h4 id="3-模拟defaultCharset执行"><a href="#3-模拟defaultCharset执行" class="headerlink" title="3.模拟defaultCharset执行"></a>3.模拟defaultCharset执行</h4><p>AbstractJni的函数callStaticObjectMethodV未能对java.nio.charset.Charset类上的静态方法defaultCharset()正确解析，因此需要补环境，模拟defaultCharset。</p>
<p>在这里，我们直接调用Charset的defaultCharset，然后转换成DvmObject的类型传回去。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602105910172.png" alt="image-20250602105910172"></p>
<h4 id="4-获得sDeviceID"><a href="#4-获得sDeviceID" class="headerlink" title="4.获得sDeviceID"></a>4.获得sDeviceID</h4><p>我们需要获得设备id，然后转换成DvmObject类型传过去。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602110612112.png" alt="image-20250602110612112"></p>
<p>通过全局搜索，查找类com.xingin.shield.http.ContextHolder。</p>
<p>由于sDeviceId是一个静态变量，可以直接通过类名获取。——518dfe96-7f6f-370a-8e80-f94f8838e6de</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602111607731.png" alt="image-20250602111607731"></p>
<p>然后覆盖AbstractJni的getStaticObjectField。</p>
<p>对于常用的java内置的数据结构，unidbg封装了特别的函数，比如StringObject，就不需要dvmClass.newObject来转换。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602111830894.png" alt="image-20250602111830894"></p>
<h4 id="5-获得sAppId"><a href="#5-获得sAppId" class="headerlink" title="5.获得sAppId"></a>5.获得sAppId</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602112110292.png" alt="image-20250602112110292"></p>
<p>与第4个补环境的流程一样。——sAppId &#x3D; -319115519</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602112306831.png" alt="image-20250602112306831"></p>
<p>覆写。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602112515324.png" alt="image-20250602112515324" style="zoom:80%;" />

<h4 id="6-模拟nativeInitializeEnd执行"><a href="#6-模拟nativeInitializeEnd执行" class="headerlink" title="6.模拟nativeInitializeEnd执行"></a>6.模拟nativeInitializeEnd执行</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602113059847.png" alt="image-20250602113059847"></p>
<p>同样不做处理，直接返回。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602113325760.png" alt="image-20250602113325760" style="zoom:80%;" />

<h4 id="7-模拟initializeStart-执行"><a href="#7-模拟initializeStart-执行" class="headerlink" title="7.模拟initializeStart()执行"></a>7.模拟initializeStart()执行</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602113535063.png" alt="image-20250602113535063"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602113701419.png" alt="image-20250602113701419"></p>
<h4 id="8-获得SharedPreferences对象"><a href="#8-获得SharedPreferences对象" class="headerlink" title="8.获得SharedPreferences对象"></a>8.获得SharedPreferences对象</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602135837739.png" alt="image-20250602135837739"></p>
<p>根据报错提示，我们要返回构造好一个SharedPreferences对象。</p>
<p><code>SharedPreferences</code> 是 Android 提供的一种轻量级的数据存储机制。它允许应用程序以<strong>键值对 (key-value pairs)</strong> 的形式持久化存储一些简单的数据类型（如布尔值、浮点数、整数、长整数和字符串）。每个 Android 应用都可以有自己的 <code>SharedPreferences</code> 文件。这些文件存储在应用的私有目录（shared_prefs目录）下，默认情况下其他应用无法访问。它是一个<strong>接口 (Interface)</strong>。这意味着它定义了一套操作规范（比如如何读取数据 <code>getString()</code>, <code>getInt()</code>，如何写入数据 <code>edit().putString().commit()</code> 等），但具体的实现则由 Android 系统提供。</p>
<p><code>Context.getSharedPreferences(name, mode)</code> 是获取或创建特定名称的 <code>SharedPreferences</code> 实例的<strong>标准途径</strong>。你调用这个方法，传入你想要操作的配置文件的名字，然后系统会返回一个实现了 <code>SharedPreferences</code> 接口的对象，你可以通过这个对象来读写数据。</p>
<p>补环境的代码如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602141349585.png" alt="image-20250602141349585"></p>
<p>注意，这里的newObject(getSharedPreferences_arg0)并不是调用构造函数，含义如下图所示。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602141224286.png" alt="image-20250602141224286" style="zoom: 50%;" />

<h4 id="9-实现函数SharedPreferences-getString"><a href="#9-实现函数SharedPreferences-getString" class="headerlink" title="9.实现函数SharedPreferences-&gt;getString()"></a>9.实现函数SharedPreferences-&gt;getString()</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602141607771.png" alt="image-20250602141607771"></p>
<p>上一步中，获得了SharedPreferences对象，这里需要通过getString获得value。</p>
<p>通过unidbg，可以打印arg0的值，是“s”。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602142002516.png" alt="image-20250602142002516"></p>
<p>因此，我们去看看xhs私有目录下有没有名为s的文件。——这些文件在原apk中没有，属于服务器下发给客户端的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602142530501.png" alt="image-20250602142530501"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602142720277.png" alt="image-20250602142720277"></p>
<p>android&#x2F;content&#x2F;SharedPreferences-&gt;getString(Ljava&#x2F;lang&#x2F;String;Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;String;的逻辑是这样的：输入2个字符串arg0、v2，输出1个字符串v1；这个函数会获取键arg0对应的值，如果没有，默认返回v2，如果找到了建arg0的值，返回v1。</p>
<p>先通过unidbg获取访问了哪些键。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602144138579.png" alt="image-20250602144138579"></p>
<p>已知main是不存在，s.xml里就放了一个main_hmac，所以可以这么写。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602144524947.png" alt="image-20250602144524947"></p>
<p>为了方便观察，我把返回的结果也打印了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602144729643.png" alt="image-20250602144729643"></p>
<h4 id="10-模拟Base64Helper-decode-执行"><a href="#10-模拟Base64Helper-decode-执行" class="headerlink" title="10.模拟Base64Helper-&gt;decode()执行"></a>10.模拟Base64Helper-&gt;decode()执行</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602144914722.png" alt="image-20250602144914722"></p>
<p>需要返回解码后的字节数组。</p>
<p>可以调用Base64类进行解码，然后通过unidbg对Byte数组的封装函数，返回回去。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602145728193.png" alt="image-20250602145728193"></p>
<h4 id="11-模拟initializedEnd-执行"><a href="#11-模拟initializedEnd-执行" class="headerlink" title="11.模拟initializedEnd()执行"></a>11.模拟initializedEnd()执行</h4><p>一样对initializedEnd()不做处理。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602164905684.png" alt="image-20250602164905684"></p>
<h4 id="12-至此，完成了对initializeNative-和initialize-的调用，接下来对intercepte进行主动调用"><a href="#12-至此，完成了对initializeNative-和initialize-的调用，接下来对intercepte进行主动调用" class="headerlink" title="12.至此，完成了对initializeNative()和initialize()的调用，接下来对intercepte进行主动调用"></a>12.至此，完成了对initializeNative()和initialize()的调用，接下来对intercepte进行主动调用</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602165136924.png" alt="image-20250602165136924"></p>
<h4 id="13-构造一个空的chain对象"><a href="#13-构造一个空的chain对象" class="headerlink" title="13.构造一个空的chain对象"></a>13.构造一个空的chain对象</h4><p>添加chain。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602175649847.png" alt="image-20250602175649847" style="zoom:80%;" />

<p>调用get_shield()。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602175726431.png" alt="image-20250602175726431"></p>
<h4 id="14-模拟com-xingin-shield-http-ShieldLogger-buildSourceStart-执行"><a href="#14-模拟com-xingin-shield-http-ShieldLogger-buildSourceStart-执行" class="headerlink" title="14.模拟com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;buildSourceStart()执行"></a>14.模拟com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;buildSourceStart()执行</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602175843374.png" alt="image-20250602175843374"></p>
<p>补环境。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602175950460.png" alt="image-20250602175950460" style="zoom:80%;" />

<h4 id="15-下载okhttp3框架，模拟okhttp3-Interceptor-Chain-request-执行"><a href="#15-下载okhttp3框架，模拟okhttp3-Interceptor-Chain-request-执行" class="headerlink" title="15.下载okhttp3框架，模拟okhttp3&#x2F;Interceptor$Chain-&gt;request()执行"></a>15.下载okhttp3框架，模拟okhttp3&#x2F;Interceptor$Chain-&gt;request()执行</h4><p>遇到报错。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602180840982.png" alt="image-20250602180840982"></p>
<p>在pom.xml中，添加okhttp3的包，注意缩进。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>保存，并构造request对象。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602180806704.png" alt="image-20250602180806704"></p>
<p>补环境。这里的request是一种标记,可以通过DvmObject.getValue()取出来request的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602181715577.png" alt="image-20250602181715577"></p>
<h4 id="16-模拟okhttp3-Interceptor-Chain-request-执行"><a href="#16-模拟okhttp3-Interceptor-Chain-request-执行" class="headerlink" title="16.模拟okhttp3&#x2F;Interceptor$Chain-&gt;request()执行"></a>16.模拟okhttp3&#x2F;Interceptor$Chain-&gt;request()执行</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602181311120.png" alt="image-20250602181311120"></p>
<p>这里的request.url也是一种标记，可以通过DvmObject.getValue()取出来request.url()的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602181727986.png" alt="image-20250602181727986"></p>
<h4 id="17-模拟执行okhttp3-HttpUrl-encodedPath"><a href="#17-模拟执行okhttp3-HttpUrl-encodedPath" class="headerlink" title="17.模拟执行okhttp3&#x2F;HttpUrl-&gt;encodedPath()"></a>17.模拟执行okhttp3&#x2F;HttpUrl-&gt;encodedPath()</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602182110508.png" alt="image-20250602182110508"></p>
<p>需要通过getValue取出具体的值，然后调用okhttp3.HttpUrl的encodedQuery()，将返回值转换为DvmObject类型返回去，由于这里是返回字符串，有专门的封装函数StringObject。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602182317628.png" alt="image-20250602182317628" style="zoom:80%;" />

<h4 id="18-模拟执行okhttp3-HttpUrl-encodedPath"><a href="#18-模拟执行okhttp3-HttpUrl-encodedPath" class="headerlink" title="18.模拟执行okhttp3&#x2F;HttpUrl-&gt;encodedPath()"></a>18.模拟执行okhttp3&#x2F;HttpUrl-&gt;encodedPath()</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602182607946.png" alt="image-20250602182607946"></p>
<p>一样的原理。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602182602826.png" alt="image-20250602182602826"></p>
<h4 id="19-空字符串异常"><a href="#19-空字符串异常" class="headerlink" title="19.空字符串异常"></a>19.空字符串异常</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602182843174.png" alt="image-20250602182843174"></p>
<p>根据提示，这里的httpUrlObj_encodedQuery.encodedQuery()返回的是空字符串，即null。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602182910797.png" alt="image-20250602182910797"></p>
<p>方法encodedQuery是用来返回url请求?后面参数用的，而我们的url没有添加?。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602183041973.png" alt="image-20250602183041973"></p>
<h4 id="20-模拟执行okhttp3-Request-body"><a href="#20-模拟执行okhttp3-Request-body" class="headerlink" title="20.模拟执行okhttp3&#x2F;Request-&gt;body()"></a>20.模拟执行okhttp3&#x2F;Request-&gt;body()</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602183118874.png" alt="image-20250602183118874"></p>
<p>复杂对象都用newObject打上标记即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;okhttp3/Request-&gt;body()Lokhttp3/RequestBody;&quot;</span>:</span><br><span class="line">	<span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/RequestBody&quot;</span>).newObject(request.body());</span><br></pre></td></tr></table></figure>

<h4 id="21-模拟执行okhttp3-Request-headers"><a href="#21-模拟执行okhttp3-Request-headers" class="headerlink" title="21.模拟执行okhttp3&#x2F;Request-&gt;headers()"></a>21.模拟执行okhttp3&#x2F;Request-&gt;headers()</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602183451505.png" alt="image-20250602183451505"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;okhttp3/Request-&gt;headers()Lokhttp3/Headers;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/Headers&quot;</span>).newObject(request.headers());</span><br></pre></td></tr></table></figure>

<h4 id="22-模拟构造函数okio-Buffer"><a href="#22-模拟构造函数okio-Buffer" class="headerlink" title="22.模拟构造函数okio&#x2F;Buffer-&gt;&lt;init&gt;()"></a>22.模拟构造函数okio&#x2F;Buffer-&gt;&lt;init&gt;()</h4><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602191745460.png" alt="image-20250602191745460" style="zoom: 67%;" />

<p>在AbstractJni.newObjectV中，实现了很多构造函数。</p>
<p>现在需要往里面添加okio.Buffer类的构造函数。</p>
<p>观察原有的构造函数实现，其实是往newObject里面存放构造函数后的初始值。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602192421858.png" alt="image-20250602192421858" style="zoom:80%;" />

<p>而okio&#x2F;Buffer-&gt;&lt;init&gt;()是无参构造函数，所以代码应该这么写。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602192939068.png" alt="image-20250602192939068" style="zoom:80%;" />

<h4 id="23-模拟okio-Buffer-writeString-Ljava-lang-String-Ljava-nio-charset-Charset-Lokio-Buffer"><a href="#23-模拟okio-Buffer-writeString-Ljava-lang-String-Ljava-nio-charset-Charset-Lokio-Buffer" class="headerlink" title="23.模拟okio&#x2F;Buffer-&gt;writeString(Ljava&#x2F;lang&#x2F;String;Ljava&#x2F;nio&#x2F;charset&#x2F;Charset;)Lokio&#x2F;Buffer;"></a>23.模拟okio&#x2F;Buffer-&gt;writeString(Ljava&#x2F;lang&#x2F;String;Ljava&#x2F;nio&#x2F;charset&#x2F;Charset;)Lokio&#x2F;Buffer;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602193106537.png" alt="image-20250602193106537"></p>
<p>函数writeString的返回值是Lokio&#x2F;Buffer，也就是说，我们可以取出Buffer实例，取出2个参数，然后调用writeString，最后将结果转换成DvmObject类型。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602193747833.png" alt="image-20250602193747833" style="zoom:80%;" />

<h4 id="24-模拟okhttp3-Headers-size-I"><a href="#24-模拟okhttp3-Headers-size-I" class="headerlink" title="24.模拟okhttp3&#x2F;Headers-&gt;size()I"></a>24.模拟okhttp3&#x2F;Headers-&gt;size()I</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602193837056.png" alt="image-20250602193837056"></p>
<p>补环境。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602194159163.png" alt="image-20250602194159163"></p>
<h4 id="25-模拟执行okhttp3-Headers-name-I-Ljava-lang-String"><a href="#25-模拟执行okhttp3-Headers-name-I-Ljava-lang-String" class="headerlink" title="25.模拟执行okhttp3&#x2F;Headers-&gt;name(I)Ljava&#x2F;lang&#x2F;String;"></a>25.模拟执行okhttp3&#x2F;Headers-&gt;name(I)Ljava&#x2F;lang&#x2F;String;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602194250684.png" alt="image-20250602194250684"></p>
<p>已经熟练补环境了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602194501997.png" alt="image-20250602194501997" style="zoom:80%;" />

<h4 id="26-模拟执行okhttp3-Headers-value-I-Ljava-lang-String"><a href="#26-模拟执行okhttp3-Headers-value-I-Ljava-lang-String" class="headerlink" title="26.模拟执行okhttp3&#x2F;Headers-&gt;value(I)Ljava&#x2F;lang&#x2F;String;"></a>26.模拟执行okhttp3&#x2F;Headers-&gt;value(I)Ljava&#x2F;lang&#x2F;String;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602194609745.png" alt="image-20250602194609745"></p>
<p>补环境。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602194728717.png" alt="image-20250602194728717" style="zoom:80%;" />

<h4 id="27-模拟执行okhttp3-RequestBody-writeTo-Lokio-BufferedSink-V"><a href="#27-模拟执行okhttp3-RequestBody-writeTo-Lokio-BufferedSink-V" class="headerlink" title="27.模拟执行okhttp3&#x2F;RequestBody-&gt;writeTo(Lokio&#x2F;BufferedSink;)V"></a>27.模拟执行okhttp3&#x2F;RequestBody-&gt;writeTo(Lokio&#x2F;BufferedSink;)V</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602194931038.png" alt="image-20250602194931038"></p>
<p>这里不能像以前一样直接返回return了，得先完成目标操作，再return。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602195806272.png" alt="image-20250602195806272"></p>
<h4 id="28-模拟执行com-xingin-shield-http-ShieldLogger-buildSourceEnd-V"><a href="#28-模拟执行com-xingin-shield-http-ShieldLogger-buildSourceEnd-V" class="headerlink" title="28.模拟执行com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;buildSourceEnd()V"></a>28.模拟执行com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;buildSourceEnd()V</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602195956838.png" alt="image-20250602195956838"></p>
<p>补环境。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602200318384.png" alt="image-20250602200318384"></p>
<h4 id="29-模拟执行com-xingin-shield-http-ShieldLogger-calculateStart-V"><a href="#29-模拟执行com-xingin-shield-http-ShieldLogger-calculateStart-V" class="headerlink" title="29.模拟执行com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;calculateStart()V"></a>29.模拟执行com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;calculateStart()V</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602200341328.png" alt="image-20250602200341328"></p>
<p>补环境。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602200309079.png" alt="image-20250602200309079"></p>
<h4 id="30-模拟执行okio-Buffer-clone-Lokio-Buffer"><a href="#30-模拟执行okio-Buffer-clone-Lokio-Buffer" class="headerlink" title="30.模拟执行okio&#x2F;Buffer-&gt;clone()Lokio&#x2F;Buffer;"></a>30.模拟执行okio&#x2F;Buffer-&gt;clone()Lokio&#x2F;Buffer;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602200445181.png" alt="image-20250602200445181"></p>
<p>补环境。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602200937658.png" alt="image-20250602200937658"></p>
<h4 id="31-模拟执行okio-Buffer-read-B-I"><a href="#31-模拟执行okio-Buffer-read-B-I" class="headerlink" title="31.模拟执行okio&#x2F;Buffer-&gt;read([B)I"></a>31.模拟执行okio&#x2F;Buffer-&gt;read([B)I</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602201000240.png" alt="image-20250602201000240"></p>
<p>补环境。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602201559098.png" alt="image-20250602201559098" style="zoom: 67%;" />

<h4 id="32-模拟执行com-xingin-shield-http-ShieldLogger-calculateEnd-V"><a href="#32-模拟执行com-xingin-shield-http-ShieldLogger-calculateEnd-V" class="headerlink" title="32.模拟执行com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;calculateEnd()V"></a>32.模拟执行com&#x2F;xingin&#x2F;shield&#x2F;http&#x2F;ShieldLogger-&gt;calculateEnd()V</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602201700874.png" alt="image-20250602201700874"></p>
<p>补环境的代码如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602201749046.png" alt="image-20250602201749046"></p>
<h4 id="33-模拟执行okhttp3-Request-newBuilder-Lokhttp3-Request-Builder"><a href="#33-模拟执行okhttp3-Request-newBuilder-Lokhttp3-Request-Builder" class="headerlink" title="33.模拟执行okhttp3&#x2F;Request-&gt;newBuilder()Lokhttp3&#x2F;Request$Builder;"></a>33.模拟执行okhttp3&#x2F;Request-&gt;newBuilder()Lokhttp3&#x2F;Request$Builder;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602201831543.png" alt="image-20250602201831543"></p>
<p>补环境的代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;okhttp3/Request$Builder-&gt;header(Ljava/lang/String;Ljava/lang/String;)Lokhttp3/Request$Builder;&quot;</span>:</span><br><span class="line">    Request.<span class="type">Builder</span> <span class="variable">builderObj_header</span> <span class="operator">=</span> (Request.Builder) dvmObject.getValue();</span><br><span class="line">    <span class="type">String</span> <span class="variable">header_arg0</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>).getValue().toString();</span><br><span class="line">    <span class="type">String</span> <span class="variable">header_arg1</span> <span class="operator">=</span> (String)vaList.getObjectArg(<span class="number">1</span>).getValue();</span><br><span class="line">    builderObj_header.header(header_arg0,header_arg1);</span><br><span class="line">    <span class="keyword">return</span> dvmObject;</span><br></pre></td></tr></table></figure>

<h4 id="34-模拟执行okhttp3-Request-newBuilder-Lokhttp3-Request-Builder"><a href="#34-模拟执行okhttp3-Request-newBuilder-Lokhttp3-Request-Builder" class="headerlink" title="34.模拟执行okhttp3&#x2F;Request-&gt;newBuilder()Lokhttp3&#x2F;Request$Builder;"></a>34.模拟执行okhttp3&#x2F;Request-&gt;newBuilder()Lokhttp3&#x2F;Request$Builder;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602201932209.png" alt="image-20250602201932209"></p>
<p>补环境的代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;okhttp3/Request-&gt;newBuilder()Lokhttp3/Request$Builder;&quot;</span>:</span><br><span class="line">    <span class="type">Request</span> <span class="variable">requestObj_newBuilder</span> <span class="operator">=</span> (Request) dvmObject.getValue();</span><br><span class="line">    <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/Request$Builder&quot;</span>).newObject(requestObj_newBuilder.newBuilder());</span><br></pre></td></tr></table></figure>

<h4 id="35-模拟执行okhttp3-Request-Builder-build-Lokhttp3-Request"><a href="#35-模拟执行okhttp3-Request-Builder-build-Lokhttp3-Request" class="headerlink" title="35.模拟执行okhttp3&#x2F;Request$Builder-&gt;build()Lokhttp3&#x2F;Request;"></a>35.模拟执行okhttp3&#x2F;Request$Builder-&gt;build()Lokhttp3&#x2F;Request;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602202115517.png" alt="image-20250602202115517"></p>
<p>补环境的代码如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602202240171.png" alt="image-20250602202240171"></p>
<h4 id="36-模拟执行okhttp3-Interceptor-Chain-proceed-Lokhttp3-Request-Lokhttp3-Response"><a href="#36-模拟执行okhttp3-Interceptor-Chain-proceed-Lokhttp3-Request-Lokhttp3-Response" class="headerlink" title="36.模拟执行okhttp3&#x2F;Interceptor$Chain-&gt;proceed(Lokhttp3&#x2F;Request;)Lokhttp3&#x2F;Response;"></a>36.模拟执行okhttp3&#x2F;Interceptor$Chain-&gt;proceed(Lokhttp3&#x2F;Request;)Lokhttp3&#x2F;Response;</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602202326256.png" alt="image-20250602202326256"></p>
<p>这里不需要模拟proceed的执行，因为proceed用于发送请求，说明字段shield已经添加好了，我们不关注发包，只关注shield是如何加密的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602202508983.png" alt="image-20250602202508983"></p>
<h4 id="37-模拟状态码"><a href="#37-模拟状态码" class="headerlink" title="37.模拟状态码"></a>37.模拟状态码</h4><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602202616539.png" alt="image-20250602202616539"></p>
<p>直接返回200。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602202657482.png" alt="image-20250602202657482" style="zoom:80%;" />

<p>至此，总算是模拟完成了——37个要补充的地方，快累死了。</p>
<h4 id="38-获得shield"><a href="#38-获得shield" class="headerlink" title="38.获得shield"></a>38.获得shield</h4><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602202919661.png" alt="image-20250602202919661" style="zoom:80%;" />

<p>然后打印的是null。</p>
<p>注意到，之前我们在模拟环境的时候，总会使用newObject创建一个新的Request对象返回去，request的值其实始终没改变，因此，我们需要知道，最后一次返回Request类型的对象是哪个函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602203351055.png" alt="image-20250602203351055" style="zoom:80%;" />

<p>来到这个代码的地方，添加一句为request赋值的语句，更新request的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602203429152.png" alt="image-20250602203429152"></p>
<p>再次查看shield，这回有结果了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250602203508023.png" alt="image-20250602203508023"></p>
<p>全部代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xhs;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.AndroidEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.api.Binder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.api.Bundle;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.api.ServiceManager;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.api.Signature;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.array.ByteArray;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.wrapper.DvmBoolean;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.wrapper.DvmInteger;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> okhttp3.*;</span><br><span class="line"><span class="keyword">import</span> okio.Buffer;</span><br><span class="line"><span class="keyword">import</span> okio.BufferedSink;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.binary.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.NoSuchPaddingException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateException;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XHS_shield</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AndroidEmulator emulator; <span class="comment">// 静态属性，以后对象和类都可以直接使用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Memory memory; <span class="comment">// 内存</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> VM vm; <span class="comment">// 虚拟机</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Module <span class="keyword">module</span>; <span class="comment">// 要加载的模块</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">DvmClass</span> <span class="variable">XhsInterceptor</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DvmObject XhsInterceptorObject;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> cPtr;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">DvmObject</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">public</span> Request request;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">XHS_shield</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// 64位虚拟设备，进程名为XHS</span></span><br><span class="line">        emulator = AndroidEmulatorBuilder.for64Bit().setProcessName(<span class="string">&quot;XHS&quot;</span>).build();</span><br><span class="line">        <span class="comment">// 获得内存对象</span></span><br><span class="line">        memory = emulator.getMemory();</span><br><span class="line">        <span class="comment">// 设置安卓sdk版本</span></span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>));</span><br><span class="line">        <span class="comment">// 创建虚拟机</span></span><br><span class="line">        vm = emulator.createDalvikVM(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/resources/xhs_pack/xhs.apk&quot;</span>));</span><br><span class="line">        <span class="comment">// 开启JNI互动</span></span><br><span class="line">        vm.setJni(<span class="built_in">this</span>); <span class="comment">// 后期补环境会用，把要补的环境写到当前类中，执行这个代码即可，但是必须要继承AbstractJni</span></span><br><span class="line">        <span class="comment">// 加载目标so</span></span><br><span class="line">        <span class="type">DalvikModule</span> <span class="variable">dm</span> <span class="operator">=</span> vm.loadLibrary(<span class="string">&quot;xyass&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 调用jni_onload</span></span><br><span class="line">        dm.callJNI_OnLoad(emulator);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = dm.getModule(); <span class="comment">// 把so加载到内存后，可以获得基地址、偏移量，该变量代指so文件</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析XhsInterceptor</span></span><br><span class="line">        XhsInterceptor = vm.resolveClass(<span class="string">&quot;com/xingin/shield/http/XhsHttpInterceptor&quot;</span>);</span><br><span class="line">        <span class="comment">// 获得一个空chain</span></span><br><span class="line"><span class="comment">//        chain = vm.resolveClass(&quot;okhttp3/Interceptor$Chain&quot;).newObject(null);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造url和request</span></span><br><span class="line">        url = <span class="string">&quot;https://edith.xiaohongshu.com/api/sns/v4/user/login/password?&quot;</span>;</span><br><span class="line">        request = <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                .url(url)</span><br><span class="line">                .addHeader(<span class="string">&quot;xy-direction&quot;</span>,<span class="string">&quot;88&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;X-B3-TraceId&quot;</span>,<span class="string">&quot;4b4bdb48881d080f&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-xray-traceid&quot;</span>,<span class="string">&quot;cb1441a76a4a081ecd469a26f3706ad0&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;xy-scene&quot;</span>,<span class="string">&quot;fs=0&amp;point=1932&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-legacy-did&quot;</span>,<span class="string">&quot;f10f91f68-7db7-3a36-80c9-703abad8fee2&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-legacy-fid&quot;</span>,<span class="string">&quot;17442981081013d20c9158a0a9b29abbcbb1ed726f5b&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-legacy-sid&quot;</span>,<span class="string">&quot;session.1744300626655701629150&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-mini-gid&quot;</span>,<span class="string">&quot;7c0d68e8647a5438a2394bbad364c2bdf31b98794735944077bbfc55&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-mini-s1&quot;</span>,<span class="string">&quot;ABsAAAABKjIUDN/qnVyFrjdjCBjTNhmOGE0SjnzqstjuHWyj5wVhUjSgHTzsuqoPKuiiOhD4JesIeK1AX8w=&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-mini-sig&quot;</span>,<span class="string">&quot;a619346fd57b0f2494eb8e197cf8fe6bb33cd62241a67e03343700de0ab8b8ff&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;x-mini-mua&quot;</span>,<span class="string">&quot;eyJhIjoiRUNGQUFGMDEiLCJjIjo0MSwiayI6ImQzNjkxYjYzMGJhODNmODljZTM0M2Q5NDlmODU2NTcyNzY5NTg2YTA5YzhmNTJhMjgzNWNiYjhjZjYxZTAwMTciLCJwIjoiYSIsInMiOiJkZmQ0OTI4ZWZlNTA5NDg1MTg5ZmJjOGEwMGRmMmMwYyIsInQiOnsiYyI6NDgsImQiOjQsImYiOjAsInMiOjQwOTgsInQiOjE3NDY3MTQwLCJ0dCI6WzFdfSwidSI6IjAwMDAwMDAwMmMwOGQwYWI0ZDdlNjExMjM4NmU2YmEyOTljZjAzNzIiLCJ2IjoiMi44LjUifQ.r2k40ztxFkHb9YD9W-r8ktVwWcyCuRLf0MmPFBWxV-9voigXNb_Bkvc3Vf8X3qs2wwcX2CpuPWIpylpfB9dwGR_CB3GAZrG1NpfKMjoDZh3Q6VAtuROrlVc7eAi-SqcGE-Z7GoU5tDth4LC9Fg0lbTIa6w6T6WTD_7QUlGroY8huQKkU26M7Whhv7nIFZQtkleznZtw276pAfbuvqyM9zMJb6TN4vqSrPeRRBBIn-7vgTNYF5pS7sF3yeshHP9BbS5QgFACF2I5iBo-z2dSMJkPeyPltMlabkqqJcf4fAjbqECYOCZusmkHXTfFk7-bwTYTW2TzeFFOBYMXNwBWKeOXe4aRqCcqbkjQQzPnJ3EHL-rzXCnKPv7Uf63MfEVxq9LqG398kwYNbUfkRdiGeM_X3OrwBLQ54cmA9jQa25L5jNzUo_2s1dS4Heg1EsEkLtNhAD9zDYDmjRpY6lbe94i_5oWLux8USIomK6_-TbvoEm1w3A51MwcJMVtiop-klqFRHEkazDUQA-76XS1Ogptxo9JpFSSYQt-S6Wet8nvg344UHUuhmXx7bb-gPYepYR6CQOt6EuCNOmLUIDLo0GgniHf2VJNQieSDxuYUIO3EGOXiwzxxB4Lv0TeSRTdqc8U7bLOb-GPeh49my4YWFHVcWEsqRO55EawZF0MSL4aekkiC5ZMm1SpoaJ60XKKVhNfG7sYf7LmIs6kMd3tNFFjvs3CFNlFgu58falTh13_W-sGsMZS3e-Cvlh6PKHic4l36rF2NH1xa2XmbY_VJzQyPm6tlD57IX89HocmwL1emORGPUx6EkhEkgbU-ZiXKcXmEC4W3njsliIc4HY18MurQmn2szKA4Kyl0Yo05igx5DlpJedTiALaaczSuaPr9Ko5xbcrSeFzFPc682BPkwZ1z8H-Hb5ljHDi2wqdvHepBVf8f96SbPEobd52wRjKh4hgdwxuUrKiM4JD3fxlCheGkLvMByCEXL3pP3oMMk7Bjblf-a_qw8cPdjzj_XOzrlcr-gWq1y79AyoyIF3CEri04uJEvnauaNNqLYOjWUYidJiuHdfpj0hQ3o-tEv19hiA4Qx_Bn_qG8BQEpVgksCTu9iwrIaeCjCZ486-waE09M.&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;xy-common-params&quot;</span>,<span class="string">&quot;fid=17442981081013d20c9158a0a9b29abbcbb1ed726f5b&amp;gid=7c0d68e8647a5438a2394bbad364c2bdf31b98794735944077bbfc55&amp;device_model=phone&amp;tz=Asia%2FShanghai&amp;channel=Vivo&amp;versionName=8.77.0&amp;deviceId=10f91f68-7db7-3a36-80c9-703abad8fee2&amp;platform=android&amp;sid=session.1744300626655701629150&amp;identifier_flag=4&amp;project_id=ECFAAF&amp;x_trace_page_current=login_full_screen_pwd_page&amp;lang=zh-Hans&amp;app_id=ECFAAF01&amp;uis=light&amp;teenager=0&amp;active_ctry=CN&amp;cpu_name=Qualcomm+Technologies%2C+Inc+SM8150&amp;dlang=zh&amp;launch_id=1744436392&amp;overseas_channel=0&amp;mlanguage=zh_cn&amp;folder_type=none&amp;auto_trans=0&amp;t=1744436385&amp;build=8770299&amp;holder_ctry=CN&amp;did=2d351bbef1db838c5fcd6b67a4aa1db5&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;User-Agent&quot;</span>,<span class="string">&quot;Dalvik/2.1.0 (Linux; U; Android 13; Pixel 4 XL Build/TP1A.221005.002.B2) Resolution/1440*3040 Version/8.77.0 Build/8770299 Device/(Google;Pixel 4 XL) discover/8.77.0 NetType/WiFi&quot;</span>)</span><br><span class="line">                .addHeader(<span class="string">&quot;Referer&quot;</span>,<span class="string">&quot;https://app.xhs.cn/&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; getStaticObjectField(BaseVM vm, DvmClass dvmClass, String signature) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;com/xingin/shield/http/ContextHolder-&gt;sLogger:Lcom/xingin/shield/http/ShieldLogger;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;com/xingin/shield/http/ShieldLogger&quot;</span>).newObject(<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;com/xingin/shield/http/ContextHolder-&gt;sDeviceId:Ljava/lang/String;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="string">&quot;518dfe96-7f6f-370a-8e80-f94f8838e6de&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getStaticObjectField(vm, dvmClass, signature);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">callVoidMethodV</span><span class="params">(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;nativeInitializeStart()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;nativeInitializeStart() trap!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;nativeInitializeEnd()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;nativeInitializeEnd() trap&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;initializeStart()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;initializeStart() trap&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;initializedEnd()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;initializedEnd() trap&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;buildSourceStart()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;buildSourceStart trap&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;okhttp3/RequestBody-&gt;writeTo(Lokio/BufferedSink;)V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;writeTo trap&quot;</span>);</span><br><span class="line">            <span class="type">RequestBody</span> <span class="variable">requestBody</span> <span class="operator">=</span> (RequestBody) dvmObject.getValue();</span><br><span class="line">            <span class="type">BufferedSink</span> <span class="variable">bufferedSink</span> <span class="operator">=</span> (BufferedSink) vaList.getObjectArg(<span class="number">0</span>).getValue();</span><br><span class="line">            <span class="keyword">if</span>(requestBody == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                requestBody.writeTo(bufferedSink);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;buildSourceEnd()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;calculateStart()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ShieldLogger-&gt;calculateEnd()V&quot;</span>.equals(signature))&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>.callVoidMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; callStaticObjectMethodV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(signature)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;java/nio/charset/Charset-&gt;defaultCharset()Ljava/nio/charset/Charset;&quot;</span>: &#123;</span><br><span class="line">                <span class="keyword">return</span> dvmClass.newObject(Charset.defaultCharset());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;com/xingin/shield/http/Base64Helper-&gt;decode(Ljava/lang/String;)[B&quot;</span>:&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">getString_arg0</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>).getValue().toString();</span><br><span class="line">                System.out.println(<span class="string">&quot;Base64Helper arg0: &quot;</span> + getString_arg0);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, Base64.decodeBase64(getString_arg0));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.callStaticObjectMethodV(vm, dvmClass, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStaticIntField</span><span class="params">(BaseVM vm, DvmClass dvmClass, String signature)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;com/xingin/shield/http/ContextHolder-&gt;sAppId:I&quot;</span>.equals(signature))&#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">319115519</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getStaticIntField(vm, dvmClass, signature);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList)&#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;android/content/Context-&gt;getSharedPreferences(Ljava/lang/String;I)Landroid/content/SharedPreferences;&quot;</span>:&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">getSharedPreferences_arg0</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>).getValue().toString();</span><br><span class="line">                System.out.println(<span class="string">&quot;arg0 = &quot;</span> + getSharedPreferences_arg0);</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;android/content/SharedPreferences&quot;</span>).newObject(getSharedPreferences_arg0);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;android/content/SharedPreferences-&gt;getString(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;&quot;</span>:&#123;</span><br><span class="line">                <span class="keyword">if</span>(dvmObject.getValue().toString().equals(<span class="string">&quot;s&quot;</span>))&#123;  <span class="comment">// 获取getSharedPreferences_arg0</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">getString_arg0</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>).getValue().toString(); <span class="comment">// 获取键</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">getString_arg1</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">1</span>).getValue().toString(); <span class="comment">// 获得默认值</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;key: &quot;</span> + getString_arg0);</span><br><span class="line">                    System.out.println(<span class="string">&quot;default_value: &quot;</span> + getString_arg1);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (getString_arg0.equals(<span class="string">&quot;main_hmac&quot;</span>)) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;SharedPreferences -&gt; getString(): &quot;</span> + <span class="string">&quot;Msm7d4eAmQVoQie97ci+UCY3fL6YKxBwT2qSuID0IOxYqWkpyRFdN6bM2LvQTlPzdQ5qkkJx/T2QMa8V/z+zkKAqh1mZevC+GYm8UJDPuZKbSI/ROWnKwlTiCvIMHEyY&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm,<span class="string">&quot;Msm7d4eAmQVoQie97ci+UCY3fL6YKxBwT2qSuID0IOxYqWkpyRFdN6bM2LvQTlPzdQ5qkkJx/T2QMa8V/z+zkKAqh1mZevC+GYm8UJDPuZKbSI/ROWnKwlTiCvIMHEyY&quot;</span>);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;SharedPreferences -&gt; getString(): &quot;</span> + getString_arg1);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, getString_arg1);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Interceptor$Chain-&gt;request()Lokhttp3/Request;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/Request&quot;</span>).newObject(request);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Request-&gt;url()Lokhttp3/HttpUrl;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/HttpUrl&quot;</span>).newObject(request.url());</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/HttpUrl-&gt;encodedQuery()Ljava/lang/String;&quot;</span>:&#123;</span><br><span class="line">                <span class="type">HttpUrl</span> <span class="variable">httpUrlObj_encodedQuery</span> <span class="operator">=</span> (HttpUrl) dvmObject.getValue();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, httpUrlObj_encodedQuery.encodedQuery());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/HttpUrl-&gt;encodedPath()Ljava/lang/String;&quot;</span>:&#123;</span><br><span class="line">                <span class="type">HttpUrl</span> <span class="variable">httpUrl</span> <span class="operator">=</span> (HttpUrl) dvmObject.getValue();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, httpUrl.encodedPath());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Request-&gt;body()Lokhttp3/RequestBody;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/RequestBody&quot;</span>).newObject(request.body());</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Request-&gt;headers()Lokhttp3/Headers;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/Headers&quot;</span>).newObject(request.headers());</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okio/Buffer-&gt;writeString(Ljava/lang/String;Ljava/nio/charset/Charset;)Lokio/Buffer;&quot;</span>:&#123;</span><br><span class="line">                <span class="type">Buffer</span> <span class="variable">buffer</span> <span class="operator">=</span> (Buffer) dvmObject.getValue(); <span class="comment">// 取出实例</span></span><br><span class="line">                <span class="comment">// 取出参数</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">arg0</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>).getValue().toString();</span><br><span class="line">                <span class="type">Charset</span> <span class="variable">arg1</span> <span class="operator">=</span> (Charset) vaList.getObjectArg(<span class="number">1</span>).getValue();</span><br><span class="line">                <span class="comment">// 调用writeString</span></span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okio/Buffer&quot;</span>).newObject(buffer.writeString(arg0, arg1));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Headers-&gt;name(I)Ljava/lang/String;&quot;</span>:&#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">arg0</span> <span class="operator">=</span> vaList.getIntArg(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, ((Headers)dvmObject.getValue()).name(arg0));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Headers-&gt;value(I)Ljava/lang/String;&quot;</span>:&#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">arg0</span> <span class="operator">=</span> vaList.getIntArg(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, ((Headers)dvmObject.getValue()).value(arg0));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okio/Buffer-&gt;clone()Lokio/Buffer;&quot;</span>:&#123;</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okio/Buffer&quot;</span>).newObject(((Buffer)dvmObject.getValue()).clone());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Request$Builder-&gt;header(Ljava/lang/String;Ljava/lang/String;)Lokhttp3/Request$Builder;&quot;</span>:&#123;</span><br><span class="line">                Request.<span class="type">Builder</span> <span class="variable">builderObj_header</span> <span class="operator">=</span> (Request.Builder) dvmObject.getValue();</span><br><span class="line">                <span class="type">String</span> <span class="variable">header_arg0</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>).getValue().toString();</span><br><span class="line">                <span class="type">String</span> <span class="variable">header_arg1</span> <span class="operator">=</span> (String)vaList.getObjectArg(<span class="number">1</span>).getValue();</span><br><span class="line">                builderObj_header.header(header_arg0,header_arg1);</span><br><span class="line">                <span class="keyword">return</span> dvmObject;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Request-&gt;newBuilder()Lokhttp3/Request$Builder;&quot;</span>:&#123;</span><br><span class="line">                <span class="type">Request</span> <span class="variable">requestObj_newBuilder</span> <span class="operator">=</span> (Request) dvmObject.getValue();</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/Request$Builder&quot;</span>).newObject(requestObj_newBuilder.newBuilder());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Request$Builder-&gt;build()Lokhttp3/Request;&quot;</span>:&#123;</span><br><span class="line">                Request.Builder builderObj_build= (Request.Builder) dvmObject.getValue();</span><br><span class="line">                <span class="type">Request</span> <span class="variable">requestObj_build</span> <span class="operator">=</span> builderObj_build.build();</span><br><span class="line">                request = requestObj_build;</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/Request&quot;</span>).newObject(requestObj_build);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Interceptor$Chain-&gt;proceed(Lokhttp3/Request;)Lokhttp3/Response;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;okhttp3/Response&quot;</span>).newObject(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; newObjectV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okio/Buffer-&gt;&lt;init&gt;()V&quot;</span>:&#123;</span><br><span class="line">                <span class="keyword">return</span> dvmClass.newObject(<span class="keyword">new</span> <span class="title class_">Buffer</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.newObjectV(vm, dvmClass, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">callIntMethodV</span><span class="params">(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Headers-&gt;size()I&quot;</span>:&#123;</span><br><span class="line">                <span class="keyword">return</span> ((Headers) dvmObject.getValue()).size();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okio/Buffer-&gt;read([B)I&quot;</span>:&#123;</span><br><span class="line">                <span class="type">Buffer</span> <span class="variable">buffer</span> <span class="operator">=</span> (Buffer) dvmObject.getValue();</span><br><span class="line">                <span class="type">byte</span>[] bytes = (<span class="type">byte</span>[]) vaList.getObjectArg(<span class="number">0</span>).getValue();</span><br><span class="line">                <span class="keyword">return</span> buffer.read(bytes);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;okhttp3/Response-&gt;code()I&quot;</span>:&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">200</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.callIntMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用initialNative</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initializeNative</span><span class="params">()</span>&#123;</span><br><span class="line">        XhsInterceptor.callStaticJniMethod(emulator, <span class="string">&quot;initializeNative()V&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用initialize</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span>&#123;</span><br><span class="line">        XhsInterceptorObject = XhsInterceptor.newObject(<span class="literal">null</span>);</span><br><span class="line">        cPtr = XhsInterceptorObject.callJniMethodLong(emulator, <span class="string">&quot;initialize(Ljava/lang/String;)J&quot;</span>, <span class="string">&quot;main&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;cPtr = &quot;</span> + cPtr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用intercept</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">get_shield</span><span class="params">()</span>&#123;</span><br><span class="line">        chain = vm.resolveClass(<span class="string">&quot;okhttp3/Interceptor$Chain&quot;</span>).newObject(<span class="literal">null</span>);</span><br><span class="line">        DvmObject&lt;?&gt; response = XhsInterceptorObject.callJniMethodObject(emulator, <span class="string">&quot;intercept(Lokhttp3/Interceptor$Chain;J)Lokhttp3/Response;&quot;</span>, chain, cPtr);</span><br><span class="line">        System.out.println(<span class="string">&quot;response = &quot;</span> + response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">XHS_shield</span> <span class="variable">shield</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XHS_shield</span>();</span><br><span class="line">        shield.initializeNative();</span><br><span class="line">        shield.initialize();</span><br><span class="line">        shield.get_shield();</span><br><span class="line">        System.out.println(<span class="string">&quot;shield = &quot;</span> + shield.request.headers().get(<span class="string">&quot;shield&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>补环境补了好久，幸好有大佬们的博客，在补环境的过程中，我也逐渐学会了各式各样的unidbg补环境的方法，今天先歇一歇，明天开始trace指令流，分析加密点。——2025.6.2，晚上20:36。</p>
<h3 id="Unidbg-trace"><a href="#Unidbg-trace" class="headerlink" title="Unidbg trace"></a>Unidbg trace</h3><h4 id="获得日志"><a href="#获得日志" class="headerlink" title="获得日志"></a>获得日志</h4><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">traceCode</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">traceFile</span> <span class="operator">=</span> <span class="string">&quot;unidbg-android/src/test/java/com/xhs/traceCode.log&quot;</span>; <span class="comment">// 输出的路径</span></span><br><span class="line">    <span class="type">PrintStream</span> <span class="variable">traceStream</span> <span class="operator">=</span> <span class="literal">null</span>; <span class="comment">// 打印流</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        traceStream = <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(traceFile), <span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// traceCode 对代码进行监控</span></span><br><span class="line">    emulator.traceCode(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base + <span class="keyword">module</span>.size).setRedirect(traceStream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后从JNI_OnLoad开始trace的话，日志存了120w条指令；而从sub_9E184开始trace，只有1700多行，我们主要关注的是sub_9E184的逻辑。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603101528525.png" alt="image-20250603101528525"></p>
<p>注意到，这里把寄存器变化的值打印出来了，假如某寄存器存放着字符串的地址，这里也只是打印地址，而不会打印字符串，这样的日志不便于观察。</p>
<p>因此，我们需要修改traceCode的逻辑。</p>
<h4 id="修改Unidbg，获得带有字符串信息的日志"><a href="#修改Unidbg，获得带有字符串信息的日志" class="headerlink" title="修改Unidbg，获得带有字符串信息的日志"></a>修改Unidbg，获得带有字符串信息的日志</h4><p>注意到，日志会出现符号“&#x3D;&gt;”，于是在整个项目中搜索这个符号。然后发现，文件RegAccessPrinter.java就是我要们要修改的文件。</p>
<p>我在这里设定，每次读取寄存器的内容，当初字符串地址进行访问，如果读取后发现了连续3个可视字符，就当成字符串进行处理，打印整个字符串。</p>
<p>在Unidbg中，读取指定内存区域的字节又该怎么做呢？——我记得Unidbg动调可以访问内存地址，指令是“m”，于是在整个项目搜索“m”，然后发现是用Pointer类型进行访问，于是代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Method to check if the register value points to a readable string and print it</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkAndPrintString</span><span class="params">(<span class="type">long</span> address, StringBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取指向指定地址的 Pointer 对象</span></span><br><span class="line">            <span class="type">Pointer</span> <span class="variable">pointer</span> <span class="operator">=</span> UnidbgPointer.pointer(emulator, address);</span><br><span class="line">            <span class="keyword">if</span> (pointer == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// 地址无效，直接返回</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 从地址读取 256 字节的数据</span></span><br><span class="line">            <span class="type">byte</span>[] bytes = pointer.getByteArray(<span class="number">0</span>, <span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查是否为可打印字符串并提取</span></span><br><span class="line">            <span class="keyword">if</span> (isPrintableString(bytes)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> extractString(bytes);</span><br><span class="line">                builder.append(<span class="string">&quot; (string: \&quot;&quot;</span>).append(str).append(<span class="string">&quot;\&quot;)&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 忽略内存不可读或无效的情况</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if the first 3 bytes are printable ASCII characters</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isPrintableString</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (bytes.length &lt; <span class="number">3</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bytes[i] &lt; <span class="number">32</span> || bytes[i] &gt; <span class="number">126</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Extract the full string until a non-printable character or null terminator</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">extractString</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : bytes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (b &gt;= <span class="number">32</span> &amp;&amp; b &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">                sb.append((<span class="type">char</span>) b);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>; <span class="comment">// Stop at first non-printable character</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>将checkAndPrintString移动到函数print内部。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603121620460.png" alt="image-20250603121620460" style="zoom:80%;" />

<p>同时，由于调用UnidbgPointer.Pointer需要Emulator对象，所以还得往类RegAccessPrinter添加成员变量。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603122310517.png" alt="image-20250603122310517"></p>
<p>既然改了构造函数，还需要在调用构造函数的地方，把Emulator对象传进去。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603122457201.png" alt="image-20250603122457201"></p>
<p>重新运行，程序能正常跑了。</p>
<p>日志中出现了我们想看到的字符串。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603122547995.png" alt="image-20250603122547995"></p>
<h3 id="寻找加密点"><a href="#寻找加密点" class="headerlink" title="寻找加密点"></a>寻找加密点</h3><p>通过带有字符串信息的日志可以知道：</p>
<ol>
<li>shield最早出现在哪条指令；</li>
<li>shield的缓冲区地址在哪。</li>
</ol>
<p>于是，有2个思路去寻找加密点：</p>
<ol>
<li>根据shield最早出现的指令，朝着之前的指令进行溯源；</li>
<li>在shield的缓冲区地址设置读写断点。</li>
</ol>
<p>怎么看都是第2种方式更简单。</p>
<p>找到缓冲区地址：0x1240c000。——因为是unidbg模拟的缓冲区，所以缓冲区地址不会变。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603124025662.png" alt="image-20250603124025662"></p>
<p>我们的shield长度是134个字节，内容为：</p>
<p>XYAAQAAgAAAAEAAABTAAAAUzUWEe0xG1IbD9&#x2F;c+qCLOlKGmTtFa+lG434Je+FUTaRHxIzkyONuSp3&#x2F;qeYJz8Mt3Jx+2fc6EAwYGGHebLP31H5m0rHnmtyNNSyC55+4O2fp4TDk</p>
<p>unidbg提供了api，可以对写操作进行监控。——traceWrite。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603130831459.png" alt="image-20250603130831459"></p>
<p>可以发现，偏移0x4b024处在将正确的值写回去了。</p>
<h2 id="分析加密算法"><a href="#分析加密算法" class="headerlink" title="分析加密算法"></a>分析加密算法</h2><p>先在IDA中，来到0x4b024看看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603132235532.png" alt="image-20250603132235532"></p>
<p>用frida hook一下，查看memcpy复制的内容，发现与最后的shield相差了2个字节，有2个字节（XY）不见了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603133116946.png" alt="image-20250603133116946" style="zoom:80%;" />

<p>根据之前traceWrite日志，可以发现0x4af74单独对0x1240c000前2个字节进行了修改。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603133810826.png" alt="image-20250603133810826"></p>
<p>根据观察，0x4af70对前2个字节做了赋值，而0x4b020对132个字节进行了赋值。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603135404795.png" alt="image-20250603135404795" style="zoom: 50%;" />

<p>而且，对a1进行交叉引用，发现没有任何修改a1的地方；查看a1被传入的地方，只发现了简单的加解密，也就是说，前2个字节是固定的，根据直接的traceWrtie日志，固定为XY，因此我们分析的重点在v16。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603134655647.png" alt="image-20250603134655647"></p>
<p>而v16似乎涉及加密。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603134245833.png" alt="image-20250603134245833" style="zoom:80%;" />

<p>在Unidbg中，对v16涉及的memcpy下断点，查看源地址是什么。（已知目的地址是0x1240c002）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603142532252.png" alt="image-20250603142532252"></p>
<p>可以看到，源地址是0x1240c0a0，于是在0x1240c0a0下写断点。</p>
<p>发现，0x1240c0a0在libxyass.so偏移0x82890的地方被写入数据。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603144957562.png" alt="image-20250603144957562"></p>
<p>注意到，shield有点像是base64编码后的结果，而且0x82890的代码又是每轮取出v136的3个字节，然后赋给v138的4个字节，这是base64编码的特征。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603150611119.png" alt="image-20250603150611119" style="zoom:80%;" />

<p>在IDA中，来到汇编层，X10应该是：指向未经过base64编码的数据的地址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603151336773.png" alt="image-20250603151336773"></p>
<p>在Unidbg中下个断点，然后查看这里的值。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603151739554.png" alt="image-20250603151739554" style="zoom:80%;" />

<p>对这里的内容进行base64编码，跟我们最终的shield后134字节一模一样，坐实了这里是base64编码。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603151957773.png" alt="image-20250603151957773"></p>
<p>注意到，这个数据的地址是0x12411000，对这里下一个写断点。（编码前是99字节）</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603152310130.png" alt="image-20250603152310130" style="zoom:80%;" />

<p>注意到，99个字节的前16个字节的LR指向libxyass.so偏移0x49da0的位置，而后面83个字节来自偏移0x49db4的位置。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603152839854.png" alt="image-20250603152839854" style="zoom:80%;" />

<p>来到IDA中。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603153216623.png" alt="image-20250603153216623" style="zoom:80%;" />

<p>先后查看两个memcpy的源地址（下断点），然后对源地址下写断点。</p>
<p>先看前16字节的memcpy的x1在哪，由于我hook的地址是0x49D9C，有些数据不是我们想要的，我们只需要前16个字节是00 04 00 02…的源地址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603154925545.png" alt="image-20250603154925545"></p>
<p>第4次进入该函数后，终于找到前16个字节的源地址是0xe4ffefd9。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603155121052.png" alt="image-20250603155121052" style="zoom: 67%;" />

<p>再来找后83个字节的x1在哪。——找到后83个字节在0x123dc060。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603155314815.png" alt="image-20250603155314815" style="zoom:67%;" />

<h3 id="0x10个字节（I）"><a href="#0x10个字节（I）" class="headerlink" title="0x10个字节（I）"></a>0x10个字节（I）</h3><p>通过IDA的伪代码分析，v15是前16个字节，它来自于a1+1或者a1+16的位置。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603161446117.png" alt="image-20250603161446117" style="zoom:80%;" />

<p>hook函数sub_49CE4，查看a1内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603161608228.png" alt="image-20250603161608228" style="zoom:80%;" />

<p>确定v15来自a1+1。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603162158928.png" alt="image-20250603162158928" style="zoom:80%;" />

<p>查看交叉引用，从哪一个过来的呢。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603162635148.png" alt="image-20250603162635148" style="zoom:80%;" />

<p>根据trace日志，可以发现是从0x4a2e0跳转过来的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603163817199.png" alt="image-20250603163817199"></p>
<p>地址0x4a2e0属于函数sub_4a278，hook一下函数的入参，可以发现x0和x1分别指向16字节和83字节，而x2代表x1的长度。</p>
<p>这里继续观察 16个字节，16个字节位于栈0xe4ffefd8上。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605093906663.png" alt="image-20250605093906663" style="zoom:80%;" />

<p>因此对0xe4ffefd8下一个写断点，注意到0x8271C、0x8272C等地址会往里写目标字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605100625749.png" alt="image-20250605100625749"></p>
<p>来到0x8271C，位于函数sub_81F00的范围内。</p>
<p>下图，我对17个字节进行了分析（<strong>第0个字节是0x20，0x20并不在目标16字节内，它另有作用</strong>）。</p>
<h4 id="第0、3-4、5-8、9-12字节分析"><a href="#第0、3-4、5-8、9-12字节分析" class="headerlink" title="第0、3-4、5-8、9-12字节分析"></a>第0、3-4、5-8、9-12字节分析</h4><p>v124用来描述v127（53个字节）的长度，所以v124是0x53，经过bswap32后变成0x53 00 00 00。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605125053638.png" alt="image-20250605125053638" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605101334210.png" alt="image-20250605101334210"></p>
<p>因此，这17个字节的格式是这样的：</p>
<p>20 ?? ?? ?? ?? 00 00 00 01 53 00 00 00 ?? ?? ?? ?? </p>
<p>再来判断第1-4个字节是如何来的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250603181820765.png" alt="image-20250603181820765"></p>
<p>假设v155是0xAB CD EF GH，左移16位后，0xEF GH 00 00，或上一个2后，0xEF GH 00 02，然后swap32交换次序，0x02 00 GH EF，也就是说，有2个字节是固定的，GH EF相当于原来的v155的低2个字节做了交换。</p>
<p>当前的v157是这样的：</p>
<p>20 ?? ?? 00 02 00 00 00 01 53 00 00 00 ?? ?? ?? ??</p>
<h4 id="第13-16字节分析"><a href="#第13-16字节分析" class="headerlink" title="第13-16字节分析"></a>第13-16字节分析</h4><p>暂时先不分析第1-2字节，这个难度有点高，先来看最后4个字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605144331650.png" alt="image-20250605144331650"></p>
<p>对v161进行交叉引用，发现v161 &#x3D; v35。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605144421784.png" alt="image-20250605144421784" style="zoom:80%;" />

<p>阅读下图，v161获得了sub_4A278的返回值，我们上面的图中，也出现了sub_4A278。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605144526867.png" alt="image-20250605144526867" style="zoom:80%;" />

<p>对sub_4A278进行分析，发现它是一个类似memcpy的函数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605145136195.png" alt="image-20250605145136195"></p>
<p>不同的是，target是std::string类型，而src是char数组。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605152800396.png" alt="image-20250605152800396" style="zoom:80%;" />

<p>string类型是24个字节，之前提到过string类型会对短字符串做sso优化，存储短字符串和长字符串时，string采用的结构不同。</p>
<p>v3 &amp; 1，即target的最低位与1做&amp;，如果（v3&amp;1 !&#x3D; 0）为true，则说明当前当前的string存储着长字符串，采用__long结构；而反之为false，则采用__short结构。</p>
<p>当遇到一个string类型，先判断第0位是否为1，如果是1，则采取__long结构，不用担心第0位的1会影响__cap_的值，__cap_被规定需要2字节对齐，所以第0位单纯是flag；而如果第0位是0，则采取__short结构，该结构会使用高7位表示data的大小，舍弃掉flag的1位，因为data就23个字节，最后一个字节还要存\x00，所以data的实际存储空间大小就22字节，用7位足够表示了。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">+--------+----------------+----------+</span><br><span class="line">|address |    __short     | __long   |</span><br><span class="line">+--------+----------------+----------+</span><br><span class="line">|   0    | __size_ / __lx |          |</span><br><span class="line">+--------+----------------+          |</span><br><span class="line">|   1    |                |          |</span><br><span class="line">|   2    |                |          |</span><br><span class="line">|   3    |                | __cap_   |</span><br><span class="line">|   4    |                |          |</span><br><span class="line">|   5    |                |          |</span><br><span class="line">|   6    |                |          |</span><br><span class="line">|   7    |                |          |</span><br><span class="line">+--------|                |----------+</span><br><span class="line">|   8    |                |          |</span><br><span class="line">|   9    |                |          |</span><br><span class="line">|   10   |                |          |</span><br><span class="line">|   11   |   __data_      | __size_  |</span><br><span class="line">|   12   |                |          |</span><br><span class="line">|   13   |                |          |</span><br><span class="line">|   14   |                |          |</span><br><span class="line">|   15   |                |          |</span><br><span class="line">+--------|                |----------+</span><br><span class="line">|   16   |                |          |</span><br><span class="line">|   17   |                |          |</span><br><span class="line">|   18   |                |          |</span><br><span class="line">|   19   |                | __data_  |</span><br><span class="line">|   20   |                |          |</span><br><span class="line">|   21   |                |          |</span><br><span class="line">|   22   |                |          |</span><br><span class="line">|   23   |                |          |</span><br><span class="line">+--------+----------------+----------+</span><br></pre></td></tr></table></figure>

<p>注意到，在函数sub_81F00中，一共调用了4次sub_4A278，而v34 &#x3D; sub_4A278是第3次调用，也就是说，v34里面累积存放了4个字符串——原本有1个，再通过sub_4A278追加了3个。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605155300448.png" alt="image-20250605155300448"></p>
<p>在Unidbg中模拟执行，对函数sub_4A278进行hook，可以发现：一共就调用了4次sub_81F00，所以基本可以确认，这4次调用都来自于sub_81F00。</p>
<p><strong>第一次调用sub_4A278。</strong></p>
<p>x0指向string类型对象，x1指向char数组，x2是char数组的长度。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605160706893.png" alt="image-20250605160706893"></p>
<p>第1个字节是0x21，它最低位是1，说明是__long类型；</p>
<p>第1个8字节是0x21，由于对齐，算作0x20，也就是说有32个字节的缓冲区；</p>
<p>第2个8字节说明缓冲区已经用了0x18个字节，也就是用掉了24个字节；</p>
<p>第3个8字节是缓冲区（堆）的地址。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605161157351.png" alt="image-20250605161157351" style="zoom:67%;" />

<p>查看堆里面存放的内容，正好24个字节。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605161634428.png" alt="image-20250605161634428" style="zoom:67%;" />

<p>待添加的字符串存在x1指向的地址中。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605162735679.png" alt="image-20250605162735679" style="zoom:80%;" />

<p><strong>第二次调用sub_4A278。</strong></p>
<p>x0指向string类型对象，x1指向char数组，x2是char数组的长度。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605161855783.png" alt="image-20250605161855783"></p>
<p>查看x0的内容。</p>
<p>第1个8字节是0x21，由于对齐，算作0x20，也就是说有32个字节的缓冲区。——因为之前32个字节，原本的字符串长度是24个字节，第一次调用时需要添加了7个字节，而缓冲区剩下的8个字节足够容纳，不需要重新申请空间。</p>
<p>第2个8字节由于添加了7个字节，由0x18 + 0x7变成了0x1F。</p>
<p>第3个8字节由于不用重新申请空间，所以空间地址和第一次调用时的堆地址一样，没变。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605162022804.png" alt="image-20250605162022804">z</p>
<p>查看堆里面存放的内容，可以看到已经添加上8770299了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605162517804.png" alt="image-20250605162517804"></p>
<p><strong>第三次调用sub_4A278。</strong></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605162832317.png" alt="image-20250605162832317"></p>
<p>第一个字节是0x51，说明是__long类型。</p>
<p>第1个8字节，0x51视作0x50，说明新申请的缓冲区有80字节的大小。</p>
<p>第2个8字节，0x43表示已经使用了0x43个字节。</p>
<p>第3个8字节，0x12407000是新缓冲区的地址。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605162931543.png" alt="image-20250605162931543" style="zoom:80%;" />

<p>18dfe96-7f6f-370a-8e80-f94f8838e6de已经被复制到缓冲区里了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605163247658.png" alt="image-20250605163247658" style="zoom:80%;" />

<p>sub_4A278的返回值是string对象的地址，也就是说，v161指向这4个字符串。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605163551389.png" alt="image-20250605163551389"></p>
<p>再也就是说，这里的v123实际上是在获得长度，而4个字符串的长度分别是0x18 + 0x7 + 0x24 + 0x10，和为0x53。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605144331650.png" alt="image-20250605144331650"></p>
<p>所以16字节的第9-12和13-16都是53 00 00 00，都代表着v127的长度。</p>
<p>为什么v156是17字节，而非16个字节，第0个字节为什么是0x20？很明显了，0x20说明是短字符串存储，经过sso优化，直接存储在对象内部，不用开辟堆空间。</p>
<p>砍去一个0不用，剩下的7位表示data部分使用的字节数，0x0010000就是是十进制16，也就是目标16个字节的长度。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605164202847.png" alt="image-20250605164202847"></p>
<p>言归正传，前17个字节的格式是这样的。</p>
<p>20 ?? ?? 00 02 00 00 00 01 53 00 00 00 53 00 00 00</p>
<p>只剩下第1-2字节未解决了。</p>
<h4 id="第1-2字节分析"><a href="#第1-2字节分析" class="headerlink" title="第1-2字节分析"></a>第1-2字节分析</h4><p>第1-2字节与v154有关。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605165305661.png" alt="image-20250605165305661" style="zoom:80%;" />

<p>而v154与a4有关。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605165352929.png" alt="image-20250605165352929" style="zoom:80%;" />

<p>查看函数0x81F00的引用，来到sub_6EFF0。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605165650062.png" alt="image-20250605165650062"></p>
<p>v5与a3相关。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605165701019.png" alt="image-20250605165701019"></p>
<p>函数sub_6EFF0有2个引用。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605165738153.png" alt="image-20250605165738153"></p>
<p>先不着急追踪引用，先在Unidbg中hook函数sub_6EFF0。</p>
<p>发现*a3 &#x3D; 0x4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605170228483.png" alt="image-20250605170228483"></p>
<p>搜索trace记录，判断函数sub_6EFF0来自于哪个函数调用。</p>
<p>跳转到0x9ef04。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605175855282.png" alt="image-20250605175855282"></p>
<p>v134是传入的a3。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605180034095.png" alt="image-20250605180034095"></p>
<p>在0x9ef04下断点，查看x2，因为v134是一个指针，所以用mx2查看里面的内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605183215314.png" alt="image-20250605183215314" style="zoom:80%;" />

<p>v134与v13有关，v13通过多个调用获得初始化。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605184132923.png" alt="image-20250605184132923"></p>
<p>我之前实现过：通过jmethodID获得函数名，因此可以识别这里调用了什么。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605205752942.png" alt="image-20250605205752942"></p>
<p>经过判断，调用了类的初始化函数okio.Buffer.&lt;init&gt;，还调用了writeString。</p>
<p>尝试分析，这里究竟写入了什么。这里我hook上了0x6E13C，0x6E13C封装了CallObjectMethodV，同时根据args[2]（jmethodID）筛选调用的函数，打印写入的字符串。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getStr</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libxyass.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x6E13C</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_">prettyMethod</span>(args[<span class="number">2</span>], <span class="number">0</span>) == (<span class="string">&quot;okio.Buffer.writeString&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">var</span> va1 = args[<span class="number">3</span>];</span><br><span class="line">                <span class="keyword">var</span> env = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[str]&quot;</span>, <span class="title function_">ptr</span>(env.<span class="title function_">getStringUtfChars</span>(va1)).<span class="title function_">readCString</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写了很多东西。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605210301978.png" alt="image-20250605210301978"></p>
<p>用Unidbg也可以实现类似的效果，写的时候打印一下即可。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605210419813.png" alt="image-20250605210419813"></p>
<p>然后下个断点，判断执行前后能否打印字符串。</p>
<p>成功打印字符串“&#x2F;api&#x2F;sns&#x2F;v4&#x2F;user&#x2F;login&#x2F;password”，但发现了点小问题。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605210639382.png" alt="image-20250605210639382"></p>
<p>观察我补的环境，发现这里传入了一个新的dvmObject，可能是因为这个原因。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605210713560.png" alt="image-20250605210713560" style="zoom:67%;" />

<p>改成这样子。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605210800510.png" alt="image-20250605210800510" style="zoom:67%;" />

<p>然后再跑一次，这回jobject的值一致了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605210955734.png" alt="image-20250605210955734" style="zoom:80%;" />

<p>最后v134应该指向栈上地址：0xe4fff640，但没找到v134被修改的地方。</p>
<p>只能说，只看伪代码果然不行，接下来看汇编了，前面的内容供读者图一乐，错误经验也是经验，主要是展示我个人的分析流程。</p>
<p>往栈地址0xe4fff640下一个写断点，发现是0x9eddc往0xe4fff640里写了0x4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605214533648.png" alt="image-20250605214533648"></p>
<p>在0x9eddc下一个断点，判断一下Q3、Q2哪个存放了0x4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605214730765.png" alt="image-20250605214730765"></p>
<p>q3存放0x4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605214912867.png" alt="image-20250605214912867"></p>
<p>而Q3 &#x3D; [X24 + 252]，往0x9EDC4下断点，查看X24+252和是多少，然后给X24+252下一个写断点。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605215043885.png" alt="image-20250605215043885"></p>
<p>x24 &#x3D; 0x123df000，因此在0x123df0fc下一个写断点。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605215318136.png" alt="image-20250605215318136"></p>
<p>下了断点后，发现是0x920AC的指令再往0x123df0fc里写0x4。</p>
<p>而w8的值由LDR w8,[x8]得来的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605215941273.png" alt="image-20250605215941273" style="zoom: 80%;" />

<p>而x8的值是0x123dc060。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605220036345.png" alt="image-20250605220036345"></p>
<p>再在0x123dc060下一个写断点，找是谁往0x123dc060里写入的0x4。</p>
<p>地址0x9aab8的指令往0x123dc060里写0x4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605220348565.png" alt="image-20250605220348565"></p>
<p>分析一波，如图所示。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605222117031.png" alt="image-20250605222117031"></p>
<p>可以下个断点在0x9AAA4，查看每次取的16字节来自于哪里。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605222306362.png" alt="image-20250605222306362" style="zoom:80%;" />

<p>Q1的16字节来自栈上基址（且x19指向的）0xe4fff200、Q0的16字节来自栈上基址（且x22指向的）0xe4fff148。</p>
<p>Q1和Q0只有低字节不一样，Q1是0x31，Q0是0x35。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606093410755.png" alt="image-20250606093410755" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606093422089.png" alt="image-20250606093422089" style="zoom:80%;" />

<p>先为0xe4fff200下一个写断点，判断这16个字节（31 01 32…17 66 39）是什么时候写入的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606093939190.png" alt="image-20250606093939190"></p>
<p>发现是0x92830的指令在往里面写，跳转过去看看。</p>
<p>Q0 &#x3D; [x8 + x10]，在0x92820下一个断点，查看x8与x10的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606094216659.png" alt="image-20250606094216659"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606094418843.png" alt="image-20250606094418843"></p>
<p>得出0x12019A30。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606094442596.png" alt="image-20250606094442596" style="zoom:80%;" />

<p>Unidbg的映射基地址是0x1200000，所以这里的偏移指向so文件的0x19A30。</p>
<p>发现这里是.rodata节的内容，也就是说，Q1的16字节，来自于文件中硬编码的16字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606094555033.png" alt="image-20250606094555033"></p>
<p>再追踪Q0的16字节从何而来，对0xe4fff148下一个写断点。</p>
<p>注意到，似乎对每个字节赋值的地址不同。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606100952982.png" alt="image-20250606100952982"></p>
<p>这里先追踪Q0最低字节，因为Q1和Q0只在这里有所不同。</p>
<p>来到0x9A064。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606101533687.png" alt="image-20250606101533687"></p>
<p>对这一块代码进行还原，发现有点复杂啊。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250604131821514.png" alt="image-20250604131821514"></p>
<p>借鉴了一下其它人的分析，Q0的16个字节来自于变种AES加密，因此这里先放一放，先去分析另外53个字节。</p>
<h3 id="0x53个字节"><a href="#0x53个字节" class="headerlink" title="0x53个字节"></a>0x53个字节</h3><p>前面提到，0x53个字节其实是分为4块，每块的字节数分别是0x18、0x7、0x24、0x10，</p>
<p>通过hook函数sub_4A278便可获得这4块内容。</p>
<p>下图是第3次调用sub_4A278的位置，可以在这边下一个断点，观察4个字符串未加密前是什么。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606110401435.png" alt="image-20250606110401435"></p>
<p>这是加密前的内容，位于0x1240c000。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606111137178.png" alt="image-20250606111137178"></p>
<p>在对第四次调用sub_4A278的位置下断点，这个时候里面的内容虽然也是0x53个字节，但已经加密了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606111756494.png" alt="image-20250606111756494" style="zoom:80%;" />

<p>加密点应该在第3次调用与第四次调用之间。</p>
<p>在0x123dc060下写断点，指令0x8235C处往里面写了0x35，0x8235C位于函数sub_81F00内。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606115920475.png" alt="image-20250606115920475"></p>
<p>跳转到0x8235C，看不出加密算法。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606120453309.png" alt="image-20250606120453309" style="zoom:67%;" />

<p>慢慢分析。</p>
<p>先对sub_81F00进行hook，打印入参。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606121200628.png" alt="image-20250606121200628" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606121138961.png" alt="image-20250606121138961"></p>
<p>（x0）a1 &#x3D; 1。（疑似固定值）</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606130046944.png" alt="image-20250606130046944" style="zoom:80%;" />

<p>（x1）a2是个字符数组，代表build，如下。</p>
<p>0xE表示sso存储，占用了7个字节。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606121335072.png" alt="image-20250606121335072" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606132842937.png" alt="image-20250606132842937" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606122006533.png" alt="image-20250606122006533"></p>
<p>（x2）a3来自于AppId。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606130146772.png" alt="image-20250606130146772" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606130210235.png" alt="image-20250606130210235" style="zoom:67%;" />

<p>（x3）a4为0x4；——之前q1、q2异或的0x4。</p>
<p>（x4）a5是个string类型；</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606121826620.png" alt="image-20250606121826620"></p>
<p>存放了device_id。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606121842021.png" alt="image-20250606121842021"></p>
<p>（x5）a6&#x3D;0xe4fff521，似乎存放了16个字节。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606130901638.png" alt="image-20250606130901638" style="zoom:67%;" />

<p>（x6）a7 &#x3D; 0x10，似乎代表a6的大小。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606130328066.png" alt="image-20250606130328066"></p>
<p>（x7）a8&#x3D;0x38663439662d3038，存放了8个字符“80-f94f8”。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606131755330.png" alt="image-20250606131755330"></p>
<p>似乎是device_id的一部分。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606132002394.png" alt="image-20250606132002394" style="zoom:80%;" />

<p>改一下变量名。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606132559512.png" alt="image-20250606132559512" style="zoom:80%;" />

<p>结合入参进行改名。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606134204767.png" alt="image-20250606134204767" style="zoom:80%;" />

<p>插入一个结构体，方便分析。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606134959994.png" alt="image-20250606134959994" style="zoom:80%;" />

<p>接着往下分析。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606135258040.png" alt="image-20250606135258040"></p>
<p>点进xmmword_19AA0，0x21说明了是长字符串存储，缓冲区大小是0x20个字节，已经占用了0x18个字节。（v157的前16个字节来自于xmmword_19AA0，缓冲区的地址并不是通过v157&#x3D;xmmword_19AA0得到的）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606135337277.png" alt="image-20250606135337277"></p>
<p>v157指向红色框中的这18个字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606111137178.png" alt="image-20250606111137178"></p>
<p>接着往下分析。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606143311760.png" alt="image-20250606143311760"></p>
<p>观察变量“ptr_18bytes_AND_build_id_AND_device_id_b”的值，它的值其实在之前就清空了，这里应该是复用了，因为不知道它在加密部分是什么含义，暂时没改变量名。</p>
<p>hook上0x821B0的位置，访问x9所指向的内存地址，查看内容有什么变化。（根据计算，有32次循环，记作0-31）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606144449746.png" alt="image-20250606144449746"></p>
<p>第0次循环。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606144721289.png" alt="image-20250606144721289"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606144805944.png" alt="image-20250606144805944" style="zoom:80%;" />

<p>在执行了几次循环后，如下图所示。</p>
<p>从第8个字节开始，0x0、0x1…依次递增，一次循环可以初始化8个4字节，而执行32次，也就是说，从0一直到(32*8 - 1)，也就是0x0到0xff。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606145022167.png" alt="image-20250606145022167"></p>
<p>而！RC4流密码中，在初始化状态向量时，SBox就是这么得来的，SBox的初始化的伪代码如下。</p>
<p>一般的RC4中，SBox是字节数组，而这里是4字节为单位的数组。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">    S[i] = i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果猜想是对的话，待会应该还有一段用密钥对S盒进行置换的过程，暂时先将“ptr_18bytes_AND_build_id_AND_device_id_b”重命名为“SBox”。</p>
<p>继续往下分析。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606151139575.png" alt="image-20250606151139575"></p>
<p>待会再去hook获得密钥，先来看看这个S盒置换算法。</p>
<p>下面这段代码基本可以说明，就是RC4算法，而且密钥长度为13——0到12。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606154725222.png" alt="image-20250606154725222"></p>
<p>循环64次，说明每次循环交换4次。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606154738763.png" alt="image-20250606154738763" style="zoom:80%;" />

<p>hook一下，得到密钥看看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606155337349.png" alt="image-20250606155337349"></p>
<p>x8&#x3D;0x1201b48d，说明密钥在文件偏移0x1b48d的位置。</p>
<p>试图用字符串“std::abort();”作掩护，hhhh。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606155703863.png" alt="image-20250606155703863" style="zoom:80%;" />

<p>拿去试一下，发现是个非常标准的rc4加密。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606163952156.png" alt="image-20250606163952156"></p>
<p>至此，0x53个字节分析完了。</p>
<h3 id="0x10个字节（Ⅱ）"><a href="#0x10个字节（Ⅱ）" class="headerlink" title="0x10个字节（Ⅱ）"></a>0x10个字节（Ⅱ）</h3><p>还记得，在**16个字节（Ⅰ）**中，我们分析得出，16个字节的格式如下：</p>
<p>20 ?? ?? 00 02 00 00 00 01 53 00 00 00 53 00 00 00</p>
<p>当时最大的问题是：?? ??的值由Q1与Q0异或得来，Q1是硬编码在文件中的，而Q0的值，当时只追踪了最低字节。</p>
<p>当时为了得出Q0的最低字节从何而来，我逆了一下算法，但涉及到的缓冲区有点多。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250604131821514.png" alt="image-20250604131821514"></p>
<p>所以在这一小节，我们的目标之一是<strong>还原Q0</strong>，还有一个目标是分析<strong>绿色框里的16个字节</strong>从何而来。</p>
<p>（我好像没解释过红色框，红色框的前4个字节是函数sub_81F00传入的a1，是固定值；再4个字节是app_id，0x2是根据传Q1与Q0异或的0x4判断得到的；0x7代表build的大小，0x24代表device_id的大小，0x10代表未知的16个字节）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606111137178.png" alt="image-20250606111137178"></p>
<h4 id="HMAC-MD5"><a href="#HMAC-MD5" class="headerlink" title="HMAC-MD5"></a>HMAC-MD5</h4><p>这16个字节是函数sub_81F00的入参a6，对应的缓冲区地址是0xe4fff521。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606130901638.png" alt="image-20250606130901638" style="zoom:67%;" />

<p>在0xe4fff521下一个写断点。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606175216983.png" alt="image-20250606175216983"></p>
<p>地址0x6f768处的指令对0xe4fff521进行了写。</p>
<p>0xe4fff521的值由Q0得到，Q0的值由[X29,#-0x18]得到，所以在0x6F758下断点（或者看日志）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606175711711.png" alt="image-20250606175711711"></p>
<p>x29&#x3D;0xe4fff470，所以X29 - 0x18是0xE4FFF458。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606175911851.png" alt="image-20250606175911851"></p>
<p>在0xE4FFF458下写断点，发现是0x92fd8。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606180338505.png" alt="image-20250606180338505"></p>
<p>地址0x92fd8位于函数sub_92F2C范围内。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606181133194.png" alt="image-20250606181133194" style="zoom:80%;" />

<p>我们需要的16字节存储在a2中，a2由v2赋值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606181450989.png" alt="image-20250606181450989"></p>
<p>w8是上图的a2，a2的值地址0x92FCC获得，所以在0x92FCC下一个断点，查看X20的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606182624432.png" alt="image-20250606182624432"></p>
<p>x20的值是0x123df480。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606182803621.png" alt="image-20250606182803621"></p>
<p>在x20下写断点。</p>
<p>可以看到，偏移0x93f74对0x123df480进行了写操作。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250606183329672.png" alt="image-20250606183329672"></p>
<p>来到0x93f74。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607095231225.png" alt="image-20250607095231225"></p>
<p>对应于汇编的伪代码。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607095624055.png" alt="image-20250607095624055"></p>
<p>现在0x93F74下个断点，发现这个函数执行了很多次，迟迟等不到我们要看的内容，于是统计一下这个函数执行的次数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607100823567.png" alt="image-20250607100823567"></p>
<p>同时，分析算法，发现一个很有意思的点。</p>
<p>假设HIDWORD(v4) &#x3D; R，那么LODWORD(v4)也等于R，也就是说64位的高32位和低32位是一样的，都为R。</p>
<p>而v4 &gt;&gt; 17可以写成(R &lt;&lt; 32 | R) &gt;&gt; 17，进一步可以写成((R &lt;&lt; 32) &gt;&gt; 17) | R &gt;&gt; 17。</p>
<p>(R &lt;&lt; 32) &gt;&gt; 17的结果是 R 左移（32 - 17 &#x3D; 15）位，并占据了结果的高位部分。</p>
<p>R &gt;&gt; 17的结果是 R 右移17位，占据了结果的低位部分。</p>
<p>v5是一个32位的数据类型，所以当上述的两者通过或组合在一块，就相当于将R循环右移了17位。</p>
<p>而循环右移17位，等同于循环左移15位。</p>
<p>（注意这里的&lt;&lt;都是逻辑左移和逻辑右移，而不是循环左移和循环右移）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607105851010.png" alt="image-20250607105851010"></p>
<p>md5算法有4轮运算：F、G、H、I，每一轮运算要执行16次（因为有16个子分组），在I运算中，涉及循环左移6、10、15、21位；除此之外，I运算涉及异或、取反、或等操作。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607111129485.png" alt="image-20250607111129485" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607111219863.png" alt="image-20250607111219863" style="zoom:80%;" />

<p>而在sub_93F14中，发现了循环左移15位，还有循环左移21位，同时发现了一些异或、取反的操作，又考虑到这个函数执行了16次，这大概率是md5算法的II运算。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607111353373.png" alt="image-20250607111353373"></p>
<p>还发现了md5的魔数，按常理来说，II运算是第4轮运算，魔数ABCD早被修改了，但编译器似乎没对寄存器x0进行操作，魔数一直存在x0中。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607113630363.png" alt="image-20250607113630363" style="zoom: 67%;" />

<p>更加坐实了这是一个魔改的md5算法。——为什么说是魔改，之后会说。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607113813785.png" alt="image-20250607113813785" style="zoom:80%;" />

<p>分析trace日志中，0x93F74出现的地方，对应上调用了16次函数sub_93F14。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607124335780.png" alt="image-20250607124335780" style="zoom:80%;" />

<p>在第16次的时候，w28出现了未知16字节中的4个字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607124755707.png" alt="image-20250607124755707"></p>
<p>在第16次调用的trace记录，w27是魔数，w28的值来自于[0xe4fff2c0 - 0x34]，即[0xE4FFF28C]。</p>
<p>要同时追踪w27和w28吗？其实不用。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608132421218.png" alt="image-20250608132421218"></p>
<p>下图是第1次调用的trace记录，w27是一个魔数，所以只追踪w28。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250607140241493.png" alt="image-20250607140241493"></p>
<p>第三轮运算最终的a、b、c、d的第四轮运算的初始a、b、c、d。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608140802816.png" alt="image-20250608140802816" style="zoom:67%;" />

<p>在0xe4fff1f0-0x34处下一个写断点，观察里面的值来自于哪，大概率是md5的HH轮运算传过来的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608142243297.png" alt="image-20250608142243297"></p>
<p>偏移0x94534位于函数sub_944A8内，符合md5的特征，看样子还是II运算。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608142607568.png" alt="image-20250608142607568" style="zoom:80%;" />

<p>结合上图和下图，有点像是MD5的第60、61、62、63、64轮运算。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608142854656.png" alt="image-20250608142854656" style="zoom:80%;" />

<p>结合标准的md5算法，md5的63、64轮明显被魔改了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608152840554.png" alt="image-20250608152840554"></p>
<p>有一个疑惑，既然这里是md5的第63、64轮加密，为什么函数sub_93F14调用了16次？我原本以为，这里魔改的II运算，结果似乎只涉及63、64轮加密，前面的分析有些误打误撞，不过确认了，使用的加密算法是md5，涉及一些变异。</p>
<p>回到函数sub_92F2C，对函数进行hook，判断v2是从什么变成16个字节。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608155657798.png" alt="image-20250608155657798" style="zoom: 67%;" />

<p>发现要加密的内容是16个字节。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608165240684.png" alt="image-20250608165240684" style="zoom:80%;" />

<p>对函数sub_92F2C进行分析，静态分析下，可能会调用了2次sub_93390，第1次调用是为了处理空间不足的情况，因为md5的每个分组是512位，要留出最后64位记录信息长度，所以实际能用来存储的空间只有56字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608165909885.png" alt="image-20250608165909885"></p>
<p>创建结构体，对变量进行修改。</p>
<p>0x80是填充值，数据长度要小于等于55，因为至少有1个字节是填充值。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608165050501.png" alt="image-20250608165050501" style="zoom: 67%;" />

<p>接下来，分析函数sub_93390，它大概率是在进行md5加密，根据统计，一共执行了5次sub_93390。——这也无法解释为什么调用了sub_93F14共计16次，再放一会吧。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608170636507.png" alt="image-20250608170636507"></p>
<p>而我hook函数sub_92F2C，这个函数执行了2次，而且每一次数据的量都没有超过55字节，说明还有其它3处地方调用了sub_93390，进行md5加密。</p>
<p>搜索trace记录，从第1次调用开始看起。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608171823863.png" alt="image-20250608171823863"></p>
<p>第一次调用来自于0x92eec。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608183325917.png" alt="image-20250608183325917"></p>
<p>这里的sub_93390没有看到参数列表。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608183652512.png" alt="image-20250608183652512" style="zoom:67%;" />

<p>根据汇编，大概有3个参数，因此可以修改函数签名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608183908545.png" alt="image-20250608183908545"></p>
<p>而且这里的v3，一看就是之前分析的那个结构，修改变量类型。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608184300820.png" alt="image-20250608184300820" style="zoom:80%;" />

<p>hook函数sub_93390，看看返回值和入参。——返回值可以通过入参a1的前16字节获得。</p>
<p>根据大量的0x36，可以判断这是一个hmac-md5算法。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608201229798.png" alt="image-20250608201229798" style="zoom:80%;" />

<p>整理一下，5次调用sub_93390的入参、返回值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">// 第1次调用</span><br><span class="line">// x0</span><br><span class="line">0000: 76 54 32 10 FE DC BA 98 89 AB CD EF 01 23 45 67    vT2..........#Eg</span><br><span class="line">// x1（key与0x36的结果）</span><br><span class="line">0000: 6A 3E 23 D6 BC E6 B7 B9 C6 D2 4B D7 6C 78 02 D9    j&gt;#.......K.lx..</span><br><span class="line">0010: 72 84 55 82 03 93 5F 6E 20 B3 32 87 75 82 F9 8D    r.U..._n .2.u...</span><br><span class="line">0020: 38 43 90 71 D4 5C B9 1A 8D 63 39 3D F7 94 59 C7    8C.q.\...c9=..Y.</span><br><span class="line">0030: 7C 27 5A FD 1D 68 77 A5 BE 4D 91 14 E5 8D 0E 51    |&#x27;Z..hw..M.....Q</span><br><span class="line">// x2</span><br><span class="line">0x1</span><br><span class="line">// 返回值</span><br><span class="line">0000: 39 0A 80 0F EC FE 50 43 EE 54 1F 5B 06 9C 47 8B    9.....PC.T.[..G.</span><br><span class="line"></span><br><span class="line">// 第2次调用</span><br><span class="line">// x0</span><br><span class="line">0000: 76 54 32 10 FE DC BA 98 89 AB CD EF 01 23 45 67    vT2..........#Eg</span><br><span class="line">// x1（key与0x5C的结果）</span><br><span class="line">0000: 00 54 49 BC D6 8C DD D3 AC B8 21 BD 06 12 68 B3    .TI.......!...h.</span><br><span class="line">0010: 18 EE 3F E8 69 F9 35 04 4A D9 58 ED 1F E8 93 E7    ..?.i.5.J.X.....</span><br><span class="line">0020: 52 29 FA 1B BE 36 D3 70 E7 09 53 57 9D FE 33 AD    R)...6.p..SW..3.</span><br><span class="line">0030: 16 4D 30 97 77 02 1D CF D4 27 FB 7E 8F E7 64 3B    .M0.w....&#x27;.~..d;</span><br><span class="line">// x2</span><br><span class="line">0x1</span><br><span class="line">// 返回值</span><br><span class="line">0000: 29 9A 8E 4B 77 48 EA 98 E3 E3 DF 8C C7 D2 4B 4A    )..KwH........KJ</span><br><span class="line"></span><br><span class="line">// 第3次调用</span><br><span class="line">// x0</span><br><span class="line">0000: 39 0A 80 0F EC FE 50 43 EE 54 1F 5B 06 9C 47 8B    9.....PC.T.[..G.</span><br><span class="line">// x1</span><br><span class="line">0000: 2F 61 70 69 2F 73 6E 73 2F 76 34 2F 75 73 65 72    /api/sns/v4/user</span><br><span class="line">0010: 2F 6C 6F 67 69 6E 2F 70 61 73 73 77 6F 72 64 66    /login/passwordf</span><br><span class="line">0020: 69 64 3D 31 37 34 34 32 39 38 31 30 38 31 30 31    id=1744298108101</span><br><span class="line">0030: 33 64 32 30 63 39 31 35 38 61 30 61 39 62 32 39    3d20c9158a0a9b29</span><br><span class="line">0040: 61 62 62 63 62 62 31 65 64 37 32 36 66 35 62 26    abbcbb1ed726f5b&amp;</span><br><span class="line">0050: 67 69 64 3D 37 63 30 64 36 38 65 38 36 34 37 61    gid=7c0d68e8647a</span><br><span class="line">0060: 35 34 33 38 61 32 33 39 34 62 62 61 64 33 36 34    5438a2394bbad364</span><br><span class="line">0070: 63 32 62 64 66 33 31 62 39 38 37 39 34 37 33 35    c2bdf31b98794735</span><br><span class="line">0080: 39 34 34 30 37 37 62 62 66 63 35 35 26 64 65 76    944077bbfc55&amp;dev</span><br><span class="line">0090: 69 63 65 5F 6D 6F 64 65 6C 3D 70 68 6F 6E 65 26    ice_model=phone&amp;</span><br><span class="line">00A0: 74 7A 3D 41 73 69 61 25 32 46 53 68 61 6E 67 68    tz=Asia%2FShangh</span><br><span class="line">00B0: 61 69 26 63 68 61 6E 6E 65 6C 3D 56 69 76 6F 26    ai&amp;channel=Vivo&amp;</span><br><span class="line">00C0: 76 65 72 73 69 6F 6E 4E 61 6D 65 3D 38 2E 37 37    versionName=8.77</span><br><span class="line">00D0: 2E 30 26 64 65 76 69 63 65 49 64 3D 31 30 66 39    .0&amp;deviceId=10f9</span><br><span class="line">00E0: 31 66 36 38 2D 37 64 62 37 2D 33 61 33 36 2D 38    1f68-7db7-3a36-8</span><br><span class="line">00F0: 30 63 39 2D 37 30 33 61 62 61 64 38 66 65 65 32    0c9-703abad8fee2</span><br><span class="line">0100: 26 70 6C 61 74 66 6F 72 6D 3D 61 6E 64 72 6F 69    &amp;platform=androi</span><br><span class="line">0110: 64 26 73 69 64 3D 73 65 73 73 69 6F 6E 2E 31 37    d&amp;sid=session.17</span><br><span class="line">0120: 34 34 33 30 30 36 32 36 36 35 35 37 30 31 36 32    4430062665570162</span><br><span class="line">0130: 39 31 35 30 26 69 64 65 6E 74 69 66 69 65 72 5F    9150&amp;identifier_</span><br><span class="line">0140: 66 6C 61 67 3D 34 26 70 72 6F 6A 65 63 74 5F 69    flag=4&amp;project_i</span><br><span class="line">0150: 64 3D 45 43 46 41 41 46 26 78 5F 74 72 61 63 65    d=ECFAAF&amp;x_trace</span><br><span class="line">0160: 5F 70 61 67 65 5F 63 75 72 72 65 6E 74 3D 6C 6F    _page_current=lo</span><br><span class="line">0170: 67 69 6E 5F 66 75 6C 6C 5F 73 63 72 65 65 6E 5F    gin_full_screen_</span><br><span class="line">0180: 70 77 64 5F 70 61 67 65 26 6C 61 6E 67 3D 7A 68    pwd_page&amp;lang=zh</span><br><span class="line">0190: 2D 48 61 6E 73 26 61 70 70 5F 69 64 3D 45 43 46    -Hans&amp;app_id=ECF</span><br><span class="line">01A0: 41 41 46 30 31 26 75 69 73 3D 6C 69 67 68 74 26    AAF01&amp;uis=light&amp;</span><br><span class="line">01B0: 74 65 65 6E 61 67 65 72 3D 30 26 61 63 74 69 76    teenager=0&amp;activ</span><br><span class="line">01C0: 65 5F 63 74 72 79 3D 43 4E 26 63 70 75 5F 6E 61    e_ctry=CN&amp;cpu_na</span><br><span class="line">01D0: 6D 65 3D 51 75 61 6C 63 6F 6D 6D 2B 54 65 63 68    me=Qualcomm+Tech</span><br><span class="line">01E0: 6E 6F 6C 6F 67 69 65 73 25 32 43 2B 49 6E 63 2B    nologies%2C+Inc+</span><br><span class="line">01F0: 53 4D 38 31 35 30 26 64 6C 61 6E 67 3D 7A 68 26    SM8150&amp;dlang=zh&amp;</span><br><span class="line">0200: 6C 61 75 6E 63 68 5F 69 64 3D 31 37 34 34 34 33    launch_id=174443</span><br><span class="line">0210: 36 33 39 32 26 6F 76 65 72 73 65 61 73 5F 63 68    6392&amp;overseas_ch</span><br><span class="line">0220: 61 6E 6E 65 6C 3D 30 26 6D 6C 61 6E 67 75 61 67    annel=0&amp;mlanguag</span><br><span class="line">0230: 65 3D 7A 68 5F 63 6E 26 66 6F 6C 64 65 72 5F 74    e=zh_cn&amp;folder_t</span><br><span class="line">0240: 79 70 65 3D 6E 6F 6E 65 26 61 75 74 6F 5F 74 72    ype=none&amp;auto_tr</span><br><span class="line">0250: 61 6E 73 3D 30 26 74 3D 31 37 34 34 34 33 36 33    ans=0&amp;t=17444363</span><br><span class="line">0260: 38 35 26 62 75 69 6C 64 3D 38 37 37 30 32 39 39    85&amp;build=8770299</span><br><span class="line">0270: 26 68 6F 6C 64 65 72 5F 63 74 72 79 3D 43 4E 26    &amp;holder_ctry=CN&amp;</span><br><span class="line">0280: 64 69 64 3D 32 64 33 35 31 62 62 65 66 31 64 62    did=2d351bbef1db</span><br><span class="line">0290: 38 33 38 63 35 66 63 64 36 62 36 37 61 34 61 61    838c5fcd6b67a4aa</span><br><span class="line">02A0: 31 64 62 35 38 38 70 6C 61 74 66 6F 72 6D 3D 61    1db588platform=a</span><br><span class="line">02B0: 6E 64 72 6F 69 64 26 62 75 69 6C 64 3D 38 37 37    ndroid&amp;build=877</span><br><span class="line">02C0: 30 32 39 39 26 64 65 76 69 63 65 49 64 3D 35 31    0299&amp;deviceId=51</span><br><span class="line">02D0: 38 64 66 65 39 36 2D 37 66 36 66 2D 33 37 30 61    8dfe96-7f6f-370a</span><br><span class="line">02E0: 2D 38 65 38 30 2D 66 39 34 66 38 38 33 38 65 36    -8e80-f94f8838e6</span><br><span class="line">02F0: 64 65 66 73 3D 30 26 70 6F 69 6E 74 3D 31 39 33    defs=0&amp;point=193</span><br><span class="line">0300: 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    2...............</span><br><span class="line">// x2</span><br><span class="line">0xc</span><br><span class="line">// 返回值</span><br><span class="line">0000: 81 97 7E 83 36 B7 43 2D 01 34 A6 A4 34 6C 32 06    ..~.6.C-.4..4l2.</span><br><span class="line"></span><br><span class="line">// 第4次调用</span><br><span class="line">// x0</span><br><span class="line">0000: 81 97 7E 83 36 B7 43 2D 01 34 A6 A4 34 6C 32 06    ..~.6.C-.4..4l2.</span><br><span class="line">// x1</span><br><span class="line">0000: 32 80 00 00 00 00 00 00 00 00 00 00 00 00 00 00    2...............</span><br><span class="line">0010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">0020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">0030: 00 00 00 00 00 00 00 00 08 1A 00 00 00 00 00 00    ................</span><br><span class="line">// x2</span><br><span class="line">0x1</span><br><span class="line">// 返回值</span><br><span class="line">0000: 8D 67 06 8C 91 18 85 7B FB 78 DB 01 59 F2 09 69    .g.....&#123;.x..Y..i</span><br><span class="line"></span><br><span class="line">// 第5次调用</span><br><span class="line">// x0</span><br><span class="line">0000: 29 9A 8E 4B 77 48 EA 98 E3 E3 DF 8C C7 D2 4B 4A    )..KwH........KJ</span><br><span class="line">// x1</span><br><span class="line">0000: 8D 67 06 8C 91 18 85 7B FB 78 DB 01 59 F2 09 69    .g.....&#123;.x..Y..i</span><br><span class="line">0010: 80 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">0020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">0030: 00 00 00 00 00 00 00 00 80 02 00 00 00 00 00 00    ................</span><br><span class="line">// x2</span><br><span class="line">0x1</span><br><span class="line">// 返回值</span><br><span class="line">0000: 72 4B A0 52 97 97 13 0E 0B C3 00 2F BF C2 C7 5F    rK.R......./..._</span><br></pre></td></tr></table></figure>

<p>注意到，第5次调用sub_93390的返回值正是我们需要的16字节。</p>
<p>同时发现：</p>
<ol>
<li>第1次调用的返回值，是第3次加密的魔数值——0x36与key异或作为输入，魔数是标准md5魔数；</li>
<li>第2次调用的返回值，是第5次加密的魔数值——0x5C与key异或作为输入，魔数是标准md5魔数；</li>
<li>第3次调用的返回值，是第4次加密的魔数值——明文url + xy-common-params + xy-direction + platform + build + deviceId + xy-scene作为输入，魔数是第1次调用的返回值；</li>
<li>第4次调用的返回值，是第5次加密的输入——第4次调用的输入是第3次加密中，末尾不足64字节的部分；如果第3次调用刚好满足每组都是64字节，第4次调用的输入将是0x80开头，然后在最后的8个字节中，会描述前面的所有块的大小。</li>
<li>第5次加密就是将第4次的16字节进行了填充得到最终的16字节。</li>
</ol>
<p>单独看每次调用，其实每次调用都是魔改MD5算法，而将5次魔改MD5的调用合在一起，就是一个HMAC-MD5调用，整个流程应该这样子理解：</p>
<p>第1次调用魔改MD5，是对**（密钥 ^ 0x36）<strong>的结果进行的魔改MD5运算，这一次调用的目的是获得用作第3次调用的魔数（16字节），这16字节并非是用来作为</strong>K’**，再次说明：密钥是64字节，不需要经过MD5运算获得16字节，再填充至64字节，这里进行MD5仅仅是为了获得第3次调用的魔数，因为第3次调用是第1次调用的延续。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608213042711.png" alt="image-20250608213042711"></p>
<p>暂时不管第2次调用。</p>
<p>第3次调用魔改MD5，是对明文进行计算MD5的值，明文长度为0x301字节，魔数是第1次调用的结果（16字节）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608213356686.png" alt="image-20250608213356686"></p>
<p>按照HMAC-MD5计算方式，K’是密钥，ipad是64个字节的0x36，两者异或后还是64字节，然后拼接上明文，再进行魔改的MD5运算，这时候，输入MD5运算的长度是0x301+0x40，即0x341字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608213042711.png" alt="image-20250608213042711"></p>
<p>而MD5运算，一次处理64字节，如果最后一组不满64字节，则填充448位，最后8字节用来表示这一次输入MD5运算的位数是多少。0x341个字节，即输入了0x1A08位数据。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608214219574.png" alt="image-20250608214219574" style="zoom:80%;" />

<p>第4次调用，单独处理1个字节，因为0x341个字节，可以分为13个64字节分组和单独1个字节，第4次调用就是处理这个字节的，注意下图，0x32后填充了一个0x80（即后面填充一个1和“无数”个0），而最后8字节是0x1A08，代表着处理的位数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608214446344.png" alt="image-20250608214446344" style="zoom:67%;" />

<p>将第1、3、4次调用放在一块看，最后获得了<strong>HMAC-MD5</strong>这一步的结果。↓</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608213042711.png" alt="image-20250608213042711"></p>
<p>第2次调用是获得（K’ ^ 0x5C）的MD5运算后的结果（16字节），用来作为第5次调用的魔数（因为在附加连接的时候，是K’在前面，说白了，魔数代表着前面几次MD5运算的结果）。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608214939057.png" alt="image-20250608214939057" style="zoom:80%;" />

<p>第5次调用，是计算H(K’ ^ 0x5C || H(K’ ^ 0x36 || 明文)) ，输入是（K’ ^ 0x5C）|| （第1、3、4次调用的结果），已知（K’ ^ 0x5C）是64字节，而（第1、3、4次调用的结果）肯定是16字节，所以一共是80字节。</p>
<p>下图中0x80是填充，最后8字节是0x280，即80字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608215911675.png" alt="image-20250608215911675"></p>
<p>到这里，也能理解之前为什么调用了16次sub_93F14。因为第1-5次调用sub_93390，分别执行了1、1、12、1、1次魔改MD5运算。</p>
<p>之所以说这是魔改MD5，是因为在个别轮次的运算，不是标准MD5的FF、GG、HH、II。</p>
<p>点开sub_93390。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609103836334.png" alt="image-20250609103836334" style="zoom:80%;" />

<p>根据日志，对sub_93390调用链进行分析，MD5一共64轮运算，将每轮运算依次与标准MD5进行对比。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609112747484.png" alt="image-20250609112747484" style="zoom: 50%;" />

<p>在日志中，追踪BR跳转，sub_94970是第1个较为“完整”的函数。（这里的完整指的是：有些函数的伪代码在IDA的分析下，显示为直接BR跳转；而这个函数会先执行一些操作再跳转）</p>
<p>根据动调，发现前4行代码加载了魔数，第5行代码加载了待加密数据的地址，具体内容写在注释上了…函数sub_94970似乎在为MD5的第一轮运算做准备。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609135943423.png" alt="image-20250609135943423"></p>
<p>接下来，来到函数sub_95080，这应该是md5的<strong>第一轮加密</strong>。循环左移7位变成了6位。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609144742615.png" alt="image-20250609144742615"></p>
<p>hook了一下v7+132的位置应该是T盒，但并不是标准的T盒。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609150053963.png" alt="image-20250609150053963"></p>
<p>函数sub_95654，为明文的第2、3个字做准备。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609152424760.png" alt="image-20250609152424760"></p>
<p>函数sub_93DD8中，MD5<strong>第二轮加密</strong>。循环左移12位变成了循环左移13位。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609154735081.png" alt="image-20250609154735081"></p>
<p>具体的不在这里一一分析，做个总结。</p>
<h5 id="魔改左移操作数"><a href="#魔改左移操作数" class="headerlink" title="魔改左移操作数"></a>魔改左移操作数</h5><p>第43轮的左移操作数被改，在地址<code>0x93AC8</code>处，<strong>原操作数为 16，被改为 11</strong></p>
<p>第42轮的左移操作数被改，在地址<code>0x93A90</code>处，<strong>原操作数为11 ，被改为 16</strong></p>
<p>第41轮的左移操作数被改，在地址<code>0x93A78</code>处，<strong>原操作数为 4，被改为 23</strong></p>
<p>第40轮的左移操作数被改，在地址<code>0x94368</code>处，<strong>原操作数为 23，被改为 4</strong></p>
<p>第14轮的左移操作数被改，在地址<code>0x9480C</code>处，<strong>原操作数为 12，被改为 13</strong></p>
<p>第11轮的左移操作数被改，在地址<code>0x94E00</code>处，<strong>原操作数为 17，被改为 16</strong></p>
<p>第8轮的左移操作数被改，在地址<code>0x93888</code>处，<strong>原操作数为 22，被改为 20</strong></p>
<p>第4轮的左移操作数被改，在地址<code>0x952E4</code>处，<strong>原操作数为 22，被改为 21</strong></p>
<p>第2轮的左移操作数被改，在地址<code>0x93E28</code>处，<strong>原操作数为 12，被改为 13</strong></p>
<p>第1轮的左移操作数被改，在地址<code>0x950F0</code>处，所属函数<code>sub_95080</code>，<strong>原操作数为 7 ，被改为 6</strong></p>
<h5 id="魔改T值"><a href="#魔改T值" class="headerlink" title="魔改T值"></a>魔改T值</h5><p>标准MD5的T值是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> t[] = &#123;</span><br><span class="line">      <span class="number">0xd76aa478</span>, <span class="number">0xe8c7b756</span>, <span class="number">0x242070db</span>, <span class="number">0xc1bdceee</span>, <span class="number">0xf57c0faf</span>, <span class="number">0x4787c62a</span>, <span class="number">0xa8304613</span>, <span class="number">0xfd469501</span>,</span><br><span class="line">      <span class="number">0x698098d8</span>, <span class="number">0x8b44f7af</span>, <span class="number">0xffff5bb1</span>, <span class="number">0x895cd7be</span>, <span class="number">0x6b901122</span>, <span class="number">0xfd987193</span>, <span class="number">0xa679438e</span>, <span class="number">0x49b40821</span>,</span><br><span class="line">      <span class="number">0xf61e2562</span>, <span class="number">0xc040b340</span>, <span class="number">0x265e5a51</span>, <span class="number">0xe9b6c7aa</span>, <span class="number">0xd62f105d</span>, <span class="number">0x02441453</span>, <span class="number">0xd8a1e681</span>, <span class="number">0xe7d3fbc8</span>,</span><br><span class="line">      <span class="number">0x21e1cde6</span>, <span class="number">0xc33707d6</span>, <span class="number">0xf4d50d87</span>, <span class="number">0x455a14ed</span>, <span class="number">0xa9e3e905</span>, <span class="number">0xfcefa3f8</span>, <span class="number">0x676f02d9</span>, <span class="number">0x8d2a4c8a</span>,</span><br><span class="line">      <span class="number">0xfffa3942</span>, <span class="number">0x8771f681</span>, <span class="number">0x6d9d6122</span>, <span class="number">0xfde5380c</span>, <span class="number">0xa4beea44</span>, <span class="number">0x4bdecfa9</span>, <span class="number">0xf6bb4b60</span>, <span class="number">0xbebfbc70</span>,</span><br><span class="line">      <span class="number">0x289b7ec6</span>, <span class="number">0xeaa127fa</span>, <span class="number">0xd4ef3085</span>, <span class="number">0x04881d05</span>, <span class="number">0xd9d4d039</span>, <span class="number">0xe6db99e5</span>, <span class="number">0x1fa27cf8</span>, <span class="number">0xc4ac5665</span>,</span><br><span class="line">      <span class="number">0xf4292244</span>, <span class="number">0x432aff97</span>, <span class="number">0xab9423a7</span>, <span class="number">0xfc93a039</span>, <span class="number">0x655b59c3</span>, <span class="number">0x8f0ccc92</span>, <span class="number">0xffeff47d</span>, <span class="number">0x85845dd1</span>,</span><br><span class="line">      <span class="number">0x6fa87e4f</span>, <span class="number">0xfe2ce6e0</span>, <span class="number">0xa3014314</span>, <span class="number">0x4e0811a1</span>, <span class="number">0xf7537e82</span>, <span class="number">0xbd3af235</span>, <span class="number">0x2ad7d2bb</span>, <span class="number">0xeb86d391</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>而魔改的T值是：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="type">56 B7 C9 E9 79 A4 1B D7 DB 81 10 24 D9 88 10 68    V</span>...y......$...h</span><br><span class="line"><span class="number">0010</span>: <span class="type">AF F7 14 9B B1 5B 1F FF BE D7 1C 88 22 61 66 66    </span>.....[......<span class="string">&quot;aff</span></span><br><span class="line"><span class="string">0020: 93 61 66 F6 9E 63 19 A6 21 09 14 49 EE CE 1D C1    .af..c..!..I....</span></span><br><span class="line"><span class="string">0030: AF 0F 1C F5 2A C6 17 47 13 46 10 A9 01 95 16 FD    ....*..G.F......</span></span><br><span class="line"><span class="string">0040: 00 25 00 F6 53 14 74 02 91 E6 21 D2 C9 11 00 E2    .%..S.t...!.....</span></span><br><span class="line"><span class="string">0050: E6 CD 61 22 97 0D D5 F2 ED 14 5A 42 05 E9 77 A2    ..a&quot;</span>......ZB..w.</span><br><span class="line"><span class="number">0060</span>: <span class="type">F9 A3 77 F2 D9 12 6F 62 9A 4C 2A 92 48 F2 39 12    </span>..w...ob.L*.H<span class="number">.9</span>.</span><br><span class="line"><span class="number">0070</span>: <span class="type">00 00 00 00 40 B3 40 C0 51 5A 5E 26 00 00 10 E9    </span>....<span class="meta">@.@.QZ^&amp;....</span></span><br><span class="line"><span class="number">0080</span>: <span class="type">5D 10 3F D6 D6 07 57 C3 42 39 FC FF 91 D6 7C 97    </span>].?...W.B9....|.</span><br><span class="line"><span class="number">0090</span>: <span class="type">44 EA BC A4 A9 CF DC 4B 70 BC BC BE C6 7E 8C 28    D</span>......Kp....~.(</span><br><span class="line"><span class="number">00</span>A0: <span class="type">60 4B CC F6 95 10 EC D4 FA 27 AC EA E5 88 DC E6    </span>`K.......<span class="string">&#x27;......</span></span><br><span class="line"><span class="string">00B0: 39 D0 DC D9 05 1D 8C 04 F9 7C A2 1F 90 F2 39 12    9........|....9.</span></span><br><span class="line"><span class="string">00C0: 00 00 00 00 22 61 9D 6D 65 56 AC C4 1C 39 E5 FD    ....&quot;a.meV...9..</span></span><br><span class="line"><span class="string">00D0: 44 22 29 F4 A7 23 94 AB 39 A0 93 F5 C3 59 5B 65    D&quot;)..#..9....Y[e</span></span><br><span class="line"><span class="string">00E0: 97 FF 2A 45 7D 24 EF F5 D1 5D 84 85 92 CC 0C 85    ..*E&#125;<span class="subst">$...]......</span></span></span><br><span class="line"><span class="subst"><span class="string">00F0: E0 26 99 F9 C0 F2 39 12 00 00 00 00 D6 A9 97 EF    .&amp;....9.........</span></span></span><br><span class="line"><span class="subst"><span class="string">0100: 4F 7E 99 F9 14 43 99 A9 82 7E 53 C5 A1 11 08 45    O~...C...~S....E</span></span></span><br><span class="line"><span class="subst"><span class="string">0110: A6 11 08 45 35 F2 3A BD 91 D3 86 EB</span></span></span><br></pre></td></tr></table></figure>

<p>为什么魔改后的T表比标准T表大呢？——多了7个4字节。</p>
<p>在函数sub_93BA4中，执行了第26、27、28轮运算，v0[59]是第27轮的t，v0[62]是第28轮的t，中间跳过了v0[60]、v0[61]，也就是2个4字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609155821938.png" alt="image-20250609155821938"></p>
<p>在函数sub_951A8中，执行了第45、46、47轮运算。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609160301578.png" alt="image-20250609160301578" style="zoom: 50%;" />

<p>而在函数sub_93A4C中，执行了第42、43、44轮运算，第45轮的t是v1[79]。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609160958764.png" alt="image-20250609160958764" style="zoom:80%;" />

<p>v1和v5基址一样，v1[79]到v5[82]，跳过了2个4字节，也就是8字节。</p>
<p>在函数sub_93CB4中，执行了第56、57、58轮运算，又跳过了3个4字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609160740608.png" alt="image-20250609160740608"></p>
<p>总共跳过了2 + 2 + 3个4字节，共计7个4字节，因此魔改后的T表多了7个4字节。</p>
<h5 id="入参顺序修改"><a href="#入参顺序修改" class="headerlink" title="入参顺序修改"></a>入参顺序修改</h5><p>假设HH的签名是HH（A，B，C，D，Mi，s，Ti）。</p>
<p>40轮：37轮结果对应为A位置，36轮结果对应B，38-39分别对应C-D，明文块取下标13</p>
<p>41轮：36轮结果对应为A位置，39轮结果对应B，38-40分别对应C-D，明文块取下标10</p>
<p>42轮：39轮结果对应为A位置，38轮结果对应B，40-41分别对应C-D，明文块取下标3</p>
<p>43轮：38轮结果对应为A位置，40轮结果对应B，41-42分别对应C-D，明文块取下标0</p>
<p>以第40轮的入参为例子。</p>
<p>标准MD5的情况下，原本第40轮的bcda分别来自于第36、39、38、37轮。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609163752074.png" alt="image-20250609163752074" style="zoom:67%;" />

<p>在函数sub_957D4中，v1-200存放着第36轮的结果b。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609164111974.png" alt="image-20250609164111974"></p>
<p>在函数sub_936C0中：</p>
<p>v2-196存放着第37轮的结果a。</p>
<p>v2-192存放着第38轮的结果d。</p>
<p>v2-188存放着第39轮的结果c。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609164347432.png" alt="image-20250609164347432"></p>
<p>正常的第40轮，应该是：HH(v-200, v-188, v-192, v-196，M10，23，tj)，展开后应该是这样子：</p>
<p>a &#x3D; (v-188) + (((v-200) + H(v-188, v-192, v-196) + M10 + tj) &lt;&lt;23)。</p>
<p>在函数sub_94344中是：HH(v-196, v-200, v-192, v-188, M13, 4, tj)。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609174510357.png" alt="image-20250609174510357"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609174519494.png" alt="image-20250609174519494"></p>
<p>同时发现，如果对第40轮取的明文进行打印，对应的M是第13块（下标），而非第10块，这里不过多赘述了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609175346841.png" alt="image-20250609175346841"></p>
<h4 id="魔改AES，还原Q0"><a href="#魔改AES，还原Q0" class="headerlink" title="魔改AES，还原Q0"></a>魔改AES，还原Q0</h4><p>现在只剩下最后2个问题：</p>
<p><strong>一是</strong>之前Q0与Q1异或的结果是0x4，Q1是硬编码在文件中的，而Q0则涉及很多内容，对栈、堆下断点，一点一点追踪Q0的内容十分困难。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250604131821514.png" alt="image-20250604131821514"></p>
<p><strong>二是</strong>HMAC-MD5的密钥是哪里来的？</p>
<p>根据后来的结果，只要解决问题二，问题一就顺带解决了。</p>
<p>x1指向的内容，是密钥与0x36异或的结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 第1次调用</span><br><span class="line">// x0</span><br><span class="line">0000: 76 54 32 10 FE DC BA 98 89 AB CD EF 01 23 45 67    vT2..........#Eg</span><br><span class="line">// x1（key与0x36的结果）</span><br><span class="line">0000: 6A 3E 23 D6 BC E6 B7 B9 C6 D2 4B D7 6C 78 02 D9    j&gt;#.......K.lx..</span><br><span class="line">0010: 72 84 55 82 03 93 5F 6E 20 B3 32 87 75 82 F9 8D    r.U..._n .2.u...</span><br><span class="line">0020: 38 43 90 71 D4 5C B9 1A 8D 63 39 3D F7 94 59 C7    8C.q.\...c9=..Y.</span><br><span class="line">0030: 7C 27 5A FD 1D 68 77 A5 BE 4D 91 14 E5 8D 0E 51    |&#x27;Z..hw..M.....Q</span><br><span class="line">// x2</span><br><span class="line">0x1</span><br><span class="line">// 返回值</span><br><span class="line">0000: 39 0A 80 0F EC FE 50 43 EE 54 1F 5B 06 9C 47 8B    9.....PC.T.[..G.</span><br></pre></td></tr></table></figure>

<p>再次异或0x36，获得key。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">5c 08 15 e0 8a d0 81 8f f0 e4 7d e1 5a 4e 34 ef </span><br><span class="line">44 b2 63 b4 35 a5 69 58 16 85 04 b1 43 b4 cf bb </span><br><span class="line">0e 75 a6 47 e2 6a 8f 2c bb 55 0f 0b c1 a2 6f f1 </span><br><span class="line">4a 11 6c cb 2b 5e 41 93 88 7b a7 22 d3 bb 38 67</span><br></pre></td></tr></table></figure>

<p>存放（密钥^0x36）的栈地址是0xe4fff320，在这里下一个写断点。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250608201229798.png" alt="image-20250608201229798" style="zoom:80%;" />

<p>偏移0x91708的位置。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609181802867.png" alt="image-20250609181802867"></p>
<p>说明密钥来自于[x25, #0x24]往后的64个字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609182441095.png" alt="image-20250609182441095"></p>
<p>地址是0x123e7024。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609182616292.png" alt="image-20250609182616292"></p>
<p>对0x123e7024下一个写断点。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609182703626.png" alt="image-20250609182703626" style="zoom:80%;" />

<p>偏移0x916d0。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609182802659.png" alt="image-20250609182802659"></p>
<p>在0x926B8下断点，获得X24的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609184353374.png" alt="image-20250609184353374"></p>
<p>再对0x123e2000下一个写断点。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609184832996.png" alt="image-20250609184832996"></p>
<p>这里的偏移是0x911c8，0x1c1f8是libc的偏移，所以这里看LR寄存器。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609185526029.png" alt="image-20250609185526029"></p>
<p>hook 0x911C4，获取源地址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609185748505.png" alt="image-20250609185748505"></p>
<p>再在0xe4fff644下写断点，看看哪里往里写。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609185904231.png" alt="image-20250609185904231"></p>
<p>偏移0x9eddc。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609190228611.png" alt="image-20250609190228611"></p>
<p>在0x9edc4下断点，查看x24和x8.</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609190344879.png" alt="image-20250609190344879"></p>
<p>在0x123df100下写断点。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609190715406.png" alt="image-20250609190715406" style="zoom:80%;" />

<p>偏移0x91c84。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609191030509.png" alt="image-20250609191030509"></p>
<p>在0x91C80下断点，查看src。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609191128512.png" alt="image-20250609191128512"></p>
<p>在0x123dc070下个写断点。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609191218148.png" alt="image-20250609191218148"></p>
<p>偏移0x9aab8，之前分析第1-2字节的时候，遇到过这个偏移。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609191250304.png" alt="image-20250609191250304"></p>
<p>密钥来源于Q1、Q0的16字节异或的结果。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609191321658.png" alt="image-20250609191321658"></p>
<p>在0x9AAB4下断点，查看Q0、Q1的值。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609200150702.png" alt="image-20250609200150702" style="zoom: 67%;" />

<p>一共经历了6次地址0x9AAB4。</p>
<p>第1轮异或的结果是0x4，是我们之前想探究的2个字节的来源。</p>
<p>第2、3、4、5轮异或的结果合在一块，是密钥的64字节。</p>
<p>第6轮异或的结果像是<strong>PKCS7</strong>填充方式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">// 1</span><br><span class="line">q0=0x3966170766667a666108020434320135</span><br><span class="line">q1=0x3966170766667a666108020434320131</span><br><span class="line">// 结果</span><br><span class="line">q0=0x4</span><br><span class="line"></span><br><span class="line">// 2</span><br><span class="line">q0=0xbf8a86b75c5aa6988a18500d97aec16e</span><br><span class="line">q1=0x50bec8edbd2742680599808777bbc932</span><br><span class="line">// 结果</span><br><span class="line">q0=0xef344e5ae17de4f08f81d08ae015085c</span><br><span class="line"></span><br><span class="line">// 3</span><br><span class="line">q0=0x57ef40c30996ef5928798ead0a1f8562</span><br><span class="line">q1=0xec20f480b8926a4f70102b98be7c3726</span><br><span class="line">// 结果</span><br><span class="line">q0=0xbbcfb443b10485165869a535b463b244</span><br><span class="line"></span><br><span class="line">// 4</span><br><span class="line">q0=0x23cec11b0d7991d1bd27b2b6ecfdc56</span><br><span class="line">q1=0xf3534ed0bbd8cca6375d11c92969a958</span><br><span class="line">// 结果</span><br><span class="line">q0=0xf16fa2c10b0f55bb2c8f6ae247a6750e</span><br><span class="line"></span><br><span class="line">// 5</span><br><span class="line">q0=0xf78b842c37084a18aebc2f6959061f3f</span><br><span class="line">q1=0x90b33fff15af31903dfd7142926a0e75</span><br><span class="line">// 结果</span><br><span class="line">q0=0x6738bbd322a77b8893415e2bcb6c114a</span><br><span class="line"></span><br><span class="line">// 6</span><br><span class="line">q0=0x82a9df8040ac9909aee06a8949973ab0</span><br><span class="line">q1=0x92b9cf9050bc8919bef07a9959872aa0</span><br><span class="line">// 结果</span><br><span class="line">q0=0x10101010101010101010101010101010</span><br></pre></td></tr></table></figure>

<p>注意到，x19里面的地址，都是从x24里面取出来的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609200122406.png" alt="image-20250609200122406"></p>
<p>x24指向的内容如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609200009519.png" alt="image-20250609200009519"></p>
<p>监控一下0x120b4000。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609201052310.png" alt="image-20250609201052310"></p>
<p>发现监控不到。。。</p>
<p>在IDA的伪代码中进行追踪。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609201701983.png" alt="image-20250609201701983"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609201718228.png" alt="image-20250609201718228"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609201736475.png" alt="image-20250609201736475"></p>
<p>打印一下result。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609201816219.png" alt="image-20250609201816219" style="zoom:67%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609201833193.png" alt="image-20250609201833193" style="zoom:67%;" />

<p>后面发现，这里的x24源于hmac_main的值，hmac_main进行base64解码后的内容和它一模一样。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609200009519.png" alt="image-20250609200009519"></p>
<p>前面0x40字节在异或后是hmac-md5的密钥，而0x40-&gt;0x50字节抑或后是pkcs7填充的内容。</p>
<p>再对x22指向的0xe4fff148进行监控。（Q0）</p>
<p>之前追踪过0x9a064，找不到结果，这回追踪LR。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609205604237.png" alt="image-20250609205604237"></p>
<p>写的操作都发生在sub_994AC中，sub_994AC累积执行了6次。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609205746004.png" alt="image-20250609205746004"></p>
<p>偏移0x9a9cc位于函数sub_9A728，对这个函数分析，发现这个函数实现了一个<strong>对称分组密码</strong>的<strong>加密和解密</strong>操作，使用模式是CBC。</p>
<p>if(a6)分支实现了CBC加密模式。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609210746105.png" alt="image-20250609210746105" style="zoom:80%;" />

<p>if(a3)分支实现了CBC解密模式。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609210816395.png" alt="image-20250609210816395" style="zoom: 80%;" />

<p>根据分析，a5是IV，即初始化向量（盐），<strong>这是之前Q1的值</strong>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609211022402.png" alt="image-20250609211022402"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609211109670.png" alt="image-20250609211109670" style="zoom: 80%;" />

<p>hook函数sub_994AC，查看它的入参。</p>
<p>注意到，第1次执行，对“32 C9 BB 77 87 80 99 05 68 42 27 BD ED C8 BE 50”解密，获得了“35 01 32 34 04 02 08 61 66 7A 66 66 07 17 66 39”，而“35 01 32 34 04 02 08 61 66 7A 66 66 07 17 66 39”正是0x9AAB4第一轮异或的Q0！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">第1次执行</span><br><span class="line">X0</span><br><span class="line">32 C9 BB 77 87 80 99 05 68 42 27 BD ED C8 BE 50</span><br><span class="line">X1</span><br><span class="line">58 97 27 12 0A 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">返回值（第2次执行时的X1）</span><br><span class="line">35 01 32 34 04 02 08 61 66 7A 66 66 07 17 66 39</span><br><span class="line"></span><br><span class="line">第2次执行</span><br><span class="line">X0</span><br><span class="line">26 37 7C BE 98 2B 10 70 4F 6A 92 B8 80 F4 20 EC</span><br><span class="line">X1</span><br><span class="line">35 01 32 34 04 02 08 61 66 7A 66 66 07 17 66 39</span><br><span class="line">返回值（第3次执行时的X1）</span><br><span class="line">6E C1 AE 97 0D 50 18 8A 98 A6 5A 5C B7 86 8A BF</span><br><span class="line"></span><br><span class="line">第3次执行</span><br><span class="line">X0</span><br><span class="line">58 A9 69 29 C9 11 5D 37 A6 CC D8 BB D0 4E 53 F3</span><br><span class="line">X1</span><br><span class="line">6E C1 AE 97 0D 50 18 8A 98 A6 5A 5C B7 86 8A BF</span><br><span class="line">返回值（第4次执行时的X1）</span><br><span class="line">62 85 1F 0A AD 8E 79 28 59 EF 96 09 C3 40 EF 57</span><br><span class="line"></span><br><span class="line">第4次执行</span><br><span class="line">X0</span><br><span class="line">75 0E 6A 92 42 71 FD 3D 90 31 AF 15 FF 3F B3 90</span><br><span class="line">X1</span><br><span class="line">62 85 1F 0A AD 8E 79 28 59 EF 96 09 C3 40 EF 57</span><br><span class="line">返回值（第5次执行时的X1）</span><br><span class="line"></span><br><span class="line">第5次执行</span><br><span class="line">X0</span><br><span class="line">A0 2A 87 59 99 7A F0 BE 19 89 BC 50 90 CF B9 92</span><br><span class="line">X1</span><br><span class="line">56 DC CF 6E 2B 7B D2 1B 1D 99 D7 B0 11 EC 3C 02</span><br><span class="line">返回值（第6次执行时的X1）</span><br><span class="line">3F 1F 06 59 69 2F BC AE 18 4A 08 37 2C 84 8B F7</span><br><span class="line"></span><br><span class="line">第6次执行</span><br><span class="line">X0</span><br><span class="line">9B 48 8F D1 39 69 CA C2 54 E2 0A F2 0C 1C 4C 98</span><br><span class="line">X1</span><br><span class="line">3F 1F 06 59 69 2F BC AE 18 4A 08 37 2C 84 8B F7</span><br><span class="line">返回值</span><br><span class="line">b0 3a 97 49 89 6a3 e0 ae 09 99 ac 40 80 df a9 82</span><br></pre></td></tr></table></figure>

<p>sub_9A728采用了CBC模式，而函数sub_994AC每次处理又是16字节，这大概率是一个AES加解密。sub_994AC的第一个参数的待解密的16字节，第二个参数存放结果，第三个参数是轮密钥。</p>
<p>s.xml文件里存放的是密文。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250609200009519.png" alt="image-20250609200009519"></p>
<p>第1个16字节作为密文0，在AES解密后生成<strong>中间值[0]</strong>，中间值[0]就是35 01 32 34 04 02 08 61 66 7A 66 66 07 17 66 39，中间值[0]再与盐IV “31 01 32 34 04 02 08 61 66 7A 66 66 07 17 66 39”进行异或，生成明文[0]——0x4。</p>
<p>所以说，这里的明文0x4是固定的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610101307202.png" alt="image-20250610101307202"></p>
<p>第2个16字节作为密文1，在AES解密后生成中间值[1]，中间值1就是6E C1 AE 97 0D 50 18 8A 98 A6 5A 5C B7 86 8A BF，中间值[1]再与密文0（32 C9 BB 77 87 80 99 05 68 42 27 BD ED C8 BE 50）进行异或，生成明文[1]——0xef344e5ae17de4f08f81d08ae015085c。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610101528397.png" alt="image-20250610101528397"></p>
<p>…以此类推，最后获得的内容是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 明文[0]，固定字节</span><br><span class="line">q0=0x4</span><br><span class="line"></span><br><span class="line">// 明文[1-4]，用作HMAC-MD5的密钥</span><br><span class="line">q0=0xef344e5ae17de4f08f81d08ae015085c</span><br><span class="line">q0=0xbbcfb443b10485165869a535b463b244</span><br><span class="line">q0=0xf16fa2c10b0f55bb2c8f6ae247a6750e</span><br><span class="line">q0=0x6738bbd322a77b8893415e2bcb6c114a</span><br><span class="line"></span><br><span class="line">// PKCS7填充</span><br><span class="line">q0=0x10101010101010101010101010101010</span><br></pre></td></tr></table></figure>

<p>也就是说，xhs服务器那边发来的xml文件，其实藏了0x4和MD5的密钥。</p>
<p>接下来还有2个疑惑AES是否魔改？密钥是什么？</p>
<p>为了解答疑惑，需要追踪函数sub_994AC，这个函数专门负责AES解密，难点在于，这个函数与魔改MD5一样，频繁通过BR跳转到别的函数，代码片段零零散散。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610104537106.png" alt="image-20250610104537106"></p>
<p>根据分析，每一次执行sub_994AC，最终都会调用下面这些函数。</p>
<p>0-3次循环都一样，第4次循环出现变化；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">994AC</span><br><span class="line">9a260				// 0-3字节：轮密钥加</span><br><span class="line">99e6c				// 4-7字节：轮密钥加</span><br><span class="line">9a40c				// 8-11字节：轮密钥加</span><br><span class="line">9a574				// 12-15字节：轮密钥加</span><br><span class="line">995e8</span><br><span class="line">99c40&lt;----循环0</span><br><span class="line">996d8				// 查表优化</span><br><span class="line">9a620				// 查表优化</span><br><span class="line">99a7c</span><br><span class="line">99564</span><br><span class="line">9a6ac</span><br><span class="line">9a2cc</span><br><span class="line">9991c&lt;&gt;</span><br><span class="line">9a0a0</span><br><span class="line">9a364</span><br><span class="line">99898</span><br><span class="line">9978c</span><br><span class="line">9a160</span><br><span class="line">99ee0</span><br><span class="line">99f74</span><br><span class="line">9969c</span><br><span class="line">99c40&lt;----循环1</span><br><span class="line">996d8</span><br><span class="line">9a620</span><br><span class="line">99a7c</span><br><span class="line">99564</span><br><span class="line">9a6ac</span><br><span class="line">9a2cc</span><br><span class="line">9991c&lt;&gt;</span><br><span class="line">9a0a0</span><br><span class="line">9a364</span><br><span class="line">99898</span><br><span class="line">9978c</span><br><span class="line">9a160</span><br><span class="line">99ee0</span><br><span class="line">99f74</span><br><span class="line">9969c</span><br><span class="line">99c40&lt;----循环2</span><br><span class="line">996d8</span><br><span class="line">9a620</span><br><span class="line">99a7c</span><br><span class="line">99564</span><br><span class="line">9a6ac</span><br><span class="line">9a2cc</span><br><span class="line">9991c&lt;&gt;</span><br><span class="line">9a0a0</span><br><span class="line">9a364</span><br><span class="line">99898</span><br><span class="line">9978c</span><br><span class="line">9a160</span><br><span class="line">99ee0</span><br><span class="line">99f74</span><br><span class="line">9969c</span><br><span class="line">99c40&lt;----循环3</span><br><span class="line">996d8</span><br><span class="line">9a620</span><br><span class="line">99a7c</span><br><span class="line">99564</span><br><span class="line">9a6ac</span><br><span class="line">9a2cc</span><br><span class="line">9991c&lt;&gt;</span><br><span class="line">9a0a0</span><br><span class="line">9a364</span><br><span class="line">99898</span><br><span class="line">9978c</span><br><span class="line">9a160</span><br><span class="line">99ee0</span><br><span class="line">99f74</span><br><span class="line">9969c</span><br><span class="line">99c40&lt;----循环4</span><br><span class="line">996d8</span><br><span class="line">9a620</span><br><span class="line">99a7c</span><br><span class="line">99564</span><br><span class="line">9a6ac</span><br><span class="line">9a2cc</span><br><span class="line">9991c&lt;&gt;</span><br><span class="line">9a4a0&lt;差异点&gt;</span><br><span class="line">9984c</span><br><span class="line">9a00c</span><br></pre></td></tr></table></figure>

<p>同时，之前提到的0x9a064位于函数sub_9A00C内部，0x9a064会在每次循环中，会修改下图的X22寄存器指向的地址，这间接改变了Q0的内容，而Q0指向解密后的中间值（之所以称作中间值，是因为CBC模式下，中间值还要和上一轮密文进行异或，才能得到最后的明文），这说明了执行到sub_9A00C的时候，已经完成了AES解密。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250605222117031.png" alt="image-20250605222117031"></p>
<p>开始分析上述函数——从sub_9A260开始。</p>
<p>hook函数sub_994AC的时候，第3个参数是轮密钥。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610150634104.png" alt="image-20250610150634104" style="zoom:80%;" />

<p>hook函数sub_9A260，发现下面的情况。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610151800401.png" alt="image-20250610151800401"></p>
<p>这说明sub_9A260在对密文进行“轮密钥加”。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610151117804.png" alt="image-20250610151117804"></p>
<h5 id="初始密钥"><a href="#初始密钥" class="headerlink" title="初始密钥"></a>初始密钥</h5><p>加密与解密的流程是反过来的，既然a3是轮密钥，可以倒推回初始密钥。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610180411680.png" alt="image-20250610180411680"></p>
<p>在0xE4FFF398下一个写断点，观察到偏移0x981b4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610181026760.png" alt="image-20250610181026760"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610181924741.png" alt="image-20250610181924741"></p>
<p>在偏移0x981A0处下一个断点，观察x2+x8。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610182010991.png" alt="image-20250610182010991"></p>
<p>往0xe4fff2f8下一个写断点。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610182136699.png" alt="image-20250610182136699"></p>
<p>偏移0x96a44，位于函数sub_96A14中。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610182337520.png" alt="image-20250610182337520"></p>
<p>hook一下函数sub_96A14，打印a1，a1是device_id的前16字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610182455586.png" alt="image-20250610182455586"></p>
<p>因此，aes密钥的种子是device_id。</p>
<h5 id="解密——Td表（未改动）"><a href="#解密——Td表（未改动）" class="headerlink" title="解密——Td表（未改动）"></a>解密——Td表（未改动）</h5><p>稍微分析了一下，AES解密采取的方式是查T表，查表的话AES的解密速率会快很多，但没有一般的特征了（行位移、字节替换等），所以不好分析。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610161717758.png" alt="image-20250610161717758" style="zoom: 67%;" />

<p>来到函数sub_996d8，0x6a5fcc9b是标准Td[0]表的4个字节，打印一下T表。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610162437314.png" alt="image-20250610162437314"></p>
<p>和标准的Td[0]表一模一样。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610164121960.png" alt="image-20250610164121960" style="zoom:80%;" />

<p>另外3个表会基于Td[0]进行生成，简单来说就是对基础表中的每一个32位数值执行<strong>字节的循环右移</strong>，因此可以根据Td[0]生成另外3个T表。经过对比，4个T表都是标准的。</p>
<h5 id="密钥扩展"><a href="#密钥扩展" class="headerlink" title="密钥扩展"></a>密钥扩展</h5><p>这里，我们为了追踪密钥扩展的函数，可以追踪初始密钥。</p>
<p>追踪sub_96A14的执行流，寻找对device_id进行处理加密，最终获得初始密钥的位置。</p>
<p>根据分析，在函数sub_96A14、sub_95A3C、sub_97100、sub_960F8中，完成了对初始密钥的构建。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610194708525.png" alt="image-20250610194708525"></p>
<p>已知，初始密钥是W[3:0]，是根据device_id异或4个固定的4字节生成的；（0-3轮密钥）</p>
<p>而接下来的第4-39轮密钥是根据查表的方式生成的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610200719014.png" alt="image-20250610200719014"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610200923629.png" alt="image-20250610200923629" style="zoom:80%;" />

<p>在日志中，发现了一个规律——最左边框框里面的轮密钥，统一由函数sub_980ac查表获得；左2的框框统一由函数sub_97490查表获得，左3的框框统一由函数sub_97980获得、左4的框框统一由sub_973a8查表获得。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610204851290.png" alt="image-20250610204851290"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610204754405.png" alt="image-20250610204754405"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610204723149.png" alt="image-20250610204723149"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610204634679.png" alt="image-20250610204634679"></p>
<p>这4个函数都只执行9次，生成了W[39:4]，此时，还未知W[43:40]的生成方式，但应该是正常的标准扩展方式。</p>
<p>正常的密钥扩展如下图所示。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610185453688.png" alt="image-20250610185453688" style="zoom: 50%;" />

<p>我们在日志中搜索W[43:40]的轮密钥——比如：搜索0x1070c115，然后来到第1次出现的地方。注意到，eor的w9和w12中并没有出现0xf0106B39，如果是标准的扩展算法，应该会出现0xf0106B39的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610211445431.png" alt="image-20250610211445431"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610214036112.png" alt="image-20250610214036112"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610214119895.png" alt="image-20250610214119895"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610214218532.png" alt="image-20250610214218532"></p>
<p>可以看到，T函数明显被修改了，除此之外，W[43:40]的结果本来是两个轮密钥异或的结果，但在上图中，由一个轮密钥和一个未知的4字节异或得到的。</p>
<p>密钥扩展中最后4轮密钥是如何生成的？涉及到查S盒、字节替换、Rcon等——需要交叉引用96b08、96d5c。</p>
<p>这里简单过一下，具体算法还原先不做，快秋招了，得做点其它的事情，补充一下开发能力QwQ，害，怎么感觉这么难呢，我好菜。</p>
<p>以W[40]为例，W[40] &#x3D; <code>*(_DWORD *)(a1 + 60) = *(_DWORD *)(a1 + 52) ^ *(_DWORD *)(a1 + 56);</code></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610221100210.png" alt="image-20250610221100210" style="zoom:80%;" />

<p>需要hook一下，获得a1+52、a1+44、a1+48等值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610221500239.png" alt="image-20250610221500239"></p>
<p>它们的值又来源于sub_97230。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610221602792.png" alt="image-20250610221602792"></p>
<p>然后又来源于sub_97100。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610221712663.png" alt="image-20250610221712663"></p>
<p>又可以追回到sub_96A14。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250610221857418.png" alt="image-20250610221857418"></p>
<p>大概意思是，W[43-40]与初始密钥相关，涉及S盒、字节交换、rcon。</p>
<p>具体关于逆T表的工作，等到以后吧，算法还原耗时但一定能解开，hhhhh。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>2025&#x2F;0610&#x2F;22:23，脑子有点晕，希望能早点找到工作。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>jidong大佬的公众号。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/29/%E6%89%B9%E9%87%8F%E4%B8%8A%E4%BC%A0typora%E5%9B%BE%E7%89%87%E5%88%B0%E5%9B%BE%E5%BA%8A%E7%9A%84%E8%84%9A%E6%9C%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/29/%E6%89%B9%E9%87%8F%E4%B8%8A%E4%BC%A0typora%E5%9B%BE%E7%89%87%E5%88%B0%E5%9B%BE%E5%BA%8A%E7%9A%84%E8%84%9A%E6%9C%AC/" class="post-title-link" itemprop="url">批量上传typora图片到图床的脚本</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-29 17:31:41 / 修改时间：17:33:13" itemprop="dateCreated datePublished" datetime="2025-05-29T17:31:41+08:00">2025-05-29</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>15k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>27 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>分享一个脚本，改一改配置项就可以用了~</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 配置项 ---</span></span><br><span class="line">MARKDOWN_DIR = <span class="string">&quot;E:\BLOG\source\_posts&quot;</span>  <span class="comment"># &lt;--- 修改这里为你的 Typora 笔记目录!</span></span><br><span class="line">PICGO_API_URL = <span class="string">&quot;http://127.0.0.1:36677/upload&quot;</span>  <span class="comment"># PicGo API 地址</span></span><br><span class="line">BACKUP_ORIGINAL_FILES = <span class="literal">True</span>  <span class="comment"># 是否备份原始 Markdown 文件</span></span><br><span class="line">BACKUP_SUFFIX = <span class="string">&quot;.backup&quot;</span>     <span class="comment"># 备份文件的后缀</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Regular Expressions ---</span></span><br><span class="line"><span class="comment"># Standard Markdown images: ![alt text](local_path)</span></span><br><span class="line"><span class="comment"># Excludes http/https and data: URIs</span></span><br><span class="line">IMAGE_REGEX = re.<span class="built_in">compile</span>(<span class="string">r&quot;!\[(.*?)\]\((?!https?://|data:)(.*?)\)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># To find complete HTML &lt;img&gt; tags</span></span><br><span class="line">HTML_TAG_REGEX = re.<span class="built_in">compile</span>(<span class="string">r&quot;&lt;img[^&gt;]+&gt;&quot;</span>, re.IGNORECASE)</span><br><span class="line"></span><br><span class="line"><span class="comment"># To find &#x27;src&#x27; attribute with a local path within an HTML tag string.</span></span><br><span class="line"><span class="comment"># - \bsrc\b: Ensures &#x27;src&#x27; is a whole word.</span></span><br><span class="line"><span class="comment"># - \s*=\s*: Allows spaces around &#x27;=&#x27;.</span></span><br><span class="line"><span class="comment"># - ([&quot;&#x27;]): Captures the quote character (Group 1).</span></span><br><span class="line"><span class="comment"># - ((?!(?:https?://|data:))[^&quot;&#x27;&gt;]+?): Captures the path if it&#x27;s not an online URL or data URI (Group 2).</span></span><br><span class="line"><span class="comment">#   - [^&quot;&#x27;&gt;]+?: Matches characters that are not quotes or &#x27;&gt;&#x27;, non-greedily.</span></span><br><span class="line"><span class="comment"># - \1: Matches the same quote character that opened the attribute value.</span></span><br><span class="line">SRC_ATTR_REGEX = re.<span class="built_in">compile</span>(</span><br><span class="line">    <span class="string">r&quot;&quot;&quot;\bsrc\s*=\s*([&quot;&#x27;])((?!(?:https?://|data:))[^&quot;&#x27;&gt;]+?)\1&quot;&quot;&quot;</span>,</span><br><span class="line">    re.IGNORECASE</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_image_to_picgo</span>(<span class="params">image_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    使用 PicGo API 上传图片 (发送 JSON 格式的图片路径列表)。</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        image_path (str): 本地图片的绝对路径。</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        str or None: 上传成功返回在线 URL，否则返回 None。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = &#123;<span class="string">&quot;list&quot;</span>: [image_path]&#125;  <span class="comment"># PicGo server expects a JSON list of absolute paths</span></span><br><span class="line">        headers = &#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(f&quot;    Uploading to PicGo: &#123;image_path&#125; with payload: &#123;payload&#125;&quot;) # Verbose logging</span></span><br><span class="line">        response = requests.post(PICGO_API_URL, json=payload, headers=headers, timeout=<span class="number">30</span>) <span class="comment"># Added timeout</span></span><br><span class="line">        response.raise_for_status()  <span class="comment"># Raises HTTPError for bad responses (4xx or 5xx)</span></span><br><span class="line"></span><br><span class="line">        result = response.json()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> result.get(<span class="string">&quot;success&quot;</span>) <span class="keyword">and</span> result.get(<span class="string">&quot;result&quot;</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(result[<span class="string">&quot;result&quot;</span>], <span class="built_in">list</span>) <span class="keyword">and</span> <span class="built_in">len</span>(result[<span class="string">&quot;result&quot;</span>]) &gt; <span class="number">0</span>:</span><br><span class="line">                uploaded_url = result[<span class="string">&quot;result&quot;</span>][<span class="number">0</span>]</span><br><span class="line">                <span class="comment"># print(f&quot;    PicGo Upload OK: &#123;uploaded_url&#125;&quot;) # Verbose logging</span></span><br><span class="line">                <span class="keyword">return</span> uploaded_url</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;    [错误] PicGo 返回的 result 格式不正确: <span class="subst">&#123;result.get(<span class="string">&#x27;result&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            error_message = result.get(<span class="string">&#x27;message&#x27;</span>, <span class="string">&#x27;未知错误&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    [错误] PicGo 上传失败: <span class="subst">&#123;error_message&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    [错误] PicGo 完整响应: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.HTTPError <span class="keyword">as</span> http_err:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    [错误] HTTP 错误发生: <span class="subst">&#123;http_err&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> http_err.response <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    [错误] PicGo 服务器响应状态码: <span class="subst">&#123;http_err.response.status_code&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;    [错误] PicGo 服务器响应内容: <span class="subst">&#123;http_err.response.text&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e: <span class="comment"># Catches ConnectTimeout, ReadTimeout, etc.</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    [错误] 连接 PicGo API 失败或请求过程中出错: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    [错误] 上传图片 &#x27;<span class="subst">&#123;image_path&#125;</span>&#x27; 时发生未知错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">original_full_tag_summary</span>(<span class="params">tag_string, max_len=<span class="number">70</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Helper function to print a summary of a tag if it&#x27;s too long.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(tag_string) &gt; max_len:</span><br><span class="line">        <span class="keyword">return</span> tag_string[:max_len-<span class="number">3</span>] + <span class="string">&quot;...&quot;</span></span><br><span class="line">    <span class="keyword">return</span> tag_string</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_markdown_file</span>(<span class="params">md_file_path_str</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    处理单个 Markdown 文件，上传本地图片 (Markdown 和 HTML 格式) 并替换链接。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;--- 正在处理文件: <span class="subst">&#123;md_file_path_str&#125;</span> ---&quot;</span>)</span><br><span class="line">    md_file_path_obj = Path(md_file_path_str)</span><br><span class="line">    md_dir = md_file_path_obj.parent</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(md_file_path_obj, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            original_content = f.read()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  [错误] 读取文件 &#x27;<span class="subst">&#123;md_file_path_str&#125;</span>&#x27; 失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    content_being_processed = original_content</span><br><span class="line">    modified_in_this_file = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Pass 1: Process standard Markdown images ---</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;  Pass 1: Processing Markdown images `![alt](path)`...&quot;</span>)</span><br><span class="line">    new_md_pass_content_parts = []</span><br><span class="line">    last_md_end = <span class="number">0</span></span><br><span class="line">    markdown_images_found_count = <span class="number">0</span></span><br><span class="line">    markdown_images_replaced_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">match</span> <span class="keyword">in</span> IMAGE_REGEX.finditer(content_being_processed):</span><br><span class="line">        markdown_images_found_count += <span class="number">1</span></span><br><span class="line">        new_md_pass_content_parts.append(content_being_processed[last_md_end:<span class="keyword">match</span>.start()])</span><br><span class="line">        </span><br><span class="line">        alt_text = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">        local_image_path_str = <span class="keyword">match</span>.group(<span class="number">2</span>)</span><br><span class="line">        original_md_tag = <span class="keyword">match</span>.group(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    MD_IMG: Found: <span class="subst">&#123;original_full_tag_summary(original_md_tag)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        local_image_path = Path(local_image_path_str)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> local_image_path.is_absolute():</span><br><span class="line">            absolute_image_path = (md_dir / local_image_path).resolve()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            absolute_image_path = local_image_path.resolve()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> absolute_image_path.exists():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    [警告] MD_IMG: File not found, skipping: <span class="subst">&#123;absolute_image_path&#125;</span>&quot;</span>)</span><br><span class="line">            new_md_pass_content_parts.append(original_md_tag)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            online_url = upload_image_to_picgo(<span class="built_in">str</span>(absolute_image_path))</span><br><span class="line">            <span class="keyword">if</span> online_url:</span><br><span class="line">                new_image_md_tag = <span class="string">f&quot;![<span class="subst">&#123;alt_text&#125;</span>](<span class="subst">&#123;online_url&#125;</span>)&quot;</span></span><br><span class="line">                new_md_pass_content_parts.append(new_image_md_tag)</span><br><span class="line">                modified_in_this_file = <span class="literal">True</span></span><br><span class="line">                markdown_images_replaced_count += <span class="number">1</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;    MD_IMG: Replaced with: <span class="subst">&#123;new_image_md_tag&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;    MD_IMG: Upload failed for &#x27;<span class="subst">&#123;local_image_path_str&#125;</span>&#x27;, skipping replacement.&quot;</span>)</span><br><span class="line">                new_md_pass_content_parts.append(original_md_tag)</span><br><span class="line">        last_md_end = <span class="keyword">match</span>.end()</span><br><span class="line">    </span><br><span class="line">    new_md_pass_content_parts.append(content_being_processed[last_md_end:])</span><br><span class="line">    content_after_md_pass = <span class="string">&quot;&quot;</span>.join(new_md_pass_content_parts)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> markdown_images_found_count &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  Pass 1 Summary: Found <span class="subst">&#123;markdown_images_found_count&#125;</span> MD images, Replaced <span class="subst">&#123;markdown_images_replaced_count&#125;</span>.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  Pass 1 Summary: No Markdown images `![alt](path)` found.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Pass 2: Process HTML &lt;img&gt; tags ---</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;  Pass 2: Processing HTML images `&lt;img src=&#x27;path&#x27;&gt;`...&quot;</span>)</span><br><span class="line">    content_for_html_pass = content_after_md_pass</span><br><span class="line">    new_html_pass_content_parts = []</span><br><span class="line">    last_html_end = <span class="number">0</span></span><br><span class="line">    html_tags_processed_count = <span class="number">0</span> <span class="comment"># Counts &lt;img&gt; tags where local src was sought</span></span><br><span class="line">    html_src_replaced_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> tag_match <span class="keyword">in</span> HTML_TAG_REGEX.finditer(content_for_html_pass):</span><br><span class="line">        new_html_pass_content_parts.append(content_for_html_pass[last_html_end:tag_match.start()])</span><br><span class="line">        </span><br><span class="line">        original_full_tag = tag_match.group(<span class="number">0</span>)</span><br><span class="line">        modified_tag_output = original_full_tag <span class="comment"># Assume not modified unless src is replaced</span></span><br><span class="line"></span><br><span class="line">        src_attr_match = SRC_ATTR_REGEX.search(original_full_tag)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> src_attr_match:</span><br><span class="line">            html_tags_processed_count +=<span class="number">1</span></span><br><span class="line">            quote_char = src_attr_match.group(<span class="number">1</span>)</span><br><span class="line">            local_image_path_str = src_attr_match.group(<span class="number">2</span>)</span><br><span class="line">            original_src_attr_part = src_attr_match.group(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    HTML_IMG: Found local src=&#x27;<span class="subst">&#123;local_image_path_str&#125;</span>&#x27; in tag: <span class="subst">&#123;original_full_tag_summary(original_full_tag)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            local_image_path = Path(local_image_path_str)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> local_image_path.is_absolute():</span><br><span class="line">                absolute_image_path = (md_dir / local_image_path).resolve()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                absolute_image_path = local_image_path.resolve()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> absolute_image_path.exists():</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;    [警告] HTML_IMG: File not found, skipping: <span class="subst">&#123;absolute_image_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                online_url = upload_image_to_picgo(<span class="built_in">str</span>(absolute_image_path))</span><br><span class="line">                <span class="keyword">if</span> online_url:</span><br><span class="line">                    new_src_attr_part = <span class="string">f&#x27;src=<span class="subst">&#123;quote_char&#125;</span><span class="subst">&#123;online_url&#125;</span><span class="subst">&#123;quote_char&#125;</span>&#x27;</span></span><br><span class="line">                    modified_tag_output = original_full_tag.replace(original_src_attr_part, new_src_attr_part, <span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">if</span> original_full_tag != modified_tag_output:</span><br><span class="line">                        modified_in_this_file = <span class="literal">True</span></span><br><span class="line">                        html_src_replaced_count +=<span class="number">1</span></span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;    HTML_IMG: Replaced src. New tag: <span class="subst">&#123;original_full_tag_summary(modified_tag_output)&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;    HTML_IMG: Upload failed for &#x27;<span class="subst">&#123;local_image_path_str&#125;</span>&#x27;, skipping replacement in tag.&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        new_html_pass_content_parts.append(modified_tag_output)</span><br><span class="line">        last_html_end = tag_match.end()</span><br><span class="line"></span><br><span class="line">    new_html_pass_content_parts.append(content_for_html_pass[last_html_end:])</span><br><span class="line">    final_content = <span class="string">&quot;&quot;</span>.join(new_html_pass_content_parts)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> html_tags_processed_count &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  Pass 2 Summary: Processed <span class="subst">&#123;html_tags_processed_count&#125;</span> &lt;img&gt; tags for local &#x27;src&#x27;, Replaced <span class="subst">&#123;html_src_replaced_count&#125;</span> &#x27;src&#x27; attributes.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  Pass 2 Summary: No HTML &lt;img&gt; tags with processable local &#x27;src&#x27; attributes found.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Save file if modified_in_this_file ---</span></span><br><span class="line">    <span class="keyword">if</span> modified_in_this_file:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> BACKUP_ORIGINAL_FILES:</span><br><span class="line">                backup_file_path = md_file_path_obj.with_suffix(md_file_path_obj.suffix + BACKUP_SUFFIX)</span><br><span class="line">                <span class="comment"># Backup the file as it is on disk (original version for this run)</span></span><br><span class="line">                shutil.copy2(md_file_path_obj, backup_file_path)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;  已备份原始文件到: <span class="subst">&#123;backup_file_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(md_file_path_obj, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(final_content)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  文件已更新: <span class="subst">&#123;md_file_path_str&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  [错误] 写入文件或备份文件失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> BACKUP_ORIGINAL_FILES <span class="keyword">and</span> <span class="string">&#x27;backup_file_path&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">and</span> Path(backup_file_path).exists():</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="comment"># Attempt to restore from backup if write failed</span></span><br><span class="line">                    shutil.copy2(backup_file_path, md_file_path_obj)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;  [警告] 写入失败，已尝试从备份 <span class="subst">&#123;backup_file_path&#125;</span> 恢复。请检查文件。&quot;</span>)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> restore_e:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;  [严重错误] 写入失败且恢复备份也失败: <span class="subst">&#123;restore_e&#125;</span>。原始文件可能已损坏，请从手动备份中恢复。&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  文件 &#x27;<span class="subst">&#123;md_file_path_str&#125;</span>&#x27; 无需修改。&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    主函数，遍历目录并处理 Markdown 文件。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    markdown_dir_path = Path(MARKDOWN_DIR)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> markdown_dir_path.is_dir():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[错误] 指定的目录不存在或不是一个目录: <span class="subst">&#123;MARKDOWN_DIR&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;开始扫描目录: <span class="subst">&#123;markdown_dir_path&#125;</span>&quot;</span>)</span><br><span class="line">    file_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> md_file <span class="keyword">in</span> markdown_dir_path.rglob(<span class="string">&quot;*.md&quot;</span>): <span class="comment"># rglob 会递归查找所有子目录中的 .md 文件</span></span><br><span class="line">        <span class="keyword">if</span> BACKUP_SUFFIX <span class="keyword">in</span> md_file.name: <span class="comment"># Skip backup files</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;跳过备份文件: <span class="subst">&#123;md_file&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        process_markdown_file(<span class="built_in">str</span>(md_file))</span><br><span class="line">        file_count += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> file_count == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;在指定目录中未找到 .md 文件。&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;所有 <span class="subst">&#123;file_count&#125;</span> 个 Markdown 文件处理完毕。&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;*********************************************************************&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;* Typora 图片上传脚本 (Markdown &amp; HTML)                              *&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;*********************************************************************&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;* 重要提示:                                                          *&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;* 1. 请确保 PicGo 正在运行并已正确配置图床和Server。                *&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;* 2. 脚本将修改 Markdown 文件中的本地图片链接。                     *&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;* 3. 配置的笔记目录: <span class="subst">&#123;MARKDOWN_DIR&#125;</span>                         *&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;* 4. PicGo API: <span class="subst">&#123;PICGO_API_URL&#125;</span>                                 *&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> BACKUP_ORIGINAL_FILES:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;* 5. 原始文件将备份为 *.md<span class="subst">&#123;BACKUP_SUFFIX&#125;</span>。                         *&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;* 5. 文件备份已禁用。                                               *&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;* 6. 强烈建议在首次运行或对重要笔记操作前备份您的整个笔记目录。     *&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;*********************************************************************\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> MARKDOWN_DIR == <span class="string">&quot;/path/to/your/typora/notes&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[配置错误] 请务必修改脚本中的 `MARKDOWN_DIR`变量，指向你的 Typora 笔记目录！&quot;</span>)</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    confirm = <span class="built_in">input</span>(<span class="string">f&quot;确认开始处理目录 &#x27;<span class="subst">&#123;MARKDOWN_DIR&#125;</span>&#x27; 下的 Markdown 文件吗? (yes/no): &quot;</span>).lower()</span><br><span class="line">    <span class="keyword">if</span> confirm == <span class="string">&#x27;yes&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;脚本将在 3 秒后开始执行... 按 Ctrl+C 取消。&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            time.sleep(<span class="number">3</span>)</span><br><span class="line">            main()</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n操作已由用户取消。&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n[严重错误] 脚本执行过程中发生意外错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;操作已取消。&quot;</span>)</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/29/angr%E4%B8%8E%E5%8E%BB%E6%B7%B7%E6%B7%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/29/angr%E4%B8%8E%E5%8E%BB%E6%B7%B7%E6%B7%86/" class="post-title-link" itemprop="url">初学angr与去混淆</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-29 17:27:46 / 修改时间：17:30:52" itemprop="dateCreated datePublished" datetime="2025-05-29T17:27:46+08:00">2025-05-29</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>32k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>58 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="学习angr"><a href="#学习angr" class="headerlink" title="学习angr"></a>学习angr</h1><p>我打算根据<a target="_blank" rel="noopener" href="https://github.com/jakespringer/angr_ctf%E9%87%8C%E7%9A%84%E8%A7%A3%E9%A2%98%E4%BB%A3%E7%A0%81%E8%BF%9B%E8%A1%8C%E5%AD%A6%E4%B9%A0%E3%80%82">https://github.com/jakespringer/angr_ctf里的解题代码进行学习。</a></p>
<h2 id="00-angr-find"><a href="#00-angr-find" class="headerlink" title="00_angr_find"></a>00_angr_find</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  <span class="comment"># Create an Angr project.</span></span><br><span class="line">  <span class="comment"># If you want to be able to point to the binary from the command line, you can</span></span><br><span class="line">  <span class="comment"># use argv[1] as the parameter. Then, you can run the script from the command</span></span><br><span class="line">  <span class="comment"># line as follows:</span></span><br><span class="line">  <span class="comment"># python ./scaffold00.py [binary]</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  path_to_binary = ???  <span class="comment"># :string</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Tell Angr where to start executing (should it start from the main()</span></span><br><span class="line">  <span class="comment"># function or somewhere else?) For now, use the entry_state function</span></span><br><span class="line">  <span class="comment"># to instruct Angr to start from the main() function.</span></span><br><span class="line">  initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Create a simulation manager initialized with the starting state. It provides</span></span><br><span class="line">  <span class="comment"># a number of useful tools to search and execute the binary.</span></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Explore the binary to attempt to find the address that prints &quot;Good Job.&quot;</span></span><br><span class="line">  <span class="comment"># You will have to find the address you want to find and insert it here. </span></span><br><span class="line">  <span class="comment"># This function will keep executing until it either finds a solution or it </span></span><br><span class="line">  <span class="comment"># has explored every possible path through the executable.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  print_good_address = ???  <span class="comment"># :integer (probably in hexadecimal)</span></span><br><span class="line">  simulation.explore(find=print_good_address)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Check that we have found a solution. The simulation.explore() method will</span></span><br><span class="line">  <span class="comment"># set simulation.found to a list of the states that it could find that reach</span></span><br><span class="line">  <span class="comment"># the instruction we asked it to search for. Remember, in Python, if a list</span></span><br><span class="line">  <span class="comment"># is empty, it will be evaluated as false, otherwise true.</span></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    <span class="comment"># The explore method stops after it finds a single state that arrives at the</span></span><br><span class="line">    <span class="comment"># target address.</span></span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Print the string that Angr wrote to stdin to follow solution_state. This </span></span><br><span class="line">    <span class="comment"># is our solution.</span></span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()))</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># If Angr could not find a path that reaches print_good_address, throw an</span></span><br><span class="line">    <span class="comment"># error. Perhaps you mistyped the print_good_address?</span></span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h3><p>创建Angr项目，angr会对二进制文件解析。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">project = angr.Project(path_to_binary)</span><br></pre></td></tr></table></figure>

<p>创建一个初始状态，通常从程序的入口点开始，即文件的入口函数main。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initial_state = project.factory.entry_state()</span><br></pre></td></tr></table></figure>

<p>创建一个模拟管理器，通过这个模拟器可以使用很多工具，对二进制文件进行搜索和执行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simulation = project.factory.simgr(initial_state)</span><br></pre></td></tr></table></figure>

<p>自动探索路径，直到找到一个到达find参数指定的地址的状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simulation.explore(find=print_good_address)</span><br></pre></td></tr></table></figure>

<p>这是一个列表，如果搜索成功，这个列表会包含所有可到达目标地址的状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simulation.found</span><br></pre></td></tr></table></figure>

<p>从成功状态中，提取标准输入的内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">solution_state = simulation.found[0]</span><br><span class="line">solution_state.posix.dumps(sys.stdin.fileno()).decode()</span><br></pre></td></tr></table></figure>

<h2 id="01-angr-avoid"><a href="#01-angr-avoid" class="headerlink" title="01_angr_avoid"></a>01_angr_avoid</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  print_good_address = <span class="number">0x80485f7</span> <span class="comment"># 目标成功地址（示例）</span></span><br><span class="line">  will_not_succeed_address = <span class="number">0x80485bf</span> <span class="comment"># 需要避开的地址（示例）</span></span><br><span class="line">  <span class="comment"># 探索时，寻找print_good_address，并避开will_not_succeed_address</span></span><br><span class="line">  simulation.explore(find=print_good_address, avoid=will_not_succeed_address)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="解析-1"><a href="#解析-1" class="headerlink" title="解析"></a>解析</h3><p>这次程序中不仅有成功路径，还有一些我们不希望进入的“陷阱”路径（例如，一个会打印失败信息然后退出的路径）。我们需要找到成功路径，同时避开这些陷阱。</p>
<p>在探索路径的时候，avoid参数可以避免某些状态的产生。比方说，不进入基本块A，则不会在基本块A处产生新状态，基本块A之后的基本块也不会继续通过基本块A产生新状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simulation.explore(find=find_address, avoid=avoid_address)</span><br></pre></td></tr></table></figure>

<h2 id="02-angr-find-condition"><a href="#02-angr-find-condition" class="headerlink" title="02_angr_find_condition"></a>02_angr_find_condition</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 定义成功条件函数</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno()) <span class="comment"># 获取标准输出</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output <span class="comment"># 检查是否包含 &quot;Good Job.&quot; (注意是字节串)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 定义应中止路径的条件函数</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output <span class="comment"># 检查是否包含 &quot;Try again.&quot;</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="解析-2"><a href="#解析-2" class="headerlink" title="解析"></a>解析</h3><p>有时候，可能不知道确切“成功”的指令地址，而是某种行为。比如说，某个基本块会标准输出“Good Job.”。</p>
<p>explore方法的find和avoid参数不仅可以接受地址，还可以接受一个函数。这个函数会以一个state对象为参数，返回True代表找到了或者应该避开，而返回False代表没找到成功状态或者不应该避开。</p>
<p>Angr会在每一步执行后，用这些函数评判当前状态，如果状态是True，就代表成功了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义成功条件函数</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno()) <span class="comment"># 获取标准输出</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output <span class="comment"># 检查是否包含 &quot;Good Job.&quot; (注意是字节串)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 定义应中止路径的条件函数</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output <span class="comment"># 检查是否包含 &quot;Try again.&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="03-angr-symbolic-registers"><a href="#03-angr-symbolic-registers" class="headerlink" title="03_angr_symbolic_registers"></a>03_angr_symbolic_registers</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> claripy <span class="comment"># 导入claripy用于创建符号变量</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 设定一个开始地址，通常是scanf调用之后，这样我们可以手动控制输入</span></span><br><span class="line">  start_address = <span class="number">0x80488c7</span> <span class="comment"># 示例地址，你需要反汇编找到它</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address, <span class="comment"># 从指定地址开始</span></span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 创建符号变量来代表密码的各个部分</span></span><br><span class="line">  <span class="comment"># 假设程序从scanf读取3个32位整数，然后这些值被放到了eax, ebx, edx</span></span><br><span class="line">  password0_size_in_bits = <span class="number">32</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, password0_size_in_bits) <span class="comment"># &#x27;password0&#x27;是名字，32是位数</span></span><br><span class="line"></span><br><span class="line">  password1_size_in_bits = <span class="number">32</span></span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, password1_size_in_bits)</span><br><span class="line"></span><br><span class="line">  password2_size_in_bits = <span class="number">32</span></span><br><span class="line">  password2 = claripy.BVS(<span class="string">&#x27;password2&#x27;</span>, password2_size_in_bits)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 将符号变量注入到相应的寄存器</span></span><br><span class="line">  initial_state.regs.eax = password0</span><br><span class="line">  initial_state.regs.ebx = password1</span><br><span class="line">  initial_state.regs.edx = password2 <span class="comment"># 实际使用哪个寄存器取决于反汇编结果</span></span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 从成功状态中求解出各个符号变量的具体值</span></span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(password0)</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(password1)</span><br><span class="line">    solution2 = solution_state.solver.<span class="built_in">eval</span>(password2)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将解格式化为程序期望的输入格式（这里假设是十六进制，空格分隔）</span></span><br><span class="line">    solution_string = <span class="string">&#x27; &#x27;</span>.join(<span class="built_in">map</span>(<span class="string">&#x27;&#123;:x&#125;&#x27;</span>.<span class="built_in">format</span>, [ solution0, solution1, solution2 ]))</span><br><span class="line">    <span class="built_in">print</span>(solution_string)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="解析-3"><a href="#解析-3" class="headerlink" title="解析"></a>解析</h3><p>虽然现在的Angr支持函数scanf了，但之前是不支持的，这道题目是想教会读者，可以在任意地址设置状态，并符号执行。</p>
<p>在任意地址创建状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">project.factory.blank_state(addr=start_address)</span><br></pre></td></tr></table></figure>

<p>创建符号向量，例如，一个代表32位数值的符号。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">claripy.BVS(&#x27;name&#x27;, bit_length)</span><br></pre></td></tr></table></figure>

<p>将符号值赋给寄存器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">state.regs.REG_NAME = symbolic_value</span><br><span class="line"># 例如: initial_state.regs.eax = password0</span><br></pre></td></tr></table></figure>

<p>获取符号变量的一个具体满足约束的值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">state.solver.eval(symbolic_value)</span><br></pre></td></tr></table></figure>

<h2 id="04-angr-symbolic-stack"><a href="#04-angr-symbolic-stack" class="headerlink" title="04_angr_symbolic_stack"></a>04_angr_symbolic_stack</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 挑战描述 scanf(&quot;%u %u&quot;)</span></span><br><span class="line">  <span class="comment"># 通常 scanf 的参数是：格式字符串地址、变量1地址、变量2地址...</span></span><br><span class="line">  <span class="comment"># 这些地址本身可能在栈上（如果是局部变量的地址）</span></span><br><span class="line">  start_address = <span class="number">0x80486ae</span> <span class="comment"># 跳过scanf的地址 (示例)</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 模拟函数栈帧的建立</span></span><br><span class="line">  <span class="comment"># mov %esp, %ebp (通常在函数开始)</span></span><br><span class="line">  <span class="comment"># sub $0x18, %esp (为局部变量分配空间)</span></span><br><span class="line">  <span class="comment"># 我们跳过了这些，所以需要手动设置</span></span><br><span class="line">  initial_state.regs.ebp = initial_state.regs.esp <span class="comment"># 假设 ebp 指向当前 esp</span></span><br><span class="line"></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, <span class="number">32</span>) <span class="comment"># 第一个32位符号整数</span></span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, <span class="number">32</span>) <span class="comment"># 第二个32位符号整数</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 根据反汇编，scanf的参数是 ebp-0xc 和 ebp-0x10</span></span><br><span class="line">  <span class="comment"># scanf(format_string, ebp - 0xc, ebp - 0x10)</span></span><br><span class="line">  <span class="comment"># 假设 ebp 和 esp 初始化后相等，我们需要在栈上为这两个变量腾出空间。</span></span><br><span class="line">  <span class="comment"># 并且，由于我们跳过了scanf之前的参数压栈，栈的布局需要我们模拟。</span></span><br><span class="line">  <span class="comment"># solve04.py 中:</span></span><br><span class="line">  <span class="comment"># ebp -&gt;     |          padding          | (ebp 指向这里，也是初始 esp 指向这里)</span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  <span class="comment"># ebp - 0x0c |   password0 (符号值)    | &lt;- scanf 会写入这里 (即 initial_state.regs.ebp - 0xc)</span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  <span class="comment"># ebp - 0x10 |   password1 (符号值)    | &lt;- scanf 会写入这里 (即 initial_state.regs.ebp - 0x10)</span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  <span class="comment"># esp -&gt;     |                           | (esp 在分配完所有局部变量后指向这里)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 为了让 scanf 操作的地址 (ebp-0xc, ebp-0x10) 包含我们的符号值，</span></span><br><span class="line">  <span class="comment"># 我们需要在这些“模拟的”内存位置存储符号值。</span></span><br><span class="line">  <span class="comment"># solve04.py 通过 stack_push 来实现，这暗示它认为这些 scanf 的目标缓冲区</span></span><br><span class="line">  <span class="comment"># 就是在栈上连续分配的。</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 首先，为栈上的局部变量和 scanf 的参数指针（如果它们是通过压栈传递的话）分配空间。</span></span><br><span class="line">  <span class="comment"># `solve04.py` 中 padding_length_in_bytes = 8，然后 esp -= padding_length_in_bytes</span></span><br><span class="line">  <span class="comment"># 之后 stack_push(password0) 和 stack_push(password1)</span></span><br><span class="line">  <span class="comment"># 这意味着它期望 password0 和 password1 直接作为值被程序使用，</span></span><br><span class="line">  <span class="comment"># 并且它们位于 esp 指向的栈顶附近。</span></span><br><span class="line">  <span class="comment"># 这需要非常小心地根据实际反汇编代码来确定栈布局。</span></span><br><span class="line">  <span class="comment"># scanf(&quot;%u %u&quot;, &amp;var1, &amp;var2) -&gt; var1 和 var2 是栈上的局部变量</span></span><br><span class="line">  <span class="comment"># 假设 var1 在 ebp-0xc, var2 在 ebp-0x10</span></span><br><span class="line">  <span class="comment"># 我们需要确保在 initial_state 中，内存地址 (ebp-0xc) 处的值是 password0，(ebp-0x10) 处是 password1。</span></span><br><span class="line">  <span class="comment"># 更直接的方法可能是:</span></span><br><span class="line">  <span class="comment"># initial_state.memory.store(initial_state.regs.ebp - 0xc, password0, endness=project.arch.memory_endness)</span></span><br><span class="line">  <span class="comment"># initial_state.memory.store(initial_state.regs.ebp - 0x10, password1, endness=project.arch.memory_endness)</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># 但 solve04.py 的做法是：</span></span><br><span class="line">  padding_length_in_bytes = <span class="number">8</span> <span class="comment"># 这个值需要根据具体情况调整</span></span><br><span class="line">  initial_state.regs.esp -= padding_length_in_bytes</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 将符号变量压入栈。注意顺序！x86参数通常自右向左压栈。</span></span><br><span class="line">  <span class="comment"># 但这里我们是模拟 scanf 已经执行完后，数据已在栈上变量中的情况。</span></span><br><span class="line">  <span class="comment"># 所以这里的顺序是 password0 在较高的地址 (ebp-0xc)，password1 在较低地址 (ebp-0x10)。</span></span><br><span class="line">  <span class="comment"># stack_push 会将值放到当前esp，然后esp相应调整。</span></span><br><span class="line">  <span class="comment"># 为了匹配 ebp-0xc 和 ebp-0x10，可能需要先push password1，再push password0，</span></span><br><span class="line">  <span class="comment"># 或者调整 padding 和 esp 的初始值。</span></span><br><span class="line">  <span class="comment"># solve04.py 的顺序是：</span></span><br><span class="line">  initial_state.stack_push(password0)</span><br><span class="line">  initial_state.stack_push(password1)</span><br><span class="line">  <span class="comment"># 这意味着 password1 在栈顶 (低地址)，password0 在其后 (高地址)。</span></span><br><span class="line">  <span class="comment"># 这需要与程序如何从栈上读取这些值相对应。</span></span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(password0)</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(password1)</span><br><span class="line">    <span class="comment"># 格式化输出</span></span><br><span class="line">    solution_string = <span class="string">&#x27; &#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, [solution0, solution1])) <span class="comment"># 假设是十进制整数，空格分隔</span></span><br><span class="line">    <span class="built_in">print</span>(solution_string)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="解析-4"><a href="#解析-4" class="headerlink" title="解析"></a>解析</h3><p>类似于Level3，但这次scanf读取的值可能直接存储于栈上的局部变量，而非像Level3一样，将值直接传递给3个寄存器。</p>
<p>获得初始状态，angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY和SYMBOL_FILL_UNCONSTRAINED_REGISTERS用于设置未初始化的内存、寄存器为符号。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">initial_state = project.factory.blank_state(</span><br><span class="line">  addr=start_address,</span><br><span class="line">  add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                  angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>模拟栈帧的建立，令ebp指向当前esp。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initial_state.regs.ebp = initial_state.regs.esp</span><br></pre></td></tr></table></figure>

<p>创建2个32位的符号整数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">password0 = claripy.BVS(&#x27;password0&#x27;, 32) # 第一个32位符号整数</span><br><span class="line">password1 = claripy.BVS(&#x27;password1&#x27;, 32) # 第二个32位符号整数</span><br></pre></td></tr></table></figure>

<p>根据反汇编，scanf的参数是 ebp-0xc 和 ebp-0x10，相当于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scanf(format_string, ebp - 0xc, ebp - 0x10)</span><br></pre></td></tr></table></figure>

<p>esp开辟8个字节的栈帧。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">padding_length_in_bytes = 8 # 这个值需要根据具体情况调整</span><br><span class="line">initial_state.regs.esp -= padding_length_in_bytes</span><br></pre></td></tr></table></figure>

<p>压栈。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">initial_state.stack_push(password0)</span><br><span class="line">initial_state.stack_push(password1)</span><br></pre></td></tr></table></figure>

<p>创建模拟器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simulation = project.factory.simgr(initial_state)</span><br></pre></td></tr></table></figure>

<p>解析成功状态时，符号的值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">solution0 = solution_state.solver.eval(password0)</span><br><span class="line">solution1 = solution_state.solver.eval(password1)</span><br></pre></td></tr></table></figure>

<p>为什么这里需要设置ebp &#x3D; esp，并且esp -&#x3D; 8？</p>
<p>观察反汇编代码，发现之后调用参数的时候，都是基于ebp来调用的，因此这里ebp先设置为esp，然后让esp -&#x3D; 8，之后压栈操作又会令esp - 4，这个时候，ebp + var_10和ebp + var_C可以正确访问到栈上的符号变量了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250529095922371.png" alt="image-20250529095922371" style="zoom:80%;" />

<h2 id="05-angr-symbolic-memory"><a href="#05-angr-symbolic-memory" class="headerlink" title="05_angr_symbolic_memory"></a>05_angr_symbolic_memory</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 挑战描述 scanf(&quot;%8s %8s %8s %8s&quot;)</span></span><br><span class="line">  <span class="comment"># 假设这些字符串被存储在已知的全局地址</span></span><br><span class="line">  start_address = <span class="number">0x8048618</span> <span class="comment"># scanf之后开始 (示例)</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 创建符号字符串，每个8字节 (8*8=64位)</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, <span class="number">8</span>*<span class="number">8</span>)</span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, <span class="number">8</span>*<span class="number">8</span>)</span><br><span class="line">  password2 = claripy.BVS(<span class="string">&#x27;password2&#x27;</span>, <span class="number">8</span>*<span class="number">8</span>)</span><br><span class="line">  password3 = claripy.BVS(<span class="string">&#x27;password3&#x27;</span>, <span class="number">8</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 将符号字符串存储到它们在内存中的地址</span></span><br><span class="line">  <span class="comment"># 这些地址需要通过反汇编确定</span></span><br><span class="line">  password0_address = <span class="number">0xab232c0</span> <span class="comment"># 示例地址</span></span><br><span class="line">  initial_state.memory.store(password0_address, password0) <span class="comment"># 默认字节序，对于字符串通常OK</span></span><br><span class="line">  password1_address = <span class="number">0xab232c8</span> <span class="comment"># 示例地址</span></span><br><span class="line">  initial_state.memory.store(password1_address, password1)</span><br><span class="line">  password2_address = <span class="number">0xab232d0</span> <span class="comment"># 示例地址</span></span><br><span class="line">  initial_state.memory.store(password2_address, password2)</span><br><span class="line">  password3_address = <span class="number">0xab232d8</span> <span class="comment"># 示例地址</span></span><br><span class="line">  initial_state.memory.store(password3_address, password3)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 求解符号字符串</span></span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(password0, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(password1, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution2 = solution_state.solver.<span class="built_in">eval</span>(password2, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution3 = solution_state.solver.<span class="built_in">eval</span>(password3, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 组合成最终输入字符串，假设空格分隔</span></span><br><span class="line">    solution_string = <span class="string">&#x27; &#x27;</span>.join([solution0, solution1, solution2, solution3])</span><br><span class="line">    <span class="built_in">print</span>(solution_string)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="解析-5"><a href="#解析-5" class="headerlink" title="解析"></a>解析</h3><p>scanf可以获得输入，这个输入在Level3中写入了寄存器，在Level4中写入了栈，在本次案例中，写入了全局变量。</p>
<p>创建起始状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">initial_state = project.factory.blank_state(</span><br><span class="line">  addr=start_address,</span><br><span class="line">  add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                  angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>创建符号变量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 创建符号字符串，每个8字节 (8*8=64位)</span><br><span class="line">password0 = claripy.BVS(&#x27;password0&#x27;, 8*8)</span><br><span class="line">password1 = claripy.BVS(&#x27;password1&#x27;, 8*8)</span><br><span class="line">password2 = claripy.BVS(&#x27;password2&#x27;, 8*8)</span><br><span class="line">password3 = claripy.BVS(&#x27;password3&#x27;, 8*8)</span><br></pre></td></tr></table></figure>

<p>使用initial_state.memory.store，将符号值存储到已知的全局变量地址。（偏移地址）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 将符号字符串存储到它们在内存中的地址</span><br><span class="line">  # 这些地址需要通过反汇编确定</span><br><span class="line">  password0_address = 0xab232c0 # 示例地址</span><br><span class="line">  initial_state.memory.store(password0_address, password0) # 默认字节序，对于字符串通常OK</span><br><span class="line">  password1_address = 0xab232c8 # 示例地址</span><br><span class="line">  initial_state.memory.store(password1_address, password1)</span><br><span class="line">  password2_address = 0xab232d0 # 示例地址</span><br><span class="line">  initial_state.memory.store(password2_address, password2)</span><br><span class="line">  password3_address = 0xab232d8 # 示例地址</span><br><span class="line">  initial_state.memory.store(password3_address, password3)</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250529101424288.png" alt="image-20250529101424288" style="zoom:80%;" />

<p>解析符号的值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">solution_state.solver.eval(symbolic_value, cast_to=bytes).decode()</span><br></pre></td></tr></table></figure>

<h2 id="06-angr-symbolic-dynamic-memory"><a href="#06-angr-symbolic-dynamic-memory" class="headerlink" title="06_angr_symbolic_dynamic_memory"></a>06_angr_symbolic_dynamic_memory</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 挑战描述 scanf(&quot;%8s %8s&quot;)，输入存储在动态分配的内存中</span></span><br><span class="line">  start_address = <span class="number">0x80486af</span> <span class="comment"># scanf 之后 (示例)</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, <span class="number">8</span>*<span class="number">8</span>) <span class="comment"># 8字节字符串</span></span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, <span class="number">8</span>*<span class="number">8</span>) <span class="comment"># 注意solve06.py这里写的是password0，应为password1</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 伪造的堆地址，我们可以控制这块内存</span></span><br><span class="line">  fake_heap_address0 = <span class="number">0x4444444</span> </span><br><span class="line">  <span class="comment"># 存储了 malloc返回地址 的那个指针变量的地址 (需反汇编确定)</span></span><br><span class="line">  pointer_to_malloc_memory_address0 = <span class="number">0xa2def74</span> <span class="comment"># 示例</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 修改程序中的指针，使其指向我们的伪造堆地址</span></span><br><span class="line">  <span class="comment"># 对于32位程序，地址是4字节</span></span><br><span class="line">  initial_state.memory.store(pointer_to_malloc_memory_address0, fake_heap_address0, endness=project.arch.memory_endness, size=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">  fake_heap_address1 = <span class="number">0x4444454</span> <span class="comment"># 为第二个密码准备的伪造地址</span></span><br><span class="line">  pointer_to_malloc_memory_address1 = <span class="number">0xa2def7c</span> <span class="comment"># 示例</span></span><br><span class="line">  initial_state.memory.store(pointer_to_malloc_memory_address1, fake_heap_address1, endness=project.arch.memory_endness, size=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 在伪造的堆地址上存储我们的符号密码</span></span><br><span class="line">  initial_state.memory.store(fake_heap_address0, password0)</span><br><span class="line">  initial_state.memory.store(fake_heap_address1, password1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(password0, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(password1, cast_to=<span class="built_in">bytes</span>).decode() <span class="comment"># 原为password0</span></span><br><span class="line">    </span><br><span class="line">    solution_string = <span class="string">&#x27; &#x27;</span>.join([solution0, solution1])</span><br><span class="line">    <span class="built_in">print</span>(solution_string)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="解析-6"><a href="#解析-6" class="headerlink" title="解析"></a>解析</h3><p>本次案例中，输入的值保存到了堆上。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250529101723507.png" alt="image-20250529101723507" style="zoom: 67%;" />

<p>在scanf之后的地址创建初始状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">start_address = 0x80486af # scanf 之后 (示例)</span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>程序中会有一个指针变量（全局变量或是局部变量）用于存储malloc返回的地址，如上图的buffer0、buffer1。</p>
<p>选择一个angr知道的、未被使用的“伪造堆地址”，使用下面这个语句修改存储malloc结果的指针，让它指向伪造的堆地址，这里的endness指字节序。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> # 伪造的堆地址，我们可以控制这块内存</span><br><span class="line">  fake_heap_address0 = 0x4444444 </span><br><span class="line">  # 存储了 malloc返回地址 的那个指针变量的地址 (需反汇编确定)</span><br><span class="line">  pointer_to_malloc_memory_address0 = 0xa2def74 # 示例</span><br><span class="line"></span><br><span class="line">initial_state.memory.store(pointer_to_malloc_memory_address1, fake_heap_address1, endness=project.arch.memory_endness, size=4)</span><br></pre></td></tr></table></figure>

<p>在对地址上存储符号向量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">password0 = claripy.BVS(&#x27;password0&#x27;, 8*8)</span><br><span class="line">password1 = claripy.BVS(&#x27;password1&#x27;, 8*8)</span><br><span class="line"># 在伪造的堆地址上存储我们的符号密码</span><br><span class="line">initial_state.memory.store(fake_heap_address0, password0)</span><br><span class="line">initial_state.memory.store(fake_heap_address1, password1)</span><br></pre></td></tr></table></figure>

<p>探索路径。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def is_successful(state):</span><br><span class="line">  stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">  return b&#x27;Good Job.&#x27; in stdout_output</span><br><span class="line"></span><br><span class="line">def should_abort(state):</span><br><span class="line">  stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">  return b&#x27;Try again.&#x27; in stdout_output</span><br><span class="line"></span><br><span class="line">simulation.explore(find=is_successful, avoid=should_abort)</span><br></pre></td></tr></table></figure>

<p>解析符号。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">solution0 = solution_state.solver.eval(password0, cast_to=bytes).decode()</span><br><span class="line">   solution1 = solution_state.solver.eval(password1, cast_to=bytes).decode() </span><br></pre></td></tr></table></figure>

<h2 id="07-angr-syombolic-file"><a href="#07-angr-syombolic-file" class="headerlink" title="07_angr_syombolic_file"></a>07_angr_syombolic_file</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># fread(buffer, sizeof(char), 64, file) - 题目提示，但实际解法用了8字节</span></span><br><span class="line">  <span class="comment"># 可能程序逻辑只需要前8字节，或者solve07.py中的大小是正确的。</span></span><br><span class="line">  start_address = <span class="number">0x80488bc</span> <span class="comment"># 通常是fread调用之前或包含fread的函数入口 (示例)</span></span><br><span class="line">  initial_state = project.factory.blank_state( <span class="comment"># 或 entry_state，取决于是否需要模拟fopen</span></span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  filename = <span class="string">&#x27;FOQVSBZB.txt&#x27;</span> <span class="comment"># 程序将要读取的文件名 (示例)</span></span><br><span class="line">  symbolic_file_size_bytes = <span class="number">8</span> <span class="comment"># 假设密码是8字节</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 创建代表文件内容的符号位向量</span></span><br><span class="line">  password_data = claripy.BVS(<span class="string">&#x27;password_file_content&#x27;</span>, symbolic_file_size_bytes * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 创建一个模拟文件，其内容是我们的符号数据</span></span><br><span class="line">  <span class="comment"># &#x27;r&#x27;表示只读模式，Angr的SimFile也接受模式参数，但content更直接</span></span><br><span class="line">  password_file = angr.storage.SimFile(filename, content=password_data)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 将这个模拟文件插入到初始状态的文件系统中</span></span><br><span class="line">  <span class="comment"># 当程序尝试打开并读取 &#x27;FOQVSBZB.txt&#x27; 时，它会读到 password_data</span></span><br><span class="line">  initial_state.fs.insert(filename, password_file)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 求解文件内容</span></span><br><span class="line">    solution_bytes = solution_state.solver.<span class="built_in">eval</span>(password_data, cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(solution_bytes.decode()) <span class="comment"># 假设是可打印字符</span></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="解析-7"><a href="#解析-7" class="headerlink" title="解析"></a>解析</h3><p>程序会从文件中读取密码，而不是标准的输入或命令行参数。</p>
<p>解题思路：</p>
<p>确定程序读取的文件名和预期的大小。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filename = &#x27;FOQVSBZB.txt&#x27; # 程序将要读取的文件名 (示例)</span><br><span class="line">symbolic_file_size_bytes = 8 # 假设密码是8字节</span><br></pre></td></tr></table></figure>

<p>创建符号位向量代表文件内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 创建代表文件内容的符号位向量</span><br><span class="line">password_data = claripy.BVS(&#x27;password_file_content&#x27;, symbolic_file_size_bytes * 8)</span><br></pre></td></tr></table></figure>

<p>使用<code>angr.storage.SimFile(filename, content=symbolic_data)</code>创建一个模拟文件，内容是我们的符号数据。将这个模拟文件插入到初始状态的文件系统中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个模拟文件，其内容是我们的符号数据</span><br><span class="line"># &#x27;r&#x27;表示只读模式，Angr的SimFile也接受模式参数，但content更直接</span><br><span class="line">password_file = angr.storage.SimFile(filename, content=password_data)</span><br><span class="line"></span><br><span class="line"># 将这个模拟文件插入到初始状态的文件系统中</span><br><span class="line"># 当程序尝试打开并读取 &#x27;FOQVSBZB.txt&#x27; 时，它会读到 password_data</span><br><span class="line">initial_state.fs.insert(filename, password_file)</span><br></pre></td></tr></table></figure>

<p>当程序执行 <code>fopen</code>, <code>fread</code> 等文件操作时，它会从我们提供的这个符号化文件中读取。</p>
<h2 id="08-angr-constrains"><a href="#08-angr-constrains" class="headerlink" title="08_angr_constrains"></a>08_angr_constrains</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 目标是找到complex_function的输入，使其输出等于硬编码的字符串</span></span><br><span class="line">  <span class="comment"># 我们从main函数中scanf之后，complex_function执行之后，但在check_equals_调用之前开始</span></span><br><span class="line">  start_address = <span class="number">0x804863c</span> <span class="comment"># scanf之后，complex_function之前的某个点 (示例)</span></span><br><span class="line">                           <span class="comment"># 或者，让Angr执行scanf和complex_function</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address, <span class="comment"># 实际上，应该让Angr执行scanf和complex_function</span></span><br><span class="line">                        <span class="comment"># 所以可能还是entry_state()或者scanf后的地址，</span></span><br><span class="line">                        <span class="comment"># 并将原始密码符号化。</span></span><br><span class="line">                        <span class="comment"># solve08.py中直接从0x804863c开始，并符号化了password_address处的内存</span></span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 原始密码（complex_function的输入）是符号化的</span></span><br><span class="line">  <span class="comment"># 假设原始密码存储在 password_address，长度16字节</span></span><br><span class="line">  password_size_bytes = <span class="number">16</span></span><br><span class="line">  password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, password_size_bytes * <span class="number">8</span>)</span><br><span class="line">  password_address = <span class="number">0x804a040</span> <span class="comment"># 假设这是存储原始密码的全局变量地址 (示例)</span></span><br><span class="line">  initial_state.memory.store(password_address, password) <span class="comment"># 注入符号化的原始密码</span></span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 探索到调用 check_equals_ 函数之前的地址</span></span><br><span class="line">  address_to_check_constraint = <span class="number">0x8048683</span> <span class="comment"># call check_equals_... 指令的地址 (示例)</span></span><br><span class="line">  simulation.explore(find=address_to_check_constraint)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>] <span class="comment"># 到达了 call check_equals_ 的状态</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># check_equals_ 的第一个参数 (char* to_check) 是 complex_function 的输出</span></span><br><span class="line">    <span class="comment"># 这个参数的地址通常是已知的，或者可以通过分析调用前的汇编指令得到</span></span><br><span class="line">    <span class="comment"># 在这个题目中，complex_function 的输出结果（即 to_check）覆盖了原始密码的内存区域</span></span><br><span class="line">    <span class="comment"># 所以 constrained_parameter_address 就是 password_address</span></span><br><span class="line">    constrained_parameter_address = <span class="number">0x804a040</span> <span class="comment"># (示例) complex_function的输出存放地址</span></span><br><span class="line">    constrained_parameter_size_bytes = <span class="number">16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 从当前状态的内存中加载这个参数，它应该是符号化的</span></span><br><span class="line">    constrained_parameter_bitvector = solution_state.memory.load(</span><br><span class="line">      constrained_parameter_address,</span><br><span class="line">      constrained_parameter_size_bytes</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 我们知道 check_equals_ 期望的字符串 (通过反汇编或题目描述)</span></span><br><span class="line">    constrained_parameter_desired_value = <span class="string">&#x27;OSIWHBXIFOQVSBZB&#x27;</span>.encode() <span class="comment"># 目标字符串 (示例)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加约束：要求 complex_function 的输出等于期望的字符串</span></span><br><span class="line">    solution_state.add_constraints(constrained_parameter_bitvector == constrained_parameter_desired_value)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 现在，求解原始的符号密码 password</span></span><br><span class="line">    <span class="comment"># Angr会找到一个 password，使得经过 complex_function 变换后，</span></span><br><span class="line">    <span class="comment"># 其结果 (constrained_parameter_bitvector) 等于 constrained_parameter_desired_value</span></span><br><span class="line">    solution_bytes = solution_state.solver.<span class="built_in">eval</span>(password, cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(solution_bytes.decode())</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="解析-8"><a href="#解析-8" class="headerlink" title="解析"></a>解析</h3><p>程序中有一个非常复杂的检查函数（<code>check_equals_...</code>），它逐字节比较输入经过某个 <code>complex_function</code> 转换后的结果与一个硬编码的字符串。如果让Angr完整符号执行这个检查函数，由于大量的分支 (每个字节比较都是一个分支)，会导致状态爆炸，非常耗时。</p>
<img src="./assets/image-20250529105354786.png" alt="image-20250529105354786" style="zoom:67%;" />

<p>创建初始状态，假设这里的0x804863C是符号执行的起始地址。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">start_address = 0x804863c</span><br><span class="line">initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options=&#123;</span><br><span class="line">        angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">        angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>符号化密码，假设密码是16字节长，创建一个16字节的符号变量，password_address是原始密码的内存地址，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">password_size_bytes = 16</span><br><span class="line">password = claripy.BVS(&#x27;password&#x27;, password_size_bytes * 8)</span><br><span class="line">password_address = 0x804a040</span><br><span class="line">initial_state.memory.store(password_address, password) # 将符号变量password写入内存地址0x804a040</span><br></pre></td></tr></table></figure>

<p>创建模拟管理器，探索目标地址。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">address_to_check_constraint = 0x8048683</span><br><span class="line">simulation.explore(find=address_to_check_constraint)</span><br></pre></td></tr></table></figure>

<p>处理成功状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if simulation.found:</span><br><span class="line">    solution_state = simulation.found[0]</span><br></pre></td></tr></table></figure>

<p>加载和约束输出。solution_state.add_constraints(…)添加约束。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">constrained_parameter_address = 0x804a040</span><br><span class="line">constrained_parameter_size_bytes = 16</span><br><span class="line">constrained_parameter_bitvector = solution_state.memory.load(</span><br><span class="line">    constrained_parameter_address,</span><br><span class="line">    constrained_parameter_size_bytes</span><br><span class="line">)</span><br><span class="line">constrained_parameter_desired_value = &#x27;OSIWHBXIFOQVSBZB&#x27;.encode()</span><br><span class="line">solution_state.add_constraints(constrained_parameter_bitvector == constrained_parameter_desired_value)</span><br></pre></td></tr></table></figure>

<p>求解密码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">solution_bytes = solution_state.solver.eval(password, cast_to=bytes)</span><br><span class="line">print(solution_bytes.decode())</span><br></pre></td></tr></table></figure>

<h2 id="09-angr-hooks"><a href="#09-angr-hooks" class="headerlink" title="09_angr_hooks"></a>09_angr_hooks</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state( <span class="comment"># 从程序入口开始，让Angr处理scanf</span></span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  check_equals_called_address = <span class="number">0x80486ca</span> <span class="comment"># call check_equals_... 指令的地址 (示例)</span></span><br><span class="line">  instruction_to_skip_length = <span class="number">5</span> <span class="comment"># call指令的长度 (示例，通常是5字节: E8 XX XX XX XX)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 定义钩子函数</span></span><br><span class="line"><span class="meta">  @project.hook(<span class="params">check_equals_called_address, length=instruction_to_skip_length</span>)</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">skip_check_equals_</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="comment"># 假设 check_equals_ 的第一个参数 (char* to_check) 指向的地址是已知的</span></span><br><span class="line">    <span class="comment"># 在此题中，它指向 complex_function 的输出，该输出存储在全局变量 0x804a044</span></span><br><span class="line">    user_input_buffer_address = <span class="number">0x804a044</span> <span class="comment"># (示例)</span></span><br><span class="line">    user_input_buffer_length = <span class="number">16</span> <span class="comment"># 字符串长度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加载这个参数（它应该是符号化的，因为它来自用户输入经过complex_function)</span></span><br><span class="line">    user_input_string_bv = state.memory.load(</span><br><span class="line">      user_input_buffer_address,</span><br><span class="line">      user_input_buffer_length <span class="comment"># load的长度单位是字节</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    check_against_string_concrete = <span class="string">&#x27;OSIWHBXIFOQVSBZB&#x27;</span>.encode() <span class="comment"># 硬编码的目标字符串</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构造符号化的返回值：如果匹配则为1，否则为0 (32位整数)</span></span><br><span class="line">    return_value = claripy.If(</span><br><span class="line">      user_input_string_bv == check_against_string_concrete, <span class="comment"># 条件</span></span><br><span class="line">      claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), <span class="comment"># 如果为真，eax = 1 (32位)</span></span><br><span class="line">      claripy.BVV(<span class="number">0</span>, <span class="number">32</span>)  <span class="comment"># 如果为假，eax = 0 (32位)</span></span><br><span class="line">    )</span><br><span class="line">    state.regs.eax = return_value <span class="comment"># 将返回值放入eax</span></span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 输入是由Angr的scanf SimProcedure处理的，所以直接从stdin dump</span></span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="解析-9"><a href="#解析-9" class="headerlink" title="解析"></a>解析</h3><p>设置钩子。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在地址0x80486ca设置钩子，替换check_equals_的调用</span></span><br><span class="line"><span class="comment"># 当程序执行到此地址时，angr执行自定义函数skip_check_equals_</span></span><br><span class="line"><span class="comment"># 而不会调用实际的check_equals_</span></span><br><span class="line">check_equals_called_address = <span class="number">0x80486ca</span></span><br><span class="line">instruction_to_skip_length = <span class="number">5</span></span><br><span class="line"><span class="meta">@project.hook(<span class="params">check_equals_called_address, length=instruction_to_skip_length</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">skip_check_equals_</span>(<span class="params">state</span>):</span><br><span class="line"><span class="comment"># 用户输入的内容存在buffer中，buffer地址是0x804a044，长度是16</span></span><br><span class="line">    user_input_buffer_address = <span class="number">0x804a044</span></span><br><span class="line">    user_input_buffer_length = <span class="number">16</span></span><br><span class="line"><span class="comment"># 加载16字节的符号变量</span></span><br><span class="line">    user_input_string_bv = state.memory.load(</span><br><span class="line">        user_input_buffer_address,</span><br><span class="line">        user_input_buffer_length</span><br><span class="line">    )</span><br><span class="line">    check_against_string_concrete = <span class="string">&#x27;OSIWHBXIFOQVSBZB&#x27;</span>.encode()</span><br><span class="line"><span class="comment"># 构造符号化的返回值</span></span><br><span class="line"><span class="comment"># 成功则return_value = claripy.BVV(1,32)</span></span><br><span class="line"><span class="comment"># 失败则return_value = claripy.BVV(0,32)</span></span><br><span class="line">    return_value = claripy.If(</span><br><span class="line">        user_input_string_bv == check_against_string_concrete,</span><br><span class="line">        claripy.BVV(<span class="number">1</span>, <span class="number">32</span>),</span><br><span class="line">        claripy.BVV(<span class="number">0</span>, <span class="number">32</span>)</span><br><span class="line">    )</span><br><span class="line">    state.regs.eax = return_value</span><br></pre></td></tr></table></figure>

<p><strong>加载二进制文件</strong>：创建 angr 项目，解析程序。</p>
<p><strong>设置初始状态</strong>：从程序入口（main）开始，允许 angr 模拟 scanf 和 complex_function。</p>
<p><strong>钩子处理</strong>：</p>
<ul>
<li>在 check_equals_ 调用处（0x80486ca）设置钩子，跳过其执行。</li>
<li>模拟 check_equals_ 的行为，比较 0x804a044 处的符号输出与目标字符串，设置 eax 为 1（匹配）或 0（不匹配）。</li>
</ul>
<p><strong>符号执行</strong>：</p>
<ul>
<li>探索所有路径，寻找输出 “Good Job.” 的状态，避免输出 “Try again.” 的状态。</li>
</ul>
<p><strong>提取输入</strong>：从成功状态的 stdin 中提取输入密码，打印结果。</p>
<h1 id="利用angr解混淆"><a href="#利用angr解混淆" class="headerlink" title="利用angr解混淆"></a>利用angr解混淆</h1><p>已经有大佬写过了，利用angr符号执行去除虚假控制流，思路很简单，不是活跃状态的基本块全部NOP掉。</p>
<p>思路：<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-266005.htm">https://bbs.kanxue.com/thread-266005.htm</a></p>
<p>项目代码：<a target="_blank" rel="noopener" href="https://github.com/bluesadi/debogus">https://github.com/bluesadi/debogus</a></p>
<p>局限也是有的：</p>
<ol>
<li>依赖于z3约束求解，如果解不出来，则判定为非活跃状态的基本块；</li>
<li>未约束导致路径爆炸。</li>
</ol>
<h1 id="我的理解"><a href="#我的理解" class="headerlink" title="我的理解"></a>我的理解</h1><h3 id="什么是状态、成功状态？"><a href="#什么是状态、成功状态？" class="headerlink" title="什么是状态、成功状态？"></a>什么是状态、成功状态？</h3><p>在一开始，符号执行还没开始的时候，需要一个初始状态（寄存器、堆栈、内存等，它们可以被定义成符号），初始状态没有对符号的约束；</p>
<p>而成功状态就是走到了目标地址或者目标行为的状态，此时的寄存器、堆栈、内存等共同构成了成功状态；</p>
<p>在初始状态到成功状态的过程中，<strong>angr会为被定义为符号的变量收集约束，正是有了这些约束，程序才可以从初始状态走到成功状态</strong>；</p>
<p>在成功状态时，可以调用angr相关的函数，根据约束计算出符号变量的值。</p>
<h3 id="状态的更新与分裂？"><a href="#状态的更新与分裂？" class="headerlink" title="状态的更新与分裂？"></a>状态的更新与分裂？</h3><p>每个基本块都有一个状态，每执行一条指令，状态都会对自身进行<strong>更新</strong>；而当来到条件分支的时候，会基于当前的状态，创建<strong>分裂</strong>出独立的、并行的多个状态，此时称作<strong>产生</strong>了新的状态。</p>
<h3 id="angr符号执行与基本块的关系？"><a href="#angr符号执行与基本块的关系？" class="headerlink" title="angr符号执行与基本块的关系？"></a>angr符号执行与基本块的关系？</h3><p><strong>基本块</strong>的特点是：</p>
<ol>
<li>只有一个入口点（第一条指令）；</li>
<li>只有一个出口点（最后一条指令，通常是跳转、返回、条件分支）。</li>
</ol>
<p><strong>angr</strong>是一种符号执行框架，它通过将程序的输入（例如标准输入或参数）表示为符号变量（claripy.BVS），模拟程序的所有可能执行路径。angr 跟踪符号变量如何影响程序的状态（寄存器、内存等），并使用约束求解器（通常是 Z3）来确定哪些输入能够引导程序到达特定目标（如某个地址）。</p>
<p>在 angr 的符号执行过程中，基本块是程序执行的“原子单位”，而符号执行是基于这些基本块进行路径探索的。</p>
<ol>
<li><p>基本块是执行的单位</p>
<ul>
<li>angr 在符号执行时，会将程序分解为基本块（通过静态分析生成 CFG 或动态执行时解析）。每个基本块代表一段连续的指令，angr 会逐块模拟执行。</li>
<li>在执行一个基本块时，angr 更新当前状态的寄存器、内存等内容，并根据基本块的出口指令（例如跳转、条件分支、返回）决定下一步的执行路径。</li>
</ul>
</li>
<li><p>状态分叉与基本块的出口</p>
<ul>
<li><p>当基本块的最后一条指令是条件分支（例如 if 语句对应的 je、jne 等跳转指令），angr 会根据条件生成多个新的状态（state），分别对应分支的真假路径。</p>
</li>
<li><p>例如，假设一个基本块以 </p>
<p>if (input[0] &#x3D;&#x3D; ‘A’)</p>
<p> 结束，angr 会：</p>
<ul>
<li>创建一个状态，约束 input[0] &#x3D;&#x3D; ‘A’，继续执行真分支。</li>
<li>创建另一个状态，约束 input[0] !&#x3D; ‘A’，继续执行假分支。</li>
</ul>
</li>
<li><p>这些分叉点通常发生在基本块的出口，因此基本块的边界决定了状态分叉的时机。</p>
</li>
</ul>
</li>
<li><p>符号执行跟踪基本块的路径</p>
<ul>
<li>angr 的符号执行本质上是沿着 CFG 的路径探索，每个路径由一系列基本块组成。angr 维护一个状态池（通过 SimulationManager，即 simgr），跟踪每个状态对应的执行路径。</li>
<li>每个状态在执行一个基本块后，会更新其上下文（例如寄存器、内存），并根据基本块的出口指令跳转到下一个基本块。</li>
</ul>
</li>
<li><p>约束累积与基本块</p>
<ul>
<li>在执行基本块的过程中，angr 会根据指令的逻辑为符号变量添加约束。例如，如果一个基本块包含比较指令 cmp input[0], ‘A’，angr 会在分支时为符号变量 input[0] 添加约束（如 input[0] &#x3D;&#x3D; ‘A’ 或 input[0] !&#x3D; ‘A’）。</li>
<li>这些约束是符号执行的核心，用于在成功状态中求解具体输入。</li>
</ul>
</li>
<li><p>成功状态与基本块</p>
<ul>
<li>当 angr 的符号执行到达目标地址（例如 find&#x3D;print_good_address），对应的状态通常位于某个基本块的入口或内部。成功状态包含了从初始状态到目标地址的完整执行路径（即一系列基本块），以及符号输入的约束集合。</li>
<li>通过 solution_state.posix.dumps(sys.stdin.fileno())，angr 求解这些约束，得到引导程序到达目标基本块的输入值。</li>
</ul>
</li>
</ol>
<p>同时，<strong>angr 不会为每条指令生成新状态（而是基于原状态进行更新），而在基本块的边界（特别是条件分支）生成新状态</strong>。状态分叉发生在基本块的出口，基于分支条件。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/27/baidu%E5%85%8D%E8%B4%B9%E5%A3%B3%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/27/baidu%E5%85%8D%E8%B4%B9%E5%A3%B3%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/" class="post-title-link" itemprop="url">baidu免费壳分析复现</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-27 21:26:01 / 修改时间：21:27:27" itemprop="dateCreated datePublished" datetime="2025-05-27T21:26:01+08:00">2025-05-27</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>129k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3:55</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="libbaiduprotect-so加载分析"><a href="#libbaiduprotect-so加载分析" class="headerlink" title="libbaiduprotect.so加载分析"></a>libbaiduprotect.so加载分析</h1><p>通过Manifest可以看到<strong>包名</strong>和第一个加载的<strong>app类</strong>。——“com.example.test”和“com.baidu.protect.StubApplication”。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508082508430.png" alt="image-20250508082508430"></p>
<p>在原来的lib下，多出了一个libbaiduprotect.so，而在assets下面也多了几个文件。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508082719470.png" alt="image-20250508082719470"></p>
<p>猜测是libbaiduprotect.so将assets下的文件解密出了dex，然后进行加载。</p>
<p>下面开始分析。</p>
<p>根据app类的名称，找到app类，一般整体壳，app类会对attachBaseContext和onCreate进行覆写。</p>
<p>先看attachBaseContext。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508083159829.png" alt="image-20250508083159829" style="zoom:80%;" />

<p>其中，StubApplication.loadLibrary实际上是加载了libbaiduprotect.so，因此，接下来用ida查看libbaiduprotect.so。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508083312421.png" alt="image-20250508083312421"></p>
<p>搜索函数“init_proc”并没有搜到，接下来查看.init_array节，存在以下在加载so阶段会执行的函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508083540297.png" alt="image-20250508083540297" style="zoom:80%;" />

<p>先来看sub_88060，一眼混淆，本来靠着NOP，去掉了几个虚假控制流和不透明谓词，但还是太多了，直接使用d810进行处理。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508083806546.png" alt="image-20250508083806546"></p>
<p>处理完后，算上default的话，有32个case选项，看样子是在做解密操作。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508084218294.png" alt="image-20250508084218294"></p>
<p>再来看JNI_OnLoad，会发现被加密了，可以猜到是sub_88060对它进行了加密。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508091104891.png" alt="image-20250508091104891"></p>
<p>下面是一个frida脚本，用于在sub_88060解完密后，第一时间dump整个so。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 要hook的函数offset</span></span><br><span class="line"><span class="keyword">var</span> offset = <span class="number">0x88060</span>;</span><br><span class="line"><span class="comment">// so文件的大小</span></span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 要hook的so的名字</span></span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获得linker64的地址</span></span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>)</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>    <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call)</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="comment">// 判断是否可以通过findModuleByName查找到目标so文件</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>)</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>)&#123;</span><br><span class="line">                module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                <span class="comment">// 第一时间hook</span></span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(offset), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="comment">// 在执行完某个函数后，立马进行dump</span></span><br><span class="line">            <span class="title function_">dump</span>(baseaddr, module_size);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump</span>(<span class="params">begin_addr, dump_size</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[name] &quot;</span>, module_name);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[base] &quot;</span>, begin_addr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[size] &quot;</span>, <span class="string">&quot;0x&quot;</span> + dump_size.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">    <span class="keyword">var</span> file_path = <span class="string">&quot;/data/data/com.example.test/zzc_&quot;</span> + begin_addr + <span class="string">&quot;_0x&quot;</span> + dump_size.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;.so&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="title function_">ptr</span>(begin_addr), dump_size, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> libso_buffer = <span class="title function_">ptr</span>(begin_addr).<span class="title function_">readByteArray</span>(dump_size);</span><br><span class="line">        file_handle.<span class="title function_">write</span>(libso_buffer);</span><br><span class="line">        file_handle.<span class="title function_">flush</span>();</span><br><span class="line">        file_handle.<span class="title function_">close</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump] &quot;</span>, file_path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors)</span><br></pre></td></tr></table></figure>

<p>将dump下来的so文件，通过soFixer进行修复。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SoFixer-Windows-64.exe -s .\zzc_0x6f7471a000_0xc1000.so -o .\zzc_0x6f7471a000_0xc1000.sofixer.so -m 0x6f7471a000 -d</span><br></pre></td></tr></table></figure>

<p>可以看到，JNI_OnLoad已经恢复正常了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508091410337.png" alt="image-20250508091410337"></p>
<p>接下来看其它的在.init_array上的函数（在加密so的中查看）。</p>
<p>查看sub_6FC4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508091509137.png" alt="image-20250508091509137"></p>
<p>可以看出来，qword_28c28s是一个函数指针，它在解密后面那一串内容。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508091601327.png" alt="image-20250508091601327"></p>
<p>点开地址28c28的位置，发现存在加密的内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508091851238.png" alt="image-20250508091851238" style="zoom: 50%;" />

<p>这说明这个函数也需要得到解密，那就只能是在sub_88060里了，去另一个解密的so文件看一眼，发现果然解密了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508091913526.png" alt="image-20250508091913526" style="zoom: 50%;" />

<p>通过hook解密后的sub_28c28，可以得到解密字符串，脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 要hook的函数offset</span></span><br><span class="line"><span class="keyword">var</span> offset = <span class="number">0x88060</span>;</span><br><span class="line"><span class="comment">// so文件的大小</span></span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 要hook的so的名字</span></span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获得linker64的地址</span></span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>)</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>    <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call)</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="comment">// 判断是否可以通过findModuleByName查找到目标so文件</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>)</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>)&#123;</span><br><span class="line">                module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                <span class="comment">// 第一时间hook</span></span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(offset), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="comment">// 第一个函数解密完后，才能hook sub_28c28</span></span><br><span class="line">            <span class="title function_">decrypt_28c28</span>(baseaddr);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">decrypt_28c28</span>(<span class="params">baseaddr</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(<span class="number">0x28c28</span>), &#123;</span><br><span class="line">            <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[sub_28c28] &quot;</span>, <span class="string">&quot;arg = &quot;</span>, <span class="title function_">ptr</span>(args[<span class="number">0</span>]).<span class="title function_">readCString</span>());</span><br><span class="line">            &#125;, <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[sub_28c28] &quot;</span>, <span class="string">&quot;retval = &quot;</span>, <span class="title function_">ptr</span>(retval).<span class="title function_">readCString</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors)</span><br></pre></td></tr></table></figure>

<p>执行的结果如下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508092118543.png" alt="image-20250508092118543" style="zoom:80%;" />

<p>写了一个ida脚本，给这些字符串的地方添加注释。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"></span><br><span class="line"># 加密/明文映射</span><br><span class="line">mappings = &#123;</span><br><span class="line">    <span class="string">&quot;710E34DFB3D273975E0936FBB4CF62BE541F3CC4A8&quot;</span>: <span class="string">&quot;FeatureLibcProtection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;530A39DDAFCB39A84E1821CEAB8F52BE4F3B34DFAEEC7FA843&quot;</span>: <span class="string">&quot;dalvik/system/DexPathList&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 函数列表（地址或函数名）</span><br><span class="line">func_list = [</span><br><span class="line">    <span class="number">0x28c28</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">def <span class="title function_">find_string_addr</span>(search_str):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;查找字符串的地址&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> addr <span class="keyword">in</span> idautils.<span class="title class_">Strings</span>():</span><br><span class="line">        <span class="keyword">if</span> <span class="title function_">str</span>(addr) == <span class="attr">search_str</span>:</span><br><span class="line">            <span class="keyword">return</span> addr.<span class="property">ea</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">None</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">resolve_func_addr</span>(func_entry):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;将函数名或地址转换为地址&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="title function_">isinstance</span>(func_entry, int):</span><br><span class="line">        <span class="keyword">return</span> func_entry</span><br><span class="line">    elif <span class="title function_">isinstance</span>(func_entry, str):</span><br><span class="line">        func_addr = idaapi.<span class="title function_">get_name_ea_simple</span>(func_entry)</span><br><span class="line">        <span class="keyword">if</span> func_addr == idaapi.<span class="property">BADADDR</span>:</span><br><span class="line">            <span class="title function_">print</span>(f<span class="string">&quot;Function not found: &#123;func_entry&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">None</span></span><br><span class="line">        <span class="keyword">return</span> func_addr</span><br><span class="line">    <span class="attr">else</span>:</span><br><span class="line">        <span class="title function_">print</span>(f<span class="string">&quot;Invalid function entry: &#123;func_entry&#125;&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">None</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">add_comments_to_strings</span>():</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;为 .rodata 中的字符串添加解密注释和重命名&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> encrypted, decrypted <span class="keyword">in</span> mappings.<span class="title function_">items</span>():</span><br><span class="line">        str_addr = <span class="title function_">find_string_addr</span>(encrypted)</span><br><span class="line">        <span class="keyword">if</span> <span class="attr">str_addr</span>:</span><br><span class="line">            idaapi.<span class="title function_">set_cmt</span>(str_addr, f<span class="string">&quot;Decrypted: &#123;decrypted&#125;&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            # 重命名字符串，替换特殊字符以符合命名规则</span><br><span class="line">            safe_name = f<span class="string">&quot;str_&#123;decrypted.replace(&#x27;/&#x27;, &#x27;_&#x27;).replace(&#x27; &#x27;, &#x27;_&#x27;)&#125;&quot;</span></span><br><span class="line">            idaapi.<span class="title function_">set_name</span>(str_addr, safe_name, idaapi.<span class="property">SN_FORCE</span>)</span><br><span class="line">            <span class="title function_">print</span>(f<span class="string">&quot;Added comment at 0x&#123;str_addr:x&#125;: &#123;encrypted&#125; -&gt; &#123;decrypted&#125;&quot;</span>)</span><br><span class="line">        <span class="attr">else</span>:</span><br><span class="line">            <span class="title function_">print</span>(f<span class="string">&quot;String not found in .rodata: &#123;encrypted&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">def <span class="title function_">add_comments_to_function</span>(func_addr):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;为指定函数添加注释，扫描加载字符串的指令&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    func = idaapi.<span class="title function_">get_func</span>(func_addr)</span><br><span class="line">    <span class="keyword">if</span> not <span class="attr">func</span>:</span><br><span class="line">        <span class="title function_">print</span>(f<span class="string">&quot;Function at 0x&#123;func_addr:x&#125; not found or invalid&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    # 添加函数注释</span><br><span class="line">    func_name = idaapi.<span class="title function_">get_func_name</span>(func_addr)</span><br><span class="line">    idaapi.<span class="title function_">set_func_cmt</span>(func_addr, f<span class="string">&quot;Decrypts strings (e.g., &#123;&#x27;, &#x27;.join(f&#x27;&#123;k&#125;-&gt;&#123;v&#125;&#x27; for k, v in mappings.items())&#125;)&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="title function_">print</span>(f<span class="string">&quot;Processing function: &#123;func_name&#125; at 0x&#123;func_addr:x&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    # 扫描函数指令，查找加载字符串的指令</span><br><span class="line">    <span class="keyword">for</span> ea <span class="keyword">in</span> idautils.<span class="title class_">FuncItems</span>(func.<span class="property">start_ea</span>):</span><br><span class="line">        disasm = idaapi.<span class="title function_">generate_disasm_line</span>(ea, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;LDR&quot;</span> <span class="keyword">in</span> <span class="attr">disasm</span>:  # 检查加载指令</span><br><span class="line">            <span class="keyword">for</span> enc, dec <span class="keyword">in</span> mappings.<span class="title function_">items</span>():</span><br><span class="line">                <span class="keyword">if</span> enc <span class="keyword">in</span> <span class="attr">disasm</span>:</span><br><span class="line">                    idaapi.<span class="title function_">set_cmt</span>(ea, f<span class="string">&quot;Loads &#123;enc&#125; -&gt; &#123;dec&#125;&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                    <span class="title function_">print</span>(f<span class="string">&quot;Added comment at 0x&#123;ea:x&#125;: &#123;enc&#125; -&gt; &#123;dec&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">def <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;主函数：处理字符串和函数列表&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    # 处理 .<span class="property">rodata</span> 中的字符串</span><br><span class="line">    <span class="title function_">print</span>(<span class="string">&quot;Processing strings in .rodata...&quot;</span>)</span><br><span class="line">    <span class="title function_">add_comments_to_strings</span>()</span><br><span class="line"></span><br><span class="line">    # 处理函数列表</span><br><span class="line">    <span class="title function_">print</span>(<span class="string">&quot;\nProcessing functions...&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> func_entry <span class="keyword">in</span> <span class="attr">func_list</span>:</span><br><span class="line">        func_addr = <span class="title function_">resolve_func_addr</span>(func_entry)</span><br><span class="line">        <span class="keyword">if</span> func_addr is not <span class="title class_">None</span>:</span><br><span class="line">            <span class="title function_">add_comments_to_function</span>(func_addr)</span><br><span class="line">        <span class="attr">else</span>:</span><br><span class="line">            <span class="title function_">print</span>(f<span class="string">&quot;Skipping invalid function: &#123;func_entry&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"># 执行脚本</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="title function_">main</span>()</span><br></pre></td></tr></table></figure>

<p>ida脚本的执行情况如下，自动添加注释并对字符串重命名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508092227454.png" alt="image-20250508092227454"></p>
<p>回到sub_6FC4的位置，710….代表FeatureLibcProtection。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508092616184.png" alt="image-20250508092616184"></p>
<p>函数sub_3E590也被加密了，通过解密的so文件查看，它似乎是在赋值？a1是一个全局变量，a2是解密后的字符串，a3是1，似乎是一个索引。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508092711397.png" alt="image-20250508092711397" style="zoom:80%;" />

<p>BB9B0是一个函数指针，存放着的内容是sub_811B8的地址（也就是811B8）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508093513610.png" alt="image-20250508093513610"></p>
<p>这里创建一个结构体，由于函数指针和字符串指针都是指针，这里定义为__int64*。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508094125599.png" alt="image-20250508094125599"></p>
<p>结构就比较容易懂了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508094428716.png" alt="image-20250508094428716"></p>
<p>因此，sub_6FC4可以理解为在做函数注册。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508100357713.png" alt="image-20250508100357713"></p>
<p>会根据index，在对应的槽位注册。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508100323592.png" alt="image-20250508100323592" style="zoom: 67%;" />

<p>根据分析，注册了8个函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508095355396.png" alt="image-20250508095355396" style="zoom:80%;" />

<p>整理一下，注册关系大致如下。</p>
<p>sub_B3B4 -&gt; 索引1 -&gt; global_func_list[1]。</p>
<p>sub_3E29C -&gt; 索引3 -&gt; global_func_list[3]。</p>
<p>sub_40CF8 -&gt; 索引6 -&gt; global_func_list[6]。</p>
<p>sub_3DFC4 -&gt; 索引7 -&gt; global_func_list[7]。</p>
<p>sub_11F5C -&gt; 索引8 -&gt; global_func_list[8]。</p>
<p>sub_45964 -&gt; 索引9 -&gt; global_func_list[9]。</p>
<p>sub_3E96C -&gt; 索引10 -&gt; global_func_list[10]。</p>
<p>sub_42388 -&gt; 索引13 -&gt; global_func_list[13]。</p>
<p>之后开始分析JNI_onLoad，由于加密的so中，JNI_onLoad没有解密，所以这里根据解密的so的JNI_onLoad进行分析。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508103142823.png" alt="image-20250508103142823" style="zoom: 50%;" />

<p>上来就看到一大堆混淆，用d810处理一下。</p>
<p>可能是由于从内存中dump出来的缘故，反汇编伪代码的效果不是很好，连vm都看不到在哪里使用了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508103810153.png" alt="image-20250508103810153" style="zoom:80%;" />

<p>先看sub_91D8，十分眼熟，+48，基本可以确认a1是JNIEnv*的类型了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508103914736.png" alt="image-20250508103914736" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508104015382.png" alt="image-20250508104015382" style="zoom:80%;" />

<p>之后再看sub_7BC4，槽位0是经过初始化的，但没存前面的函数（应该被sub_82254初始化了），如果0号元素的内容为空，则调用sub_3E5A8进行清空。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508104607048.png" alt="image-20250508104607048" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508104938793.png" alt="image-20250508104938793" style="zoom:50%;" />

<p>所以，可以把函数sub_7BC4理解为，判断函数是否注册完毕。</p>
<p>接着看函数sub_3E628，没搞明白v11、v12在做什么，但能看得出来，是在调用函数列表里的函数，第一个参数是自己的地址，第二个参数是1（JNI_OnLoad传入的a2）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130255689.png" alt="image-20250508130255689"></p>
<p>先来观察函数列表的index为1的函数sub_B3B4。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130512877.png" alt="image-20250508130512877" style="zoom: 67%;" />

<p>如果a2不为1，直接返回，说明sub_B3B4只接受a2&#x3D;&#x3D;1的情况。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130621090.png" alt="image-20250508130621090"></p>
<p>sub_B3B4对很多字符串进行了解密，同时连接了很多字符串。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130801265.png" alt="image-20250508130801265" style="zoom: 50%;" />

<p>配合着脚本，实现了对这些字符串的解密。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 要hook的函数offset</span></span><br><span class="line"><span class="keyword">var</span> offset = <span class="number">0x88060</span>;</span><br><span class="line"><span class="comment">// so文件的大小</span></span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 要hook的so的名字</span></span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解密函数的偏移列表（从 sub_28AD0 到 sub_28A24）</span></span><br><span class="line"><span class="keyword">var</span> decrypt_offsets = [</span><br><span class="line">    <span class="number">0x28AD0</span>, <span class="number">0x25E78</span>, <span class="number">0x25F24</span>, <span class="number">0x25FD0</span>, <span class="number">0x2607C</span>, <span class="number">0x26128</span>, <span class="number">0x261D4</span>, <span class="number">0x26280</span>,</span><br><span class="line">    <span class="number">0x2632C</span>, <span class="number">0x263D8</span>, <span class="number">0x26484</span>, <span class="number">0x26530</span>, <span class="number">0x265DC</span>, <span class="number">0x26688</span>, <span class="number">0x26734</span>, <span class="number">0x267E0</span>,</span><br><span class="line">    <span class="number">0x2688C</span>, <span class="number">0x26938</span>, <span class="number">0x269E4</span>, <span class="number">0x26A90</span>, <span class="number">0x26B3C</span>, <span class="number">0x26BE8</span>, <span class="number">0x26C94</span>, <span class="number">0x26D40</span>,</span><br><span class="line">    <span class="number">0x26DEC</span>, <span class="number">0x26E98</span>, <span class="number">0x26F44</span>, <span class="number">0x26FF0</span>, <span class="number">0x2709C</span>, <span class="number">0x27148</span>, <span class="number">0x271F4</span>, <span class="number">0x272A0</span>,</span><br><span class="line">    <span class="number">0x2734C</span>, <span class="number">0x273F8</span>, <span class="number">0x274A4</span>, <span class="number">0x27550</span>, <span class="number">0x275FC</span>, <span class="number">0x276A8</span>, <span class="number">0x27754</span>, <span class="number">0x27800</span>,</span><br><span class="line">    <span class="number">0x278AC</span>, <span class="number">0x27958</span>, <span class="number">0x27A04</span>, <span class="number">0x27AB0</span>, <span class="number">0x27B5C</span>, <span class="number">0x27C08</span>, <span class="number">0x27CB4</span>, <span class="number">0x27D60</span>,</span><br><span class="line">    <span class="number">0x27E0C</span>, <span class="number">0x27EB8</span>, <span class="number">0x27F64</span>, <span class="number">0x28010</span>, <span class="number">0x280BC</span>, <span class="number">0x28168</span>, <span class="number">0x28214</span>, <span class="number">0x282C0</span>,</span><br><span class="line">    <span class="number">0x2836C</span>, <span class="number">0x28418</span>, <span class="number">0x284C4</span>, <span class="number">0x28570</span>, <span class="number">0x2861C</span>, <span class="number">0x286C8</span>, <span class="number">0x28774</span>, <span class="number">0x28820</span>,</span><br><span class="line">    <span class="number">0x288CC</span>, <span class="number">0x28A24</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获得linker64的地址</span></span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>;    <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="comment">// 判断是否可以通过findModuleByName查找到目标so文件</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                <span class="comment">// 第一时间hook</span></span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(offset), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[target_func] onEnter, offset:&quot;</span>, offset.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[target_func] onLeave, retval:&quot;</span>, retval);</span><br><span class="line">            <span class="comment">// 第一个函数解密完后，Hook 所有解密函数</span></span><br><span class="line">            <span class="title function_">hook_decrypt_funcs</span>(baseaddr);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_decrypt_funcs</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="comment">// Hook sub_28C28（保持原有逻辑）</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(<span class="number">0x28C28</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[sub_28C28] arg =&quot;</span>, <span class="title function_">ptr</span>(args[<span class="number">0</span>]).<span class="title function_">readCString</span>());</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[sub_28C28] retval =&quot;</span>, <span class="title function_">ptr</span>(retval).<span class="title function_">readCString</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 循环 Hook 所有解密函数</span></span><br><span class="line">    decrypt_offsets.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> func_name = <span class="string">&quot;sub_&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">toUpperCase</span>();</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(offset), &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] arg =&quot;</span>, <span class="title function_">ptr</span>(args[<span class="number">0</span>]).<span class="title function_">readCString</span>());</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] retval =&quot;</span>, <span class="title function_">ptr</span>(retval).<span class="title function_">readCString</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>用ida进行修改并添加注释。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加密/明文映射（从 Frida 输出中提取）</span></span><br><span class="line">mappings = &#123;</span><br><span class="line">    <span class="string">&quot;710E34DFB3D273975E0936FBB4CF62BE541F3CC4A8&quot;</span>: <span class="string">&quot;FeatureLibcProtection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;530A39DDAFCB39A84E1821CEAB8F52BE4F3B34DFAEEC7FA843&quot;</span>: <span class="string">&quot;dalvik/system/DexPathList&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3D7CDAABED5340D60976CFBAFB5560E80D70C9B0F64C40E80F&quot;</span>: <span class="string">&quot;FeatureProtectEnvironment&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5227DBB22926DA554467C6EF2433D6524567F7&quot;</span>: <span class="string">&quot;com/baidu/protect/A&quot;</span>,</span><br><span class="line">    <span class="string">&quot;14D64606364E3C6D&quot;</span>: <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5A483597E76FC0D170423682FE54CBF073&quot;</span>: <span class="string">&quot;FeatureGlobalInfo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;47986CBE0A46F6EE6F8968AD0D5DE7DE429568A914&quot;</span>: <span class="string">&quot;FeatureIntegrityCheck&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5227DBB22926DA554467C6EF2433D6524567F5EF2A34DB795026D2F12E35&quot;</span>: <span class="string">&quot;com/baidu/protect/CrashHandler&quot;</span>,</span><br><span class="line">    <span class="string">&quot;02D740473B583B0914975D1A364D370E15976F&quot;</span>: <span class="string">&quot;com/baidu/protect/B&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0406D0C873B03D581246CD957EA5315F1346FC9761983A5A08&quot;</span>: <span class="string">&quot;com/baidu/protect/AppInfo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C7D432A325E854F696D43CFF27BF03F7&quot;</span>: <span class="string">&quot;c07954f5209e7c14&quot;</span>,</span><br><span class="line">    <span class="string">&quot;67C538FE4857A6C4309F39AB4B06A5C5&quot;</span>: <span class="string">&quot;f8547c5c1b4a426b&quot;</span>,</span><br><span class="line">    <span class="string">&quot;260714BFA582481D715D15EAA6D34B1C785B43B8F385444A705E15EAF3D54C4B&quot;</span>: <span class="string">&quot;f8547c5c1b4a426b8db3ad940a4aa415&quot;</span>,</span><br><span class="line">    <span class="string">&quot;57585C810030ABC6530C06D65363FF9C545A5CD60367A9CD545400D45430A8C9&quot;</span>: <span class="string">&quot;359b71797ac5dbcc07954f5209e7c146&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7E6EA364435927F7&quot;</span>: <span class="string">&quot;.suuid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3148B69D4B47B331&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;61B82D685939526D&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;065A40FFE793182D255C54F9FB95042D0474&quot;</span>: <span class="string">&quot;FeatureSecuritySDK&quot;</span>,</span><br><span class="line">    <span class="string">&quot;1901FAF72A31D21E5D29D8FA6408D15B542BC2A6100BD950472999F12A29D41E7E2ADCF82833881867&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;49F16102384F33420DD9430F7676300704DB59530275380C17D90204385735422EDA470D3A4D69443B&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4F20F18D70A735130B08D3803E9E3656020AC9DC4A9D3E5D1108928B70BF3313280BD78272A56F1525&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)B&quot;</span>,</span><br><span class="line">    <span class="string">&quot;8CAD49F071AA53ECC8856BFD3F9350A9C18771A14B9058A2D2852AF671B255ECEB866FFF73A809EAE7&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)C&quot;</span>,</span><br><span class="line">    <span class="string">&quot;29B441A01E42F2886D9C63AD507BF1CD649E79F12478F9C6779C22A61E5AF4884E9F67AF1C40A88E52&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)S&quot;</span>,</span><br><span class="line">    <span class="string">&quot;68766DE1F3971C512C5E4FECBDAE1F14255C55B0C9AD171F365E0EE7F38F1A510F5D4BEEF195465709&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)I&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4C2429895677FDD0080C0B84184EFE95010E11D86C4DF69E120C4A8F566FFBD02B0F0F865475A7D62E&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)J&quot;</span>,</span><br><span class="line">    <span class="string">&quot;78549A7B4B4B46D83C7CB8760572459D357EA22A71714D96267CF97D4B5340D81F7FBC7449491CDE16&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)F&quot;</span>,</span><br><span class="line">    <span class="string">&quot;8F4502F0DDCDC5C2CB6D20FD93F4C687C26F3AA1E7F7CE8CD16D61F6DDD5C3C2E86E24FFDFCF9FC4E3&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)D&quot;</span>,</span><br><span class="line">    <span class="string">&quot;A34B5090CFED8214E763729D81D48151EE6168C1F5D7895AFD633396CFF58414C460769FCDEFD812C7687D8CCFB48F5AE56533B5CCF18658FF39&quot;</span>: <span class="string">&quot;(ILjava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2E68C02CC53A063D255DD337C42D001F0162CF&quot;</span>: <span class="string">&quot;FeatureVMProtection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;F48398ED31542B0E&quot;</span>: <span class="string">&quot;libc.so&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6E2DCEF43F47B331&quot;</span>: <span class="string">&quot;_exit&quot;</span>,</span><br><span class="line">    <span class="string">&quot;04C0441C5939526D&quot;</span>: <span class="string">&quot;exit&quot;</span>,</span><br><span class="line">    <span class="string">&quot;171DD59574B03063041BD88665B4&quot;</span>: <span class="string">&quot;pthread_create&quot;</span>,</span><br><span class="line">    <span class="string">&quot;D4906DE875BD569CCE8B6CF4&quot;</span>: <span class="string">&quot;pthread_join&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6C9860A90F4D93A7&quot;</span>: <span class="string">&quot;memcpy&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2D5E4DE7FD827D7E&quot;</span>: <span class="string">&quot;malloc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;070C098F58629CFF&quot;</span>: <span class="string">&quot;calloc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3D78BB624F4927F7&quot;</span>: <span class="string">&quot;memset&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C1633EFFD2BBA4ED&quot;</span>: <span class="string">&quot;fopen&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ED617095DDFEE33B&quot;</span>: <span class="string">&quot;fclose&quot;</span>,</span><br><span class="line">    <span class="string">&quot;E24E68C72ED3BB4E&quot;</span>: <span class="string">&quot;fgets&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4EFE6FC425A325B6&quot;</span>: <span class="string">&quot;strtoul&quot;</span>,</span><br><span class="line">    <span class="string">&quot;30640DB4A5A47CCE&quot;</span>: <span class="string">&quot;strtoull&quot;</span>,</span><br><span class="line">    <span class="string">&quot;59CA0B1C240EE666&quot;</span>: <span class="string">&quot;strstr&quot;</span>,</span><br><span class="line">    <span class="string">&quot;B3783A25593967C1&quot;</span>: <span class="string">&quot;ptrace&quot;</span>,</span><br><span class="line">    <span class="string">&quot;715D268CE678C6E2&quot;</span>: <span class="string">&quot;mprotect&quot;</span>,</span><br><span class="line">    <span class="string">&quot;678568CC1272D9F4&quot;</span>: <span class="string">&quot;strlen&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4333E40A59E92B6B&quot;</span>: <span class="string">&quot;sscanf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;20C396763EB607CE&quot;</span>: <span class="string">&quot;free&quot;</span>,</span><br><span class="line">    <span class="string">&quot;59EFF51F63070DB8&quot;</span>: <span class="string">&quot;strdup&quot;</span>,</span><br><span class="line">    <span class="string">&quot;1B79D33BDD38636B&quot;</span>: <span class="string">&quot;strcmp&quot;</span>,</span><br><span class="line">    <span class="string">&quot;11EDA0D862CA71BA0FE9&quot;</span>: <span class="string">&quot;strcasecmp&quot;</span>,</span><br><span class="line">    <span class="string">&quot;AD1C8CA1863C3CF3&quot;</span>: <span class="string">&quot;utime&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7F7567B6D496D9AC&quot;</span>: <span class="string">&quot;mkdir&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3F4E6764B2499D86&quot;</span>: <span class="string">&quot;open&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7838B71CCAAF75C6&quot;</span>: <span class="string">&quot;close&quot;</span>,</span><br><span class="line">    <span class="string">&quot;04B2CD050F9C47EE&quot;</span>: <span class="string">&quot;unlink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;086DDAAB98212586&quot;</span>: <span class="string">&quot;stat&quot;</span>,</span><br><span class="line">    <span class="string">&quot;E2292D97D01141B6&quot;</span>: <span class="string">&quot;time&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6E4AC4CB291788D4&quot;</span>: <span class="string">&quot;snprintf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;302FD3054ECECD91&quot;</span>: <span class="string">&quot;strchr&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C65AB9D5625867A8&quot;</span>: <span class="string">&quot;strncmp&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0C8A9ABA3559D876189B86A93350&quot;</span>: <span class="string">&quot;pthread_detach&quot;</span>,</span><br><span class="line">    <span class="string">&quot;B4D5455E4F6B8C3BB7C4414A&quot;</span>: <span class="string">&quot;pthread_self&quot;</span>,</span><br><span class="line">    <span class="string">&quot;A832C433D41105B4&quot;</span>: <span class="string">&quot;opendir&quot;</span>,</span><br><span class="line">    <span class="string">&quot;63C7D8A1855BE1D1&quot;</span>: <span class="string">&quot;readdir&quot;</span>,</span><br><span class="line">    <span class="string">&quot;DD596595BC74408E&quot;</span>: <span class="string">&quot;closedir&quot;</span>,</span><br><span class="line">    <span class="string">&quot;711BD780E966683E&quot;</span>: <span class="string">&quot;mmap&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3B70EDB05642EDB6&quot;</span>: <span class="string">&quot;munmap&quot;</span>,</span><br><span class="line">    <span class="string">&quot;31F4B35BA15DF8D9&quot;</span>: <span class="string">&quot;lseek&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3A7B1DDB8EAEEB3C&quot;</span>: <span class="string">&quot;fstat&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2DC5B93C51DE4E8C&quot;</span>: <span class="string">&quot;read&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CD3E5AC4CE4EB523&quot;</span>: <span class="string">&quot;select&quot;</span>,</span><br><span class="line">    <span class="string">&quot;9C6E379605B933C39F71&quot;</span>: <span class="string">&quot;bsd_signal&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C489B09443666A3D&quot;</span>: <span class="string">&quot;fork&quot;</span>,</span><br><span class="line">    <span class="string">&quot;266DF31562D26748&quot;</span>: <span class="string">&quot;prctl&quot;</span>,</span><br><span class="line">    <span class="string">&quot;176E4794FD670E8110&quot;</span>: <span class="string">&quot;setrlimit&quot;</span>,</span><br><span class="line">    <span class="string">&quot;50660A65A953F202&quot;</span>: <span class="string">&quot;getppid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;9B333E341D4B67D8&quot;</span>: <span class="string">&quot;getpid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;68D77BE990FA40DB&quot;</span>: <span class="string">&quot;waitpid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;03B093571B66B5A9&quot;</span>: <span class="string">&quot;kill&quot;</span>,</span><br><span class="line">    <span class="string">&quot;75F6DC484BF43E44&quot;</span>: <span class="string">&quot;flock&quot;</span>,</span><br><span class="line">    <span class="string">&quot;795BD9475A856CF3&quot;</span>: <span class="string">&quot;write&quot;</span>,</span><br><span class="line">    <span class="string">&quot;BE66196673ACF758&quot;</span>: <span class="string">&quot;execve&quot;</span>,</span><br><span class="line">    <span class="string">&quot;296C25084100FFA8&quot;</span>: <span class="string">&quot;execv&quot;</span>,</span><br><span class="line">    <span class="string">&quot;164C148245E50A35&quot;</span>: <span class="string">&quot;execl&quot;</span>,</span><br><span class="line">    <span class="string">&quot;FEF19D484641B9EC&quot;</span>: <span class="string">&quot;sysconf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;E215844F2E808FC7E23A85592D9198DEC415905329&quot;</span>: <span class="string">&quot;__system_property_get&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C033AAA8B3EE1BBFC3&quot;</span>: <span class="string">&quot;ftruncate&quot;</span>,</span><br><span class="line">    <span class="string">&quot;D818528B9AD01DD0&quot;</span>: <span class="string">&quot;gettid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2E1331FA88B61B58&quot;</span>: <span class="string">&quot;pread64&quot;</span>,</span><br><span class="line">    <span class="string">&quot;8F6EB5FBB011CE0A&quot;</span>: <span class="string">&quot;pwrite64&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3DFBFF6E535AF038&quot;</span>: <span class="string">&quot;pread&quot;</span>,</span><br><span class="line">    <span class="string">&quot;B2D06CEC09B428DF&quot;</span>: <span class="string">&quot;pwrite&quot;</span>,</span><br><span class="line">    <span class="string">&quot;326FA0A56FCADBAB&quot;</span>: <span class="string">&quot;statvfs&quot;</span>,</span><br><span class="line">    <span class="string">&quot;09598DD611D1543C&quot;</span>: <span class="string">&quot;n001&quot;</span>,</span><br><span class="line">    <span class="string">&quot;8CA86FFB66BD1DAFC58A62B543A840AACA833ED67ABD44A28B8864F477F361B7D68D6BFD2B9058A2D2852AF671B255ECF79077F37EBB098FCE8573FB3FB053ADC3CB56EE62B55CA49FAD5FB346&quot;</span>: <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;IZ)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6FCD3DF87F3493A7&quot;</span>: <span class="string">&quot;n002&quot;</span>,</span><br><span class="line">    <span class="string">&quot;687340E5F6931217241042E4FC951810341062E4FC951806340408DD&quot;</span>: <span class="string">&quot;(Landroid/content/Context;)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0A5D55D037019CFF&quot;</span>: <span class="string">&quot;n003&quot;</span>,</span><br><span class="line">    <span class="string">&quot;783480112A3D27F7&quot;</span>: <span class="string">&quot;()V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;226212F6FEFC669A22&quot;</span>: <span class="string">&quot;arm64-v8a&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4819CF8872FE27590B0F928A70A127&quot;</span>: <span class="string">&quot;/proc/self/maps&quot;</span>,</span><br><span class="line">    <span class="string">&quot;D6E4059A10DC32C3&quot;</span>: <span class="string">&quot;r&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6D946FAE0959BDD46E&quot;</span>: <span class="string">&quot;libdvm.so&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2C5643EAE095530D2F&quot;</span>: <span class="string">&quot;libart.so&quot;</span>,</span><br><span class="line">    <span class="string">&quot;080407955A6AF59B3B01008E4273B28C0B&quot;</span>: <span class="string">&quot;libvmkid_lemur.so&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3C74B470455E09843F&quot;</span>: <span class="string">&quot;libaoc.so&quot;</span>,</span><br><span class="line">    <span class="string">&quot;54AFA16C61F747EE&quot;</span>: <span class="string">&quot;%s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;44CB02463B5D3E0202D3&quot;</span>: <span class="string">&quot;%s/.bdlock&quot;</span>,</span><br><span class="line">    <span class="string">&quot;050301915868F8D007020B97526FE8D014004AB05E66F29E10181786&quot;</span>: <span class="string">&quot;android/content/pm/Signature&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3173B263455443D83372B8654F5353D82070F9414B5E4C9637789F7F4C52&quot;</span>: <span class="string">&quot;android/content/pm/PackageInfo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C6622AE8D3D2C0C2C46320EED9D5D0C2D76161CADDD8CF8CC06903FBD2DAC388D5&quot;</span>: <span class="string">&quot;android/content/pm/PackageManager&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EA6C7888C1F28714EA726CD5EFF89752FD6B6883FAF3915EEA66&quot;</span>: <span class="string">&quot;android/app/ActivityThread&quot;</span>,</span><br><span class="line">    <span class="string">&quot;E54769C132BADF61E5597D9C1EBCD53AE15179FA30A3D7&quot;</span>: <span class="string">&quot;android/app/ContextImpl&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5AEF69E333A53DD350C972DE3EB331C2&quot;</span>: <span class="string">&quot;getSystemContext&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6B3933A1A4B562CD2A7450A1BAA13FE12C7E0BA5B2A559CF337C44&quot;</span>: <span class="string">&quot;()Landroid/app/ContextImpl;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;49CB0B1D3512922749CA101939089F3242CC1C0E34&quot;</span>: <span class="string">&quot;currentActivityThread&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EB250425543815AEAA6867254A2C4880A078213253281E95AB7E2D255E67&quot;</span>: <span class="string">&quot;()Landroid/app/ActivityThread;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7B4820B3F37ECEF77B481982FC7CC2F36E&quot;</span>: <span class="string">&quot;getPackageManager&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3CD856C11978AB9B7D9535C31872AD917A8535D01A338995779A7BC71251B89A75967FD24C&quot;</span>: <span class="string">&quot;()Landroid/content/pm/PackageManager;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5725F33B56EC400A5725CE0551E0&quot;</span>: <span class="string">&quot;getPackageInfo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6EFD997248D728A227DF943C6DC275A728D6C85A17FA66A022C39C7A5A9964A128C5967D4A9977A369E1927055D760AB0FDF957C05&quot;</span>: <span class="string">&quot;(Ljava/lang/String;I)Landroid/content/pm/PackageInfo;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;59F2E015770378CA4FE8&quot;</span>: <span class="string">&quot;signatures&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3341C036D43A0C020C22C237DE3C06051C22D1359F1B0A0C066CD52DC22D58&quot;</span>: <span class="string">&quot;[Landroid/content/pm/Signature;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;16F690C277DC55AB10F8AB&quot;</span>: <span class="string">&quot;toByteArray&quot;</span>,</span><br><span class="line">    <span class="string">&quot;F041BE8EE33C3CF3&quot;</span>: <span class="string">&quot;()[B&quot;</span>,</span><br><span class="line">    <span class="string">&quot;376D2CF19796D9AC&quot;</span>: <span class="string">&quot;%s/.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;754D2D248366B8F5&quot;</span>: <span class="string">&quot;%s/.1/%s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EA6C7888C1F28714E47133B8DBF28F5F&quot;</span>: <span class="string">&quot;android/os/Build&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C96649F611D3BB4E&quot;</span>: <span class="string">&quot;MODEL&quot;</span>,</span><br><span class="line">    <span class="string">&quot;71E07CC62BF925D753ED32E33EA420D85AB1&quot;</span>: <span class="string">&quot;Ljava/lang/String;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;E67F6728533E67C1&quot;</span>: <span class="string">&quot;%s/lib&quot;</span>,</span><br><span class="line">    <span class="string">&quot;395E7BCDB779A596&quot;</span>: <span class="string">&quot;%s/.%d&quot;</span>,</span><br><span class="line">    <span class="string">&quot;758269C5036FF69675987ED5076EB68071926E851332B39566&quot;</span>: <span class="string">&quot;assets/baiduprotect%d.jar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;1F71A90156FD2B6B&quot;</span>: <span class="string">&quot;/1.jar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;69D29F724DC562BD68DB9261&quot;</span>: <span class="string">&quot;/classes.jar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;05F8EB1A650468CB04FFE203&quot;</span>: <span class="string">&quot;/classes.dex&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4769C02CD167070A1C6C8E7DC3674D4E0C22C234D13B100E1B23CB39C2&quot;</span>: <span class="string">&quot;/data/data/%s/.%d/classes.jar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4DFDB3CF629670B816F8FD9E70963AFC06B6B1D762CA67BC11B7B6DE7B&quot;</span>: <span class="string">&quot;/data/data/%s/.%d/classes.dex&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0DD14F092B4D300C12DD031B36&quot;</span>: <span class="string">&quot;libartbase.so&quot;</span>,</span><br><span class="line">    <span class="string">&quot;1E38C4F22868C0545D2E99F02A37C0&quot;</span>: <span class="string">&quot;/proc/self/maps&quot;</span>,</span><br><span class="line">    <span class="string">&quot;13B82D685939526D&quot;</span>: <span class="string">&quot;r&quot;</span>,</span><br><span class="line">    <span class="string">&quot;1544909711D1543C&quot;</span>: <span class="string">&quot;r--p&quot;</span>,</span><br><span class="line">    <span class="string">&quot;819725BF63FC17E9D7C420B063FC17E9D7C420E9&quot;</span>: <span class="string">&quot;%s %s %*s %*s %*s %s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;73D075BA7F3493A7&quot;</span>: <span class="string">&quot;r-xp&quot;</span>,</span><br><span class="line">    <span class="string">&quot;FBBB64F474AE5DAAC0BB69F5778342B1CD8A71&quot;</span>: <span class="string">&quot;__android_log_print&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2D5240FB92E17D7E&quot;</span>: <span class="string">&quot;mmap&quot;</span>,</span><br><span class="line">    <span class="string">&quot;503BC5F83F349C535021D2E83B35DC45542BC2B82F69D95043&quot;</span>: <span class="string">&quot;assets/baiduprotect%d.jar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0900049337019CFF&quot;</span>: <span class="string">&quot;mmap&quot;</span>,</span><br><span class="line">    <span class="string">&quot;D2290DB35DD3BB4E&quot;</span>: <span class="string">&quot;V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;678A1DB04AD649B6&quot;</span>: <span class="string">&quot;Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;01107FC0CAD110A2&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">    <span class="string">&quot;69BE796F507CE666&quot;</span>: <span class="string">&quot;C&quot;</span>,</span><br><span class="line">    <span class="string">&quot;900C48443A5C67C1&quot;</span>: <span class="string">&quot;S&quot;</span>,</span><br><span class="line">    <span class="string">&quot;552D54E3921DA596&quot;</span>: <span class="string">&quot;I&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5EF11AA0771CD9F4&quot;</span>: <span class="string">&quot;J&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7640876B378F2B6B&quot;</span>: <span class="string">&quot;F&quot;</span>,</span><br><span class="line">    <span class="string">&quot;02B1F3133EB607CE&quot;</span>: <span class="string">&quot;D&quot;</span>,</span><br><span class="line">    <span class="string">&quot;669B877B16770DB8&quot;</span>: <span class="string">&quot;L&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6A0EB69D4B47B331&quot;</span>: <span class="string">&quot;[F&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3AFC2D685939526D&quot;</span>: <span class="string">&quot;[D&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0D08CB863EBD35520046FF887EBD315D09&quot;</span>: <span class="string">&quot;java/lang/Boolean&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CE8573FB3FB053ADC3CB47E364B9&quot;</span>: <span class="string">&quot;java/lang/Byte&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6B9C7BAB5058F2C966D24EA21E46F2C475987F&quot;</span>: <span class="string">&quot;java/lang/Character&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2A5E57EABD8D1C10271072E3FD9309&quot;</span>: <span class="string">&quot;java/lang/Short&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0E0C1382186DFD9103422C8D4364FB9A16&quot;</span>: <span class="string">&quot;java/lang/Integer&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3A7CA0700551469937329A7E445A&quot;</span>: <span class="string">&quot;java/lang/Long&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CD6D38FB93D7C583C02308F6D3DAD0&quot;</span>: <span class="string">&quot;java/lang/Float&quot;</span>,</span><br><span class="line">    <span class="string">&quot;E1636A9B81F78255EC2D5895DBF98F5E&quot;</span>: <span class="string">&quot;java/lang/Double&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EE487BD272BFDA20E30642D137B6D83A&quot;</span>: <span class="string">&quot;java/lang/Object&quot;</span>,</span><br><span class="line">    <span class="string">&quot;01E373D93EE849B6&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6B4A5696CAD110A2&quot;</span>: <span class="string">&quot;(Z)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;16D717062442E666&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EB4E61123A5C67C1&quot;</span>: <span class="string">&quot;(B)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;20443A8AE623A596&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3CB233F6771CD9F4&quot;</span>: <span class="string">&quot;(C)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0C29E90243B12B6B&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6EE2DA453EB607CE&quot;</span>: <span class="string">&quot;(S)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;16F2E91262490DB8&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;4044880EB048636B&quot;</span>: <span class="string">&quot;(I)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5EF0BCD2778714D9&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;F022CC9AE33C3CF3&quot;</span>: <span class="string">&quot;(J)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;2E776DB6D2A8D9AC&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;78782B5CB2499D86&quot;</span>: <span class="string">&quot;(F)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;273DB606DB9175C6&quot;</span>: <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;5998883A61F747EE&quot;</span>: <span class="string">&quot;(D)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;1976D4B3FD404BD01A75CEBA&quot;</span>: <span class="string">&quot;booleanValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;BE691AF2D01141B6&quot;</span>: <span class="string">&quot;()Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7F5DC0DC161890C778&quot;</span>: <span class="string">&quot;byteValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;6B72E36626BCCD91&quot;</span>: <span class="string">&quot;()B&quot;</span>,</span><br><span class="line">    <span class="string">&quot;D646AAC957547BDDD0&quot;</span>: <span class="string">&quot;charValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;54D7B1C85038BC29&quot;</span>: <span class="string">&quot;()C&quot;</span>,</span><br><span class="line">    <span class="string">&quot;B7C9425E5E5C8908B1C4&quot;</span>: <span class="string">&quot;shortValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EF6BF25DB07877B4&quot;</span>: <span class="string">&quot;()S&quot;</span>,</span><br><span class="line">    <span class="string">&quot;78CCCD93805EE6B4&quot;</span>: <span class="string">&quot;intValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;961C43E6D91029FC&quot;</span>: <span class="string">&quot;()I&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7019D897BF07044B79&quot;</span>: <span class="string">&quot;longValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7E2CC9DD3732EDB6&quot;</span>: <span class="string">&quot;()J&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3BEBB95FBE0B99B528E2&quot;</span>: <span class="string">&quot;floatValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;74212FBAFAAEEB3C&quot;</span>: <span class="string">&quot;()F&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3BCFAD3A3DBB18ED33D5BD&quot;</span>: <span class="string">&quot;doubleValue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;967272A1AD3AB523&quot;</span>: <span class="string">&quot;()D&quot;</span>,</span><br><span class="line">    <span class="string">&quot;947C25A859BC35C3993200BD04B93ACA&quot;</span>: <span class="string">&quot;java/lang/String&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CB88B69A31086A3D&quot;</span>: <span class="string">&quot;intern&quot;</span>,</span><br><span class="line">    <span class="string">&quot;7E36DC0B6FA406673A7EFE062181133A3F71F75A&quot;</span>: <span class="string">&quot;()Ljava/lang/String;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;0406D0C873B03D581246C59479B831500346DC843E891C&quot;</span>: <span class="string">&quot;com/baidu/xshield/ac/XH&quot;</span>,</span><br><span class="line">    <span class="string">&quot;8CA864F474AE5DAAC0CB66F57EA857ADD0CB46F57EA857BBD0DF49F071AA53ECC8856BFD3F8F46B1CD8A62A15CB653B5C5CB69FB7EBB1D90D0966CF477E7698A8DB2&quot;</span>: <span class="string">&quot;(Landroid/content/Context;Ljava/lang/String;Ljava/lang/String;[I)V&quot;</span>,</span><br><span class="line">    <span class="string">&quot;689364BE7F3493A7&quot;</span>: <span class="string">&quot;init&quot;</span>,</span><br><span class="line">    <span class="string">&quot;503BC5F83F349C535021D2E83B35DC45542BC2B326&quot;</span>: <span class="string">&quot;assets/baiduprotect.m&quot;</span>,</span><br><span class="line">    <span class="string">&quot;44CB2D685939526D&quot;</span>: <span class="string">&quot;%s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;3E27F603C0CC1EC6&quot;</span>: <span class="string">&quot;%s.lock&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 函数列表（从 Frida 输出中提取涉及的函数地址）</span></span><br><span class="line">func_list = [</span><br><span class="line">    <span class="number">0x28C28</span>,  <span class="comment"># sub_28C28</span></span><br><span class="line">    <span class="number">0x2709C</span>,  <span class="comment"># sub_2709C</span></span><br><span class="line">    <span class="number">0x25E78</span>,  <span class="comment"># sub_25E78</span></span><br><span class="line">    <span class="number">0x25F24</span>,  <span class="comment"># sub_25F24</span></span><br><span class="line">    <span class="number">0x25FD0</span>,  <span class="comment"># sub_25FD0</span></span><br><span class="line">    <span class="number">0x2607C</span>,  <span class="comment"># sub_2607C</span></span><br><span class="line">    <span class="number">0x26128</span>,  <span class="comment"># sub_26128</span></span><br><span class="line">    <span class="number">0x261D4</span>,  <span class="comment"># sub_261D4</span></span><br><span class="line">    <span class="number">0x26280</span>,  <span class="comment"># sub_26280</span></span><br><span class="line">    <span class="number">0x2632C</span>,  <span class="comment"># sub_2632C</span></span><br><span class="line">    <span class="number">0x263D8</span>,  <span class="comment"># sub_263D8</span></span><br><span class="line">    <span class="number">0x26484</span>,  <span class="comment"># sub_26484</span></span><br><span class="line">    <span class="number">0x26BE8</span>,  <span class="comment"># sub_26BE8</span></span><br><span class="line">    <span class="number">0x28AD0</span>   <span class="comment"># sub_28AD0</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_string_addr</span>(<span class="params">search_str</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;查找字符串的地址&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> addr <span class="keyword">in</span> idautils.Strings():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">str</span>(addr) == search_str:</span><br><span class="line">            <span class="keyword">return</span> addr.ea</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resolve_func_addr</span>(<span class="params">func_entry</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;将函数名或地址转换为地址&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(func_entry, <span class="built_in">int</span>):</span><br><span class="line">        <span class="keyword">return</span> func_entry</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(func_entry, <span class="built_in">str</span>):</span><br><span class="line">        func_addr = idaapi.get_name_ea_simple(func_entry)</span><br><span class="line">        <span class="keyword">if</span> func_addr == idaapi.BADADDR:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Function not found: <span class="subst">&#123;func_entry&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> func_addr</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Invalid function entry: <span class="subst">&#123;func_entry&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_comments_to_strings</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;为 .rodata 中的字符串添加解密注释和重命名&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> encrypted, decrypted <span class="keyword">in</span> mappings.items():</span><br><span class="line">        str_addr = find_string_addr(encrypted)</span><br><span class="line">        <span class="keyword">if</span> str_addr:</span><br><span class="line">            idaapi.set_cmt(str_addr, <span class="string">f&quot;Decrypted: <span class="subst">&#123;decrypted&#125;</span>&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            <span class="comment"># 重命名字符串，替换特殊字符以符合命名规则</span></span><br><span class="line">            safe_name = <span class="string">f&quot;str_<span class="subst">&#123;decrypted.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;_&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;_&#x27;</span>).replace(<span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;_&#x27;</span>).replace(<span class="string">&#x27;)&#x27;</span>, <span class="string">&#x27;_&#x27;</span>).replace(<span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;_&#x27;</span>).replace(<span class="string">&#x27;[&#x27;</span>, <span class="string">&#x27;_&#x27;</span>).replace(<span class="string">&#x27;]&#x27;</span>, <span class="string">&#x27;_&#x27;</span>)&#125;</span>&quot;</span></span><br><span class="line">            idaapi.set_name(str_addr, safe_name, idaapi.SN_FORCE)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Added comment at 0x<span class="subst">&#123;str_addr:x&#125;</span>: <span class="subst">&#123;encrypted&#125;</span> -&gt; <span class="subst">&#123;decrypted&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;String not found in .rodata: <span class="subst">&#123;encrypted&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_comments_to_function</span>(<span class="params">func_addr</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;为指定函数添加注释，扫描加载字符串的指令&quot;&quot;&quot;</span></span><br><span class="line">    func = idaapi.get_func(func_addr)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> func:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Function at 0x<span class="subst">&#123;func_addr:x&#125;</span> not found or invalid&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加函数注释</span></span><br><span class="line">    func_name = idaapi.get_func_name(func_addr)</span><br><span class="line">    idaapi.set_func_cmt(func_addr, <span class="string">f&quot;Decrypts strings (e.g., <span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(<span class="string">f&#x27;<span class="subst">&#123;k&#125;</span>-&gt;<span class="subst">&#123;v&#125;</span>&#x27;</span> <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">list</span>(mappings.items())[:<span class="number">5</span>])&#125;</span>...)&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Processing function: <span class="subst">&#123;func_name&#125;</span> at 0x<span class="subst">&#123;func_addr:x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 扫描函数指令，查找加载字符串的指令</span></span><br><span class="line">    <span class="keyword">for</span> ea <span class="keyword">in</span> idautils.FuncItems(func.start_ea):</span><br><span class="line">        disasm = idaapi.generate_disasm_line(ea, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;LDR&quot;</span> <span class="keyword">in</span> disasm:  <span class="comment"># 检查加载指令</span></span><br><span class="line">            <span class="keyword">for</span> enc, dec <span class="keyword">in</span> mappings.items():</span><br><span class="line">                <span class="keyword">if</span> enc <span class="keyword">in</span> disasm:</span><br><span class="line">                    idaapi.set_cmt(ea, <span class="string">f&quot;Loads <span class="subst">&#123;enc&#125;</span> -&gt; <span class="subst">&#123;dec&#125;</span>&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;Added comment at 0x<span class="subst">&#123;ea:x&#125;</span>: <span class="subst">&#123;enc&#125;</span> -&gt; <span class="subst">&#123;dec&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主函数：处理字符串和函数列表&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 处理 .rodata 中的字符串</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Processing strings in .rodata...&quot;</span>)</span><br><span class="line">    add_comments_to_strings()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 处理函数列表</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nProcessing functions...&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> func_entry <span class="keyword">in</span> func_list:</span><br><span class="line">        func_addr = resolve_func_addr(func_entry)</span><br><span class="line">        <span class="keyword">if</span> func_addr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            add_comments_to_function(func_addr)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Skipping invalid function: <span class="subst">&#123;func_entry&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行脚本</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>效果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508133149140.png" alt="image-20250508133149140"></p>
<p>由于解密我在hook的脚本里，设置第一个参数是字符串，而在sub_b3b4中，有些解密函数的参数是字节码，因此还需要补充5个解密函数的hook。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 要 hook 的 so 文件名字</span></span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"><span class="comment">// so 文件的大小</span></span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 默认的目标函数偏移</span></span><br><span class="line"><span class="keyword">var</span> target_offset = <span class="number">0x88060</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要 hook 的字节码解密函数偏移列表</span></span><br><span class="line"><span class="keyword">var</span> bytecode_decrypt_offsets = [</span><br><span class="line">    <span class="number">0x267e0</span>, <span class="number">0x26A90</span>, <span class="number">0x27550</span>, <span class="number">0x27800</span>, <span class="number">0x28418</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook linker64 的 call_constructors，检测目标 so 文件加载</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                <span class="comment">// 第一时间 hook 目标函数</span></span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 目标函数（触发后续字节码解密函数的 hook）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(target_offset), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[target_func] onEnter, offset: 0x&quot;</span> + target_offset.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[target_func] onLeave, retval: &quot;</span> + retval);</span><br><span class="line">            <span class="comment">// 在目标函数退出时，hook 所有字节码解密函数</span></span><br><span class="line">            <span class="title function_">hook_bytecode_decrypt_funcs</span>(baseaddr);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 指定的字节码解密函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_bytecode_decrypt_funcs</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    bytecode_decrypt_offsets.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> func_name = <span class="string">&quot;sub_&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">toUpperCase</span>();</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(offset), &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> input_ptr = args[<span class="number">0</span>]; <span class="comment">// 捕获输入指针（指向字节数组）</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] Input pointer: &quot;</span> + input_ptr);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 读取以 0x00 结尾的字节数组</span></span><br><span class="line">                <span class="keyword">let</span> bytes = [];</span><br><span class="line">                <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> byte = <span class="title class_">Memory</span>.<span class="title function_">readU8</span>(input_ptr.<span class="title function_">add</span>(i));</span><br><span class="line">                    <span class="keyword">if</span> (byte === <span class="number">0x00</span>) <span class="keyword">break</span>; <span class="comment">// 遇到 0x00 停止</span></span><br><span class="line">                    bytes.<span class="title function_">push</span>(byte.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                    i++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] Input bytes: &quot;</span> + bytes.<span class="title function_">join</span>(<span class="string">&quot;, &quot;</span>));</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="comment">// 捕获返回值（解密后的字符串）</span></span><br><span class="line">                <span class="keyword">let</span> output_str = retval.<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] Output string: &quot;</span> + output_str);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主逻辑：启动 hook</span></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>看得出来，sub_b3b4负责解密字符串，因此改名成这个。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508133416118.png" alt="image-20250508133416118"></p>
<p>接下来看其它的函数，根据分析，当a2&#x3D;&#x3D;1时，只执行sub_B3B4。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130512877.png" alt="image-20250508130512877" style="zoom: 67%;" />

<p>回到JNI_OnLoad，继续分析sub_91E4。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508134058128.png" alt="image-20250508134058128" style="zoom:67%;" />

<p>可以看出来，在进行JNI动态注册，所以给它改了些函数名及变量名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508134858811.png" alt="image-20250508134858811"></p>
<p>回到JNI_OnLoad，我一直很好奇剩下的fread是什么东西？下图是别人对同样的so文件的分析，它这里伪代码是gettimeofday，那就很好理解了，在计算时间差，一般计算时间差是为了反调试，博主说这里只是收集信息。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/745332_UJ2HKKKE2VPQ7PW.png" alt="745332_UJ2HKKKE2VPQ7PW"></p>
<p>接下来可以分析第a2&#x3D;&#x3D;2的时候，会调用什么内容。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508140130462.png" alt="image-20250508140130462"></p>
<p>已知B3B4只当a2&#x3D;&#x3D;1时才调用，这里从3E29C开始分析。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130512877.png" alt="image-20250508130512877" style="zoom: 67%;" />

<p>直接分析3E36C。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508140313511.png" alt="image-20250508140313511" style="zoom:80%;" />

<p>再进入3E3F0。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508142124937.png" alt="image-20250508142124937" style="zoom: 67%;" />

<p>3E3F0这两个函数很奇怪，似乎是我dump出现了点bug？</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508142155835.png" alt="image-20250508142155835"></p>
<p>和博主dump下来的so不太一样呢。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508142103062.png" alt="image-20250508142103062"></p>
<p>用博主的图来讲函数3E3F0，大概是通过&#x2F;proc&#x2F;self&#x2F;maps获取进程虚拟机类型。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508142607362.png" alt="image-20250508142607362"></p>
<p>这样子分析下去有点难受，我重新dump了一个，还是这样子，难道是壳做了什么手脚？——保留疑惑。看了一下修复的soFixer，它github写着。——阿这。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508144748157.png" alt="image-20250508144748157"></p>
<p>之后换了一个so修复的程序，需要自己编译。</p>
<p>链接：<a target="_blank" rel="noopener" href="https://github.com/maiyao1988/elf-dump-fix">https://github.com/maiyao1988/elf-dump-fix</a></p>
<p>再次查看3e3f0，这回终于没问题了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508171016443.png" alt="image-20250508171016443" style="zoom:67%;" />

<p>继续看函数列表，发现当a2&#x3D;&#x3D;2时，只执行了3E29C。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130512877.png" alt="image-20250508130512877" style="zoom: 67%;" />

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此，libbaiduprotect.so加载完了，总结一下：</p>
<ol>
<li>在.init_array的sub_88060进行解密，对so里的一些关键函数进行恢复。</li>
<li>下述这些函数，统统在<strong>全局函数列表</strong>处进行注册添加，等待调用。</li>
</ol>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130512877.png" alt="image-20250508130512877" style="zoom: 67%;" />

<ol start="3">
<li><p>在JNI_OnLoad处。</p>
<p>sub_B3B4（a2&#x3D;&#x3D;1）解密了一些libc常用的函数地址，存在全局变量中。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508180536833.png" alt="image-20250508180536833" style="zoom:50%;" />

<p>sub_91E4处，进行JNI动态注册，注册了n001、n002、n003共3个JNI函数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508180647854.png" alt="image-20250508180647854"></p>
<p>sub_3E29C（a2&#x3D;&#x3D;2）执行了下面的内容，获取最大IO向量数量并获得虚拟机类型。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508191242049.png" alt="image-20250508191242049"></p>
</li>
</ol>
<h1 id="JNI函数分析（attachBaseContext-onCreate）"><a href="#JNI函数分析（attachBaseContext-onCreate）" class="headerlink" title="JNI函数分析（attachBaseContext&#x2F;onCreate）"></a>JNI函数分析（attachBaseContext&#x2F;onCreate）</h1><h2 id="n001"><a href="#n001" class="headerlink" title="n001"></a>n001</h2><p>Java层的n001，对应于sub_91E4注册的3个函数的第1个函数。</p>
<p>通过分析，得知n001属于类com.baidu.protect.A。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508192514683.png" alt="image-20250508192514683" style="zoom:67%;" />

<p>然后在com.baidu.protect.StubApplication类的attachBaseContext中进行调用。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508192627062.png" alt="image-20250508192627062"></p>
<p>接下来进入native层进行分析。</p>
<p>首先简单的改了一下名字和类型。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508194738777.png" alt="image-20250508194738777" style="zoom:67%;" />

<p>下图中，还原了一些函数名。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509141717335.png" alt="image-20250509141717335" style="zoom: 67%;" />

<p>先来分析sub_95B4。</p>
<p>下面两个图中，可以看到函数sub_968C的参数列表不一样。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509142032751.png" alt="image-20250509142032751" style="zoom: 67%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509142046768.png" alt="image-20250509142046768" style="zoom: 67%;" />

<p>在sub_95B4调用sub_968C的地方，进入汇编层分析。</p>
<p>可以看到，前sub_968C的前两个参数是sub_9584的前两个参数，而X2 &#x3D; X19 + X1 &#x3D; strlen(X1) + X1，因此，sub_968C的参数列表应该是3个参数，第3个参数是a2字符串的结束地址。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509142257558.png" alt="image-20250509142257558" style="zoom:67%;" />

<p>修改后是这样。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509142546267.png" alt="image-20250509142546267" style="zoom:80%;" />

<p>进入sub_968C进行分析，修改了一些变量名后，如下图所示。</p>
<p>它大致是一个管理缓冲区的函数，将字符串复制到目标缓冲区，并防止缓冲区溢出，重命名为buffer_manager。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509142702869.png" alt="image-20250509142702869"></p>
<p>回到n001的JNI函数，继续往下分析，尝试hook decrypt_str2，观察返回值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509163101547.png" alt="image-20250509163101547"></p>
<p>hook的脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 要 hook 的 so 文件名字</span></span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"><span class="comment">// so 文件的大小</span></span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 默认的目标函数偏移</span></span><br><span class="line"><span class="keyword">var</span> target_offset = <span class="number">0x88060</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要 hook 的字节码解密函数偏移列表</span></span><br><span class="line"><span class="keyword">var</span> bytecode_decrypt_offsets = [</span><br><span class="line">    <span class="number">0x95F4</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook linker64 的 call_constructors，检测目标 so 文件加载</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                <span class="comment">// 第一时间 hook 目标函数</span></span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 目标函数（触发后续字节码解密函数的 hook）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(target_offset), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[target_func] onEnter, offset: 0x&quot;</span> + target_offset.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[target_func] onLeave, retval: &quot;</span> + retval);</span><br><span class="line">            <span class="comment">// 在目标函数退出时，hook 所有字节码解密函数</span></span><br><span class="line">            <span class="title function_">hook_bytecode_decrypt_funcs</span>(baseaddr);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 指定的字节码解密函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_bytecode_decrypt_funcs</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    bytecode_decrypt_offsets.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> func_name = <span class="string">&quot;sub_&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">toUpperCase</span>();</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(offset), &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> input_ptr = args[<span class="number">0</span>]; <span class="comment">// 捕获输入指针（指向字节数组）</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] Input pointer: &quot;</span> + input_ptr);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 读取以 0x00 结尾的字节数组</span></span><br><span class="line">                <span class="keyword">let</span> bytes = [];</span><br><span class="line">                <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> byte = <span class="title class_">Memory</span>.<span class="title function_">readU8</span>(input_ptr.<span class="title function_">add</span>(i));</span><br><span class="line">                    <span class="keyword">if</span> (byte === <span class="number">0x00</span>) <span class="keyword">break</span>; <span class="comment">// 遇到 0x00 停止</span></span><br><span class="line">                    bytes.<span class="title function_">push</span>(byte.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                    i++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] Input bytes: &quot;</span> + bytes.<span class="title function_">join</span>(<span class="string">&quot;, &quot;</span>));</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="comment">// 捕获返回值（解密后的字符串）</span></span><br><span class="line">                <span class="keyword">let</span> output_str = retval.<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + func_name + <span class="string">&quot;] Output string: &quot;</span> + output_str);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主逻辑：启动 hook</span></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>打印的结果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509163338561.png" alt="image-20250509163338561"></p>
<p>打印了几个字符串，BCDB0[0]的值是BE660，因此可以确定，&#x2F;data&#x2F;user&#x2F;0&#x2F;com.example.test是我们要找的解密字符串。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509163951244.png" alt="image-20250509163951244" style="zoom:67%;" />

<p>之后又调用函数sub_95FC。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509170223847.png" alt="image-20250509170223847"></p>
<p>在这个函数中，创建了文件&#x2F;data&#x2F;user&#x2F;0&#x2F;com.example.test&#x2F;.bdlock，然后通过flock函数上锁（文件锁）。更名为open_and_lock。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509170400314.png" alt="image-20250509170400314"></p>
<p>之后再分析sub_781C，又有混淆，通过d810去一下混淆，又调用函数列表，这回调用a2&#x3D;&#x3D;3的情况。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509183928072.png" alt="image-20250509183928072" style="zoom:80%;" />

<p>观察函数列表的函数，先整理出有哪些函数当a2&#x3D;&#x3D;3的时候执行。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250508130512877.png" alt="image-20250508130512877" style="zoom: 67%;" />

<p>经过整理，会执行3E29C、40CF8（与java层传入的arg5有关）、3DFC4、11F5C、45964。</p>
<h3 id="sub-3E29C-a2-3"><a href="#sub-3E29C-a2-3" class="headerlink" title="sub_3E29C(a2&#x3D;&#x3D;3)"></a>sub_3E29C(a2&#x3D;&#x3D;3)</h3><p>先分析3E29C。</p>
<p>查看call_funcs_list，传入的参数为：a1是函数列表，a2是3，a3是env。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509191538468.png" alt="image-20250509191538468" style="zoom: 67%;" />

<p>进入sub_13880进行查看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509194725564.png" alt="image-20250509194725564"></p>
<p>解密了很多系统库中的函数名，通过JNI进行调用。</p>
<p>这一块代码有点怪，v29应该传入getPackageInfo的函数参数里的，可以从汇编看看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509194808323.png" alt="image-20250509194808323"></p>
<p>如下图所示，应该有5个参数。（arm64支持X0-X7传递参数）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509195624108.png" alt="image-20250509195624108"></p>
<p>但这里不能修改一下callxxxxx的函数签名，因为他是一个不定长的函数调用。但我们知道，a2是一个字符串（包名，稍微追踪一下，发现是在JNI_OnLoad赋值的，当时没改名字，现在苦苦分析）。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509200504526.png" alt="image-20250509200504526" style="zoom:80%;" />

<p>flags的值是0x40，代表返回PackageInfo的PackageInfo对象，包含签名信息。（如果不填0x40，返回的PackageInfo对象中的signatures字段将会是null）</p>
<p>继续分析，为他们修改注释和变量名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509204903121.png" alt="image-20250509204903121"></p>
<p>进入sub_3AE58，直接返回16字节，有点像md5的初始化常量。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509205051133.png" alt="image-20250509205051133"></p>
<p>借助大模型的力量，我成功识别了md5的相关函数，不过也说明了算法是我的薄弱点，得找时间好好看看。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509211428955.png" alt="image-20250509211428955" style="zoom:80%;" />

<p>分析完了，sub_13880的行为：根据签名数组的第0个签名生成md5，赋值给a3并返回。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250509212723680.png" alt="image-20250509212723680"></p>
<p>接着看sub_66064。</p>
<p>在sub_65E94中，会根据md5的值，在result地址+8的为止，根据md5，累积异或产生了16个新字节（假如记作buf1）。</p>
<p>在sub_64A50中，result将指向ptr_result+1的位置，也就是result &#x3D; buf1，然后在sub_64A50中，根据buf1的最后4个字节，又生成了160个字节，也就是说，result指向的字节数组大小为176。</p>
<p>因此，将sub_66064命名为md5_extend_176。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510094601966.png" alt="image-20250510094601966"></p>
<p>整理一下，sub_3E29C得到了一个md5和一个基于md5的176字节。</p>
<h3 id="sub-40cf8-a2-3"><a href="#sub-40cf8-a2-3" class="headerlink" title="sub_40cf8(a2&#x3D;&#x3D;3)"></a>sub_40cf8(a2&#x3D;&#x3D;3)</h3><p>继续看，下一个看40CF8——3E29C、40CF8（与java层传入的arg5有关）、3DFC4、11F5C、45964。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510095619450.png" alt="image-20250510095619450"></p>
<p>这里的BCE28，和n001传入的arg5有关。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510095704606.png" alt="image-20250510095704606"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510095818583.png" alt="image-20250510095818583"></p>
<p>为了确定这个值，尝试hook一下Java层的n001，脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_n001</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> clazz_A = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.baidu.protect.A&quot;</span>);</span><br><span class="line">        clazz_A.<span class="property">n001</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">arg0, arg1, arg2, arg3, arg4, arg5</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[arg0] &quot;</span>, arg0);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[arg1] &quot;</span>, arg1);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[arg2] &quot;</span>, arg2);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[arg3] &quot;</span>, arg3);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[arg4] &quot;</span>, arg4);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[arg5] &quot;</span>, arg5);</span><br><span class="line">            <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">n001</span>(arg0,arg1,arg2,arg3,arg4,arg5);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_n001);</span><br></pre></td></tr></table></figure>

<p>结果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510101348916.png" alt="image-20250510101348916"></p>
<p>从调用的地方可以猜到含义，分别代表着：包名、app名、apk路径、数据路径、sdk版本、是否报崩溃的错误。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510101848906.png" alt="image-20250510101848906"></p>
<p>回到40CF8，这回知道了off_BCE28的含义了，用来判断是否上报crash信息的，那40CF8的这段代码，应该是用来处理崩溃信息上传的？</p>
<p>在调用call_funcs_list这个函数中，调用函数列表每个函数的传参方式是：函数地址、a2、env、a4、a5、a6。（a3就是env）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510103253286.png" alt="image-20250510103253286"></p>
<p>因此，在40CF8中，sub_409E0和sub_40F38的传参就好懂了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510102611433.png" alt="image-20250510102611433" style="zoom: 67%;" />

<p>先进入409E0，修改a2的类型，看样子是注册了两个函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510103527181.png" alt="image-20250510103527181" style="zoom: 67%;" />

<p>交叉引用qword_BE808，找到它赋值的位置，发现它是一个之前的解密字符串，“com&#x2F;baidu&#x2F;protect&#x2F;CrashHandler”。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510105100608.png" alt="image-20250510105100608"></p>
<p>鉴于sub_7398、sub_409E0等函数还存在字符串未解密，这里先把它们的解密字符串收集起来，就不提供脚本了，脚本都大差不差。</p>
<p>回到409e0。</p>
<p>有些搞不明白这里的v10与v11的关系，v11按理来说应该是异常的回调函数，但这里的写法我确实没看懂。</p>
<p>总之，sub_409E0动态注册了com.baidu.protect.CrashHandler.a()和com.baidu.protect.CrashHandler.b(Ljava&#x2F;lang&#x2F;String)。</p>
<p>同时，注册了一个统一的自定义处理函数sub_40bd0，负责处理异常。</p>
<p>综上所述，直接将这个函数改名成处理异常。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510120359482.png" alt="image-20250510120359482"></p>
<p>回到40cf8，这个函数在a2&#x3D;&#x3D;3时，做了下面的操作，接着看下一个函数列表的函数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510140228861.png" alt="image-20250510140228861"></p>
<h3 id="sub-3DFC4-a2-3"><a href="#sub-3DFC4-a2-3" class="headerlink" title="sub_3DFC4(a2&#x3D;&#x3D;3)"></a>sub_3DFC4(a2&#x3D;&#x3D;3)</h3><p>该看3DFC4了——3E29C、40CF8（与java层传入的arg5有关）、3DFC4、11F5C、45964。</p>
<p>先将a3的类型改为JNIEnv*，然后尝试阅读一下代码。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510143523604.png" alt="image-20250510143523604"></p>
<p>这一个函数的难度，比我想象中难很多啊，博客说，3D6AC是3DFC4的关键函数…点进去一看，不知道3D6AC在做什么，ptr_buf的大小是0x13E80，不妨hook sub_3d6ac，观察结束后，ptr_buf的内容是多少。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510143621535.png" alt="image-20250510143621535"></p>
<p>脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Frida脚本：hexdump sub_3D6AC的第一个参数ptr_buf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 请将 &quot;libyourtarget.so&quot; 替换为目标SO文件的实际名称</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">TARGET_MODULE_NAME</span> = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 这是 sub_3D6AC 函数在SO文件中的偏移地址</span></span><br><span class="line"><span class="comment">//    如果 &quot;sub_3D6AC&quot; 是一个导出的函数名，你可以尝试使用 Module.findExportByName()</span></span><br><span class="line"><span class="comment">//    但通常这种 &quot;sub_XXXXX&quot; 格式的名称是IDA反编译后基于地址命名的，所以使用偏移量更可靠。</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FUNCTION_OFFSET</span> = <span class="number">0x3D6AC</span>; <span class="comment">// 函数 sub_3D6AC 的偏移地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ptr_buf 指向的内存区域大小</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">BUFFER_SIZE</span> = <span class="number">0x13e80</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (可选) 你想在hexdump中实际打印的最大字节数，以防BUFFER_SIZE过大导致控制台输出混乱</span></span><br><span class="line"><span class="comment">// 如果你想打印全部内容，可以将MAX_DUMP_SIZE设置为BUFFER_SIZE</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MAX_DUMP_SIZE</span> = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable constant_">BUFFER_SIZE</span>); <span class="comment">// 例如，最多打印1024字节</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获得linker64的地址</span></span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>;    <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="comment">// 判断是否可以通过findModuleByName查找到目标so文件</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="variable constant_">TARGET_MODULE_NAME</span>);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 第一时间hook</span></span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(<span class="number">0x88060</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="comment">// 第一个函数解密完后，才能hook sub_28c28</span></span><br><span class="line">            <span class="title function_">main</span>(baseaddr);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params">base</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> moduleBase = base;</span><br><span class="line">    <span class="keyword">if</span> (!moduleBase) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] 模块 &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot; 未找到。请确保模块名正确且已加载。&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> targetFunctionAddr = moduleBase.<span class="title function_">add</span>(<span class="variable constant_">FUNCTION_OFFSET</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] 目标函数 sub_3D6AC 地址: &quot;</span> + targetFunctionAddr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] ptr_buf 大小: 0x&quot;</span> + <span class="variable constant_">BUFFER_SIZE</span>.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; (&quot;</span> + <span class="variable constant_">BUFFER_SIZE</span> + <span class="string">&quot; bytes)&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] hexdump 将显示最多: 0x&quot;</span> + <span class="variable constant_">MAX_DUMP_SIZE</span>.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; (&quot;</span> + <span class="variable constant_">MAX_DUMP_SIZE</span> + <span class="string">&quot; bytes)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(targetFunctionAddr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="comment">// args[0] 是第一个参数 (__int64 a1, 即 ptr_buf)</span></span><br><span class="line">            <span class="comment">// args[1] 是第二个参数 (JNIEnv *env)</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ptr_buf</span> = args[<span class="number">0</span>]; <span class="comment">// 保存 ptr_buf 的指针以在 onLeave 中使用</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">jniEnv</span> = args[<span class="number">1</span>];  <span class="comment">// 保存 JNIEnv 指针</span></span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n[*] 进入 sub_3D6AC:&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    ptr_buf (a1): &quot;</span> + <span class="variable language_">this</span>.<span class="property">ptr_buf</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    JNIEnv* (a2): &quot;</span> + <span class="variable language_">this</span>.<span class="property">jniEnv</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] 离开 sub_3D6AC. 返回值: &quot;</span> + retval);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">ptr_buf</span> &amp;&amp; !<span class="variable language_">this</span>.<span class="property">ptr_buf</span>.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] ptr_buf (&quot;</span> + <span class="variable language_">this</span>.<span class="property">ptr_buf</span> + <span class="string">&quot;) 内容 (前 &quot;</span> + <span class="variable constant_">MAX_DUMP_SIZE</span> + <span class="string">&quot; 字节):&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// Memory.readByteArray(pointer, length) 返回一个 ArrayBuffer</span></span><br><span class="line">                    <span class="keyword">const</span> bufferContent = <span class="title class_">Memory</span>.<span class="title function_">readByteArray</span>(<span class="variable language_">this</span>.<span class="property">ptr_buf</span>, <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable constant_">BUFFER_SIZE</span>, <span class="variable constant_">MAX_DUMP_SIZE</span>));</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(bufferContent, &#123;</span><br><span class="line">                        <span class="attr">offset</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="attr">length</span>: <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable constant_">BUFFER_SIZE</span>, <span class="variable constant_">MAX_DUMP_SIZE</span>), <span class="comment">// 确保hexdump长度与读取长度一致</span></span><br><span class="line">                        <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">                        <span class="attr">ansi</span>: <span class="literal">true</span> <span class="comment">// 如果你的控制台支持，可以开启颜色高亮</span></span><br><span class="line">                    &#125;));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 如果你想保存整个缓冲区到文件（这部分比较复杂，通常建议在PC端Python脚本中处理）</span></span><br><span class="line">                    <span class="comment">// 你可以在这里发送 bufferContent (或者 this.ptr_buf 和 BUFFER_SIZE) 到你的Python脚本</span></span><br><span class="line">                    <span class="comment">// 例如: send(&#123; ptr: this.ptr_buf.toString(), size: BUFFER_SIZE &#125;);</span></span><br><span class="line">                    <span class="comment">// 然后在Python端接收并保存：</span></span><br><span class="line">                    <span class="comment">// def on_message(message, data):</span></span><br><span class="line">                    <span class="comment">//     if message[&#x27;type&#x27;] == &#x27;send&#x27;:</span></span><br><span class="line">                    <span class="comment">//         payload = message[&#x27;payload&#x27;]</span></span><br><span class="line">                    <span class="comment">//         ptr = int(payload[&#x27;ptr&#x27;], 16)</span></span><br><span class="line">                    <span class="comment">//         size = payload[&#x27;size&#x27;]</span></span><br><span class="line">                    <span class="comment">//         print(f&quot;Receiving buffer from &#123;hex(ptr)&#125; with size &#123;size&#125;&quot;)</span></span><br><span class="line">                    <span class="comment">//         buffer_data = process.read_bytes(ptr, size)</span></span><br><span class="line">                    <span class="comment">//         with open(f&quot;ptr_buf_dump_&#123;hex(ptr)&#125;.bin&quot;, &quot;wb&quot;) as f_out:</span></span><br><span class="line">                    <span class="comment">//             f_out.write(buffer_data)</span></span><br><span class="line">                    <span class="comment">//         print(f&quot;Buffer dumped to ptr_buf_dump_&#123;hex(ptr)&#125;.bin&quot;)</span></span><br><span class="line">                    <span class="comment">// script.on(&#x27;message&#x27;, on_message)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] 读取或hexdump ptr_buf 时发生错误: &quot;</span> + e);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;    错误详情: &quot;</span> + e.<span class="property">stack</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] ptr_buf 在 onLeave 时为 null 或无效。&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;--- 结束 sub_3D6AC 打印 ---&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 确保在Java环境准备好后执行main函数，尤其是在attach模式下早期hook时</span></span><br><span class="line"><span class="comment">// 对于 Android SO 文件中的函数，通常直接调用 main() 即可，</span></span><br><span class="line"><span class="comment">// 或者使用 setImmediate(main) 来确保主循环已准备好</span></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br><span class="line"><span class="comment">// 或者对于某些情况，特别是应用启动非常早期的hook，可能需要等待Java VM加载完毕</span></span><br><span class="line"><span class="comment">// Java.perform(function() &#123;</span></span><br><span class="line"><span class="comment">//     console.log(&quot;[+] Java VM 已加载，开始执行 main()&quot;);</span></span><br><span class="line"><span class="comment">//     main();</span></span><br><span class="line"><span class="comment">// &#125;);</span></span><br></pre></td></tr></table></figure>

<p>打印的结果如下图所示，文件还挺大的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510174628687.png" alt="image-20250510174628687"></p>
<p>回到3DFC4，验证一下我们之前的分析，第0x721个元素存放了目录路径的个数。0x721 x 4 &#x3D; 0x1C84，因此到0x1C84去读取个数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510174732047.png" alt="image-20250510174732047"></p>
<p>读4个字节，02 00 00 00，即为2。因此会创建2个文件夹，再来到第0x744个元素（也就是0x744 x 4 &#x3D; 0x1D10），去读取目录字符串。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510174841862.png" alt="image-20250510174841862"></p>
<p>也就是说，第一个目录字符串的地址存放再0x7969adfcc0处，下一个地址则是0x7969adfd20。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250510175058363.png" alt="image-20250510175058363"></p>
<p>要获取这2个字符串，即去读取ptr_buf + 0x1D10和ptr_buf + 0x1D40，修改一下脚本。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">TARGET_MODULE_NAME</span> = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FUNCTION_OFFSET</span> = <span class="number">0x3D6AC</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">BUFFER_SIZE</span> = <span class="number">0x13e80</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MAX_DUMP_SIZE</span> = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable constant_">BUFFER_SIZE</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="variable constant_">TARGET_MODULE_NAME</span>);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(<span class="number">0x88060</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;&#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="title function_">main</span>(baseaddr);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params">base</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> moduleBase = base;</span><br><span class="line">    <span class="keyword">if</span> (!moduleBase) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] 模块 &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot; 未找到。请确保模块名正确且已加载。&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> targetFunctionAddr = moduleBase.<span class="title function_">add</span>(<span class="variable constant_">FUNCTION_OFFSET</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] 目标函数 sub_3D6AC 地址: &quot;</span> + targetFunctionAddr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] ptr_buf 大小: 0x&quot;</span> + <span class="variable constant_">BUFFER_SIZE</span>.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; (&quot;</span> + <span class="variable constant_">BUFFER_SIZE</span> + <span class="string">&quot; bytes)&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] hexdump 将显示最多: 0x&quot;</span> + <span class="variable constant_">MAX_DUMP_SIZE</span>.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; (&quot;</span> + <span class="variable constant_">MAX_DUMP_SIZE</span> + <span class="string">&quot; bytes)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(targetFunctionAddr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ptr_buf</span> = args[<span class="number">0</span>]; <span class="comment">// 保存 ptr_buf 的指针</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">jniEnv</span> = args[<span class="number">1</span>];  <span class="comment">// 保存 JNIEnv 指针</span></span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n[*] 进入 sub_3D6AC:&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    ptr_buf (a1): &quot;</span> + <span class="variable language_">this</span>.<span class="property">ptr_buf</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    JNIEnv* (a2): &quot;</span> + <span class="variable language_">this</span>.<span class="property">jniEnv</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] 离开 sub_3D6AC. 返回值: &quot;</span> + retval);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">ptr_buf</span> &amp;&amp; !<span class="variable language_">this</span>.<span class="property">ptr_buf</span>.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] ptr_buf (&quot;</span> + <span class="variable language_">this</span>.<span class="property">ptr_buf</span> + <span class="string">&quot;) 内容:&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 读取目录个数 (ptr_buf[0x721])</span></span><br><span class="line">                    <span class="keyword">const</span> dirCount = <span class="variable language_">this</span>.<span class="property">ptr_buf</span>.<span class="title function_">add</span>(<span class="number">0x721</span> * <span class="number">4</span>).<span class="title function_">readU32</span>();</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] 目录个数 (ptr_buf[0x721]): &quot;</span> + dirCount);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 从 0x744 开始遍历目录结构</span></span><br><span class="line">                    <span class="keyword">let</span> dirOffset = <span class="number">0x744</span> * <span class="number">4</span>; <span class="comment">// 字节偏移</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dirCount; i++) &#123;</span><br><span class="line">                        <span class="keyword">const</span> dirEntry = <span class="variable language_">this</span>.<span class="property">ptr_buf</span>.<span class="title function_">add</span>(dirOffset);</span><br><span class="line">                        <span class="keyword">const</span> dirPathPtr = dirEntry.<span class="title function_">readPointer</span>(); <span class="comment">// 读取目录路径指针</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">const</span> dirPath = dirPathPtr.<span class="title function_">readCString</span>();</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[Dir <span class="subst">$&#123;i&#125;</span>] <span class="subst">$&#123;dirPathPtr&#125;</span>: <span class="subst">$&#123;dirPath&#125;</span>`</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[Dir <span class="subst">$&#123;i&#125;</span>] <span class="subst">$&#123;dirPathPtr&#125;</span>: (无法读取字符串: <span class="subst">$&#123;e&#125;</span>)`</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        dirOffset += <span class="number">48</span>; <span class="comment">// 每个目录结构 48 字节</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 可选：打印整个缓冲区 (注释掉，避免输出过多)</span></span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    const bufferContent = Memory.readByteArray(this.ptr_buf, Math.min(BUFFER_SIZE, MAX_DUMP_SIZE));</span></span><br><span class="line"><span class="comment">                    console.log(hexdump(bufferContent, Math.min(BUFFER_SIZE, MAX_DUMP_SIZE)));</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] 读取 ptr_buf 时发生错误: &quot;</span> + e);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;    错误详情: &quot;</span> + e.<span class="property">stack</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] ptr_buf 在 onLeave 时为 null 或无效。&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;--- 结束 sub_3D6AC 打印 ---&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>打印的结果如下图所示，创建了2个目录。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511140930719.png" alt="image-20250511140930719"></p>
<p>至于sub_3DFC4d剩下的内容就不分析了，因为sdk版本之前打印好像是32。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511141315957.png" alt="image-20250511141315957"></p>
<h3 id="sub-11F5C-a2-3"><a href="#sub-11F5C-a2-3" class="headerlink" title="sub_11F5C(a2&#x3D;&#x3D;3)"></a>sub_11F5C(a2&#x3D;&#x3D;3)</h3><p>接着看11F5C。——3E29C、40CF8（与java层传入的arg5有关）、3DFC4、11F5C、45964。</p>
<p>直接调用sub_BC60。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511141842306.png" alt="image-20250511141842306" style="zoom:67%;" />

<p>在sub_BC60中，根据sdk版本，执行不同的代码块，我记得之前打印过，sdk_version是32，因此这里只关注需要执行的函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511143526110.png" alt="image-20250511143526110" style="zoom:50%;" />

<p>来看看sub_188AC，用d810去一下混淆。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511143722434.png" alt="image-20250511143722434" style="zoom: 50%;" />

<p>hook这些字符串，打印看看什么含义，似乎没打印出来，说明没执行到。v0是一个指针，存储着BCEB8。我猜测，这里是在根据sdk，选择对应的so。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511145520335.png" alt="image-20250511145520335" style="zoom: 67%;" />

<p>我知道libart.so，但libartbase.so是什么呢？</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511150550133.png" alt="image-20250511150550133" style="zoom: 67%;" />

<p>接着看sub_4029c，进行一定分析，修改变量名，写注释，如下图所示。</p>
<p>看上去，sub_4029C是一个处理内存映射的函数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511152105188.png" alt="image-20250511152105188"></p>
<p>整理一下：</p>
<ol>
<li><strong>读取 &#x2F;proc&#x2F;self&#x2F;maps</strong>：</li>
</ol>
<ul>
<li>打开 &#x2F;proc&#x2F;self&#x2F;maps 文件，获取当前进程的内存映射信息。</li>
</ul>
<ol start="2">
<li><strong>查找目标模块（str）</strong>：</li>
</ol>
<ul>
<li>在内存映射中查找包含 str（例如 “libartbase.so”）的条目。</li>
</ul>
<ol start="3">
<li><strong>修改内存权限</strong>：</li>
</ol>
<ul>
<li>对于目标模块的内存段，修改其权限（mprotect）：<ul>
<li>如果段权限是 r–p（只读），改为 r-x（可读可执行）。</li>
<li>如果段权限是 r-xp（可读可执行），改为 rwx（可读可写可执行）。</li>
</ul>
</li>
</ul>
<ol start="4">
<li><strong>存储基地址</strong>：</li>
</ol>
<ul>
<li>将目标模块的基地址存储到 a1 中。</li>
</ul>
<p>回到sub_188AC，继续分析，将sub_4029C改名成get_so_baseaddr_AND_change_flags。</p>
<p>我之前hook过sub_25E78，但这里似乎并没有对6A6DC5A……进行解密，大概率是没执行，这里分析else分支，继续分析sub_3FF9C。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511153622384.png" alt="image-20250511153622384"></p>
<p>baseaddr是libartbase.so的基址，这里看上去是在解析ELF文件。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511154637350.png" alt="image-20250511154637350" style="zoom:67%;" />

<p>随便打开一个普通的so文件看看，寻找第0x38个字节和0x20个字节的含义。——先取指针，后进行运算，所以这里用0x38*8。</p>
<p>第0x38字节的含义：e_phnum_NUMBER_OF_PROGRAM_HEADER_ENTRIES，代表PHT的个数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511160146292.png" alt="image-20250511160146292"></p>
<p>第0x20字节的含义：e_phoff_PROGRAM_HEADER_OFFSET_IN_FILE，代表PHT在文件中的偏移量。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511160307043.png" alt="image-20250511160307043"></p>
<p>除此之外，还有访问pht + 16位置的代码段…这里就不贴图了，直接修改变量名。</p>
<p>这个函数手动解析了ELF动态信息，这种方式可以绕过一些针对标准<code>dlsym</code>的Hook，或者在某些特殊环境中加载和解析符号。</p>
<p>那么，sub_3FF9C看似是在解析动态链接库，并找到对应的符号。——当然不是这样，继续往下看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511164204307.png" alt="image-20250511164204307"></p>
<p>可以注意到，函数3FAE0和3F924出现在了switch-case结构中，这里简单介绍这俩函数的作用。</p>
<p>函数sub_3FAE0负责处理<strong>标准的ELF重定位表</strong>（如 <code>.rela.dyn</code> 用于数据重定位，<code>.rela.plt</code> 用于过程链接表PLT的函数调用重定位）。它查找对目标符号的引用，并将这些引用重定向到a3（调用时提供的“空函数”地址，伏笔）。</p>
<p>函数sub_3FAE0负责处理一个<strong>自定义的、以”APS2”开头的特殊数据结构</strong>。这个结构中也包含了对某些符号的引用信息（可能是为了处理更复杂的场景，如与符号版本控制相关的重定位，或者是一些内部模块间的链接）。它同样查找对目标符号的引用，并将这些引用重定向到提供的“空函数”地址。</p>
<p>这里的空函数，指的是sub_1B044，这是一个空函数，点进去只有一个return。（这里的redirect_func_to_a3是sub_3FF9C，被我改名了）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511191508810.png" alt="image-20250511191508810"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511191528201.png" alt="image-20250511191528201" style="zoom:67%;" />

<p>在sub_188AC中，除了将__android_log_print进行hook，重定位到一个空函数，还将mmap进行了hook，重定位到了sub_1B070，博主说，这里在加载Dex的时候有用。那就待会再来看sub_1B070吧。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511191747476.png" alt="image-20250511191747476"></p>
<p>回到sub_BC60，总结一下sub_188AC，它将__android_log_print和mmap进行了hook。</p>
<p>因为我们的sdk是32，再继续分析sub_11AB0。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511193723418.png" alt="image-20250511193723418" style="zoom: 67%;" />

<p>还有好多未解密的字符串，写个脚本打印一下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511193921095.png" alt="image-20250511193921095" style="zoom: 67%;" />

<p>打印的结果如下，涉及动态加载。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511201719617.png" alt="image-20250511201719617"></p>
<p>有个很奇怪的现象，可能是我没分析到？当把未解密的so文件放入ida中，跳转到11ab0，是可以看到循环的（和博客一致）。而解密后的so文件在查看时，没有for循环，不知道是什么导致的。麻了，因为这个so文件我没添加注释，没改变量名，有些东西乍一看看不出来。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511203419140.png" alt="image-20250511203419140" style="zoom:80%;" />

<p>直接拿博客的图来用一下吧，好糊。</p>
<p>简单说一下思路，将jar文件转换成dex文件，然后通过InMemoryDexClassLoader进行加载，然后将两个加载器的Element数组合并，重新设置成原加载器的Element数组（为了之后加载的类，可以被原始类加载器加载，热更新），随后将Dex文件的信息，在baidu设置的0x13E80个字节的缓冲区里进行更新——也不知道更新什么东西？费这么大信息，hook上mmap函数，最后只是为了拿到mmap分配的地址，给到函数update_dex_info_to_baidu_struct。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511211536106.png" alt="image-20250511211536106" style="zoom:80%;" />

<p>回到sub_bc60，再次总结一下，在hook mmap之后，会加载jar文件（目标dex文件），然后去除mmap的hook。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511213147216.png" alt="image-20250511213147216" style="zoom:80%;" />

<p>至此，sub_bc60分析完了——我没特意分析具体是如何解密出dex文件的，感觉很复杂——之前的签名扩展的176字节，会被用来当密钥，也就是说，如果这个apk被修改后重新签名，是无法打开的，因为Dex文件解不开。</p>
<p>要想得到这个Dex文件，可以通过hook sub_3BA90，在onLeave时dump第3个参数，而dump的大小是第4个参数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511213343307.png" alt="image-20250511213343307" style="zoom:80%;" />

<h3 id="sub-45964-a2-3"><a href="#sub-45964-a2-3" class="headerlink" title="sub_45964(a2&#x3D;&#x3D;3)"></a>sub_45964(a2&#x3D;&#x3D;3)</h3><p>最后，分析sub_45964。——3E29C、40CF8（与java层传入的arg5有关）、3DFC4、11F5C、45964。</p>
<p>做了一下简单的分析。</p>
<p>在RegisterNative_10item的函数中，注册了10个JNI函数，10个JNI函数全部注册到了1个Native地址上。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511215230452.png" alt="image-20250511215230452"></p>
<p>10个函数全部注册到1个地址，说明是vmp。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511215317797.png" alt="image-20250511215317797"></p>
<p>下图来自未解密的so文件，又有do-while没被检测出来。在函数sub_42D8C中，会对每个Dex文件去解析附加数据3。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511222646400.png" alt="image-20250511222646400"></p>
<p>下图是每个Jar文件的内容。sub_42D8C负责处理其中的附加数据3。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511222818162.png" alt="image-20250511222818162"></p>
<p>这里直接引用博主的分析，如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511223003506.png" alt="image-20250511223003506"></p>
<p>如何分析出来的呢？过几天来看看。</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>至此，n001分析完了，总结一下。</p>
<p>sub_3E29C取出了签名数组，取了数组的第0个元素，通过md5得到了16个字节，再把这16字节扩展成了176字节。</p>
<p>sub_40cf8注册的函数异常处理有关，大致是负责异常处理。</p>
<p>sub_3DFC4创建了两个目录，分别是&#x2F;data&#x2F;user&#x2F;0&#x2F;com.example.test&#x2F;.1和&#x2F;data&#x2F;user&#x2F;0&#x2F;com.example.test&#x2F;.2，这两个目录应该是与dex、jar相关，为sub_11f5c服务的。——我发现了一些字符串，&#x2F;data&#x2F;data&#x2F;包名&#x2F; &#x3D;&#x3D; &#x2F;data&#x2F;user&#x2F;0&#x2F;包名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250511221807574.png" alt="image-20250511221807574"></p>
<p>sub_11f5C hook了两个函数，一个是__android_log_print，一个是mmap，然后解密加载了业务dex文件（需要用到sub_3E29C签名扩展的176字节进行解密），加载完后，删除了mmap的hook。</p>
<p>sub_4596c注册了10个JNI函数，解析了vmp的方法数组和指令替换表。</p>
<h2 id="n002"><a href="#n002" class="headerlink" title="n002"></a>n002</h2><p>n002函数是在onCreate函数中调用的，也是启动app的流程必经的函数之一。</p>
<p>在n002中，又是调用函数列表上的函数，这回的a2&#x3D;&#x3D;4。</p>
<p>通过分析，会有sub_ 40CF8、sub_ 3E96C、sub_ 42388这3个函数执行。</p>
<p>sub_ 40CF8调用CrashHandler.asynRun方法，向<a target="_blank" rel="noopener" href="https://apkprotect.baidu.com/apklog%E5%8F%91%E9%80%81%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF%E3%80%82">https://apkprotect.baidu.com/apklog发送统计信息。</a></p>
<p>sub_ 3E96C assets&#x2F;baiduprotect.m检查dex的完整性，该文件中存有加密的dex MD5，如果修改dex进行重新签名，会导致app打不开。——应该还有对调试器的检测，因为使用frida和IDA的时候会异常退出。</p>
<p>sub_ 42388注册com.baidu.xshield.jni.Asc和com.baidu.xshield.utility.KeyUtil的本地函数，调用com.baidu.xshield.ac.XH.init方法。</p>
<p>至此，app启动流程涉及到的n001和n002分析完了。</p>
<h1 id="vmp分析"><a href="#vmp分析" class="headerlink" title="vmp分析"></a>vmp分析</h1><p>先把dex dump下来，下面是脚本，hook sub_3BA90，在onLeave时进行dump。</p>
<p>脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">TARGET_MODULE_NAME</span> = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="variable constant_">TARGET_MODULE_NAME</span>);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(<span class="number">0x88060</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;&#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="comment">// hook sub_3BA90</span></span><br><span class="line">            <span class="title function_">hook_3BA90</span>(baseaddr);</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_3BA90</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseaddr.<span class="title function_">add</span>(<span class="number">0x3BA90</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="comment">// 保存指针地址</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">dexPtr</span> = args[<span class="number">2</span>]; <span class="comment">// &amp;dex_ 的地址</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">sizePtr</span> = args[<span class="number">3</span>]; <span class="comment">// &amp;v6 的地址</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] sub_3BA90 - dexPtr:&quot;</span>, <span class="variable language_">this</span>.<span class="property">dexPtr</span>, <span class="string">&quot;sizePtr:&quot;</span>, <span class="variable language_">this</span>.<span class="property">sizePtr</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Call stack:\n&quot;</span>, <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">ACCURATE</span>).<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&quot;\n&quot;</span>));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 读取 dex_ 和 v6 的值</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">ptr</span> = <span class="variable language_">this</span>.<span class="property">dexPtr</span>.<span class="title function_">readPointer</span>(); <span class="comment">// *dexPtr, 即 dex_ 的值</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">size</span> = <span class="variable language_">this</span>.<span class="property">sizePtr</span>.<span class="title function_">readU64</span>().<span class="title function_">toNumber</span>(); <span class="comment">// *sizePtr, 即 v6 的值</span></span><br><span class="line"></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] DEX dump - ptr:&quot;</span>, <span class="variable language_">this</span>.<span class="property">ptr</span>, <span class="string">&quot;size:&quot;</span>, <span class="variable language_">this</span>.<span class="property">size</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">ptr</span> &amp;&amp; !<span class="variable language_">this</span>.<span class="property">ptr</span>.<span class="title function_">isNull</span>() &amp;&amp; <span class="variable language_">this</span>.<span class="property">size</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">size</span> &lt; <span class="number">0x10000000</span>) &#123; <span class="comment">// 限制最大 256MB</span></span><br><span class="line">                    <span class="comment">// 修改内存权限</span></span><br><span class="line">                    <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="variable language_">this</span>.<span class="property">ptr</span>, <span class="variable language_">this</span>.<span class="property">size</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] 内存权限已修改为 rwx&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 读取 DEX 文件内容</span></span><br><span class="line">                    <span class="keyword">const</span> dexData = <span class="title class_">Memory</span>.<span class="title function_">readByteArray</span>(<span class="variable language_">this</span>.<span class="property">ptr</span>, <span class="variable language_">this</span>.<span class="property">size</span>);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] 成功读取 DEX 数据&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 生成唯一的文件名</span></span><br><span class="line">                    <span class="keyword">const</span> filename = <span class="string">`/data/data/com.example.test/dex_dump_<span class="subst">$&#123;<span class="variable language_">this</span>.ptr.toString(<span class="number">16</span>)&#125;</span>_<span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span>.dex`</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 写入文件</span></span><br><span class="line">                    <span class="keyword">const</span> file = <span class="keyword">new</span> <span class="title class_">File</span>(filename, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (file) &#123;</span><br><span class="line">                        file.<span class="title function_">write</span>(dexData);</span><br><span class="line">                        file.<span class="title function_">flush</span>();</span><br><span class="line">                        file.<span class="title function_">close</span>();</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] DEX 文件成功保存到:&quot;</span>, filename);</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] 无法打开文件:&quot;</span>, filename);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] 无效的 ptr 或 size:&quot;</span>, <span class="variable language_">this</span>.<span class="property">ptr</span>, <span class="variable language_">this</span>.<span class="property">size</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>打印的结果如下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512102740207.png" alt="image-20250512102740207" style="zoom:80%;" />

<p>这里图方便，分析onCreate函数（vmp化），需要判断它在哪个dex文件里。</p>
<p>通过这个指令：<strong>grep -r “MainActivity” .&#x2F;dex_dump</strong> 可以找到。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512103001280.png" alt="image-20250512103001280"></p>
<p>算了，直接将2个dex都pull出来，丢进行jadx里看看。</p>
<p>成功找到了类MainActivity，onCreate明显被vmp动过。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512103150789.png" alt="image-20250512103150789" style="zoom:80%;" />

<p>-1426063360即为0xAB00 0000。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512103506171.png" alt="image-20250512103506171" style="zoom:67%;" />

<p>来到之前注册V的函数的地方，函数列表很怪，按理来说，应该有5个参数，前2个是JNIEnv和jclass，然后是A.V传的3个参数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512105550561.png" alt="image-20250512105550561"></p>
<p>把签名改成我期待的样子。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512105617334.png" alt="image-20250512105617334"></p>
<p>再看这个sub_4A458，很不正常，连传了3个BYTE(a3)，还是看汇编吧。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512124624278.png" alt="image-20250512124624278"></p>
<p>通过汇编的还原，调用的参数列表应该是这样子的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512124116293.png" alt="image-20250512124116293" style="zoom:80%;" />

<p>接下来，进入sub_4a458。看一眼就累了，很多函数的参数都是瞎传递的，ida没正确识别。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512131633429.png" alt="image-20250512131633429"></p>
<p>试试用ida的trace，由于vmp这一块代码是加密的，要等到解密后才方便下断点。因此，还是使用frida进行trace吧。</p>
<p>但是frida trace受挫了，似乎有反调？我之前尝试使用jnitrace也是执行到特定时候就会退出。</p>
<p>之后尝试绕过。——hook pthread_create的线程函数，置为空，然后重新使用hook_libart.js来查看调用的JNI函数，看看会不会退出。</p>
<p>好消息，成功了，脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> offset = <span class="number">0x88060</span>;</span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> base_addr = <span class="literal">null</span>; <span class="comment">// To store the base address of libbaiduprotect.so</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an empty function</span></span><br><span class="line"><span class="keyword">var</span> empty_func = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                base_addr = secmodule.<span class="property">base</span>; <span class="comment">// Save the base address</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libbaiduprotect.so base: &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> target_addr = baseaddr.<span class="title function_">add</span>(offset);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Target function at &quot;</span> + target_addr + <span class="string">&quot; entered&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libbaiduprotect.so base address: &quot;</span> + baseaddr);</span><br><span class="line">            <span class="title function_">hook_pthread_create</span>();</span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthread_create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> pthread_create_addr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> func_addr = args[<span class="number">2</span>];</span><br><span class="line">            <span class="keyword">let</span> target_func_addr = base_addr.<span class="title function_">add</span>(<span class="number">0x3E9F0</span>); <span class="comment">// Calculate the target function address</span></span><br><span class="line">            <span class="keyword">if</span> (func_addr.<span class="title function_">equals</span>(target_func_addr)) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Replacing func_addr &quot;</span> + func_addr + <span class="string">&quot; with empty function&quot;</span>);</span><br><span class="line">                args[<span class="number">2</span>] = empty_func; <span class="comment">// Replace with the empty function</span></span><br><span class="line">                <span class="title function_">hook_libart</span>(); <span class="comment">// Execute hook_libart</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(func_addr);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">module</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span> === module_name) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create called in libbaiduprotect.so, function address: &quot;</span> + func_addr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="comment">// Optionally log return value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">STD_STRING_SIZE</span> = <span class="number">3</span> * <span class="title class_">Process</span>.<span class="property">pointerSize</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StdString</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">handle</span> = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="variable constant_">STD_STRING_SIZE</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> [data, isTiny] = <span class="variable language_">this</span>.<span class="title function_">_getData</span>();</span><br><span class="line">        <span class="keyword">if</span> (!isTiny) &#123;</span><br><span class="line">            <span class="title class_">Java</span>.<span class="property">api</span>.$delete(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">disposeToString</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="variable language_">this</span>.<span class="title function_">toString</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">dispose</span>();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">toString</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> [data] = <span class="variable language_">this</span>.<span class="title function_">_getData</span>();</span><br><span class="line">        <span class="keyword">return</span> data.<span class="title function_">readUtf8String</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">_getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> str = <span class="variable language_">this</span>.<span class="property">handle</span>;</span><br><span class="line">        <span class="keyword">const</span> isTiny = (str.<span class="title function_">readU8</span>() &amp; <span class="number">1</span>) === <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">const</span> data = isTiny ? str.<span class="title function_">add</span>(<span class="number">1</span>) : str.<span class="title function_">add</span>(<span class="number">2</span> * <span class="title class_">Process</span>.<span class="property">pointerSize</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">        <span class="keyword">return</span> [data, isTiny];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">prettyMethod</span>(<span class="params">method_id, withSignature</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">new</span> <span class="title class_">StdString</span>();</span><br><span class="line">    <span class="title class_">Java</span>.<span class="property">api</span>[<span class="string">&#x27;art::ArtMethod::PrettyMethod&#x27;</span>](result, method_id, withSignature ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> result.<span class="title function_">disposeToString</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_libart</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> symbols = <span class="title class_">Module</span>.<span class="title function_">enumerateSymbolsSync</span>(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> addrGetStringUTFChars = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrNewStringUTF = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrFindClass = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetMethodID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetStaticMethodID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetFieldID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetStaticFieldID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrRegisterNatives = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> so_name = <span class="string">&quot;lib&quot;</span>;      <span class="comment">// <span class="doctag">TODO:</span> Specify the SO to filter</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;art&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;JNI&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) &lt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;_ZN3art3JNIILb0&quot;</span>) &gt;= <span class="number">0</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;GetStringUTFChars&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrGetStringUTFChars = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;GetStringUTFChars is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;NewStringUTF&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrNewStringUTF = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;NewStringUTF is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;FindClass&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrFindClass = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;FindClass is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;GetMethodID&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrGetMethodID = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;GetMethodID is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;GetStaticMethodID&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrGetStaticMethodID = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;GetStaticMethodID is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;GetFieldID&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrGetFieldID = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;GetFieldID is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;GetStaticFieldID&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrGetStaticFieldID = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;GetStaticFieldID is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;RegisterNatives&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                addrRegisterNatives = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;RegisterNatives is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CallStatic&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;CallStatic is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">                <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(symbol.<span class="property">address</span>, &#123;</span><br><span class="line">                    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> java_class = args[<span class="number">1</span>];</span><br><span class="line">                            <span class="keyword">var</span> mid = args[<span class="number">2</span>];</span><br><span class="line">                            <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(java_class);</span><br><span class="line">                            <span class="keyword">if</span> (class_name.<span class="title function_">indexOf</span>(<span class="string">&quot;java.&quot;</span>) == -<span class="number">1</span> &amp;&amp; class_name.<span class="title function_">indexOf</span>(<span class="string">&quot;android.&quot;</span>) == -<span class="number">1</span>) &#123;</span><br><span class="line">                                <span class="keyword">var</span> method_name = <span class="title function_">prettyMethod</span>(mid, <span class="number">1</span>);</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&lt;&gt;CallStatic:&quot;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>), class_name, method_name);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CallNonvirtual&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;CallNonvirtual is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">                <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(symbol.<span class="property">address</span>, &#123;</span><br><span class="line">                    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> jobject = args[<span class="number">1</span>];</span><br><span class="line">                            <span class="keyword">var</span> jclass = args[<span class="number">2</span>];</span><br><span class="line">                            <span class="keyword">var</span> jmethodID = args[<span class="number">3</span>];</span><br><span class="line">                            <span class="keyword">var</span> obj_class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getObjectClassName</span>(jobject);</span><br><span class="line">                            <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(jclass);</span><br><span class="line">                            <span class="keyword">if</span> (class_name.<span class="title function_">indexOf</span>(<span class="string">&quot;java.&quot;</span>) == -<span class="number">1</span> &amp;&amp; class_name.<span class="title function_">indexOf</span>(<span class="string">&quot;android.&quot;</span>) == -<span class="number">1</span>) &#123;</span><br><span class="line">                                <span class="keyword">var</span> method_name = <span class="title function_">prettyMethod</span>(jmethodID, <span class="number">1</span>);</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&lt;&gt;CallNonvirtual:&quot;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>), class_name, obj_class_name, method_name);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;Call&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;Method&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Call&lt;&gt;Method is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">                <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(symbol.<span class="property">address</span>, &#123;</span><br><span class="line">                    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> java_class = args[<span class="number">1</span>];</span><br><span class="line">                            <span class="keyword">var</span> mid = args[<span class="number">2</span>];</span><br><span class="line">                            <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getObjectClassName</span>(java_class);</span><br><span class="line">                            <span class="keyword">if</span> (class_name.<span class="title function_">indexOf</span>(<span class="string">&quot;java.&quot;</span>) == -<span class="number">1</span> &amp;&amp; class_name.<span class="title function_">indexOf</span>(<span class="string">&quot;android.&quot;</span>) == -<span class="number">1</span>) &#123;</span><br><span class="line">                                <span class="keyword">var</span> method_name = <span class="title function_">prettyMethod</span>(mid, <span class="number">1</span>);</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&lt;&gt;Call&lt;&gt;Method:&quot;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>), class_name, method_name);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addrGetStringUTFChars != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrGetStringUTFChars, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (retval != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> bytes = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(retval);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetStringUTFChars] result:&quot;</span> + bytes, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (addrNewStringUTF != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrNewStringUTF, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args[<span class="number">1</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> string = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">1</span>]);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[NewStringUTF] bytes:&quot;</span> + string, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addrFindClass != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrFindClass, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args[<span class="number">1</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">1</span>]);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[FindClass] name:&quot;</span> + name, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (addrGetMethodID != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrGetMethodID, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args[<span class="number">2</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> clazz = args[<span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(clazz);</span><br><span class="line">                    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">2</span>]);</span><br><span class="line">                        <span class="keyword">if</span> (args[<span class="number">3</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">3</span>]);</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetMethodID] class_name:&quot;</span> + class_name + <span class="string">&quot; name:&quot;</span> + name + <span class="string">&quot;, sig:&quot;</span> + sig, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetMethodID] class_name:&quot;</span> + class_name + <span class="string">&quot; name:&quot;</span> + name, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (addrGetStaticMethodID != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrGetStaticMethodID, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args[<span class="number">2</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> clazz = args[<span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(clazz);</span><br><span class="line">                    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">2</span>]);</span><br><span class="line">                        <span class="keyword">if</span> (args[<span class="number">3</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">3</span>]);</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetStaticMethodID] class_name:&quot;</span> + class_name + <span class="string">&quot; name:&quot;</span> + name + <span class="string">&quot;, sig:&quot;</span> + sig, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetStaticMethodID] class_name:&quot;</span> + class_name + <span class="string">&quot; name:&quot;</span> + name, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (addrGetFieldID != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrGetFieldID, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args[<span class="number">2</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">2</span>]);</span><br><span class="line">                        <span class="keyword">if</span> (args[<span class="number">3</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">3</span>]);</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetFieldID] name:&quot;</span> + name + <span class="string">&quot;, sig:&quot;</span> + sig, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetFieldID] name:&quot;</span> + name, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (addrGetStaticFieldID != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrGetStaticFieldID, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args[<span class="number">2</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(so_name) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">2</span>]);</span><br><span class="line">                        <span class="keyword">if</span> (args[<span class="number">3</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(args[<span class="number">3</span>]);</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetStaticFieldID] name:&quot;</span> + name + <span class="string">&quot;, sig:&quot;</span> + sig, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[GetStaticFieldID] name:&quot;</span> + name, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addrRegisterNatives != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrRegisterNatives, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[RegisterNatives] method_count:&quot;</span>, args[<span class="number">3</span>], <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                <span class="keyword">var</span> env = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">var</span> java_class = args[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(java_class);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> methods_ptr = <span class="title function_">ptr</span>(args[<span class="number">2</span>]);</span><br><span class="line">                <span class="keyword">var</span> method_count = <span class="built_in">parseInt</span>(args[<span class="number">3</span>]);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; method_count; i++) &#123;</span><br><span class="line">                    <span class="keyword">var</span> name_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span>));</span><br><span class="line">                    <span class="keyword">var</span> sig_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span>));</span><br><span class="line">                    <span class="keyword">var</span> fnPtr_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(name_ptr);</span><br><span class="line">                    <span class="keyword">var</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(sig_ptr);</span><br><span class="line">                    <span class="keyword">var</span> find_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(fnPtr_ptr);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[RegisterNatives] java_class:&quot;</span>, class_name, <span class="string">&quot;name:&quot;</span>, name, <span class="string">&quot;sig:&quot;</span>, sig, <span class="string">&quot;fnPtr:&quot;</span>, fnPtr_ptr, <span class="string">&quot;module_name:&quot;</span>, find_module.<span class="property">name</span>, <span class="string">&quot;module_base:&quot;</span>, find_module.<span class="property">base</span>, <span class="string">&quot;offset:&quot;</span>, <span class="title function_">ptr</span>(fnPtr_ptr).<span class="title function_">sub</span>(find_module.<span class="property">base</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">hook_linker_call_constructors</span>();</span><br></pre></td></tr></table></figure>

<p>成功打印出jni调用的函数，也就是说，离frida trace所有vmp的指令又进一步。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250512194612007.png" alt="image-20250512194612007"></p>
<p>暂时先到这吧，明天面携程，先复习一下加解密算法，之后继续复现vmp。</p>
<p> ok，继续分析，也不知道携程能不能有个善终——20250514 09:28。</p>
<p>我将jni调用的日志输出到文件中，慢慢看。</p>
<p>我们要分析的被vmp的函数是onCreate，不妨猜测它会调用super.onCreate，而要实现super.onCreate，不能只靠vmp的解释器进行解释执行，还需要用到jni调用，因此可以在日志中搜索onCreate，于是得到下面的日志。</p>
<p>于是，我们能确定了解释器是在哪里获取的onCreate的jmethod_id（0x5df18）和在哪里真正调用onCreate函数的（0x54370）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[GetMethodID] class_name:androidx.appcompat.app.AppCompatActivity name:onCreate, sig:(Landroid/os/Bundle;)V 0x743fd08f18 libbaiduprotect.so!0x5df18</span><br><span class="line">[GetMethodID] class_name:android.system.StructStatVfs name:&lt;init&gt;, sig:(JJJJJJJJJJJ)V 0x744a5310b4 libjavacore.so!0x310b4</span><br><span class="line">&lt;&gt;CallNonvirtual: 0x743fcff370 libbaiduprotect.so!0x54370 androidx.appcompat.app.AppCompatActivity com.example.test.MainActivity void androidx.appcompat.app.AppCompatActivity.onCreate(android.os.Bundle)</span><br></pre></td></tr></table></figure>

<p>不妨想想如何倒推——如果没有被vmp化，原onCreate中，大概率要执行super.onCreate，对应的smali指令，大概率是invoke-super，通过invoke-super调用父类的onCreate。</p>
<p>先尝试将指令trace下来吧，试了一下，即便先绕过反调，仍然无法trace下来，那是什么原因呢？</p>
<p>追踪指令流，发现执行到sub_45EBC后，程序便不会返回到BL sub_45EBC的下一条指令了，而sub_45EBC的最后一条指令是，将栈指针寄存器变成了0x1，难怪会退出——为什么使用frida-stalker之后，会出现这种问题呢？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov wsp, #1</span><br></pre></td></tr></table></figure>

<p>整理一下现有的信息，我知道：</p>
<ol>
<li><p>哪里调用了onCreate。</p>
</li>
<li><p>执行sub_45EBC就会崩溃。</p>
</li>
</ol>
<p>那我是否可以根据onCreate的交叉引用，一步一步回推是哪个跳转出现了问题，最后进入了sub_45EBC退出的。</p>
<p>已知0x5df18处会获取onCreate的method_id，而0x54370会调用onCreate，交叉引用一下这两个地址，发现两个函数都追踪到了.data节，除此之外，没有其它函数引用了它们。</p>
<p>把函数地址存放在.data节中，而且不只一个函数地址，大概率是通过BLR或BR指令跳转的。</p>
<p>BL和BLR的区别在，前者是通过PC相对偏移量跳转到目标函数在内存中的地址，而后者是跳转到寄存器中存储的地址，也就是说，BL的跳转地址基本是硬编码在指令里的，是编译时就确定的，而BLR可以根据寄存器的内容进行跳转，在运行时决定。这里这么多个地址放在一块，大概率在执行时要跳转很多个函数，所以使用有R的跳转指令。</p>
<p>这里继续交叉引用off_BD040。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514154101276.png" alt="image-20250514154101276" style="zoom:80%;" />

<p>BR X8，符合上面的分析。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514155831323.png" alt="image-20250514155831323" style="zoom: 67%;" />

<p>回到函数列表中，突然发现它有256个函数地址，smali的操作码是1个字节，对应256种操作，这里会不会就是vmp解释器模拟smali指令的地方？读取解密后的vmp_code_item，然后根据vmp_code_item里的每一条指令，模拟执行对应的函数。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></td><td class="code"><pre><span class="line">.data:00000000000BD040 58 CD 04 00 00 00 00 00 off<span class="emphasis">_BD040       DCQ sub_</span>4CD58           ; DATA XREF: sub<span class="emphasis">_4CC20+C4↑o</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD048 8C CD 04 00 00 00 00 00                 DCQ sub_</span>4CD8C</span><br><span class="line">.data:00000000000BD050 E0 CD 04 00 00 00 00 00                 DCQ sub<span class="emphasis">_4CDE0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD058 34 CE 04 00 00 00 00 00                 DCQ sub_</span>4CE34</span><br><span class="line">.data:00000000000BD060 84 CE 04 00 00 00 00 00                 DCQ sub<span class="emphasis">_4CE84</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD068 D4 CE 04 00 00 00 00 00                 DCQ sub_</span>4CED4</span><br><span class="line">.data:00000000000BD070 24 CF 04 00 00 00 00 00                 DCQ sub<span class="emphasis">_4CF24</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD078 70 CF 04 00 00 00 00 00                 DCQ sub_</span>4CF70</span><br><span class="line">.data:00000000000BD080 C0 CF 04 00 00 00 00 00                 DCQ sub<span class="emphasis">_4CFC0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD088 10 D0 04 00 00 00 00 00                 DCQ sub_</span>4D010</span><br><span class="line">.data:00000000000BD090 5C D0 04 00 00 00 00 00                 DCQ sub<span class="emphasis">_4D05C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD098 C0 D0 04 00 00 00 00 00                 DCQ sub_</span>4D0C0</span><br><span class="line">.data:00000000000BD0A0 2C D1 04 00 00 00 00 00                 DCQ sub<span class="emphasis">_4D12C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0A8 98 D1 04 00 00 00 00 00                 DCQ sub_</span>4D198</span><br><span class="line">.data:00000000000BD0B0 DC 46 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_546DC           ; jumptable 0000000000053D00 cases 69,71,72,75,77-82,84,85,87-89</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0B0                                                                 ; jumptable 0000000000053D50 cases 69,71,72,75,77-82,84,85,87-89</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0B0                                                                 ; jumptable 0000000000053DAC cases 69,71,72,75,77-82,84,85,87-89</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0B8 BC 46 05 00 00 00 00 00                 DCQ loc_</span>546BC</span><br><span class="line">.data:00000000000BD0C0 14 D2 04 00 00 00 00 00                 DCQ sub<span class="emphasis">_4D214</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0C8 14 D2 04 00 00 00 00 00                 DCQ sub_</span>4D214</span><br><span class="line">.data:00000000000BD0D0 34 D2 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D234</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0D8 80 D2 04 00 00 00 00 00                 DCQ loc_</span>4D280</span><br><span class="line">.data:00000000000BD0E0 D0 D2 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D2D0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0E8 24 D3 04 00 00 00 00 00                 DCQ loc_</span>4D324</span><br><span class="line">.data:00000000000BD0F0 74 D3 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D374</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD0F8 C0 D3 04 00 00 00 00 00                 DCQ loc_</span>4D3C0</span><br><span class="line">.data:00000000000BD100 18 D4 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D418</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD108 7C D4 04 00 00 00 00 00                 DCQ loc_</span>4D47C</span><br><span class="line">.data:00000000000BD110 CC D4 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D4CC</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD118 44 D5 04 00 00 00 00 00                 DCQ loc_</span>4D544</span><br><span class="line">.data:00000000000BD120 C4 D5 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D5C4</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD128 40 D6 04 00 00 00 00 00                 DCQ loc_</span>4D640</span><br><span class="line">.data:00000000000BD130 A8 D6 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D6A8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD138 24 D7 04 00 00 00 00 00                 DCQ loc_</span>4D724</span><br><span class="line">.data:00000000000BD140 C4 D7 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D7C4</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD148 68 D8 04 00 00 00 00 00                 DCQ loc_</span>4D868</span><br><span class="line">.data:00000000000BD150 E0 D8 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4D8E0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD158 C0 DA 04 00 00 00 00 00                 DCQ loc_</span>4DAC0</span><br><span class="line">.data:00000000000BD160 90 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53390</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD168 28 DC 04 00 00 00 00 00                 DCQ loc_</span>4DC28</span><br><span class="line">.data:00000000000BD170 30 DC 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4DC30</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD178 AC DC 04 00 00 00 00 00                 DCQ loc_</span>4DCAC</span><br><span class="line">.data:00000000000BD180 E8 DC 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4DCE8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD188 24 DD 04 00 00 00 00 00                 DCQ loc_</span>4DD24</span><br><span class="line">.data:00000000000BD190 60 DD 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4DD60</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD198 A4 DD 04 00 00 00 00 00                 DCQ loc_</span>4DDA4</span><br><span class="line">.data:00000000000BD1A0 24 DE 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4DE24</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD1A8 A4 DE 04 00 00 00 00 00                 DCQ loc_</span>4DEA4</span><br><span class="line">.data:00000000000BD1B0 30 DF 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4DF30</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD1B8 B0 DF 04 00 00 00 00 00                 DCQ loc_</span>4DFB0</span><br><span class="line">.data:00000000000BD1C0 34 E0 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E034</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD1C8 AC E0 04 00 00 00 00 00                 DCQ loc_</span>4E0AC</span><br><span class="line">.data:00000000000BD1D0 28 E1 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E128</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD1D8 14 E2 04 00 00 00 00 00                 DCQ loc_</span>4E214</span><br><span class="line">.data:00000000000BD1E0 00 E3 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E300</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD1E8 94 E3 04 00 00 00 00 00                 DCQ loc_</span>4E394</span><br><span class="line">.data:00000000000BD1F0 28 E4 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E428</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD1F8 BC E4 04 00 00 00 00 00                 DCQ loc_</span>4E4BC</span><br><span class="line">.data:00000000000BD200 50 E5 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E550</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD208 D4 E5 04 00 00 00 00 00                 DCQ loc_</span>4E5D4</span><br><span class="line">.data:00000000000BD210 58 E6 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E658</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD218 E0 E6 04 00 00 00 00 00                 DCQ loc_</span>4E6E0</span><br><span class="line">.data:00000000000BD220 68 E7 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E768</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD228 F0 E7 04 00 00 00 00 00                 DCQ loc_</span>4E7F0</span><br><span class="line">.data:00000000000BD230 78 E8 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E878</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD238 78 E8 04 00 00 00 00 00                 DCQ loc_</span>4E878</span><br><span class="line">.data:00000000000BD240 78 E8 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E878</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD248 78 E8 04 00 00 00 00 00                 DCQ loc_</span>4E878</span><br><span class="line">.data:00000000000BD250 78 E8 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E878</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD258 78 E8 04 00 00 00 00 00                 DCQ loc_</span>4E878</span><br><span class="line">.data:00000000000BD260 78 E8 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4E878</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD268 A4 E9 04 00 00 00 00 00                 DCQ loc_</span>4E9A4</span><br><span class="line">.data:00000000000BD270 A4 EA 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4EAA4</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD278 30 EC 04 00 00 00 00 00                 DCQ loc_</span>4EC30</span><br><span class="line">.data:00000000000BD280 1C ED 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4ED1C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD288 E0 ED 04 00 00 00 00 00                 DCQ loc_</span>4EDE0</span><br><span class="line">.data:00000000000BD290 A0 EE 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4EEA0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD298 64 EF 04 00 00 00 00 00                 DCQ loc_</span>4EF64</span><br><span class="line">.data:00000000000BD2A0 60 F0 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4F060</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD2A8 50 F1 04 00 00 00 00 00                 DCQ loc_</span>4F150</span><br><span class="line">.data:00000000000BD2B0 F4 F1 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4F1F4</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD2B8 9C F2 04 00 00 00 00 00                 DCQ loc_</span>4F29C</span><br><span class="line">.data:00000000000BD2C0 44 F3 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4F344</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD2C8 EC F3 04 00 00 00 00 00                 DCQ loc_</span>4F3EC</span><br><span class="line">.data:00000000000BD2D0 94 F4 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4F494</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD2D8 6C F5 04 00 00 00 00 00                 DCQ loc_</span>4F56C</span><br><span class="line">.data:00000000000BD2E0 30 F6 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4F630</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD2E8 A4 F7 04 00 00 00 00 00                 DCQ loc_</span>4F7A4</span><br><span class="line">.data:00000000000BD2F0 4C F8 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4F84C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD2F8 F8 F8 04 00 00 00 00 00                 DCQ loc_</span>4F8F8</span><br><span class="line">.data:00000000000BD300 A0 F9 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4F9A0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD308 4C FA 04 00 00 00 00 00                 DCQ loc_</span>4FA4C</span><br><span class="line">.data:00000000000BD310 0C FB 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4FB0C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD318 C8 FB 04 00 00 00 00 00                 DCQ loc_</span>4FBC8</span><br><span class="line">.data:00000000000BD320 68 FC 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4FC68</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD328 0C FD 04 00 00 00 00 00                 DCQ loc_</span>4FD0C</span><br><span class="line">.data:00000000000BD330 B0 FD 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4FDB0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD338 54 FE 04 00 00 00 00 00                 DCQ loc_</span>4FE54</span><br><span class="line">.data:00000000000BD340 F8 FE 04 00 00 00 00 00                 DCQ loc<span class="emphasis">_4FEF8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD348 C0 FF 04 00 00 00 00 00                 DCQ loc_</span>4FFC0</span><br><span class="line">.data:00000000000BD350 78 00 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50078</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD358 E8 01 05 00 00 00 00 00                 DCQ loc_</span>501E8</span><br><span class="line">.data:00000000000BD360 88 02 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50288</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD368 2C 03 05 00 00 00 00 00                 DCQ loc_</span>5032C</span><br><span class="line">.data:00000000000BD370 CC 03 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_503CC</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD378 70 04 05 00 00 00 00 00                 DCQ loc_</span>50470</span><br><span class="line">.data:00000000000BD380 24 05 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50524</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD388 D4 05 05 00 00 00 00 00                 DCQ loc_</span>505D4</span><br><span class="line">.data:00000000000BD390 6C 06 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_5066C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD398 08 07 05 00 00 00 00 00                 DCQ loc_</span>50708</span><br><span class="line">.data:00000000000BD3A0 A4 07 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_507A4</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD3A8 40 08 05 00 00 00 00 00                 DCQ loc_</span>50840</span><br><span class="line">.data:00000000000BD3B0 74 37 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53774</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD3B8 C4 37 05 00 00 00 00 00                 DCQ loc_</span>537C4</span><br><span class="line">.data:00000000000BD3C0 9C 38 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_5389C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD3C8 CC 39 05 00 00 00 00 00                 DCQ loc_</span>539CC</span><br><span class="line">.data:00000000000BD3D0 44 38 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53844</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD3D8 70 37 05 00 00 00 00 00                 DCQ loc_</span>53770</span><br><span class="line">.data:00000000000BD3E0 70 37 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53770</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD3E8 C0 37 05 00 00 00 00 00                 DCQ loc_</span>537C0</span><br><span class="line">.data:00000000000BD3F0 DC 08 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_508DC</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD3F8 C8 39 05 00 00 00 00 00                 DCQ loc_</span>539C8</span><br><span class="line">.data:00000000000BD400 40 38 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53840</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD408 F4 08 05 00 00 00 00 00                 DCQ loc_</span>508F4</span><br><span class="line">.data:00000000000BD410 F4 08 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_508F4</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD418 F4 08 05 00 00 00 00 00                 DCQ loc_</span>508F4</span><br><span class="line">.data:00000000000BD420 4C 09 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_5094C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD428 A4 09 05 00 00 00 00 00                 DCQ loc_</span>509A4</span><br><span class="line">.data:00000000000BD430 F8 09 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_509F8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD438 4C 0A 05 00 00 00 00 00                 DCQ loc_</span>50A4C</span><br><span class="line">.data:00000000000BD440 AC 0A 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50AAC</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD448 00 0B 05 00 00 00 00 00                 DCQ loc_</span>50B00</span><br><span class="line">.data:00000000000BD450 54 0B 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50B54</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD458 B4 0B 05 00 00 00 00 00                 DCQ loc_</span>50BB4</span><br><span class="line">.data:00000000000BD460 10 0C 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50C10</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD468 68 0C 05 00 00 00 00 00                 DCQ loc_</span>50C68</span><br><span class="line">.data:00000000000BD470 C4 0C 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50CC4</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD478 18 0D 05 00 00 00 00 00                 DCQ loc_</span>50D18</span><br><span class="line">.data:00000000000BD480 B8 0D 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50DB8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD488 50 0E 05 00 00 00 00 00                 DCQ loc_</span>50E50</span><br><span class="line">.data:00000000000BD490 A8 0E 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50EA8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD498 44 0F 05 00 00 00 00 00                 DCQ loc_</span>50F44</span><br><span class="line">.data:00000000000BD4A0 D8 0F 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_50FD8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD4A8 34 10 05 00 00 00 00 00                 DCQ loc_</span>51034</span><br><span class="line">.data:00000000000BD4B0 88 10 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51088</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD4B8 DC 10 05 00 00 00 00 00                 DCQ loc_</span>510DC</span><br><span class="line">.data:00000000000BD4C0 30 11 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51130</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD4C8 98 11 05 00 00 00 00 00                 DCQ loc_</span>51198</span><br><span class="line">.data:00000000000BD4D0 00 12 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51200</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD4D8 68 12 05 00 00 00 00 00                 DCQ loc_</span>51268</span><br><span class="line">.data:00000000000BD4E0 0C 13 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_5130C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD4E8 98 13 05 00 00 00 00 00                 DCQ loc_</span>51398</span><br><span class="line">.data:00000000000BD4F0 00 14 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51400</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD4F8 68 14 05 00 00 00 00 00                 DCQ loc_</span>51468</span><br><span class="line">.data:00000000000BD500 D0 14 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_514D0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD508 3C 15 05 00 00 00 00 00                 DCQ loc_</span>5153C</span><br><span class="line">.data:00000000000BD510 A8 15 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_515A8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD518 14 16 05 00 00 00 00 00                 DCQ loc_</span>51614</span><br><span class="line">.data:00000000000BD520 74 16 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51674</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD528 D4 16 05 00 00 00 00 00                 DCQ loc_</span>516D4</span><br><span class="line">.data:00000000000BD530 34 17 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51734</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD538 C4 17 05 00 00 00 00 00                 DCQ loc_</span>517C4</span><br><span class="line">.data:00000000000BD540 48 18 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51848</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD548 A8 18 05 00 00 00 00 00                 DCQ loc_</span>518A8</span><br><span class="line">.data:00000000000BD550 08 19 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51908</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD558 68 19 05 00 00 00 00 00                 DCQ loc_</span>51968</span><br><span class="line">.data:00000000000BD560 D0 19 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_519D0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD568 38 1A 05 00 00 00 00 00                 DCQ loc_</span>51A38</span><br><span class="line">.data:00000000000BD570 A0 1A 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51AA0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD578 10 1B 05 00 00 00 00 00                 DCQ loc_</span>51B10</span><br><span class="line">.data:00000000000BD580 80 1B 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51B80</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD588 F0 1B 05 00 00 00 00 00                 DCQ loc_</span>51BF0</span><br><span class="line">.data:00000000000BD590 60 1C 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51C60</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD598 F0 1C 05 00 00 00 00 00                 DCQ loc_</span>51CF0</span><br><span class="line">.data:00000000000BD5A0 50 1D 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51D50</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD5A8 B0 1D 05 00 00 00 00 00                 DCQ loc_</span>51DB0</span><br><span class="line">.data:00000000000BD5B0 10 1E 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51E10</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD5B8 70 1E 05 00 00 00 00 00                 DCQ loc_</span>51E70</span><br><span class="line">.data:00000000000BD5C0 F0 1E 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51EF0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD5C8 50 1F 05 00 00 00 00 00                 DCQ loc_</span>51F50</span><br><span class="line">.data:00000000000BD5D0 B0 1F 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_51FB0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD5D8 10 20 05 00 00 00 00 00                 DCQ loc_</span>52010</span><br><span class="line">.data:00000000000BD5E0 A0 20 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_520A0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD5E8 24 21 05 00 00 00 00 00                 DCQ loc_</span>52124</span><br><span class="line">.data:00000000000BD5F0 84 21 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52184</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD5F8 E4 21 05 00 00 00 00 00                 DCQ loc_</span>521E4</span><br><span class="line">.data:00000000000BD600 44 22 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52244</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD608 A8 22 05 00 00 00 00 00                 DCQ loc_</span>522A8</span><br><span class="line">.data:00000000000BD610 0C 23 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_5230C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD618 70 23 05 00 00 00 00 00                 DCQ loc_</span>52370</span><br><span class="line">.data:00000000000BD620 CC 23 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_523CC</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD628 28 24 05 00 00 00 00 00                 DCQ loc_</span>52428</span><br><span class="line">.data:00000000000BD630 84 24 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52484</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD638 0C 25 05 00 00 00 00 00                 DCQ loc_</span>5250C</span><br><span class="line">.data:00000000000BD640 88 25 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52588</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD648 E4 25 05 00 00 00 00 00                 DCQ loc_</span>525E4</span><br><span class="line">.data:00000000000BD650 40 26 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52640</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD658 9C 26 05 00 00 00 00 00                 DCQ loc_</span>5269C</span><br><span class="line">.data:00000000000BD660 00 27 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52700</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD668 64 27 05 00 00 00 00 00                 DCQ loc_</span>52764</span><br><span class="line">.data:00000000000BD670 C8 27 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_527C8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD678 2C 28 05 00 00 00 00 00                 DCQ loc_</span>5282C</span><br><span class="line">.data:00000000000BD680 90 28 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52890</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD688 F4 28 05 00 00 00 00 00                 DCQ loc_</span>528F4</span><br><span class="line">.data:00000000000BD690 58 29 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52958</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD698 DC 29 05 00 00 00 00 00                 DCQ loc_</span>529DC</span><br><span class="line">.data:00000000000BD6A0 38 2A 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52A38</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD6A8 94 2A 05 00 00 00 00 00                 DCQ loc_</span>52A94</span><br><span class="line">.data:00000000000BD6B0 F0 2A 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52AF0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD6B8 4C 2B 05 00 00 00 00 00                 DCQ loc_</span>52B4C</span><br><span class="line">.data:00000000000BD6C0 C8 2B 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52BC8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD6C8 24 2C 05 00 00 00 00 00                 DCQ loc_</span>52C24</span><br><span class="line">.data:00000000000BD6D0 80 2C 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52C80</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD6D8 DC 2C 05 00 00 00 00 00                 DCQ loc_</span>52CDC</span><br><span class="line">.data:00000000000BD6E0 70 2D 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52D70</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD6E8 F8 2D 05 00 00 00 00 00                 DCQ loc_</span>52DF8</span><br><span class="line">.data:00000000000BD6F0 54 2E 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52E54</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD6F8 B0 2E 05 00 00 00 00 00                 DCQ loc_</span>52EB0</span><br><span class="line">.data:00000000000BD700 0C 2F 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52F0C</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD708 6C 2F 05 00 00 00 00 00                 DCQ loc_</span>52F6C</span><br><span class="line">.data:00000000000BD710 D0 2F 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_52FD0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD718 34 30 05 00 00 00 00 00                 DCQ loc_</span>53034</span><br><span class="line">.data:00000000000BD720 C8 30 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_530C8</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD728 50 31 05 00 00 00 00 00                 DCQ loc_</span>53150</span><br><span class="line">.data:00000000000BD730 B0 31 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_531B0</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD738 10 32 05 00 00 00 00 00                 DCQ loc_</span>53210</span><br><span class="line">.data:00000000000BD740 70 32 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53270</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD748 D0 32 05 00 00 00 00 00                 DCQ loc_</span>532D0</span><br><span class="line">.data:00000000000BD750 30 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53330</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD758 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD760 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD768 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD770 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD778 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD780 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD788 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD790 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD798 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD7A0 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD7A8 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD7B0 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD7B8 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD7C0 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD7C8 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD7D0 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD7D8 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD7E0 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD7E8 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD7F0 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD7F8 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD800 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD808 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD810 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD818 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD820 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD828 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br><span class="line">.data:00000000000BD830 98 33 05 00 00 00 00 00                 DCQ loc<span class="emphasis">_53398</span></span><br><span class="line"><span class="emphasis">.data:00000000000BD838 98 33 05 00 00 00 00 00                 DCQ loc_</span>53398</span><br></pre></td></tr></table></figure>

<p>继续交叉引用sub_4CC20，来到了关键的地方，基本可以确认sub_4CC20就是解释器了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514160856292.png" alt="image-20250514160856292"></p>
<p>hook了一些libc的open、strstr、read、strcmp之类的函数，并没有发现对frida的检测，好奇怪，那为什么会执行到sub_45EBC就崩溃呢？</p>
<p>对着sub_45EBC进行分析，发现一个比较关键的地方。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514210759485.png" alt="image-20250514210759485"></p>
<p>这个时候，可以打开我们之前trace的汇编指令，究竟是谁让w8变成了0。从0x4ad0c往上找，关于x8&#x2F;w8的赋值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514211854347.png" alt="image-20250514211854347"></p>
<p>很容易就找到，x11存放了一个地址，而x10的值为0，因此w8变成了0，继续追踪x10&#x2F;x11的含义。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514212027583.png" alt="image-20250514212027583"></p>
<p>可以根据减去基址，看看x8和x0的含义，基址是0x743fc99000。</p>
<p>x0对应0x2F38BFB0，x8对应0x2D40FEC78，看来调用的不是libbaiduprotect.so的函数，应该是别的库，所以减错了基址。</p>
<p>我在ida中还原过这个地方，x8是malloc的运行地址，所以这里的x0是分配到的空间地址，和我想得不太一样啊？</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514212503520.png" alt="image-20250514212503520"></p>
<p>这说明，进入sub_45EBC函数后，应该是能正常出来的。</p>
<p>其实仔细观察，为什么会发生崩溃呢？MOV WSP, #1虽然将栈顶寄存器指向了一个会奇怪的地方，但下一条指令很快的覆盖了SP的内容，因此应该不会造成崩溃，那问题只能处在frida-stalker了，它是不是在插桩的时候用到了SP？</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514222207967.png" alt="image-20250514222207967"></p>
<p>我们来看一下frida-stalker的原理。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250514222454544.png" alt="image-20250514222454544"></p>
<p>离我们的猜想很近，如果插桩的黄色代码中，使用到了sp寄存器，就会把程序弄崩溃，我们试试能不能在识别到MOV WSP, #1时候将它NOP掉，不执行，避免产生这样的问题。</p>
<p>代码如下，下面这个代码可以绕过这一条指令，继续打印追踪的流程。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> offset = <span class="number">0x88060</span>;</span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> base_addr = <span class="literal">null</span>; <span class="comment">// To store the base address of libbaiduprotect.so</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an empty function</span></span><br><span class="line"><span class="keyword">var</span> empty_func = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// console.log(&quot;[Anti-Debug] Empty function executed.&quot;); // 可选日志</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 为提高健壮性，建议使用更完善的 linker 及 call_constructors 查找逻辑</span></span><br><span class="line">    <span class="comment">// 但为保持与你原始脚本的结构，暂时保留这种直接方式</span></span><br><span class="line">    <span class="keyword">let</span> linker_module_name = <span class="title class_">Process</span>.<span class="property">arch</span> === <span class="string">&#x27;arm64&#x27;</span> ? <span class="string">&#x27;linker64&#x27;</span> : <span class="string">&#x27;linker&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(linker_module_name);</span><br><span class="line">    <span class="keyword">if</span> (!linker64_base_addr) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] Failed to get &quot;</span> + linker_module_name + <span class="string">&quot; base address. Trying to find module directly later.&quot;</span>);</span><br><span class="line">        <span class="comment">// Fallback if linker not found</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!base_addr) &#123; <span class="comment">// Check if already found</span></span><br><span class="line">                <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">                <span class="keyword">if</span> (secmodule) &#123;</span><br><span class="line">                    base_addr = secmodule.<span class="property">base</span>;</span><br><span class="line">                    module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot; base (fallback): &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                    <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] &quot;</span> + module_name + <span class="string">&quot; not found via fallback. Cannot proceed.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1500</span>); <span class="comment">// Delay slightly</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv - 这个偏移非常依赖系统</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Attempting to attach to linker&#x27;s call_constructors at &quot;</span> + call_constructors);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="comment">// console.log(&#x27;[linker] Call_Constructors onEnter&#x27;);</span></span><br><span class="line">                <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">                <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (base_addr === <span class="literal">null</span>) &#123; <span class="comment">// 确保只初始化一次</span></span><br><span class="line">                        module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                        base_addr = secmodule.<span class="property">base</span>; <span class="comment">// Save the base address</span></span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot; base: &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// *** 在这里也可以考虑直接打补丁已知崩溃点, 但Stalker内处理更灵活些 ***</span></span><br><span class="line">                        <span class="comment">// patchInstructionToNop(base_addr, 0x48AC0, 4);</span></span><br><span class="line">                        <span class="comment">// patchInstructionToNop(base_addr, 0x4ABB8, 4);</span></span><br><span class="line"></span><br><span class="line">                        <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                        listener.<span class="title function_">detach</span>();</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Detached from linker hook.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Failed to attach to linker&#x27;s call_constructors: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    Will rely on fallback to find module &quot;</span> + module_name);</span><br><span class="line">         <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="comment">// 与上面的 fallback 逻辑类似</span></span><br><span class="line">            <span class="keyword">if</span> (!base_addr) &#123;</span><br><span class="line">                <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">                <span class="keyword">if</span> (secmodule) &#123;</span><br><span class="line">                    base_addr = secmodule.<span class="property">base</span>;</span><br><span class="line">                    module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot; base (fallback after attach error): &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                    <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Fallback after attach error: &quot;</span> + module_name + <span class="string">&quot; not found.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1500</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">current_base_addr</span>) &#123; <span class="comment">// 使用 current_base_addr 区分全局 base_addr</span></span><br><span class="line">    <span class="keyword">if</span> (!current_base_addr || current_base_addr.<span class="title function_">isNull</span>())&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] hook_target_func: current_base_addr is invalid.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> target_addr = current_base_addr.<span class="title function_">add</span>(offset); <span class="comment">// offset = 0x88060</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking target function at &quot;</span> + target_addr + <span class="string">&quot; (offset 0x&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Target function &quot;</span> + module_name + <span class="string">&quot;!0x&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; entered. Called from: &quot;</span> + <span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot;!0x&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; onLeave. Base address: &quot;</span> + current_base_addr);</span><br><span class="line">                <span class="keyword">if</span> (base_addr &amp;&amp; !base_addr.<span class="title function_">isNull</span>()) &#123; <span class="comment">// 确保全局base_addr有效</span></span><br><span class="line">                    <span class="title function_">hook_pthread_create</span>();</span><br><span class="line">                    <span class="title class_">StalkerTrace</span>(base_addr); <span class="comment">// 传递正确的模块基址给StalkerTrace</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Global base_addr not set in hook_target_func onLeave. Cannot start Stalker / pthread hook.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Detached from target_func hook at &quot;</span> + target_addr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Failed to attach to target_func at &quot;</span> + target_addr + <span class="string">&quot;: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthread_create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!base_addr || base_addr.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] hook_pthread_create: Global base_addr is null.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> pthread_create_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pthread_create_addr) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking pthread_create at &quot;</span> + pthread_create_addr);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create_addr, &#123;</span><br><span class="line">                <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> func_addr = args[<span class="number">2</span>];</span><br><span class="line">                    <span class="keyword">let</span> target_func_addr = base_addr.<span class="title function_">add</span>(<span class="number">0x3E9F0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (func_addr.<span class="title function_">equals</span>(target_func_addr)) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Anti-Debug] Replacing thread start_routine &quot;</span> + func_addr + <span class="string">&quot; with empty function.&quot;</span>);</span><br><span class="line">                        args[<span class="number">2</span>] = empty_func;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Failed to attach to pthread_create: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] pthread_create not found in libc.so. Hook skipped.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">TARGET_MODULE_NAME</span> = <span class="string">&quot;libbaiduprotect.so&quot;</span>; <span class="comment">// 等同于 module_name</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_diff_regs</span>(<span class="params">context, pre_regs</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> diff_regs = &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> current_regs_snapshot = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(context));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> reg_name_orig <span class="keyword">in</span> current_regs_snapshot) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current_regs_snapshot.<span class="title function_">hasOwnProperty</span>(reg_name_orig)) &#123;</span><br><span class="line">            <span class="keyword">const</span> reg_name = reg_name_orig.<span class="title function_">toLowerCase</span>();</span><br><span class="line">            <span class="keyword">if</span> (reg_name !== <span class="string">&quot;pc&quot;</span> &amp;&amp; !reg_name.<span class="title function_">startsWith</span>(<span class="string">&quot;q&quot;</span>) &amp;&amp; reg_name !== <span class="string">&quot;sp&quot;</span>) &#123; <span class="comment">// 也可以过滤掉sp</span></span><br><span class="line">                <span class="keyword">if</span> (pre_regs[reg_name_orig] !== current_regs_snapshot[reg_name_orig]) &#123;</span><br><span class="line">                    pre_regs[reg_name_orig] = current_regs_snapshot[reg_name_orig];</span><br><span class="line">                    diff_regs[reg_name_orig] = current_regs_snapshot[reg_name_orig];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> diff_regs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_involved_regs</span>(<span class="params">instruction</span>) &#123; <span class="comment">/* ... (保持不变) ... */</span></span><br><span class="line">    <span class="keyword">const</span> involved_regs = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">    instruction.<span class="property">operands</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">op</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (op.<span class="property">type</span> === <span class="string">&#x27;reg&#x27;</span>) &#123; involved_regs.<span class="title function_">add</span>(op.<span class="property">value</span>); &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (op.<span class="property">type</span> === <span class="string">&#x27;mem&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (op.<span class="property">value</span>.<span class="property">base</span>) &#123; involved_regs.<span class="title function_">add</span>(op.<span class="property">value</span>.<span class="property">base</span>); &#125;</span><br><span class="line">            <span class="keyword">if</span> (op.<span class="property">value</span>.<span class="property">index</span>) &#123; involved_regs.<span class="title function_">add</span>(op.<span class="property">value</span>.<span class="property">index</span>); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(involved_regs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =======================================================================================</span></span><br><span class="line"><span class="comment">// 修改 StalkerTrace 函数</span></span><br><span class="line"><span class="comment">// =======================================================================================</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">StalkerTrace</span>(<span class="params">current_module_baseaddr</span>) &#123; <span class="comment">// 确保传入的是正确的模块基地址</span></span><br><span class="line">    <span class="keyword">var</span> stalker_target_func_offset = <span class="number">0x4a458</span>; <span class="comment">// 这是你希望Stalker开始追踪的函数偏移</span></span><br><span class="line">    <span class="keyword">var</span> sub_42598_addr = current_module_baseaddr.<span class="title function_">add</span>(stalker_target_func_offset);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] StalkerTrace will target &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; at actual address: &quot;</span> + sub_42598_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> module_stalk_target = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(sub_42598_addr);</span><br><span class="line">    <span class="keyword">if</span> (!module_stalk_target || module_stalk_target.<span class="property">name</span> !== <span class="variable constant_">TARGET_MODULE_NAME</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] StalkerTrace: Module for target function (&quot;</span> + sub_42598_addr + <span class="string">&quot;) is not &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> +</span><br><span class="line">                      <span class="string">&quot;. Found: &quot;</span> + (module_stalk_target ? module_stalk_target.<span class="property">name</span> : <span class="string">&quot;none&quot;</span>) +</span><br><span class="line">                      <span class="string">&quot;. Ensure base address and offset are correct. Stalker might not work as expected.&quot;</span>);</span><br><span class="line">        <span class="comment">// 如果模块名不匹配，我们可能不应该继续，或者用传入的 baseaddr 作为module_start/end的依据</span></span><br><span class="line">        <span class="keyword">if</span> (!current_module_baseaddr || current_module_baseaddr.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] StalkerTrace: No valid base address to proceed with module bounds.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">         module_stalk_target = &#123; <span class="attr">base</span>: current_module_baseaddr, <span class="attr">size</span>: module_size, <span class="attr">name</span>: <span class="variable constant_">TARGET_MODULE_NAME</span> &#125;; <span class="comment">// module_size 是全局的</span></span><br><span class="line">         <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] StalkerTrace: Using passed base_addr for module bounds for Stalker.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> module_start = module_stalk_target.<span class="property">base</span>;</span><br><span class="line">    <span class="keyword">const</span> module_end = module_stalk_target.<span class="property">base</span>.<span class="title function_">add</span>(module_stalk_target.<span class="property">size</span>); <span class="comment">// Stalker只记录此模块内的指令</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Stalker module bounds: Start=&quot;</span> + module_start + <span class="string">&quot;, End=&quot;</span> + module_end);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(sub_42598_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">tid</span> = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Stalker: Entered &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; (TID: &quot;</span> + <span class="variable language_">this</span>.<span class="property">tid</span> + <span class="string">&quot;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> local_pre_regs = &#123;&#125;;</span><br><span class="line">            <span class="keyword">const</span> initial_context_snapshot = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">context</span>));</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> reg_name_orig <span class="keyword">in</span> initial_context_snapshot) &#123;</span><br><span class="line">                <span class="keyword">if</span> (initial_context_snapshot.<span class="title function_">hasOwnProperty</span>(reg_name_orig)) &#123;</span><br><span class="line">                    <span class="keyword">const</span> reg_name = reg_name_orig.<span class="title function_">toLowerCase</span>();</span><br><span class="line">                    <span class="keyword">if</span> (reg_name !== <span class="string">&quot;pc&quot;</span> &amp;&amp; !reg_name.<span class="title function_">startsWith</span>(<span class="string">&quot;q&quot;</span>)) &#123;</span><br><span class="line">                        local_pre_regs[reg_name_orig] = initial_context_snapshot[reg_name_orig];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// === 新增：用于直接patch的已知崩溃点 ===</span></span><br><span class="line">            <span class="comment">// 这些地址相对于 current_module_baseaddr (即 libbaiduprotect.so 的基地址)</span></span><br><span class="line">            <span class="keyword">const</span> knownCrashOffsets = [<span class="number">0x48AC0</span>, <span class="number">0x4ABB8</span>]; <span class="comment">// 把已知的都列出来</span></span><br><span class="line">            knownCrashOffsets.<span class="title function_">forEach</span>(<span class="function"><span class="params">offset</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> patchAddr = current_module_baseaddr.<span class="title function_">add</span>(offset);</span><br><span class="line">                    <span class="comment">// 读取指令，确认是否是 MOV WSP, #1</span></span><br><span class="line">                    <span class="keyword">const</span> instrBytes = patchAddr.<span class="title function_">readByteArray</span>(<span class="number">4</span>);</span><br><span class="line">                    <span class="comment">// MOV WSP, #1 (MOVZ W31, #1, LSL #0) -&gt; FF 03 00 32 (Little Endian: 320003FF)</span></span><br><span class="line">                    <span class="keyword">if</span> (instrBytes &amp;&amp; instrBytes[<span class="number">0</span>] === <span class="number">0x32</span> &amp;&amp; instrBytes[<span class="number">1</span>] === <span class="number">0x00</span> &amp;&amp; instrBytes[<span class="number">2</span>] === <span class="number">0x03</span> &amp;&amp; instrBytes[<span class="number">3</span>] === <span class="number">0xFF</span>) &#123;</span><br><span class="line">                        <span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(patchAddr, <span class="number">4</span>, <span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">                            <span class="keyword">const</span> writer = <span class="keyword">new</span> <span class="title class_">Arm64Writer</span>(code, &#123; <span class="attr">pc</span>: patchAddr &#125;);</span><br><span class="line">                            writer.<span class="title function_">putNop</span>();</span><br><span class="line">                            writer.<span class="title function_">flush</span>();</span><br><span class="line">                        &#125;);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[MemoryPatch] Stalker&#x27;s onEnter: NOPped known crash (MOV WSP, #1) at &quot;</span> + module_name + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(offset) + <span class="string">&quot; (&quot;</span>+ patchAddr + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// console.log(&quot;[MemoryPatch] Stalker&#x27;s onEnter: Instruction at &quot; + module_name + &quot;!&quot; + ptr(offset) + &quot; is not MOV WSP, #1. Bytes: &quot; + Array.from(new Uint8Array(instrBytes)).map(b =&gt; b.toString(16).padStart(2,&#x27;0&#x27;)).join(&#x27;&#x27;));</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[MemoryPatch] Stalker&#x27;s onEnter: Error patching &quot;</span> + module_name + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(offset) + <span class="string">&quot;: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// =====================================</span></span><br><span class="line"></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">follow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>, &#123;</span><br><span class="line">                <span class="attr">events</span>: &#123; <span class="attr">call</span>: <span class="literal">false</span>, <span class="attr">ret</span>: <span class="literal">false</span>, <span class="attr">exec</span>: <span class="literal">true</span>, <span class="attr">block</span>: <span class="literal">false</span>, <span class="attr">compile</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">                <span class="title function_">transform</span>(<span class="params">iterator</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> instruction = iterator.<span class="title function_">next</span>();</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="keyword">const</span> currentAddress = instruction.<span class="property">address</span>;</span><br><span class="line">                        <span class="keyword">let</span> patchedThisInstruction = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 通用的 MOV WSP/SP, #1 检测和NOP逻辑 (作为补充)</span></span><br><span class="line">                        <span class="keyword">const</span> mnemonic = instruction.<span class="property">mnemonic</span>.<span class="title function_">toLowerCase</span>();</span><br><span class="line">                        <span class="keyword">if</span> ((mnemonic === <span class="string">&#x27;mov&#x27;</span> || mnemonic === <span class="string">&#x27;movz&#x27;</span>) &amp;&amp; instruction.<span class="property">operands</span>.<span class="property">length</span> &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                            <span class="keyword">const</span> destOperand = instruction.<span class="property">operands</span>[<span class="number">0</span>];</span><br><span class="line">                            <span class="keyword">const</span> srcOperand = instruction.<span class="property">operands</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (destOperand.<span class="property">type</span> === <span class="string">&#x27;reg&#x27;</span> &amp;&amp;</span><br><span class="line">                                (destOperand.<span class="property">value</span> === <span class="string">&#x27;wsp&#x27;</span> || destOperand.<span class="property">value</span> === <span class="string">&#x27;sp&#x27;</span> ||</span><br><span class="line">                                 destOperand.<span class="property">value</span> === <span class="string">&#x27;w31&#x27;</span> || destOperand.<span class="property">value</span> === <span class="string">&#x27;x31&#x27;</span>) &amp;&amp;</span><br><span class="line">                                srcOperand.<span class="property">type</span> === <span class="string">&#x27;imm&#x27;</span> &amp;&amp;</span><br><span class="line">                                <span class="built_in">parseInt</span>(srcOperand.<span class="property">value</span>.<span class="title function_">toString</span>()) === <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[StalkerTransform] Identified &#x27;&quot;</span> + instruction.<span class="title function_">toString</span>() + <span class="string">&quot;&#x27; at &quot;</span> + currentAddress + <span class="string">&quot;. Replacing with NOP.&quot;</span>);</span><br><span class="line">                                iterator.<span class="title function_">putNop</span>();</span><br><span class="line">                                patchedThisInstruction = <span class="literal">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (!patchedThisInstruction) &#123;</span><br><span class="line">                            <span class="comment">// 仅在模块代码范围内执行putCallout，减少日志量并避免干扰其他模块</span></span><br><span class="line">                            <span class="keyword">const</span> is_module_code = currentAddress.<span class="title function_">compare</span>(module_start) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                                   currentAddress.<span class="title function_">compare</span>(module_end) &lt; <span class="number">0</span>;</span><br><span class="line">                            <span class="keyword">if</span> (is_module_code) &#123;</span><br><span class="line">                                iterator.<span class="title function_">putCallout</span>(<span class="keyword">function</span> (<span class="params">context</span>) &#123;</span><br><span class="line">                                    <span class="keyword">var</span> pc = context.<span class="property">pc</span>;</span><br><span class="line">                                    <span class="comment">// module_start, module_end, TARGET_MODULE_NAME, get_diff_regs, local_pre_regs</span></span><br><span class="line">                                    <span class="comment">// 这些变量需要能被这个闭包访问到。local_pre_regs 是 onEnter 作用域的。</span></span><br><span class="line">                                    <span class="comment">// module_start 等可以考虑从外部作用域传入或再次获取。</span></span><br><span class="line">                                    <span class="comment">// 为简化，假设它们可访问。</span></span><br><span class="line">                                    <span class="keyword">var</span> current_callout_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(pc);</span><br><span class="line">                                    <span class="keyword">if</span> (current_callout_module &amp;&amp; current_callout_module.<span class="property">name</span> === <span class="variable constant_">TARGET_MODULE_NAME</span>) &#123;</span><br><span class="line">                                        <span class="keyword">const</span> instrToLog = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(pc);</span><br><span class="line">                                        <span class="keyword">const</span> diff_regs = <span class="title function_">get_diff_regs</span>(context, local_pre_regs);</span><br><span class="line">                                        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">                                            current_callout_module.<span class="property">name</span> + <span class="string">&quot;!&quot;</span> + pc.<span class="title function_">sub</span>(current_callout_module.<span class="property">base</span>),</span><br><span class="line">                                            instrToLog.<span class="title function_">toString</span>(),</span><br><span class="line">                                            <span class="string">&quot;\t\t&quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(diff_regs)</span><br><span class="line">                                        );</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;);</span><br><span class="line">                            &#125;</span><br><span class="line">                            iterator.<span class="title function_">keep</span>();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((instruction = iterator.<span class="title function_">next</span>()) !== <span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; onLeave, TID:&quot;</span>, <span class="variable language_">this</span>.<span class="property">tid</span>);</span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">unfollow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>); <span class="comment">// 在函数退出时明确停止Stalker是个好习惯</span></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">garbageCollect</span>();   <span class="comment">// 回收Stalker资源</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Script starting for &quot;</span> + module_name + <span class="string">&quot;...&quot;</span>);</span><br><span class="line">    <span class="title function_">hook_linker_call_constructors</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Script loaded. Waiting for &quot;</span> + module_name + <span class="string">&quot;...&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>听说frida-sktrace实现了字符串（连续有4个可显示的字符时，打印字符串）的打印，而且更美观一些，这里试试使用frida-sktrace，但似乎不支持spawn模式附加进程，而且hook的时机还得修改，我决定在我原有的代码上添加这个功能。——我改成了，存在连续3个可视字符时，把指针内容当成字符串地址。</p>
<p>下面是让大模型帮我写的代码，不过也太长了吧。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// =======================================================================================</span></span><br><span class="line"><span class="comment">// Modified StalkerTrace Function (FIXED local_pre_regs access)</span></span><br><span class="line"><span class="comment">// =======================================================================================</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">StalkerTrace</span>(<span class="params">current_module_baseaddr</span>) &#123; <span class="comment">// Ensure the correct module base address is passed</span></span><br><span class="line">    <span class="comment">// Use the global module_size which should be set by now</span></span><br><span class="line">    <span class="keyword">if</span> (!current_module_baseaddr || current_module_baseaddr.<span class="title function_">isNull</span>() || module_size === <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] StalkerTrace: Invalid module base address or size. Cannot proceed.&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> stalker_target_func_offset = <span class="number">0x4a458</span>; <span class="comment">// The offset of the function you want Stalker to trace</span></span><br><span class="line">    <span class="keyword">var</span> stalker_start_addr = current_module_baseaddr.<span class="title function_">add</span>(stalker_target_func_offset);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] StalkerTrace will target &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; at actual address: &quot;</span> + stalker_start_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define the module bounds for Stalker logging</span></span><br><span class="line">    <span class="keyword">const</span> module_start = current_module_baseaddr;</span><br><span class="line">    <span class="keyword">const</span> module_end = current_module_baseaddr.<span class="title function_">add</span>(module_size);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Stalker module bounds: Start=&quot;</span> + module_start + <span class="string">&quot;, End=&quot;</span> + module_end);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(stalker_start_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="comment">// Stalker operates per thread. Get the current thread ID.</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">tid</span> = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Stalker: Entered &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; (TID: &quot;</span> + <span class="variable language_">this</span>.<span class="property">tid</span> + <span class="string">&quot;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize previous register state *for this specific thread*.</span></span><br><span class="line">            <span class="comment">// This variable is local to this onEnter call but will be captured by the closure.</span></span><br><span class="line">            <span class="keyword">const</span> local_pre_regs = &#123;&#125;; </span><br><span class="line">            <span class="comment">// Populate initial state, excluding filtered registers</span></span><br><span class="line">            <span class="keyword">const</span> initial_context_snapshot = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">context</span>));</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> reg_name_orig <span class="keyword">in</span> initial_context_snapshot) &#123;</span><br><span class="line">                <span class="keyword">if</span> (initial_context_snapshot.<span class="title function_">hasOwnProperty</span>(reg_name_orig)) &#123;</span><br><span class="line">                    <span class="keyword">const</span> reg_name_lower = reg_name_orig.<span class="title function_">toLowerCase</span>();</span><br><span class="line">                     <span class="keyword">if</span> (reg_name_lower !== <span class="string">&quot;pc&quot;</span> &amp;&amp; reg_name_lower !== <span class="string">&quot;sp&quot;</span> &amp;&amp; !reg_name_lower.<span class="title function_">startsWith</span>(<span class="string">&quot;q&quot;</span>) &amp;&amp; !reg_name_lower.<span class="title function_">startsWith</span>(<span class="string">&quot;v&quot;</span>)) &#123;</span><br><span class="line">                        local_pre_regs[reg_name_orig] = initial_context_snapshot[reg_name_orig];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// *** REMOVE THIS LINE *** this.local_pre_regs = local_pre_regs; </span></span><br><span class="line">            <span class="comment">// The variable &#x27;local_pre_regs&#x27; is already in scope for the transform/callout closures.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// === Patch known crashing instructions on entering the traced function ===</span></span><br><span class="line">            <span class="comment">// These addresses are relative to the module base address (current_module_baseaddr)</span></span><br><span class="line">            <span class="keyword">const</span> knownCrashOffsets = [<span class="number">0x48AC0</span>, <span class="number">0x4ABB8</span>]; <span class="comment">// List of known problematic instruction offsets</span></span><br><span class="line">            knownCrashOffsets.<span class="title function_">forEach</span>(<span class="function"><span class="params">offset</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> patchAddr = current_module_baseaddr.<span class="title function_">add</span>(offset);</span><br><span class="line">                    <span class="comment">// Read instruction bytes to verify it&#x27;s the expected &#x27;MOV WSP, #1&#x27;</span></span><br><span class="line">                    <span class="comment">// ARM64: MOV WSP, #1 is 320003FF (little endian)</span></span><br><span class="line">                    <span class="keyword">const</span> expectedBytes = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0x32</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>]);</span><br><span class="line">                    <span class="keyword">const</span> instrBytes = patchAddr.<span class="title function_">readByteArray</span>(<span class="number">4</span>);</span><br><span class="line">                    <span class="keyword">const</span> actualBytes = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(instrBytes);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">let</span> matchesExpected = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (actualBytes.<span class="property">length</span> === <span class="number">4</span>) &#123;</span><br><span class="line">                         <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">4</span>; i++) &#123;</span><br><span class="line">                              <span class="keyword">if</span> (actualBytes[i] !== expectedBytes[i]) &#123;</span><br><span class="line">                                   matchesExpected = <span class="literal">false</span>;</span><br><span class="line">                                   <span class="keyword">break</span>;</span><br><span class="line">                              &#125;</span><br><span class="line">                         &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         matchesExpected = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (matchesExpected) &#123;</span><br><span class="line">                         <span class="comment">// If it matches, NOP it</span></span><br><span class="line">                         <span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(patchAddr, <span class="number">4</span>, <span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">                             <span class="keyword">const</span> writer = <span class="keyword">new</span> <span class="title class_">Arm64Writer</span>(code, &#123; <span class="attr">pc</span>: patchAddr &#125;);</span><br><span class="line">                             writer.<span class="title function_">putNop</span>(); <span class="comment">// Replace the instruction with NOP</span></span><br><span class="line">                             writer.<span class="title function_">flush</span>();</span><br><span class="line">                         &#125;);</span><br><span class="line">                         <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[MemoryPatch] Stalker&#x27;s onEnter: NOPped known crash (MOV WSP, #1) at &quot;</span> + module_name + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(offset) + <span class="string">&quot; (&quot;</span>+ patchAddr + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         <span class="comment">// console.log(&quot;[MemoryPatch] Stalker&#x27;s onEnter: Instruction at &quot; + module_name + &quot;!&quot; + ptr(offset) + &quot; is not MOV WSP, #1. Bytes: &quot; + Array.from(actualBytes).map(b =&gt; b.toString(16).padStart(2,&#x27;0&#x27;)).join(&#x27;&#x27;)); // Optional log</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[MemoryPatch] Stalker&#x27;s onEnter: Error patching &quot;</span> + module_name + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(offset) + <span class="string">&quot;: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// ==================================================================</span></span><br><span class="line"></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">follow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>, &#123;</span><br><span class="line">                 <span class="comment">// Configure events to trace. exec=true traces every executed instruction.</span></span><br><span class="line">                <span class="attr">events</span>: &#123; <span class="attr">call</span>: <span class="literal">false</span>, <span class="attr">ret</span>: <span class="literal">false</span>, <span class="attr">exec</span>: <span class="literal">true</span>, <span class="attr">block</span>: <span class="literal">false</span>, <span class="attr">compile</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">                 <span class="comment">// The transform callback allows inspecting/rewriting instruction blocks</span></span><br><span class="line">                <span class="title function_">transform</span>(<span class="params">iterator</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> instruction = iterator.<span class="title function_">next</span>();</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="keyword">const</span> currentAddress = instruction.<span class="property">address</span>;</span><br><span class="line">                        <span class="keyword">let</span> patchedThisInstruction = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Check if the instruction is within the target module&#x27;s bounds</span></span><br><span class="line">                        <span class="keyword">const</span> is_module_code = currentAddress.<span class="title function_">compare</span>(module_start) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                               currentAddress.<span class="title function_">compare</span>(module_end) &lt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                         <span class="comment">// === Universal MOV WSP/SP, #1 detection and NOP logic ===</span></span><br><span class="line">                         <span class="comment">// This is a fallback/alternative to the onEnter patch</span></span><br><span class="line">                         <span class="comment">// It happens per block compiled by Stalker</span></span><br><span class="line">                        <span class="keyword">if</span> (is_module_code) &#123; <span class="comment">// Only patch instructions within the target module</span></span><br><span class="line">                            <span class="keyword">const</span> mnemonic = instruction.<span class="property">mnemonic</span>.<span class="title function_">toLowerCase</span>();</span><br><span class="line">                             <span class="comment">// Check for MOV or MOVZ with SP/WSP as destination and immediate 1</span></span><br><span class="line">                             <span class="keyword">if</span> ((mnemonic === <span class="string">&#x27;mov&#x27;</span> || mnemonic === <span class="string">&#x27;movz&#x27;</span>) &amp;&amp; instruction.<span class="property">operands</span>.<span class="property">length</span> &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                                 <span class="keyword">const</span> destOperand = instruction.<span class="property">operands</span>[<span class="number">0</span>];</span><br><span class="line">                                 <span class="keyword">const</span> srcOperand = instruction.<span class="property">operands</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                                 <span class="keyword">if</span> (destOperand.<span class="property">type</span> === <span class="string">&#x27;reg&#x27;</span> &amp;&amp;</span><br><span class="line">                                     (destOperand.<span class="property">value</span> === <span class="string">&#x27;wsp&#x27;</span> || destOperand.<span class="property">value</span> === <span class="string">&#x27;sp&#x27;</span> ||</span><br><span class="line">                                      destOperand.<span class="property">value</span> === <span class="string">&#x27;w31&#x27;</span> || destOperand.<span class="property">value</span> === <span class="string">&#x27;x31&#x27;</span>) &amp;&amp; <span class="comment">// w31/x31 are aliases for wsp/sp</span></span><br><span class="line">                                     srcOperand.<span class="property">type</span> === <span class="string">&#x27;imm&#x27;</span> &amp;&amp;</span><br><span class="line">                                     <span class="built_in">parseInt</span>(srcOperand.<span class="property">value</span>.<span class="title function_">toString</span>()) === <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">                                     <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[StalkerTransform] Identified potential crash instruction &#x27;&quot;</span> + instruction.<span class="title function_">toString</span>() + <span class="string">&quot;&#x27; at &quot;</span> + currentAddress + <span class="string">&quot;. Replacing with NOP.&quot;</span>);</span><br><span class="line">                                     iterator.<span class="title function_">putNop</span>(); <span class="comment">// Replace the instruction with NOP</span></span><br><span class="line">                                     patchedThisInstruction = <span class="literal">true</span>;</span><br><span class="line">                                 &#125;</span><br><span class="line">                             &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// =========================================================</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">// If the instruction wasn&#x27;t NOPped by the above check, add a callout for logging</span></span><br><span class="line">                        <span class="keyword">if</span> (!patchedThisInstruction) &#123;</span><br><span class="line">                            <span class="comment">// Only add callout for instructions within the target module</span></span><br><span class="line">                            <span class="keyword">if</span> (is_module_code) &#123;</span><br><span class="line">                                <span class="comment">// &#x27;local_pre_regs&#x27; is accessible here via closure</span></span><br><span class="line">                                iterator.<span class="title function_">putCallout</span>(<span class="keyword">function</span> (<span class="params">context</span>) &#123;</span><br><span class="line">                                    <span class="comment">// Access local_pre_regs directly from the outer scope (captured by closure)</span></span><br><span class="line">                                    <span class="keyword">const</span> thread_pre_regs = local_pre_regs; </span><br><span class="line">                                    <span class="keyword">const</span> pc = context.<span class="property">pc</span>;</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// Get the register differences after this instruction executes</span></span><br><span class="line">                                    <span class="comment">// get_diff_regs modifies thread_pre_regs in place</span></span><br><span class="line">                                    <span class="keyword">const</span> diff_regs = <span class="title function_">get_diff_regs</span>(context, thread_pre_regs);</span><br><span class="line">                                    </span><br><span class="line">                                    <span class="comment">// Find the module info again (can be optimized by caching, but this is reliable)</span></span><br><span class="line">                                    <span class="keyword">var</span> current_callout_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(pc);</span><br><span class="line"></span><br><span class="line">                                     <span class="comment">// Ensure we are logging code from the target module</span></span><br><span class="line">                                     <span class="keyword">if</span> (current_callout_module &amp;&amp; current_callout_module.<span class="property">name</span> === <span class="variable constant_">TARGET_MODULE_NAME</span>) &#123;</span><br><span class="line">                                         <span class="keyword">const</span> instrToLog = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(pc);</span><br><span class="line">                                         <span class="keyword">let</span> logLine = <span class="string">`<span class="subst">$&#123;current_callout_module.name&#125;</span>!<span class="subst">$&#123;pc.sub(current_callout_module.base)&#125;</span> <span class="subst">$&#123;instrToLog.toString()&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">                                         <span class="comment">// Append changed registers and potential strings</span></span><br><span class="line">                                         <span class="keyword">const</span> diffRegKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(diff_regs);</span><br><span class="line">                                         <span class="keyword">if</span> (diffRegKeys.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                              logLine += <span class="string">`\t\t| Changed Regs: `</span>;</span><br><span class="line">                                              <span class="keyword">let</span> firstReg = <span class="literal">true</span>;</span><br><span class="line">                                              <span class="keyword">for</span> (<span class="keyword">const</span> regName <span class="keyword">of</span> diffRegKeys) &#123;</span><br><span class="line">                                                   <span class="keyword">if</span> (!firstReg) logLine += <span class="string">&quot;, &quot;</span>;</span><br><span class="line">                                                   firstReg = <span class="literal">false</span>;</span><br><span class="line">                                                   <span class="keyword">const</span> regValue = diff_regs[regName]; <span class="comment">// The new value of the register</span></span><br><span class="line">                                                   logLine += <span class="string">`<span class="subst">$&#123;regName&#125;</span>=<span class="subst">$&#123;regValue&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">                                                   <span class="comment">// --- Check if the register value points to a string ---</span></span><br><span class="line">                                                   <span class="keyword">const</span> potentialString = <span class="title function_">tryReadString</span>(regValue);</span><br><span class="line">                                                   <span class="keyword">if</span> (potentialString !== <span class="literal">null</span>) &#123;</span><br><span class="line">                                                       <span class="comment">// Truncate long strings for readability</span></span><br><span class="line">                                                       <span class="keyword">const</span> displayString = potentialString.<span class="property">length</span> &gt; <span class="number">60</span> ? potentialString.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">57</span>) + <span class="string">&quot;...&quot;</span> : potentialString;</span><br><span class="line">                                                       <span class="comment">// Escape potential quotes in the string for cleaner output</span></span><br><span class="line">                                                       <span class="keyword">const</span> escapedString = displayString.<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;\\&quot;&#x27;</span>).<span class="title function_">replace</span>(<span class="regexp">/\n/g</span>, <span class="string">&#x27;\\n&#x27;</span>).<span class="title function_">replace</span>(<span class="regexp">/\r/g</span>, <span class="string">&#x27;\\r&#x27;</span>);</span><br><span class="line">                                                        logLine += <span class="string">` (&quot;<span class="subst">$&#123;escapedString&#125;</span>&quot;)`</span>;</span><br><span class="line">                                                   &#125;</span><br><span class="line">                                                   <span class="comment">// ----------------------------------------------------------</span></span><br><span class="line">                                              &#125;</span><br><span class="line">                                         &#125;</span><br><span class="line"></span><br><span class="line">                                         <span class="variable language_">console</span>.<span class="title function_">log</span>(logLine);</span><br><span class="line">                                     &#125;</span><br><span class="line">                                &#125;);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// Keep the original instruction</span></span><br><span class="line">                            iterator.<span class="title function_">keep</span>();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((instruction = iterator.<span class="title function_">next</span>()) !== <span class="literal">null</span>); <span class="comment">// Process next instruction in the block</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; onLeave, TID:&quot;</span>, <span class="variable language_">this</span>.<span class="property">tid</span>);</span><br><span class="line">             <span class="comment">// Stop stalking this thread when the function exits</span></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">unfollow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>);</span><br><span class="line">             <span class="comment">// Clean up Stalker&#x27;s compiled code cache</span></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">garbageCollect</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... (rest of the script remains the same)</span></span><br><span class="line"><span class="comment">// hook_linker_call_constructors();</span></span><br><span class="line"><span class="comment">// hook_target_func(base_addr); // Called from linker hook or fallback</span></span><br><span class="line"><span class="comment">// hook_pthread_create(); // Called from hook_target_func onLeave</span></span><br><span class="line"><span class="comment">// tryReadString() // Helper function defined above</span></span><br><span class="line"><span class="comment">// get_diff_regs() // Helper function defined above</span></span><br><span class="line"><span class="comment">// get_involved_regs() // Helper function defined above</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> offset = <span class="number">0x88060</span>;</span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>; <span class="comment">// Will be populated when module is found</span></span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> base_addr = <span class="literal">null</span>; <span class="comment">// To store the base address of libbaiduprotect.so</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an empty function</span></span><br><span class="line"><span class="keyword">var</span> empty_func = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// console.log(&quot;[Anti-Debug] Empty function executed.&quot;); // Optional log</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- Helper function to attempt reading a string ---</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">tryReadString</span>(<span class="params">address, minPrintableBytes = <span class="number">3</span>, maxReadLength = <span class="number">256</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!address) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// Cannot read from null address</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Step 1: Read the first few bytes to see if they look like printable ASCII</span></span><br><span class="line">        <span class="keyword">const</span> preliminaryBytes = address.<span class="title function_">readByteArray</span>(minPrintableBytes);</span><br><span class="line">        <span class="keyword">if</span> (!preliminaryBytes) &#123;</span><br><span class="line">             <span class="comment">// Can&#x27;t read the initial bytes (e.g., invalid address)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> uint8Array = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(preliminaryBytes);</span><br><span class="line">        <span class="keyword">let</span> allPrintable = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; uint8Array.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> byte = uint8Array[i];</span><br><span class="line">            <span class="comment">// Basic check for printable ASCII (0x20 to 0x7E)</span></span><br><span class="line">            <span class="keyword">if</span> (byte &lt; <span class="number">0x20</span> || byte &gt; <span class="number">0x7E</span>) &#123;</span><br><span class="line">                allPrintable = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (allPrintable) &#123;</span><br><span class="line">            <span class="comment">// Step 2: If they look printable, attempt to read a C-string</span></span><br><span class="line">            <span class="comment">// readCString reads until null terminator or max length</span></span><br><span class="line">            <span class="keyword">const</span> str = address.<span class="title function_">readCString</span>(maxReadLength);</span><br><span class="line">             <span class="comment">// Filter out empty strings or strings that only contained non-null printable chars but no null terminator early on</span></span><br><span class="line">            <span class="keyword">if</span> (str &amp;&amp; str.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> str;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="comment">// Reading failed (e.g., invalid memory access)</span></span><br><span class="line">        <span class="comment">// console.warn(&quot;[-] Failed to read memory at &quot; + address + &quot; for string check: &quot; + e.message); // Optional: Log errors</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// Did not pass the checks or failed to read</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 为提高健壮性，建议使用更完善的 linker 及 call_constructors 查找逻辑</span></span><br><span class="line">    <span class="comment">// 但为保持与你原始脚本的结构，暂时保留这种直接方式</span></span><br><span class="line">    <span class="keyword">let</span> linker_module_name = <span class="title class_">Process</span>.<span class="property">arch</span> === <span class="string">&#x27;arm64&#x27;</span> ? <span class="string">&#x27;linker64&#x27;</span> : <span class="string">&#x27;linker&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(linker_module_name);</span><br><span class="line">    <span class="keyword">if</span> (!linker64_base_addr) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] Failed to get &quot;</span> + linker_module_name + <span class="string">&quot; base address. Trying to find module directly later.&quot;</span>);</span><br><span class="line">        <span class="comment">// Fallback if linker not found</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!base_addr) &#123; <span class="comment">// Check if already found</span></span><br><span class="line">                <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">                <span class="keyword">if</span> (secmodule) &#123;</span><br><span class="line">                    base_addr = secmodule.<span class="property">base</span>;</span><br><span class="line">                    module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot; base (fallback): &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                    <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] &quot;</span> + module_name + <span class="string">&quot; not found via fallback. Cannot proceed.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1500</span>); <span class="comment">// Delay slightly</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> This offset is highly dependent on the system/Android version and linker variant!</span></span><br><span class="line">    <span class="comment">// A more robust approach would involve scanning for the function signature.</span></span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// Example: __dl__ZN6soinfo17call_constructorsEv on some systems</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Attempting to attach to linker&#x27;s call_constructors at &quot;</span> + call_constructors);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="comment">// console.log(&#x27;[linker] Call_Constructors onEnter&#x27;);</span></span><br><span class="line">                <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">                <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (base_addr === <span class="literal">null</span>) &#123; <span class="comment">// Ensure initialized only once</span></span><br><span class="line">                        module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                        base_addr = secmodule.<span class="property">base</span>; <span class="comment">// Save the base address</span></span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot; base: &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// *** Consider patching known points here or within Stalker ***</span></span><br><span class="line">                        <span class="comment">// Patching here happens earlier, might be safer for some anti-debug</span></span><br><span class="line">                        <span class="comment">// patchInstructionToNop(base_addr, 0x48AC0, 4); // Example offset</span></span><br><span class="line">                        <span class="comment">// patchInstructionToNop(base_addr, 0x4ABB8, 4); // Example offset</span></span><br><span class="line"></span><br><span class="line">                        <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                        listener.<span class="title function_">detach</span>(); <span class="comment">// Detach once the module is found</span></span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Detached from linker hook.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// No onLeave needed for just finding the module base</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Failed to attach to linker&#x27;s call_constructors: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    Will rely on fallback to find module &quot;</span> + module_name);</span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="comment">// Similar fallback logic as above</span></span><br><span class="line">              <span class="keyword">if</span> (!base_addr) &#123;</span><br><span class="line">                  <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">                  <span class="keyword">if</span> (secmodule) &#123;</span><br><span class="line">                      base_addr = secmodule.<span class="property">base</span>;</span><br><span class="line">                      module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                      <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot; base (fallback after attach error): &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                      <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Fallback after attach error: &quot;</span> + module_name + <span class="string">&quot; not found.&quot;</span>);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;, <span class="number">1500</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">current_base_addr</span>) &#123; <span class="comment">// Use current_base_addr to distinguish from global base_addr</span></span><br><span class="line">    <span class="keyword">if</span> (!current_base_addr || current_base_addr.<span class="title function_">isNull</span>())&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] hook_target_func: current_base_addr is invalid.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> target_addr = current_base_addr.<span class="title function_">add</span>(offset); <span class="comment">// offset = 0x88060</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking target function at &quot;</span> + target_addr + <span class="string">&quot; (offset 0x&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Use attachOnce if you only need it to trigger once</span></span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Target function &quot;</span> + module_name + <span class="string">&quot;!0x&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; entered. Called from: &quot;</span> + <span class="variable language_">this</span>.<span class="property">returnAddress</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(module_name + <span class="string">&quot;!0x&quot;</span> + offset.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; onLeave. Base address: &quot;</span> + current_base_addr);</span><br><span class="line">                <span class="comment">// IMPORTANT: Use the global base_addr here as it should be set by now and is needed by StalkerTrace/pthread hook</span></span><br><span class="line">                <span class="keyword">if</span> (base_addr &amp;&amp; !base_addr.<span class="title function_">isNull</span>()) &#123; </span><br><span class="line">                    <span class="title function_">hook_pthread_create</span>();</span><br><span class="line">                    <span class="title class_">StalkerTrace</span>(base_addr); <span class="comment">// Pass the correct module base address to StalkerTrace</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Global base_addr not set in hook_target_func onLeave. Cannot start Stalker / pthread hook.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                 <span class="comment">// No need to detach here if using attachOnce, but if using attach, you might detach</span></span><br><span class="line">                 <span class="comment">// listener.detach();</span></span><br><span class="line">                 <span class="comment">// console.log(&quot;[i] Detached from target_func hook at &quot; + target_addr);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">         <span class="comment">// Note: Interceptor.attachOnce is often better if you only need the onLeave logic once</span></span><br><span class="line">         <span class="comment">// However, let&#x27;s stick to attach and detach in onLeave for now based on your original code structure.</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Failed to attach to target_func at &quot;</span> + target_addr + <span class="string">&quot;: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthread_create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Ensure base_addr is set before hooking pthread_create as it&#x27;s needed for comparison</span></span><br><span class="line">    <span class="keyword">if</span> (!base_addr || base_addr.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] hook_pthread_create: Global base_addr is null. Skipping hook.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> pthread_create_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pthread_create_addr) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking pthread_create at &quot;</span> + pthread_create_addr);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create_addr, &#123;</span><br><span class="line">                <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                    <span class="comment">// pthread_create signature:</span></span><br><span class="line">                    <span class="comment">// int pthread_create(pthread_t *thread, const pthread_attr_t *attr, void *(*start_routine) (void *), void *arg);</span></span><br><span class="line">                    <span class="comment">// start_routine is the 3rd argument (index 2)</span></span><br><span class="line">                    <span class="keyword">let</span> func_addr = args[<span class="number">2</span>]; </span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Target function address within libbaiduprotect.so</span></span><br><span class="line">                    <span class="comment">// This offset (0x3E9F0) might also need dynamic finding</span></span><br><span class="line">                    <span class="keyword">let</span> target_func_offset_pthread = <span class="number">0x3E9F0</span>; </span><br><span class="line">                    <span class="keyword">let</span> target_func_addr = base_addr.<span class="title function_">add</span>(target_func_offset_pthread);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Check if the thread being created is the one we want to intercept</span></span><br><span class="line">                    <span class="keyword">if</span> (func_addr.<span class="title function_">equals</span>(target_func_addr)) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Anti-Debug] Replacing thread start_routine &quot;</span> + func_addr + <span class="string">&quot; with empty function.&quot;</span>);</span><br><span class="line">                        <span class="comment">// Replace the actual start routine pointer with our empty function&#x27;s pointer</span></span><br><span class="line">                        args[<span class="number">2</span>] = empty_func; </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] Failed to attach to pthread_create: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[-] pthread_create not found in libc.so. Hook skipped.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">TARGET_MODULE_NAME</span> = <span class="string">&quot;libbaiduprotect.so&quot;</span>; <span class="comment">// Same as module_name for clarity with Stalker</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_diff_regs</span>(<span class="params">context, pre_regs</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> diff_regs = &#123;&#125;;</span><br><span class="line">    <span class="comment">// Create a snapshot of the current context&#x27;s general-purpose registers</span></span><br><span class="line">    <span class="keyword">const</span> current_regs_snapshot = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(context)); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Iterate through the original register names from the snapshot</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> reg_name_orig <span class="keyword">in</span> current_regs_snapshot) &#123;</span><br><span class="line">        <span class="comment">// Ensure it&#x27;s a direct property, not inherited</span></span><br><span class="line">        <span class="keyword">if</span> (current_regs_snapshot.<span class="title function_">hasOwnProperty</span>(reg_name_orig)) &#123;</span><br><span class="line">            <span class="keyword">const</span> reg_name_lower = reg_name_orig.<span class="title function_">toLowerCase</span>();</span><br><span class="line">            <span class="comment">// Filter out PC, SP, and floating-point/vector registers (q* or v*)</span></span><br><span class="line">            <span class="keyword">if</span> (reg_name_lower !== <span class="string">&quot;pc&quot;</span> &amp;&amp; reg_name_lower !== <span class="string">&quot;sp&quot;</span> &amp;&amp; !reg_name_lower.<span class="title function_">startsWith</span>(<span class="string">&quot;q&quot;</span>) &amp;&amp; !reg_name_lower.<span class="title function_">startsWith</span>(<span class="string">&quot;v&quot;</span>)) &#123; </span><br><span class="line">                <span class="comment">// Compare with the previous snapshot</span></span><br><span class="line">                <span class="keyword">if</span> (pre_regs[reg_name_orig] !== current_regs_snapshot[reg_name_orig]) &#123;</span><br><span class="line">                    <span class="comment">// If the value has changed, update the previous snapshot and record the difference</span></span><br><span class="line">                    pre_regs[reg_name_orig] = current_regs_snapshot[reg_name_orig];</span><br><span class="line">                    diff_regs[reg_name_orig] = current_regs_snapshot[reg_name_orig]; <span class="comment">// Store the NEW value</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> diff_regs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This function is defined but not currently used in the logging. Keeping it as it was in the original code.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_involved_regs</span>(<span class="params">instruction</span>) &#123; </span><br><span class="line">    <span class="keyword">const</span> involved_regs = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">    instruction.<span class="property">operands</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">op</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (op.<span class="property">type</span> === <span class="string">&#x27;reg&#x27;</span>) &#123; involved_regs.<span class="title function_">add</span>(op.<span class="property">value</span>); &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (op.<span class="property">type</span> === <span class="string">&#x27;mem&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (op.<span class="property">value</span>.<span class="property">base</span>) &#123; involved_regs.<span class="title function_">add</span>(op.<span class="property">value</span>.<span class="property">base</span>); &#125;</span><br><span class="line">            <span class="keyword">if</span> (op.<span class="property">value</span>.<span class="property">index</span>) &#123; involved_regs.<span class="title function_">add</span>(op.<span class="property">value</span>.<span class="property">index</span>); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(involved_regs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =======================================================================================</span></span><br><span class="line"><span class="comment">// Modified StalkerTrace Function (FIXED local_pre_regs access)</span></span><br><span class="line"><span class="comment">// =======================================================================================</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">StalkerTrace</span>(<span class="params">current_module_baseaddr</span>) &#123; <span class="comment">// Ensure the correct module base address is passed</span></span><br><span class="line">    <span class="comment">// Use the global module_size which should be set by now</span></span><br><span class="line">    <span class="keyword">if</span> (!current_module_baseaddr || current_module_baseaddr.<span class="title function_">isNull</span>() || module_size === <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] StalkerTrace: Invalid module base address or size. Cannot proceed.&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> stalker_target_func_offset = <span class="number">0x4a458</span>; <span class="comment">// The offset of the function you want Stalker to trace</span></span><br><span class="line">    <span class="keyword">var</span> stalker_start_addr = current_module_baseaddr.<span class="title function_">add</span>(stalker_target_func_offset);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] StalkerTrace will target &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; at actual address: &quot;</span> + stalker_start_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define the module bounds for Stalker logging</span></span><br><span class="line">    <span class="keyword">const</span> module_start = current_module_baseaddr;</span><br><span class="line">    <span class="keyword">const</span> module_end = current_module_baseaddr.<span class="title function_">add</span>(module_size);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Stalker module bounds: Start=&quot;</span> + module_start + <span class="string">&quot;, End=&quot;</span> + module_end);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(stalker_start_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="comment">// Stalker operates per thread. Get the current thread ID.</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">tid</span> = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Stalker: Entered &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; (TID: &quot;</span> + <span class="variable language_">this</span>.<span class="property">tid</span> + <span class="string">&quot;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize previous register state *for this specific thread*.</span></span><br><span class="line">            <span class="comment">// This variable is local to this onEnter call but will be captured by the closure.</span></span><br><span class="line">            <span class="keyword">const</span> local_pre_regs = &#123;&#125;; </span><br><span class="line">            <span class="comment">// Populate initial state, excluding filtered registers</span></span><br><span class="line">            <span class="keyword">const</span> initial_context_snapshot = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">context</span>));</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> reg_name_orig <span class="keyword">in</span> initial_context_snapshot) &#123;</span><br><span class="line">                <span class="keyword">if</span> (initial_context_snapshot.<span class="title function_">hasOwnProperty</span>(reg_name_orig)) &#123;</span><br><span class="line">                    <span class="keyword">const</span> reg_name_lower = reg_name_orig.<span class="title function_">toLowerCase</span>();</span><br><span class="line">                     <span class="keyword">if</span> (reg_name_lower !== <span class="string">&quot;pc&quot;</span> &amp;&amp; reg_name_lower !== <span class="string">&quot;sp&quot;</span> &amp;&amp; !reg_name_lower.<span class="title function_">startsWith</span>(<span class="string">&quot;q&quot;</span>) &amp;&amp; !reg_name_lower.<span class="title function_">startsWith</span>(<span class="string">&quot;v&quot;</span>)) &#123;</span><br><span class="line">                        local_pre_regs[reg_name_orig] = initial_context_snapshot[reg_name_orig];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// *** REMOVE THIS LINE *** this.local_pre_regs = local_pre_regs; </span></span><br><span class="line">            <span class="comment">// The variable &#x27;local_pre_regs&#x27; is already in scope for the transform/callout closures.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// === Patch known crashing instructions on entering the traced function ===</span></span><br><span class="line">            <span class="comment">// These addresses are relative to the module base address (current_module_baseaddr)</span></span><br><span class="line">            <span class="keyword">const</span> knownCrashOffsets = [<span class="number">0x48AC0</span>, <span class="number">0x4ABB8</span>]; <span class="comment">// List of known problematic instruction offsets</span></span><br><span class="line">            knownCrashOffsets.<span class="title function_">forEach</span>(<span class="function"><span class="params">offset</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> patchAddr = current_module_baseaddr.<span class="title function_">add</span>(offset);</span><br><span class="line">                    <span class="comment">// Read instruction bytes to verify it&#x27;s the expected &#x27;MOV WSP, #1&#x27;</span></span><br><span class="line">                    <span class="comment">// ARM64: MOV WSP, #1 is 320003FF (little endian)</span></span><br><span class="line">                    <span class="keyword">const</span> expectedBytes = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0x32</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>]);</span><br><span class="line">                    <span class="keyword">const</span> instrBytes = patchAddr.<span class="title function_">readByteArray</span>(<span class="number">4</span>);</span><br><span class="line">                    <span class="keyword">const</span> actualBytes = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(instrBytes);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">let</span> matchesExpected = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (actualBytes.<span class="property">length</span> === <span class="number">4</span>) &#123;</span><br><span class="line">                         <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">4</span>; i++) &#123;</span><br><span class="line">                              <span class="keyword">if</span> (actualBytes[i] !== expectedBytes[i]) &#123;</span><br><span class="line">                                   matchesExpected = <span class="literal">false</span>;</span><br><span class="line">                                   <span class="keyword">break</span>;</span><br><span class="line">                              &#125;</span><br><span class="line">                         &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         matchesExpected = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (matchesExpected) &#123;</span><br><span class="line">                         <span class="comment">// If it matches, NOP it</span></span><br><span class="line">                         <span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(patchAddr, <span class="number">4</span>, <span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">                             <span class="keyword">const</span> writer = <span class="keyword">new</span> <span class="title class_">Arm64Writer</span>(code, &#123; <span class="attr">pc</span>: patchAddr &#125;);</span><br><span class="line">                             writer.<span class="title function_">putNop</span>(); <span class="comment">// Replace the instruction with NOP</span></span><br><span class="line">                             writer.<span class="title function_">flush</span>();</span><br><span class="line">                         &#125;);</span><br><span class="line">                         <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[MemoryPatch] Stalker&#x27;s onEnter: NOPped known crash (MOV WSP, #1) at &quot;</span> + module_name + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(offset) + <span class="string">&quot; (&quot;</span>+ patchAddr + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         <span class="comment">// console.log(&quot;[MemoryPatch] Stalker&#x27;s onEnter: Instruction at &quot; + module_name + &quot;!&quot; + ptr(offset) + &quot; is not MOV WSP, #1. Bytes: &quot; + Array.from(actualBytes).map(b =&gt; b.toString(16).padStart(2,&#x27;0&#x27;)).join(&#x27;&#x27;)); // Optional log</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[MemoryPatch] Stalker&#x27;s onEnter: Error patching &quot;</span> + module_name + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(offset) + <span class="string">&quot;: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// ==================================================================</span></span><br><span class="line"></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">follow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>, &#123;</span><br><span class="line">                 <span class="comment">// Configure events to trace. exec=true traces every executed instruction.</span></span><br><span class="line">                <span class="attr">events</span>: &#123; <span class="attr">call</span>: <span class="literal">false</span>, <span class="attr">ret</span>: <span class="literal">false</span>, <span class="attr">exec</span>: <span class="literal">true</span>, <span class="attr">block</span>: <span class="literal">false</span>, <span class="attr">compile</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">                 <span class="comment">// The transform callback allows inspecting/rewriting instruction blocks</span></span><br><span class="line">                <span class="title function_">transform</span>(<span class="params">iterator</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> instruction = iterator.<span class="title function_">next</span>();</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="keyword">const</span> currentAddress = instruction.<span class="property">address</span>;</span><br><span class="line">                        <span class="keyword">let</span> patchedThisInstruction = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Check if the instruction is within the target module&#x27;s bounds</span></span><br><span class="line">                        <span class="keyword">const</span> is_module_code = currentAddress.<span class="title function_">compare</span>(module_start) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                               currentAddress.<span class="title function_">compare</span>(module_end) &lt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                         <span class="comment">// === Universal MOV WSP/SP, #1 detection and NOP logic ===</span></span><br><span class="line">                         <span class="comment">// This is a fallback/alternative to the onEnter patch</span></span><br><span class="line">                         <span class="comment">// It happens per block compiled by Stalker</span></span><br><span class="line">                        <span class="keyword">if</span> (is_module_code) &#123; <span class="comment">// Only patch instructions within the target module</span></span><br><span class="line">                            <span class="keyword">const</span> mnemonic = instruction.<span class="property">mnemonic</span>.<span class="title function_">toLowerCase</span>();</span><br><span class="line">                             <span class="comment">// Check for MOV or MOVZ with SP/WSP as destination and immediate 1</span></span><br><span class="line">                             <span class="keyword">if</span> ((mnemonic === <span class="string">&#x27;mov&#x27;</span> || mnemonic === <span class="string">&#x27;movz&#x27;</span>) &amp;&amp; instruction.<span class="property">operands</span>.<span class="property">length</span> &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                                 <span class="keyword">const</span> destOperand = instruction.<span class="property">operands</span>[<span class="number">0</span>];</span><br><span class="line">                                 <span class="keyword">const</span> srcOperand = instruction.<span class="property">operands</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                                 <span class="keyword">if</span> (destOperand.<span class="property">type</span> === <span class="string">&#x27;reg&#x27;</span> &amp;&amp;</span><br><span class="line">                                     (destOperand.<span class="property">value</span> === <span class="string">&#x27;wsp&#x27;</span> || destOperand.<span class="property">value</span> === <span class="string">&#x27;sp&#x27;</span> ||</span><br><span class="line">                                      destOperand.<span class="property">value</span> === <span class="string">&#x27;w31&#x27;</span> || destOperand.<span class="property">value</span> === <span class="string">&#x27;x31&#x27;</span>) &amp;&amp; <span class="comment">// w31/x31 are aliases for wsp/sp</span></span><br><span class="line">                                     srcOperand.<span class="property">type</span> === <span class="string">&#x27;imm&#x27;</span> &amp;&amp;</span><br><span class="line">                                     <span class="built_in">parseInt</span>(srcOperand.<span class="property">value</span>.<span class="title function_">toString</span>()) === <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">                                     <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;[StalkerTransform] Identified potential crash instruction &#x27;&quot;</span> + instruction.<span class="title function_">toString</span>() + <span class="string">&quot;&#x27; at &quot;</span> + currentAddress + <span class="string">&quot;. Replacing with NOP.&quot;</span>);</span><br><span class="line">                                     iterator.<span class="title function_">putNop</span>(); <span class="comment">// Replace the instruction with NOP</span></span><br><span class="line">                                     patchedThisInstruction = <span class="literal">true</span>;</span><br><span class="line">                                 &#125;</span><br><span class="line">                             &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// =========================================================</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">// If the instruction wasn&#x27;t NOPped by the above check, add a callout for logging</span></span><br><span class="line">                        <span class="keyword">if</span> (!patchedThisInstruction) &#123;</span><br><span class="line">                            <span class="comment">// Only add callout for instructions within the target module</span></span><br><span class="line">                            <span class="keyword">if</span> (is_module_code) &#123;</span><br><span class="line">                                <span class="comment">// &#x27;local_pre_regs&#x27; is accessible here via closure</span></span><br><span class="line">                                iterator.<span class="title function_">putCallout</span>(<span class="keyword">function</span> (<span class="params">context</span>) &#123;</span><br><span class="line">                                    <span class="comment">// Access local_pre_regs directly from the outer scope (captured by closure)</span></span><br><span class="line">                                    <span class="keyword">const</span> thread_pre_regs = local_pre_regs; </span><br><span class="line">                                    <span class="keyword">const</span> pc = context.<span class="property">pc</span>;</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// Get the register differences after this instruction executes</span></span><br><span class="line">                                    <span class="comment">// get_diff_regs modifies thread_pre_regs in place</span></span><br><span class="line">                                    <span class="keyword">const</span> diff_regs = <span class="title function_">get_diff_regs</span>(context, thread_pre_regs);</span><br><span class="line">                                    </span><br><span class="line">                                    <span class="comment">// Find the module info again (can be optimized by caching, but this is reliable)</span></span><br><span class="line">                                    <span class="keyword">var</span> current_callout_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(pc);</span><br><span class="line"></span><br><span class="line">                                     <span class="comment">// Ensure we are logging code from the target module</span></span><br><span class="line">                                     <span class="keyword">if</span> (current_callout_module &amp;&amp; current_callout_module.<span class="property">name</span> === <span class="variable constant_">TARGET_MODULE_NAME</span>) &#123;</span><br><span class="line">                                         <span class="keyword">const</span> instrToLog = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(pc);</span><br><span class="line">                                         <span class="keyword">let</span> logLine = <span class="string">`<span class="subst">$&#123;current_callout_module.name&#125;</span>!<span class="subst">$&#123;pc.sub(current_callout_module.base)&#125;</span> <span class="subst">$&#123;instrToLog.toString()&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">                                         <span class="comment">// Append changed registers and potential strings</span></span><br><span class="line">                                         <span class="keyword">const</span> diffRegKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(diff_regs);</span><br><span class="line">                                         <span class="keyword">if</span> (diffRegKeys.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                              logLine += <span class="string">`\t\t| Changed Regs: `</span>;</span><br><span class="line">                                              <span class="keyword">let</span> firstReg = <span class="literal">true</span>;</span><br><span class="line">                                              <span class="keyword">for</span> (<span class="keyword">const</span> regName <span class="keyword">of</span> diffRegKeys) &#123;</span><br><span class="line">                                                   <span class="keyword">if</span> (!firstReg) logLine += <span class="string">&quot;, &quot;</span>;</span><br><span class="line">                                                   firstReg = <span class="literal">false</span>;</span><br><span class="line">                                                   <span class="keyword">const</span> regValue = diff_regs[regName]; <span class="comment">// The new value of the register</span></span><br><span class="line">                                                   logLine += <span class="string">`<span class="subst">$&#123;regName&#125;</span>=<span class="subst">$&#123;regValue&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">                                                   <span class="comment">// --- Check if the register value points to a string ---</span></span><br><span class="line">                                                   <span class="keyword">const</span> potentialString = <span class="title function_">tryReadString</span>(regValue);</span><br><span class="line">                                                   <span class="keyword">if</span> (potentialString !== <span class="literal">null</span>) &#123;</span><br><span class="line">                                                       <span class="comment">// Truncate long strings for readability</span></span><br><span class="line">                                                       <span class="keyword">const</span> displayString = potentialString.<span class="property">length</span> &gt; <span class="number">60</span> ? potentialString.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">57</span>) + <span class="string">&quot;...&quot;</span> : potentialString;</span><br><span class="line">                                                       <span class="comment">// Escape potential quotes in the string for cleaner output</span></span><br><span class="line">                                                       <span class="keyword">const</span> escapedString = displayString.<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;\\&quot;&#x27;</span>).<span class="title function_">replace</span>(<span class="regexp">/\n/g</span>, <span class="string">&#x27;\\n&#x27;</span>).<span class="title function_">replace</span>(<span class="regexp">/\r/g</span>, <span class="string">&#x27;\\r&#x27;</span>);</span><br><span class="line">                                                        logLine += <span class="string">` (&quot;<span class="subst">$&#123;escapedString&#125;</span>&quot;)`</span>;</span><br><span class="line">                                                   &#125;</span><br><span class="line">                                                   <span class="comment">// ----------------------------------------------------------</span></span><br><span class="line">                                              &#125;</span><br><span class="line">                                         &#125;</span><br><span class="line"></span><br><span class="line">                                         <span class="variable language_">console</span>.<span class="title function_">log</span>(logLine);</span><br><span class="line">                                     &#125;</span><br><span class="line">                                &#125;);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// Keep the original instruction</span></span><br><span class="line">                            iterator.<span class="title function_">keep</span>();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((instruction = iterator.<span class="title function_">next</span>()) !== <span class="literal">null</span>); <span class="comment">// Process next instruction in the block</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span> + <span class="variable constant_">TARGET_MODULE_NAME</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(stalker_target_func_offset) + <span class="string">&quot; onLeave, TID:&quot;</span>, <span class="variable language_">this</span>.<span class="property">tid</span>);</span><br><span class="line">             <span class="comment">// Stop stalking this thread when the function exits</span></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">unfollow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>);</span><br><span class="line">             <span class="comment">// Clean up Stalker&#x27;s compiled code cache</span></span><br><span class="line">            <span class="title class_">Stalker</span>.<span class="title function_">garbageCollect</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start the script execution by hooking the linker</span></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Script starting for &quot;</span> + module_name + <span class="string">&quot;...&quot;</span>);</span><br><span class="line">    <span class="title function_">hook_linker_call_constructors</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Script loaded. Waiting for &quot;</span> + module_name + <span class="string">&quot; to be loaded...&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>接下来又遇到一个问题，在trace到sub_5AE5C内部的时候，会在随机某处地址断开trace。由于是随机断开的，没搞清楚到底是为什么？头疼。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516124234164.png" alt="image-20250516124234164" style="zoom:67%;" />

<p>先通过下面这个脚本，hook上了sub_5AE5C，跑起来没问题。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> offset = <span class="number">0x88060</span>;</span><br><span class="line"><span class="keyword">var</span> module_size = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libbaiduprotect.so&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> base_addr = <span class="literal">null</span>; <span class="comment">// To store the base address of libbaiduprotect.so</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an empty function</span></span><br><span class="line"><span class="keyword">var</span> empty_func = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[linker] Call_Constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(module_name);</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                module_size = secmodule.<span class="property">size</span>;</span><br><span class="line">                base_addr = secmodule.<span class="property">base</span>; <span class="comment">// Save the base address</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libbaiduprotect.so base: &quot;</span> + base_addr + <span class="string">&quot;, size: &quot;</span> + module_size);</span><br><span class="line">                <span class="title function_">hook_target_func</span>(base_addr);</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> target_addr = baseaddr.<span class="title function_">add</span>(offset);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Target function at &quot;</span> + target_addr + <span class="string">&quot; entered&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libbaiduprotect.so base address: &quot;</span> + baseaddr);</span><br><span class="line">            <span class="title function_">hook_pthread_create</span>();</span><br><span class="line">            <span class="title function_">hook_sub_5ae5c</span>(baseaddr); <span class="comment">// Hook sub_5AE5C after target function</span></span><br><span class="line">            listener.<span class="title function_">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthread_create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> pthread_create_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> func_addr = args[<span class="number">2</span>];</span><br><span class="line">            <span class="keyword">let</span> target_func_addr = base_addr.<span class="title function_">add</span>(<span class="number">0x3E9F0</span>); <span class="comment">// Calculate the target function address</span></span><br><span class="line">            <span class="keyword">if</span> (func_addr.<span class="title function_">equals</span>(target_func_addr)) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Replacing func_addr &quot;</span> + func_addr + <span class="string">&quot; with empty function&quot;</span>);</span><br><span class="line">                args[<span class="number">2</span>] = empty_func; <span class="comment">// Replace with the empty function</span></span><br><span class="line">                <span class="comment">// hook_libart(); // Commented out as it was not provided</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(func_addr);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">module</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span> === module_name) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create called in libbaiduprotect.so, function address: &quot;</span> + func_addr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="comment">// Optionally log return value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_5ae5c</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!baseaddr || baseaddr.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[-] hook_sub_5ae5c: Invalid base address. Cannot proceed.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> target_addr = baseaddr.<span class="title function_">add</span>(<span class="number">0x5AE5C</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking sub_5AE5C at &quot;</span> + target_addr);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[sub_5AE5C] onEnter&quot;</span>);</span><br><span class="line">            <span class="comment">// Dump args[0] (pointer to _QWORD)</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!args[<span class="number">0</span>].<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[0] (*_QWORD at &quot;</span> + args[<span class="number">0</span>] + <span class="string">&quot;):&quot;</span>);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">0</span>], &#123; <span class="attr">length</span>: <span class="number">64</span>, <span class="attr">ansi</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;args[0] is null&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;Failed to hexdump args[0]: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Dump args[2] (data + 8)</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!args[<span class="number">2</span>].<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[2] (data + 8 at &quot;</span> + args[<span class="number">2</span>] + <span class="string">&quot;):&quot;</span>);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">2</span>], &#123; <span class="attr">length</span>: <span class="number">64</span>, <span class="attr">ansi</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;args[2] is null&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;Failed to hexdump args[2]: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Store pointers for comparison in onLeave</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[sub_5AE5C] onLeave, Return value: &quot;</span> + retval);</span><br><span class="line">            <span class="comment">// Dump args[0] again to check for changes</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">arg0</span>.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[0] (*_QWORD at &quot;</span> + <span class="variable language_">this</span>.<span class="property">arg0</span> + <span class="string">&quot;) after execution:&quot;</span>);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>, &#123; <span class="attr">length</span>: <span class="number">64</span>, <span class="attr">ansi</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;args[0] is null in onLeave&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;Failed to hexdump args[0] in onLeave: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Dump args[2] again to check for changes</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">arg2</span>.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[2] (data + 8 at &quot;</span> + <span class="variable language_">this</span>.<span class="property">arg2</span> + <span class="string">&quot;) after execution:&quot;</span>);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg2</span>, &#123; <span class="attr">length</span>: <span class="number">64</span>, <span class="attr">ansi</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;args[2] is null in onLeave&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;Failed to hexdump args[2] in onLeave: &quot;</span> + e.<span class="property">message</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Script starting for &quot;</span> + module_name + <span class="string">&quot;...&quot;</span>);</span><br><span class="line">    <span class="title function_">hook_linker_call_constructors</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[i] Script loaded. Waiting for &quot;</span> + module_name + <span class="string">&quot; to be loaded...&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>可以看到，after execution的args[2]中，存放的内容是一大片地址，将这些地址减去libbaiduprotect.so的基地址，可以发现这些地址都是vmp__funcs_256这个表上的地址。也就是说，经过函数sub_5ae5c，会从第一个参数中，获得到实现JNI函数所需要的的vmp指令集合列表。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516152914009.png" alt="image-20250516152914009"></p>
<p>既然trace不了函数5ae5c，那就从sub_5ae5c的汇编代码分析吧。</p>
<p>基本块1。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516164415682.png" alt="image-20250516164415682"></p>
<p>基本块2。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516164434265.png" alt="image-20250516164434265"></p>
<p>基本块3。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516164454468.png" alt="image-20250516164454468"></p>
<p>基本块4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516164512194.png" alt="image-20250516164512194"></p>
<p>基本块5。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516164532311.png" alt="image-20250516164532311"></p>
<p>基本块6。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516191356570.png" alt="image-20250516191356570"></p>
<p>基本块7。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516172701443.png" alt="image-20250516172701443" style="zoom:80%;" />

<p>基本块7的下一个块又是基本块4，也就是说，将上述流程写成伪代码的话，如下所示。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> index = <span class="number">0</span>; index &lt; <span class="number">256</span>; index++)&#123;</span><br><span class="line">	a2 + (*(((byte*)a0) + <span class="number">64</span> + index*<span class="number">4</span>)) * <span class="number">8</span> = *(a1 + index*<span class="number">8</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和ida做一个对比，会发现ida的伪代码看不懂。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516192214983.png" alt="image-20250516192214983"></p>
<p>通过这个伪代码，我们可以得知，a0是一个已知的数据源，它的64字节大小的offset偏移处，存放着解密后的vmp_code映射表，比方说，读取一个 a0 + 64 + index*4，命名为v1，然后将vmp_funcs_list的从0到255，把每一个元素，依次赋给 v1*8 + a2 的内存地址上，注意，这里的v1并不是逐增的。</p>
<p>↑我把我的表述扔给gemini，哈哈哈，得到认可了，看来没分析错。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516193401944.png" alt="image-20250516193401944"></p>
<p>我将函数sub_5ae5c命名为：from_DecodeVmpCode_map_to_SimulateSmaliCode。</p>
<p>分析完它之后，不妨再分析sub_4A458，我想分析vmp_explain传入的参数的含义是什么。</p>
<p>IDA的伪代码问题太大了，传入2个v19很明显没意义。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516221417532.png" alt="image-20250516221417532" style="zoom:80%;" />

<p>基本块1。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250516221732841.png" alt="image-20250516221732841"></p>
<p>基本块2。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517102406624.png" alt="image-20250517102406624"></p>
<p>基本块3，调用了sub_5cb98([[qword_BED18地址 + (vmp_method_code &amp; 0xFF0000)&gt;&gt;16]], vmp_method_code &amp; 0xFFFF)</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517114642368.png" alt="image-20250517114642368"></p>
<p>基本块4，sub_5cb98的操作如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517114339893.png" alt="image-20250517114339893"></p>
<p>基本块5。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517120326446.png" alt="image-20250517120326446" style="zoom:80%;" />

<p>基本块6。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517124953190.png" alt="image-20250517124953190" style="zoom:80%;" />

<p>基本块7。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517125335092.png" alt="image-20250517125335092" style="zoom:67%;" />

<p>基本块8。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517130438972.png" alt="image-20250517130438972"></p>
<p>基本块9，sub_45EBC比较复杂，暂时先不分析，待会hook一下这个函数，可以不费吹灰之力获得——</p>
<ol>
<li><p>[[[qword_BED18地址 + (vmp_method_code &amp; 0xFF0000)&gt;&gt;16] + 0x38] + (vmp_method_code &amp; 0xFFFF)*8]</p>
</li>
<li><p>[原SP-0x40]</p>
</li>
<li><p>bundle数组的内容</p>
</li>
<li><p>malloc1的内容</p>
</li>
<li><p>malloc2的内容</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517132004904.png" alt="image-20250517132004904"></p>
<p>基本块10。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517132244136.png" alt="image-20250517132244136" style="zoom:80%;" />

<p>基本块11。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250517152311463.png" alt="image-20250517152311463"></p>
<p>后面还要分析好多函数，暂时先分析到这。——2025&#x2F;05&#x2F;17。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-257926.htm#msg_header_h1_3">https://bbs.kanxue.com/thread-257926.htm#msg_header_h1_3</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-257926.htm#msg_header_h1_2">https://bbs.kanxue.com/thread-257926.htm#msg_header_h1_2</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/27/360%E5%85%8D%E8%B4%B9%E5%A3%B3%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/27/360%E5%85%8D%E8%B4%B9%E5%A3%B3%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/" class="post-title-link" itemprop="url">360免费壳分析复现</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-27 21:22:57 / 修改时间：21:34:35" itemprop="dateCreated datePublished" datetime="2025-05-27T21:22:57+08:00">2025-05-27</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>82k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2:29</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="数字免费壳"><a href="#数字免费壳" class="headerlink" title="数字免费壳"></a>数字免费壳</h1><p>用的是大佬 oacia 加固的apk，需要的可以去大佬的博客中下载~</p>
<p>将apk丢入jeb中，查看AndroidManifest.xml。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521191640996.png" alt="image-20250521191640996" style="zoom:67%;" />

<p>从整体壳开始看起，一般整体壳会在App类中重写方法attachBaseContext和onCreate，在这两个方法中，实现自脱壳。</p>
<p>先看attachBaseContext。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521193756011.png" alt="image-20250521193756011"></p>
<p>通过反射，访问类**”android.content.pm.PackageParser$Package”**，设置构造方法为可访问。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521193925825.png" alt="image-20250521193925825" style="zoom:80%;" />

<p>通过反射，获取当前线程的ActivityThread实例，然后设置mHiddenApiWarningShown字段为true，避免了日志中出现使用隐藏api时的警告信息。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521194051603.png" alt="image-20250521194051603"></p>
<p>StubApp是一个静态类，存储加固相关的全局状态。</p>
<p>StubApp.a保存上下文，供加固逻辑使用；StubApp.c保存当前对象实例（App类实例），确保只初始化一次。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521194322034.png" alt="image-20250521194322034"></p>
<p>在函数com.qihoo.util.a.a()中，通过下述3种方式判断当前的架构，若是x86架构，则返回true，然后加载X86Bridge；反之相反。</p>
<ol>
<li><p>检查 Build.SUPPORTED_32_BIT_ABIS 系统属性。</p>
</li>
<li><p>读取 &#x2F;system&#x2F;build.prop 文件中的 ro.product.cpu.abi 属性。</p>
</li>
<li><p>检查 &#x2F;system&#x2F;bin&#x2F;ls 的 ELF 文件头，判断其架构。</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521195133236.png" alt="image-20250521195133236"></p>
<p>com.qihoo.util.a.a(…)会检测…&#x2F;assets&#x2F;libjiagu.so和…&#x2F;.jiagu&#x2F;libjiagu.so是否完全一样，如果不一样，以assets的so为主，会把assets的so覆写.jiagu的so，假如之后我们patch了…&#x2F;.jiagu的so文件进行重打包，将不会有效果；libjiagu_64.so同等”待遇”。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521201518518.png" alt="image-20250521201518518"></p>
<p>随后来到方法interface5，跳转到native层执行。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521202133001.png" alt="image-20250521202133001" style="zoom:80%;" />

<p>不必多说，这个interface5肯定是在libjiaguxxx.so中注册的。</p>
<p>使用下面这个脚本跑一下试试。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">find_RegisterNatives</span>(<span class="params">params</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> symbols = <span class="title class_">Module</span>.<span class="title function_">enumerateSymbolsSync</span>(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> addrRegisterNatives = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> symbol = symbols[i];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//_ZN3art3JNI15RegisterNativesEP7_JNIEnvP7_jclassPK15JNINativeMethodi</span></span><br><span class="line">        <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;art&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;JNI&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; </span><br><span class="line">                symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;RegisterNatives&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; </span><br><span class="line">                symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            addrRegisterNatives = symbol.<span class="property">address</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;RegisterNatives is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            <span class="title function_">hook_RegisterNatives</span>(addrRegisterNatives)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_RegisterNatives</span>(<span class="params">addrRegisterNatives</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addrRegisterNatives != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrRegisterNatives, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[RegisterNatives] method_count:&quot;</span>, args[<span class="number">3</span>]);</span><br><span class="line">                <span class="keyword">let</span> java_class = args[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">let</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(java_class);</span><br><span class="line">                <span class="comment">//console.log(class_name);</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> methods_ptr = <span class="title function_">ptr</span>(args[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> method_count = <span class="built_in">parseInt</span>(args[<span class="number">3</span>]);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; method_count; i++) &#123;</span><br><span class="line">                    <span class="keyword">let</span> name_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span>));</span><br><span class="line">                    <span class="keyword">let</span> sig_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span>));</span><br><span class="line">                    <span class="keyword">let</span> fnPtr_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">let</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(name_ptr);</span><br><span class="line">                    <span class="keyword">let</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(sig_ptr);</span><br><span class="line">                    <span class="keyword">let</span> symbol = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(fnPtr_ptr)</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[RegisterNatives] java_class:&quot;</span>, class_name, <span class="string">&quot;name:&quot;</span>, name, <span class="string">&quot;sig:&quot;</span>, sig, <span class="string">&quot;fnPtr:&quot;</span>, fnPtr_ptr,  <span class="string">&quot; fnOffset:&quot;</span>, symbol, <span class="string">&quot; callee:&quot;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>), <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(find_RegisterNatives);</span><br></pre></td></tr></table></figure>

<p>结果如图，暂时忽视那个Bad access….目标函数在libjiagu_64.so offset为0x11be00的位置。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521203239178.png" alt="image-20250521203239178"></p>
<p>先不着急分析interface5，先走完libjiagu_64.so的初始化，用IDA打开assets下的libjiagu_a64.so。</p>
<p>打开一看，天塌了，导入表、导出表全是空的。</p>
<p>使用System.loadLibray加载一个so文件的流程是这样的（大致操作应该没问题，如果细节有误，就是我学术不精）。</p>
<ol start="0">
<li><p>动态链接器会映射这个so文件的PT_LOAD段到内存中；</p>
</li>
<li><p>解析so文件，映射所有其他依赖的共享库；</p>
</li>
<li><p>完成符号解析、动态重定位等操作；</p>
</li>
<li><p>动态库初始化：init_proc -&gt; .init_array(函数指针) -&gt; JNI_OnLoad；</p>
</li>
<li><p>完成加载，等待调用。</p>
</li>
</ol>
<p>一般来说，一个普通的so文件是没有start的（注意，_start和_dl_start不是一个函数），只有可执行文件有，而libjiagu_64.so的导出表有start，而且只有一个start，甚至被标记为了main_entry。但对于so文件来说，main_entry应该是用不着的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521220343528.png" alt="image-20250521220343528"></p>
<p>上述种种特征说明，它不是一个普通的so文件，而是一个类似于自加载器的so文件，壳so负责将加固后的so文件解密，解析并加载，然后链接重定位。</p>
<p>那么问题来了，何时进行加载、何时重定位呢？</p>
<p><strong>得先找到壳的程序入口点。</strong></p>
<p>按照我们的常规思路，先去看看有没有函数叫init_proc（旧版本的才有的函数，一般情况下已经见不到这个函数）、再看init_array上有没有函数指针列表、最后找JNI_OnLoad。</p>
<p>结果，在IDA中看不到init_proc、init_array节、JNI_OnLoad。</p>
<p>后来，我通过readelf -a读到了INIT_ARRAY的偏移。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522121310523.png" alt="image-20250522121310523"></p>
<p>跳转到0x2d760，没有看到函数指针。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522145858137.png" alt="image-20250522145858137" style="zoom:80%;" />

<p>360壳对so文件的结构字段做了很多修改，有一些字段是用来观察so文件结构的，他们属于对动态链接器加载流程不构成影响的字段，这些字段要么给删了，要么给加密了。</p>
<p>事实上，完全可以从内存中dump一个已经加载好的so文件，但我想看看一般这种情况要如何进行下一步分析。</p>
<p>重新理一下思路——360壳对ELF文件做了手脚，通过工具无法查看某些字段的信息，但对于动态链接器来说，它依旧可以正确调用init_array上的函数和JNI_OnLoad。</p>
<p><strong>因此，下一个切入点是：动态链接器是如何获得到init_array和JNI_OnLoad地址的。</strong></p>
<p><strong>动态链接器找init_array节地址的流程</strong>是这样的：</p>
<ol>
<li><p>查找.dynamic节的位置，.dynamic节是一个由Elf_Dyn结构体组成的数组，每个Elf_Dyn包含2个主要成员。</p>
<ul>
<li>d_tag：一个标记（tag），表示这个条目的类型，比如，当前这个条目指向符号表或重定位表等。</li>
<li>d_un：一个联合体，根据d_tag的不同，它可以是一个值，或者指向一个虚拟地址。</li>
</ul>
</li>
<li><p>查找特定的d_tag，对于.init_array来说，有2个相关的d_tag标记。</p>
<ul>
<li>d_tag &#x3D;&#x3D; DT_INIT_ARRAY，此时d_un包含了.init_array节的偏移地址。</li>
<li>d_tag &#x3D;&#x3D; DT_INIT_ARRAYSZ，此时d_un包含了.init_array节的总大小。（以字节为单位）</li>
</ul>
</li>
<li><p>动态链接器会找到.init_array的位置，并根据.init_array的大小，得到函数指针的数目，执行上面的函数指针。</p>
</li>
</ol>
<p>实操如下。</p>
<p>通过010editor，找到节头表，然后根据节头表找到.dynamic节的偏移。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522163243458.png" alt="image-20250522163243458" style="zoom:67%;" />

<p>下面这个网址，给出了d_tag的值与含义。</p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E23824_01/html/819-0690/chapter6-42444.html">https://docs.oracle.com/cd/E23824_01/html/819-0690/chapter6-42444.html</a></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522163712631.png" alt="image-20250522163712631"></p>
<p>一个Elf_Dyn元素占16个字节，前8个字节是d_tag，后8个字节是d_un。</p>
<p>接下来，在010editor中，从0x1DAD0开始，搜索d_tag &#x3D;&#x3D; 25（0x19）或27（0x1B）的地方。</p>
<p>翻译一下，.init_array的地址是0x2D760，和之前readelf看到的一样；而.init_array的大小是0x10字节，可以存放2个函数指针。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522164021033.png" alt="image-20250522164021033"></p>
<p>我们之前跳转到了0x2D760，发现.init_array上没有任何内容，这2个函数指针是哪里来的？突然想起来，在一个so文件加载的流程中，会先进行动态重定位，那大概率是在重定位的过程，为.init_array赋了2个函数指针。</p>
<p>重定位表（RELA类型）相关的d_tag如下：</p>
<ul>
<li>DT_RELA：此时d_un指向了重定位表的地址。</li>
<li>DT_RELASZ：此时d_un指定了重定位表的总大小。</li>
<li>DT_RELAENT：此时d_un指定了每个重定位条目的大小（一般24字节）。</li>
</ul>
<p>而重定位表（RELA类型）中的每个元素的结构（Elf_Rela）是这样的：</p>
<ul>
<li>r_offset：需要修改的、需要重定位的地址偏移量。（字节）</li>
<li>r_info：这个成员变量包含2个信息——高4字节表示符号表索引，指向动态符号表（.dynsym）中的符号条目，该符号的地址将用于重定位计算；低4字节表示修正规则，用于判断执行哪种类型的地址修正操作。</li>
<li>r_addend：一个显式的加数，一个有符号的常量，它会参与重定位的计算中，比如说：写入r_offset的位置的值可能是符号地址 + r_addend。</li>
</ul>
<p>而如果是REL类型的重定位表，相关的d_tag则是少了一个A，比如说，DT_REL、DT_RELSZ、DT_RELENT。</p>
<p>而REL类型重定位表每个元素的的结构只有：r_offset和r_info。</p>
<p>接下来是实操。</p>
<p>通过 <strong>readelf -r libjiagu_a64.so –use-dynamic</strong>，可以获得重定位表表项的信息。</p>
<p>第一条表项，是不是很眼熟？正是我们.init_array的地址，（除此之外，没找到0x2d768），由于r_info的低32位是0403，代表修正操作是R_AARCH64_RELATIV，这个修正规则的符号索引通常是0（指向空符号），因为这种重定位规则是相对于模块自身的加载基址，不依赖于其他特定符号。</p>
<p>因此，.init_array的第一个函数指针是sub_98a0。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522182759789.png" alt="image-20250522182759789"></p>
<p>别着急找JNI_OnLoad，还没完，突然注意到RELA表中，第二项的Type也是R_AARCH64_RELATIV，并且r_addend是0x2e20，这不正是我们之前看到的start函数的地址吗？</p>
<p>它被存放到了0x2d770的位置，这个地址离.init_array就差16个字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521220343528.png" alt="image-20250521220343528"></p>
<p>还记得我们之前使用readelf -a读到了.init_array的地址，其实当时还读到了.fini_array的地址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522183812989.png" alt="image-20250522183812989"></p>
<p>也就是说，这个start是.fini_array上的函数指针，很有迷惑性，.fini_array上的函数指针，是当程序退出的时候执行的，却取名叫了start。</p>
<p>至此，我们找到了.init_array上的函数指针：<strong>sub_98a0</strong>。</p>
<p><strong>下一步，动态链接器是如何找到JNI_OnLoad的呢？</strong></p>
<p>动态链接器在执行完.init_array上函数指针的函数后，会调用dlsym(handle, “JNI_OnLoad”)，用于在库中查找一个名为”JNI_OnLoad”的<strong>导出符号</strong>，具体来说，dlsym()回到库的动态符号表(.dynsym)中搜索这个名称，如果找到了这个符号，就会返回这个符号的内存地址，由Dalvik&#x2F;ART虚拟机传递JavaVM*指针和一个保留参数并执行这个指向JNI_OnLoad的函数。</p>
<p>实操如下。</p>
<p>通过.dynamic的节表找到.dynamic节在文件中的偏移。</p>
<p>通过010editor，找到节头表（动态链接器会根据PHT来找，节表在装载过程可有可无），然后根据节头表找到.dynamic节的偏移。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522163243458.png" alt="image-20250522163243458" style="zoom:67%;" />

<p>然后从0x1DAD0的位置，寻找d_tag &#x3D;&#x3D; DT_SYMTAB（0x6）的表项。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522192323619.png" alt="image-20250522192323619"></p>
<p>可以从d_un知道，动态符号表的偏移是0x4E8。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522192408776.png" alt="image-20250522192408776"></p>
<p>**动态符号表（.dynsym）**每个元素的结构（Elf64_Sym）是这样的。</p>
<ul>
<li>一共24个字节。</li>
<li>st_name：4个字节，表示相对于动态字符串表起始地址（.dynstr）中的偏移，如果该值为0，表示该符号没有名称。</li>
<li>st_info：1个字节，表示符号的<strong>类型</strong>和<strong>绑定属性</strong>（根据这1个字节的不同位区分），类型：函数还是对象；绑定属性：全局还是局部。</li>
<li>st_other：1个字节，定义符号的可见性。</li>
<li>st_shndx：2个字节，符号相关的节头表索引，指明了该符号定义在哪个节区（特殊值有：未定义符号-SHN_UNDEF、绝对符号-SHN_ABS）。</li>
<li>st_value：8个字节，符号的值，通常是符号的虚拟地址。</li>
<li>st_size：8个字节，符号关联的数据的大小，以字节为单位，例如：函数体的大小或者数据对象的大小。</li>
</ul>
<p>而动态字符串表（.dynstr）里面，全部放着字符串，动态符号表的st_name的索引，对应着动态字符串表首地址的偏移量。</p>
<p>在动态符号表中，每个数据对象占24（0x18）个字节，我们假设JNI_OnLoad这个字符串一定存在于.dynstr里，先去计算它相对于.dynstr的首地址的偏移量。</p>
<p>找动态字符串表有个快捷的方式，直接在IDA中shift + f12，起始地址是0xFB0。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522210913892.png" alt="image-20250522210913892" style="zoom:80%;" />

<p>然后搜索”JNI_OnLoad”，先考虑第1个JNI_OnLoad的偏移吧，如果根据第1个的偏移找不到，再考虑第2个。（仅仅根据字符串，无法通过交叉引用追踪到JNI_OnLoad的函数地址）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522211014029.png" alt="image-20250522211014029"></p>
<p>计算偏移，得出0x230。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522211223432.png" alt="image-20250522211223432"></p>
<p>接下来，从动态符号表（从0x4E8开始找）中，每次查看24字节的前4个字节，寻找0x230，然后根据st_value，找到符号的虚拟地址。——由于是小端排序，可以直接在010editor搜索，30 02。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522213102676.png" alt="image-20250522213102676" style="zoom:80%;" />

<p>根据st_value在结构体中的偏移量，st_value &#x3D; 0x8AFC。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522213143598.png" alt="image-20250522213143598"></p>
<p>接下来我们去看看0x8AFC符不符合JNI_OnLoad的特征。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522213451658.png" alt="image-20250522213451658" style="zoom: 67%;" />

<p>其中，sub_8C74里面有关于JNI_OnLoad字符串的出现。</p>
<p>sub_4c70像不像dlsym？dlsym根据动态链接库操作句柄(pHandle)与符号(symbol)，返回符号对应的地址，也就是一个函数指针，为什么有2个JNI_OnLoad呢？我<strong>猜测</strong>是壳so加载了一个so（暂且叫做主so），而这个主so负责JNI动态注册，简单来说，壳so的JNI_OnLoad调用了主so的JNI_OnLoad。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522214248568.png" alt="image-20250522214248568"></p>
<p>至此，做个小总结，.init_array节上有函数指针sub_98a0，而壳so的JNI_OnLoad地址是0x8AFC，为了验证猜想，我们可以dump一个内存中加载好的libjiagu_64.so进行验证。</p>
<p>通过frida进行dump。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">my_hook_dlopen</span>(<span class="params">soName = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;准备加载&quot;</span>)</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="title function_">dump_so</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump_so</span>(<span class="params">so_name</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(so_name)</span><br><span class="line">    <span class="keyword">var</span> libso = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(so_name);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[name]:&quot;</span>, libso.<span class="property">name</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[base]:&quot;</span>, libso.<span class="property">base</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[size]:&quot;</span>, <span class="title function_">ptr</span>(libso.<span class="property">size</span>));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[path]:&quot;</span>, libso.<span class="property">path</span>);</span><br><span class="line">    <span class="keyword">var</span> file_path = <span class="string">&quot;/data/data/com.oacia.apk_protect/&quot;</span> + libso.<span class="property">name</span> + <span class="string">&quot;_&quot;</span> + libso.<span class="property">base</span> + <span class="string">&quot;_&quot;</span> + <span class="title function_">ptr</span>(libso.<span class="property">size</span>) + <span class="string">&quot;.so&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="title function_">ptr</span>(libso.<span class="property">base</span>), libso.<span class="property">size</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> libso_buffer = <span class="title function_">ptr</span>(libso.<span class="property">base</span>).<span class="title function_">readByteArray</span>(libso.<span class="property">size</span>);</span><br><span class="line">        file_handle.<span class="title function_">write</span>(libso_buffer);</span><br><span class="line">        file_handle.<span class="title function_">flush</span>();</span><br><span class="line">        file_handle.<span class="title function_">close</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump]:&quot;</span>, file_path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="title function_">my_hook_dlopen</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>然后使用elf修复工具进行修复，再用ida打开，这回导入、导出表的内容恢复了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522125906310.png" alt="image-20250522125906310" style="zoom:50%;" />

<p>来查看.init_array和JNI_OnLoad的地址。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522215252155.png" alt="image-20250522215252155" style="zoom: 67%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522215337793.png" alt="image-20250522215337793"></p>
<p>下图是壳so的JNI_OnLoad。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522215721040.png" alt="image-20250522215721040"></p>
<p>下图是主so的JNI_OnLoad。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522215826312.png" alt="image-20250522215826312" style="zoom:80%;" />

<p>暂且就不去分析sub_98a0和壳so的JNI_OnLoad的代码了，应该是修复导入、导出表，执行JNI_OnLoad、反调等操作。接下来会使用frida对这一块内容进行分析。</p>
<hr>
<p>注意到，在frida注入代码，dump了so文件之后，进程会立即退出。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522125830770.png" alt="image-20250522125830770" style="zoom:80%;" />

<p>hook了android_dlopen_ext，发现进程在加载了libjiagu_64.so后就退出了，说明检测frida的代码大概率在这个so文件里。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522130529768.png" alt="image-20250522130529768"></p>
<p>通过hook发现，libjiagu_64.so的某段代码一直在检测maps文件，应该是这里在检测调试器。</p>
<p>解决办法：可以hook函数open，每当要执行函数open时，判断目标文件是否为maps文件，如果是，重定位到一个不存在的文件。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522130853416.png" alt="image-20250522130853416" style="zoom:80%;" />

<p>hook的脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">my_hook_dlopen</span>(<span class="params">soName = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_proc_self_maps</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_proc_self_maps</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> openPtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> open = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fakePath = <span class="string">&quot;/data/data/com.oacia.apk_protect/maps&quot;</span>;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(openPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">pathnameptr, flag</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> pathname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(pathnameptr);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;open&quot;</span>, pathname);</span><br><span class="line">        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;maps&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find&quot;</span>,pathname,<span class="string">&quot;,redirect to&quot;</span>,fakePath);</span><br><span class="line">            <span class="keyword">var</span> filename = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(fakePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">open</span>(filename, flag);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> fd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(my_hook_dlopen,<span class="string">&quot;libjiagu&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>虽然还是退出了，但这次有了新的收获，可以看到打开了3个dex文件。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522131044479.png" alt="image-20250522131044479" style="zoom:80%;" />

<p>用010editor打开，发现第一个dex处于加密状态，而其它的dex是空的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522131542842.png" alt="image-20250522131542842"></p>
<p>为了判断是哪里的代码open了dex文件，可以打印一下堆栈，常规的打印堆栈的方式是加下面这句代码，但我们前面将maps文件重定位了，所以不能使用DebugSymbol.fromAddress（用到了maps文件）了，得自己实现一个函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;RegisterNatives called from:\\n&#x27;</span> + <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">FUZZY</span>).<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&#x27;\\n&#x27;</span>) + <span class="string">&#x27;\\n&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>修改后的完整代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">addr_in_so</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> process_Obj_Module_Arr = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; process_Obj_Module_Arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(addr&gt;process_Obj_Module_Arr[i].<span class="property">base</span> &amp;&amp; addr&lt;process_Obj_Module_Arr[i].<span class="property">base</span>.<span class="title function_">add</span>(process_Obj_Module_Arr[i].<span class="property">size</span>))&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(addr.<span class="title function_">toString</span>(<span class="number">16</span>),<span class="string">&quot;is in&quot;</span>,process_Obj_Module_Arr[i].<span class="property">name</span>,<span class="string">&quot;offset: 0x&quot;</span>+(addr-process_Obj_Module_Arr[i].<span class="property">base</span>).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_proc_self_maps</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> openPtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> open = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fakePath = <span class="string">&quot;/data/data/com.oacia.apk_protect/maps_nonexistent&quot;</span>;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(openPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">pathnameptr, flag</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> pathname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(pathnameptr);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;open&quot;</span>,pathname);<span class="comment">//,Process.getCurrentThreadId()</span></span><br><span class="line">        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;maps&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find&quot;</span>,pathname+<span class="string">&quot;, redirect to&quot;</span>,fakePath);</span><br><span class="line">            <span class="keyword">var</span> filename = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(fakePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">open</span>(filename, flag);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;dex&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">FUZZY</span>).<span class="title function_">map</span>(addr_in_so);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> fd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">my_hook_dlopen</span>(<span class="params">soName=<span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="comment">//console.log(path);</span></span><br><span class="line">                    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_proc_self_maps</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(my_hook_dlopen,<span class="string">&#x27;libjiagu&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>可以看到3个dex文件被打开时的调用栈了，鉴于3个dex文件的调用栈基本一样，大概率是在一个循环中依次加载的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522133014663.png" alt="image-20250522133014663" style="zoom: 67%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522133032024.png" alt="image-20250522133032024" style="zoom:67%;" />

<p>来到0x19b780，发现都是0，应该是在加载完dex文件后，将这块空间清空了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523131131946.png" alt="image-20250523131131946" style="zoom:50%;" />

<p>为了分析这块代码的逻辑，需要在open dex文件的时候，将so文件dump下来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hook_once = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">my_hook_dlopen</span>(<span class="params">soName = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;准备加载&quot;</span>)</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="comment">// 获得open的地址</span></span><br><span class="line">                    <span class="keyword">const</span> openPtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">                    <span class="comment">// 准备替换的open</span></span><br><span class="line">                    <span class="keyword">const</span> open = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">                    <span class="comment">// hook</span></span><br><span class="line">                    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(openPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">pathnameptr, flag</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> pathname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(pathnameptr);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;open&quot;</span>, pathname);<span class="comment">//,Process.getCurrentThreadId()</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;maps&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> fakePath = <span class="string">&quot;/data/data/com.oacia.apk_protect/maps_nonexistent&quot;</span>;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find&quot;</span>,pathname+<span class="string">&quot;, redirect to&quot;</span>,fakePath);</span><br><span class="line">                            <span class="keyword">var</span> filename = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(fakePath);</span><br><span class="line">                            <span class="keyword">return</span> <span class="title function_">open</span>(filename, flag);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;/data/data/com.oacia.apk_protect/.jiagu/classes&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span>(hook_once == <span class="number">0</span>)&#123;</span><br><span class="line">                                <span class="title function_">dump_so</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>);</span><br><span class="line">                                hook_once = <span class="number">1</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">var</span> fd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">                        <span class="keyword">return</span> fd;</span><br><span class="line">                    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump_so</span>(<span class="params">so_name</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(so_name)</span><br><span class="line">    <span class="keyword">var</span> libso = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(so_name);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[name]:&quot;</span>, libso.<span class="property">name</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[base]:&quot;</span>, libso.<span class="property">base</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[size]:&quot;</span>, <span class="title function_">ptr</span>(libso.<span class="property">size</span>));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[path]:&quot;</span>, libso.<span class="property">path</span>);</span><br><span class="line">    <span class="keyword">var</span> file_path = <span class="string">&quot;/data/data/com.oacia.apk_protect/&quot;</span> + libso.<span class="property">name</span> + <span class="string">&quot;_&quot;</span> + libso.<span class="property">base</span> + <span class="string">&quot;_&quot;</span> + <span class="title function_">ptr</span>(libso.<span class="property">size</span>) + <span class="string">&quot;.so&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="title function_">ptr</span>(libso.<span class="property">base</span>), libso.<span class="property">size</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> libso_buffer = <span class="title function_">ptr</span>(libso.<span class="property">base</span>).<span class="title function_">readByteArray</span>(libso.<span class="property">size</span>);</span><br><span class="line">        file_handle.<span class="title function_">write</span>(libso_buffer);</span><br><span class="line">        file_handle.<span class="title function_">flush</span>();</span><br><span class="line">        file_handle.<span class="title function_">close</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump]:&quot;</span>, file_path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="title function_">my_hook_dlopen</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>脚本执行结果。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522134705450.png" alt="image-20250522134705450" style="zoom:67%;" />

<p> 修复之后，用IDA打开，定位到0x19b780。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523131209960.png" alt="image-20250523131209960" style="zoom:80%;" />

<p>可以使用winmerge查看两个文件的区别。分析被抽空的数据，是从哪里开始抽空的</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523131635457.png" alt="image-20250523131635457"></p>
<p>往上滚动，直到0xe7000，两边的文件才基本一模一样。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523131949048.png" alt="image-20250523131949048"></p>
<p>注意到，0xe7000存放的是.ELF，这是ELF文件的魔数。也就是说，壳so里面藏了一个so（主so）。</p>
<p>使用下面这个脚本，将壳so里的ELF文件读出来，放入010editor查看。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;libjiagu_64.so_0x6f71613000_0x274000.so&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    s=f.read()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;libjiagu_0xe7000.so&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(s[<span class="number">0xe7000</span>::])</span><br></pre></td></tr></table></figure>

<p>除了ELF头，段头表和节表都被加密了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523132740721.png" alt="image-20250523132740721"></p>
<p>因此，IDA无法对这个ELF文件进行正常的分析。</p>
<p>根据前人的分析，壳ELF会对加密的主ELF进行解密，并且自己实现了linker，对主ELF进行解析，再将解析结果赋值到soinfo结构体中，然后调用dlopen进行手动加载。</p>
<p>先简单介绍一下什么是dlopen、dlsym和soinfo。</p>
<p><strong><code>dlopen</code> (Dynamic Load Open)</strong></p>
<ul>
<li><strong>是什么</strong>：<code>dlopen</code> 是一个标准 C 库函数（定义在 <code>dlfcn.h</code> 中，通常由 <code>libdl.so</code> 提供）。它允许程序在运行时（而不是在程序启动时）显式地加载指定的共享对象（SO文件）到其地址空间。</li>
<li><strong>作用</strong>：当程序调用 <code>dlopen(&quot;path/to/your_library.so&quot;, flags)</code> 时，它会请求动态链接器加载这个库。如果加载成功，<code>dlopen</code> 会返回一个“句柄 (handle)”，后续可以使用这个句柄通过 <code>dlsym</code> 查找库中的符号（函数或变量），或者通过 <code>dlclose</code>卸载该库。</li>
<li><strong>谁调用它</strong>：应用程序代码可以直接调用 <code>dlopen</code> 来实现插件系统、按需加载功能模块等。在Java&#x2F;Kotlin层面，<code>System.loadLibrary()</code> 或 <code>System.load()</code> 在底层通常也是通过调用 <code>dlopen</code> 来加载JNI库的。</li>
</ul>
<p><strong><code>soinfo</code> (Shared Object Information)</strong></p>
<ul>
<li><strong>是什么</strong>：<code>soinfo</code> 是<strong>Android动态链接器内部使用的一个非常重要的数据结构</strong>。对于加载到进程中的<strong>每一个SO文件</strong>，动态链接器都会在内部创建一个对应的 <code>soinfo</code> 实例来管理它。其他类Unix系统的动态链接器也会有类似的内部结构来跟踪已加载的库，但 <code>soinfo</code> 这个名称特指Android的实现（源于Bionic C库的链接器）。</li>
<li><strong>作用</strong>：soinfo结构体存储了关于一个已加载SO文件的所有关键运行时信息，例如：<ul>
<li>库的名称和完整路径。</li>
<li>库在内存中的加载基地址 (base address) 和大小。</li>
<li>指向其ELF动态段 (<code>.dynamic</code> section) 的指针。</li>
<li>指向其动态符号表 (<code>.dynsym</code>)、字符串表 (<code>.dynstr</code>)、哈希表 (<code>.hash</code> 或 <code>.gnu.hash</code>) 的指针。</li>
<li>重定位表的信息。</li>
<li>依赖的其他 <code>soinfo</code> 实例的列表。</li>
<li>库的句柄 (handle)、引用计数。</li>
<li>初始化状态（例如，构造函数&#x2F;<code>.init_array</code> 是否已运行）。</li>
<li>标志位（例如，是否是主可执行程序、是否是PIE等）。</li>
</ul>
</li>
</ul>
<p>应用程序通过dlopen函数请求加载一个so文件，dlopen会将这个请求传递给动态链接器linker，动态链接器linker负责实际执行加载so文件的所有底层工作（查找文件、映射内存、解析依赖、重定位符号、运行初始化代码等）。在加载so文件的过程中，动态链接器会为这个新加载的so文件创建一个soinfo结构体实例，这个soinfo包含了管理该so所需的所有元数据和状态信息。</p>
<p>而当后续调用dlsym查找该库某个符号时，链接器会查阅对应soinfo中记录的符号表等信息——dlopen获得的handle，实际上就是soinfo结构体实例的指针。</p>
<p>因此，可以理解壳ELF的行为：对主ELF文件进行解析、映射、重定位…创建soinfo结构实例，然后供dlsym使用，获得符号的地址。</p>
<p>主so是壳so加载起来的，但要是连依赖项也由壳处理，就过于麻烦了，所以前人分析会用到dlopen，于是进行交叉引用追踪。</p>
<p>在函数sub_3C94中，用到了dlopen，同时会发现，这里的代码和aosp源码的预链接十分相似，下图是sub_3C94的代码。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523143433747.png" alt="image-20250523143433747"></p>
<p>下图是AOSP源码中的预链接（直接用oacia大佬的图）。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523143521988.png" alt="image-20250523143521988" style="zoom: 50%;" />

<p>添加前人准备好的关于soinfo的结构体，然后将参数a1类型改成soinfo *。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ELF64 启用该宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LP64__ 1</span></span><br><span class="line"><span class="comment">// ELF32 启用该宏</span></span><br><span class="line"><span class="comment">//#define __work_around_b_24465209__ 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">https://android.googlesource.com/platform/bionic/+/master/linker/Android.bp</span></span><br><span class="line"><span class="comment">架构为 32 位 定义__work_around_b_24465209__宏arch: &#123;</span></span><br><span class="line"><span class="comment">    arm: &#123;cflags: [&quot; D__work_around_b_24465209__&quot;],&#125;,</span></span><br><span class="line"><span class="comment">    x86: &#123;cflags: [&quot; D__work_around_b_24465209__&quot;],&#125;,</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 ELF 文件的基本类型，根据架构决定使用 ELF32 或 ELF64 类型</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__LP64__)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> ElfW(type) Elf64_ ## type</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> ElfW(type) Elf32_ ## type</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 32 位和 64 位重定位和符号表数据结构</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Elf32 和 Elf64 基本类型</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">signed</span> <span class="type">char</span> __s8;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> __u8;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">signed</span> <span class="type">short</span> __s16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">short</span> __u16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">signed</span> <span class="type">int</span> __s32;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> __u32;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">signed</span> <span class="type">long</span> <span class="type">long</span> __s64;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> __u64;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 32 位 ELF 基本类型</span></span><br><span class="line"><span class="keyword">typedef</span> __u32 Elf32_Addr;</span><br><span class="line"><span class="keyword">typedef</span> __u16 Elf32_Half;</span><br><span class="line"><span class="keyword">typedef</span> __u32 Elf32_Off;</span><br><span class="line"><span class="keyword">typedef</span> __s32 Elf32_Sword;</span><br><span class="line"><span class="keyword">typedef</span> __u32 Elf32_Word;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 64 位 ELF 基本类型</span></span><br><span class="line"><span class="keyword">typedef</span> __u64 Elf64_Addr;</span><br><span class="line"><span class="keyword">typedef</span> __u16 Elf64_Half;</span><br><span class="line"><span class="keyword">typedef</span> __s16 Elf64_SHalf;</span><br><span class="line"><span class="keyword">typedef</span> __u64 Elf64_Off;</span><br><span class="line"><span class="keyword">typedef</span> __s32 Elf64_Sword;</span><br><span class="line"><span class="keyword">typedef</span> __u32 Elf64_Word;</span><br><span class="line"><span class="keyword">typedef</span> __u64 Elf64_Xword;</span><br><span class="line"><span class="keyword">typedef</span> __s64 Elf64_Sxword;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态段数据结构（Elf32 和 Elf64）</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dynamic</span> &#123;</span></span><br><span class="line">    Elf32_Sword d_tag;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        Elf32_Sword d_val;</span><br><span class="line">        Elf32_Addr d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf64_Sxword d_tag; <span class="comment">/* entry tag value */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        Elf64_Xword d_val;</span><br><span class="line">        Elf64_Addr d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf64_Dyn;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重定位数据结构（Elf32 和 Elf64）</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf32_rel</span> &#123;</span></span><br><span class="line">    Elf32_Addr r_offset;</span><br><span class="line">    Elf32_Word r_info;</span><br><span class="line">&#125; Elf32_Rel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf64_rel</span> &#123;</span></span><br><span class="line">    Elf64_Addr r_offset; <span class="comment">/* Location at which to apply the action */</span></span><br><span class="line">    Elf64_Xword r_info;  <span class="comment">/* index and type of relocation */</span></span><br><span class="line">&#125; Elf64_Rel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf32_rela</span> &#123;</span></span><br><span class="line">    Elf32_Addr r_offset;</span><br><span class="line">    Elf32_Word r_info;</span><br><span class="line">    Elf32_Sword r_addend;</span><br><span class="line">&#125; Elf32_Rela;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf64_rela</span> &#123;</span></span><br><span class="line">    Elf64_Addr r_offset;  <span class="comment">/* Location at which to apply the action */</span></span><br><span class="line">    Elf64_Xword r_info;   <span class="comment">/* index and type of relocation */</span></span><br><span class="line">    Elf64_Sxword r_addend; <span class="comment">/* Constant addend used to compute value */</span></span><br><span class="line">&#125; Elf64_Rela;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 符号表数据结构（Elf32 和 Elf64）</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf32_sym</span> &#123;</span></span><br><span class="line">    Elf32_Word st_name;</span><br><span class="line">    Elf32_Addr st_value;</span><br><span class="line">    Elf32_Word st_size;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> st_info;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> st_other;</span><br><span class="line">    Elf32_Half st_shndx;</span><br><span class="line">&#125; Elf32_Sym;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf64_sym</span> &#123;</span></span><br><span class="line">    Elf64_Word st_name;     <span class="comment">/* Symbol name, index in string tbl */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> st_info;  <span class="comment">/* Type and binding attributes */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> st_other; <span class="comment">/* No defined meaning, 0 */</span></span><br><span class="line">    Elf64_Half st_shndx;    <span class="comment">/* Associated section index */</span></span><br><span class="line">    Elf64_Addr st_value;    <span class="comment">/* Value of the symbol */</span></span><br><span class="line">    Elf64_Xword st_size;    <span class="comment">/* Associated symbol size */</span></span><br><span class="line">&#125; Elf64_Sym;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ELF 文件头数据结构（Elf32 和 Elf64）</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EI_NIDENT 16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf32_hdr</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> e_ident[EI_NIDENT];</span><br><span class="line">    Elf32_Half e_type;</span><br><span class="line">    Elf32_Half e_machine;</span><br><span class="line">    Elf32_Word e_version;</span><br><span class="line">    Elf32_Addr e_entry; <span class="comment">/* Entry point */</span></span><br><span class="line">    Elf32_Off e_phoff;</span><br><span class="line">    Elf32_Off e_shoff;</span><br><span class="line">    Elf32_Word e_flags;</span><br><span class="line">    Elf32_Half e_ehsize;</span><br><span class="line">    Elf32_Half e_phentsize;</span><br><span class="line">    Elf32_Half e_phnum;</span><br><span class="line">    Elf32_Half e_shentsize;</span><br><span class="line">    Elf32_Half e_shnum;</span><br><span class="line">    Elf32_Half e_shstrndx;</span><br><span class="line">&#125; Elf32_Ehdr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf64_hdr</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> e_ident[EI_NIDENT]; <span class="comment">/* ELF &quot;magic number&quot; */</span></span><br><span class="line">    Elf64_Half e_type;</span><br><span class="line">    Elf64_Half e_machine;</span><br><span class="line">    Elf64_Word e_version;</span><br><span class="line">    Elf64_Addr e_entry;  <span class="comment">/* Entry point virtual address */</span></span><br><span class="line">    Elf64_Off e_phoff;   <span class="comment">/* Program header table file offset */</span></span><br><span class="line">    Elf64_Off e_shoff;   <span class="comment">/* Section header table file offset */</span></span><br><span class="line">    Elf64_Word e_flags;</span><br><span class="line">    Elf64_Half e_ehsize;</span><br><span class="line">    Elf64_Half e_phentsize;</span><br><span class="line">    Elf64_Half e_phnum;</span><br><span class="line">    Elf64_Half e_shentsize;</span><br><span class="line">    Elf64_Half e_shnum;</span><br><span class="line">    Elf64_Half e_shstrndx;</span><br><span class="line">&#125; Elf64_Ehdr;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 程序头数据结构（Elf32 和 Elf64）</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf32_phdr</span> &#123;</span></span><br><span class="line">    Elf32_Word p_type;</span><br><span class="line">    Elf32_Off p_offset;</span><br><span class="line">    Elf32_Addr p_vaddr;</span><br><span class="line">    Elf32_Addr p_paddr;</span><br><span class="line">    Elf32_Word p_filesz;</span><br><span class="line">    Elf32_Word p_memsz;</span><br><span class="line">    Elf32_Word p_flags;</span><br><span class="line">    Elf32_Word p_align;</span><br><span class="line">&#125; Elf32_Phdr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf64_phdr</span> &#123;</span></span><br><span class="line">    Elf64_Word p_type;</span><br><span class="line">    Elf64_Word p_flags;</span><br><span class="line">    Elf64_Off p_offset;  <span class="comment">/* Segment file offset */</span></span><br><span class="line">    Elf64_Addr p_vaddr;  <span class="comment">/* Segment virtual address */</span></span><br><span class="line">    Elf64_Addr p_paddr;  <span class="comment">/* Segment physical address */</span></span><br><span class="line">    Elf64_Xword p_filesz; <span class="comment">/* Segment size in file */</span></span><br><span class="line">    Elf64_Xword p_memsz;  <span class="comment">/* Segment size in memory */</span></span><br><span class="line">    Elf64_Xword p_align;  <span class="comment">/* Segment alignment, file &amp; memory */</span></span><br><span class="line">&#125; Elf64_Phdr;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 节头数据结构（Elf32 和 Elf64）</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf32_shdr</span> &#123;</span></span><br><span class="line">    Elf32_Word sh_name;</span><br><span class="line">    Elf32_Word sh_type;</span><br><span class="line">    Elf32_Word sh_flags;</span><br><span class="line">    Elf32_Addr sh_addr;</span><br><span class="line">    Elf32_Off sh_offset;</span><br><span class="line">    Elf32_Word sh_size;</span><br><span class="line">    Elf32_Word sh_link;</span><br><span class="line">    Elf32_Word sh_info;</span><br><span class="line">    Elf32_Word sh_addralign;</span><br><span class="line">    Elf32_Word sh_entsize;</span><br><span class="line">&#125; Elf32_Shdr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf64_shdr</span> &#123;</span></span><br><span class="line">    Elf64_Word sh_name;       <span class="comment">/* Section name, index in string tbl */</span></span><br><span class="line">    Elf64_Word sh_type;       <span class="comment">/* Type of section */</span></span><br><span class="line">    Elf64_Xword sh_flags;     <span class="comment">/* Miscellaneous section attributes */</span></span><br><span class="line">    Elf64_Addr sh_addr;       <span class="comment">/* Section virtual addr at execution */</span></span><br><span class="line">    Elf64_Off sh_offset;      <span class="comment">/* Section file offset */</span></span><br><span class="line">    Elf64_Xword sh_size;      <span class="comment">/* Size of section in bytes */</span></span><br><span class="line">    Elf64_Word sh_link;       <span class="comment">/* Index of another section */</span></span><br><span class="line">    Elf64_Word sh_info;       <span class="comment">/* Additional section information */</span></span><br><span class="line">    Elf64_Xword sh_addralign; <span class="comment">/* Section alignment */</span></span><br><span class="line">    Elf64_Xword sh_entsize;   <span class="comment">/* Entry size if section holds table */</span></span><br><span class="line">&#125; Elf64_Shdr;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态链接信息结构（Android 特有）</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*<span class="type">linker_dtor_function_t</span>)</span><span class="params">()</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*<span class="type">linker_ctor_function_t</span>)</span><span class="params">(<span class="type">int</span>, <span class="type">char</span>**, <span class="type">char</span>**)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__work_around_b_24465209__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOINFO_NAME_LEN 128</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Android 中的 soinfo 结构体，用于表示动态链接库信息</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">soinfo</span> &#123;</span></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> defined(__work_around_b_24465209__)</span></span><br><span class="line">    <span class="type">char</span> old_name_[SOINFO_NAME_LEN];</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Phdr)</span>* phdr;</span><br><span class="line">    <span class="type">size_t</span> phnum;</span><br><span class="line">    ElfW(Addr) base;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    ElfW(Dyn)* dynamic;</span><br><span class="line">    soinfo* next;</span><br><span class="line">    <span class="type">uint32_t</span> flags_;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* strtab_;</span><br><span class="line">    ElfW(Sym)* symtab_;</span><br><span class="line">    <span class="type">size_t</span> nbucket_;</span><br><span class="line">    <span class="type">size_t</span> nchain_;</span><br><span class="line">    <span class="type">uint32_t</span>* bucket_;</span><br><span class="line">    <span class="type">uint32_t</span>* chain_;</span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> !defined(__LP64__)</span></span><br><span class="line">    ElfW(Addr)** unused4; <span class="comment">// DO NOT USE, maintained for compatibility</span></span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> defined(USE_RELA)</span></span><br><span class="line">    ElfW(Rela)* plt_rela_;</span><br><span class="line">    <span class="type">size_t</span> plt_rela_count_;</span><br><span class="line">    ElfW(Rela)* rela_;</span><br><span class="line">    <span class="type">size_t</span> rela_count_;</span><br><span class="line">    <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    ElfW(Rel)* plt_rel_;</span><br><span class="line">    <span class="type">size_t</span> plt_rel_count_;</span><br><span class="line">    ElfW(Rel)* rel_;</span><br><span class="line">    <span class="type">size_t</span> rel_count_;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">linker_ctor_function_t</span>* preinit_array_;</span><br><span class="line">    <span class="type">size_t</span> preinit_array_count_;</span><br><span class="line">    <span class="type">linker_ctor_function_t</span>* init_array_;</span><br><span class="line">    <span class="type">size_t</span> init_array_count_;</span><br><span class="line">    <span class="type">linker_dtor_function_t</span>* fini_array_;</span><br><span class="line">    <span class="type">size_t</span> fini_array_count_;</span><br><span class="line">    <span class="type">linker_ctor_function_t</span> init_func_;</span><br><span class="line">    <span class="type">linker_dtor_function_t</span> fini_func_;</span><br><span class="line">    <span class="type">size_t</span> ref_count_;</span><br><span class="line">    link_map link_map_head;</span><br><span class="line">    <span class="type">bool</span> constructors_called;</span><br><span class="line">    ElfW(Addr) load_bias;</span><br><span class="line">    <span class="type">bool</span> has_text_relocations;</span><br><span class="line">    <span class="type">bool</span> has_DT_SYMBOLIC;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如果是一个标准的soinfo结构，不会出现a1[1]，只能说壳ELF的soinfo魔改了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523145851806.png" alt="image-20250523145851806"></p>
<p>简单分析一下sub_3C94做了什么：</p>
<ol>
<li>构建soinfo实例，从一些硬编码的信息中，将soinfo实例进行初始化；</li>
<li>加载主so的依赖库；</li>
</ol>
<p>这些硬编码信息的偏移量是从a1获得的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523152403741.png" alt="image-20250523152403741" style="zoom: 67%;" />

<p>sub_49F0调用了sub_3C94。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523152508833.png" alt="image-20250523152508833" style="zoom:80%;" />

<p>v5的值与v1有关，v1的值与a1有关，a1的值来自sub_49f0的调用者——sub_4B54。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523152541657.png" alt="image-20250523152541657" style="zoom:80%;" />

<p>a1的值与a2有关，但在函数sub_6128中，a2的值是由a1得来的，因此，还得继续追踪sub_4B54的调用者。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523152738670.png" alt="image-20250523152738670"></p>
<p>sub_4B54有2个调用者，其中，sub_8c74很眼熟。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523153052668.png" alt="image-20250523153052668"></p>
<p>0x8AFC是JNI_OnLoad的函数地址，其实之前交叉引用sub_8C74的时候，发现没有函数引用sub_8C74，但JNI_OnLoad的伪代码里突然发现了sub_8c74。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523160437480.png" alt="image-20250523160437480" style="zoom: 50%;" />

<p>通过汇编代码，可以看到，BL指令的下一条指令就是sub_8C74，<strong>这种方式的调用可能让IDA无法正常分析了</strong>。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523162349320.png" alt="image-20250523162349320" style="zoom:80%;" />

<p>言归正传，也就是说，当壳so被加载起来后，会通过JNI_OnLoad，最终将主so进行解析并加载。</p>
<p>回到sub_3C94的调用者——sub_49F0。</p>
<p>只有当sub_3C94的返回值是奇数，才能进一步执行sub_4918，而sub_3C94的作用我们前面分析过了（将主so的元数据填到soinfo实例，然后加载主so的依赖），这里的sub_4918大概率是进一步完成主so的加载。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523163024028.png" alt="image-20250523163024028" style="zoom:80%;" />

<p>看到关于dynamic的字眼，大概率是重定位阶段。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523164348276.png" alt="image-20250523164348276"></p>
<p>点进sub_4000。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523165245625.png" alt="image-20250523165245625"></p>
<p>看到0x403，有点眼熟，搜了一下之前的内容，果然，v8是r_info的低32位，代表重定位过程，地址的修正规则，进一步说明当前函数是在进行重定位了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522182759789.png" alt="image-20250522182759789"></p>
<p>一般情况下，动态链接器会先对处理通用重定位（.rela.dyn或.rel.dyn），再处理 PLT 重定位（.rela.plt或.rel.plt）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523183558728.png" alt="image-20250523183558728"></p>
<p>再进入sub_5e6c观察。</p>
<ol>
<li><p>观察到0x38（56个字节），刚好是一个段表的大小。</p>
</li>
<li><p>调用了mprotect。</p>
</li>
</ol>
<p>基本可以确定，大概率是在处理各个LOAD段。</p>
<p>将begin_addr_pht_1类型改成elf64_phdr，IDA的伪代码将会更加清晰，下图是我分析后的sub_5E6C。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523184641892.png" alt="image-20250523184641892"></p>
<p>0x6474E552换成十进制是1685382482，可以通过010Editor知道其含义是PT_GNU_RELRO。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523190428752.png" alt="image-20250523190428752" style="zoom:80%;" />

<p>sub_5E6C 函数在处理 PT_GNU_RELRO 段。它的作用就是在“主SO”的重定位完成后，找到所有标记为 PT_GNU_RELRO 的程序段，并将这些段在内存中的对应区域设置为只读。这是ELF动态链接中的一个标准安全步骤，称为<strong>RELRO (Relocation Read-Only)</strong>，<strong>目的是保护那些在重定位后不应再被修改的数据段</strong>（如部分GOT表、.data.rel.ro段）免遭篡改。</p>
<p>既然，这里将RELRO的段设置成了只读，说明这个时候，所有的PHT都应该处于解密状态，尝试在这个时候读取PHT，将它们dump下来。</p>
<p>第1个参数代表程序头表（们）的起始地址，第2个参数代表数量，第3个参数还没分析。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523193144378.png" alt="image-20250523193144378"></p>
<p>使用frida脚本进行dump，需要注意，sub_5E6C是在壳so的JNI_OnLoad调用的，如果hook android_dlopen_ext，在onLeave回调时，hook sub_5E6C，那时就太晚了，JNI_OnLoad都执行完了，不会触发Interceptor.attach的trap。</p>
<p>因此，得hook call_constructors，在onEnter时进一步hook sub_5E6C，这个hook的时机是：壳so的内容映射到了内存中，但尚未执行init_proc、.init_array上的函数、JNI_OnLoad，这个时机就很完美。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 针对 call_constructors 进行 Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// 你手机的 linker64 中 call_constructors 的偏移量</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>); <span class="comment">// 目标 SO 文件</span></span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Hook 目标函数 sub_5E6C</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span>, <span class="string">&quot;Module libjiagu_64.so base_addr: &quot;</span>, secmodule.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>(); <span class="comment">// Hook 完成后解除</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 目标函数 sub_5E6C</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="comment">// sub_5E6C 的偏移</span></span><br><span class="line">    <span class="keyword">let</span> target_offset = <span class="number">0x5E6C</span>;</span><br><span class="line">    <span class="keyword">let</span> target_func = baseaddr.<span class="title function_">add</span>(target_offset);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_func, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] Hooking sub_5E6C at:&#x27;</span>, target_func);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取参数</span></span><br><span class="line">            <span class="keyword">let</span> begin_addr_pht = args[<span class="number">0</span>]; <span class="comment">// 第一个 PHT 条目的地址</span></span><br><span class="line">            <span class="keyword">let</span> nums_pht = args[<span class="number">1</span>]; <span class="comment">// PHT 条目数量</span></span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] PHT Parameters:&#x27;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;  - begin_addr_pht:&#x27;</span>, begin_addr_pht);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;  - nums_pht:&#x27;</span>, nums_pht);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;  - a3: 0x&#x27;</span> + args[<span class="number">2</span>].<span class="title function_">toString</span>(<span class="number">16</span>))</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 验证 PHT 条目数量</span></span><br><span class="line">            <span class="keyword">if</span> (nums_pht &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[-] Invalid PHT count:&#x27;</span>, nums_pht);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 计算 PHT 结束地址</span></span><br><span class="line">            <span class="keyword">let</span> pht_size_per_entry = <span class="number">56</span>; <span class="comment">// Elf64_Phdr 的大小为 56 字节</span></span><br><span class="line">            <span class="keyword">let</span> end_addr_pht = begin_addr_pht.<span class="title function_">add</span>(nums_pht * pht_size_per_entry);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 准备保存 PHT 数据</span></span><br><span class="line">            <span class="keyword">let</span> pht_data = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(nums_pht * pht_size_per_entry);</span><br><span class="line">            <span class="title class_">Memory</span>.<span class="title function_">copy</span>(pht_data, begin_addr_pht, nums_pht * pht_size_per_entry);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 保存到文件</span></span><br><span class="line">            <span class="keyword">let</span> file_path = <span class="string">&#x27;/data/data/com.oacia.apk_protect/pht_decrypt.bin&#x27;</span>;</span><br><span class="line">            <span class="keyword">let</span> file = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&#x27;wb&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (file &amp;&amp; file !== <span class="literal">null</span>) &#123;</span><br><span class="line">                file.<span class="title function_">write</span>(pht_data.<span class="title function_">readByteArray</span>(nums_pht * pht_size_per_entry));</span><br><span class="line">                file.<span class="title function_">flush</span>();</span><br><span class="line">                file.<span class="title function_">close</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] PHT dumped to:&#x27;</span>, file_path);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[-] Failed to open file:&#x27;</span>, file_path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] sub_5E6C returned:&#x27;</span>, retval);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动 Hook</span></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>结果如下（忽视掉进程终止^_^）。</p>
<p>可以发现：0x70089b4000 - 0x70088cd000 &#x3D; 0xe7000，而之前我们的分析中，偏移量0xe7000处是主so的起始地址，所以这里的a3是主so在内存中的基址。</p>
<p>同时，也可以看出来解密后的PHT的存放地址，和主so的ELF头并不在内存上相连（在之后的操作后就明白了，这里PHT的地址是堆的地址，主so的PHT是垃圾数据），与ELF头相连的PHT是垃圾数据填充的，或者说是加密的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523214928222.png" alt="image-20250523214928222"></p>
<p>将文件pull出来观察，看样子确实解密了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523200915894.png" alt="image-20250523200915894" style="zoom:67%;" />

<p>修改到之前脱掉的主so里去，现在可以清晰看到段表的内容了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523201154653.png" alt="image-20250523201154653"></p>
<p>至此，拿到了解密后的PHT，也知道了sub_5E6C的参数意义。</p>
<p>问题又来了，既然参数的意义分别是：第1个参数代表程序头表（们）的起始地址，第2个参数代表数量，第3个参数代表主so的基址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523220006379.png" alt="image-20250523220006379"></p>
<p>而soinfo的结构体是这样的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523220224280.png" alt="image-20250523220224280" style="zoom:80%;" />

<p>按理来说，soinfo偏移量为0的地方就是PHT的地址，而这里的a1-&gt;link_map_head.l_next实则指向了((byte*) a1) + 232，这说明在成员变量const Elf64_Phdr *phdr的前面，还有232字节，这232字节应该是360壳自定义的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523220603855.png" alt="image-20250523220603855"></p>
<p>添加后，第1个参数的位置对了，但第2个参数和第3个参数还是错的，说明还需要插入一些字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523220720253.png" alt="image-20250523220720253"></p>
<p>正常情况应该是这样。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_5E6C(a1-&gt;phdr, a1-&gt;phnum, a1-&gt;base)</span><br></pre></td></tr></table></figure>

<p>为了知道壳ELF是怎么解密出来的，大佬oacia写了一个IDA插件：stalker_trace_so，这个脚本可以追踪native函数的执行顺序，但似乎不分线程，而且也没有调用关系，下图是截的大佬oacia博客的图。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524093446012.png" alt="image-20250524093446012" style="zoom: 67%;" />

<p>我对这个脚本进行了二开，让打印更美观一点，而且要展示调用关系。</p>
<p>修改后，打印的内容好看了很多，能清晰地看到调用链。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">[ONEPLUS A6003::com.oacia.apk_protect ]-&gt; start Stalker on thread 11793</span><br><span class="line">Stalker started!</span><br><span class="line">[180 ms] [TID:11793] ENTER: JNI_OnLoad</span><br><span class="line">  [180 ms] [TID:11793] ENTER: .interpreter_wrap_int64_t</span><br><span class="line">    [180 ms] [TID:11793] ENTER: interpreter_wrap_int64_t</span><br><span class="line">      [181 ms] [TID:11793] ENTER: ._Znwm</span><br><span class="line">      [181 ms] [TID:11793] EXIT: ._Znwm</span><br><span class="line">    [181 ms] [TID:11793] EXIT: interpreter_wrap_int64_t</span><br><span class="line">    [182 ms] [TID:11793] ENTER: sub_13908</span><br><span class="line">      [182 ms] [TID:11793] ENTER: ._Znam</span><br><span class="line">      [182 ms] [TID:11793] EXIT: ._Znam</span><br><span class="line">      [184 ms] [TID:11793] ENTER: sub_11220</span><br><span class="line">        [184 ms] [TID:11793] ENTER: .memset</span><br><span class="line">        [185 ms] [TID:11793] EXIT: .memset</span><br><span class="line">        [186 ms] [TID:11793] ENTER: sub_9DD8</span><br><span class="line">        [186 ms] [TID:11793] EXIT: sub_9DD8</span><br><span class="line">      [187 ms] [TID:11793] EXIT: sub_11220</span><br><span class="line">      [190 ms] [TID:11793] ENTER: sub_E3E0</span><br><span class="line">      [190 ms] [TID:11793] EXIT: sub_E3E0</span><br><span class="line">      [190 ms] [TID:11793] ENTER: .calloc</span><br><span class="line">      [191 ms] [TID:11793] EXIT: .calloc</span><br><span class="line">    [191 ms] [TID:11793] EXIT: sub_13908</span><br><span class="line">  [191 ms] [TID:11793] EXIT: .interpreter_wrap_int64_t</span><br><span class="line">[193 ms] [TID:11793] EXIT: JNI_OnLoad</span><br><span class="line">[204 ms] [TID:11793] ENTER: .malloc</span><br><span class="line">  [204 ms] [TID:11793] ENTER: .free</span><br><span class="line">  [204 ms] [TID:11793] EXIT: .free</span><br><span class="line">[207 ms] [TID:11793] EXIT: .malloc</span><br><span class="line">[208 ms] [TID:11793] ENTER: sub_E648</span><br><span class="line">[209 ms] [TID:11793] EXIT: sub_E648</span><br><span class="line">[209 ms] [TID:11793] ENTER: ._ZdaPv</span><br><span class="line">[213 ms] [TID:11793] EXIT: ._ZdaPv</span><br><span class="line">[213 ms] [TID:11793] ENTER: sub_C918</span><br><span class="line">[213 ms] [TID:11793] EXIT: sub_C918</span><br><span class="line">[214 ms] [TID:11793] ENTER: sub_9988</span><br><span class="line">[214 ms] [TID:11793] EXIT: sub_9988</span><br><span class="line">[214 ms] [TID:11793] ENTER: sub_9964</span><br><span class="line">[214 ms] [TID:11793] EXIT: sub_9964</span><br><span class="line">[215 ms] [TID:11793] ENTER: sub_9AC4</span><br><span class="line">[216 ms] [TID:11793] EXIT: sub_9AC4</span><br><span class="line">[216 ms] [TID:11793] ENTER: .ffi_prep_cif</span><br><span class="line">  [216 ms] [TID:11793] ENTER: ffi_prep_cif</span><br><span class="line">    [217 ms] [TID:11793] ENTER: .ffi_prep_cif_machdep</span><br><span class="line">      [217 ms] [TID:11793] ENTER: ffi_prep_cif_machdep</span><br><span class="line">      [218 ms] [TID:11793] EXIT: ffi_prep_cif_machdep</span><br><span class="line">      [218 ms] [TID:11793] ENTER: .ffi_call</span><br><span class="line">        [218 ms] [TID:11793] ENTER: ffi_call</span><br><span class="line">          [218 ms] [TID:11793] ENTER: sub_1674C</span><br><span class="line">          [219 ms] [TID:11793] EXIT: sub_1674C</span><br><span class="line">          [219 ms] [TID:11793] ENTER: .ffi_call_SYSV</span><br><span class="line">            [219 ms] [TID:11793] ENTER: ffi_call_SYSV</span><br><span class="line">              [219 ms] [TID:11793] ENTER: sub_167BC</span><br><span class="line">                [220 ms] [TID:11793] ENTER: sub_1647C</span><br><span class="line">                [220 ms] [TID:11793] EXIT: sub_1647C</span><br><span class="line">                [220 ms] [TID:11793] ENTER: sub_163DC</span><br><span class="line">                [220 ms] [TID:11793] EXIT: sub_163DC</span><br><span class="line">              [221 ms] [TID:11793] EXIT: sub_167BC</span><br><span class="line">            [221 ms] [TID:11793] EXIT: ffi_call_SYSV</span><br><span class="line">            [221 ms] [TID:11793] ENTER: sub_9900</span><br><span class="line">            [222 ms] [TID:11793] EXIT: sub_9900</span><br><span class="line">          [222 ms] [TID:11793] EXIT: .ffi_call_SYSV</span><br><span class="line">        [222 ms] [TID:11793] EXIT: ffi_call</span><br><span class="line">      [222 ms] [TID:11793] EXIT: .ffi_call</span><br><span class="line">    [223 ms] [TID:11793] EXIT: .ffi_prep_cif_machdep</span><br><span class="line">    [224 ms] [TID:11793] ENTER: sub_94BC</span><br><span class="line">      [224 ms] [TID:11793] ENTER: .dladdr</span><br><span class="line">      [226 ms] [TID:11793] EXIT: .dladdr</span><br><span class="line">    [226 ms] [TID:11793] EXIT: sub_94BC</span><br><span class="line">  [226 ms] [TID:11793] EXIT: ffi_prep_cif</span><br><span class="line">[226 ms] [TID:11793] EXIT: .ffi_prep_cif</span><br><span class="line">[226 ms] [TID:11793] ENTER: .strstr</span><br><span class="line">[227 ms] [TID:11793] EXIT: .strstr</span><br><span class="line">[231 ms] [TID:11793] ENTER: .setenv</span><br><span class="line">[232 ms] [TID:11793] EXIT: .setenv</span><br><span class="line">[235 ms] [TID:11793] ENTER: _Z9__arm_a_1P7_JavaVMP7_JNIEnvPvRi</span><br><span class="line">[239 ms] [TID:11793] EXIT: _Z9__arm_a_1P7_JavaVMP7_JNIEnvPvRi</span><br><span class="line">[241 ms] [TID:11793] ENTER: sub_9E58</span><br><span class="line">  [242 ms] [TID:11793] ENTER: sub_999C</span><br><span class="line">  [242 ms] [TID:11793] EXIT: sub_999C</span><br><span class="line">[242 ms] [TID:11793] EXIT: sub_9E58</span><br><span class="line">[242 ms] [TID:11793] ENTER: sub_10964</span><br><span class="line">  [243 ms] [TID:11793] ENTER: j_._ZdlPv_1</span><br><span class="line">    [243 ms] [TID:11793] ENTER: ._ZdlPv</span><br><span class="line">      [245 ms] [TID:11793] ENTER: sub_96E0</span><br><span class="line">      [246 ms] [TID:11793] EXIT: sub_96E0</span><br><span class="line">    [246 ms] [TID:11793] EXIT: ._ZdlPv</span><br><span class="line">    [246 ms] [TID:11793] ENTER: sub_8000</span><br><span class="line">      [246 ms] [TID:11793] ENTER: .strncpy</span><br><span class="line">      [247 ms] [TID:11793] EXIT: .strncpy</span><br><span class="line">      [247 ms] [TID:11793] ENTER: sub_60E0</span><br><span class="line">      [247 ms] [TID:11793] EXIT: sub_60E0</span><br><span class="line">      [247 ms] [TID:11793] ENTER: sub_6544</span><br><span class="line">      [248 ms] [TID:11793] EXIT: sub_6544</span><br><span class="line">      [248 ms] [TID:11793] ENTER: sub_4B54</span><br><span class="line">        [248 ms] [TID:11793] ENTER: sub_6128</span><br><span class="line">        [248 ms] [TID:11793] EXIT: sub_6128</span><br><span class="line">        [248 ms] [TID:11793] ENTER: _ZN9__arm_c_19__arm_c_0Ev</span><br><span class="line">        [250 ms] [TID:11793] EXIT: _ZN9__arm_c_19__arm_c_0Ev</span><br><span class="line">        [250 ms] [TID:11793] ENTER: sub_A3EC</span><br><span class="line">          [250 ms] [TID:11793] ENTER: sub_99CC</span><br><span class="line">            [250 ms] [TID:11793] ENTER: sub_9944</span><br><span class="line">            [250 ms] [TID:11793] EXIT: sub_9944</span><br><span class="line">          [251 ms] [TID:11793] EXIT: sub_99CC</span><br><span class="line">        [251 ms] [TID:11793] EXIT: sub_A3EC</span><br><span class="line">      [252 ms] [TID:11793] EXIT: sub_4B54</span><br><span class="line">    [254 ms] [TID:11793] EXIT: sub_8000</span><br><span class="line">  [254 ms] [TID:11793] EXIT: j_._ZdlPv_1</span><br><span class="line">[254 ms] [TID:11793] EXIT: sub_10964</span><br><span class="line">[257 ms] [TID:11793] ENTER: sub_6484</span><br><span class="line">  [257 ms] [TID:11793] ENTER: sub_6590</span><br><span class="line">    [257 ms] [TID:11793] ENTER: .memcpy</span><br><span class="line">    [258 ms] [TID:11793] EXIT: .memcpy</span><br><span class="line">    [258 ms] [TID:11793] ENTER: sub_6698</span><br><span class="line">      [260 ms] [TID:11793] ENTER: sub_9FFC</span><br><span class="line">      [261 ms] [TID:11793] EXIT: sub_9FFC</span><br><span class="line">    [268 ms] [TID:11793] EXIT: sub_6698</span><br><span class="line">    [268 ms] [TID:11793] ENTER: j_._ZdlPv_3</span><br><span class="line">      [268 ms] [TID:11793] ENTER: j_._ZdlPv_2</span><br><span class="line">        [269 ms] [TID:11793] ENTER: j_._ZdlPv_0</span><br><span class="line">          [269 ms] [TID:11793] ENTER: sub_A3A0</span><br><span class="line">            [269 ms] [TID:11793] ENTER: sub_9A90</span><br><span class="line">            [269 ms] [TID:11793] EXIT: sub_9A90</span><br><span class="line">          [269 ms] [TID:11793] EXIT: sub_A3A0</span><br><span class="line">        [270 ms] [TID:11793] EXIT: j_._ZdlPv_0</span><br><span class="line">      [270 ms] [TID:11793] EXIT: j_._ZdlPv_2</span><br><span class="line">      [270 ms] [TID:11793] ENTER: sub_5F20</span><br><span class="line">      [271 ms] [TID:11793] EXIT: sub_5F20</span><br><span class="line">    [271 ms] [TID:11793] EXIT: j_._ZdlPv_3</span><br><span class="line">    [271 ms] [TID:11793] ENTER: sub_6044</span><br><span class="line">    [276 ms] [TID:11793] EXIT: sub_6044</span><br><span class="line">  [276 ms] [TID:11793] EXIT: sub_6590</span><br><span class="line">  [276 ms] [TID:11793] ENTER: sub_3574</span><br><span class="line">    [276 ms] [TID:11793] ENTER: .uncompress</span><br><span class="line">    [279 ms] [TID:11793] EXIT: .uncompress</span><br><span class="line">  [279 ms] [TID:11793] EXIT: sub_3574</span><br><span class="line">[281 ms] [TID:11793] EXIT: sub_6484</span><br><span class="line">[316 ms] [TID:11793] ENTER: sub_49F0</span><br><span class="line">  [316 ms] [TID:11793] ENTER: sub_5400</span><br><span class="line">  [316 ms] [TID:11793] EXIT: sub_5400</span><br><span class="line">  [316 ms] [TID:11793] ENTER: sub_5478</span><br><span class="line">    [316 ms] [TID:11793] ENTER: sub_5B08</span><br><span class="line">    [318 ms] [TID:11793] EXIT: sub_5B08</span><br><span class="line">  [320 ms] [TID:11793] EXIT: sub_5478</span><br><span class="line">  [320 ms] [TID:11793] ENTER: sub_5650</span><br><span class="line">  [321 ms] [TID:11793] EXIT: sub_5650</span><br><span class="line">  [321 ms] [TID:11793] ENTER: sub_580C</span><br><span class="line">    [322 ms] [TID:11793] ENTER: .mprotect</span><br><span class="line">    [322 ms] [TID:11793] EXIT: .mprotect</span><br><span class="line">  [324 ms] [TID:11793] EXIT: sub_580C</span><br><span class="line">[324 ms] [TID:11793] EXIT: sub_49F0</span><br><span class="line">[325 ms] [TID:11793] ENTER: .strlen</span><br><span class="line">[325 ms] [TID:11793] EXIT: .strlen</span><br><span class="line">[325 ms] [TID:11793] ENTER: sub_3C94</span><br><span class="line">  [327 ms] [TID:11793] ENTER: .dlopen</span><br><span class="line">  [328 ms] [TID:11793] EXIT: .dlopen</span><br><span class="line">[330 ms] [TID:11793] EXIT: sub_3C94</span><br><span class="line">[352 ms] [TID:11793] ENTER: sub_4918</span><br><span class="line">  [353 ms] [TID:11793] ENTER: sub_4000</span><br><span class="line">    [353 ms] [TID:11793] ENTER: sub_41B4</span><br><span class="line">      [354 ms] [TID:11793] ENTER: sub_35AC</span><br><span class="line">      [355 ms] [TID:11793] EXIT: sub_35AC</span><br><span class="line">    [355 ms] [TID:11793] EXIT: sub_41B4</span><br><span class="line">    [356 ms] [TID:11793] ENTER: .dlsym</span><br><span class="line">    [357 ms] [TID:11793] EXIT: .dlsym</span><br><span class="line">  [358 ms] [TID:11793] EXIT: sub_4000</span><br><span class="line">[359 ms] [TID:11793] EXIT: sub_4918</span><br><span class="line">[369 ms] [TID:11793] ENTER: sub_5E6C</span><br><span class="line">[370 ms] [TID:11793] EXIT: sub_5E6C</span><br><span class="line">[370 ms] [TID:11793] ENTER: sub_5444</span><br><span class="line">[370 ms] [TID:11793] EXIT: sub_5444</span><br><span class="line">[386 ms] [TID:11793] ENTER: sub_633C</span><br><span class="line">[386 ms] [TID:11793] EXIT: sub_633C</span><br><span class="line">[386 ms] [TID:11793] ENTER: sub_8130</span><br><span class="line">  [387 ms] [TID:11793] ENTER: sub_4C70</span><br><span class="line">  [387 ms] [TID:11793] EXIT: sub_4C70</span><br><span class="line">[388 ms] [TID:11793] EXIT: sub_8130</span><br><span class="line">[388 ms] [TID:11793] ENTER: sub_825C</span><br><span class="line">[389 ms] [TID:11793] EXIT: sub_825C</span><br><span class="line">[389 ms] [TID:11793] ENTER: sub_8B50</span><br><span class="line">[390 ms] [TID:11793] EXIT: sub_8B50</span><br><span class="line">[390 ms] [TID:11793] ENTER: sub_8ED4</span><br><span class="line">[391 ms] [TID:11793] EXIT: sub_8ED4</span><br><span class="line">[391 ms] [TID:11793] ENTER: sub_8430</span><br><span class="line">[394 ms] [TID:11793] EXIT: sub_8430</span><br><span class="line">[395 ms] [TID:11793] ENTER: interpreter_wrap_int64_t_bridge</span><br><span class="line">  [397 ms] [TID:11793] ENTER: sub_9D60</span><br><span class="line">  [398 ms] [TID:11793] EXIT: sub_9D60</span><br><span class="line">[398 ms] [TID:11793] EXIT: interpreter_wrap_int64_t_bridge</span><br><span class="line">[780 ms] [TID:11793] ENTER: sub_166C4</span><br><span class="line">[781 ms] [TID:11793] EXIT: sub_166C4</span><br><span class="line">[782 ms] [TID:11793] ENTER: .puts</span><br><span class="line">[787 ms] [TID:11793] EXIT: .puts</span><br><span class="line">[1642 ms] [TID:11793] ENTER: sub_115AA0</span><br><span class="line">[1643 ms] [TID:11793] EXIT: sub_115AA0</span><br><span class="line">[1781 ms] [TID:11793] ENTER: _Z9__arm_a_2PcmS_Rii</span><br><span class="line">[1790 ms] [TID:11793] EXIT: _Z9__arm_a_2PcmS_Rii</span><br><span class="line">[2069 ms] [TID:11793] ENTER: .ffi_prep_cif_var</span><br><span class="line">  [2070 ms] [TID:11793] ENTER: ffi_prep_cif_var</span><br><span class="line">  [2070 ms] [TID:11793] EXIT: ffi_prep_cif_var</span><br><span class="line">[2070 ms] [TID:11793] EXIT: .ffi_prep_cif_var</span><br></pre></td></tr></table></figure>

<p>脚本链接：<strong><a target="_blank" rel="noopener" href="https://github.com/X14Nuy/Call_Trace">Call_Trace</a></strong>，如果觉得好用，麻烦点个星星，┭┮﹏┭┮这对我找工作真的很重要。——脚本是有局限的，在github里写了，如果只想要观察调用顺序而不需要调用关系，可以把打印内容的EXIT全部去掉，再把缩进也去掉，这样就恢复成原来oacia大佬的脚本了。<strong>由于这是360壳，有些调用不是标准的RET退栈，所以调用关系可能会有问题</strong>。</p>
<p>继续分析。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524152046692.png" alt="image-20250524152046692" style="zoom:67%;" />

<p>在解压缩操作附近的函数进行查看，发现存在RC4加密。</p>
<p>下面这个是标准RC4的KSA步骤。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524153516529.png" alt="image-20250524153516529" style="zoom: 67%;" />

<p>修改一下变量名，简单明了，和标准RC4一模一样，如果想得到密钥的值，hook sub_5F20，然后得到第1个参数的值即可。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524154214898.png" alt="image-20250524154214898"></p>
<p>hook rc4的密钥脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 针对 call_constructors 进行 Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// 你手机的 linker64 中 call_constructors 的偏移量</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>); <span class="comment">// 目标 SO 文件</span></span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Hook 目标函数 sub_5E6C</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span>, <span class="string">&quot;Module libjiagu_64.so base_addr: &quot;</span>, secmodule.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>(); <span class="comment">// Hook 完成后解除</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 目标函数 sub_5f20</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="comment">// sub_5E6C 的偏移</span></span><br><span class="line">    <span class="keyword">let</span> target_offset = <span class="number">0x5f20</span>;</span><br><span class="line">    <span class="keyword">let</span> target_func = baseaddr.<span class="title function_">add</span>(target_offset);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_func, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] Hooking sub_5f20 at:&#x27;</span>, target_func);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;rc4 key:&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">0</span>], &#123;<span class="attr">length</span>: <span class="number">64</span>&#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] sub_5f20 returned:&#x27;</span>, retval);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动 Hook</span></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>结果如下图所示，提取密钥，如果之后要用就方便了。0x76,0x55,0x56,0x34,0x23,0x91,0x23,0x53,0x56,0x74。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524215504808.png" alt="image-20250524215504808" style="zoom:80%;" />

<p>按理来说，在ksa之后，应该会调用rc4的PRGA算法，然后进行rc4解密，再进行压缩，所以这里继续追踪sub_6044和sub_3574进行查看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524154405943.png" alt="image-20250524154405943"></p>
<p>先看sub_3574，这里直接调用了uncompress，那大概率sub_6044就是rc4_PRGA算法。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524154735343.png" alt="image-20250524154735343" style="zoom:80%;" />

<p>标准的RC4_PRGA算法是这样的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524154857110.png" alt="image-20250524154857110" style="zoom: 67%;" />

<p>而sub_6044是这样的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524154817260.png" alt="image-20250524154817260"></p>
<p>修改变量名后，如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524214255632.png" alt="image-20250524214255632"></p>
<p>在进行rc4解密后，主so的内容仍然是不可用的，还需要进行解压缩。sub_6044的下一个函数调用是sub_3574，而sub_3574直接调用uncompress，然后发现uncompress位于导入表，那大概率就是zlib库的uncompress了。</p>
<p>下面是uncompress的函数签名。</p>
<p><em><strong>int uncompress(Bytef *dest, uLongf *destLen, const Bytef *source, uLong sourceLen);</strong></em></p>
<p>根据这个函数签名，我们可以hook它，得到解压缩后的内容。</p>
<p>但在hook uncompress之前，先hook rc4_prga，通过它，可以获得加密主so的地址和内容的大小。</p>
<p>脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 针对 call_constructors 进行 Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// 手机的 linker64 中 call_constructors 的偏移量</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>); <span class="comment">// 目标 SO 文件</span></span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Hook 目标函数 sub_6044</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span>, <span class="string">&quot;Module libjiagu_64.so base_addr: &quot;</span>, secmodule.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>(); <span class="comment">// Hook 完成后解除</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 目标函数 sub_6044</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="comment">// sub_6044 的偏移</span></span><br><span class="line">    <span class="keyword">let</span> target_offset = <span class="number">0x6044</span>;</span><br><span class="line">    <span class="keyword">let</span> target_func = baseaddr.<span class="title function_">add</span>(target_offset);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_func, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] Hooking sub_6044 at:&#x27;</span>, target_func);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;encrypt 主elf addr:&quot;</span>, <span class="string">&quot;0x&quot;</span> + (args[<span class="number">0</span>] - baseaddr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;encrypt 主elf size:&quot;</span>, <span class="string">&quot;0x&quot;</span> + args[<span class="number">1</span>].<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;解密前:&quot;</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">0</span>], &#123;<span class="attr">length</span>: <span class="number">64</span>&#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;解密后:&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>, &#123;<span class="attr">length</span>: <span class="number">64</span>&#125;))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动 Hook</span></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>打印结果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525103239983.png" alt="image-20250525103239983"></p>
<p>0x74783ff0肯定不是一个正常的偏移量，估计做过转移（比如malloc申请空间，存到别的地方去了），真正的主so加密数据应该是在壳so的某个偏移。</p>
<p>尝试在壳so文件搜索加密前的内容——用010editor在文件中在搜索 01 18 25 e7…</p>
<p>可以发现，加密数据存放于libjiagu_64_after_open_fixed.so的0x2e270的位置，这是我之前趁着open(“…&#x2F;xxx.dex”)的时候dump下来的libjiagu_a64.so。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525110933159.png" alt="image-20250525110933159" style="zoom:80%;" />

<p>而在assets目录下的libjiagu_a64.so中，这段加密内容位于0x1E270的位置。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525111242312.png" alt="image-20250525111242312" style="zoom: 80%;" />

<p>估计是加载过程中对齐的缘故，又或者是360壳把把主so的基址设在了64K位置（0x10000）。</p>
<p>如果之后我们想直接从壳so中获得主so，用的是0x1E270，但分析的时候，继续用0x2e270。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525112814418.png" alt="image-20250525112814418"></p>
<p>对这个变量名交叉引用，只有函数sub_8000引用了它。</p>
<p>可以发现，0xB8010正是sub_6044第2个参数的值，代表着RC4加密后主so的大小。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525112854039.png" alt="image-20250525112854039" style="zoom:67%;" />

<p>接着hook uncompress，由于uncompress是系统库的函数，不需要考虑360壳做手脚，直接hook。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 针对 call_constructors 进行 Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// 手机的 linker64 中 call_constructors 的偏移量</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>); <span class="comment">// 目标 SO 文件</span></span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Hook 目标函数 sub_6044</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span>, <span class="string">&quot;Module libjiagu_64.so base_addr: &quot;</span>, secmodule.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>(); <span class="comment">// Hook 完成后解除</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 目标函数 sub_6044</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="comment">// sub_6044 的偏移</span></span><br><span class="line">    <span class="keyword">let</span> target_offset = <span class="number">0x6044</span>;</span><br><span class="line">    <span class="keyword">let</span> target_func = baseaddr.<span class="title function_">add</span>(target_offset);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_func, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] Hooking sub_6044 at:&#x27;</span>, target_func);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;encrypt 主elf在内存中的实际位置:&quot;</span>, <span class="string">&quot;0x&quot;</span> + args[<span class="number">0</span>].<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;encrypt 主elf在rc4加密后的大小:&quot;</span>, <span class="string">&quot;0x&quot;</span> + args[<span class="number">1</span>].<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;解密前:&quot;</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">0</span>], &#123;<span class="attr">length</span>: <span class="number">64</span>&#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;解密后:&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>, &#123;<span class="attr">length</span>: <span class="number">64</span>&#125;))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_uncompress_res</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;uncompress&quot;</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hook uncompress&quot;</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;解压缩前:&quot;</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">2</span>], &#123;</span><br><span class="line">              <span class="attr">offset</span>: <span class="number">0</span>,<span class="comment">// 相对偏移</span></span><br><span class="line">              <span class="attr">length</span>: <span class="number">64</span>,<span class="comment">//dump 的大小</span></span><br><span class="line">              <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">            &#125;));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;解压缩前的大小:&quot;</span>,args[<span class="number">3</span>])</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动 Hook</span></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_linker_call_constructors</span>();</span><br><span class="line">    <span class="title function_">hook_uncompress_res</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>打印的结果如下。</p>
<p>很容易猜到，rc4解密后的数据的前4个字节用来表示解压后的主so的大小（<strong>0x1a0eb9</strong>）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525113844217.png" alt="image-20250525113844217"></p>
<p>现在我们已经知道了主so的位置（0x1e270）、加密的算法与密钥（rc4和”0x76,0x55,0x56,0x34,0x23,0x91,0x23,0x53,0x56,0x74”）、解压用的函数及解压后的大小（zlib的uncompress和0x1a0eb9），现在可以很轻易地从壳so中直接得到主so解密的内容。</p>
<p>写脚本脱下来看看——这边直接抄了oacia大佬的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">RC4</span>(<span class="params">data, key</span>):</span><br><span class="line">    S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    out = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># KSA Phase</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># PRGA Phase</span></span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> data:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + S[i]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">        out.append(ch ^ S[(S[i] + S[j]) % <span class="number">256</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">RC4decrypt</span>(<span class="params">ciphertext, key</span>):</span><br><span class="line">    <span class="keyword">return</span> RC4(ciphertext, key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wrap_elf_start = <span class="number">0x1e270</span></span><br><span class="line">wrap_elf_size = <span class="number">0xb8010</span></span><br><span class="line">key = <span class="string">b&quot;vUV4#\x91#SVt&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;com.oacia.apk_protect/assets/libjiagu_a64.so&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    wrap_elf = f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对密文进行解密</span></span><br><span class="line">dec_compress_elf = RC4decrypt(wrap_elf[wrap_elf_start:wrap_elf_start+wrap_elf_size], key)</span><br><span class="line">dec_elf = zlib.decompress(<span class="built_in">bytes</span>(dec_compress_elf[<span class="number">4</span>::]))</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;wrap_elf&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(dec_elf)</span><br></pre></td></tr></table></figure>

<p>将得到的wrap_elf放到010editor查看，一大堆D3。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525115700120.png" alt="image-20250525115700120" style="zoom: 80%;" />

<p>往下面看，发现存在ELF文件的特征，而ELF文件之前导出都是D3。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525132029227.png" alt="image-20250525132029227" style="zoom:67%;" />

<p>可以将这里理解为2段数据，part1为D3相关的加密，part2为ELF文件头（可能还有其它内容）。</p>
<p>这里对wrap_elf进行切割。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;wrap_elf&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    wrap_elf = f.read()</span><br><span class="line">ELF_magic = <span class="built_in">bytes</span>([<span class="number">0x7F</span>, <span class="number">0x45</span>, <span class="number">0x4C</span>, <span class="number">0x46</span>])</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(wrap_elf) - <span class="built_in">len</span>(ELF_magic) + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">if</span> wrap_elf[i:i + <span class="built_in">len</span>(ELF_magic)] == ELF_magic:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(i))</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;wrap_elf_part1&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(wrap_elf[<span class="number">0</span>:i])</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;wrap_elf_part2&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(wrap_elf[i::])</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>打开wrap_elf_part2，发现PHT填充了一堆垃圾数据（可能是加密数据，但我更倾向于PHT放在了别的地方）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525133553692.png" alt="image-20250525133553692"></p>
<p>往下分析，要进行重定位的话，要么是part2的PHT解密了，要么是PHT放在了其它地方。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525133145413.png" alt="image-20250525133145413"></p>
<p>对其中的函数进行分析。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525142521149.png" alt="image-20250525142521149"></p>
<p>一般加载一个so的时候，申请mmap空间之前需要有PHT，先读取PHT上写着的LOAD加载地址、大小、对齐方式等，再调用mmap进行申请。</p>
<p>因此，sub_5B08大概率在获得正确的PHT，点进来一看，发现存在常量0x38，刚好是一个PHT的大小，更说明猜测是对的了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525143259739.png" alt="image-20250525143259739" style="zoom:67%;" />

<p>pht_buffer与xor_key进行异或，异或的xor_key来自于a2+16。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525150624560.png" alt="image-20250525150624560" style="zoom:80%;" />

<p>hook一下，查看xor_key的内容是多少。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 针对 call_constructors 进行 Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// 手机的 linker64 中 call_constructors 的偏移量</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>); <span class="comment">// 目标 SO 文件</span></span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span>, <span class="string">&quot;Module libjiagu_64.so base_addr: &quot;</span>, secmodule.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>(); <span class="comment">// Hook 完成后解除</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> target_offset = <span class="number">0x5B08</span>;</span><br><span class="line">    <span class="keyword">let</span> target_func = baseaddr.<span class="title function_">add</span>(target_offset);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_func, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[xor_key]:&quot;</span>, <span class="string">&quot;0x&quot;</span>+args[<span class="number">1</span>].<span class="title function_">add</span>(<span class="number">16</span>).<span class="title function_">readPointer</span>().<span class="title function_">readU8</span>().<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动 Hook</span></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_linker_call_constructors</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>脚本执行结果是0xd3，说明真正的PHT很可能就是part1解密后的内容。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525152209680.png" alt="image-20250525152209680"></p>
<p>除了异或，解密的循环还有arm64的neon运算。</p>
<p>NEON 是 ARM 架构的 SIMD 扩展，提供一组专用的寄存器和指令，用于并行处理多个数据元素。</p>
<p>下面两个链接介绍了sub_5B08中出现的vdupq_n_s8和veorq_s8。</p>
<p><a target="_blank" rel="noopener" href="https://developer.arm.com/architectures/instruction-sets/intrinsics/#q=vdupq_n_s8">https://developer.arm.com/architectures/instruction-sets/intrinsics/#q=vdupq_n_s8</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.arm.com/architectures/instruction-sets/intrinsics/#q=veorq_s8">https://developer.arm.com/architectures/instruction-sets/intrinsics/#q=veorq_s8</a></p>
<p>简单来说，一个字节一个字节的异或效率太低，而neon可以一次性异或16个字节。——根本不影响阅读。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525162553594.png" alt="image-20250525162553594" style="zoom:80%;" />

<p>分析了一下，突然意识到v2似乎指向part2。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525155237926.png" alt="image-20250525155237926"></p>
<p>打印一下看看。（脚本就不提供了，跟查看xor_key的脚本差不多）</p>
<p>下面这内容不就是part1的内容？</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525155415726.png" alt="image-20250525155415726"></p>
<p>也就是说，part1的第1个字节是xor_key，接下来的4个字节是长度（0x150），再接下来的0x150个字节是待异或的内容，注意到，我们之前分析的主so有6个pht，每个pht大小是0x38，加起来不就是0x150个字节吗？所以说，part1的前0x155字节与pht相关。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525155524905.png" alt="image-20250525155524905"></p>
<p>整理了一下，假如每次要处理的数据量都很小，那每次的处理数据的方式都是逐字节异或，然后goto到下一块要处理的数据，整个sub_5B08有4个这样子的结构，因此有4块数据。</p>
<p>数据的分布结构是这样的：xor_key（1个字节）、data1_len（4个字节）、data1、data2_len（4个字节）、data2、data3_len（4个字节）、data3、data4_len、data4。</p>
<p>之前提过，soinfo中存在一些360壳的字段，而在sub_5B08可以推测一些字段了。</p>
<p>关于data1的相关字段。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525163327040.png" alt="image-20250525163327040" style="zoom:67%;" />

<p>关于data2的相关字段。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525163402407.png" alt="image-20250525163402407" style="zoom: 67%;" />

<p>关于data3的相关字段。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525163427141.png" alt="image-20250525163427141" style="zoom: 67%;" />

<p>关于data4的相关字段。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525163513117.png" alt="image-20250525163513117" style="zoom:67%;" />

<p>最后还有elf的相关字段，这里的v16、v27、v38、pht_total_size有3个是数据的大小，还有有一个是基址；17是1个字节的xor_key和4个4字节的data_len。</p>
<p>想想wrap_elf，part1基本都是0xD3，而part2是ELF文件，不难想出，a1的第152个字节指向elf起始地址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525164721162.png" alt="image-20250525164721162"></p>
<p>原先的soinfo是这样的。前232字节由于不知道是什么，直接当成一个char数组，暂时没做处理。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525163608632.png" alt="image-20250525163608632" style="zoom:80%;" />

<p>根据分析，可以这么设置。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525170510570.png" alt="image-20250525170510570" style="zoom:80%;" />

<p>但是想了想，似乎不太合适，这样子先入为主地认为之前的那个数据结构是soinfo了，虽然的确很像，如果如上图这么设置，pht_buffer和phdr是同一个意思，应该不会这么设计。</p>
<p>依照其它人的博客的意思，老老实实创建当前这个结构体即可，不要往soinfo去想，因为一开始的soinfo也是猜测。</p>
<p>因此，这里的Four_Section不需要凑232个字节了，只需要满足偏移量在对应的地方即可，结构体应该如下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525201455502.png" alt="image-20250525201455502" style="zoom:80%;" />

<p>既然sub_5B08的第1个参数是Four_Section，查看它的引用函数，传参的那个变量的类型也应该是Four_Section。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525201744955.png" alt="image-20250525201744955"></p>
<p>继续查看引用sub_5478函数，将v14变量的类型改成Four_Section*，然后发现不对，存在2个问题。</p>
<ol>
<li>v14的类型是Four_Section*，为什么还要取地址再转成(Four_Section*)？</li>
<li>v7_1[29] &#x3D; v9，v9 &#x3D; v16，但v16的值呢？</li>
</ol>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525201939099.png" alt="image-20250525201939099"></p>
<p>针对上述两个问题，其实说明v14的类型取错了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525202237290.png" alt="image-20250525202237290"></p>
<p>这里的v15-v23找不到赋值的地方，它们很有可能是和v14作为一个完整的结构体对象，一起作为参数赋值的，而我们这边将v14设置成指针类型，导致将v14与v15-v23进行了切割。只需要把v14的指针符号去掉即可。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525202441708.png" alt="image-20250525202441708" style="zoom:80%;" />

<p>再根据下图的逻辑，定义新的结构体。v7_1申请了0x1E0个空间，因此，我们需要创建的结构体大小应该也是0x1E0。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525202608074.png" alt="image-20250525202608074"></p>
<p>创建的结构体是这样的，注：168个字节中，可能有好几个成员变量类型。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525203507669.png" alt="image-20250525203507669"></p>
<p>其实到这一步，也能看出之前想的soinfo是错误的，因此要回到用到了soinfo的地方，把类型改成FourSection_t，然后观察section2&#x2F;3&#x2F;4到底是什么。</p>
<p>sub_3c94是设置重定位表、符号表等内容的函数，可以看出来section4存放的是.dynamic节（一般DT_DYNAMIC只含一个.dynamic节）。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525204112819.png" alt="image-20250525204112819" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525203811167.png" alt="image-20250525203811167"></p>
<p>而在函数sub_4918中，我们判断第1次调用sub_4000是进行常规重定位（对数据和指令的重定位），第2次调用sub_4000是进行plt重定位（大部分情况是对符号的重定位）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525204312795.png" alt="image-20250525204312795"></p>
<p>快有点模糊d_tag和r_info的区别了…这里的0x402和0x403分别是R_AARCH64_JUMP_SLOT、R_AARCH64_RELATIVE，是一种计算修正地址的规则，而这种规则分别常用于.rela.plt和.rela.dyn，<strong>因此认为这里的section3和2分别指向.rela.dyn和.rela.plt</strong>。</p>
<p>区分.rela.plt和.rela.dyn的方式是d_tag，d_tag &#x3D;&#x3D; DT_RELA是后者，d_tag &#x3D;&#x3D; DT_JMPREL是前者。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525210705157.png" alt="image-20250525210705157"></p>
<p>至此，重命名一下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525211112557.png" alt="image-20250525211112557" style="zoom: 80%;" />

<p>总结一下释放主so的流程：</p>
<ol>
<li><p>wrap_elf位于assets&#x2F;libjiagu_a64.so的0x1e270的位置。</p>
</li>
<li><p>wrap_elf经过rc4解密（密钥：b”vUV4#\x91#SVt”）后，是一个长度为0xb8010的压缩数据A，真正参与解压的数据是A[4:]，也就是说，参与解压的数据的大小是0xb800C，前4个字节描述了解压后数据的大小。</p>
</li>
<li><p>解压后的数据视作wrap_elf，而wrap_elf里分为part1和part2两部分，part1被0xD3异或加密，part2指向一个ELF文件，但PHT、.dynamic节的等内容均被垃圾数据占满。</p>
</li>
<li><p>part1里有<strong>4组</strong>数据，它的<strong>数据结构</strong>是这样：xor_key（1个字节）、data1_len（4个字节）、data1、data2_len（4个字节）、data2、data3_len（4个字节）、data3、data4_len、data4；</p>
</li>
<li><p>data1-data4分别是被0xD3异或加密的PHT、.rela.plt、.rela.dyn、.dynamic。</p>
</li>
</ol>
<p>需要注意，<strong>0x1e270是在壳so文件里wrap_elf的偏移，而在内存中，wrap_elf的偏移来到了0x2e270，原0x1e270被清空了；之后的主so加载的基址是0xe7000。</strong></p>
<p>通过下面这个脚本，可以从壳so里直接获得4个解密后的section。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">RC4</span>(<span class="params">data, key</span>):</span><br><span class="line">    S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    out = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># KSA Phase</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># PRGA Phase</span></span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> data:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + S[i]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">        out.append(ch ^ S[(S[i] + S[j]) % <span class="number">256</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">RC4decrypt</span>(<span class="params">ciphertext, key</span>):</span><br><span class="line">    <span class="keyword">return</span> RC4(ciphertext, key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wrap_elf_start = <span class="number">0x1e270</span></span><br><span class="line">wrap_elf_size = <span class="number">0xb8010</span></span><br><span class="line">key = <span class="string">b&quot;vUV4#\x91#SVt&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;com.oacia.apk_protect/assets/libjiagu_a64.so&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    wrap_elf = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对密文进行解密</span></span><br><span class="line">dec_compress_elf = RC4decrypt(wrap_elf[wrap_elf_start:wrap_elf_start + wrap_elf_size], key)</span><br><span class="line">dec_elf = zlib.decompress(<span class="built_in">bytes</span>(dec_compress_elf[<span class="number">4</span>::]))</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;wrap_elf&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(dec_elf)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">part</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.value = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="variable language_">self</span>.offset = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.size = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">index = <span class="number">1</span></span><br><span class="line">extra_part = [part() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>)]</span><br><span class="line"></span><br><span class="line">seg = [<span class="string">&quot;phdr&quot;</span>, <span class="string">&quot;.rela.plt&quot;</span>, <span class="string">&quot;.rela.dyn&quot;</span>, <span class="string">&quot;.dynamic&quot;</span>]</span><br><span class="line">v_xor = dec_elf[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    size = <span class="built_in">int</span>.from_bytes(dec_elf[index:index + <span class="number">4</span>], <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    index += <span class="number">4</span></span><br><span class="line">    extra_part[i + <span class="number">1</span>].name = seg[i]</span><br><span class="line">    extra_part[i + <span class="number">1</span>].value = <span class="built_in">bytes</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: x ^ v_xor, dec_elf[index:index + size]))</span><br><span class="line">    extra_part[i + <span class="number">1</span>].size = size</span><br><span class="line">    index += size</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> extra_part:</span><br><span class="line">    <span class="keyword">if</span> p.value!=<span class="string">b&#x27;&#x27;</span>:</span><br><span class="line">        filename = <span class="string">f&quot;libjiagu.so_<span class="subst">&#123;<span class="built_in">hex</span>(p.size)&#125;</span>_<span class="subst">&#123;p.name&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;p.name&#125;</span>] get <span class="subst">&#123;filename&#125;</span>, size: <span class="subst">&#123;<span class="built_in">hex</span>(p.size)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(filename,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(p.value)</span><br></pre></td></tr></table></figure>

<p>至于修复，很简单，把part2的主so放到010editor，用得到的4个section进行覆盖就行。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526092610332.png" alt="image-20250526092610332"></p>
<p>覆盖pht，其它的覆盖方法，需要找.dynamic节，然后得到.rela.plt和.rela.dyn节的偏移是多少，这里不过多赘述。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526092831748.png" alt="image-20250526092831748" style="zoom: 50%;" />

<p>在修复之后，基址设为0xe7000。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526093509859.png" alt="image-20250526093509859" style="zoom:67%;" />

<p>在获得主so文件之后，<strong>下一个主线任务就是找到主dex是如何加载并被解密的</strong>，然后获取主dex。</p>
<p>之前我们在hook函数open的时候，发现open会打开dex文件，通过打印调用函数栈，我们发现主so位于偏移量为0xE7000的位置，现在回顾一下在打开dex文件时的函数调用栈。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526100506048.png" alt="image-20250526100506048" style="zoom:80%;" />

<p>这里看到的调用栈其实只是部分，因为主so的函数列表并没有添加到壳so生成的脚本里，我之前写的脚本并没有测试过，所以这里还是用大佬oacia的吧。</p>
<p>在IDA中打开主so，然后使用插件stalker_trace_so，然后将主so的函数列表插回壳so的脚本里，这是佬oacia的截图。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526103628785.png" alt="image-20250526103628785"></p>
<p>这里我将名字改成keke了hhhhh。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526103707527.png" alt="image-20250526103707527"></p>
<p>然后插入1个判断即可。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526103748834.png" alt="image-20250526103748834"></p>
<p>前面在大量地执行壳so的函数，后面基本都在调用主so的函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526103913279.png" alt="image-20250526103913279" style="zoom:80%;" />

<p>在主so中搜索0x19b780，发现这个指令位于函数sub_19B760中，然后在trace.log中，发现没找到sub_19B760，应该是因为没hook maps文件，进程检测到frida，提前退出了。</p>
<p>在hook了maps文件后，发现获得的日志信息反而变少了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br></pre></td><td class="code"><pre><span class="line">[ONEPLUS A6003::com.oacia.apk_protect ]-&gt; start Stalker!</span><br><span class="line">Stalker end!</span><br><span class="line">[keke] call1:JNI_OnLoad</span><br><span class="line">[keke] call2:.interpreter_wrap_int64_t</span><br><span class="line">[keke] call3:interpreter_wrap_int64_t</span><br><span class="line">[keke] call4:._Znwm</span><br><span class="line">[keke] call5:sub_13908</span><br><span class="line">[keke] call6:._Znam</span><br><span class="line">[keke] call7:sub_11220</span><br><span class="line">[keke] call8:.memset</span><br><span class="line">[keke] call9:sub_9DD8</span><br><span class="line">[keke] call10:sub_E3E0</span><br><span class="line">[keke] call11:.calloc</span><br><span class="line">[keke] call12:.malloc</span><br><span class="line">[keke] call13:.free</span><br><span class="line">[keke] call14:sub_E648</span><br><span class="line">[keke] call15:._ZdaPv</span><br><span class="line">[keke] call16:sub_C918</span><br><span class="line">[keke] call17:sub_9988</span><br><span class="line">[keke] call18:sub_9964</span><br><span class="line">[keke] call19:sub_9AC4</span><br><span class="line">[keke] call20:.ffi_prep_cif</span><br><span class="line">[keke] call21:ffi_prep_cif</span><br><span class="line">[keke] call22:.ffi_prep_cif_machdep</span><br><span class="line">[keke] call23:ffi_prep_cif_machdep</span><br><span class="line">[keke] call24:.ffi_call</span><br><span class="line">[keke] call25:ffi_call</span><br><span class="line">[keke] call26:sub_1674C</span><br><span class="line">[keke] call27:.ffi_call_SYSV</span><br><span class="line">[keke] call28:ffi_call_SYSV</span><br><span class="line">[keke] call29:sub_167BC</span><br><span class="line">[keke] call30:sub_1647C</span><br><span class="line">[keke] call31:sub_163DC</span><br><span class="line">[keke] call32:sub_9900</span><br><span class="line">[keke] call33:sub_94BC</span><br><span class="line">[keke] call34:.dladdr</span><br><span class="line">[keke] call35:.strstr</span><br><span class="line">[keke] call36:.setenv</span><br><span class="line">[keke] call37:_Z9__arm_a_1P7_JavaVMP7_JNIEnvPvRi</span><br><span class="line">[keke] call38:sub_9E58</span><br><span class="line">[keke] call39:sub_999C</span><br><span class="line">[keke] call40:sub_10964</span><br><span class="line">[keke] call41:j_._ZdlPv_1</span><br><span class="line">[keke] call42:._ZdlPv</span><br><span class="line">[keke] call43:sub_96E0</span><br><span class="line">[keke] call44:sub_8000</span><br><span class="line">[keke] call45:.strncpy</span><br><span class="line">[keke] call46:sub_60E0</span><br><span class="line">[keke] call47:sub_6544</span><br><span class="line">[keke] call48:sub_4B54</span><br><span class="line">[keke] call49:sub_6128</span><br><span class="line">[keke] call50:_ZN9__arm_c_19__arm_c_0Ev</span><br><span class="line">[keke] call51:sub_A3EC</span><br><span class="line">[keke] call52:sub_99CC</span><br><span class="line">[keke] call53:sub_9944</span><br><span class="line">[keke] call54:sub_6484</span><br><span class="line">[keke] call55:sub_6590</span><br><span class="line">[keke] call56:.memcpy</span><br><span class="line">[keke] call57:sub_6698</span><br><span class="line">[keke] call58:sub_9FFC</span><br><span class="line">[keke] call59:j_._ZdlPv_3</span><br><span class="line">[keke] call60:j_._ZdlPv_2</span><br><span class="line">[keke] call61:j_._ZdlPv_0</span><br><span class="line">[keke] call62:sub_A3A0</span><br><span class="line">[keke] call63:sub_9A90</span><br><span class="line">[keke] call64:sub_5F20</span><br><span class="line">[keke] call65:sub_6044</span><br><span class="line">[keke] call66:sub_3574</span><br><span class="line">[keke] call67:.uncompress</span><br><span class="line">[keke] call68:sub_49F0</span><br><span class="line">[keke] call69:sub_5400</span><br><span class="line">[keke] call70:sub_5478</span><br><span class="line">[keke] call71:sub_5B08</span><br><span class="line">[keke] call72:sub_5650</span><br><span class="line">[keke] call73:sub_580C</span><br><span class="line">[keke] call74:.mprotect</span><br><span class="line">[keke] call75:.strlen</span><br><span class="line">[keke] call76:sub_3C94</span><br><span class="line">[keke] call77:.dlopen</span><br><span class="line">[keke] call78:sub_4918</span><br><span class="line">[keke] call79:sub_4000</span><br><span class="line">[keke] call80:sub_41B4</span><br><span class="line">[keke] call81:sub_35AC</span><br><span class="line">[keke] call82:.dlsym</span><br><span class="line">[keke] call83:sub_5E6C</span><br><span class="line">[keke] call84:sub_5444</span><br><span class="line">[main] call85:sub_11603C</span><br><span class="line">[main] call86:j__Znwm</span><br><span class="line">[main] call87:_Znwm</span><br><span class="line">[main] call88:malloc</span><br><span class="line">[main] call89:__cxa_atexit</span><br><span class="line">[main] call90:sub_1160B4</span><br><span class="line">[main] call91:sub_1160C4</span><br><span class="line">[main] call92:strlen</span><br><span class="line">[main] call93:memcpy</span><br><span class="line">[main] call94:sub_1161FC</span><br><span class="line">[main] call95:sub_1164AC</span><br><span class="line">[main] call96:sub_1164D8</span><br><span class="line">[main] call97:sub_116528</span><br><span class="line">[main] call98:sub_1165C8</span><br><span class="line">[main] call99:sub_1A32C0</span><br><span class="line">[main] call100:sub_1A3150</span><br><span class="line">[main] call101:sub_1A3204</span><br><span class="line">[main] call102:sub_1166FC</span><br><span class="line">[main] call103:sub_116728</span><br><span class="line">[main] call104:sub_116750</span><br><span class="line">[main] call105:sub_116830</span><br><span class="line">[main] call106:sub_116BA0</span><br><span class="line">[keke] call107:sub_633C</span><br><span class="line">[keke] call108:sub_8130</span><br><span class="line">[keke] call109:sub_4C70</span><br><span class="line">[keke] call110:sub_825C</span><br><span class="line">[keke] call111:sub_8B50</span><br><span class="line">[keke] call112:sub_8ED4</span><br><span class="line">[keke] call113:sub_8430</span><br><span class="line">[main] call114:JNI_OnLoad</span><br><span class="line">[main] call115:j_interpreter_wrap_int64_t</span><br><span class="line">[main] call116:interpreter_wrap_int64_t</span><br><span class="line">[keke] call117:interpreter_wrap_int64_t_bridge</span><br><span class="line">[keke] call118:sub_9D60</span><br><span class="line">[main] call119:sub_1B3F0C</span><br><span class="line">[main] call120:gettimeofday</span><br><span class="line">[main] call121:sub_11BD9C</span><br><span class="line">[main] call122:sub_1182D8</span><br><span class="line">[main] call123:sub_123970</span><br><span class="line">[main] call124:sub_1B6448</span><br><span class="line">[main] call125:getenv</span><br><span class="line">[main] call126:sub_11F130</span><br><span class="line">[main] call127:sub_12047C</span><br><span class="line">[main] call128:j__ZdlPv</span><br><span class="line">[main] call129:_ZdlPv</span><br><span class="line">[main] call130:free</span><br><span class="line">[main] call131:sub_1427E8</span><br><span class="line">[main] call132:dlopen</span><br><span class="line">[main] call133:sub_11BDA8</span><br><span class="line">[main] call134:sub_11BE58</span><br><span class="line">[main] call135:sub_11F69C</span><br><span class="line">[main] call136:sub_117BE0</span><br><span class="line">[main] call137:sub_117CA0</span><br><span class="line">[main] call138:fopen</span><br><span class="line">open /proc/self/maps</span><br><span class="line">find /proc/self/maps, redirect to /data/data/com.oacia.apk_protect/maps_nonexistent</span><br><span class="line">[main] call139:sub_117E90</span><br><span class="line">[main] call140:sub_14285C</span><br><span class="line">[main] call141:sub_1429CC</span><br><span class="line">[main] call142:sub_11C1AC</span><br><span class="line">[main] call143:sub_11C1B4</span><br><span class="line">[main] call144:sub_11C210</span><br><span class="line">[keke] call145:sub_166C4</span><br><span class="line">[keke] call146:.puts</span><br><span class="line">[main] call147:sub_123324</span><br><span class="line">[main] call148:sub_1205A0</span><br><span class="line">[main] call149:sub_11F768</span><br><span class="line">[main] call150:memcmp</span><br><span class="line">[main] call151:opendir</span><br><span class="line">[main] call152:closedir</span><br><span class="line">[main] call153:sub_11859C</span><br><span class="line">[main] call154:sub_11C268</span><br><span class="line">[main] call155:sub_11C300</span><br><span class="line">[main] call156:sub_117B68</span><br><span class="line">[main] call157:sub_1186B8</span><br><span class="line">[main] call158:sub_143964</span><br><span class="line">[main] call159:sub_1B66A8</span><br><span class="line">[main] call160:pthread_mutex_lock</span><br><span class="line">[main] call161:sub_142EA0</span><br><span class="line">[main] call162:sub_143A38</span><br><span class="line">[main] call163:sub_11CF8C</span><br><span class="line">[main] call164:sub_131D58</span><br><span class="line">[main] call165:sub_1B66D0</span><br><span class="line">[main] call166:pthread_mutex_unlock</span><br><span class="line">[main] call167:sub_1178E8</span><br><span class="line">[main] call168:sub_13D70C</span><br><span class="line">[main] call169:sub_19F984</span><br><span class="line">[main] call170:sub_11F1C8</span><br><span class="line">[main] call171:atoi</span><br><span class="line">[main] call172:sub_12D2F8</span><br><span class="line">[main] call173:sub_17ABE8</span><br><span class="line">[main] call174:sub_172660</span><br><span class="line">[main] call175:sub_13BFF0</span><br><span class="line">[main] call176:sub_172AA4</span><br><span class="line">[main] call177:sub_13BD80</span><br><span class="line">[main] call178:sub_13BE2C</span><br><span class="line">[main] call179:sub_13BE4C</span><br><span class="line">[main] call180:memmove</span><br><span class="line">[main] call181:sub_13BE64</span><br><span class="line">[main] call182:sub_172D78</span><br><span class="line">[main] call183:sub_13E510</span><br><span class="line">[main] call184:sub_1926F0</span><br><span class="line">[main] call185:sub_13DB7C</span><br><span class="line">[main] call186:sub_1B7A08</span><br><span class="line">[main] call187:sub_1B7ABC</span><br><span class="line">[main] call188:pthread_cond_broadcast</span><br><span class="line">open /proc/self/maps</span><br><span class="line">find /proc/self/maps, redirect to /data/data/com.oacia.apk_protect/maps_nonexistent</span><br><span class="line">open /proc/self/maps</span><br><span class="line">find /proc/self/maps, redirect to /data/data/com.oacia.apk_protect/maps_nonexistent</span><br><span class="line">[main] call189:sub_12FA34</span><br><span class="line">[main] call190:sub_120664</span><br><span class="line">[main] call191:sub_1332B8</span><br><span class="line">[main] call192:sub_13E0F8</span><br><span class="line">open /proc/self/maps</span><br><span class="line">find /proc/self/maps, redirect to /data/data/com.oacia.apk_protect/maps_nonexistent</span><br><span class="line">[main] call193:sub_12743C</span><br><span class="line">[main] call194:sub_124C68</span><br><span class="line">[main] call195:sub_125DC4</span><br><span class="line">[main] call196:sub_124510</span><br><span class="line">[main] call197:sub_126888</span><br><span class="line">[main] call198:strdup</span><br><span class="line">[main] call199:sub_126920</span><br><span class="line">[main] call200:sub_122180</span><br><span class="line">[main] call201:sub_11BC1C</span><br><span class="line">[main] call202:sub_13DF34</span><br><span class="line">[main] call203:getpid</span><br><span class="line">[main] call204:memset</span><br><span class="line">[main] call205:snprintf</span><br><span class="line">open /proc/25453/maps</span><br><span class="line">find /proc/25453/maps, redirect to /data/data/com.oacia.apk_protect/maps_nonexistent</span><br><span class="line">[main] call206:sub_124FA0</span><br><span class="line">[main] call207:sub_1B6498</span><br><span class="line">[main] call208:sub_1A0C88</span><br><span class="line">[main] call209:sub_217444</span><br><span class="line">[main] call210:sub_2175E0</span><br><span class="line">[main] call211:read</span><br><span class="line">[main] call212:strncmp</span><br><span class="line">[main] call213:close</span><br><span class="line">[main] call214:sub_1B578C</span><br><span class="line">[main] call215:j___self_lseek</span><br><span class="line">[main] call216:__self_lseek</span><br><span class="line">[main] call217:sub_1B586C</span><br><span class="line">[main] call218:j_j___read_self</span><br><span class="line">[main] call219:j___read_self</span><br><span class="line">[main] call220:__read_self</span><br><span class="line">[main] call221:sub_1B6528</span><br><span class="line">[main] call222:sub_1B6578</span><br><span class="line">[main] call223:mmap</span><br><span class="line">[main] call224:sub_1B5B50</span><br><span class="line">[main] call225:calloc</span><br><span class="line">[main] call226:memchr</span><br><span class="line">[main] call227:sub_1B5D04</span><br><span class="line">[main] call228:sub_1B5EC4</span><br><span class="line">[main] call229:sub_1B6270</span><br><span class="line">[main] call230:sub_1B6180</span><br><span class="line">[main] call231:sub_1B6678</span><br><span class="line">[main] call232:inflateInit2_</span><br><span class="line">[main] call233:inflate</span><br><span class="line">[main] call234:inflateEnd</span><br><span class="line">[main] call235:sub_1B6540</span><br><span class="line">[main] call236:munmap</span><br><span class="line">[main] call237:sub_1B56F8</span><br><span class="line">[main] call238:sub_19BC9C</span><br><span class="line">[main] call239:sub_19CCD4</span><br><span class="line">open /proc/self/maps</span><br><span class="line">find /proc/self/maps, redirect to /data/data/com.oacia.apk_protect/maps_nonexistent</span><br><span class="line">[main] call240:sub_12D470</span><br><span class="line">[main] call241:sub_142FE0</span><br><span class="line">[main] call242:sub_143008</span><br><span class="line">[main] call243:sub_142ABC</span><br><span class="line">[main] call244:sub_143848</span><br><span class="line">[main] call245:sub_143B48</span><br><span class="line">[main] call246:sub_143088</span><br><span class="line">[main] call247:sub_1222D0</span><br><span class="line">[main] call248:sub_14316C</span><br><span class="line">[main] call249:sub_142954</span><br><span class="line">[keke] call250:_Z9__arm_a_2PcmS_Rii</span><br><span class="line">[main] call251:sub_142894</span><br><span class="line">[main] call252:sub_1428BC</span><br><span class="line">[main] call253:sub_127DCC</span><br><span class="line">[main] call254:sub_14292C</span><br><span class="line">[main] call255:sub_121B78</span><br><span class="line">[main] call256:sub_121BE0</span><br><span class="line">[main] call257:sub_123CE8</span><br><span class="line">[main] call258:sub_123BC0</span><br><span class="line">[main] call259:sub_11959C</span><br><span class="line">[main] call260:sub_1AC170</span><br><span class="line">[main] call261:pthread_create</span><br><span class="line">[main] call262:sub_1AC210</span><br><span class="line">[main] call263:sub_1B5DE4</span><br><span class="line">[main] call264:sub_1B60E8</span><br><span class="line">[main] call265:sub_19F7C4</span><br><span class="line">[main] call266:sub_1B2DC8</span><br><span class="line">[main] call267:sub_1B1CE8</span><br><span class="line">open /proc/self/maps</span><br><span class="line">find /proc/self/maps, redirect to /data/data/com.oacia.apk_protect/maps_nonexistent</span><br><span class="line">[main] call268:sub_1B0974</span><br><span class="line">[main] call269:sub_1AFE6C</span><br><span class="line">[main] call270:sub_126ED8</span><br><span class="line">[main] call271:sub_1AFE8C</span><br><span class="line">[main] call272:sub_1AFE90</span><br><span class="line">[main] call273:sub_1AB87C</span><br><span class="line">[main] call274:sub_1B26D4</span><br><span class="line">[main] call275:sub_1B26F4</span><br><span class="line">[main] call276:sub_1B27C8</span><br><span class="line">[keke] call277:.ffi_prep_cif_var</span><br><span class="line">[keke] call278:ffi_prep_cif_var</span><br><span class="line">[main] call279:sub_1AAF48</span><br><span class="line">[main] call280:sub_1AAF54</span><br><span class="line">[main] call281:sub_2162D4</span><br><span class="line">[main] call282:sub_1B2898</span><br><span class="line">[main] call283:sub_1B2918</span><br><span class="line">[main] call284:sub_1ABE90</span><br><span class="line">[main] call285:sub_13E0EC</span><br><span class="line">Process terminated</span><br></pre></td></tr></table></figure>

<p>根据对日志的分析，发现有3个函数是zlib库中用来解压缩的函数——inflateInit2_、inflate、inflateEnd，大概率是用来解压dex文件的。</p>
<p>对inflateInit2_进行交叉引用，发现2个引用。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526120322384.png" alt="image-20250526120322384"></p>
<p>根据日志，先查看sub_1B6270。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526120702211.png" alt="image-20250526120702211" style="zoom:80%;" />

<p>注意到，inflate的参数是s和4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526121122466.png" alt="image-20250526121122466"></p>
<p>根据函数签名，可以知道s是z_streamp类型，需要在IDA中添加相应的结构体。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526121150955.png" alt="image-20250526121150955"></p>
<p>结构体如下，Bytef可以改成Byte*，指针都是8个字节，感觉不用太担心具体类型。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#  <span class="keyword">define</span> z_const const</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span>  Byte;  <span class="comment">/* 8 bits */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span>   uInt;  <span class="comment">/* 16 bits or more */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span>  uLong; <span class="comment">/* 32 bits or more */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">z_stream_s</span> &#123;</span></span><br><span class="line">    z_const Bytef *next_in;     <span class="comment">/* next input byte */</span></span><br><span class="line">    uInt     avail_in;  <span class="comment">/* number of bytes available at next_in */</span></span><br><span class="line">    uLong    total_in;  <span class="comment">/* total number of input bytes read so far */</span></span><br><span class="line"></span><br><span class="line">    Bytef    *next_out; <span class="comment">/* next output byte will go here */</span></span><br><span class="line">    uInt     avail_out; <span class="comment">/* remaining free space at next_out */</span></span><br><span class="line">    uLong    total_out; <span class="comment">/* total number of bytes output so far */</span></span><br><span class="line">&#125; z_stream;</span><br></pre></td></tr></table></figure>

<p>接下来hook inflate，看看解压缩后的数据是什么，这里有个问题，在主so还没解密时是hook不了的，大佬oacia给了一个思路：哦统计inflate调用的次数，壳ELF在调用uncompress的时候会执行1次inflate，而解压dex的时候就是第2次。</p>
<p>大佬的思路很好，学习到了，但是不知道为什么大佬的脚本hook的是汇编层指令的地址（可能会报错），而非函数序言地址，直接在onLeave回调时不一样可以dump和打印吗，还可以少定义一个函数。</p>
<p>下面是从佬博客标注的代码，不全。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dump_memory</span>(<span class="params">start,size,filename</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> file_path = <span class="string">&quot;/data/data/com.oacia.apk_protect/&quot;</span> + filename;</span><br><span class="line">    <span class="keyword">var</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> libso_buffer = start.<span class="title function_">readByteArray</span>(size.<span class="title function_">toUInt32</span>());</span><br><span class="line">        file_handle.<span class="title function_">write</span>(libso_buffer);</span><br><span class="line">        file_handle.<span class="title function_">flush</span>();</span><br><span class="line">        file_handle.<span class="title function_">close</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump]:&quot;</span>, file_path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_zlib_result</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1B63F0</span>), &#123;</span><br><span class="line">        <span class="comment">// fd, buff, len</span></span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;inflate result&quot;</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(next_in, &#123;</span><br><span class="line">              <span class="attr">offset</span>: <span class="number">0</span>,<span class="comment">// 相对偏移</span></span><br><span class="line">              <span class="attr">length</span>: <span class="number">0x50</span>,<span class="comment">//dump 的大小</span></span><br><span class="line">              <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">            &#125;));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(next_out, &#123;</span><br><span class="line">              <span class="attr">offset</span>: <span class="number">0</span>,<span class="comment">// 相对偏移</span></span><br><span class="line">              <span class="attr">length</span>: <span class="number">0x50</span>,<span class="comment">//dump 的大小</span></span><br><span class="line">              <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">            &#125;));</span><br><span class="line">            <span class="title function_">dump_memory</span>(next_out,avail_out,<span class="string">&quot;dex001&quot;</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> zlib_count=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> next_in,avail_in,next_out,avail_out;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_zlib</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;inflate&quot;</span>), &#123;</span><br><span class="line">        <span class="comment">// fd, buff, len</span></span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            zlib_count+=<span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(zlib_count&gt;<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="title function_">hook_zlib_result</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            next_in=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x0</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            avail_in=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x8</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            next_out=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x18</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            avail_out=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x20</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(next_in, &#123;</span><br><span class="line">              <span class="attr">offset</span>: <span class="number">0</span>,<span class="comment">// 相对偏移</span></span><br><span class="line">              <span class="attr">length</span>: <span class="number">0x50</span>,<span class="comment">//dump 的大小</span></span><br><span class="line">              <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">            &#125;));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">1</span>]);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是我对佬代码做的删减及必要的补充。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dump_memory</span>(<span class="params">start,size,filename</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> file_path = <span class="string">&quot;/data/data/com.oacia.apk_protect/&quot;</span> + filename;</span><br><span class="line">    <span class="keyword">var</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> libso_buffer = start.<span class="title function_">readByteArray</span>(size.<span class="title function_">toUInt32</span>());</span><br><span class="line">        file_handle.<span class="title function_">write</span>(libso_buffer);</span><br><span class="line">        file_handle.<span class="title function_">flush</span>();</span><br><span class="line">        file_handle.<span class="title function_">close</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump]:&quot;</span>, file_path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> zlib_count=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> next_in,avail_in,next_out,avail_out;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_zlib</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;inflate&quot;</span>), &#123;</span><br><span class="line">        <span class="comment">// fd, buff, len</span></span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            zlib_count+=<span class="number">1</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[inflate calls]&quot;</span>, zlib_count);</span><br><span class="line">            next_in=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x0</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            avail_in=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x8</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            next_out=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x18</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            avail_out=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x20</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(next_in, &#123;</span><br><span class="line">              <span class="attr">offset</span>: <span class="number">0</span>,<span class="comment">// 相对偏移</span></span><br><span class="line">              <span class="attr">length</span>: <span class="number">0x64</span>,<span class="comment">//dump 的大小</span></span><br><span class="line">              <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(zlib_count&gt;<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;inflate result&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(next_out, &#123;</span><br><span class="line">                  <span class="attr">offset</span>: <span class="number">0</span>,<span class="comment">// 相对偏移</span></span><br><span class="line">                  <span class="attr">length</span>: <span class="number">0x50</span>,<span class="comment">//dump 的大小</span></span><br><span class="line">                  <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">                  <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">                &#125;));</span><br><span class="line">                <span class="title function_">dump_memory</span>(next_out,avail_out,<span class="string">&quot;dex001&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">my_hook_dlopen</span>(<span class="params">soName=<span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="comment">//console.log(path);</span></span><br><span class="line">                    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_proc_self_maps</span>();</span><br><span class="line">                    <span class="title function_">hook_zlib</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_proc_self_maps</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> openPtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> open = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fakePath = <span class="string">&quot;/data/data/com.oacia.apk_protect/maps_nonexistent&quot;</span>;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(openPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">pathnameptr, flag</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> pathname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(pathnameptr);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;open&quot;</span>,pathname);<span class="comment">//,Process.getCurrentThreadId()</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;maps&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find&quot;</span>,pathname+<span class="string">&quot;, redirect to&quot;</span>,fakePath);</span><br><span class="line">            <span class="keyword">var</span> filename = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(fakePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">open</span>(filename, flag);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> fd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">my_hook_dlopen</span>(<span class="string">&#x27;libjiagu&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行效果如下，解压后的数据似乎是一个dex文件？</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526132131214.png" alt="image-20250526132131214" style="zoom:80%;" />

<p>难蚌，为什么解压后的数据与原dex完全相同。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526132323546.png" alt="image-20250526132323546"></p>
<p>博主根据原apk、加固后的apk，通过比较大小，发现壳dex的末尾附带了一大串加密数据，既然当前的sub_1B6270解压出了和原dex一样的<strong>数据A</strong>，说明接下来该对这个<strong>数据A</strong>的末尾进行解密了。</p>
<p>观察sub_1B6270，会发现，return是用来判断函数sub_1B6270是否执行成功的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526134858141.png" alt="image-20250526134858141" style="zoom:80%;" />

<p>a3将缓冲区的地址传给了s.next_out，解压后的数据在a3，缓冲区的长度为v19。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526135343573.png" alt="image-20250526135343573" style="zoom:80%;" />

<p>追踪sub_1B6270，判断a3是在哪申请的缓冲区，根据日志，选择sub_1A0C88。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526135805308.png" alt="image-20250526135805308"></p>
<p>v10拿到了装有原dex的缓冲区，然后赋给了a3。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526135905993.png" alt="image-20250526135905993"></p>
<p>根据日志，这里选择追踪函数sub_124FA0。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526140025579.png" alt="image-20250526140025579"></p>
<p>这里返回值用来判断是否执行成功，s1获得了原dex。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526140247694.png" alt="image-20250526140247694"></p>
<p>s1会给v27传递一些信息，此后s1没出现过了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526141948951.png" alt="image-20250526141948951"></p>
<p>对sub_19BC9C进行分析。</p>
<ol>
<li><p><strong>内部状态初始化</strong>：对 <code>a1</code> 指向的内存区域进行清零和内部指针设置。</p>
</li>
<li><p><strong>DEX文件处理</strong>：解析传入的 <code>s1</code>（壳dex文件），识别其具体类型（DEX, ODEX, CDEX），并调整 <code>a1</code> 中的指针以指向有效的DEX数据区域。这使得后续代码可以通过 <code>a1</code> 方便地访问DEX内容。</p>
</li>
<li><p><strong>构建JNI类型映射</strong>：在 <code>a1</code> 结构的某个区域（从偏移 <code>0x138</code> 开始）构建一个从JNI短类型签名到完整Java类名的映射表。这个映射表是执行JNI操作（如方法调用、字段访问）时进行类型匹配和转换的基础。</p>
</li>
</ol>
<p> 看来也没有壳dex末尾的加密数据进行解密，继续交叉引用sub_124FA0，结合日志，下一个追踪的函数是sub_1332B8。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526143837983.png" alt="image-20250526143837983" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526143857946.png" alt="image-20250526143857946"></p>
<p>调用链应该是这样的，除此之外，暂时没什么成果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_1332B8-&gt;sub_124FA0-&gt;sub_1A0C88-&gt;sub_1B6270-&gt;inflate</span><br></pre></td></tr></table></figure>

<p>回到函数open打开classes.dex时的函数调用栈，如下图。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526100506048.png" alt="image-20250526100506048" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522133032024.png" alt="image-20250522133032024" style="zoom:67%;" />

<p>查看函数0x19b780的引用，发现有2次引用来自sub_1332b8，根据上面2个图，结合0x134680 &#x3D;&#x3D; 0x1332b8 + 0x13c4 + 0x4和0x134598 &#x3D;&#x3D; 0x1332b8 + 0x12dC + 0x4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526150825957.png" alt="image-20250526150825957"></p>
<p>所以classes.dex对应的sub_19b760，在sub_1332B8+12DC处被调用。</p>
<p>而classes2.dex和classes3.dex对应的sub_19b760，在subsub_1332B8+13C4处被调用。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526151921387.png" alt="image-20250526151921387"></p>
<p>注意到，壳dex的中注入的加密数据位于0x3198h处，而大小是0x41FD18。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526152253621.png" alt="image-20250526152253621"></p>
<p>尝试hook一下sub_19b760，观察buffer和buffer_size是否有符合壳dex末尾加密数据的特征。</p>
<p>大佬没给脚本，自己写一个脚本吧。</p>
<p>考虑到sub_19b760是主so中的函数，如果hook得太早，主so还没有加载，这样hook不上，甚至可能会有报错；如果hook太晚，sub_19b70可能执行完了。</p>
<p>所以需要找一个时机，主so已经加载完，并且sub_19b70还没清空的时机——其实拿inflate第2次执行的时机就行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">my_hook_dlopen</span>(<span class="params">soName=<span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="comment">//console.log(path);</span></span><br><span class="line">                    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_proc_self_maps</span>();</span><br><span class="line"></span><br><span class="line">                    <span class="title function_">hook_zlib</span>();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_proc_self_maps</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> openPtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> open = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fakePath = <span class="string">&quot;/data/data/com.oacia.apk_protect/maps_nonexistent&quot;</span>;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(openPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">pathnameptr, flag</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> pathname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(pathnameptr);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;open&quot;</span>,pathname);<span class="comment">//,Process.getCurrentThreadId()</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;maps&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find&quot;</span>,pathname+<span class="string">&quot;, redirect to&quot;</span>,fakePath);</span><br><span class="line">            <span class="keyword">var</span> filename = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(fakePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">open</span>(filename, flag);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> fd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> zlib_count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_zlib</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;inflate&quot;</span>), &#123;</span><br><span class="line">        <span class="comment">// fd, buff, len</span></span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            zlib_count = zlib_count + <span class="number">1</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">            <span class="comment">// 此时的sub_19b760已经解密完成，而且没有被清空</span></span><br><span class="line">            <span class="keyword">if</span>(zlib_count == <span class="number">2</span>)&#123;</span><br><span class="line">                <span class="title function_">hook_sub_19b760</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_19b760</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[so base]&quot;</span>, <span class="string">&quot;0x&quot;</span> + <span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>))</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x19b760</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[path]&quot;</span>, args[<span class="number">0</span>].<span class="title function_">readCString</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[buffer] size =&quot;</span>, <span class="string">&quot;0x&quot;</span>+args[<span class="number">2</span>].<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">1</span>], &#123;<span class="attr">length</span>: <span class="number">64</span>&#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">my_hook_dlopen</span>(<span class="string">&#x27;libjiagu&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行结果如下，可以看到，打开的classes.dex正是壳dex末尾的注入数据，连大小都是0x41fd18。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526155617908.png" alt="image-20250526155617908"></p>
<p>在sub_1332B8中，打开了classes.dex，已经确定了sub_19B760的3个参数的内容是什么，追踪dex_buffer。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526163850323.png" alt="image-20250526163850323"></p>
<p>dex_buffer会作为参数传递给sub_128D44。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526164059339.png" alt="image-20250526164059339"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526164137748.png" alt="image-20250526164137748"></p>
<p>转到汇编层，可以看到j_interpreter_wrap_int64_t的参数不应该是0。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526180148434.png" alt="image-20250526180148434"></p>
<p>根据寄存器的大小，修改成下面这样。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526180048792.png" alt="image-20250526180048792"></p>
<p>接着，通过stalker_trace_so的日志可以发现，函数sub_128D44没执行。博主在这个问题上的解决办法是：在调用sub_128D44的位置，再调用一次trace_so()。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526180701496.png" alt="image-20250526180701496"></p>
<p>博主给出了脚本的片段，如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526181208584.png" alt="image-20250526181208584"></p>
<p>我试验了一下，进程还是退出了，可能是我hook的时机不对，干脆先把反调过了，然后再执行stalker_trace_so，使用下面这个脚本可以找到哪里调用了pthread_create。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">check_pthread_create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> pthread_create_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;pthread_create&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pthread_create = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(pthread_create_addr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(pthread_create_addr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">parg0, parg1, parg2, parg3</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> so_name = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(parg2).<span class="property">name</span>;</span><br><span class="line">        <span class="keyword">var</span> so_path = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(parg2).<span class="property">path</span>;</span><br><span class="line">        <span class="keyword">var</span> so_base = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(so_name);</span><br><span class="line">        <span class="keyword">var</span> offset = parg2 - so_base;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">PC</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((so_name.<span class="title function_">indexOf</span>(<span class="string">&quot;jiagu&quot;</span>) &gt; -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;======&quot;</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find thread func offset&quot;</span>, so_name, offset.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">            <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">ACCURATE</span>).<span class="title function_">map</span>(addr_in_so);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> check_list = []<span class="comment">//1769036,1771844</span></span><br><span class="line">            <span class="keyword">if</span> (check_list.<span class="title function_">indexOf</span>(offset)!==-<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;check bypass&quot;</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable constant_">PC</span> = <span class="title function_">pthread_create</span>(parg0, parg1, parg2, parg3);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable constant_">PC</span> = <span class="title function_">pthread_create</span>(parg0, parg1, parg2, parg3);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable constant_">PC</span>;</span><br><span class="line">    &#125;, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addr_in_so</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> process_Obj_Module_Arr = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; process_Obj_Module_Arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(addr&gt;process_Obj_Module_Arr[i].<span class="property">base</span> &amp;&amp; addr&lt;process_Obj_Module_Arr[i].<span class="property">base</span>.<span class="title function_">add</span>(process_Obj_Module_Arr[i].<span class="property">size</span>))&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(addr.<span class="title function_">toString</span>(<span class="number">16</span>),<span class="string">&quot;is in&quot;</span>,process_Obj_Module_Arr[i].<span class="property">name</span>,<span class="string">&quot;offset: 0x&quot;</span>+(addr-process_Obj_Module_Arr[i].<span class="property">base</span>).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">check_pthread_create</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526184917507.png" alt="image-20250526184917507" style="zoom:80%;" />

<p>由于无法判断是哪个线程检测了frida，这里并不方便把目标线程函数替换为空。</p>
<p>先来0x17710看看，并没有看到pthread_create，这里的X24里面应该存放了pthread_create的地址。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526185047625.png" alt="image-20250526185047625" style="zoom:80%;" />

<p>大佬oacia在这里写得有些模糊。这里X24不一定是pthread_create，还有可能是其它的函数，通过这种动态跳转的方式，避免在静态调试工具中暴露易被检测的函数。</p>
<p>大佬在这里一个一个改x0-x6，emmm，先判断X24跳转的函数是什么，然后查看对应的寄存器会更好吧。</p>
<p>这里借着大佬已经分析出的解决方案——修改x6指向的字符串，去思考为什么是修改x6。</p>
<p>之前我们hook maps文件，是因为存在读maps文件的操作，但要如何逐行检测frida呢？是靠strstr吗？这里的x6说明了参数的数目之多，strstr可没那么多参数。</p>
<p>我写了个脚本，hook x6寄存器，并根据x24跳转的地址，根据它的偏移量，计算跳转的目标函数是什么。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">anti_frida_check</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">module</span>) &#123;</span><br><span class="line">        <span class="comment">// console.log(&quot;[anti_frida_check] libjiagu_64.so not found.&quot;);</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1770C</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 确保 X6 是一个有效的指针再尝试读取</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x6</span> &amp;&amp; !<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x6</span>.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                    <span class="keyword">var</span> s = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        s = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x6</span>.<span class="title function_">readCString</span>();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (readError) &#123;</span><br><span class="line">                        <span class="comment">// console.log(&quot;[anti_frida_check] Error reading string from X6: &quot; + readError.message);</span></span><br><span class="line">                        <span class="keyword">return</span>; <span class="comment">// 如果无法读取字符串，则不继续</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (s &amp;&amp; (s.<span class="title function_">indexOf</span>(<span class="string">&#x27;frida&#x27;</span>) !== -<span class="number">1</span> ||</span><br><span class="line">                              s.<span class="title function_">indexOf</span>(<span class="string">&#x27;gum-js-loop&#x27;</span>) !== -<span class="number">1</span> ||</span><br><span class="line">                              s.<span class="title function_">indexOf</span>(<span class="string">&#x27;gmain&#x27;</span>) !== -<span class="number">1</span> ||</span><br><span class="line">                              s.<span class="title function_">indexOf</span>(<span class="string">&#x27;linjector&#x27;</span>) !== -<span class="number">1</span> ||</span><br><span class="line">                              s.<span class="title function_">indexOf</span>(<span class="string">&#x27;/proc/&#x27;</span>) !== -<span class="number">1</span>)) &#123;</span><br><span class="line">                        </span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n==================================================&quot;</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Frida-related string detected in X6!&quot;</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    Original string (s) from X6: \&quot;&quot;</span> + s + <span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">                        </span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;--- Register Dump (X0-X6) ---&quot;</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X0: &quot;</span> + <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X1: &quot;</span> + <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x1</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X2: &quot;</span> + <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x2</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X3: &quot;</span> + <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x3</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X4: &quot;</span> + <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x4</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X5: &quot;</span> + <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x5</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X6: &quot;</span> + <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x6</span> + <span class="string">&quot; (Pointer value)&quot;</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;--- X24 Analysis ---&quot;</span>);</span><br><span class="line">                        <span class="keyword">var</span> x24_val = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x24</span>;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X24 points to address: &quot;</span> + x24_val);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (x24_val &amp;&amp; !x24_val.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                            <span class="keyword">var</span> symbolInfo = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(x24_val);</span><br><span class="line">                            <span class="keyword">if</span> (symbolInfo &amp;&amp; symbolInfo.<span class="property">name</span>) &#123;</span><br><span class="line">                                <span class="keyword">var</span> moduleName = symbolInfo.<span class="property">moduleName</span> || <span class="string">&quot;unknown module&quot;</span>;</span><br><span class="line">                                <span class="keyword">var</span> moduleBase = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(moduleName) || <span class="title function_">ptr</span>(<span class="number">0</span>);</span><br><span class="line">                                <span class="keyword">var</span> symbolOffset = symbolInfo.<span class="property">address</span>.<span class="title function_">sub</span>(moduleBase); <span class="comment">// Offset of symbol from module base</span></span><br><span class="line">                                <span class="keyword">var</span> pcOffsetFromSymbolStart = x24_val.<span class="title function_">sub</span>(symbolInfo.<span class="property">address</span>); <span class="comment">// Offset of PC from symbol start</span></span><br><span class="line"></span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    -&gt; Resolved Symbol: &quot;</span> + symbolInfo.<span class="property">name</span>);</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;       Module: &quot;</span> + moduleName + <span class="string">&quot; (Base: &quot;</span> + moduleBase + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;       Symbol Address: &quot;</span> + symbolInfo.<span class="property">address</span> + <span class="string">&quot; (Offset in module: 0x&quot;</span> + symbolOffset.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;       X24 is +0x&quot;</span> + pcOffsetFromSymbolStart.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; bytes from symbol start.&quot;</span>);</span><br><span class="line"></span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="comment">// 如果 DebugSymbol 未直接找到名称，尝试通过 ModuleMap 查找模块</span></span><br><span class="line">                                <span class="keyword">var</span> moduleDetails = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(x24_val);</span><br><span class="line">                                <span class="keyword">if</span> (moduleDetails) &#123;</span><br><span class="line">                                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    -&gt; Address is within module: &quot;</span> + moduleDetails.<span class="property">name</span>);</span><br><span class="line">                                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;       Module Base: &quot;</span> + moduleDetails.<span class="property">base</span>);</span><br><span class="line">                                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;       Offset from module base: 0x&quot;</span> + x24_val.<span class="title function_">sub</span>(moduleDetails.<span class="property">base</span>).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    -&gt; Could not resolve X24 to a specific function or module.&quot;</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    -&gt; X24 is null or its value is invalid.&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;==================================================\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="comment">// 捕获外部 try-catch 的错误，例如 this.context 访问问题（虽然不太可能）</span></span><br><span class="line">                <span class="comment">// console.log(&quot;[anti_frida_check] General error in onEnter: &quot; + e.message);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">my_hook_dlopen</span>(<span class="params">soName = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span> &amp;&amp; !pathptr.<span class="title function_">isNull</span>()) &#123; <span class="comment">// 添加 !pathptr.isNull() 检查</span></span><br><span class="line">                    <span class="keyword">var</span> path = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        <span class="comment">// console.log(&quot;Error reading SO path: &quot; + e.message);</span></span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (path &amp;&amp; soName &amp;&amp; path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123; <span class="comment">// 确保 soName 也有效</span></span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="comment">// console.log(&quot;[my_hook_dlopen] Detected &quot; + (soName || &quot;target SO&quot;) + &quot;. Attaching anti_frida_check.&quot;);</span></span><br><span class="line">                    <span class="title function_">anti_frida_check</span>();</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">false</span>; <span class="comment">// 重置标志，避免重复附加</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 你可以在这里指定要监控的 soName，例如 &#x27;libjiagu_64.so&#x27;</span></span><br><span class="line">    <span class="comment">// 如果不指定，或者指定空字符串，my_hook_dlopen 默认的 soName=&#x27;&#x27;</span></span><br><span class="line">    <span class="comment">// path.indexOf(&#x27;&#x27;) 总是返回0（为真），这会导致对每个dlopen都尝试设置anti_frida_check</span></span><br><span class="line">    <span class="comment">// 建议明确指定 soName 来提高目标性，例如：</span></span><br><span class="line">    <span class="comment">// my_hook_dlopen(&#x27;libjiagu_64.so&#x27;); </span></span><br><span class="line">    <span class="comment">// 如果你希望保持原样，对所有SO加载（dlopen）后都调用 anti_frida_check（如果 libjiagu_64.so 已加载）</span></span><br><span class="line">    <span class="comment">// 那么下面的调用是正确的，但请注意 anti_frida_check 内部会找 libjiagu_64.so</span></span><br><span class="line">    <span class="title function_">my_hook_dlopen</span>(<span class="string">&#x27;libjiagu_64.so&#x27;</span>); <span class="comment">// 修改此处，明确指定目标SO，使anti_frida_check只在该SO加载后执行一次</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行结果如下，那应该很好猜了，sscanf是用来逐行解析maps文件的，然后比较对应的字段，判断是否有frida的痕迹。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526193502474.png" alt="image-20250526193502474" style="zoom:80%;" />

<p>接下来，只要将x6替换掉即可，博主给出了代码，添加一下执行时机即可使用，在这里就不写了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">anti_frida_check</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1770C</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> s = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x6</span>.<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="keyword">if</span> (s.<span class="title function_">indexOf</span>(<span class="string">&#x27;frida&#x27;</span>)!==-<span class="number">1</span> ||</span><br><span class="line">                    s.<span class="title function_">indexOf</span>(<span class="string">&#x27;gum-js-loop&#x27;</span>)!==-<span class="number">1</span> ||</span><br><span class="line">                    s.<span class="title function_">indexOf</span>(<span class="string">&#x27;gmain&#x27;</span>)!==-<span class="number">1</span> ||</span><br><span class="line">                    s.<span class="title function_">indexOf</span>(<span class="string">&#x27;linjector&#x27;</span>)!==-<span class="number">1</span> ||</span><br><span class="line">                    s.<span class="title function_">indexOf</span>(<span class="string">&#x27;/proc/&#x27;</span>)!==-<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="comment">//console.log(s)</span></span><br><span class="line">                    <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>, <span class="title class_">Process</span>.<span class="property">pointerSize</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">                    <span class="keyword">var</span> replace_str=<span class="string">&quot;&quot;</span></span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;s.<span class="property">length</span>;i++)&#123;</span><br><span class="line">                        replace_str+=<span class="string">&quot;0&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>.<span class="title function_">writeUtf8String</span>(replace_str);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (e)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526195657484.png" alt="image-20250526195657484"></p>
<p>现在再试试能不能使用stalker_trace_so追踪所有函数了。</p>
<p>成功了，这回能够一直trace下去了，哈哈哈哈哈哈哈: &#x2F;</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526200220622.png" alt="image-20250526200220622"></p>
<p>顺着stalker_trace_so，沿着0x128D44继续往下分析，直到分析sub_18FEA8，这个函数内部存在大量的字符。</p>
<p>先hook这个函数的参数看看。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526202751628.png" alt="image-20250526202751628" style="zoom:80%;" />

<p>打印了3次，有理由去怀疑它与3个dex文件相关，感觉a1是数字、a2是地址、a3是大小，a4是地址，a5又是大小，a6暂时不知道。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526202809100.png" alt="image-20250526202809100" style="zoom:80%;" />

<p>修改一下，a2和a3分别代表着解密后的dex文件和文件大小。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526203312634.png" alt="image-20250526203312634"></p>
<p>根据oacia大佬的说明，函数sub_18FEA8里的字符串解密后，与dex文件的加载有关，这里就不深入了，主要还是关心dex文件是如何解密的。</p>
<p>我还是觉得sub_128d44很可疑，只输入一个加密的dex，加密的dex又不能提取什么信息，除了解密，还能干嘛？如果要解密，必须读取加密dex，所以可以在加密dex设置读写断点。</p>
<p>让gemini帮我写一个，脚本过于丑陋，就不外露了。</p>
<p>下面是打印结果。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526205010061.png" alt="image-20250526205010061"></p>
<p>注意到，打印出来的内容基都是read的操作，而没有写的操作，说明解密后的dex放到了内存的另一个地方。——20250526-20:51，明天再看，看了一天了有点累了。</p>
<p>——早上好~现在是20250527-09:04，继续分析。</p>
<p>通过上图的hook，可以知道libjiagu_64.so偏移0xd364的位置访问了加密dex，而且这个偏移一眼是壳代码，偏移为0xd364的指令位于函数sub_C918内。</p>
<p>然而查看stalker_trace_so，发现sub_128D44后面没有跟着sub_C918，为什么？我的猜测如下：脚本hook的时机不对，frida_stalker_so hook的时机是当android_dlopen_ext检测到库libjiagu_64.so时，在onLeave回调时调用trace_so，对所有在func_addr列表上的地址进行追踪，然而，主so在没加载的时候，主so某些函数尚未解密，此时frida-stalker插的桩似乎并不有效，总之，可能会引起问题。</p>
<p>尝试验证一下：在第二次inflate的时候开始执行trace_so，第二次inflate的时候，主so应该是解密完成的。</p>
<p>下图是打印结果，看来猜对了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527095842692.png" alt="image-20250527095842692" style="zoom:80%;" />

<p>hook一下sub_c918，根据观察，a1总为0，a2和a3应该是地址，a4不知道是什么；而且我明明写了onLeave回调，但这里没触发，说明函数sub_C918内访问了加密dex并调用了解密函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527121537670.png" alt="image-20250527121537670" style="zoom:80%;" />

<p>hook一下，查看执行到0xd364时，X19和X24的值。</p>
<p>也就是说x19 + x24 &#x3D;&#x3D; 0x7009ee4ce4，而[0x7009ee4ce4]的值为0x707aa982e0，0x707aa982e0刚好是0x707aa872d8 + 8的位置，因此访问了加密dex的缓冲区，触发了断点。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527133205197.png" alt="image-20250527133205197" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527133617161.png" alt="image-20250527133617161"></p>
<p>把脚本改了一下，验证一下，结果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527134953849.png" alt="image-20250527134953849"></p>
<p>和在010editor中加密dex的第2个8字节一样，说明思路是对的——但是注意，这里的汇编指令是STR W0，也就是传了4个字节，而非8个字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527135015190.png" alt="image-20250527135015190"></p>
<p>光看sub_c918，没发现解密内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527143339957.png" alt="image-20250527143339957" style="zoom:80%;" />

<p>而且似乎只访问了上图的内容，然后做了一个内存移动的操作，从将dex加密的第3个4字节从[x19, x24]移到[x19, x21]。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527133617161.png" alt="image-20250527133617161"></p>
<p>根据stalker_frida_so，继续往下分析其它的函数，寻找加密点。</p>
<p>在sub_143008发现了加解密的代码。</p>
<p>vaddq_s8，批量进行加法；veorq_s8，批量进行异或。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527153041340.png" alt="image-20250527153041340" style="zoom: 80%;" />

<p>hook sub_143008的形参。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527154322756.png" alt="image-20250527154322756"></p>
<p>结果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527155431502.png" alt="image-20250527155431502"></p>
<p>arg1不知道是什么。</p>
<p>arg2指向着压缩的dex的第12个字节开始的地址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527160301779.png" alt="image-20250527160301779"></p>
<p>arg2 &#x3D;&#x3D; 0x41e，这不正是偏移0xD364处的指令，所读取那4个字节吗？</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527155938623.png" alt="image-20250527155938623"></p>
<p>解密一下，发现是配置信息。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527164253814.png" alt="image-20250527164253814" style="zoom:80%;" />

<p>解密算法是：（加密字节 + 0x70）^0x36，但这仅仅针对0x41E个字节，并不足以解密整个dex文件。</p>
<p>接下来，大佬的思路是：在调用链中，发现用到了pthread_mutex_lock函数，说明有多个线程，当前的frida-stalker追踪的是某一线程，有可能是其它的线程完成了对dex的解密。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527161717098.png" alt="image-20250527161717098" style="zoom:80%;" />

<p>查看sub_143848、sub_1B66A8，看看是哪个函数调用了锁。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527162127366.png" alt="image-20250527162127366" style="zoom:80%;" />

<p>既然函数sub_143848涉及到锁，说明会有多个线程调用sub_143848，因此对函数sub_143848进行hook。</p>
<p>照着博客的代码，改了一下脚本，追踪非主线程的线程，只trace一次。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527163146812.png" alt="image-20250527163146812" style="zoom:80%;" />

<p>打印结果如下，和大佬博客的一模一样。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527163120637.png" alt="image-20250527163120637" style="zoom:80%;" />

<p>然后大佬发现sub_1A1D84是一个解密函数。</p>
<p>但是！其实我在主线程的trace.log中也看到了这个函数，可能是大佬没注意吧？</p>
<p>sub_1A1D84是一个典型的RC4算法函数，一眼a2是密钥，a3是长度。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527164604090.png" alt="image-20250527164604090" style="zoom:67%;" />

<p>hook一下，获得密钥的内容。长16字节，内容是：0x68,0x76,0x99,0x72,0x96,0x60,0x9f,0x63,0x96,0x2c,0x98,0x30,0xc2,0x36,0x51,0x42</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527165421138.png" alt="image-20250527165421138"></p>
<p>与sub_1A1D84的下一个函数调用是sub_1A1E74，明显的rc4解密。</p>
<p>hook一下，查看函数sub_1A1E74在对什么进行解密。</p>
<p>第一个加密内容如下所示。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527181237282.png" alt="image-20250527181237282"></p>
<p>将f7 4f e8 0e 62 19作为搜索关键词，在壳dex中进行搜索。</p>
<p>蓝色部分是不知道什么作用的8个字节，蓝色与红色直接是加密内容的长度，也就是0x10949f，红色部分是加密内容，因此，可以判断sub_1A1E74在对壳dex尾部的加密数据进行逐段解密。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527181335376.png" alt="image-20250527181335376"></p>
<p>同时注意到，先前先加0x70，再异或0x36的加密内容，同样源于壳dex的末尾，同样前8个字节不知道是什么，然后4个字节代表加密内容大小，0x31A4 + 0x41E &#x3D;&#x3D; 0x35C2，正好是上面那段加密内容的起始部分。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527181652626.png" alt="image-20250527181652626"></p>
<p>因此，可以猜测壳dex有多个段被加密，数据结构是这样的：不知道什么作用的8个字节 + 加密内容长度（4个字节） + 加密内容 + 不知道什么作用的8个字节…….</p>
<p>计算一下下一段加密内容的起始地址：0x10949F + 0x35CE &#x3D;&#x3D; 0x10CA6D，下一个加密内容的长度是0x31a3028，这个长度明显不肯，说明关于壳dex的数据结构猜测有问题，说明存在其它的加密方式。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527182226096.png" alt="image-20250527182226096"></p>
<p>观察我们的打印日志，只有f7 4f e8 0e 62开头encrypt_data在壳dex中，其它的加密内容，并没有出现在壳dex中。统计一下，有3个f7 4f e8 0e 62开头encrypt_data，还有3个长度为0x6400的encrypt_data，会不会代表着3个dex文件及其加密组件呢？</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527183939347.png" alt="image-20250527183939347" style="zoom:67%;" />

<p>把这3个内容解密看看，然而并没有出现dex的魔术。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527184825546.png" alt="image-20250527184825546" style="zoom:80%;" />

<p>总结一下，这3个rc加密的内容，分别在偏移<code>0x35CE</code> , <code>0x3A93AD</code> , <code>0x417064</code>的位置。</p>
<p>看了一眼博主的分析，好像确实是这样！</p>
<p>所以，加密dex的数据结构应该是这个样子：<strong>未知8个字节、配置信息长度（4字节）、配置信息、加密内容个数（4个字节）、加密内容1的总长度（4个字节）、加密内容1需要rc4解密的长度（4个字节）、加密内容1、加密内容2的总长度（4个字节）、加密内容2需要rc4解密的长度（4个字节）、加密内容2、加密内容3的总长度（4个字节）、加密内容3需要rc4解密的长度（4个字节）、加密内容3。</strong></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20240308004303427.png" alt="image-20240308004303427"></p>
<p>如此，便可写一个脚本，尝试把加密内容脱下来并解密，如下图所示，下图是dex1的内容，仍然是加密内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527193149268.png" alt="image-20250527193149268" style="zoom:80%;" />

<p>跟着<del>博主</del>（函数调用链）继续分析，函数sub_18F6AC似乎在做解密。</p>
<p>其中，a3是加密内容被rc4解密后，从0xC开始的数据地址。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527193749337.png" alt="image-20250527193749337" style="zoom:80%;" />

<p>具体如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527194144192.png" alt="image-20250527194144192"></p>
<p>还有11个字节，在函数sub_18DCC0进行处理。以5、4、4字节的大小进行读取。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527194317120.png" alt="image-20250527194317120"></p>
<p>以dex1.dex为例，按照这种方式进行读取的话，内容在破折号后面，记作a1、a2、a3——0x 01 00 00 00 5D、0x 00 40 00 00、0x 00 10 94 92。</p>
<p>a2：</p>
<p>之前将加密内容分成了：1.rc4解密数据，2.未加密数据；而在更早之前，我们在hook maps文件的时候，曾获得了一个解密的dex文件，经过搜索未加密数据，发现未加密数据在dex的偏移量刚好是a2。</p>
<p>以dex1.dex为例，dex1的a2是0x400000，那未加密数据的内容，在dex1.dex中需要移动到偏移量为0x400000的地方。</p>
<p>下图是dex1.dex。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527200812044.png" alt="image-20250527200812044"></p>
<p>下图是未加密数据。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527200828145.png" alt="image-20250527200828145"></p>
<p>而a3，代表着第2次解密的长度（尚未知道是什么算法）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527201027621.png" alt="image-20250527201027621"></p>
<p>随后，发现了一个很关键的信息——sub_128D44的返回值是一个3级指针，指向着解密之后的dex。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527201458653.png" alt="image-20250527201458653"></p>
<p>而且，这个dex数据的首地址是0x6ffeae3000，一般mmap申请空间才会这么规整，按照0x1000对齐来给空间。</p>
<p>发现，sub_19b73c调用了mmap。</p>
<p>那咱可以尝试在mmap调用完后，获得申请的空间地址，然后对这部分空间下读写断点，同时打印调用栈。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_mmap</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x19B81C</span>), &#123;</span><br><span class="line">        <span class="comment">// fd, buff, len</span></span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;mmap!&quot;</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>);</span><br><span class="line">            <span class="title class_">MemoryAccessMonitor</span>.<span class="title function_">enable</span>(</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">base</span>:<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>,</span><br><span class="line">                    <span class="attr">size</span>:<span class="number">30</span></span><br><span class="line">                &#125;,&#123;</span><br><span class="line">                    <span class="attr">onAccess</span>: <span class="keyword">function</span> (<span class="params">details</span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(details.<span class="property">operation</span>)</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">get_addr_in_so</span>(details.<span class="property">from</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_addr_in_so</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> process_Obj_Module_Arr = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; process_Obj_Module_Arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(addr&gt;process_Obj_Module_Arr[i].<span class="property">base</span> &amp;&amp; addr&lt;process_Obj_Module_Arr[i].<span class="property">base</span>.<span class="title function_">add</span>(process_Obj_Module_Arr[i].<span class="property">size</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> addr.<span class="title function_">toString</span>(<span class="number">16</span>)+<span class="string">&quot; is in &quot;</span>+process_Obj_Module_Arr[i].<span class="property">name</span>+<span class="string">&quot; offset: 0x&quot;</span>+(addr-process_Obj_Module_Arr[i].<span class="property">base</span>).<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> addr.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>脚本执行结果如下，可以发现调用了3次mmap，对应3个dex的映射，同时通过写断点，找到了是哪里在给这块内容进行写操作——0x18ebd4。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527202407163.png" alt="image-20250527202407163" style="zoom:80%;" />

<p>定位过来，在函数sub_18E8D0内部，这个函数十分大，第2次解密算法是自定义的算法，一般自定义算法，我会通过trace，通过汇编指令逐步还原解密法。——实习还没着落，不太想花时间在这，暂时先搁置吧。</p>
<p>可以猜到v15是基址，v4是游标，v28是解密后的内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527202610910.png" alt="image-20250527202610910" style="zoom:80%;" />

<p>最后写一个脚本，判断一下这里的v28是不是解密后的dex。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527205949901.png" alt="image-20250527205949901" style="zoom:80%;" />

<p>还不是dex的魔数？但发现：a1 a0 bd cf f5 f6 fd c5与c5进行异或后。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527210536218.png" alt="image-20250527210536218"></p>
<p>原来还有一步异或。</p>
<h2 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h2><p>很感谢有这样的大佬愿意分享技术博客，光是复现就学到很多了，谢谢！</p>
<p>从我自己的角度来说，这一次分析360免费壳真是学到了很多，不仅对动态链接的流程更加深刻了，同时开阔了眼界——还能这么玩？</p>
<p>在复现的时候，对于主so的还原，我还有些思路，就算没思路了还可以看看大佬的博客；但在主dex的还原时，明显感觉到，我的分析缺乏目的性，虽然看了大佬的博客会有思路，但很多时候还是踩在巨人的肩膀上，我很难想象要是从头自己分析，要分析得有多崩溃（可能我太菜了吧）。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>数字壳的加固方案：壳DEX-&gt;壳ELF-&gt;主ELF-&gt;主DEX——具体的加固方式在上面的内容中。</li>
<li>反调使用了sscanf解读maps文件，读取相应字段对frida进行检测，这算是常规操作了。</li>
</ol>
<h2 id="不足之处"><a href="#不足之处" class="headerlink" title="不足之处"></a>不足之处</h2><p>1.学习如何写JEB脚本，oacia师傅写了一个JEB解密脚本，可以简单学习一下。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.client.api <span class="keyword">import</span> IScript, IconType, ButtonGroupType</span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.core <span class="keyword">import</span> RuntimeProjectUtil</span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.core.units.code.java <span class="keyword">import</span> IJavaSourceUnit</span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.core.units.code <span class="keyword">import</span> ICodeUnit, ICodeItem</span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.core.output.text <span class="keyword">import</span> ITextDocument</span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.core.units.code.java <span class="keyword">import</span> IJavaSourceUnit, IJavaStaticField, IJavaNewArray, IJavaConstant, IJavaCall, IJavaField, IJavaMethod, IJavaClass</span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.core.events <span class="keyword">import</span> JebEvent, J</span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.core.util <span class="keyword">import</span> DecompilerHelper</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解密字符串函数的类名以及方法名</span></span><br><span class="line">methodName = [<span class="string">&#x27;Lcom/qihoo/util/a;&#x27;</span>, <span class="string">&#x27;a&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">dec_str_360jiagu</span>(<span class="title class_ inherited__">IScript</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, ctx</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;start deal with strings&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.ctx = ctx</span><br><span class="line">        engctx = ctx.getEnginesContext()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> engctx:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Back-end engines not initialized&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        projects = engctx.getProjects()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> projects:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;There is no opened project&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        units = RuntimeProjectUtil.findUnitsByType(projects[<span class="number">0</span>], IJavaSourceUnit, <span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">for</span> unit <span class="keyword">in</span> units:</span><br><span class="line">            javaClass = unit.getClassElement()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[+] decrypt:&#x27;</span> + javaClass.getName())</span><br><span class="line">            <span class="variable language_">self</span>.cstbuilder = unit.getFactories().getConstantFactory()</span><br><span class="line">            <span class="variable language_">self</span>.processClass(javaClass)</span><br><span class="line">            unit.notifyListeners(JebEvent(J.UnitChange))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Done.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">processClass</span>(<span class="params">self, javaClass</span>):</span><br><span class="line">        <span class="keyword">if</span> javaClass.getName() == methodName[<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">for</span> method <span class="keyword">in</span> javaClass.getMethods():</span><br><span class="line">            block = method.getBody()</span><br><span class="line">            i = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> i &lt; block.size():</span><br><span class="line">                stm = block.get(i)</span><br><span class="line">                <span class="variable language_">self</span>.checkElement(block, stm)</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">checkElement</span>(<span class="params">self, parent, e</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(e, IJavaCall):</span><br><span class="line">                mmethod = e.getMethod()</span><br><span class="line">                mname = mmethod.getName()</span><br><span class="line">                msig = mmethod.getSignature()</span><br><span class="line">                <span class="keyword">if</span> mname == methodName[<span class="number">1</span>] <span class="keyword">and</span> methodName[<span class="number">0</span>] <span class="keyword">in</span> msig:</span><br><span class="line">                    v = []</span><br><span class="line">                    <span class="keyword">for</span> arg <span class="keyword">in</span> e.getArguments():</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">isinstance</span>(arg, IJavaConstant):</span><br><span class="line">                            v.append(arg.getString())</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(v) == <span class="number">1</span>:</span><br><span class="line">                        decstr = <span class="variable language_">self</span>.decryptstring(v[<span class="number">0</span>])</span><br><span class="line">                        parent.replaceSubElement(e, <span class="variable language_">self</span>.cstbuilder.createString(decstr))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> subelt <span class="keyword">in</span> e.getSubElements():</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(subelt, IJavaClass) <span class="keyword">or</span> <span class="built_in">isinstance</span>(subelt, IJavaField) <span class="keyword">or</span> <span class="built_in">isinstance</span>(subelt, IJavaMethod):</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="variable language_">self</span>.checkElement(e, subelt)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;error&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decryptstring</span>(<span class="params">self, string</span>):</span><br><span class="line">        src = []</span><br><span class="line">        <span class="keyword">for</span> index, char <span class="keyword">in</span> <span class="built_in">enumerate</span>(string):</span><br><span class="line">            src.append(<span class="built_in">chr</span>(<span class="built_in">ord</span>(char) ^ <span class="number">16</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(src).decode(<span class="string">&#x27;unicode_escape&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>2.根据大佬的博客，在attachBaseContexr中会加载DtcLoader类，jeb中没显示出来，而在jadx中显示了，这是如何做到的？这个DtcLoader做了什么？</p>
<p>3.onCreate的vmp没分析。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="noopener" href="https://oacia.dev/360-jiagu/">https://oacia.dev/360-jiagu/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/21/%E6%9F%90%E5%92%96%E5%95%A1app%E5%8D%8F%E8%AE%AE%E5%AD%97%E6%AE%B5%E5%88%86%E6%9E%90%E2%80%94%E2%80%94sign%E3%80%81q/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/21/%E6%9F%90%E5%92%96%E5%95%A1app%E5%8D%8F%E8%AE%AE%E5%AD%97%E6%AE%B5%E5%88%86%E6%9E%90%E2%80%94%E2%80%94sign%E3%80%81q/" class="post-title-link" itemprop="url">某咖啡app协议字段分析——sign、q</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-21 18:40:08 / 修改时间：18:43:42" itemprop="dateCreated datePublished" datetime="2025-05-21T18:40:08+08:00">2025-05-21</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>31k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>57 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="分析流程"><a href="#分析流程" class="headerlink" title="分析流程"></a>分析流程</h1><p>首先打开JEB观察分析结果，看到存在com.qihoo.util，说明是数字壳。</p>
<p>从Manifest可以知道，包名是com.lucky.luckyclient。</p>
<p>接下来先进行脱壳，我之前刷了一个aosp10的脱壳机，正好试试。</p>
<h2 id="脱壳"><a href="#脱壳" class="headerlink" title="脱壳"></a>脱壳</h2><p>将app装入脱壳机，在某个指定文件中输入该app的包名，等待脱壳完毕即可。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519151242871.png" alt="image-20250519151242871"></p>
<p>将脱完后的内容放入jadx，已经可以看到很多java层的代码了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519152942187.png" alt="image-20250519152942187" style="zoom:67%;" />

<p>接下来尝试抓包，我抓包工具还挺多的，reqable或Charles都行，试试Charles好了。</p>
<h2 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h2><p>先观察电脑ip。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519154135717.png" alt="image-20250519154135717" style="zoom:80%;" />

<p>将手机连上同一个局域网，并将代理设置为主机的ip，端口则填Charles监听的端口。——因此，代理地址是192.168.1.188:9999。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519154503684.png" alt="image-20250519154503684" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519154806363.png" alt="image-20250519154806363" style="zoom:67%;" />

<p>要分析的这个请求是为了获得AuthCode（授权码），根据网上的博客，接下来开始分析<strong>sign</strong>和<strong>q字段</strong>的加密流程。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519160845900.png" alt="image-20250519160845900" style="zoom:80%;" />

<h2 id="分析加密流程"><a href="#分析加密流程" class="headerlink" title="分析加密流程"></a>分析加密流程</h2><h3 id="sign"><a href="#sign" class="headerlink" title="sign"></a>sign</h3><p>在jadx直接搜索sign，观察是否能直接找到关于字段sign的代码，事实证明，并不可以。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519161524126.png" alt="image-20250519161524126"></p>
<p>一般在开发中，存储字段会使用到标准sdk的HashMap，因此，接下来可以hook HashMap的put，观察进程是否会调用HashMap.put将sign字段存储起来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">call_HashMap</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> hashMap = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.util.HashMap&quot;</span>);</span><br><span class="line">        hashMap.<span class="property">put</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (a != <span class="literal">null</span> &amp;&amp; a.<span class="title function_">equals</span>(<span class="string">&quot;sign&quot;</span>)) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()))</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hashMap.put: &quot;</span>, a, b);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">put</span>(a, b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印的结果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519162507367.png" alt="image-20250519162507367"></p>
<p>很自然地，通过调用方法栈，我们下一个分析的点就是 <strong>getRequestParams</strong>。</p>
<p>将 <strong>com.lucky.lib.http2.AbstractLcRequest.getRequestParams</strong> 拿到jadx中搜一搜。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519162956867.png" alt="image-20250519162956867" style="zoom:80%;" />

<p>结合我们之前打印的结果，StubApp.getString2 在把字符串解密后，返回值字符串。</p>
<p>hook一下，查看返回值，代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">get_str</span>(<span class="params">num</span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="title class_">StubApp</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.stub.StubApp&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[num] &quot;</span>, num, <span class="string">&quot; -&gt; &quot;</span>, <span class="string">&quot;[decrypt_str] &quot;</span>, <span class="title class_">StubApp</span>.<span class="title function_">getString2</span>(num));</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印的结果如下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519164034161.png" alt="image-20250519164034161" style="zoom:80%;" />

<p>在jadx中加点注释。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519164527033.png" alt="image-20250519164527033"></p>
<p>我们的目标是 <strong>sign</strong>，它的值是这样得来的，也就是说，要先获得cid、uid、q的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C9267r.m20563a(cid, uid, q2)</span><br></pre></td></tr></table></figure>

<p>直接写脚本获取cid、uid、q，我们的目标是分析 <strong>sign</strong> 的加密流程。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> R = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.lucky.lib.http2.r&quot;</span>);</span><br><span class="line">    R.<span class="property">a</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">cid, uid, q</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[cid] &quot;</span>, cid);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[uid] &quot;</span>, uid);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[q] &quot;</span>, q);</span><br><span class="line">        <span class="keyword">var</span> res = <span class="variable language_">this</span>.<span class="title function_">a</span>(cid, uid, q);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行后报错了，说是找不到类 <strong>com.lucky.lib.http2.r</strong>，可能是因为Frida使用的类加载器不对？经过尝试，这个类并不是一开始就加载的类，类未加载的时候hook不上。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">get_cid_uid_q</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateClassLoaders</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">loader</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 尝试使用当前 loader 加载类，不要设置全局 loader</span></span><br><span class="line">                    <span class="keyword">const</span> R = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.lucky.lib.http2.r&quot;</span>, &#123; <span class="attr">classLoader</span>: loader &#125;);</span><br><span class="line">                    <span class="comment">// console.log(&quot;[SUCCESS] Found com.lucky.lib.http2.r with loader: &quot; + loader);</span></span><br><span class="line">    </span><br><span class="line">                    R.<span class="property">a</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">cid, uid, q</span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Hooked R.a] Reached!&quot;</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[cid] &quot;</span>, cid);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[uid] &quot;</span>, uid);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[q] &quot;</span>, q);</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// 暂时不要调用原始方法，先看hook本身是否稳定</span></span><br><span class="line">                        <span class="comment">//console.log(&quot;Original method R.a will not be called for now to test stability.&quot;);</span></span><br><span class="line">                        <span class="keyword">var</span> res = <span class="variable language_">this</span>.<span class="title function_">a</span>(cid, uid, q);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[res from &quot;</span> + loader + <span class="string">&quot;] &quot;</span>, res);</span><br><span class="line">                        <span class="keyword">return</span> res;</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// 根据原始方法的返回类型返回一个默认值，如果是void则不需要返回</span></span><br><span class="line">                        <span class="comment">// 如果不知道返回类型，可以暂时返回 null</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="comment">// 如果希望只hook一次，可以在这里添加逻辑停止枚举或标记已hook</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[FAIL] Could not find com.lucky.lib.http2.r with loader: &quot;</span> + loader);</span><br><span class="line">                    <span class="comment">// 如果错误不是 ClassNotFoundException，打印出来看看</span></span><br><span class="line">                    <span class="keyword">if</span> (!e.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&quot;java.lang.ClassNotFoundException&quot;</span>)) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Error while trying to use class with loader &quot;</span> + loader + <span class="string">&quot;: &quot;</span> + e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Class loader enumeration complete.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(get_cid_uid_q);</span><br></pre></td></tr></table></figure>

<p>等待一段时间，等到类加载了再进行hook即可。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519183249268.png" alt="image-20250519183249268"></p>
<p>cid、uid基本是不变的（除非换账号、删缓存），唯一会变的是q。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519183502080.png" alt="image-20250519183502080"></p>
<p>之后分析的时候，需要将q固定，这里先不动它。</p>
<p>点进 <strong>C9267r.m20563a(cid, uid, q2)</strong> 查看，大致逻辑可以总结成下面这个式子，key和value代入uid、cid、q即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C9247c.f237976b.m20087a(<span class="string">&quot;&lt;key&gt;=&lt;value&gt;;&lt;key&gt;=&lt;value&gt;;&lt;key&gt;=&lt;value&gt;;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519184802371.png" alt="image-20250519184802371"></p>
<p>点进 <strong>C9247c.f237976b.m20087a</strong> 查看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519191252914.png" alt="image-20250519191252914"></p>
<p>观察 <strong>this.f237669e.mo15913a</strong> ，this代表对象，<strong>f237669e</strong> 是this对象的接口对象，通过这个接口对象调用接口中声明的方法。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519191500562.png" alt="image-20250519191500562" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519191524953.png" alt="image-20250519191524953" style="zoom:80%;" />

<p>如果想hook一个接口或者抽象方法，需要找到实现的地方进行hook，这跟frida是如何hook java层方法的原理有关。——简单来说，一个Java方法对应一个ArtMethod，我们要找到实现Java方法的ArtMethod，抽象方法和接口都没有实际的CodeItem。</p>
<p>因此，我们要找到实现了这个接口的类，但是，这又有一个问题，CryptoHelper似乎并没有继承其它的类，没有间接实现接口的可能；那还有两个可能：一是赋值的时候用匿名类，在赋值的时候，同时实现了接口；二是定义一个实现好了接口的类，然后作为参数传能够给赋值 <strong>f237669e</strong> 的方法。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519192312985.png" alt="image-20250519192312985"></p>
<p>交叉引用这个接口对象 <strong>f237669e</strong>，可以注意到，只有<strong>构造函数</strong>和<strong>方法m20086a</strong>可能为接口对象赋值了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519192915818.png" alt="image-20250519192915818"></p>
<p>交叉引用<strong>方法m20086a</strong>，会发现：没有任何被Java层代码调用的地方，那这个函数可能是在native层被调用了（通过FindClass、CallStaticMethod等函数调用），所以在jadx中查不到。</p>
<p>接着交叉引用构造函数，这回有收获了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519193321999.png" alt="image-20250519193321999"></p>
<p>分别去查看C8118a、C9123b等类，查看它们关于接口的实现方式，结果如下。</p>
<p><strong>C8118a的实现。</strong></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519193455565.png" alt="image-20250519193455565" style="zoom:80%;" />

<p>可以注意到，有点像base64编码（但标准的base64没有_符号），去试试解码。——试了后发现，都是不可显示的字符，用Hex也没看出什么特征。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519195428064.png" alt="image-20250519195428064" style="zoom:80%;" />

<p>之后发现，这里面的_需要换成&#x2F;，不过之后再说吧。</p>
<p><strong>C9123b的实现。</strong></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519193855028.png" alt="image-20250519193855028" style="zoom:80%;" />

<p><strong>C9234b的实现</strong>有点绕。</p>
<p>继续追踪f237975a。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519194259042.png" alt="image-20250519194259042" style="zoom:80%;" />

<p>根据交叉引用，它只会通过方法m20437c得到值，因此继续追踪方法m20437c。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519194422403.png" alt="image-20250519194422403" style="zoom:80%;" />

<p>查看成员变量f238026j，进行交叉引用。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519194501863.png" alt="image-20250519194501863" style="zoom:67%;" />

<p>发现它只会在方法m20538g进行调用，继续交叉引用。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519194551662.png" alt="image-20250519194551662"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519194632237.png" alt="image-20250519194632237"></p>
<p><strong>因此，C9234b的实现是这样的。</strong></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519194736625.png" alt="image-20250519194736625" style="zoom:80%;" />

<p><strong>C11110a的实现。</strong></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519195626309.png" alt="image-20250519195626309"></p>
<p><strong>C11112c的实现</strong>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519195706646.png" alt="image-20250519195706646"></p>
<p>回到方法 <strong>m20087a</strong>。</p>
<p>md5_crypt( str.getBytes(), num)，这里的num是0&#x2F;1&#x2F;2中的一个，大概率是1，因为根据上述解密，似乎其它的类似base64编码的字节码，在解码后是不可视的字节码？无法和coffee、tea进行比较。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519201707502.png" alt="image-20250519201707502"></p>
<p>这里的md5_crypt是native函数，不妨hook一下，看看i2的值是什么。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519202206855.png" alt="image-20250519202206855" style="zoom:80%;" />

<p>代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_md5_crypt</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="title class_">CryptoHelper</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.luckincoffee.safeboxlib.CryptoHelper&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">CryptoHelper</span>.<span class="property">md5_crypt</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">arr, i2</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`--- md5_crypt called ---`</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[i2] <span class="subst">$&#123;i2&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[bArr] byte array of length <span class="subst">$&#123;arr.length&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历字节数组，并尝试转换为ASCII字符</span></span><br><span class="line">            <span class="keyword">let</span> hexString = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">let</span> asciiString = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">const</span> bytesPerLine = <span class="number">16</span>; <span class="comment">// 每行显示的字节数，方便查看</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">const</span> byte = arr[i];</span><br><span class="line">                <span class="comment">// 将有符号字节转换为无符号整数 (0-255)</span></span><br><span class="line">                <span class="keyword">const</span> unsignedByte = byte &amp; <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将字节值转换为十六进制字符串，方便对比</span></span><br><span class="line">                hexString += unsignedByte.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>) + <span class="string">&#x27; &#x27;</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 判断是否为可打印的ASCII字符 (通常范围是 32 到 126)</span></span><br><span class="line">                <span class="keyword">if</span> (unsignedByte &gt;= <span class="number">32</span> &amp;&amp; unsignedByte &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">                    asciiString += <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unsignedByte);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果不是可打印字符，用点或其他符号代替</span></span><br><span class="line">                    asciiString += <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 每隔 bytesPerLine 打印一行，或者在数组结束时打印剩余部分</span></span><br><span class="line">                <span class="keyword">if</span> ((i + <span class="number">1</span>) % bytesPerLine === <span class="number">0</span> || i === arr.<span class="property">length</span> - <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="comment">// 为了对齐，给较短的行添加空格填充</span></span><br><span class="line">                     <span class="keyword">while</span> (hexString.<span class="property">length</span> &lt; bytesPerLine * <span class="number">3</span>) &#123; <span class="comment">// 2 chars + 1 space per byte</span></span><br><span class="line">                        hexString += <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  <span class="subst">$&#123;hexString&#125;</span> | <span class="subst">$&#123;asciiString&#125;</span>`</span>);</span><br><span class="line">                    hexString = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                    asciiString = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`--- Calling original md5_crypt ---`</span>);</span><br><span class="line">            <span class="comment">// 调用原始的 native 方法并返回结果</span></span><br><span class="line">            <span class="keyword">const</span> result = <span class="variable language_">this</span>.<span class="title function_">md5_crypt</span>(arr, i2);</span><br><span class="line">             <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`--- Original md5_crypt returned ---`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_md5_crypt);</span><br></pre></td></tr></table></figure>

<p>如果多截几张图，就会发现，i2基本恒为1，符合我们的猜测，bArr数组其实就是cid、q、uid放在一块。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519210039726.png" alt="image-20250519210039726" style="zoom:80%;" />

<p>接下来进入native层分析md5_crypt对应的函数，将libcryptoDD.so放入IDA中。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519210317230.png" alt="image-20250519210317230"></p>
<p>进来后，先来看看导出表，我们的目标大概率是android_native_md5。</p>
<p>同时，发现存在很多.datadiv_decodexxxxxx的函数，应该是解密字符串用的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519210441038.png" alt="image-20250519210441038"></p>
<p>基本都在.init_array段上，先不着急分析了，先写个脚本，将解密后的so文件进行dump，这样便于之后的分析。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519210536785.png" alt="image-20250519210536785"></p>
<p>最后一个datadiv函数的地址是0x1B61C。可以在hook这个函数的onLeave回调进行dump。</p>
<p>我靠，我写好了脚本，尝试了好多遍为什么一dump就“非法指令”退出，突然想起来，”libcryptoDD.so”是32位的so，不仅要修改linker64 -&gt; linker，还需要修改call_constructor的偏移量。</p>
<p>但似乎改了后，还是会崩溃，那就应该是有反调了，但我没注意反调在哪，跑了挺久，也没退出，可能是对某些关键函数的hook做了检测吧，之后再去找找看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519220328748.png" alt="image-20250519220328748"></p>
<p>既然这样，不在第一时间dump了，等so文件稳定了再dump。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libcryptoDD.so&quot;</span>; <span class="comment">// 可选：目标库名称，用于过滤</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> dlopenPtr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;dlopen&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!dlopenPtr) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[!] dlopen not found.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking dlopen at &quot;</span> + dlopenPtr);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(dlopenPtr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> libraryPath = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(args[<span class="number">0</span>]);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dlopen] Loading library: &quot;</span> + libraryPath);</span><br><span class="line">            <span class="keyword">if</span> (libraryPath.<span class="title function_">includes</span>(module_name)) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[!] Target library &quot;</span> + module_name + <span class="string">&quot; loaded, exiting...&quot;</span>);</span><br><span class="line">                <span class="title class_">Process</span>.<span class="title function_">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_android_dlopen_ext</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> androidDlopenExtPtr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!androidDlopenExtPtr) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[!] android_dlopen_ext not found.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking android_dlopen_ext at &quot;</span> + androidDlopenExtPtr);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(androidDlopenExtPtr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> libraryPath = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(args[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">var</span> flags = args[<span class="number">1</span>].<span class="title function_">toInt32</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[android_dlopen_ext] Loading library: &quot;</span> + libraryPath + <span class="string">&quot;, flags: 0x&quot;</span> + flags.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">            <span class="keyword">if</span> (libraryPath.<span class="title function_">includes</span>(module_name)) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[!] Target library &quot;</span> + module_name + <span class="string">&quot; loaded, exiting...&quot;</span>);</span><br><span class="line">                <span class="title class_">Process</span>.<span class="title function_">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">hook_dlopen</span>();</span><br><span class="line">        <span class="title function_">hook_android_dlopen_ext</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] Hooking dlopen and android_dlopen_ext initialized.&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump_so</span>(<span class="params">so_name</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(so_name);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[name] &quot;</span>, so_name);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[base] &quot;</span>, secmodule.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[size] &quot;</span>, secmodule.<span class="property">size</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">    <span class="title function_">dump</span>(secmodule.<span class="property">base</span>, secmodule.<span class="property">size</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump</span>(<span class="params">begin_addr, dump_size</span>)&#123;</span><br><span class="line">    <span class="comment">// console.log(&quot;[name] &quot;, module_name);</span></span><br><span class="line">    <span class="comment">// console.log(&quot;[base] &quot;, begin_addr);</span></span><br><span class="line">    <span class="comment">// console.log(&quot;[size] &quot;, &quot;0x&quot; + dump_size.toString(16));</span></span><br><span class="line">    <span class="keyword">var</span> file_path = <span class="string">&quot;/data/data/com.lucky.luckyclient/zzc_0x&quot;</span> + begin_addr.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;_0x&quot;</span> + dump_size.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;.so&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="title function_">ptr</span>(begin_addr), dump_size, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> libso_buffer = <span class="title function_">ptr</span>(begin_addr).<span class="title function_">readByteArray</span>(dump_size);</span><br><span class="line">        file_handle.<span class="title function_">write</span>(libso_buffer);</span><br><span class="line">        file_handle.<span class="title function_">flush</span>();</span><br><span class="line">        file_handle.<span class="title function_">close</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump] &quot;</span>, file_path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure>

<p>执行结果如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519221122233.png" alt="image-20250519221122233"></p>
<p>然后将它pull出来，用修复工具修复（别用soFixer，可能导入表是乱的），展示一下修复后两个so文件的区别，明显可以看到，有一些字符串已经解密了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519222654556.png" alt="image-20250519222654556"></p>
<p>继续分析这个so文件，写一个脚本hook上RegisterNatives，判断一下md5_crypt对应的native函数地址是哪个。</p>
<p>还没打印到那一步，就已经退出了。</p>
<p>我尝试hook了libc标准库的常见函数，如：open、openat、strstr等函数，没发现对frida检测。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519223425284.png" alt="image-20250519223425284"></p>
<p>还有一个问题，无法实现对call_constructor的hook，根据调用栈，会发现报错源来自frida的agent，是frida版本的问题吗？</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520101558428.png" alt="image-20250520101558428"></p>
<p>之后再来分析，先去分析数字免费壳，再来分析这个付费壳。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520132734558.png" alt="image-20250520132734558" style="zoom:80%;" />

<p>之后我发现，换了一个方式hook RegisterNatives就能打印md5_crypt的注册地址了？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取 RegisterNatives 函数的内存地址，并赋值给addrRegisterNatives。</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> addrRegisterNatives = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> symbols = <span class="title class_">Module</span>.<span class="title function_">enumerateSymbolsSync</span>(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;art&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;JNI&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;RegisterNatives&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            addrRegisterNatives = symbol.<span class="property">address</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;RegisterNatives is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (addrRegisterNatives) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrRegisterNatives, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> env = args[<span class="number">0</span>];        <span class="comment">// jni对象</span></span><br><span class="line">                <span class="keyword">var</span> java_class = args[<span class="number">1</span>]; <span class="comment">// 类</span></span><br><span class="line">                <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(java_class);</span><br><span class="line">                <span class="keyword">var</span> taget_class = <span class="string">&quot;com.luckincoffee.safeboxlib.CryptoHelper&quot;</span>;   <span class="comment">//111 某个类中动态注册的so</span></span><br><span class="line">                <span class="keyword">if</span> (class_name === taget_class) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n[RegisterNatives] method_count:&quot;</span>, args[<span class="number">3</span>]);</span><br><span class="line">                    <span class="keyword">var</span> methods_ptr = <span class="title function_">ptr</span>(args[<span class="number">2</span>]);</span><br><span class="line">                    <span class="keyword">var</span> method_count = <span class="built_in">parseInt</span>(args[<span class="number">3</span>]);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; method_count; i++) &#123;</span><br><span class="line">                        <span class="comment">// Java中函数名字的</span></span><br><span class="line">                        <span class="keyword">var</span> name_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span>));</span><br><span class="line">                        <span class="comment">// 参数和返回值类型</span></span><br><span class="line">                        <span class="keyword">var</span> sig_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span>));</span><br><span class="line">                        <span class="comment">// C中的函数内存地址</span></span><br><span class="line">                        <span class="keyword">var</span> fnPtr_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">2</span>));</span><br><span class="line">                        <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(name_ptr);</span><br><span class="line">                        <span class="keyword">var</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(sig_ptr);</span><br><span class="line">                        <span class="keyword">var</span> find_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(fnPtr_ptr);</span><br><span class="line">                        <span class="comment">// 地址、偏移量、基地址</span></span><br><span class="line">                        <span class="keyword">var</span> offset = <span class="title function_">ptr</span>(fnPtr_ptr).<span class="title function_">sub</span>(find_module.<span class="property">base</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;class_name:&#x27;</span>,class_name,<span class="string">&quot;name:&quot;</span>, name, <span class="string">&quot;sig:&quot;</span>, sig,<span class="string">&#x27;module_name:&#x27;</span>,find_module.<span class="property">name</span> ,<span class="string">&quot;offset:&quot;</span>, offset);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br><span class="line"><span class="comment">// 动态注册函数地址</span></span><br><span class="line"><span class="comment">// frida -U -f com.lucky.luckyclient -l hook_so_register.js  </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>原先的脚本如下，区别在于：上面这个脚本在RegiterNatives的地方加了个taget_class的限制，那问题应该是注册了太多函数，导致打印崩溃了（？），先不管，之后分析壳的时候再看。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">find_RegisterNatives</span>(<span class="params">params</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> symbols = <span class="title class_">Module</span>.<span class="title function_">enumerateSymbolsSync</span>(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> addrRegisterNatives = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> symbol = symbols[i];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//_ZN3art3JNI15RegisterNativesEP7_JNIEnvP7_jclassPK15JNINativeMethodi</span></span><br><span class="line">        <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;art&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;JNI&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; </span><br><span class="line">                symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;RegisterNatives&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; </span><br><span class="line">                symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            addrRegisterNatives = symbol.<span class="property">address</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;RegisterNatives is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            <span class="title function_">hook_RegisterNatives</span>(addrRegisterNatives)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_RegisterNatives</span>(<span class="params">addrRegisterNatives</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addrRegisterNatives != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrRegisterNatives, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[RegisterNatives] method_count:&quot;</span>, args[<span class="number">3</span>]);</span><br><span class="line">                <span class="keyword">let</span> java_class = args[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">let</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(java_class);</span><br><span class="line">                <span class="comment">//console.log(class_name);</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> methods_ptr = <span class="title function_">ptr</span>(args[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> method_count = <span class="built_in">parseInt</span>(args[<span class="number">3</span>]);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; method_count; i++) &#123;</span><br><span class="line">                    <span class="keyword">let</span> name_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span>));</span><br><span class="line">                    <span class="keyword">let</span> sig_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span>));</span><br><span class="line">                    <span class="keyword">let</span> fnPtr_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">let</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(name_ptr);</span><br><span class="line">                    <span class="keyword">let</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(sig_ptr);</span><br><span class="line">                    <span class="keyword">let</span> symbol = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(fnPtr_ptr)</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[RegisterNatives] java_class:&quot;</span>, class_name, <span class="string">&quot;name:&quot;</span>, name, <span class="string">&quot;sig:&quot;</span>, sig, <span class="string">&quot;fnPtr:&quot;</span>, fnPtr_ptr,  <span class="string">&quot; fnOffset:&quot;</span>, symbol, <span class="string">&quot; callee:&quot;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(find_RegisterNatives);</span><br></pre></td></tr></table></figure>

<p>打印的结果如下，md5_crypt对应着的地址是sub_1a981。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520135811852.png" alt="image-20250520135811852"></p>
<p>我开了两个IDA对照着看，因为dump下来的文件虽然恢复了某些代码，但IDA的反汇编的伪代码也变了，没原来的so好读。</p>
<p>根据对sub_1a981的分析，发现<strong>输入数据</strong>和<strong>输入数据的长度</strong>在sub_13E3C进行调用，sub_13E3C的函数名是md5。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520144716225.png" alt="image-20250520144716225" style="zoom:80%;" />

<p>v24很有可能就是md5的返回值，可以写个脚本试试。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_md5</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> module_base = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libcryptoDD.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(module_base.<span class="title function_">add</span>(<span class="number">0x13E3c</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">data</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">data_len</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">digest</span> = args[<span class="number">2</span>];</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[data]:\n&quot;</span>, <span class="title function_">hexdump</span>(args[<span class="number">0</span>], &#123;<span class="attr">length</span>: args[<span class="number">1</span>]&#125;));</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[digest]:\n&quot;</span>, <span class="title function_">hexdump</span>(args[<span class="number">2</span>], &#123;<span class="attr">length</span>: <span class="number">64</span>&#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>肯定是有反调，不然这种程度的hook，不至于引起进程崩溃。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520162306897.png" alt="image-20250520162306897"></p>
<p>接下来用unidbg模拟执行。</p>
<p>代码如下，从这套代码中，可以学会如何下断点（甚至是动调），如何模拟一个native层函数的执行。下断点的方式有2种，一是Unidbg提供的接口断点，二是Unicorn提供的断点，代码里都有涉及。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.luckincoffee.safeboxlib;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.AndroidEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Emulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.backend.Unicorn2Factory;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.array.ByteArray;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.jni.ProxyClassFactory;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.utils.Inspector;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.context.RegisterContext;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.debugger.BreakPointCallback;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.debugger.Debugger;</span><br><span class="line"><span class="keyword">import</span> com.sun.jna.Pointer;</span><br><span class="line"><span class="keyword">import</span> unicorn.ArmConst;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CryptoHelper</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DvmClass cCryptoHelper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CryptoHelper</span><span class="params">()</span> &#123;</span><br><span class="line">        emulator = AndroidEmulatorBuilder.for32Bit()</span><br><span class="line">                .addBackendFactory(<span class="keyword">new</span> <span class="title class_">Unicorn2Factory</span>(<span class="literal">true</span>))</span><br><span class="line">                .setProcessName(<span class="string">&quot;com.lucky.luckyclient&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">Memory</span> <span class="variable">memory</span> <span class="operator">=</span> emulator.getMemory();</span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>));</span><br><span class="line">        vm = emulator.createDalvikVM(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;../file/rx.apk&quot;</span>));</span><br><span class="line">        vm.setJni(<span class="built_in">this</span>);</span><br><span class="line">        vm.setDvmClassFactory(<span class="keyword">new</span> <span class="title class_">ProxyClassFactory</span>());</span><br><span class="line">        vm.setVerbose(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">DalvikModule</span> <span class="variable">dm</span> <span class="operator">=</span> vm.loadLibrary(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/resources/example_binaries/armeabi-v7a/libcryptoDD.so&quot;</span>), <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">module</span> = dm.getModule();</span><br><span class="line">        cCryptoHelper = vm.resolveClass(<span class="string">&quot;com/luckincoffee/safeboxlib/CryptoHelper&quot;</span>);</span><br><span class="line">        dm.callJNI_OnLoad(emulator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">md5_hook</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Debugger</span> <span class="variable">debugger</span> <span class="operator">=</span> emulator.attach();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Hook md5 function at 0x13E3C: md5(indata_jarray, initial_len, v25)</span></span><br><span class="line">        debugger.addBreakPoint(<span class="keyword">module</span>.base + <span class="number">0x14D6E</span>, <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line"><span class="comment">//                System.out.println(&quot;Breakpoint hit: md5 at 0x&quot; + Long.toHexString(address));</span></span><br><span class="line"><span class="comment">//                RegisterContext context = emulator.getContext();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Parameters: ARM32 registers R0-R2</span></span><br><span class="line"><span class="comment">//                long jarray = context.getLongArg(0); // R0: indata_jarray (jbyteArray)</span></span><br><span class="line"><span class="comment">//                long initial_len = context.getLongArg(1); // R1: initial_len (jint)</span></span><br><span class="line"><span class="comment">//                long v25 = context.getLongArg(2); // R2: v25 (pointer, possibly jbyteArray)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                System.out.println(&quot;md5 Parameters: jarray=0x&quot; + Long.toHexString(jarray) +</span></span><br><span class="line"><span class="comment">//                        &quot;, initial_len=&quot; + initial_len +</span></span><br><span class="line"><span class="comment">//                        &quot;, v25=0x&quot; + Long.toHexString(v25));</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Parse input jbyteArray</span></span><br><span class="line"><span class="comment">//                if (jarray != 0) &#123;</span></span><br><span class="line"><span class="comment">//                    ByteArray byteArray = (ByteArray) vm.getObject((int) jarray);</span></span><br><span class="line"><span class="comment">//                    if (byteArray != null) &#123;</span></span><br><span class="line"><span class="comment">//                        Inspector.inspect(byteArray.getValue(), &quot;Input jbyteArray&quot;);</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Parse v25 (assuming it&#x27;s a pointer to output buffer)</span></span><br><span class="line"><span class="comment">//                if (v25 != 0) &#123;</span></span><br><span class="line"><span class="comment">//                    Pointer cipherText = context.getPointerArg(2);</span></span><br><span class="line"><span class="comment">//                    Inspector.inspect(cipherText.getByteArray(0, 32), &quot;cipherText&quot;);</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Continue execution, return false to stop at breakpoint for manual debugging</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        debugger.addBreakPoint(module.base + 0x1AB92, new BreakPointCallback() &#123;</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public boolean onHit(Emulator&lt;?&gt; emulator, long address) &#123;</span></span><br><span class="line"><span class="comment">//                System.out.println(&quot;Breakpoint hit: END at 0x&quot; + Long.toHexString(address));</span></span><br><span class="line"><span class="comment">//                return true;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        // Hook doMD5sign function at 0x14D54: doMD5sign(v41, initial_len + 20, &amp;v53)</span></span><br><span class="line"><span class="comment">//        debugger.addBreakPoint(module.base + 0x14D54, new BreakPointCallback() &#123;</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public boolean onHit(Emulator&lt;?&gt; emulator, long address) &#123;</span></span><br><span class="line"><span class="comment">//                System.out.println(&quot;Breakpoint hit: doMD5sign at 0x&quot; + Long.toHexString(address));</span></span><br><span class="line"><span class="comment">//                RegisterContext context = emulator.getContext();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Parameters: ARM32 registers R0-R2</span></span><br><span class="line"><span class="comment">//                long v41 = context.getLongArg(0); // R0: v41 (possibly jbyteArray)</span></span><br><span class="line"><span class="comment">//                long len = context.getLongArg(1); // R1: initial_len + 20 (jint)</span></span><br><span class="line"><span class="comment">//                long v53 = context.getLongArg(2); // R2: &amp;v53 (pointer to output buffer)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                System.out.println(&quot;doMD5sign Parameters: v41=0x&quot; + Long.toHexString(v41) +</span></span><br><span class="line"><span class="comment">//                        &quot;, len=&quot; + len +</span></span><br><span class="line"><span class="comment">//                        &quot;, v53=0x&quot; + Long.toHexString(v53));</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Parse v41 (assuming it&#x27;s a jbyteArray)</span></span><br><span class="line"><span class="comment">//                if (v41 != 0) &#123;</span></span><br><span class="line"><span class="comment">//                    ByteArray byteArray = (ByteArray) vm.getObject((int) v41);</span></span><br><span class="line"><span class="comment">//                    if (byteArray != null) &#123;</span></span><br><span class="line"><span class="comment">//                        Inspector.inspect(byteArray.getValue(), &quot;Input v41 (jbyteArray)&quot;);</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Parse v53 (output buffer)</span></span><br><span class="line"><span class="comment">//                if (v53 != 0) &#123;</span></span><br><span class="line"><span class="comment">//                    Pointer cipherText = context.getPointerArg(2);</span></span><br><span class="line"><span class="comment">//                    Inspector.inspect(cipherText.getByteArray(0, 32), &quot;cipherText&quot;);</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Continue execution</span></span><br><span class="line"><span class="comment">//                return true;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        // Add return hook using CodeHook to capture return value</span></span><br><span class="line"><span class="comment">//        emulator.getBackend().hook_add_new(new com.github.unidbg.hook.HookListener() &#123;</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public void hook(unicorn.Unicorn u, long address, int size, Object user) &#123;</span></span><br><span class="line"><span class="comment">//                // Not used for entry hook in this case</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public void onReturn(unicorn.Unicorn u, long address, int size, Object user) &#123;</span></span><br><span class="line"><span class="comment">//                if (address == module.base + 0x13E3C) &#123;</span></span><br><span class="line"><span class="comment">//                    long retValue = u.reg_read(ArmConst.UC_ARM_REG_R0).longValue();</span></span><br><span class="line"><span class="comment">//                    System.out.println(&quot;md5 returned: 0x&quot; + Long.toHexString(retValue));</span></span><br><span class="line"><span class="comment">//                    if (retValue != 0) &#123;</span></span><br><span class="line"><span class="comment">//                        ByteArray retByteArray = (ByteArray) vm.getObject((int) retValue);</span></span><br><span class="line"><span class="comment">//                        if (retByteArray != null) &#123;</span></span><br><span class="line"><span class="comment">//                            Inspector.inspect(retByteArray.getValue(), &quot;md5 return jbyteArray&quot;);</span></span><br><span class="line"><span class="comment">//                        &#125;</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                &#125; else if (address == module.base + 0x14D54) &#123;</span></span><br><span class="line"><span class="comment">//                    long retValue = u.reg_read(ArmConst.UC_ARM_REG_R0).longValue();</span></span><br><span class="line"><span class="comment">//                    System.out.println(&quot;doMD5sign returned: 0x&quot; + Long.toHexString(retValue));</span></span><br><span class="line"><span class="comment">//                    if (retValue != 0) &#123;</span></span><br><span class="line"><span class="comment">//                        ByteArray retByteArray = (ByteArray) vm.getObject((int) retValue);</span></span><br><span class="line"><span class="comment">//                        if (retByteArray != null) &#123;</span></span><br><span class="line"><span class="comment">//                            Inspector.inspect(retByteArray.getValue(), &quot;doMD5sign return jbyteArray&quot;);</span></span><br><span class="line"><span class="comment">//                        &#125;</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;, module.base + 0x13E3C, module.base + 0x14D54, null);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">call_md5</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Object&gt; args = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">        args.add(vm.getJNIEnv());</span><br><span class="line">        args.add(<span class="number">0</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">my_bytes</span> <span class="operator">=</span> <span class="string">&quot;cid=1;uid=1;q=1;&quot;</span>;</span><br><span class="line">        args.add(vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, my_bytes.getBytes())));</span><br><span class="line">        args.add(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Number</span> <span class="variable">retNum</span> <span class="operator">=</span> <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x1a981</span>, args.toArray());</span><br><span class="line">        <span class="type">ByteArray</span> <span class="variable">retByteArr</span> <span class="operator">=</span> (ByteArray) vm.getObject(retNum.intValue());</span><br><span class="line">        <span class="type">String</span> <span class="variable">md5result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(retByteArr.getValue(), StandardCharsets.UTF_8);</span><br><span class="line">        System.out.println(<span class="string">&quot;md5 result = &quot;</span> + md5result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">call_hooked_function</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Object&gt; args = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">        args.add(vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, <span class="string">&quot;test_hook&quot;</span>.getBytes())));</span><br><span class="line">        args.add(<span class="number">16</span>); <span class="comment">// initial_len</span></span><br><span class="line">        args.add(vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">32</span>]))); <span class="comment">// v25: empty buffer</span></span><br><span class="line">        <span class="type">Number</span> <span class="variable">retNum</span> <span class="operator">=</span> <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x13E3C</span>, args.toArray());</span><br><span class="line">        <span class="type">ByteArray</span> <span class="variable">retByteArr</span> <span class="operator">=</span> (ByteArray) vm.getObject(retNum.intValue());</span><br><span class="line">        <span class="keyword">if</span> (retByteArr != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(retByteArr.getValue(), StandardCharsets.UTF_8);</span><br><span class="line">            System.out.println(<span class="string">&quot;md5 function result = &quot;</span> + result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    private void call_doMD5sign() &#123;</span></span><br><span class="line"><span class="comment">//        List&lt;Object&gt; args = new ArrayList&lt;&gt;(10);</span></span><br><span class="line"><span class="comment">//        args.add(vm.addLocalObject(new ByteArray(vm, &quot;test_doMD5sign&quot;.getBytes())));</span></span><br><span class="line"><span class="comment">//        args.add(34); // initial_len + 20</span></span><br><span class="line"><span class="comment">//        args.add(vm.addLocalObject(new ByteArray(vm, new byte[32]))); // v53: empty buffer</span></span><br><span class="line"><span class="comment">//        Number retNum = module.callFunction(emulator, 0x14D54, args.toArray());</span></span><br><span class="line"><span class="comment">//        ByteArray retByteArr = (ByteArray) vm.getObject(retNum.intValue());</span></span><br><span class="line"><span class="comment">//        if (retByteArr != null) &#123;</span></span><br><span class="line"><span class="comment">//            String result = new String(retByteArr.getValue(), StandardCharsets.UTF_8);</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;doMD5sign function result = &quot; + result);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        emulator.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">CryptoHelper</span> <span class="variable">cryptoHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CryptoHelper</span>();</span><br><span class="line">        cryptoHelper.md5_hook();</span><br><span class="line">        cryptoHelper.call_md5();</span><br><span class="line"><span class="comment">//        cryptoHelper.call_hooked_function();</span></span><br><span class="line"><span class="comment">//        cryptoHelper.call_doMD5sign();</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cryptoHelper.destroy();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，上述关于断点处的代码，return true（或者是false）代表着是否要动调，false代表着要动调，Unidbg会模拟程序执行到那，然后停住（有点类似于gdb），等待用户输入指令。</p>
<p>根据之前的分析，我们知道，md5_crypt对应的native层函数是 <strong>android_native_md5</strong>。</p>
<p>根据对这个函数的分析，会发现传入的“cid&#x3D;1;uid&#x3D;1;q&#x3D;1”（unidbg中固定了输入值）最终会传入函数 <strong>doMD5sign</strong>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520222934333.png" alt="image-20250520222934333"></p>
<p>根据动调，比较java层得到的返回值和doMD5sign在函数退出时，digest指向的值，两者是一样的，因此这里的digest就是我们要的 <strong>android_native_md5</strong> 最后的返回值。不过注意，我们固定输入的initial_msg后，标准的md5返回值和digest里面的值是不一样的，这说明魔改了。</p>
<p>在doMD5sign中，可以发现还有个函数叫md5，对这个函数进行hook（frida用不了，用unidbg的hook），在函数执行前，打印寄存器r0、r1、r2的值（r2指向一块buf），然后在md5执行完后，查看buf的内容。</p>
<p>会发现，这个buf的内容是标准的md5结果。</p>
<p>操作如下——</p>
<p>固定输入。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520223622766.png" alt="image-20250520223622766"></p>
<p>下断点。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520223708127.png" alt="image-20250520223708127" style="zoom:67%;" />

<p>r0 &#x3D; 0x12248000，r1 &#x3D; 36，r2 &#x3D; 0xe4fff5d8。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520223800781.png" alt="image-20250520223800781"></p>
<p>查看r0指向的字符串，会发现除了固定的输入，还加了IV，因此r1是36，而非我们固定输入的长度。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520223851080.png" alt="image-20250520223851080" style="zoom:80%;" />

<p>当前的mr2。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520223934899.png" alt="image-20250520223934899"></p>
<p>给0x12014d72下断点，然后按c执行，继续跑。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520224006870.png" alt="image-20250520224006870"></p>
<p>此时程序跑完了md5，再来看看buf里的内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520224201817.png" alt="image-20250520224201817" style="zoom:80%;" />

<p>这里的9eed….正是标准的md5结果。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520224251421.png" alt="image-20250520224251421" style="zoom:80%;" />

<p>接下来就是看doMD5sign是如何魔改的，魔改的主要逻辑在 <strong>bytesToInt</strong>。按顺序，每次操作md5结果的4个字节，将每个字节都放大了好多，然后最终通过<strong>或</strong>操作，组成一个<strong>很大的数字</strong>，由于是signed int类型，有可能是负数，一旦是负数，就取绝对值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520224616556.png" alt="image-20250520224616556"></p>
<p>然后将取过绝对值的这个<strong>很大的数字</strong>化作字符串，存入缓冲区。——这里的byte_E0021指向字符串%d，可以在解密后的so文件看出来。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520224720896.png" alt="image-20250520224720896" style="zoom:67%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520224859525.png" alt="image-20250520224859525"></p>
<p>既然知道算法了，接下来就写个python脚本复现一下，这里踩了个坑，python的整型是很大的，因此一般不会出现负数，而c&#x2F;c++中，32位的数若是很大，可能会溢出成负数，所以这里需要根据0x8000 0000判断当前得到的整型若是化成32位，是否是负数，若是，则转成正数，即减去0x1 0000 0000。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bytesToInt</span>(<span class="params">src, offset</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(src) &lt; offset + <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Source array too short for offset <span class="subst">&#123;offset&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> v9_unsigned &gt;= <span class="number">0x80000000</span>: <span class="comment"># 检查是否是负数（在C语言中）</span></span><br><span class="line">        v9_signed = v9_unsigned - <span class="number">0x100000000</span> <span class="comment"># 转换为正确的补码负值</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        v9_signed = v9_unsigned</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> v9_signed</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">doMD5sign</span>(<span class="params">initial_msg</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Calculate MD5 hash (16 bytes)</span></span><br><span class="line">    md5_hash = hashlib.md5(initial_msg).digest()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Process 4 blocks (offsets 0, 4, 8, 12)</span></span><br><span class="line">    offsets = [<span class="number">0</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">12</span>]</span><br><span class="line">    strings = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> offset <span class="keyword">in</span> offsets:</span><br><span class="line">        raw_int_value = bytesToInt(md5_hash, offset) <span class="comment"># 获取有符号的整数值</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 按照IDA伪代码的逻辑，在转为字符串前取绝对值</span></span><br><span class="line">        <span class="comment"># 对应IDA伪代码中的 &#x27;if ( vX &lt; 0 ) vY = -vX;&#x27;</span></span><br><span class="line">        abs_value = <span class="built_in">abs</span>(raw_int_value) </span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 将绝对值转换为字符串</span></span><br><span class="line">        strings.append(<span class="built_in">str</span>(abs_value))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Offset <span class="subst">&#123;offset&#125;</span>: raw_int_value = <span class="subst">&#123;raw_int_value&#125;</span>, abs_value = <span class="subst">&#123;abs_value&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Concatenate strings</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span>.join(strings)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Simulate malloc and qmemcpy</span></span><br><span class="line">    digest = result</span><br><span class="line">    length = <span class="built_in">len</span>(digest)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Final digest: <span class="subst">&#123;digest&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Length: <span class="subst">&#123;length&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> length, digest</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    initial_msg = <span class="string">b&quot;cid=1;uid=1;q=1;dJLdCJiVnDvM9JUpsom9&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        length, digest = doMD5sign(initial_msg)</span><br><span class="line">    <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>脚本跑完的结果如下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520225434327.png" alt="image-20250520225434327" style="zoom:80%;" />

<p>而Unidbg模拟的结果如下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520225455464.png" alt="image-20250520225455464" style="zoom:80%;" />

<p>至此，sign分析结束了。</p>
<p>ps：unidbg之前没怎么用过，这个动调、断点还挺好用的，之后整理一套使用手册。</p>
<h3 id="q"><a href="#q" class="headerlink" title="q"></a>q</h3><p>用之前写的hook HashMap的脚本，试试能不能找到q的加密点。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">call_HashMap</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> hashMap = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.util.HashMap&quot;</span>);</span><br><span class="line">        hashMap.<span class="property">put</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (a != <span class="literal">null</span> &amp;&amp; a.<span class="title function_">equals</span>(<span class="string">&quot;q&quot;</span>)) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()))</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hashMap.put: &quot;</span>, a, b);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">put</span>(a, b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看来跟sign一样，都是这么存储字段的。</p>
<p>注意到，字段q的最后一个字节是&#x3D;，那很有可能是base64（猜测，base64没有_和-）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520230417092.png" alt="image-20250520230417092"></p>
<p>先从com.lucky.lib.http2.r.a看起，又是这个函数，需要追踪str3的值从何而来。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521095921734.png" alt="image-20250521095921734" style="zoom: 67%;" />

<p>写个脚本hook getRequestParams，并且hook AbstractC3710a.toJSONString，打印一下这个q2字符串的内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521102012343.png" alt="image-20250521102012343" style="zoom:80%;" />

<p>这个类是之后加载的，需要加载之后再hook。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521102914062.png" alt="image-20250521102914062"></p>
<p>打印的内容有些多。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521103024248.png" alt="image-20250521103024248"></p>
<p>然后将内容传入方法 <strong>C9247c.m20436b</strong>，再传入 <strong>f237976b.m20089c</strong>。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521104203303.png" alt="image-20250521104203303" style="zoom:80%;" />

<p>在 <strong>f237976b.m20089c</strong> 中，走localAESWork4Api(str.getBytes(), 0)。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521104819109.png" alt="image-20250521104819109"></p>
<p>localAESWork4Api是CryptoHelper中的JNI函数，也注册在libcryptoDD.so。</p>
<p>根据符号名，可以看出来是aes白盒加密。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521105621185.png" alt="image-20250521105621185"></p>
<p>在 <strong>android_native_wbaes_jni</strong> 中，可以找到函数 <strong>wbaes_decrypt_ecb</strong>，说明是aes的ecb模式加密，ecb模式没有IV。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521115216953.png" alt="image-20250521115216953" style="zoom:67%;" />

<p>虚假控制流有点多，要不直接trace算了？再等等好了。</p>
<p>本次逆向的主要目标，就是掌握AES加密及白盒AES的破解方法之一——DFA。</p>
<p>先根据这篇博客回顾一下，AES加密的流程。</p>
<p><a target="_blank" rel="noopener" href="https://xiaoeeyu.github.io/2024/02/29/%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81-AES/">https://xiaoeeyu.github.io/2024/02/29/%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81-AES/</a></p>
<p>以AES128为例，原理简单来说，如下。</p>
<p>​	<strong>输入</strong>：128位明文 + 128位密钥。</p>
<p>​	<strong>密钥扩展</strong>：生成11个128位（4x4字节）轮密钥。</p>
<p>​	<strong>初始轮</strong>：明文与第一个轮密钥异或。</p>
<p>​	<strong>普通轮</strong>：执行9轮（SubBytes（查表替换） → ShiftRows（字节循环左移） → MixColumns（列混合，矩阵乘法） → AddRoundKey（密钥异或））。</p>
<p>​	<strong>最终轮</strong>：执行1轮（SubBytes（查表替换） → ShiftRows（字节循环左移） → AddRoundKey（密钥异或））。</p>
<p>​	<strong>输出</strong>：128位密文。</p>
<p>其中，查表替换的S盒是固定的，而且只有一个，通过脚本，搜索S盒的特征就可以找到了。</p>
<p>交叉引用SBox。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521130346431.png" alt="image-20250521130346431"></p>
<p>有2个函数调用了SBox。</p>
<p>sub_63A0，很明显的SubBytes特征。</p>
<p>*result &#x3D; *((_BYTE *)RijnDael_AES_LONG_SBox + (*result &amp; 0xF0) + (*result &amp; 0xF))</p>
<p>等同于：result[i] &#x3D; SBox[result[i]]。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521130953155.png" alt="image-20250521130953155"></p>
<p>还有一处是sub_5C58，这个特征不太明显阿。有点像SubBytes，又有点像移位操作。</p>
<p>这毕竟不是标准AES，属于白盒AE，拿到了代码也不知道密钥在哪。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_5C58</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (*((<span class="type">unsigned</span> __int8 *)&amp;RijnDael_AES_LONG_SBox[<span class="number">4</span> * ((a1 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xF000000F</span>)] + (a1 &amp; <span class="number">0xF</span>)) | (*((<span class="type">unsigned</span> __int8 *)RijnDael_AES_LONG_SBox + ((a1 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xF0</span>) + ((a1 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF00000F</span>)) &lt;&lt; <span class="number">8</span>) | (*((<span class="type">unsigned</span> __int8 *)&amp;RijnDael_AES_LONG_SBox[<span class="number">4</span> * ((a1 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xFFFFF00F</span>)] + (HIWORD(a1) &amp; <span class="number">0xFFFF000F</span>)) &lt;&lt; <span class="number">16</span>)) ^ (*((<span class="type">unsigned</span> __int8 *)RijnDael_AES_LONG_SBox + (HIBYTE(a1) &amp; <span class="number">0xF0</span>) + (HIBYTE(a1) &amp; <span class="number">0xF</span>)) &lt;&lt; <span class="number">24</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，学习其它的博客，试试如何获得白盒AES的密钥，下面这个文章把DFA原理讲得很明白。</p>
<p><a target="_blank" rel="noopener" href="https://blog.quarkslab.com/differential-fault-analysis-on-white-box-aes-implementations.html">https://blog.quarkslab.com/differential-fault-analysis-on-white-box-aes-implementations.html</a></p>
<p>总结一下我的理解：</p>
<p>找到第8轮列混淆之后、第9轮列混淆之前（第十轮没有列混淆），然后修改1个字节（比特翻转，或者多修改点），这个修改的影响会被第9轮列混淆进行扩大，扩大到最终影响了输出的4个字节。</p>
<p>根据数学关系，可以列4个等式。</p>
<p>O和O’都是已知的，Z代表S-盒输入的差（A+X，即A异或X），根据对Y的假设，可以找到可能满足4个等式的Y0、Y1、Y2、Y3的候选者。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521154218635.png" alt="image-20250521154218635" style="zoom:80%;" />

<p>再通过Y的候选者和已知的O，去获得可能的K（轮密钥的某个字节）的候选者。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521154520520.png" alt="image-20250521154520520" style="zoom:80%;" />

<p>搞清楚DFA的原理以后，第一步，找到第8轮列混淆之后、第9轮列混淆之前进行故障注入。</p>
<p>回到 <strong>android_native_wbaes</strong>，看看有没有什么特征函数。——找到了一个行位移的函数。为了确保它是我们要找的行位移函数，试试它有没有执行10次，并且打印v42的内容，判断是否每次都有行位移的操作。</p>
<p>通过Unidbg完成上述的操作。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521160530312.png" alt="image-20250521160530312" style="zoom:80%;" />

<p>下述是代码片段，num是我添加的成员变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">call_aes</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Object&gt; args = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// JNIEnv*</span></span><br><span class="line">        args.add(vm.getJNIEnv());</span><br><span class="line">        <span class="comment">// jclass</span></span><br><span class="line">        args.add(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 固定输入</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">my_bytes</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;type\&quot;:1&#125;&quot;</span>;</span><br><span class="line">        args.add(vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, my_bytes.getBytes())));</span><br><span class="line">        <span class="comment">// 模式</span></span><br><span class="line">        args.add(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 函数android_native_wbaes的偏移量0x1b1cd</span></span><br><span class="line">        <span class="type">Number</span> <span class="variable">retNum</span> <span class="operator">=</span> <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x1b1cd</span>, args.toArray());</span><br><span class="line">        <span class="type">ByteArray</span> <span class="variable">retByteArr</span> <span class="operator">=</span> (ByteArray) vm.getObject(retNum.intValue());</span><br><span class="line">        <span class="comment">// 打印</span></span><br><span class="line">        <span class="type">byte</span>[] resultBytes = retByteArr.getValue();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">hexString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : resultBytes) &#123;</span><br><span class="line">            hexString.append(String.format(<span class="string">&quot;%02X&quot;</span>, b &amp; <span class="number">0xFF</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;q result (hex) = &quot;</span> + hexString.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">q_hook</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Debugger</span> <span class="variable">debugger</span> <span class="operator">=</span> emulator.attach();</span><br><span class="line">        <span class="comment">// Hook wbShiftRows function at 0x14F98</span></span><br><span class="line">        debugger.addBreakPoint(<span class="keyword">module</span>.base + <span class="number">0x14F98</span>, <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line">                num += <span class="number">1</span>;</span><br><span class="line">                System.out.println(<span class="string">&quot;wbShiftRows has been called: &quot;</span> + num);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，打印了10次，符合我们的预期。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521163609731.png" alt="image-20250521163609731" style="zoom:80%;" />

<p>尝试打印每一次执行行位移之前的状态矩阵。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">q_hook</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Debugger</span> <span class="variable">debugger</span> <span class="operator">=</span> emulator.attach();</span><br><span class="line">        <span class="comment">// Hook wbShiftRows function at 0x14F98</span></span><br><span class="line">        debugger.addBreakPoint(<span class="keyword">module</span>.base + <span class="number">0x14F98</span>, <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line">                num += <span class="number">1</span>;</span><br><span class="line">                System.out.println(<span class="string">&quot;wbShiftRows has been called: &quot;</span> + num);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取寄存器上下文</span></span><br><span class="line">                <span class="type">RegisterContext</span> <span class="variable">context</span> <span class="operator">=</span> emulator.getContext();</span><br><span class="line">                <span class="comment">// R0 通常是第一个参数（状态矩阵的指针）</span></span><br><span class="line">                <span class="type">Pointer</span> <span class="variable">stateMatrix</span> <span class="operator">=</span> context.getPointerArg(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (stateMatrix != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 读取 16 字节状态矩阵</span></span><br><span class="line">                    <span class="type">byte</span>[] stateBytes = stateMatrix.getByteArray(<span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">                    <span class="comment">// 转为十六进制</span></span><br><span class="line">                    <span class="type">StringBuilder</span> <span class="variable">hexString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">byte</span> b : stateBytes) &#123;</span><br><span class="line">                        hexString.append(String.format(<span class="string">&quot;%02X &quot;</span>, b &amp; <span class="number">0xFF</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(<span class="string">&quot;wbShiftRows state matrix (hex): &quot;</span> + hexString.toString());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 继续执行</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521163920393.png" alt="image-20250521163920393" style="zoom:80%;" />

<p>下面是q正常情况下的结果。——2FF0E1B44B413D51A083E55259E2179F</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521165448510.png" alt="image-20250521165448510" style="zoom:80%;" />

<p>修改第9次行位移的某个字节，收集10次差分故障攻击的结果。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521165638163.png" alt="image-20250521165638163"></p>
<p>收集了16个错误的结果。</p>
<p>2F1BE1B4E6413D51A083E56059E21A9F</p>
<p>2FF0E1A84B41C451A0B1E55215E2179F</p>
<p>E7F0E1B44B413DE3A0837A525924179F</p>
<p>2FF0A8B44B2F3D511A83E55259E217C6</p>
<p>DCF0E1B44B413DBEA08316525911179F</p>
<p>2F68E1B436413D51A083E5CF59E2769F</p>
<p>96F0E1B44B413DACA083AB5259EA179F</p>
<p>89F0E1B44B413DE7A0831C525944179F</p>
<p>42F0E1B44B413D1CA083D9525974179F</p>
<p>2FF07FB44B6E3D514683E55259E21747</p>
<p>17F0E1B44B413D6CA0838A5259F3179F</p>
<p>2FF069B44BAA3D510283E55259E21754</p>
<p>D8F0E1B44B413D36A0834452590B179F</p>
<p>8AF0E1B44B413D27A0839752591E179F</p>
<p>24F0E1B44B413DB1A0839C5259E9179F</p>
<p>2FF0E16A4B414151A0A4E55293E2179F</p>
<p>接下来使用大佬写的攻击，通过差分结果、正常结果，还原轮密钥，项目地址：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/SideChannelMarvels/JeanGrey/tree/master/phoenixAES">https://github.com/SideChannelMarvels/JeanGrey/tree/master/phoenixAES</a></p>
<p>编写脚本得到第10轮子密钥。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> phoenixAES</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;tracefile&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> t:</span><br><span class="line">    t.write(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    2FF0E1B44B413D51A083E55259E2179F</span></span><br><span class="line"><span class="string">    2F1BE1B4E6413D51A083E56059E21A9F</span></span><br><span class="line"><span class="string">    2FF0E1A84B41C451A0B1E55215E2179F</span></span><br><span class="line"><span class="string">    E7F0E1B44B413DE3A0837A525924179F</span></span><br><span class="line"><span class="string">    2FF0A8B44B2F3D511A83E55259E217C6</span></span><br><span class="line"><span class="string">    DCF0E1B44B413DBEA08316525911179F</span></span><br><span class="line"><span class="string">    2F68E1B436413D51A083E5CF59E2769F</span></span><br><span class="line"><span class="string">    96F0E1B44B413DACA083AB5259EA179F</span></span><br><span class="line"><span class="string">    89F0E1B44B413DE7A0831C525944179F</span></span><br><span class="line"><span class="string">    42F0E1B44B413D1CA083D9525974179F</span></span><br><span class="line"><span class="string">    2FF07FB44B6E3D514683E55259E21747</span></span><br><span class="line"><span class="string">    17F0E1B44B413D6CA0838A5259F3179F</span></span><br><span class="line"><span class="string">    2FF069B44BAA3D510283E55259E21754</span></span><br><span class="line"><span class="string">    D8F0E1B44B413D36A0834452590B179F</span></span><br><span class="line"><span class="string">    8AF0E1B44B413D27A0839752591E179F</span></span><br><span class="line"><span class="string">    24F0E1B44B413DB1A0839C5259E9179F</span></span><br><span class="line"><span class="string">    2FF0E16A4B414151A0A4E55293E2179F</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.encode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">phoenixAES.crack_file(<span class="string">&#x27;tracefile&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>结果是：869D92BBB700D0D25BD9FD3E224B5DF2。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521170559877.png" alt="image-20250521170559877" style="zoom:80%;" />

<p>再用另一个大佬，从轮密钥还原原密钥。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/SideChannelMarvels/Stark">https://github.com/SideChannelMarvels/Stark</a></p>
<p>需要自己编译源代码，编译完后，还原原密钥！</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521181924901.png" alt="image-20250521181924901" style="zoom:80%;" />

<p>至此，成功把密钥DFA出来了，下面这个结果和Unidbg模拟的一模一样。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521182009136.png" alt="image-20250521182009136" style="zoom: 67%;" />

<h1 id="心得体会"><a href="#心得体会" class="headerlink" title="心得体会"></a>心得体会</h1><p>以下是我从这次分析中，认为自己需要加强的点：</p>
<p>1.学习绕过反调；（分析壳）</p>
<p>2.学习Unidbg的用法，包括hook、补环境、补系统调用等操作；（读相关博客等）</p>
<p>3.利用符号执行，去除控制流平坦化；</p>
<p>4.学习Binary ninja。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/19/%E5%AE%9E%E7%8E%B0%E5%AF%B9%E7%9B%AE%E6%A0%87%E5%87%BD%E6%95%B0%E8%A1%8C%E4%B8%BA%E5%88%86%E6%9E%90%E7%9A%84%E8%84%9A%E6%9C%AC%EF%BC%88frida%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/19/%E5%AE%9E%E7%8E%B0%E5%AF%B9%E7%9B%AE%E6%A0%87%E5%87%BD%E6%95%B0%E8%A1%8C%E4%B8%BA%E5%88%86%E6%9E%90%E7%9A%84%E8%84%9A%E6%9C%AC%EF%BC%88frida%EF%BC%89/" class="post-title-link" itemprop="url">实现对目标函数行为分析的脚本（frida）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-19 14:52:10 / 修改时间：14:53:47" itemprop="dateCreated datePublished" datetime="2025-05-19T14:52:10+08:00">2025-05-19</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>852</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Frida-BehaviorTrace"><a href="#Frida-BehaviorTrace" class="headerlink" title="Frida_BehaviorTrace"></a>Frida_BehaviorTrace</h1><p>场景：在native层遇到一个特别复杂的函数时，比方说被vmp保护的函数，若是难以通过静态分析工具去分析它的逻辑，那可以尝试hook一些libc的函数、JNI的函数观察它的行为。ps：这个脚本就做了这么一个事情。</p>
<h1 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h1><p>1.根据自己的需求，修改hook时机，当前脚本的hook时机是：linker64的call_constructor执行前。</p>
<p>2.选定完hook时机后，调用hook_main_target_function_for_tracing()。ps：我之所以选择在执行完sub_88060再执行，是因为sub_88060会对某些函数进行解密，请大家自行修改。</p>
<p>3.修改目标so和目标函数————修改TARGET_MODULE_NAME和TARGET_FUNCTION_OFFSET。</p>
<p>4.添加要关注的自定义函数的偏移————往CUSTOM_FUNCTION_OFFSETS添加想要关注的自定义函数。</p>
<p>5.添加要关注的libc的函数，修改参数解析的代码————往LIBC_FUNCTIONS_TO_HOOK添加要关注的libc函数，同时修改参数解析。</p>
<p>6.添加要关注的JNI函数，修改参数解析部分的代码———往函数hook_libart()中添加要关注的JNI函数，同样，注意修改参数解析。</p>
<p>7.启动脚本————frida -U -f &lt;包名&gt; -l trace_behavior.js</p>
<h1 id="使用案例"><a href="#使用案例" class="headerlink" title="使用案例"></a>使用案例</h1><p>比方说，我要追踪libbaiduprotect.so的sub_409E0，追踪它的行为。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519141642616.png" alt="image-20250519141642616"></p>
<p>sub_409E0调用了sub_29030、sub_290DC…还调用了一些JNI函数。</p>
<p>在我根据使用方法修改了脚本后，执行的效果是这样的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519142250215.png" alt="image-20250519142250215"></p>
<p><strong>缩进</strong>代表函数调用的<strong>层级关系</strong>，这样子可以清晰看见目标函数执行了哪些<strong>自定义函数、Libc、JNI函数</strong>。</p>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>链接：<a target="_blank" rel="noopener" href="https://github.com/X14Nuy/Frida_BehaviorTrace">https://github.com/X14Nuy/Frida_BehaviorTrace</a></p>
<p>大模型真厉害，一下子把我的思路变成代码了，哈哈哈。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/unidbg%E5%88%9D%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/unidbg%E5%88%9D%E8%AF%86/" class="post-title-link" itemprop="url">unidbg初识</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:26:53 / 修改时间：17:31:41" itemprop="dateCreated datePublished" datetime="2025-05-18T17:26:53+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>18 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Frida和Unidbg最大的区别是，Unidbg是模拟程序执行，所以可以绕过检测，而Frida面临众多检测，需要学会反检测。</p>
<p>其实在理解了Unidbg的原理之后，它还蛮简单的。</p>
<h1 id="模拟层级"><a href="#模拟层级" class="headerlink" title="模拟层级"></a>模拟层级</h1><p>Unicorn模拟了底层cpu指令模拟，相当于一台裸机。当native代码调用到系统调用的指令（如x86的syscall、arch64的svc等），会将这些触发转发给AndroidEmulator进行处理。</p>
<p>AndroidEmulator主要负责<strong>模拟安卓环境和系统环境</strong>和<strong>JNI交互</strong>，除此之外，它还负责处理Unicorn转发而来的<strong>系统调用</strong>。</p>
<h1 id="补环境实例讲解"><a href="#补环境实例讲解" class="headerlink" title="补环境实例讲解"></a>补环境实例讲解</h1><p>可以观察下面的一个需要<strong>补环境</strong>的代码。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">example</span>.<span class="property">luodst</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">AndroidEmulator</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">LibraryResolver</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">Module</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">arm</span>.<span class="property">backend</span>.<span class="property">Unicorn2Factory</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">linux</span>.<span class="property">android</span>.<span class="property">AndroidEmulatorBuilder</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">linux</span>.<span class="property">android</span>.<span class="property">AndroidResolver</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">linux</span>.<span class="property">android</span>.<span class="property">dvm</span>.*;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">linux</span>.<span class="property">android</span>.<span class="property">dvm</span>.<span class="property">array</span>.<span class="property">ByteArray</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">memory</span>.<span class="property">Memory</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">virtualmodule</span>.<span class="property">android</span>.<span class="property">AndroidModule</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">File</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">IOException</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">UnsupportedEncodingException</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">sql</span>.<span class="property">SQLOutput</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">ArrayList</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">Enumeration</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">List</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">zip</span>.<span class="property">ZipEntry</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">zip</span>.<span class="property">ZipFile</span>;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_ inherited__">AbstractJni</span> &#123;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="params"><span class="built_in">String</span>[] args</span>) &#123;</span><br><span class="line">        <span class="title class_">MainActivity</span> mainActivity = <span class="keyword">new</span> <span class="title class_">MainActivity</span>();</span><br><span class="line">        mainActivity.<span class="title function_">getHash</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 模拟器创建</span></span><br><span class="line">    private final <span class="title class_">AndroidEmulator</span> emulator;</span><br><span class="line">    <span class="comment">// 创建java虚拟机</span></span><br><span class="line">	private final <span class="variable constant_">VM</span> vm;</span><br><span class="line"></span><br><span class="line">    private final <span class="title class_">Module</span> <span class="variable language_">module</span>;</span><br><span class="line"></span><br><span class="line">    private <span class="title class_">MainActivity</span>() &#123;</span><br><span class="line">        <span class="comment">//1.创建Android模拟器实例</span></span><br><span class="line">        emulator = <span class="title class_">AndroidEmulatorBuilder</span></span><br><span class="line">                .<span class="title function_">for32Bit</span>() <span class="comment">// 32位虚拟机</span></span><br><span class="line">                .<span class="title function_">addBackendFactory</span>(<span class="keyword">new</span> <span class="title class_">Unicorn2Factory</span>(<span class="literal">true</span>)) <span class="comment">// 选择指令集，相当于选择哪台裸机，默认是unicorn</span></span><br><span class="line">                .<span class="title function_">setRootDir</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/com/example/luodst/rootfs&quot;</span>)) <span class="comment">// 设置文件系统根目录</span></span><br><span class="line">                .<span class="title function_">build</span>(); <span class="comment">// 创建</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.获取操作内存的接口</span></span><br><span class="line">        <span class="title class_">Memory</span> memory = emulator.<span class="title function_">getMemory</span>();</span><br><span class="line">        <span class="comment">//3.设置Android SDK 版本</span></span><br><span class="line">        <span class="title class_">LibraryResolver</span> resolver = <span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>);</span><br><span class="line">        memory.<span class="title function_">setLibraryResolver</span>(resolver); <span class="comment">// 加载sdk里的java类（可能会添加hook）</span></span><br><span class="line">        <span class="comment">//4.创建java虚拟机，导入apk文件</span></span><br><span class="line">        vm = emulator.<span class="title function_">createDalvikVM</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/com/example/luodst/files/DogPro.apk&quot;</span>));</span><br><span class="line">        <span class="comment">//5.是否打印日志</span></span><br><span class="line">        vm.<span class="title function_">setVerbose</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//6.将自定义的JNI处理逻辑绑定到java虚拟机上</span></span><br><span class="line">        vm.<span class="title function_">setJni</span>(<span class="variable language_">this</span>);</span><br><span class="line">        <span class="comment">// 为java环境模拟器和java虚拟机注册内存</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AndroidModule</span>(emulator, vm).<span class="title function_">register</span>(memory);</span><br><span class="line">        <span class="comment">//7.加载目标so文件，true主动执行init init_array</span></span><br><span class="line">        <span class="title class_">DalvikModule</span> dm = vm.<span class="title function_">loadLibrary</span>(<span class="string">&quot;dogpro&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//8.将so文件对应的Module存入成员变量</span></span><br><span class="line">        <span class="variable language_">module</span> = dm.<span class="title function_">getModule</span>();</span><br><span class="line">        <span class="comment">//9.主动调用JNI_OnLoad</span></span><br><span class="line">        dm.<span class="title function_">callJNI_OnLoad</span>(emulator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="keyword">void</span> <span class="title function_">getHash</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">DvmObject</span>&lt;?&gt; dvmObject = vm.<span class="title function_">resolveClass</span>(<span class="string">&quot;com/example/dogpro/MainActivity&quot;</span>).<span class="title function_">newObject</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;dvmObject = &quot;</span>+ dvmObject.<span class="title function_">toString</span>());</span><br><span class="line">        <span class="title class_">String</span> input = <span class="string">&quot;unidbg-android/src/test/java/com/example/luodst/files/DogPro.apk&quot;</span>;</span><br><span class="line">        <span class="title class_">DvmObject</span>&lt;?&gt; ret = dvmObject.<span class="title function_">callJniMethodObject</span>(emulator, <span class="string">&quot;getHash(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, input);</span><br><span class="line">        <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;result ==&gt; &quot;</span>+ret.<span class="title function_">getValue</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以这么理解Unidbg补环境的过程，so文件作为elf二进制代码，可以在unicorn上面跑，但一些JNI函数，他们的参数列表需要JNI类型的数据，有时候甚至要调用一些Java层的函数（java层给native层数据时，数据类型是JNI类型），而Unidbg就是负责处理JNI交互的。</p>
<p>Unidbg有自己的一套JNI类型，其内置的Java虚拟机中还内置了很多自定义的<strong>基本类型、引用类型</strong>的数据结果，如：外部虚拟机中的String类型，在Unidbg中是StringObject类型；外部的int、boolean类型，是Unidbg中的DvmInteger和DvmBoolean；除此之外，大部分引用类型在Unidbg都视作DvmClass类型（继承于DvmObject&lt;?&gt;类型），这些引用类型的对象都属于DvmObject&lt;?&gt;类型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DvmObject&lt;?&gt;：这是 Unidbg 中所有 Java 对象的基类，类似于真实 JVM 中的 java.lang.Object。它是一个泛型类，DvmObject&lt;T&gt; 的 T 通常表示对应的真实 Java 类型。例如，DvmObject&lt;String&gt; 表示一个 String 类型的对象。</span><br><span class="line">DvmClass：表示 Java 中的类对象（java.lang.Class 的模拟）。在 Unidbg 中，DvmClass 继承自 DvmObject&lt;Class&lt;?&gt;&gt;，用来表示类的元信息（如类名、方法、字段等）。</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250320093443037.png" alt="image-20250320093443037"></p>
<p>一般情况下，不需要补环境，是因为unidbg的虚拟机中内置了很多DvmClass（解析于SDK），也内置了很多自己的处理函数，操作这些DvmObject&lt;?&gt;，但遇到一些尚未解析的DvmClass或者无法解析的DvmClass的函数，就会抛出错误，这个时候就需要为它补环境了。</p>
<p>补环境的过程如下，简单来说，就是内置的类与函数不够用了，转而使用外部java虚拟机的类与函数，只将结果转换成DvmObject&lt;?&gt;返回给内部虚拟机。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250320094827973.png" alt="image-20250320094827973" style="zoom: 67%;" />

<p>举个例子，下面这个报错是无法处理ZipFile的构造函数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250320093822376.png" alt="image-20250320093822376"></p>
<p>一直定位追踪到下面这个函数，会发现没有针对于ZipFile类型的构造函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; newObjectV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/io/ByteArrayInputStream-&gt;&lt;init&gt;([B)V&quot;</span>: &#123;</span><br><span class="line">            <span class="type">ByteArray</span> <span class="variable">array</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">assert</span> array != <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;java/io/ByteArrayInputStream&quot;</span>).newObject(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(array.value));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/lang/String-&gt;&lt;init&gt;([B)V&quot;</span>: &#123;</span><br><span class="line">            <span class="type">ByteArray</span> <span class="variable">array</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">assert</span> array != <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="keyword">new</span> <span class="title class_">String</span>(array.value));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/lang/String-&gt;&lt;init&gt;([BLjava/lang/String;)V&quot;</span>: &#123;</span><br><span class="line">            <span class="type">ByteArray</span> <span class="variable">array</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">assert</span> array != <span class="literal">null</span>;</span><br><span class="line">            <span class="type">StringObject</span> <span class="variable">charsetName</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">assert</span> charsetName != <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="keyword">new</span> <span class="title class_">String</span>(array.value, charsetName.value));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;javax/crypto/spec/SecretKeySpec-&gt;&lt;init&gt;([BLjava/lang/String;)V&quot;</span>:&#123;</span><br><span class="line">            <span class="type">byte</span>[] key = (<span class="type">byte</span>[]) vaList.getObjectArg(<span class="number">0</span>).value;</span><br><span class="line">            <span class="type">StringObject</span> <span class="variable">algorithm</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">assert</span> algorithm != <span class="literal">null</span>;</span><br><span class="line">            <span class="type">SecretKeySpec</span> <span class="variable">secretKeySpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(key, algorithm.value);</span><br><span class="line">            <span class="keyword">return</span> dvmClass.newObject(secretKeySpec);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/lang/Integer-&gt;&lt;init&gt;(I)V&quot;</span>: &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> vaList.getIntArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> DvmInteger.valueOf(vm, i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/lang/Boolean-&gt;&lt;init&gt;(Z)V&quot;</span>:&#123;</span><br><span class="line">            <span class="type">boolean</span> b;</span><br><span class="line">            b = vaList.getIntArg(<span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> DvmBoolean.valueOf(vm, b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(signature);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个时候就需要为它补环境了，如何补呢？这里的ZipFile并不是基本数据类型，在项目中也没有为它进行解析。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250320095402681.png" alt="image-20250320095402681" style="zoom:67%;" />

<p>因此需要将这个ZipFile类型解析到Unidbg的虚拟机中，再为它创建一个对象进行返回。</p>
<p>下面的代码中，vm.resolveClass负责解析ZipFile类，此时ZipFile类光荣的加入了Unidbg的虚拟机中，并重新定义为DvmObject&lt;ZipFile&gt;类，newObject返回了一个Unidbg内置的DvmObject&lt;ZipFile&gt;类对象。</p>
<p>这样便解解决了一个环境问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> DvmObject&lt;?&gt; newObjectV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;</span><br><span class="line">       <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;java/util/zip/ZipFile-&gt;&lt;init&gt;(Ljava/lang/String;)V&quot;</span>: &#123;</span><br><span class="line">               <span class="comment">// 正确提取 String 参数</span></span><br><span class="line">               <span class="type">StringObject</span> <span class="variable">pathObj</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>); <span class="comment">// 内部虚拟机的String</span></span><br><span class="line">               <span class="keyword">assert</span> pathObj != <span class="literal">null</span>;</span><br><span class="line">               <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> pathObj.getValue(); <span class="comment">// 获取实际java类型的String</span></span><br><span class="line"></span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="comment">// 创建虚拟的 ZipFile 对象（需提前在虚拟文件系统中补文件）</span></span><br><span class="line">                   <span class="type">ZipFile</span> <span class="variable">zipFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipFile</span>(filePath);</span><br><span class="line">                   <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;java/util/zip/ZipFile&quot;</span>).newObject(zipFile);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">super</span>.newObjectV(vm, dvmClass, signature, vaList);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>还有一个补环境的例子，下面是报错，报错理由是缺少ZipFile的entries操作。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.UnsupportedOperationException: java/util/zip/ZipFile-&gt;entries()Ljava/util/Enumeration;</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodV(DvmMethod.java:89)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.DalvikVM$32.handle(DalvikVM.java:553)</span><br></pre></td></tr></table></figure>

<p>一开始的补法是这样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/util/zip/ZipFile-&gt;entries()Ljava/util/Enumeration;&quot;</span>: &#123;</span><br><span class="line">            <span class="comment">//拿操作的对象</span></span><br><span class="line">            <span class="type">ZipFile</span> <span class="variable">zipFile</span> <span class="operator">=</span> (ZipFile) dvmObject.getValue();</span><br><span class="line">            <span class="comment">//通过对象来调用方法</span></span><br><span class="line">            Enumeration&lt;? <span class="keyword">extends</span> <span class="title class_">ZipEntry</span>&gt; entries =  zipFile.entries();</span><br><span class="line">            <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;java/util/Enumeration&quot;</span>).newObject(entries);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但之后仍会报错，提示无法将DvmObject转换为Enumeration，为什么会出现这个问题？其实DvmObject&lt;Enumeration&gt;是我们补的一个类，但Unidbg中内置了一个Enumeration类，这个类不应该补的，因为负责与与native层交互的内置虚拟机，它默认是转换内置的Enumeration &#x3D;&gt; JNI类型，而我们导入的这个类型会被忽视。</p>
<p>虽然如此，但return的这个对象很重要，这是我们通过外部虚拟机，要返回给内部虚拟机的一个Enumeration对象，如果我们返回的是它内置的com.github.unidbg.linux.android.dvm.Enumeration就没任何事，因为这是它缺少的对象，但我们返回的是com.github.unidbg.linux.android.dvm.DvmObject&lt;Enumeration&gt;，对象不一致，就要强转了，然后失败了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ClassCastException: class com.github.unidbg.linux.android.dvm.DvmObject cannot be cast to class com.github.unidbg.linux.android.dvm.Enumeration (com.github.unidbg.linux.android.dvm.DvmObject and com.github.unidbg.linux.android.dvm.Enumeration are in unnamed module of loader &#x27;app&#x27;)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:610)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:603)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.DvmMethod.callBooleanMethodV(DvmMethod.java:119)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.DalvikVM$35.handle(DalvikVM.java:630)</span><br></pre></td></tr></table></figure>

<p>我的分析得到了grok的认可，哈哈哈哈。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250320101751847.png" alt="image-20250320101751847"></p>
<p>既然这样补不对，就需要看内置的Enumeration是如何创建的，可以看到，内置的Enumeration实现的俩函数，不过这里不是重点，重点是如何创建一个Enumeration对象。</p>
<p>通过构造函数，可以看到，需要输入一个外部java中的List对象，对象里的元素是DvmObject对象即可。</p>
<p>因此，我们需要创建一个List，然后把ZipFile对象里元素的类型（即ZipEntry）转换成DvmObject&lt;ZipEntry&gt;，然后再放入List中。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250320101923116.png" alt="image-20250320101923116" style="zoom: 67%;" />

<p>这样就算补好了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/util/zip/ZipFile-&gt;entries()Ljava/util/Enumeration;&quot;</span>: &#123;</span><br><span class="line">            <span class="type">ZipFile</span> <span class="variable">zipFile</span> <span class="operator">=</span> (ZipFile) dvmObject.getValue();</span><br><span class="line">            Enumeration&lt;? <span class="keyword">extends</span> <span class="title class_">ZipEntry</span>&gt; entries =  zipFile.entries();</span><br><span class="line">            <span class="comment">//return vm.resolveClass(&quot;java/util/Enumeration&quot;).newObject(entries);</span></span><br><span class="line">            List&lt;DvmObject&lt;?&gt;&gt; objs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">while</span> (entries.hasMoreElements())&#123;</span><br><span class="line">                <span class="type">ZipEntry</span> <span class="variable">zipEntry</span> <span class="operator">=</span> entries.nextElement();</span><br><span class="line">                objs.add(vm.resolveClass(<span class="string">&quot;java/util/zip/ZipEntry&quot;</span>).newObject(zipEntry));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">com</span>.github.unidbg.linux.android.dvm.Enumeration(vm, objs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="追踪读写"><a href="#追踪读写" class="headerlink" title="追踪读写"></a>追踪读写</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 监控读写 */</span></span><br><span class="line">emulator.traceRead(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base + <span class="keyword">module</span>.size);</span><br><span class="line">emulator.traceWrite(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base + <span class="keyword">module</span>.size);</span><br></pre></td></tr></table></figure>

<h1 id="读取内存"><a href="#读取内存" class="headerlink" title="读取内存"></a>读取内存</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 读取内存 */</span></span><br><span class="line">long targetAddr = <span class="variable language_">module</span>.<span class="property">base</span> + <span class="number">0xE0320</span>;</span><br><span class="line"><span class="title class_">UnidbgPointer</span> ptr = <span class="title class_">UnidbgPointer</span>.<span class="title function_">pointer</span>(emulator, targetAddr);</span><br><span class="line">byte[] data = ptr.<span class="title function_">getByteArray</span>(<span class="number">0</span>, <span class="number">0xC0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Inspector</span>.<span class="title function_">inspect</span>(data, <span class="string">&quot;Dumped Memory at 0x&quot;</span> + <span class="title class_">Long</span>.<span class="title function_">toHexString</span>(targetAddr));</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/%E7%AE%97%E6%B3%95%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E5%88%9D%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/%E7%AE%97%E6%B3%95%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E5%88%9D%E8%AF%86/" class="post-title-link" itemprop="url">算法逆向分析初识</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:23:57 / 修改时间：17:32:44" itemprop="dateCreated datePublished" datetime="2025-05-18T17:23:57+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="hellojni-2-0-7-apk"><a href="#hellojni-2-0-7-apk" class="headerlink" title="hellojni_2.0.7.apk"></a>hellojni_2.0.7.apk</h1><p>目标：还原signs的加密算法。</p>
<p>点击SIGN2按钮后，下面这个签名会发生改变。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414145949279.png" alt="image-20250414145949279" style="zoom:67%;" />

<p>通过定位，发现这个签名是由JNI函数<strong>Java_com_example_hellojni_HelloJni_sign2</strong>生成的。</p>
<p>进一步，对其中的sub_1CFF0进行hook，发现其第3个参数（从1开始算）便是签名。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414150401970.png" alt="image-20250414150401970" style="zoom:67%;" />

<p>hook的代码如下，将其中的addr赋值为<strong>1CFF0</strong>即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_find_target_address</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> base = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libhello-jni.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nlibhello-jni.so Baseaddr: &quot;</span> + base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> target_addr = base.<span class="title function_">add</span>(addr);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nTarget Address: &quot;</span> + target_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hook并打印参数和返回值</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nsub_&quot;</span> + addr.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;args: &quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\ninput_str: \r\n&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\ninput_str_length: &quot;</span> + <span class="variable language_">this</span>.<span class="property">arg1</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">onLeave</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\noutput_str: \r\n&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg2</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印的结果如下图所示。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414150622333.png" alt="image-20250414150622333" style="zoom:80%;" />

<p>为了方便分析，这里需要将input_str和input_str_length进行固定。</p>
<p>如图所示，我将输入字符串固定为”1234567890abcdefg”。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_find_target_address</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> base = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libhello-jni.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nlibhello-jni.so Baseaddr: &quot;</span> + base);</span><br><span class="line">    <span class="keyword">var</span> target_addr = base.<span class="title function_">add</span>(addr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nTarget Address: &quot;</span> + target_addr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// hook并打印参数和返回值</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="comment">// 保存原始参数值以便打印</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nsub_&quot;</span> + addr.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; args: &quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\n原始input_str: \r\n&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>, &#123; <span class="attr">length</span>: <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>) &#125;));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\ninput_str_length: &quot;</span> + <span class="variable language_">this</span>.<span class="property">arg1</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 新字符串</span></span><br><span class="line">            <span class="keyword">var</span> new_str = <span class="string">&quot;1234567890abcdefg&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 方法1：直接写入内存</span></span><br><span class="line">            <span class="title class_">Memory</span>.<span class="title function_">writeUtf8String</span>(args[<span class="number">0</span>], new_str);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 方法2：如果需要写入二进制数据而不是UTF8字符串</span></span><br><span class="line">            <span class="comment">// var bytes = [0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x00]; // &quot;1234567890abcdef\0&quot;</span></span><br><span class="line">            <span class="comment">// Memory.writeByteArray(args[0], bytes);</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> length = new_str.<span class="property">length</span>;</span><br><span class="line">            args[<span class="number">1</span>] = <span class="title function_">ptr</span>(length);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">args1</span> = args[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\n修改后的长度: &quot;</span> + <span class="variable language_">this</span>.<span class="property">args1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\n修改后input_str: \r\n&quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">0</span>], &#123; <span class="attr">length</span>: <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">args1</span>) &#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">onLeave</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\noutput_str: \r\n&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg2</span>, &#123; <span class="attr">length</span>: <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">args1</span>) &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414153532777.png" alt="image-20250414153532777" style="zoom:80%;" />

<p>在确保了输入字符串不变后，尝试使用IDA的trace，追踪函数sub_1CFF0。</p>
<p>先注入frida、再注入IDA server——似乎不按这个顺序，先注入IDA再注入Frida，Frida会注入失败。</p>
<p>我决定先退出Frida的hook，再进行追踪，因为我发现Frida要是已经hook了sub_1CFF0，在sub_1CFF0的函数开始的地方，会存在inline hook，跳转到Frida的跳床函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414153913051.png" alt="image-20250414153913051" style="zoom:80%;" />

<p>通过IDA trace，走过的汇编指令会变成黄色。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414154156636.png" alt="image-20250414154156636"></p>
<p>追踪到的内容如下图所示，第一栏的36EE是线程id，第二栏是地址，第三栏开始就是汇编指令了，如果汇编指令修改了寄存器，则会在汇编指令后面，显示寄存器被修改后的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414154332639.png" alt="image-20250414154332639"></p>
<p>之后，我重新生成了一个trace记录，并记录了一下签名值。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414162840995.png" alt="image-20250414162840995" style="zoom: 50%;" />

<p>之后进行算法逆向。</p>
<p>已知算法的输入是input_str &#x2F; input_str_length &#x2F; output_str，分别代表着X0、X1、X2。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414164247587.png" alt="image-20250414164247587"></p>
<p>因为X2代表着output_str的内存地址，所以追踪X2，判断有哪些指令对地址0x00000079E1720D90上的内容进行了修改。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414164543132.png" alt="image-20250414164543132" style="zoom:80%;" />

<p>查找到了34个对0x00000079E1720D90进行读写的位置。</p>
<p>对其中一些指令进行还原，可以猜到。</p>
<p>X8代表：当前正在操作output的第X8个字节，也代表循环次数；</p>
<p>X5代表output的内存地址；</p>
<p>X29[var_64]是一个固定字节数组。</p>
<p>X29[var_68]也是一个固定字节数组。</p>
<p>至于var_6C，最后还是追踪到var_68上。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414190420796.png" alt="image-20250414190420796"></p>
<p>做了一些补充。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250415094520831.png" alt="image-20250415094520831"></p>
<p>一直追踪[X29,#var_64]。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250415094627344.png" alt="image-20250415094627344"></p>
<p>而一直追踪[X29,#var_68]，会发现需要追踪X2，继而追踪X2和X3，继而追踪X3和X7……</p>
<p>最后追踪到[X29,#var_88]。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250415094751043.png" alt="image-20250415094751043"></p>
<p>最后发现，var_88这个变量是一个指针，它将地址给了X2，由X2去获取全局变量，也就是图中的xmmword_79A31EE7B0。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250415095055847.png" alt="image-20250415095055847"></p>
<p>至此，可以将全局变量及涉及到的寄存器改写成c。</p>
<p>(解密的时候前8个字节和后8个字节的处理方式不同，可能还得逆，这里我直接贴别人逆好的代码)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">enc_function</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* input_str, <span class="type">int</span> input_len, <span class="type">char</span>* result)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* table_key1 = <span class="string">&quot;9d9107e02f0f07984956767ab1ac87e5&quot;</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> table_key2[] = &#123;<span class="number">0x37</span>, <span class="number">0x92</span>, <span class="number">0x44</span>, <span class="number">0x68</span>, <span class="number">0xA5</span>, <span class="number">0x3D</span>, <span class="number">0xCC</span>, <span class="number">0x7F</span>, <span class="number">0xBB</span>, <span class="number">0xF</span>, <span class="number">0xD9</span>, <span class="number">0x88</span>, <span class="number">0xEE</span>, <span class="number">0x9A</span>, <span class="number">0xE9</span>, <span class="number">0x5A</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; input_len; ++i) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> X2 = input_str[i];</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> key2 = table_key2[(i &amp; <span class="number">0xF</span>) &amp; <span class="number">0xFFFFFFFF</span>];</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W8 = <span class="number">0xDA</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W30 = <span class="number">0x25</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W2 = X2;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W7 = W8 &amp; (~W2);</span><br><span class="line">        W2 = W2 &amp; <span class="number">0x25</span>;</span><br><span class="line">        W2 = W7 | W2;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W3 = key2;</span><br><span class="line">        W7 = W8 &amp; (~W3);</span><br><span class="line">        W3 = W3 &amp; W30;</span><br><span class="line">        W3 = W7 | W3;</span><br><span class="line">        W2 = W2 ^ W3;</span><br><span class="line">        W3 = W2;</span><br><span class="line"></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> key1 = table_key1[(i ^ <span class="number">0xFFFFFFF8</span>) &amp; i ];</span><br><span class="line">        W2 = key1;</span><br><span class="line">        W7 = key2;</span><br><span class="line">        W30 = key2;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W1 = W2 &amp; (~W3);</span><br><span class="line">        W3 = W3 &amp; (~W2);</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W5 = W30 &amp; (~W2);</span><br><span class="line">        W2 = W2 &amp; (~W30);</span><br><span class="line">        W1 = W1 | W3;</span><br><span class="line">        W2 = W5 | W2;</span><br><span class="line">        W1 = W1 + W7;</span><br><span class="line">        W3 = W1 &amp; (~W2);</span><br><span class="line">        W1 = W2 &amp; (~W1);</span><br><span class="line">        W1 = W3 | W1;</span><br><span class="line">        result[i] = W1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">test_eq</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* buf1, <span class="type">const</span> <span class="type">char</span>* buf2, <span class="type">int</span> buf_len)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; buf_len; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (buf1[i] != buf2[i]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* input = <span class="string">&quot;0123456789abcdef0123456789abcdef&quot;</span>;</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(input);</span><br><span class="line">    <span class="type">char</span>* result = (<span class="type">char</span>*)<span class="built_in">malloc</span>(len);</span><br><span class="line">    <span class="built_in">memset</span>(result, <span class="number">0</span>, len);</span><br><span class="line">    enc_function(input, len, result);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02x&quot;</span>, (<span class="type">unsigned</span> <span class="type">char</span>)result[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\r\n%x&quot;</span>, test_eq(result, result, len));</span><br><span class="line">    <span class="built_in">free</span>(result);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/%E6%9F%90%E7%93%A3%E5%AD%97%E6%AE%B5-sig%E7%9A%84%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/%E6%9F%90%E7%93%A3%E5%AD%97%E6%AE%B5-sig%E7%9A%84%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">某瓣字段_sig的分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:21:48 / 修改时间：17:32:22" itemprop="dateCreated datePublished" datetime="2025-05-18T17:21:48+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>14k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>25 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="豆瓣"><a href="#豆瓣" class="headerlink" title="豆瓣"></a>豆瓣</h1><h2 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h2><p>先了解如何抓包，这次尝试分析某个参数的加解密过程。</p>
<p>工具是：Charles 4.6.3。</p>
<p>抓包的配置方式如下：</p>
<p>1.将pc和op放在同一局域网下，pc上打开Charles，设置Proxy-&gt;Proxy Settings，填写端口并勾选，如下图所示。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310103644735.png" alt="image-20250310103644735" style="zoom:50%;" />

<p>2.之后在op上，设置网络的代理，将手机的流量转发到手机的9999端口。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310103929125.png" alt="image-20250310103929125" style="zoom:67%;" />

<p>3.为pc和手机装Charles的root证书，用于CA自签名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310104014250.png" alt="image-20250310104014250"></p>
<p>由于手机端的证书对文件名有要求，这个文件名需要通过计算获得，计算可以通过<code>openssl x509 -subject_hash_old -in &lt;证书&gt;</code>获得，下图是网图，它最后得到的文件名就是5cba21f7，然后后缀固定为.0，所以就是<code>5cba21f7.0</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310104324383.png" alt="image-20250310104324383"></p>
<p>4.在安卓7以上的版本，app只接受系统证书，不接受用户证书，所以需要将证书移至&#x2F;system&#x2F;etc&#x2F;security&#x2F;cacerts，之后重启手机。</p>
<p>5.之后如图所示，设置ssl代理。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310104618901.png" alt="image-20250310104618901"></p>
<p>之后就可以抓到包了。——上面只考虑了单向认证，如果是双向认证，有些app的包还是会显示unknown，那就要将app的证书和密钥填写至Charles中了，不过豆瓣是单向认证。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>根据访问不同的域名，进行区别。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310150823254.png" alt="image-20250310150823254" style="zoom:67%;" />

<p>其中，参数_sig是请求签名，用于验证请求的完整性和合法性，通常由参数和密钥计算得出。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310150909829.png" alt="image-20250310150909829"></p>
<p>这次要分析的就是如何得到这个_sig。——抓几次包，会发现每次发包的header中，就_sig的值一直在变化，所以如果想要写脚本来发包，伪造客户端，就要解决_sig构造的问题。</p>
<p>通过搜索<code>&quot;_sig&quot;</code>，似乎找到了为<code>_sig</code>赋值的地方，将pair0.first经过一些规则（HTTP的规范）后，作为值赋给_sig。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310151822183.png" alt="image-20250310151822183"></p>
<p>在setQueryParameter中会检查s是否为空，如果已存在，还会把它移除，重新进行签名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310155727702.png" alt="image-20250310155727702"></p>
<p>之后，我想hook上面的函数，结果遇到了frida检测。</p>
<p>这次frida检测，我学到了以下几点：</p>
<p>1.frida用旧一些的版本，最新的可能不稳定；</p>
<p>2.把握好hook的时机，Interceptor.attach和Interceptor.replace的执行方式不同。attach是设置监控，监控目标地址，当执行到目标地址，才会启动对应的脚本内容；而replace是对目标地址立马进行替换，如果目标地址所在的模块尚未加载，会执行失败。</p>
<p>以下是grok的回答。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">什么是“Hook 陷阱”？</span><br><span class="line"></span><br><span class="line">“Hook 陷阱”并不是一个官方术语，而是形象地描述了 Frida 在特定时机设置 Hook 的工作方式。简单来说，它就像在目标函数的调用路径上“埋下一个陷阱”，等待程序运行到那个位置时触发，而不是立即执行 Hook 逻辑。</span><br><span class="line"></span><br><span class="line">在 Frida 中，Hook 的实现主要通过 Interceptor 模块完成：</span><br><span class="line"></span><br><span class="line"><span class="code">    Interceptor.attach：附加到目标函数的入口和出口，分别在函数调用前（onEnter）和调用后（onLeave）执行自定义逻辑。</span></span><br><span class="line"><span class="code">    Interceptor.replace：直接替换目标函数的实现，用你定义的函数逻辑覆盖原始函数。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">“陷阱”的关键在于时机：</span><br><span class="line"></span><br><span class="line"><span class="code">    Hook 的设置（比如调用 Interceptor.attach 或 Interceptor.replace）是在你的 Frida JS 脚本运行时完成的。</span></span><br><span class="line"><span class="code">    Hook 的触发（比如执行 onEnter 或替换后的函数逻辑）则是在目标函数被实际调用时发生的。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">举个例子：</span><br><span class="line">javascript</span><br><span class="line">Interceptor.attach(Module.getExportByName(&#x27;libc.so&#x27;, &#x27;open&#x27;), &#123;</span><br><span class="line"><span class="code">    onEnter: function(args) &#123;</span></span><br><span class="line"><span class="code">        console.log(&#x27;open 被调用了！&#x27;);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">&#125;);</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    脚本运行时，Interceptor.attach 会“设置陷阱”，告诉 Frida 监控 open 函数。</span></span><br><span class="line"><span class="code">    但 onEnter 里的 console.log 并不会立即执行，而是等到程序调用 open 时才打印日志。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">这种“等待触发”的机制就是“Hook 陷阱”的核心。</span><br><span class="line">替换函数的时机：脚本运行后会第一时间替换吗？</span><br><span class="line"></span><br><span class="line">你提到：“将脚本跑起来后，它难道不是第一时间将 Native 层函数替换掉吗？”答案是不完全是。让我们详细分析一下。</span><br><span class="line">Frida 替换函数的工作原理</span><br><span class="line"></span><br><span class="line">使用 Interceptor.replace 可以替换 Native 层函数的实现。例如：</span><br><span class="line">javascript</span><br><span class="line">Interceptor.replace(ptr(&#x27;0x12345678&#x27;), new NativeCallback(function() &#123;</span><br><span class="line"><span class="code">    console.log(&#x27;函数被替换了！&#x27;);</span></span><br><span class="line"><span class="code">    return 0;</span></span><br><span class="line"><span class="code">&#125;, &#x27;int&#x27;, []));</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    当脚本执行到 Interceptor.replace 时，Frida 会尝试将目标函数的地址替换为你的自定义函数。</span></span><br><span class="line"><span class="code">    但这有一个前提：目标函数所在的模块必须已经加载到内存中。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">时机的影响因素</span><br><span class="line"></span><br><span class="line"><span class="code">    模块是否已加载</span></span><br><span class="line"><span class="code">        如果你在脚本运行时要替换的函数属于某个动态加载的 .so 文件（比如 libexample.so），而这个文件在脚本启动时尚未加载，Frida 无法立即替换。</span></span><br><span class="line"><span class="code">        因为 Frida 需要知道模块的基址和函数的偏移量。如果 Process.findModuleByName(&#x27;libexample.so&#x27;) 返回 null，你就无法计算目标函数的地址，替换自然无法生效。</span></span><br><span class="line"><span class="code">    动态加载的场景</span></span><br><span class="line"><span class="code">        在 Android 中，很多 .so 文件是通过 dlopen（或 android_dlopen_ext）动态加载的。</span></span><br><span class="line"><span class="code">        如果你的目标函数在某个动态加载的模块中，你需要在模块加载后再执行替换操作。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">实际例子：你的代码可能的样子</span><br><span class="line"></span><br><span class="line">假设你想替换 libmsaoaidsec.so 中的某个函数 sub<span class="emphasis">_1b924，代码可能是这样的：</span></span><br><span class="line"><span class="emphasis">javascript</span></span><br><span class="line"><span class="emphasis">function hook_</span>sub<span class="emphasis">_1b924() &#123;</span></span><br><span class="line"><span class="emphasis">    let module = Process.findModuleByName(&#x27;libmsaoaidsec.so&#x27;);</span></span><br><span class="line"><span class="emphasis">    if (module) &#123;</span></span><br><span class="line"><span class="emphasis">        let sub_</span>1b924 = module.base.add(0x1b924);</span><br><span class="line"><span class="code">        Interceptor.replace(sub_1b924, new NativeCallback(function() &#123;</span></span><br><span class="line"><span class="code">            console.log(&#x27;sub_1b924 被替换了！&#x27;);</span></span><br><span class="line"><span class="code">            return 0;</span></span><br><span class="line"><span class="code">        &#125;, &#x27;int&#x27;, []));</span></span><br><span class="line"><span class="code">    &#125; else &#123;</span></span><br><span class="line"><span class="code">        console.log(&#x27;模块尚未加载！&#x27;);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">&#125;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    如果脚本运行时 libmsaoaidsec.so 还没加载，module 会是 null，替换不会生效。</span></span><br><span class="line"><span class="code">    你需要等待模块加载完成后再调用 hook_sub_1b924()。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">为什么不直接在脚本运行时替换？</span><br><span class="line"></span><br><span class="line">你可能会疑惑：为什么不直接在脚本启动时就完成所有替换？原因有以下几点：</span><br><span class="line"></span><br><span class="line"><span class="code">    模块未加载的问题</span></span><br><span class="line"><span class="code">        如上所述，如果目标模块没加载，Frida 无法找到函数地址，替换会失败。</span></span><br><span class="line"><span class="code">        解决办法是监控模块加载过程（比如 Hook android_dlopen_ext），在模块加载后再执行替换。</span></span><br><span class="line"><span class="code">    初始化逻辑的依赖</span></span><br><span class="line"><span class="code">        有些 .so 文件在加载后会执行初始化逻辑（比如通过 soinfo::call_constructors() 调用 .init 或 .init_array）。</span></span><br><span class="line"><span class="code">        如果你在初始化前替换函数，可能会干扰模块的正常初始化（比如反调试、校验逻辑），导致程序崩溃或行为异常。</span></span><br><span class="line"><span class="code">        通过在初始化开始前（比如 call_constructors 的 onEnter）替换函数，你可以更安全地介入。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">例如，一个常见的策略是：</span><br><span class="line">javascript</span><br><span class="line">Interceptor.attach(Module.getExportByName(&#x27;libdl.so&#x27;, &#x27;android<span class="emphasis">_dlopen_</span>ext&#x27;), &#123;</span><br><span class="line"><span class="code">    onEnter: function(args) &#123;</span></span><br><span class="line"><span class="code">        this.onLeave = function(retval) &#123;</span></span><br><span class="line"><span class="code">            hook_sub_1b924(); // 在模块加载后替换函数</span></span><br><span class="line"><span class="code">        &#125;;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">&#125;);</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    这里在 android_dlopen_ext 调用后（模块加载完成时）再执行替换，确保时机正确。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">总结：如何理解“Hook 陷阱”和替换时机</span><br><span class="line"></span><br><span class="line"><span class="code">    “Hook 陷阱”的含义</span></span><br><span class="line"><span class="code">        它是指在脚本运行时设置 Hook，但实际逻辑在目标函数调用时触发，就像“埋下陷阱”等待猎物。</span></span><br><span class="line"><span class="code">        比如通过 Interceptor.attach 设置的 onEnter 和 onLeave，都是在目标函数执行时才生效。</span></span><br><span class="line"><span class="code">    替换函数的时机</span></span><br><span class="line"><span class="code">        Interceptor.replace 在脚本运行时设置替换，但实际生效取决于模块是否加载。</span></span><br><span class="line"><span class="code">        如果目标函数所在的 .so 文件是动态加载的，你需要在模块加载后（比如通过 Hook android_dlopen_ext 或 soinfo::call_constructors()）再执行替换。</span></span><br><span class="line"><span class="code">    你的疑问解答</span></span><br><span class="line"><span class="code">        脚本运行后不会“第一时间”替换 Native 层函数，除非目标模块已经加载且函数地址可访问。</span></span><br><span class="line"><span class="code">        对于动态加载的模块，Frida 需要你手动控制替换时机，确保在正确的时间点介入。</span></span><br></pre></td></tr></table></figure>

<p>之后写的脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">fileName</span> = args[<span class="number">0</span>].<span class="title function_">readCString</span>()</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onEnter: <span class="subst">$&#123;<span class="variable language_">this</span>.fileName&#125;</span>`</span>)</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fileName</span> !== <span class="literal">undefined</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">fileName</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_linker_call_constructors</span>()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onLeave fileName: <span class="subst">$&#123;<span class="variable language_">this</span>.fileName&#125;</span>`</span>)</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fileName</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">fileName</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> JNI_OnLoad = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="variable language_">this</span>.<span class="property">fileName</span>, <span class="string">&#x27;JNI_OnLoad&#x27;</span>)</span><br><span class="line">                    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(JNI_OnLoad, &#123;</span><br><span class="line">                        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`JNI_OnLoad onLeave: <span class="subst">$&#123;retval&#125;</span>`</span>)</span><br><span class="line">                        &#125;    </span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onLeave JNI_OnLoad: <span class="subst">$&#123;JNI_OnLoad - Module.getBaseAddress(<span class="variable language_">this</span>.fileName)&#125;</span>`</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>)</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0x51BA8</span>    <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset)</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hook_linker_call_constructors onEnter&#x27;</span>)</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">// hook_pthred_create()</span></span><br><span class="line">                <span class="title function_">hook_sub_1c544</span>() <span class="comment">// 含检测</span></span><br><span class="line">                <span class="title function_">hook_sub_1b8d4</span>()</span><br><span class="line">                <span class="comment">// hook_sub_26e5c()</span></span><br><span class="line">                listener.<span class="title function_">detach</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthred_create</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libmsaoaidsec.so --- &quot;</span> + <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>).<span class="property">base</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>,<span class="string">&#x27;pthread_create&#x27;</span>),&#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> func_addr = args[<span class="number">2</span>]</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`The thread Called function address is: <span class="subst">$&#123;func_addr&#125;</span>`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_1c544</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1c544</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_1c544 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&quot;int64&quot;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_1b8d4</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1b8d4</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_1b8d4 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_26e5c</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x26e5c</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_26e5c &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;, <span class="string">&#x27;int64&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_dlopen)</span><br></pre></td></tr></table></figure>

<p>逻辑算比较清楚，之后还剩下对业务函数的hook、利用_sig构造包。</p>
<p>接着分析方法e0.d.A(Request request0)。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250312125816408.png" alt="image-20250312125816408"></p>
<p>然后写了这个函数，每次我将这个函数放到hook_dlopen的末尾，就无法正确hook上之前的3个线程。之后我发现，可以通过cmd行输入。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sig</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> clazz_d = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;e0.d&quot;</span>);</span><br><span class="line">        clazz_d.<span class="property">A</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">request</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`request-header: <span class="subst">$&#123;request.header(<span class="string">&quot;Authorization&quot;</span>)&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">A</span>(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250312125943864.png" alt="image-20250312125943864"></p>
<p>这里就获得了Authorization的值：93f4c257daea24dfbbde470790be6e9d。</p>
<p>在方法d.z中，将url、method、authorization进行加密</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250312130152471.png" alt="image-20250312130152471"></p>
<p>这里就不进去追踪了，直接获取返回值。</p>
<p>直接获取了_sig和_ts的值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sig</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> clazz_d = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;e0.d&quot;</span>);</span><br><span class="line">        clazz_d.<span class="property">A</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">request</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`request-header: <span class="subst">$&#123;request.header(<span class="string">&quot;Authorization&quot;</span>)&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">let</span> res = <span class="variable language_">this</span>.<span class="title function_">A</span>(request);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Pair-first: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">String</span>(res.first)&#125;</span>\nPair-second: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">String</span>(res.second)&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250312131159267.png" alt="image-20250312131159267"></p>
<p>之后要利用并构造包的话，只需要添加上自己生成的_sig参数，这里用js脚本，模仿jeb的代码构造_sig，最终，完整的代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url;</span><br><span class="line"><span class="keyword">var</span> method;</span><br><span class="line"><span class="keyword">var</span> authorization;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">fileName</span> = args[<span class="number">0</span>].<span class="title function_">readCString</span>()</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onEnter: <span class="subst">$&#123;<span class="variable language_">this</span>.fileName&#125;</span>`</span>)</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fileName</span> !== <span class="literal">undefined</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">fileName</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_linker_call_constructors</span>()</span><br><span class="line">                    listener.<span class="title function_">detach</span>()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// hook_sig()</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>)</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0x51BA8</span>    <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset)</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hook_linker_call_constructors onEnter&#x27;</span>)</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">// hook_pthred_create()</span></span><br><span class="line">                <span class="title function_">hook_sub_1c544</span>()</span><br><span class="line">                <span class="title function_">hook_sub_1b8d4</span>()</span><br><span class="line">                <span class="title function_">hook_sub_26e5c</span>()</span><br><span class="line">                listener.<span class="title function_">detach</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthred_create</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libmsaoaidsec.so --- &quot;</span> + <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>).<span class="property">base</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>,<span class="string">&#x27;pthread_create&#x27;</span>),&#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> func_addr = args[<span class="number">2</span>]</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`The thread Called function address is: <span class="subst">$&#123;func_addr&#125;</span>`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_1c544</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1c544</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_1c544 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&quot;int64&quot;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_1b8d4</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1b8d4</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_1b8d4 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_26e5c</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x26e5c</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_26e5c &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;, <span class="string">&#x27;int64&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sig</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> clazz_d = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;e0.d&quot;</span>);</span><br><span class="line">        clazz_d.<span class="property">A</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">request</span>) &#123;</span><br><span class="line">            authorization = request.<span class="title function_">header</span>(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">            authorization = authorization.<span class="title function_">substring</span>(<span class="number">7</span>);</span><br><span class="line">            url = request.<span class="title function_">url</span>().<span class="title function_">toString</span>();</span><br><span class="line">            method = request.<span class="title function_">method</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`request-header: <span class="subst">$&#123;authorization&#125;</span>`</span>); <span class="comment">// 打印Authorization</span></span><br><span class="line">            <span class="keyword">let</span> res = <span class="variable language_">this</span>.<span class="title function_">A</span>(request);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Pair-first: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">String</span>(res.first.value)&#125;</span>\nPair-second: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">String</span>(res.second.value)&#125;</span>`</span>); <span class="comment">// 打印Pair</span></span><br><span class="line">            <span class="comment">// MySig，自己模仿流程写一个</span></span><br><span class="line">            <span class="title function_">getMySig</span>();</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getMySig</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">HttpUrl</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;okhttp3.HttpUrl&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">StringBuilder</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.StringBuilder&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> clazz_a = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.support.v4.media.a&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Uri</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.net.Uri&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 临时硬编码 s3</span></span><br><span class="line">    <span class="keyword">var</span> s3 = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;bf7dddc7c9cfe6f7&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!url || !method || !authorization) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;url, method, or authorization is undefined&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> stringBuilder0 = clazz_a.<span class="title function_">g</span>(method);</span><br><span class="line">    <span class="keyword">if</span> (!stringBuilder0) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;clazz_a.g(method) returned null&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> s4 = <span class="title class_">HttpUrl</span>.<span class="title function_">parse</span>(url).<span class="title function_">encodedPath</span>();</span><br><span class="line">    <span class="keyword">if</span> (!s4) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;HttpUrl.parse failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> s5 = <span class="title class_">Uri</span>.<span class="title function_">decode</span>(s4);</span><br><span class="line">    <span class="keyword">if</span> (s5.<span class="title function_">endsWith</span>(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">        s5 = clazz_a.<span class="title function_">e</span>(s5, -<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stringBuilder0.<span class="title function_">append</span>(<span class="string">&quot;&amp;&quot;</span>).<span class="title function_">append</span>(<span class="title class_">Uri</span>.<span class="title function_">encode</span>(s5)).<span class="title function_">append</span>(<span class="string">&quot;&amp;&quot;</span>).<span class="title function_">append</span>(authorization);</span><br><span class="line">    <span class="keyword">var</span> v = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.System&quot;</span>).<span class="title function_">currentTimeMillis</span>().<span class="title function_">toString</span>();</span><br><span class="line">    v = v.<span class="title function_">substring</span>(<span class="number">0</span>, v.<span class="property">length</span> - <span class="number">3</span>);</span><br><span class="line">    stringBuilder0.<span class="title function_">append</span>(<span class="string">&quot;&amp;&quot;</span>).<span class="title function_">append</span>(v);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> mac0 = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;javax.crypto.Mac&quot;</span>).<span class="title function_">getInstance</span>(<span class="string">&quot;HmacSHA1&quot;</span>);</span><br><span class="line">    mac0.<span class="title function_">init</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;javax.crypto.spec.SecretKeySpec&quot;</span>).$new(s3.<span class="title function_">getBytes</span>(), <span class="string">&quot;HmacSHA1&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Base64</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Base64&quot;</span>);</span><br><span class="line"></span><br><span class="line">    stringBuilder0.<span class="title function_">toString</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> strrr = stringBuilder0.<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`typeof strrr: <span class="subst">$&#123;<span class="keyword">typeof</span> strrr&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> bytes = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(strrr).<span class="title function_">getBytes</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`typeof Java.use(&quot;java.lang.String&quot;).$new(strrr): <span class="subst">$&#123;<span class="keyword">typeof</span> Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(strrr)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> res = mac0.<span class="title function_">doFinal</span>(bytes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> s6 = <span class="title class_">Base64</span>.<span class="title function_">encodeToString</span>(res, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 确保 s6 和 v 是正确的 Java 字符串</span></span><br><span class="line">    <span class="keyword">var</span> pair = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Pair&quot;</span>).$new(</span><br><span class="line">        s6, v);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`MySig: <span class="subst">$&#123;pair.first&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> pair;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_dlopen)</span><br></pre></td></tr></table></figure>

<p>其中，有一个问题，如下代码卡了我很久。在我眼中，这里的strrr一定是一个js代理java的String类型，是一个属于java的字符串，但被frida自动转换成了JavaScript字符串，而JS字符串没有getBytes函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stringBuilder0.<span class="title function_">toString</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> strrr = stringBuilder0.<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> bytes = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(strrr).<span class="title function_">getBytes</span>();</span><br><span class="line"><span class="comment">// 原本写的是strrr.getBytes()</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://reverseengineering.stackexchange.com/questions/32790/convert-string-to-byte-array-in-frida-js-script">https://reverseengineering.stackexchange.com/questions/32790/convert-string-to-byte-array-in-frida-js-script</a></p>
<p>通过js的函数，typeof去查看区别，可以发现stringBuilder0.toString()的类型是string，而Java.use(“java.lang.String”).$new(strrr)的类型是object。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250313175050250.png" alt="image-20250313175050250"></p>
<p>至此，脚本也算是跑出了_sig签名。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/default-index/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/default-index/">1</a><span class="page-number current">2</span><a class="page-number" href="/default-index/page/3/">3</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/default-index/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">X14Nuy</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">507k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">15:22</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
