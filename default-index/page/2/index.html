<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/default-index/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="X14Nuy">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/default-index/page/2/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"default-index/page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">X14Nuy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/21/%E6%9F%90%E5%92%96%E5%95%A1app%E5%8D%8F%E8%AE%AE%E5%AD%97%E6%AE%B5%E5%88%86%E6%9E%90%E2%80%94%E2%80%94sign%E3%80%81q/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/21/%E6%9F%90%E5%92%96%E5%95%A1app%E5%8D%8F%E8%AE%AE%E5%AD%97%E6%AE%B5%E5%88%86%E6%9E%90%E2%80%94%E2%80%94sign%E3%80%81q/" class="post-title-link" itemprop="url">某咖啡app协议字段分析——sign、q</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-21 18:40:08 / 修改时间：18:43:42" itemprop="dateCreated datePublished" datetime="2025-05-21T18:40:08+08:00">2025-05-21</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>31k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>57 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="分析流程"><a href="#分析流程" class="headerlink" title="分析流程"></a>分析流程</h1><p>首先打开JEB观察分析结果，看到存在com.qihoo.util，说明是数字壳。</p>
<p>从Manifest可以知道，包名是com.lucky.luckyclient。</p>
<p>接下来先进行脱壳，我之前刷了一个aosp10的脱壳机，正好试试。</p>
<h2 id="脱壳"><a href="#脱壳" class="headerlink" title="脱壳"></a>脱壳</h2><p>将app装入脱壳机，在某个指定文件中输入该app的包名，等待脱壳完毕即可。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519151242871.png" alt="image-20250519151242871"></p>
<p>将脱完后的内容放入jadx，已经可以看到很多java层的代码了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519152942187.png" alt="image-20250519152942187" style="zoom:67%;" />

<p>接下来尝试抓包，我抓包工具还挺多的，reqable或Charles都行，试试Charles好了。</p>
<h2 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h2><p>先观察电脑ip。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519154135717.png" alt="image-20250519154135717" style="zoom:80%;" />

<p>将手机连上同一个局域网，并将代理设置为主机的ip，端口则填Charles监听的端口。——因此，代理地址是192.168.1.188:9999。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519154503684.png" alt="image-20250519154503684" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519154806363.png" alt="image-20250519154806363" style="zoom:67%;" />

<p>要分析的这个请求是为了获得AuthCode（授权码），根据网上的博客，接下来开始分析<strong>sign</strong>和<strong>q字段</strong>的加密流程。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519160845900.png" alt="image-20250519160845900" style="zoom:80%;" />

<h2 id="分析加密流程"><a href="#分析加密流程" class="headerlink" title="分析加密流程"></a>分析加密流程</h2><h3 id="sign"><a href="#sign" class="headerlink" title="sign"></a>sign</h3><p>在jadx直接搜索sign，观察是否能直接找到关于字段sign的代码，事实证明，并不可以。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519161524126.png" alt="image-20250519161524126"></p>
<p>一般在开发中，存储字段会使用到标准sdk的HashMap，因此，接下来可以hook HashMap的put，观察进程是否会调用HashMap.put将sign字段存储起来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">call_HashMap</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> hashMap = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.util.HashMap&quot;</span>);</span><br><span class="line">        hashMap.<span class="property">put</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (a != <span class="literal">null</span> &amp;&amp; a.<span class="title function_">equals</span>(<span class="string">&quot;sign&quot;</span>)) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()))</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hashMap.put: &quot;</span>, a, b);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">put</span>(a, b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印的结果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519162507367.png" alt="image-20250519162507367"></p>
<p>很自然地，通过调用方法栈，我们下一个分析的点就是 <strong>getRequestParams</strong>。</p>
<p>将 <strong>com.lucky.lib.http2.AbstractLcRequest.getRequestParams</strong> 拿到jadx中搜一搜。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519162956867.png" alt="image-20250519162956867" style="zoom:80%;" />

<p>结合我们之前打印的结果，StubApp.getString2 在把字符串解密后，返回值字符串。</p>
<p>hook一下，查看返回值，代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">get_str</span>(<span class="params">num</span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="title class_">StubApp</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.stub.StubApp&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[num] &quot;</span>, num, <span class="string">&quot; -&gt; &quot;</span>, <span class="string">&quot;[decrypt_str] &quot;</span>, <span class="title class_">StubApp</span>.<span class="title function_">getString2</span>(num));</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印的结果如下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519164034161.png" alt="image-20250519164034161" style="zoom:80%;" />

<p>在jadx中加点注释。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519164527033.png" alt="image-20250519164527033"></p>
<p>我们的目标是 <strong>sign</strong>，它的值是这样得来的，也就是说，要先获得cid、uid、q的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C9267r.m20563a(cid, uid, q2)</span><br></pre></td></tr></table></figure>

<p>直接写脚本获取cid、uid、q，我们的目标是分析 <strong>sign</strong> 的加密流程。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> R = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.lucky.lib.http2.r&quot;</span>);</span><br><span class="line">    R.<span class="property">a</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">cid, uid, q</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[cid] &quot;</span>, cid);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[uid] &quot;</span>, uid);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[q] &quot;</span>, q);</span><br><span class="line">        <span class="keyword">var</span> res = <span class="variable language_">this</span>.<span class="title function_">a</span>(cid, uid, q);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行后报错了，说是找不到类 <strong>com.lucky.lib.http2.r</strong>，可能是因为Frida使用的类加载器不对？经过尝试，这个类并不是一开始就加载的类，类未加载的时候hook不上。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">get_cid_uid_q</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateClassLoaders</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">loader</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 尝试使用当前 loader 加载类，不要设置全局 loader</span></span><br><span class="line">                    <span class="keyword">const</span> R = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.lucky.lib.http2.r&quot;</span>, &#123; <span class="attr">classLoader</span>: loader &#125;);</span><br><span class="line">                    <span class="comment">// console.log(&quot;[SUCCESS] Found com.lucky.lib.http2.r with loader: &quot; + loader);</span></span><br><span class="line">    </span><br><span class="line">                    R.<span class="property">a</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">cid, uid, q</span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Hooked R.a] Reached!&quot;</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[cid] &quot;</span>, cid);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[uid] &quot;</span>, uid);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[q] &quot;</span>, q);</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// 暂时不要调用原始方法，先看hook本身是否稳定</span></span><br><span class="line">                        <span class="comment">//console.log(&quot;Original method R.a will not be called for now to test stability.&quot;);</span></span><br><span class="line">                        <span class="keyword">var</span> res = <span class="variable language_">this</span>.<span class="title function_">a</span>(cid, uid, q);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[res from &quot;</span> + loader + <span class="string">&quot;] &quot;</span>, res);</span><br><span class="line">                        <span class="keyword">return</span> res;</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// 根据原始方法的返回类型返回一个默认值，如果是void则不需要返回</span></span><br><span class="line">                        <span class="comment">// 如果不知道返回类型，可以暂时返回 null</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="comment">// 如果希望只hook一次，可以在这里添加逻辑停止枚举或标记已hook</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[FAIL] Could not find com.lucky.lib.http2.r with loader: &quot;</span> + loader);</span><br><span class="line">                    <span class="comment">// 如果错误不是 ClassNotFoundException，打印出来看看</span></span><br><span class="line">                    <span class="keyword">if</span> (!e.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&quot;java.lang.ClassNotFoundException&quot;</span>)) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Error while trying to use class with loader &quot;</span> + loader + <span class="string">&quot;: &quot;</span> + e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Class loader enumeration complete.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(get_cid_uid_q);</span><br></pre></td></tr></table></figure>

<p>等待一段时间，等到类加载了再进行hook即可。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519183249268.png" alt="image-20250519183249268"></p>
<p>cid、uid基本是不变的（除非换账号、删缓存），唯一会变的是q。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519183502080.png" alt="image-20250519183502080"></p>
<p>之后分析的时候，需要将q固定，这里先不动它。</p>
<p>点进 <strong>C9267r.m20563a(cid, uid, q2)</strong> 查看，大致逻辑可以总结成下面这个式子，key和value代入uid、cid、q即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C9247c.f237976b.m20087a(<span class="string">&quot;&lt;key&gt;=&lt;value&gt;;&lt;key&gt;=&lt;value&gt;;&lt;key&gt;=&lt;value&gt;;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519184802371.png" alt="image-20250519184802371"></p>
<p>点进 <strong>C9247c.f237976b.m20087a</strong> 查看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519191252914.png" alt="image-20250519191252914"></p>
<p>观察 <strong>this.f237669e.mo15913a</strong> ，this代表对象，<strong>f237669e</strong> 是this对象的接口对象，通过这个接口对象调用接口中声明的方法。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519191500562.png" alt="image-20250519191500562" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519191524953.png" alt="image-20250519191524953" style="zoom:80%;" />

<p>如果想hook一个接口或者抽象方法，需要找到实现的地方进行hook，这跟frida是如何hook java层方法的原理有关。——简单来说，一个Java方法对应一个ArtMethod，我们要找到实现Java方法的ArtMethod，抽象方法和接口都没有实际的CodeItem。</p>
<p>因此，我们要找到实现了这个接口的类，但是，这又有一个问题，CryptoHelper似乎并没有继承其它的类，没有间接实现接口的可能；那还有两个可能：一是赋值的时候用匿名类，在赋值的时候，同时实现了接口；二是定义一个实现好了接口的类，然后作为参数传能够给赋值 <strong>f237669e</strong> 的方法。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519192312985.png" alt="image-20250519192312985"></p>
<p>交叉引用这个接口对象 <strong>f237669e</strong>，可以注意到，只有<strong>构造函数</strong>和<strong>方法m20086a</strong>可能为接口对象赋值了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519192915818.png" alt="image-20250519192915818"></p>
<p>交叉引用<strong>方法m20086a</strong>，会发现：没有任何被Java层代码调用的地方，那这个函数可能是在native层被调用了（通过FindClass、CallStaticMethod等函数调用），所以在jadx中查不到。</p>
<p>接着交叉引用构造函数，这回有收获了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519193321999.png" alt="image-20250519193321999"></p>
<p>分别去查看C8118a、C9123b等类，查看它们关于接口的实现方式，结果如下。</p>
<p><strong>C8118a的实现。</strong></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519193455565.png" alt="image-20250519193455565" style="zoom:80%;" />

<p>可以注意到，有点像base64编码（但标准的base64没有_符号），去试试解码。——试了后发现，都是不可显示的字符，用Hex也没看出什么特征。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519195428064.png" alt="image-20250519195428064" style="zoom:80%;" />

<p>之后发现，这里面的_需要换成&#x2F;，不过之后再说吧。</p>
<p><strong>C9123b的实现。</strong></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519193855028.png" alt="image-20250519193855028" style="zoom:80%;" />

<p><strong>C9234b的实现</strong>有点绕。</p>
<p>继续追踪f237975a。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519194259042.png" alt="image-20250519194259042" style="zoom:80%;" />

<p>根据交叉引用，它只会通过方法m20437c得到值，因此继续追踪方法m20437c。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519194422403.png" alt="image-20250519194422403" style="zoom:80%;" />

<p>查看成员变量f238026j，进行交叉引用。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519194501863.png" alt="image-20250519194501863" style="zoom:67%;" />

<p>发现它只会在方法m20538g进行调用，继续交叉引用。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519194551662.png" alt="image-20250519194551662"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519194632237.png" alt="image-20250519194632237"></p>
<p><strong>因此，C9234b的实现是这样的。</strong></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519194736625.png" alt="image-20250519194736625" style="zoom:80%;" />

<p><strong>C11110a的实现。</strong></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519195626309.png" alt="image-20250519195626309"></p>
<p><strong>C11112c的实现</strong>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519195706646.png" alt="image-20250519195706646"></p>
<p>回到方法 <strong>m20087a</strong>。</p>
<p>md5_crypt( str.getBytes(), num)，这里的num是0&#x2F;1&#x2F;2中的一个，大概率是1，因为根据上述解密，似乎其它的类似base64编码的字节码，在解码后是不可视的字节码？无法和coffee、tea进行比较。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519201707502.png" alt="image-20250519201707502"></p>
<p>这里的md5_crypt是native函数，不妨hook一下，看看i2的值是什么。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519202206855.png" alt="image-20250519202206855" style="zoom:80%;" />

<p>代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_md5_crypt</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="title class_">CryptoHelper</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.luckincoffee.safeboxlib.CryptoHelper&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">CryptoHelper</span>.<span class="property">md5_crypt</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">arr, i2</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`--- md5_crypt called ---`</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[i2] <span class="subst">$&#123;i2&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[bArr] byte array of length <span class="subst">$&#123;arr.length&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历字节数组，并尝试转换为ASCII字符</span></span><br><span class="line">            <span class="keyword">let</span> hexString = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">let</span> asciiString = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">const</span> bytesPerLine = <span class="number">16</span>; <span class="comment">// 每行显示的字节数，方便查看</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">const</span> byte = arr[i];</span><br><span class="line">                <span class="comment">// 将有符号字节转换为无符号整数 (0-255)</span></span><br><span class="line">                <span class="keyword">const</span> unsignedByte = byte &amp; <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将字节值转换为十六进制字符串，方便对比</span></span><br><span class="line">                hexString += unsignedByte.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>) + <span class="string">&#x27; &#x27;</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 判断是否为可打印的ASCII字符 (通常范围是 32 到 126)</span></span><br><span class="line">                <span class="keyword">if</span> (unsignedByte &gt;= <span class="number">32</span> &amp;&amp; unsignedByte &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">                    asciiString += <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unsignedByte);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果不是可打印字符，用点或其他符号代替</span></span><br><span class="line">                    asciiString += <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 每隔 bytesPerLine 打印一行，或者在数组结束时打印剩余部分</span></span><br><span class="line">                <span class="keyword">if</span> ((i + <span class="number">1</span>) % bytesPerLine === <span class="number">0</span> || i === arr.<span class="property">length</span> - <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="comment">// 为了对齐，给较短的行添加空格填充</span></span><br><span class="line">                     <span class="keyword">while</span> (hexString.<span class="property">length</span> &lt; bytesPerLine * <span class="number">3</span>) &#123; <span class="comment">// 2 chars + 1 space per byte</span></span><br><span class="line">                        hexString += <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  <span class="subst">$&#123;hexString&#125;</span> | <span class="subst">$&#123;asciiString&#125;</span>`</span>);</span><br><span class="line">                    hexString = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                    asciiString = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`--- Calling original md5_crypt ---`</span>);</span><br><span class="line">            <span class="comment">// 调用原始的 native 方法并返回结果</span></span><br><span class="line">            <span class="keyword">const</span> result = <span class="variable language_">this</span>.<span class="title function_">md5_crypt</span>(arr, i2);</span><br><span class="line">             <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`--- Original md5_crypt returned ---`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_md5_crypt);</span><br></pre></td></tr></table></figure>

<p>如果多截几张图，就会发现，i2基本恒为1，符合我们的猜测，bArr数组其实就是cid、q、uid放在一块。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519210039726.png" alt="image-20250519210039726" style="zoom:80%;" />

<p>接下来进入native层分析md5_crypt对应的函数，将libcryptoDD.so放入IDA中。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519210317230.png" alt="image-20250519210317230"></p>
<p>进来后，先来看看导出表，我们的目标大概率是android_native_md5。</p>
<p>同时，发现存在很多.datadiv_decodexxxxxx的函数，应该是解密字符串用的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519210441038.png" alt="image-20250519210441038"></p>
<p>基本都在.init_array段上，先不着急分析了，先写个脚本，将解密后的so文件进行dump，这样便于之后的分析。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519210536785.png" alt="image-20250519210536785"></p>
<p>最后一个datadiv函数的地址是0x1B61C。可以在hook这个函数的onLeave回调进行dump。</p>
<p>我靠，我写好了脚本，尝试了好多遍为什么一dump就“非法指令”退出，突然想起来，”libcryptoDD.so”是32位的so，不仅要修改linker64 -&gt; linker，还需要修改call_constructor的偏移量。</p>
<p>但似乎改了后，还是会崩溃，那就应该是有反调了，但我没注意反调在哪，跑了挺久，也没退出，可能是对某些关键函数的hook做了检测吧，之后再去找找看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519220328748.png" alt="image-20250519220328748"></p>
<p>既然这样，不在第一时间dump了，等so文件稳定了再dump。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> module_name = <span class="string">&quot;libcryptoDD.so&quot;</span>; <span class="comment">// 可选：目标库名称，用于过滤</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> dlopenPtr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;dlopen&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!dlopenPtr) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[!] dlopen not found.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking dlopen at &quot;</span> + dlopenPtr);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(dlopenPtr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> libraryPath = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(args[<span class="number">0</span>]);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dlopen] Loading library: &quot;</span> + libraryPath);</span><br><span class="line">            <span class="keyword">if</span> (libraryPath.<span class="title function_">includes</span>(module_name)) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[!] Target library &quot;</span> + module_name + <span class="string">&quot; loaded, exiting...&quot;</span>);</span><br><span class="line">                <span class="title class_">Process</span>.<span class="title function_">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_android_dlopen_ext</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> androidDlopenExtPtr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!androidDlopenExtPtr) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[!] android_dlopen_ext not found.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking android_dlopen_ext at &quot;</span> + androidDlopenExtPtr);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(androidDlopenExtPtr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> libraryPath = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(args[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">var</span> flags = args[<span class="number">1</span>].<span class="title function_">toInt32</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[android_dlopen_ext] Loading library: &quot;</span> + libraryPath + <span class="string">&quot;, flags: 0x&quot;</span> + flags.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">            <span class="keyword">if</span> (libraryPath.<span class="title function_">includes</span>(module_name)) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[!] Target library &quot;</span> + module_name + <span class="string">&quot; loaded, exiting...&quot;</span>);</span><br><span class="line">                <span class="title class_">Process</span>.<span class="title function_">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">hook_dlopen</span>();</span><br><span class="line">        <span class="title function_">hook_android_dlopen_ext</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] Hooking dlopen and android_dlopen_ext initialized.&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump_so</span>(<span class="params">so_name</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(so_name);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[name] &quot;</span>, so_name);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[base] &quot;</span>, secmodule.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[size] &quot;</span>, secmodule.<span class="property">size</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">    <span class="title function_">dump</span>(secmodule.<span class="property">base</span>, secmodule.<span class="property">size</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump</span>(<span class="params">begin_addr, dump_size</span>)&#123;</span><br><span class="line">    <span class="comment">// console.log(&quot;[name] &quot;, module_name);</span></span><br><span class="line">    <span class="comment">// console.log(&quot;[base] &quot;, begin_addr);</span></span><br><span class="line">    <span class="comment">// console.log(&quot;[size] &quot;, &quot;0x&quot; + dump_size.toString(16));</span></span><br><span class="line">    <span class="keyword">var</span> file_path = <span class="string">&quot;/data/data/com.lucky.luckyclient/zzc_0x&quot;</span> + begin_addr.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;_0x&quot;</span> + dump_size.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;.so&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="title function_">ptr</span>(begin_addr), dump_size, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> libso_buffer = <span class="title function_">ptr</span>(begin_addr).<span class="title function_">readByteArray</span>(dump_size);</span><br><span class="line">        file_handle.<span class="title function_">write</span>(libso_buffer);</span><br><span class="line">        file_handle.<span class="title function_">flush</span>();</span><br><span class="line">        file_handle.<span class="title function_">close</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump] &quot;</span>, file_path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure>

<p>执行结果如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519221122233.png" alt="image-20250519221122233"></p>
<p>然后将它pull出来，用修复工具修复（别用soFixer，可能导入表是乱的），展示一下修复后两个so文件的区别，明显可以看到，有一些字符串已经解密了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519222654556.png" alt="image-20250519222654556"></p>
<p>继续分析这个so文件，写一个脚本hook上RegisterNatives，判断一下md5_crypt对应的native函数地址是哪个。</p>
<p>还没打印到那一步，就已经退出了。</p>
<p>我尝试hook了libc标准库的常见函数，如：open、openat、strstr等函数，没发现对frida检测。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519223425284.png" alt="image-20250519223425284"></p>
<p>还有一个问题，无法实现对call_constructor的hook，根据调用栈，会发现报错源来自frida的agent，是frida版本的问题吗？</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520101558428.png" alt="image-20250520101558428"></p>
<p>之后再来分析，先去分析数字免费壳，再来分析这个付费壳。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520132734558.png" alt="image-20250520132734558" style="zoom:80%;" />

<p>之后我发现，换了一个方式hook RegisterNatives就能打印md5_crypt的注册地址了？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取 RegisterNatives 函数的内存地址，并赋值给addrRegisterNatives。</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> addrRegisterNatives = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> symbols = <span class="title class_">Module</span>.<span class="title function_">enumerateSymbolsSync</span>(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;art&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;JNI&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;RegisterNatives&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            addrRegisterNatives = symbol.<span class="property">address</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;RegisterNatives is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (addrRegisterNatives) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrRegisterNatives, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> env = args[<span class="number">0</span>];        <span class="comment">// jni对象</span></span><br><span class="line">                <span class="keyword">var</span> java_class = args[<span class="number">1</span>]; <span class="comment">// 类</span></span><br><span class="line">                <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(java_class);</span><br><span class="line">                <span class="keyword">var</span> taget_class = <span class="string">&quot;com.luckincoffee.safeboxlib.CryptoHelper&quot;</span>;   <span class="comment">//111 某个类中动态注册的so</span></span><br><span class="line">                <span class="keyword">if</span> (class_name === taget_class) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n[RegisterNatives] method_count:&quot;</span>, args[<span class="number">3</span>]);</span><br><span class="line">                    <span class="keyword">var</span> methods_ptr = <span class="title function_">ptr</span>(args[<span class="number">2</span>]);</span><br><span class="line">                    <span class="keyword">var</span> method_count = <span class="built_in">parseInt</span>(args[<span class="number">3</span>]);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; method_count; i++) &#123;</span><br><span class="line">                        <span class="comment">// Java中函数名字的</span></span><br><span class="line">                        <span class="keyword">var</span> name_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span>));</span><br><span class="line">                        <span class="comment">// 参数和返回值类型</span></span><br><span class="line">                        <span class="keyword">var</span> sig_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span>));</span><br><span class="line">                        <span class="comment">// C中的函数内存地址</span></span><br><span class="line">                        <span class="keyword">var</span> fnPtr_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">2</span>));</span><br><span class="line">                        <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(name_ptr);</span><br><span class="line">                        <span class="keyword">var</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(sig_ptr);</span><br><span class="line">                        <span class="keyword">var</span> find_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(fnPtr_ptr);</span><br><span class="line">                        <span class="comment">// 地址、偏移量、基地址</span></span><br><span class="line">                        <span class="keyword">var</span> offset = <span class="title function_">ptr</span>(fnPtr_ptr).<span class="title function_">sub</span>(find_module.<span class="property">base</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;class_name:&#x27;</span>,class_name,<span class="string">&quot;name:&quot;</span>, name, <span class="string">&quot;sig:&quot;</span>, sig,<span class="string">&#x27;module_name:&#x27;</span>,find_module.<span class="property">name</span> ,<span class="string">&quot;offset:&quot;</span>, offset);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br><span class="line"><span class="comment">// 动态注册函数地址</span></span><br><span class="line"><span class="comment">// frida -U -f com.lucky.luckyclient -l hook_so_register.js  </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>原先的脚本如下，区别在于：上面这个脚本在RegiterNatives的地方加了个taget_class的限制，那问题应该是注册了太多函数，导致打印崩溃了（？），先不管，之后分析壳的时候再看。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">find_RegisterNatives</span>(<span class="params">params</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> symbols = <span class="title class_">Module</span>.<span class="title function_">enumerateSymbolsSync</span>(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> addrRegisterNatives = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> symbol = symbols[i];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//_ZN3art3JNI15RegisterNativesEP7_JNIEnvP7_jclassPK15JNINativeMethodi</span></span><br><span class="line">        <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;art&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;JNI&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; </span><br><span class="line">                symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;RegisterNatives&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; </span><br><span class="line">                symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            addrRegisterNatives = symbol.<span class="property">address</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;RegisterNatives is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            <span class="title function_">hook_RegisterNatives</span>(addrRegisterNatives)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_RegisterNatives</span>(<span class="params">addrRegisterNatives</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addrRegisterNatives != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrRegisterNatives, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[RegisterNatives] method_count:&quot;</span>, args[<span class="number">3</span>]);</span><br><span class="line">                <span class="keyword">let</span> java_class = args[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">let</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(java_class);</span><br><span class="line">                <span class="comment">//console.log(class_name);</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> methods_ptr = <span class="title function_">ptr</span>(args[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> method_count = <span class="built_in">parseInt</span>(args[<span class="number">3</span>]);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; method_count; i++) &#123;</span><br><span class="line">                    <span class="keyword">let</span> name_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span>));</span><br><span class="line">                    <span class="keyword">let</span> sig_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span>));</span><br><span class="line">                    <span class="keyword">let</span> fnPtr_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">let</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(name_ptr);</span><br><span class="line">                    <span class="keyword">let</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(sig_ptr);</span><br><span class="line">                    <span class="keyword">let</span> symbol = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(fnPtr_ptr)</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[RegisterNatives] java_class:&quot;</span>, class_name, <span class="string">&quot;name:&quot;</span>, name, <span class="string">&quot;sig:&quot;</span>, sig, <span class="string">&quot;fnPtr:&quot;</span>, fnPtr_ptr,  <span class="string">&quot; fnOffset:&quot;</span>, symbol, <span class="string">&quot; callee:&quot;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(find_RegisterNatives);</span><br></pre></td></tr></table></figure>

<p>打印的结果如下，md5_crypt对应着的地址是sub_1a981。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520135811852.png" alt="image-20250520135811852"></p>
<p>我开了两个IDA对照着看，因为dump下来的文件虽然恢复了某些代码，但IDA的反汇编的伪代码也变了，没原来的so好读。</p>
<p>根据对sub_1a981的分析，发现<strong>输入数据</strong>和<strong>输入数据的长度</strong>在sub_13E3C进行调用，sub_13E3C的函数名是md5。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520144716225.png" alt="image-20250520144716225" style="zoom:80%;" />

<p>v24很有可能就是md5的返回值，可以写个脚本试试。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_md5</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> module_base = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libcryptoDD.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(module_base.<span class="title function_">add</span>(<span class="number">0x13E3c</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">data</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">data_len</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">digest</span> = args[<span class="number">2</span>];</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[data]:\n&quot;</span>, <span class="title function_">hexdump</span>(args[<span class="number">0</span>], &#123;<span class="attr">length</span>: args[<span class="number">1</span>]&#125;));</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[digest]:\n&quot;</span>, <span class="title function_">hexdump</span>(args[<span class="number">2</span>], &#123;<span class="attr">length</span>: <span class="number">64</span>&#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>肯定是有反调，不然这种程度的hook，不至于引起进程崩溃。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520162306897.png" alt="image-20250520162306897"></p>
<p>接下来用unidbg模拟执行。</p>
<p>代码如下，从这套代码中，可以学会如何下断点（甚至是动调），如何模拟一个native层函数的执行。下断点的方式有2种，一是Unidbg提供的接口断点，二是Unicorn提供的断点，代码里都有涉及。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.luckincoffee.safeboxlib;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.AndroidEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Emulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.backend.Unicorn2Factory;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.array.ByteArray;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.jni.ProxyClassFactory;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.utils.Inspector;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.context.RegisterContext;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.debugger.BreakPointCallback;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.debugger.Debugger;</span><br><span class="line"><span class="keyword">import</span> com.sun.jna.Pointer;</span><br><span class="line"><span class="keyword">import</span> unicorn.ArmConst;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CryptoHelper</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DvmClass cCryptoHelper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CryptoHelper</span><span class="params">()</span> &#123;</span><br><span class="line">        emulator = AndroidEmulatorBuilder.for32Bit()</span><br><span class="line">                .addBackendFactory(<span class="keyword">new</span> <span class="title class_">Unicorn2Factory</span>(<span class="literal">true</span>))</span><br><span class="line">                .setProcessName(<span class="string">&quot;com.lucky.luckyclient&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">Memory</span> <span class="variable">memory</span> <span class="operator">=</span> emulator.getMemory();</span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>));</span><br><span class="line">        vm = emulator.createDalvikVM(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;../file/rx.apk&quot;</span>));</span><br><span class="line">        vm.setJni(<span class="built_in">this</span>);</span><br><span class="line">        vm.setDvmClassFactory(<span class="keyword">new</span> <span class="title class_">ProxyClassFactory</span>());</span><br><span class="line">        vm.setVerbose(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">DalvikModule</span> <span class="variable">dm</span> <span class="operator">=</span> vm.loadLibrary(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/resources/example_binaries/armeabi-v7a/libcryptoDD.so&quot;</span>), <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">module</span> = dm.getModule();</span><br><span class="line">        cCryptoHelper = vm.resolveClass(<span class="string">&quot;com/luckincoffee/safeboxlib/CryptoHelper&quot;</span>);</span><br><span class="line">        dm.callJNI_OnLoad(emulator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">md5_hook</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Debugger</span> <span class="variable">debugger</span> <span class="operator">=</span> emulator.attach();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Hook md5 function at 0x13E3C: md5(indata_jarray, initial_len, v25)</span></span><br><span class="line">        debugger.addBreakPoint(<span class="keyword">module</span>.base + <span class="number">0x14D6E</span>, <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line"><span class="comment">//                System.out.println(&quot;Breakpoint hit: md5 at 0x&quot; + Long.toHexString(address));</span></span><br><span class="line"><span class="comment">//                RegisterContext context = emulator.getContext();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Parameters: ARM32 registers R0-R2</span></span><br><span class="line"><span class="comment">//                long jarray = context.getLongArg(0); // R0: indata_jarray (jbyteArray)</span></span><br><span class="line"><span class="comment">//                long initial_len = context.getLongArg(1); // R1: initial_len (jint)</span></span><br><span class="line"><span class="comment">//                long v25 = context.getLongArg(2); // R2: v25 (pointer, possibly jbyteArray)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                System.out.println(&quot;md5 Parameters: jarray=0x&quot; + Long.toHexString(jarray) +</span></span><br><span class="line"><span class="comment">//                        &quot;, initial_len=&quot; + initial_len +</span></span><br><span class="line"><span class="comment">//                        &quot;, v25=0x&quot; + Long.toHexString(v25));</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Parse input jbyteArray</span></span><br><span class="line"><span class="comment">//                if (jarray != 0) &#123;</span></span><br><span class="line"><span class="comment">//                    ByteArray byteArray = (ByteArray) vm.getObject((int) jarray);</span></span><br><span class="line"><span class="comment">//                    if (byteArray != null) &#123;</span></span><br><span class="line"><span class="comment">//                        Inspector.inspect(byteArray.getValue(), &quot;Input jbyteArray&quot;);</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Parse v25 (assuming it&#x27;s a pointer to output buffer)</span></span><br><span class="line"><span class="comment">//                if (v25 != 0) &#123;</span></span><br><span class="line"><span class="comment">//                    Pointer cipherText = context.getPointerArg(2);</span></span><br><span class="line"><span class="comment">//                    Inspector.inspect(cipherText.getByteArray(0, 32), &quot;cipherText&quot;);</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Continue execution, return false to stop at breakpoint for manual debugging</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        debugger.addBreakPoint(module.base + 0x1AB92, new BreakPointCallback() &#123;</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public boolean onHit(Emulator&lt;?&gt; emulator, long address) &#123;</span></span><br><span class="line"><span class="comment">//                System.out.println(&quot;Breakpoint hit: END at 0x&quot; + Long.toHexString(address));</span></span><br><span class="line"><span class="comment">//                return true;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        // Hook doMD5sign function at 0x14D54: doMD5sign(v41, initial_len + 20, &amp;v53)</span></span><br><span class="line"><span class="comment">//        debugger.addBreakPoint(module.base + 0x14D54, new BreakPointCallback() &#123;</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public boolean onHit(Emulator&lt;?&gt; emulator, long address) &#123;</span></span><br><span class="line"><span class="comment">//                System.out.println(&quot;Breakpoint hit: doMD5sign at 0x&quot; + Long.toHexString(address));</span></span><br><span class="line"><span class="comment">//                RegisterContext context = emulator.getContext();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Parameters: ARM32 registers R0-R2</span></span><br><span class="line"><span class="comment">//                long v41 = context.getLongArg(0); // R0: v41 (possibly jbyteArray)</span></span><br><span class="line"><span class="comment">//                long len = context.getLongArg(1); // R1: initial_len + 20 (jint)</span></span><br><span class="line"><span class="comment">//                long v53 = context.getLongArg(2); // R2: &amp;v53 (pointer to output buffer)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                System.out.println(&quot;doMD5sign Parameters: v41=0x&quot; + Long.toHexString(v41) +</span></span><br><span class="line"><span class="comment">//                        &quot;, len=&quot; + len +</span></span><br><span class="line"><span class="comment">//                        &quot;, v53=0x&quot; + Long.toHexString(v53));</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Parse v41 (assuming it&#x27;s a jbyteArray)</span></span><br><span class="line"><span class="comment">//                if (v41 != 0) &#123;</span></span><br><span class="line"><span class="comment">//                    ByteArray byteArray = (ByteArray) vm.getObject((int) v41);</span></span><br><span class="line"><span class="comment">//                    if (byteArray != null) &#123;</span></span><br><span class="line"><span class="comment">//                        Inspector.inspect(byteArray.getValue(), &quot;Input v41 (jbyteArray)&quot;);</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Parse v53 (output buffer)</span></span><br><span class="line"><span class="comment">//                if (v53 != 0) &#123;</span></span><br><span class="line"><span class="comment">//                    Pointer cipherText = context.getPointerArg(2);</span></span><br><span class="line"><span class="comment">//                    Inspector.inspect(cipherText.getByteArray(0, 32), &quot;cipherText&quot;);</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                // Continue execution</span></span><br><span class="line"><span class="comment">//                return true;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        // Add return hook using CodeHook to capture return value</span></span><br><span class="line"><span class="comment">//        emulator.getBackend().hook_add_new(new com.github.unidbg.hook.HookListener() &#123;</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public void hook(unicorn.Unicorn u, long address, int size, Object user) &#123;</span></span><br><span class="line"><span class="comment">//                // Not used for entry hook in this case</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public void onReturn(unicorn.Unicorn u, long address, int size, Object user) &#123;</span></span><br><span class="line"><span class="comment">//                if (address == module.base + 0x13E3C) &#123;</span></span><br><span class="line"><span class="comment">//                    long retValue = u.reg_read(ArmConst.UC_ARM_REG_R0).longValue();</span></span><br><span class="line"><span class="comment">//                    System.out.println(&quot;md5 returned: 0x&quot; + Long.toHexString(retValue));</span></span><br><span class="line"><span class="comment">//                    if (retValue != 0) &#123;</span></span><br><span class="line"><span class="comment">//                        ByteArray retByteArray = (ByteArray) vm.getObject((int) retValue);</span></span><br><span class="line"><span class="comment">//                        if (retByteArray != null) &#123;</span></span><br><span class="line"><span class="comment">//                            Inspector.inspect(retByteArray.getValue(), &quot;md5 return jbyteArray&quot;);</span></span><br><span class="line"><span class="comment">//                        &#125;</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                &#125; else if (address == module.base + 0x14D54) &#123;</span></span><br><span class="line"><span class="comment">//                    long retValue = u.reg_read(ArmConst.UC_ARM_REG_R0).longValue();</span></span><br><span class="line"><span class="comment">//                    System.out.println(&quot;doMD5sign returned: 0x&quot; + Long.toHexString(retValue));</span></span><br><span class="line"><span class="comment">//                    if (retValue != 0) &#123;</span></span><br><span class="line"><span class="comment">//                        ByteArray retByteArray = (ByteArray) vm.getObject((int) retValue);</span></span><br><span class="line"><span class="comment">//                        if (retByteArray != null) &#123;</span></span><br><span class="line"><span class="comment">//                            Inspector.inspect(retByteArray.getValue(), &quot;doMD5sign return jbyteArray&quot;);</span></span><br><span class="line"><span class="comment">//                        &#125;</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;, module.base + 0x13E3C, module.base + 0x14D54, null);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">call_md5</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Object&gt; args = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">        args.add(vm.getJNIEnv());</span><br><span class="line">        args.add(<span class="number">0</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">my_bytes</span> <span class="operator">=</span> <span class="string">&quot;cid=1;uid=1;q=1;&quot;</span>;</span><br><span class="line">        args.add(vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, my_bytes.getBytes())));</span><br><span class="line">        args.add(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Number</span> <span class="variable">retNum</span> <span class="operator">=</span> <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x1a981</span>, args.toArray());</span><br><span class="line">        <span class="type">ByteArray</span> <span class="variable">retByteArr</span> <span class="operator">=</span> (ByteArray) vm.getObject(retNum.intValue());</span><br><span class="line">        <span class="type">String</span> <span class="variable">md5result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(retByteArr.getValue(), StandardCharsets.UTF_8);</span><br><span class="line">        System.out.println(<span class="string">&quot;md5 result = &quot;</span> + md5result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">call_hooked_function</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Object&gt; args = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">        args.add(vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, <span class="string">&quot;test_hook&quot;</span>.getBytes())));</span><br><span class="line">        args.add(<span class="number">16</span>); <span class="comment">// initial_len</span></span><br><span class="line">        args.add(vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">32</span>]))); <span class="comment">// v25: empty buffer</span></span><br><span class="line">        <span class="type">Number</span> <span class="variable">retNum</span> <span class="operator">=</span> <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x13E3C</span>, args.toArray());</span><br><span class="line">        <span class="type">ByteArray</span> <span class="variable">retByteArr</span> <span class="operator">=</span> (ByteArray) vm.getObject(retNum.intValue());</span><br><span class="line">        <span class="keyword">if</span> (retByteArr != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(retByteArr.getValue(), StandardCharsets.UTF_8);</span><br><span class="line">            System.out.println(<span class="string">&quot;md5 function result = &quot;</span> + result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    private void call_doMD5sign() &#123;</span></span><br><span class="line"><span class="comment">//        List&lt;Object&gt; args = new ArrayList&lt;&gt;(10);</span></span><br><span class="line"><span class="comment">//        args.add(vm.addLocalObject(new ByteArray(vm, &quot;test_doMD5sign&quot;.getBytes())));</span></span><br><span class="line"><span class="comment">//        args.add(34); // initial_len + 20</span></span><br><span class="line"><span class="comment">//        args.add(vm.addLocalObject(new ByteArray(vm, new byte[32]))); // v53: empty buffer</span></span><br><span class="line"><span class="comment">//        Number retNum = module.callFunction(emulator, 0x14D54, args.toArray());</span></span><br><span class="line"><span class="comment">//        ByteArray retByteArr = (ByteArray) vm.getObject(retNum.intValue());</span></span><br><span class="line"><span class="comment">//        if (retByteArr != null) &#123;</span></span><br><span class="line"><span class="comment">//            String result = new String(retByteArr.getValue(), StandardCharsets.UTF_8);</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;doMD5sign function result = &quot; + result);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        emulator.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">CryptoHelper</span> <span class="variable">cryptoHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CryptoHelper</span>();</span><br><span class="line">        cryptoHelper.md5_hook();</span><br><span class="line">        cryptoHelper.call_md5();</span><br><span class="line"><span class="comment">//        cryptoHelper.call_hooked_function();</span></span><br><span class="line"><span class="comment">//        cryptoHelper.call_doMD5sign();</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cryptoHelper.destroy();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，上述关于断点处的代码，return true（或者是false）代表着是否要动调，false代表着要动调，Unidbg会模拟程序执行到那，然后停住（有点类似于gdb），等待用户输入指令。</p>
<p>根据之前的分析，我们知道，md5_crypt对应的native层函数是 <strong>android_native_md5</strong>。</p>
<p>根据对这个函数的分析，会发现传入的“cid&#x3D;1;uid&#x3D;1;q&#x3D;1”（unidbg中固定了输入值）最终会传入函数 <strong>doMD5sign</strong>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520222934333.png" alt="image-20250520222934333"></p>
<p>根据动调，比较java层得到的返回值和doMD5sign在函数退出时，digest指向的值，两者是一样的，因此这里的digest就是我们要的 <strong>android_native_md5</strong> 最后的返回值。不过注意，我们固定输入的initial_msg后，标准的md5返回值和digest里面的值是不一样的，这说明魔改了。</p>
<p>在doMD5sign中，可以发现还有个函数叫md5，对这个函数进行hook（frida用不了，用unidbg的hook），在函数执行前，打印寄存器r0、r1、r2的值（r2指向一块buf），然后在md5执行完后，查看buf的内容。</p>
<p>会发现，这个buf的内容是标准的md5结果。</p>
<p>操作如下——</p>
<p>固定输入。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520223622766.png" alt="image-20250520223622766"></p>
<p>下断点。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520223708127.png" alt="image-20250520223708127" style="zoom:67%;" />

<p>r0 &#x3D; 0x12248000，r1 &#x3D; 36，r2 &#x3D; 0xe4fff5d8。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520223800781.png" alt="image-20250520223800781"></p>
<p>查看r0指向的字符串，会发现除了固定的输入，还加了IV，因此r1是36，而非我们固定输入的长度。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520223851080.png" alt="image-20250520223851080" style="zoom:80%;" />

<p>当前的mr2。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520223934899.png" alt="image-20250520223934899"></p>
<p>给0x12014d72下断点，然后按c执行，继续跑。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520224006870.png" alt="image-20250520224006870"></p>
<p>此时程序跑完了md5，再来看看buf里的内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520224201817.png" alt="image-20250520224201817" style="zoom:80%;" />

<p>这里的9eed….正是标准的md5结果。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520224251421.png" alt="image-20250520224251421" style="zoom:80%;" />

<p>接下来就是看doMD5sign是如何魔改的，魔改的主要逻辑在 <strong>bytesToInt</strong>。按顺序，每次操作md5结果的4个字节，将每个字节都放大了好多，然后最终通过<strong>或</strong>操作，组成一个<strong>很大的数字</strong>，由于是signed int类型，有可能是负数，一旦是负数，就取绝对值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520224616556.png" alt="image-20250520224616556"></p>
<p>然后将取过绝对值的这个<strong>很大的数字</strong>化作字符串，存入缓冲区。——这里的byte_E0021指向字符串%d，可以在解密后的so文件看出来。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520224720896.png" alt="image-20250520224720896" style="zoom:67%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520224859525.png" alt="image-20250520224859525"></p>
<p>既然知道算法了，接下来就写个python脚本复现一下，这里踩了个坑，python的整型是很大的，因此一般不会出现负数，而c&#x2F;c++中，32位的数若是很大，可能会溢出成负数，所以这里需要根据0x8000 0000判断当前得到的整型若是化成32位，是否是负数，若是，则转成正数，即减去0x1 0000 0000。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bytesToInt</span>(<span class="params">src, offset</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(src) &lt; offset + <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Source array too short for offset <span class="subst">&#123;offset&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> v9_unsigned &gt;= <span class="number">0x80000000</span>: <span class="comment"># 检查是否是负数（在C语言中）</span></span><br><span class="line">        v9_signed = v9_unsigned - <span class="number">0x100000000</span> <span class="comment"># 转换为正确的补码负值</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        v9_signed = v9_unsigned</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> v9_signed</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">doMD5sign</span>(<span class="params">initial_msg</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Calculate MD5 hash (16 bytes)</span></span><br><span class="line">    md5_hash = hashlib.md5(initial_msg).digest()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Process 4 blocks (offsets 0, 4, 8, 12)</span></span><br><span class="line">    offsets = [<span class="number">0</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">12</span>]</span><br><span class="line">    strings = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> offset <span class="keyword">in</span> offsets:</span><br><span class="line">        raw_int_value = bytesToInt(md5_hash, offset) <span class="comment"># 获取有符号的整数值</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 按照IDA伪代码的逻辑，在转为字符串前取绝对值</span></span><br><span class="line">        <span class="comment"># 对应IDA伪代码中的 &#x27;if ( vX &lt; 0 ) vY = -vX;&#x27;</span></span><br><span class="line">        abs_value = <span class="built_in">abs</span>(raw_int_value) </span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 将绝对值转换为字符串</span></span><br><span class="line">        strings.append(<span class="built_in">str</span>(abs_value))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Offset <span class="subst">&#123;offset&#125;</span>: raw_int_value = <span class="subst">&#123;raw_int_value&#125;</span>, abs_value = <span class="subst">&#123;abs_value&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Concatenate strings</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span>.join(strings)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Simulate malloc and qmemcpy</span></span><br><span class="line">    digest = result</span><br><span class="line">    length = <span class="built_in">len</span>(digest)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Final digest: <span class="subst">&#123;digest&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Length: <span class="subst">&#123;length&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> length, digest</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    initial_msg = <span class="string">b&quot;cid=1;uid=1;q=1;dJLdCJiVnDvM9JUpsom9&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        length, digest = doMD5sign(initial_msg)</span><br><span class="line">    <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>脚本跑完的结果如下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520225434327.png" alt="image-20250520225434327" style="zoom:80%;" />

<p>而Unidbg模拟的结果如下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520225455464.png" alt="image-20250520225455464" style="zoom:80%;" />

<p>至此，sign分析结束了。</p>
<p>ps：unidbg之前没怎么用过，这个动调、断点还挺好用的，之后整理一套使用手册。</p>
<h3 id="q"><a href="#q" class="headerlink" title="q"></a>q</h3><p>用之前写的hook HashMap的脚本，试试能不能找到q的加密点。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">call_HashMap</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> hashMap = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.util.HashMap&quot;</span>);</span><br><span class="line">        hashMap.<span class="property">put</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (a != <span class="literal">null</span> &amp;&amp; a.<span class="title function_">equals</span>(<span class="string">&quot;q&quot;</span>)) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()))</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hashMap.put: &quot;</span>, a, b);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">put</span>(a, b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看来跟sign一样，都是这么存储字段的。</p>
<p>注意到，字段q的最后一个字节是&#x3D;，那很有可能是base64（猜测，base64没有_和-）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250520230417092.png" alt="image-20250520230417092"></p>
<p>先从com.lucky.lib.http2.r.a看起，又是这个函数，需要追踪str3的值从何而来。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521095921734.png" alt="image-20250521095921734" style="zoom: 67%;" />

<p>写个脚本hook getRequestParams，并且hook AbstractC3710a.toJSONString，打印一下这个q2字符串的内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521102012343.png" alt="image-20250521102012343" style="zoom:80%;" />

<p>这个类是之后加载的，需要加载之后再hook。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521102914062.png" alt="image-20250521102914062"></p>
<p>打印的内容有些多。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521103024248.png" alt="image-20250521103024248"></p>
<p>然后将内容传入方法 <strong>C9247c.m20436b</strong>，再传入 <strong>f237976b.m20089c</strong>。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521104203303.png" alt="image-20250521104203303" style="zoom:80%;" />

<p>在 <strong>f237976b.m20089c</strong> 中，走localAESWork4Api(str.getBytes(), 0)。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521104819109.png" alt="image-20250521104819109"></p>
<p>localAESWork4Api是CryptoHelper中的JNI函数，也注册在libcryptoDD.so。</p>
<p>根据符号名，可以看出来是aes白盒加密。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521105621185.png" alt="image-20250521105621185"></p>
<p>在 <strong>android_native_wbaes_jni</strong> 中，可以找到函数 <strong>wbaes_decrypt_ecb</strong>，说明是aes的ecb模式加密，ecb模式没有IV。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521115216953.png" alt="image-20250521115216953" style="zoom:67%;" />

<p>虚假控制流有点多，要不直接trace算了？再等等好了。</p>
<p>本次逆向的主要目标，就是掌握AES加密及白盒AES的破解方法之一——DFA。</p>
<p>先根据这篇博客回顾一下，AES加密的流程。</p>
<p><a target="_blank" rel="noopener" href="https://xiaoeeyu.github.io/2024/02/29/%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81-AES/">https://xiaoeeyu.github.io/2024/02/29/%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81-AES/</a></p>
<p>以AES128为例，原理简单来说，如下。</p>
<p>​	<strong>输入</strong>：128位明文 + 128位密钥。</p>
<p>​	<strong>密钥扩展</strong>：生成11个128位（4x4字节）轮密钥。</p>
<p>​	<strong>初始轮</strong>：明文与第一个轮密钥异或。</p>
<p>​	<strong>普通轮</strong>：执行9轮（SubBytes（查表替换） → ShiftRows（字节循环左移） → MixColumns（列混合，矩阵乘法） → AddRoundKey（密钥异或））。</p>
<p>​	<strong>最终轮</strong>：执行1轮（SubBytes（查表替换） → ShiftRows（字节循环左移） → AddRoundKey（密钥异或））。</p>
<p>​	<strong>输出</strong>：128位密文。</p>
<p>其中，查表替换的S盒是固定的，而且只有一个，通过脚本，搜索S盒的特征就可以找到了。</p>
<p>交叉引用SBox。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521130346431.png" alt="image-20250521130346431"></p>
<p>有2个函数调用了SBox。</p>
<p>sub_63A0，很明显的SubBytes特征。</p>
<p>*result &#x3D; *((_BYTE *)RijnDael_AES_LONG_SBox + (*result &amp; 0xF0) + (*result &amp; 0xF))</p>
<p>等同于：result[i] &#x3D; SBox[result[i]]。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521130953155.png" alt="image-20250521130953155"></p>
<p>还有一处是sub_5C58，这个特征不太明显阿。有点像SubBytes，又有点像移位操作。</p>
<p>这毕竟不是标准AES，属于白盒AE，拿到了代码也不知道密钥在哪。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_5C58</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (*((<span class="type">unsigned</span> __int8 *)&amp;RijnDael_AES_LONG_SBox[<span class="number">4</span> * ((a1 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xF000000F</span>)] + (a1 &amp; <span class="number">0xF</span>)) | (*((<span class="type">unsigned</span> __int8 *)RijnDael_AES_LONG_SBox + ((a1 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xF0</span>) + ((a1 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF00000F</span>)) &lt;&lt; <span class="number">8</span>) | (*((<span class="type">unsigned</span> __int8 *)&amp;RijnDael_AES_LONG_SBox[<span class="number">4</span> * ((a1 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xFFFFF00F</span>)] + (HIWORD(a1) &amp; <span class="number">0xFFFF000F</span>)) &lt;&lt; <span class="number">16</span>)) ^ (*((<span class="type">unsigned</span> __int8 *)RijnDael_AES_LONG_SBox + (HIBYTE(a1) &amp; <span class="number">0xF0</span>) + (HIBYTE(a1) &amp; <span class="number">0xF</span>)) &lt;&lt; <span class="number">24</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，学习其它的博客，试试如何获得白盒AES的密钥，下面这个文章把DFA原理讲得很明白。</p>
<p><a target="_blank" rel="noopener" href="https://blog.quarkslab.com/differential-fault-analysis-on-white-box-aes-implementations.html">https://blog.quarkslab.com/differential-fault-analysis-on-white-box-aes-implementations.html</a></p>
<p>总结一下我的理解：</p>
<p>找到第8轮列混淆之后、第9轮列混淆之前（第十轮没有列混淆），然后修改1个字节（比特翻转，或者多修改点），这个修改的影响会被第9轮列混淆进行扩大，扩大到最终影响了输出的4个字节。</p>
<p>根据数学关系，可以列4个等式。</p>
<p>O和O’都是已知的，Z代表S-盒输入的差（A+X，即A异或X），根据对Y的假设，可以找到可能满足4个等式的Y0、Y1、Y2、Y3的候选者。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521154218635.png" alt="image-20250521154218635" style="zoom:80%;" />

<p>再通过Y的候选者和已知的O，去获得可能的K（轮密钥的某个字节）的候选者。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521154520520.png" alt="image-20250521154520520" style="zoom:80%;" />

<p>搞清楚DFA的原理以后，第一步，找到第8轮列混淆之后、第9轮列混淆之前进行故障注入。</p>
<p>回到 <strong>android_native_wbaes</strong>，看看有没有什么特征函数。——找到了一个行位移的函数。为了确保它是我们要找的行位移函数，试试它有没有执行10次，并且打印v42的内容，判断是否每次都有行位移的操作。</p>
<p>通过Unidbg完成上述的操作。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521160530312.png" alt="image-20250521160530312" style="zoom:80%;" />

<p>下述是代码片段，num是我添加的成员变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">call_aes</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Object&gt; args = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// JNIEnv*</span></span><br><span class="line">        args.add(vm.getJNIEnv());</span><br><span class="line">        <span class="comment">// jclass</span></span><br><span class="line">        args.add(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 固定输入</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">my_bytes</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;type\&quot;:1&#125;&quot;</span>;</span><br><span class="line">        args.add(vm.addLocalObject(<span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, my_bytes.getBytes())));</span><br><span class="line">        <span class="comment">// 模式</span></span><br><span class="line">        args.add(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 函数android_native_wbaes的偏移量0x1b1cd</span></span><br><span class="line">        <span class="type">Number</span> <span class="variable">retNum</span> <span class="operator">=</span> <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x1b1cd</span>, args.toArray());</span><br><span class="line">        <span class="type">ByteArray</span> <span class="variable">retByteArr</span> <span class="operator">=</span> (ByteArray) vm.getObject(retNum.intValue());</span><br><span class="line">        <span class="comment">// 打印</span></span><br><span class="line">        <span class="type">byte</span>[] resultBytes = retByteArr.getValue();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">hexString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : resultBytes) &#123;</span><br><span class="line">            hexString.append(String.format(<span class="string">&quot;%02X&quot;</span>, b &amp; <span class="number">0xFF</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;q result (hex) = &quot;</span> + hexString.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">q_hook</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Debugger</span> <span class="variable">debugger</span> <span class="operator">=</span> emulator.attach();</span><br><span class="line">        <span class="comment">// Hook wbShiftRows function at 0x14F98</span></span><br><span class="line">        debugger.addBreakPoint(<span class="keyword">module</span>.base + <span class="number">0x14F98</span>, <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line">                num += <span class="number">1</span>;</span><br><span class="line">                System.out.println(<span class="string">&quot;wbShiftRows has been called: &quot;</span> + num);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，打印了10次，符合我们的预期。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521163609731.png" alt="image-20250521163609731" style="zoom:80%;" />

<p>尝试打印每一次执行行位移之前的状态矩阵。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">q_hook</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Debugger</span> <span class="variable">debugger</span> <span class="operator">=</span> emulator.attach();</span><br><span class="line">        <span class="comment">// Hook wbShiftRows function at 0x14F98</span></span><br><span class="line">        debugger.addBreakPoint(<span class="keyword">module</span>.base + <span class="number">0x14F98</span>, <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line">                num += <span class="number">1</span>;</span><br><span class="line">                System.out.println(<span class="string">&quot;wbShiftRows has been called: &quot;</span> + num);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取寄存器上下文</span></span><br><span class="line">                <span class="type">RegisterContext</span> <span class="variable">context</span> <span class="operator">=</span> emulator.getContext();</span><br><span class="line">                <span class="comment">// R0 通常是第一个参数（状态矩阵的指针）</span></span><br><span class="line">                <span class="type">Pointer</span> <span class="variable">stateMatrix</span> <span class="operator">=</span> context.getPointerArg(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (stateMatrix != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 读取 16 字节状态矩阵</span></span><br><span class="line">                    <span class="type">byte</span>[] stateBytes = stateMatrix.getByteArray(<span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">                    <span class="comment">// 转为十六进制</span></span><br><span class="line">                    <span class="type">StringBuilder</span> <span class="variable">hexString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">byte</span> b : stateBytes) &#123;</span><br><span class="line">                        hexString.append(String.format(<span class="string">&quot;%02X &quot;</span>, b &amp; <span class="number">0xFF</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(<span class="string">&quot;wbShiftRows state matrix (hex): &quot;</span> + hexString.toString());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 继续执行</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521163920393.png" alt="image-20250521163920393" style="zoom:80%;" />

<p>下面是q正常情况下的结果。——2FF0E1B44B413D51A083E55259E2179F</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521165448510.png" alt="image-20250521165448510" style="zoom:80%;" />

<p>修改第9次行位移的某个字节，收集10次差分故障攻击的结果。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521165638163.png" alt="image-20250521165638163"></p>
<p>收集了16个错误的结果。</p>
<p>2F1BE1B4E6413D51A083E56059E21A9F</p>
<p>2FF0E1A84B41C451A0B1E55215E2179F</p>
<p>E7F0E1B44B413DE3A0837A525924179F</p>
<p>2FF0A8B44B2F3D511A83E55259E217C6</p>
<p>DCF0E1B44B413DBEA08316525911179F</p>
<p>2F68E1B436413D51A083E5CF59E2769F</p>
<p>96F0E1B44B413DACA083AB5259EA179F</p>
<p>89F0E1B44B413DE7A0831C525944179F</p>
<p>42F0E1B44B413D1CA083D9525974179F</p>
<p>2FF07FB44B6E3D514683E55259E21747</p>
<p>17F0E1B44B413D6CA0838A5259F3179F</p>
<p>2FF069B44BAA3D510283E55259E21754</p>
<p>D8F0E1B44B413D36A0834452590B179F</p>
<p>8AF0E1B44B413D27A0839752591E179F</p>
<p>24F0E1B44B413DB1A0839C5259E9179F</p>
<p>2FF0E16A4B414151A0A4E55293E2179F</p>
<p>接下来使用大佬写的攻击，通过差分结果、正常结果，还原轮密钥，项目地址：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/SideChannelMarvels/JeanGrey/tree/master/phoenixAES">https://github.com/SideChannelMarvels/JeanGrey/tree/master/phoenixAES</a></p>
<p>编写脚本得到第10轮子密钥。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> phoenixAES</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;tracefile&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> t:</span><br><span class="line">    t.write(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    2FF0E1B44B413D51A083E55259E2179F</span></span><br><span class="line"><span class="string">    2F1BE1B4E6413D51A083E56059E21A9F</span></span><br><span class="line"><span class="string">    2FF0E1A84B41C451A0B1E55215E2179F</span></span><br><span class="line"><span class="string">    E7F0E1B44B413DE3A0837A525924179F</span></span><br><span class="line"><span class="string">    2FF0A8B44B2F3D511A83E55259E217C6</span></span><br><span class="line"><span class="string">    DCF0E1B44B413DBEA08316525911179F</span></span><br><span class="line"><span class="string">    2F68E1B436413D51A083E5CF59E2769F</span></span><br><span class="line"><span class="string">    96F0E1B44B413DACA083AB5259EA179F</span></span><br><span class="line"><span class="string">    89F0E1B44B413DE7A0831C525944179F</span></span><br><span class="line"><span class="string">    42F0E1B44B413D1CA083D9525974179F</span></span><br><span class="line"><span class="string">    2FF07FB44B6E3D514683E55259E21747</span></span><br><span class="line"><span class="string">    17F0E1B44B413D6CA0838A5259F3179F</span></span><br><span class="line"><span class="string">    2FF069B44BAA3D510283E55259E21754</span></span><br><span class="line"><span class="string">    D8F0E1B44B413D36A0834452590B179F</span></span><br><span class="line"><span class="string">    8AF0E1B44B413D27A0839752591E179F</span></span><br><span class="line"><span class="string">    24F0E1B44B413DB1A0839C5259E9179F</span></span><br><span class="line"><span class="string">    2FF0E16A4B414151A0A4E55293E2179F</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.encode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">phoenixAES.crack_file(<span class="string">&#x27;tracefile&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>结果是：869D92BBB700D0D25BD9FD3E224B5DF2。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521170559877.png" alt="image-20250521170559877" style="zoom:80%;" />

<p>再用另一个大佬，从轮密钥还原原密钥。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/SideChannelMarvels/Stark">https://github.com/SideChannelMarvels/Stark</a></p>
<p>需要自己编译源代码，编译完后，还原原密钥！</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521181924901.png" alt="image-20250521181924901" style="zoom:80%;" />

<p>至此，成功把密钥DFA出来了，下面这个结果和Unidbg模拟的一模一样。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521182009136.png" alt="image-20250521182009136" style="zoom: 67%;" />

<h1 id="心得体会"><a href="#心得体会" class="headerlink" title="心得体会"></a>心得体会</h1><p>以下是我从这次分析中，认为自己需要加强的点：</p>
<p>1.学习绕过反调；（分析壳）</p>
<p>2.学习Unidbg的用法，包括hook、补环境、补系统调用等操作；（读相关博客等）</p>
<p>3.利用符号执行，去除控制流平坦化；</p>
<p>4.学习Binary ninja。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/19/%E5%AE%9E%E7%8E%B0%E5%AF%B9%E7%9B%AE%E6%A0%87%E5%87%BD%E6%95%B0%E8%A1%8C%E4%B8%BA%E5%88%86%E6%9E%90%E7%9A%84%E8%84%9A%E6%9C%AC%EF%BC%88frida%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/19/%E5%AE%9E%E7%8E%B0%E5%AF%B9%E7%9B%AE%E6%A0%87%E5%87%BD%E6%95%B0%E8%A1%8C%E4%B8%BA%E5%88%86%E6%9E%90%E7%9A%84%E8%84%9A%E6%9C%AC%EF%BC%88frida%EF%BC%89/" class="post-title-link" itemprop="url">实现对目标函数行为分析的脚本（frida）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-19 14:52:10 / 修改时间：14:53:47" itemprop="dateCreated datePublished" datetime="2025-05-19T14:52:10+08:00">2025-05-19</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>852</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Frida-BehaviorTrace"><a href="#Frida-BehaviorTrace" class="headerlink" title="Frida_BehaviorTrace"></a>Frida_BehaviorTrace</h1><p>场景：在native层遇到一个特别复杂的函数时，比方说被vmp保护的函数，若是难以通过静态分析工具去分析它的逻辑，那可以尝试hook一些libc的函数、JNI的函数观察它的行为。ps：这个脚本就做了这么一个事情。</p>
<h1 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h1><p>1.根据自己的需求，修改hook时机，当前脚本的hook时机是：linker64的call_constructor执行前。</p>
<p>2.选定完hook时机后，调用hook_main_target_function_for_tracing()。ps：我之所以选择在执行完sub_88060再执行，是因为sub_88060会对某些函数进行解密，请大家自行修改。</p>
<p>3.修改目标so和目标函数————修改TARGET_MODULE_NAME和TARGET_FUNCTION_OFFSET。</p>
<p>4.添加要关注的自定义函数的偏移————往CUSTOM_FUNCTION_OFFSETS添加想要关注的自定义函数。</p>
<p>5.添加要关注的libc的函数，修改参数解析的代码————往LIBC_FUNCTIONS_TO_HOOK添加要关注的libc函数，同时修改参数解析。</p>
<p>6.添加要关注的JNI函数，修改参数解析部分的代码———往函数hook_libart()中添加要关注的JNI函数，同样，注意修改参数解析。</p>
<p>7.启动脚本————frida -U -f &lt;包名&gt; -l trace_behavior.js</p>
<h1 id="使用案例"><a href="#使用案例" class="headerlink" title="使用案例"></a>使用案例</h1><p>比方说，我要追踪libbaiduprotect.so的sub_409E0，追踪它的行为。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519141642616.png" alt="image-20250519141642616"></p>
<p>sub_409E0调用了sub_29030、sub_290DC…还调用了一些JNI函数。</p>
<p>在我根据使用方法修改了脚本后，执行的效果是这样的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250519142250215.png" alt="image-20250519142250215"></p>
<p><strong>缩进</strong>代表函数调用的<strong>层级关系</strong>，这样子可以清晰看见目标函数执行了哪些<strong>自定义函数、Libc、JNI函数</strong>。</p>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>链接：<a target="_blank" rel="noopener" href="https://github.com/X14Nuy/Frida_BehaviorTrace">https://github.com/X14Nuy/Frida_BehaviorTrace</a></p>
<p>大模型真厉害，一下子把我的思路变成代码了，哈哈哈。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/unidbg%E5%88%9D%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/unidbg%E5%88%9D%E8%AF%86/" class="post-title-link" itemprop="url">unidbg初识</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:26:53 / 修改时间：17:31:41" itemprop="dateCreated datePublished" datetime="2025-05-18T17:26:53+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>18 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Frida和Unidbg最大的区别是，Unidbg是模拟程序执行，所以可以绕过检测，而Frida面临众多检测，需要学会反检测。</p>
<p>其实在理解了Unidbg的原理之后，它还蛮简单的。</p>
<h1 id="模拟层级"><a href="#模拟层级" class="headerlink" title="模拟层级"></a>模拟层级</h1><p>Unicorn模拟了底层cpu指令模拟，相当于一台裸机。当native代码调用到系统调用的指令（如x86的syscall、arch64的svc等），会将这些触发转发给AndroidEmulator进行处理。</p>
<p>AndroidEmulator主要负责<strong>模拟安卓环境和系统环境</strong>和<strong>JNI交互</strong>，除此之外，它还负责处理Unicorn转发而来的<strong>系统调用</strong>。</p>
<h1 id="补环境实例讲解"><a href="#补环境实例讲解" class="headerlink" title="补环境实例讲解"></a>补环境实例讲解</h1><p>可以观察下面的一个需要<strong>补环境</strong>的代码。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">example</span>.<span class="property">luodst</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">AndroidEmulator</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">LibraryResolver</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">Module</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">arm</span>.<span class="property">backend</span>.<span class="property">Unicorn2Factory</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">linux</span>.<span class="property">android</span>.<span class="property">AndroidEmulatorBuilder</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">linux</span>.<span class="property">android</span>.<span class="property">AndroidResolver</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">linux</span>.<span class="property">android</span>.<span class="property">dvm</span>.*;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">linux</span>.<span class="property">android</span>.<span class="property">dvm</span>.<span class="property">array</span>.<span class="property">ByteArray</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">memory</span>.<span class="property">Memory</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">github</span>.<span class="property">unidbg</span>.<span class="property">virtualmodule</span>.<span class="property">android</span>.<span class="property">AndroidModule</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">File</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">IOException</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">UnsupportedEncodingException</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">sql</span>.<span class="property">SQLOutput</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">ArrayList</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">Enumeration</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">List</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">zip</span>.<span class="property">ZipEntry</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">zip</span>.<span class="property">ZipFile</span>;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_ inherited__">AbstractJni</span> &#123;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="params"><span class="built_in">String</span>[] args</span>) &#123;</span><br><span class="line">        <span class="title class_">MainActivity</span> mainActivity = <span class="keyword">new</span> <span class="title class_">MainActivity</span>();</span><br><span class="line">        mainActivity.<span class="title function_">getHash</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 模拟器创建</span></span><br><span class="line">    private final <span class="title class_">AndroidEmulator</span> emulator;</span><br><span class="line">    <span class="comment">// 创建java虚拟机</span></span><br><span class="line">	private final <span class="variable constant_">VM</span> vm;</span><br><span class="line"></span><br><span class="line">    private final <span class="title class_">Module</span> <span class="variable language_">module</span>;</span><br><span class="line"></span><br><span class="line">    private <span class="title class_">MainActivity</span>() &#123;</span><br><span class="line">        <span class="comment">//1.创建Android模拟器实例</span></span><br><span class="line">        emulator = <span class="title class_">AndroidEmulatorBuilder</span></span><br><span class="line">                .<span class="title function_">for32Bit</span>() <span class="comment">// 32位虚拟机</span></span><br><span class="line">                .<span class="title function_">addBackendFactory</span>(<span class="keyword">new</span> <span class="title class_">Unicorn2Factory</span>(<span class="literal">true</span>)) <span class="comment">// 选择指令集，相当于选择哪台裸机，默认是unicorn</span></span><br><span class="line">                .<span class="title function_">setRootDir</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/com/example/luodst/rootfs&quot;</span>)) <span class="comment">// 设置文件系统根目录</span></span><br><span class="line">                .<span class="title function_">build</span>(); <span class="comment">// 创建</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.获取操作内存的接口</span></span><br><span class="line">        <span class="title class_">Memory</span> memory = emulator.<span class="title function_">getMemory</span>();</span><br><span class="line">        <span class="comment">//3.设置Android SDK 版本</span></span><br><span class="line">        <span class="title class_">LibraryResolver</span> resolver = <span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>);</span><br><span class="line">        memory.<span class="title function_">setLibraryResolver</span>(resolver); <span class="comment">// 加载sdk里的java类（可能会添加hook）</span></span><br><span class="line">        <span class="comment">//4.创建java虚拟机，导入apk文件</span></span><br><span class="line">        vm = emulator.<span class="title function_">createDalvikVM</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/com/example/luodst/files/DogPro.apk&quot;</span>));</span><br><span class="line">        <span class="comment">//5.是否打印日志</span></span><br><span class="line">        vm.<span class="title function_">setVerbose</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//6.将自定义的JNI处理逻辑绑定到java虚拟机上</span></span><br><span class="line">        vm.<span class="title function_">setJni</span>(<span class="variable language_">this</span>);</span><br><span class="line">        <span class="comment">// 为java环境模拟器和java虚拟机注册内存</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AndroidModule</span>(emulator, vm).<span class="title function_">register</span>(memory);</span><br><span class="line">        <span class="comment">//7.加载目标so文件，true主动执行init init_array</span></span><br><span class="line">        <span class="title class_">DalvikModule</span> dm = vm.<span class="title function_">loadLibrary</span>(<span class="string">&quot;dogpro&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//8.将so文件对应的Module存入成员变量</span></span><br><span class="line">        <span class="variable language_">module</span> = dm.<span class="title function_">getModule</span>();</span><br><span class="line">        <span class="comment">//9.主动调用JNI_OnLoad</span></span><br><span class="line">        dm.<span class="title function_">callJNI_OnLoad</span>(emulator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="keyword">void</span> <span class="title function_">getHash</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">DvmObject</span>&lt;?&gt; dvmObject = vm.<span class="title function_">resolveClass</span>(<span class="string">&quot;com/example/dogpro/MainActivity&quot;</span>).<span class="title function_">newObject</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;dvmObject = &quot;</span>+ dvmObject.<span class="title function_">toString</span>());</span><br><span class="line">        <span class="title class_">String</span> input = <span class="string">&quot;unidbg-android/src/test/java/com/example/luodst/files/DogPro.apk&quot;</span>;</span><br><span class="line">        <span class="title class_">DvmObject</span>&lt;?&gt; ret = dvmObject.<span class="title function_">callJniMethodObject</span>(emulator, <span class="string">&quot;getHash(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, input);</span><br><span class="line">        <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;result ==&gt; &quot;</span>+ret.<span class="title function_">getValue</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以这么理解Unidbg补环境的过程，so文件作为elf二进制代码，可以在unicorn上面跑，但一些JNI函数，他们的参数列表需要JNI类型的数据，有时候甚至要调用一些Java层的函数（java层给native层数据时，数据类型是JNI类型），而Unidbg就是负责处理JNI交互的。</p>
<p>Unidbg有自己的一套JNI类型，其内置的Java虚拟机中还内置了很多自定义的<strong>基本类型、引用类型</strong>的数据结果，如：外部虚拟机中的String类型，在Unidbg中是StringObject类型；外部的int、boolean类型，是Unidbg中的DvmInteger和DvmBoolean；除此之外，大部分引用类型在Unidbg都视作DvmClass类型（继承于DvmObject&lt;?&gt;类型），这些引用类型的对象都属于DvmObject&lt;?&gt;类型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DvmObject&lt;?&gt;：这是 Unidbg 中所有 Java 对象的基类，类似于真实 JVM 中的 java.lang.Object。它是一个泛型类，DvmObject&lt;T&gt; 的 T 通常表示对应的真实 Java 类型。例如，DvmObject&lt;String&gt; 表示一个 String 类型的对象。</span><br><span class="line">DvmClass：表示 Java 中的类对象（java.lang.Class 的模拟）。在 Unidbg 中，DvmClass 继承自 DvmObject&lt;Class&lt;?&gt;&gt;，用来表示类的元信息（如类名、方法、字段等）。</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250320093443037.png" alt="image-20250320093443037"></p>
<p>一般情况下，不需要补环境，是因为unidbg的虚拟机中内置了很多DvmClass（解析于SDK），也内置了很多自己的处理函数，操作这些DvmObject&lt;?&gt;，但遇到一些尚未解析的DvmClass或者无法解析的DvmClass的函数，就会抛出错误，这个时候就需要为它补环境了。</p>
<p>补环境的过程如下，简单来说，就是内置的类与函数不够用了，转而使用外部java虚拟机的类与函数，只将结果转换成DvmObject&lt;?&gt;返回给内部虚拟机。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250320094827973.png" alt="image-20250320094827973" style="zoom: 67%;" />

<p>举个例子，下面这个报错是无法处理ZipFile的构造函数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250320093822376.png" alt="image-20250320093822376"></p>
<p>一直定位追踪到下面这个函数，会发现没有针对于ZipFile类型的构造函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; newObjectV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/io/ByteArrayInputStream-&gt;&lt;init&gt;([B)V&quot;</span>: &#123;</span><br><span class="line">            <span class="type">ByteArray</span> <span class="variable">array</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">assert</span> array != <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;java/io/ByteArrayInputStream&quot;</span>).newObject(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(array.value));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/lang/String-&gt;&lt;init&gt;([B)V&quot;</span>: &#123;</span><br><span class="line">            <span class="type">ByteArray</span> <span class="variable">array</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">assert</span> array != <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="keyword">new</span> <span class="title class_">String</span>(array.value));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/lang/String-&gt;&lt;init&gt;([BLjava/lang/String;)V&quot;</span>: &#123;</span><br><span class="line">            <span class="type">ByteArray</span> <span class="variable">array</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">assert</span> array != <span class="literal">null</span>;</span><br><span class="line">            <span class="type">StringObject</span> <span class="variable">charsetName</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">assert</span> charsetName != <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm, <span class="keyword">new</span> <span class="title class_">String</span>(array.value, charsetName.value));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;javax/crypto/spec/SecretKeySpec-&gt;&lt;init&gt;([BLjava/lang/String;)V&quot;</span>:&#123;</span><br><span class="line">            <span class="type">byte</span>[] key = (<span class="type">byte</span>[]) vaList.getObjectArg(<span class="number">0</span>).value;</span><br><span class="line">            <span class="type">StringObject</span> <span class="variable">algorithm</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">assert</span> algorithm != <span class="literal">null</span>;</span><br><span class="line">            <span class="type">SecretKeySpec</span> <span class="variable">secretKeySpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(key, algorithm.value);</span><br><span class="line">            <span class="keyword">return</span> dvmClass.newObject(secretKeySpec);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/lang/Integer-&gt;&lt;init&gt;(I)V&quot;</span>: &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> vaList.getIntArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> DvmInteger.valueOf(vm, i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/lang/Boolean-&gt;&lt;init&gt;(Z)V&quot;</span>:&#123;</span><br><span class="line">            <span class="type">boolean</span> b;</span><br><span class="line">            b = vaList.getIntArg(<span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> DvmBoolean.valueOf(vm, b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(signature);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个时候就需要为它补环境了，如何补呢？这里的ZipFile并不是基本数据类型，在项目中也没有为它进行解析。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250320095402681.png" alt="image-20250320095402681" style="zoom:67%;" />

<p>因此需要将这个ZipFile类型解析到Unidbg的虚拟机中，再为它创建一个对象进行返回。</p>
<p>下面的代码中，vm.resolveClass负责解析ZipFile类，此时ZipFile类光荣的加入了Unidbg的虚拟机中，并重新定义为DvmObject&lt;ZipFile&gt;类，newObject返回了一个Unidbg内置的DvmObject&lt;ZipFile&gt;类对象。</p>
<p>这样便解解决了一个环境问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> DvmObject&lt;?&gt; newObjectV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;</span><br><span class="line">       <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;java/util/zip/ZipFile-&gt;&lt;init&gt;(Ljava/lang/String;)V&quot;</span>: &#123;</span><br><span class="line">               <span class="comment">// 正确提取 String 参数</span></span><br><span class="line">               <span class="type">StringObject</span> <span class="variable">pathObj</span> <span class="operator">=</span> vaList.getObjectArg(<span class="number">0</span>); <span class="comment">// 内部虚拟机的String</span></span><br><span class="line">               <span class="keyword">assert</span> pathObj != <span class="literal">null</span>;</span><br><span class="line">               <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> pathObj.getValue(); <span class="comment">// 获取实际java类型的String</span></span><br><span class="line"></span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="comment">// 创建虚拟的 ZipFile 对象（需提前在虚拟文件系统中补文件）</span></span><br><span class="line">                   <span class="type">ZipFile</span> <span class="variable">zipFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipFile</span>(filePath);</span><br><span class="line">                   <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;java/util/zip/ZipFile&quot;</span>).newObject(zipFile);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">super</span>.newObjectV(vm, dvmClass, signature, vaList);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>还有一个补环境的例子，下面是报错，报错理由是缺少ZipFile的entries操作。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.UnsupportedOperationException: java/util/zip/ZipFile-&gt;entries()Ljava/util/Enumeration;</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodV(DvmMethod.java:89)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.DalvikVM$32.handle(DalvikVM.java:553)</span><br></pre></td></tr></table></figure>

<p>一开始的补法是这样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/util/zip/ZipFile-&gt;entries()Ljava/util/Enumeration;&quot;</span>: &#123;</span><br><span class="line">            <span class="comment">//拿操作的对象</span></span><br><span class="line">            <span class="type">ZipFile</span> <span class="variable">zipFile</span> <span class="operator">=</span> (ZipFile) dvmObject.getValue();</span><br><span class="line">            <span class="comment">//通过对象来调用方法</span></span><br><span class="line">            Enumeration&lt;? <span class="keyword">extends</span> <span class="title class_">ZipEntry</span>&gt; entries =  zipFile.entries();</span><br><span class="line">            <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;java/util/Enumeration&quot;</span>).newObject(entries);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但之后仍会报错，提示无法将DvmObject转换为Enumeration，为什么会出现这个问题？其实DvmObject&lt;Enumeration&gt;是我们补的一个类，但Unidbg中内置了一个Enumeration类，这个类不应该补的，因为负责与与native层交互的内置虚拟机，它默认是转换内置的Enumeration &#x3D;&gt; JNI类型，而我们导入的这个类型会被忽视。</p>
<p>虽然如此，但return的这个对象很重要，这是我们通过外部虚拟机，要返回给内部虚拟机的一个Enumeration对象，如果我们返回的是它内置的com.github.unidbg.linux.android.dvm.Enumeration就没任何事，因为这是它缺少的对象，但我们返回的是com.github.unidbg.linux.android.dvm.DvmObject&lt;Enumeration&gt;，对象不一致，就要强转了，然后失败了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ClassCastException: class com.github.unidbg.linux.android.dvm.DvmObject cannot be cast to class com.github.unidbg.linux.android.dvm.Enumeration (com.github.unidbg.linux.android.dvm.DvmObject and com.github.unidbg.linux.android.dvm.Enumeration are in unnamed module of loader &#x27;app&#x27;)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:610)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:603)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.DvmMethod.callBooleanMethodV(DvmMethod.java:119)</span><br><span class="line">	at com.github.unidbg.linux.android.dvm.DalvikVM$35.handle(DalvikVM.java:630)</span><br></pre></td></tr></table></figure>

<p>我的分析得到了grok的认可，哈哈哈哈。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250320101751847.png" alt="image-20250320101751847"></p>
<p>既然这样补不对，就需要看内置的Enumeration是如何创建的，可以看到，内置的Enumeration实现的俩函数，不过这里不是重点，重点是如何创建一个Enumeration对象。</p>
<p>通过构造函数，可以看到，需要输入一个外部java中的List对象，对象里的元素是DvmObject对象即可。</p>
<p>因此，我们需要创建一个List，然后把ZipFile对象里元素的类型（即ZipEntry）转换成DvmObject&lt;ZipEntry&gt;，然后再放入List中。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250320101923116.png" alt="image-20250320101923116" style="zoom: 67%;" />

<p>这样就算补好了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;java/util/zip/ZipFile-&gt;entries()Ljava/util/Enumeration;&quot;</span>: &#123;</span><br><span class="line">            <span class="type">ZipFile</span> <span class="variable">zipFile</span> <span class="operator">=</span> (ZipFile) dvmObject.getValue();</span><br><span class="line">            Enumeration&lt;? <span class="keyword">extends</span> <span class="title class_">ZipEntry</span>&gt; entries =  zipFile.entries();</span><br><span class="line">            <span class="comment">//return vm.resolveClass(&quot;java/util/Enumeration&quot;).newObject(entries);</span></span><br><span class="line">            List&lt;DvmObject&lt;?&gt;&gt; objs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">while</span> (entries.hasMoreElements())&#123;</span><br><span class="line">                <span class="type">ZipEntry</span> <span class="variable">zipEntry</span> <span class="operator">=</span> entries.nextElement();</span><br><span class="line">                objs.add(vm.resolveClass(<span class="string">&quot;java/util/zip/ZipEntry&quot;</span>).newObject(zipEntry));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">com</span>.github.unidbg.linux.android.dvm.Enumeration(vm, objs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="追踪读写"><a href="#追踪读写" class="headerlink" title="追踪读写"></a>追踪读写</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 监控读写 */</span></span><br><span class="line">emulator.traceRead(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base + <span class="keyword">module</span>.size);</span><br><span class="line">emulator.traceWrite(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base + <span class="keyword">module</span>.size);</span><br></pre></td></tr></table></figure>

<h1 id="读取内存"><a href="#读取内存" class="headerlink" title="读取内存"></a>读取内存</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 读取内存 */</span></span><br><span class="line">long targetAddr = <span class="variable language_">module</span>.<span class="property">base</span> + <span class="number">0xE0320</span>;</span><br><span class="line"><span class="title class_">UnidbgPointer</span> ptr = <span class="title class_">UnidbgPointer</span>.<span class="title function_">pointer</span>(emulator, targetAddr);</span><br><span class="line">byte[] data = ptr.<span class="title function_">getByteArray</span>(<span class="number">0</span>, <span class="number">0xC0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Inspector</span>.<span class="title function_">inspect</span>(data, <span class="string">&quot;Dumped Memory at 0x&quot;</span> + <span class="title class_">Long</span>.<span class="title function_">toHexString</span>(targetAddr));</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/%E7%AE%97%E6%B3%95%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E5%88%9D%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/%E7%AE%97%E6%B3%95%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E5%88%9D%E8%AF%86/" class="post-title-link" itemprop="url">算法逆向分析初识</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:23:57 / 修改时间：17:32:44" itemprop="dateCreated datePublished" datetime="2025-05-18T17:23:57+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="hellojni-2-0-7-apk"><a href="#hellojni-2-0-7-apk" class="headerlink" title="hellojni_2.0.7.apk"></a>hellojni_2.0.7.apk</h1><p>目标：还原signs的加密算法。</p>
<p>点击SIGN2按钮后，下面这个签名会发生改变。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414145949279.png" alt="image-20250414145949279" style="zoom:67%;" />

<p>通过定位，发现这个签名是由JNI函数<strong>Java_com_example_hellojni_HelloJni_sign2</strong>生成的。</p>
<p>进一步，对其中的sub_1CFF0进行hook，发现其第3个参数（从1开始算）便是签名。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414150401970.png" alt="image-20250414150401970" style="zoom:67%;" />

<p>hook的代码如下，将其中的addr赋值为<strong>1CFF0</strong>即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_find_target_address</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> base = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libhello-jni.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nlibhello-jni.so Baseaddr: &quot;</span> + base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> target_addr = base.<span class="title function_">add</span>(addr);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nTarget Address: &quot;</span> + target_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hook并打印参数和返回值</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nsub_&quot;</span> + addr.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;args: &quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\ninput_str: \r\n&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\ninput_str_length: &quot;</span> + <span class="variable language_">this</span>.<span class="property">arg1</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">onLeave</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\noutput_str: \r\n&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg2</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印的结果如下图所示。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414150622333.png" alt="image-20250414150622333" style="zoom:80%;" />

<p>为了方便分析，这里需要将input_str和input_str_length进行固定。</p>
<p>如图所示，我将输入字符串固定为”1234567890abcdefg”。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_find_target_address</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> base = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libhello-jni.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nlibhello-jni.so Baseaddr: &quot;</span> + base);</span><br><span class="line">    <span class="keyword">var</span> target_addr = base.<span class="title function_">add</span>(addr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nTarget Address: &quot;</span> + target_addr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// hook并打印参数和返回值</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_addr, &#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="comment">// 保存原始参数值以便打印</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\nsub_&quot;</span> + addr.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; args: &quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\n原始input_str: \r\n&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>, &#123; <span class="attr">length</span>: <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>) &#125;));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\ninput_str_length: &quot;</span> + <span class="variable language_">this</span>.<span class="property">arg1</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 新字符串</span></span><br><span class="line">            <span class="keyword">var</span> new_str = <span class="string">&quot;1234567890abcdefg&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 方法1：直接写入内存</span></span><br><span class="line">            <span class="title class_">Memory</span>.<span class="title function_">writeUtf8String</span>(args[<span class="number">0</span>], new_str);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 方法2：如果需要写入二进制数据而不是UTF8字符串</span></span><br><span class="line">            <span class="comment">// var bytes = [0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x00]; // &quot;1234567890abcdef\0&quot;</span></span><br><span class="line">            <span class="comment">// Memory.writeByteArray(args[0], bytes);</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> length = new_str.<span class="property">length</span>;</span><br><span class="line">            args[<span class="number">1</span>] = <span class="title function_">ptr</span>(length);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">args1</span> = args[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\n修改后的长度: &quot;</span> + <span class="variable language_">this</span>.<span class="property">args1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\n修改后input_str: \r\n&quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">0</span>], &#123; <span class="attr">length</span>: <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">args1</span>) &#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">onLeave</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\r\noutput_str: \r\n&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg2</span>, &#123; <span class="attr">length</span>: <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">args1</span>) &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414153532777.png" alt="image-20250414153532777" style="zoom:80%;" />

<p>在确保了输入字符串不变后，尝试使用IDA的trace，追踪函数sub_1CFF0。</p>
<p>先注入frida、再注入IDA server——似乎不按这个顺序，先注入IDA再注入Frida，Frida会注入失败。</p>
<p>我决定先退出Frida的hook，再进行追踪，因为我发现Frida要是已经hook了sub_1CFF0，在sub_1CFF0的函数开始的地方，会存在inline hook，跳转到Frida的跳床函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414153913051.png" alt="image-20250414153913051" style="zoom:80%;" />

<p>通过IDA trace，走过的汇编指令会变成黄色。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414154156636.png" alt="image-20250414154156636"></p>
<p>追踪到的内容如下图所示，第一栏的36EE是线程id，第二栏是地址，第三栏开始就是汇编指令了，如果汇编指令修改了寄存器，则会在汇编指令后面，显示寄存器被修改后的值。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414154332639.png" alt="image-20250414154332639"></p>
<p>之后，我重新生成了一个trace记录，并记录了一下签名值。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414162840995.png" alt="image-20250414162840995" style="zoom: 50%;" />

<p>之后进行算法逆向。</p>
<p>已知算法的输入是input_str &#x2F; input_str_length &#x2F; output_str，分别代表着X0、X1、X2。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414164247587.png" alt="image-20250414164247587"></p>
<p>因为X2代表着output_str的内存地址，所以追踪X2，判断有哪些指令对地址0x00000079E1720D90上的内容进行了修改。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414164543132.png" alt="image-20250414164543132" style="zoom:80%;" />

<p>查找到了34个对0x00000079E1720D90进行读写的位置。</p>
<p>对其中一些指令进行还原，可以猜到。</p>
<p>X8代表：当前正在操作output的第X8个字节，也代表循环次数；</p>
<p>X5代表output的内存地址；</p>
<p>X29[var_64]是一个固定字节数组。</p>
<p>X29[var_68]也是一个固定字节数组。</p>
<p>至于var_6C，最后还是追踪到var_68上。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250414190420796.png" alt="image-20250414190420796"></p>
<p>做了一些补充。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250415094520831.png" alt="image-20250415094520831"></p>
<p>一直追踪[X29,#var_64]。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250415094627344.png" alt="image-20250415094627344"></p>
<p>而一直追踪[X29,#var_68]，会发现需要追踪X2，继而追踪X2和X3，继而追踪X3和X7……</p>
<p>最后追踪到[X29,#var_88]。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250415094751043.png" alt="image-20250415094751043"></p>
<p>最后发现，var_88这个变量是一个指针，它将地址给了X2，由X2去获取全局变量，也就是图中的xmmword_79A31EE7B0。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250415095055847.png" alt="image-20250415095055847"></p>
<p>至此，可以将全局变量及涉及到的寄存器改写成c。</p>
<p>(解密的时候前8个字节和后8个字节的处理方式不同，可能还得逆，这里我直接贴别人逆好的代码)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">enc_function</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* input_str, <span class="type">int</span> input_len, <span class="type">char</span>* result)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* table_key1 = <span class="string">&quot;9d9107e02f0f07984956767ab1ac87e5&quot;</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> table_key2[] = &#123;<span class="number">0x37</span>, <span class="number">0x92</span>, <span class="number">0x44</span>, <span class="number">0x68</span>, <span class="number">0xA5</span>, <span class="number">0x3D</span>, <span class="number">0xCC</span>, <span class="number">0x7F</span>, <span class="number">0xBB</span>, <span class="number">0xF</span>, <span class="number">0xD9</span>, <span class="number">0x88</span>, <span class="number">0xEE</span>, <span class="number">0x9A</span>, <span class="number">0xE9</span>, <span class="number">0x5A</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; input_len; ++i) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> X2 = input_str[i];</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> key2 = table_key2[(i &amp; <span class="number">0xF</span>) &amp; <span class="number">0xFFFFFFFF</span>];</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W8 = <span class="number">0xDA</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W30 = <span class="number">0x25</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W2 = X2;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W7 = W8 &amp; (~W2);</span><br><span class="line">        W2 = W2 &amp; <span class="number">0x25</span>;</span><br><span class="line">        W2 = W7 | W2;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W3 = key2;</span><br><span class="line">        W7 = W8 &amp; (~W3);</span><br><span class="line">        W3 = W3 &amp; W30;</span><br><span class="line">        W3 = W7 | W3;</span><br><span class="line">        W2 = W2 ^ W3;</span><br><span class="line">        W3 = W2;</span><br><span class="line"></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> key1 = table_key1[(i ^ <span class="number">0xFFFFFFF8</span>) &amp; i ];</span><br><span class="line">        W2 = key1;</span><br><span class="line">        W7 = key2;</span><br><span class="line">        W30 = key2;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W1 = W2 &amp; (~W3);</span><br><span class="line">        W3 = W3 &amp; (~W2);</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> W5 = W30 &amp; (~W2);</span><br><span class="line">        W2 = W2 &amp; (~W30);</span><br><span class="line">        W1 = W1 | W3;</span><br><span class="line">        W2 = W5 | W2;</span><br><span class="line">        W1 = W1 + W7;</span><br><span class="line">        W3 = W1 &amp; (~W2);</span><br><span class="line">        W1 = W2 &amp; (~W1);</span><br><span class="line">        W1 = W3 | W1;</span><br><span class="line">        result[i] = W1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">test_eq</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* buf1, <span class="type">const</span> <span class="type">char</span>* buf2, <span class="type">int</span> buf_len)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; buf_len; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (buf1[i] != buf2[i]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* input = <span class="string">&quot;0123456789abcdef0123456789abcdef&quot;</span>;</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(input);</span><br><span class="line">    <span class="type">char</span>* result = (<span class="type">char</span>*)<span class="built_in">malloc</span>(len);</span><br><span class="line">    <span class="built_in">memset</span>(result, <span class="number">0</span>, len);</span><br><span class="line">    enc_function(input, len, result);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02x&quot;</span>, (<span class="type">unsigned</span> <span class="type">char</span>)result[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\r\n%x&quot;</span>, test_eq(result, result, len));</span><br><span class="line">    <span class="built_in">free</span>(result);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/%E6%9F%90%E7%93%A3%E5%AD%97%E6%AE%B5-sig%E7%9A%84%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/%E6%9F%90%E7%93%A3%E5%AD%97%E6%AE%B5-sig%E7%9A%84%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">某瓣字段_sig的分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:21:48 / 修改时间：17:32:22" itemprop="dateCreated datePublished" datetime="2025-05-18T17:21:48+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>14k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>25 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="豆瓣"><a href="#豆瓣" class="headerlink" title="豆瓣"></a>豆瓣</h1><h2 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h2><p>先了解如何抓包，这次尝试分析某个参数的加解密过程。</p>
<p>工具是：Charles 4.6.3。</p>
<p>抓包的配置方式如下：</p>
<p>1.将pc和op放在同一局域网下，pc上打开Charles，设置Proxy-&gt;Proxy Settings，填写端口并勾选，如下图所示。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310103644735.png" alt="image-20250310103644735" style="zoom:50%;" />

<p>2.之后在op上，设置网络的代理，将手机的流量转发到手机的9999端口。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310103929125.png" alt="image-20250310103929125" style="zoom:67%;" />

<p>3.为pc和手机装Charles的root证书，用于CA自签名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310104014250.png" alt="image-20250310104014250"></p>
<p>由于手机端的证书对文件名有要求，这个文件名需要通过计算获得，计算可以通过<code>openssl x509 -subject_hash_old -in &lt;证书&gt;</code>获得，下图是网图，它最后得到的文件名就是5cba21f7，然后后缀固定为.0，所以就是<code>5cba21f7.0</code>。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310104324383.png" alt="image-20250310104324383"></p>
<p>4.在安卓7以上的版本，app只接受系统证书，不接受用户证书，所以需要将证书移至&#x2F;system&#x2F;etc&#x2F;security&#x2F;cacerts，之后重启手机。</p>
<p>5.之后如图所示，设置ssl代理。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310104618901.png" alt="image-20250310104618901"></p>
<p>之后就可以抓到包了。——上面只考虑了单向认证，如果是双向认证，有些app的包还是会显示unknown，那就要将app的证书和密钥填写至Charles中了，不过豆瓣是单向认证。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>根据访问不同的域名，进行区别。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310150823254.png" alt="image-20250310150823254" style="zoom:67%;" />

<p>其中，参数_sig是请求签名，用于验证请求的完整性和合法性，通常由参数和密钥计算得出。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310150909829.png" alt="image-20250310150909829"></p>
<p>这次要分析的就是如何得到这个_sig。——抓几次包，会发现每次发包的header中，就_sig的值一直在变化，所以如果想要写脚本来发包，伪造客户端，就要解决_sig构造的问题。</p>
<p>通过搜索<code>&quot;_sig&quot;</code>，似乎找到了为<code>_sig</code>赋值的地方，将pair0.first经过一些规则（HTTP的规范）后，作为值赋给_sig。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310151822183.png" alt="image-20250310151822183"></p>
<p>在setQueryParameter中会检查s是否为空，如果已存在，还会把它移除，重新进行签名。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250310155727702.png" alt="image-20250310155727702"></p>
<p>之后，我想hook上面的函数，结果遇到了frida检测。</p>
<p>这次frida检测，我学到了以下几点：</p>
<p>1.frida用旧一些的版本，最新的可能不稳定；</p>
<p>2.把握好hook的时机，Interceptor.attach和Interceptor.replace的执行方式不同。attach是设置监控，监控目标地址，当执行到目标地址，才会启动对应的脚本内容；而replace是对目标地址立马进行替换，如果目标地址所在的模块尚未加载，会执行失败。</p>
<p>以下是grok的回答。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">什么是“Hook 陷阱”？</span><br><span class="line"></span><br><span class="line">“Hook 陷阱”并不是一个官方术语，而是形象地描述了 Frida 在特定时机设置 Hook 的工作方式。简单来说，它就像在目标函数的调用路径上“埋下一个陷阱”，等待程序运行到那个位置时触发，而不是立即执行 Hook 逻辑。</span><br><span class="line"></span><br><span class="line">在 Frida 中，Hook 的实现主要通过 Interceptor 模块完成：</span><br><span class="line"></span><br><span class="line"><span class="code">    Interceptor.attach：附加到目标函数的入口和出口，分别在函数调用前（onEnter）和调用后（onLeave）执行自定义逻辑。</span></span><br><span class="line"><span class="code">    Interceptor.replace：直接替换目标函数的实现，用你定义的函数逻辑覆盖原始函数。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">“陷阱”的关键在于时机：</span><br><span class="line"></span><br><span class="line"><span class="code">    Hook 的设置（比如调用 Interceptor.attach 或 Interceptor.replace）是在你的 Frida JS 脚本运行时完成的。</span></span><br><span class="line"><span class="code">    Hook 的触发（比如执行 onEnter 或替换后的函数逻辑）则是在目标函数被实际调用时发生的。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">举个例子：</span><br><span class="line">javascript</span><br><span class="line">Interceptor.attach(Module.getExportByName(&#x27;libc.so&#x27;, &#x27;open&#x27;), &#123;</span><br><span class="line"><span class="code">    onEnter: function(args) &#123;</span></span><br><span class="line"><span class="code">        console.log(&#x27;open 被调用了！&#x27;);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">&#125;);</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    脚本运行时，Interceptor.attach 会“设置陷阱”，告诉 Frida 监控 open 函数。</span></span><br><span class="line"><span class="code">    但 onEnter 里的 console.log 并不会立即执行，而是等到程序调用 open 时才打印日志。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">这种“等待触发”的机制就是“Hook 陷阱”的核心。</span><br><span class="line">替换函数的时机：脚本运行后会第一时间替换吗？</span><br><span class="line"></span><br><span class="line">你提到：“将脚本跑起来后，它难道不是第一时间将 Native 层函数替换掉吗？”答案是不完全是。让我们详细分析一下。</span><br><span class="line">Frida 替换函数的工作原理</span><br><span class="line"></span><br><span class="line">使用 Interceptor.replace 可以替换 Native 层函数的实现。例如：</span><br><span class="line">javascript</span><br><span class="line">Interceptor.replace(ptr(&#x27;0x12345678&#x27;), new NativeCallback(function() &#123;</span><br><span class="line"><span class="code">    console.log(&#x27;函数被替换了！&#x27;);</span></span><br><span class="line"><span class="code">    return 0;</span></span><br><span class="line"><span class="code">&#125;, &#x27;int&#x27;, []));</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    当脚本执行到 Interceptor.replace 时，Frida 会尝试将目标函数的地址替换为你的自定义函数。</span></span><br><span class="line"><span class="code">    但这有一个前提：目标函数所在的模块必须已经加载到内存中。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">时机的影响因素</span><br><span class="line"></span><br><span class="line"><span class="code">    模块是否已加载</span></span><br><span class="line"><span class="code">        如果你在脚本运行时要替换的函数属于某个动态加载的 .so 文件（比如 libexample.so），而这个文件在脚本启动时尚未加载，Frida 无法立即替换。</span></span><br><span class="line"><span class="code">        因为 Frida 需要知道模块的基址和函数的偏移量。如果 Process.findModuleByName(&#x27;libexample.so&#x27;) 返回 null，你就无法计算目标函数的地址，替换自然无法生效。</span></span><br><span class="line"><span class="code">    动态加载的场景</span></span><br><span class="line"><span class="code">        在 Android 中，很多 .so 文件是通过 dlopen（或 android_dlopen_ext）动态加载的。</span></span><br><span class="line"><span class="code">        如果你的目标函数在某个动态加载的模块中，你需要在模块加载后再执行替换操作。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">实际例子：你的代码可能的样子</span><br><span class="line"></span><br><span class="line">假设你想替换 libmsaoaidsec.so 中的某个函数 sub<span class="emphasis">_1b924，代码可能是这样的：</span></span><br><span class="line"><span class="emphasis">javascript</span></span><br><span class="line"><span class="emphasis">function hook_</span>sub<span class="emphasis">_1b924() &#123;</span></span><br><span class="line"><span class="emphasis">    let module = Process.findModuleByName(&#x27;libmsaoaidsec.so&#x27;);</span></span><br><span class="line"><span class="emphasis">    if (module) &#123;</span></span><br><span class="line"><span class="emphasis">        let sub_</span>1b924 = module.base.add(0x1b924);</span><br><span class="line"><span class="code">        Interceptor.replace(sub_1b924, new NativeCallback(function() &#123;</span></span><br><span class="line"><span class="code">            console.log(&#x27;sub_1b924 被替换了！&#x27;);</span></span><br><span class="line"><span class="code">            return 0;</span></span><br><span class="line"><span class="code">        &#125;, &#x27;int&#x27;, []));</span></span><br><span class="line"><span class="code">    &#125; else &#123;</span></span><br><span class="line"><span class="code">        console.log(&#x27;模块尚未加载！&#x27;);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">&#125;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    如果脚本运行时 libmsaoaidsec.so 还没加载，module 会是 null，替换不会生效。</span></span><br><span class="line"><span class="code">    你需要等待模块加载完成后再调用 hook_sub_1b924()。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">为什么不直接在脚本运行时替换？</span><br><span class="line"></span><br><span class="line">你可能会疑惑：为什么不直接在脚本启动时就完成所有替换？原因有以下几点：</span><br><span class="line"></span><br><span class="line"><span class="code">    模块未加载的问题</span></span><br><span class="line"><span class="code">        如上所述，如果目标模块没加载，Frida 无法找到函数地址，替换会失败。</span></span><br><span class="line"><span class="code">        解决办法是监控模块加载过程（比如 Hook android_dlopen_ext），在模块加载后再执行替换。</span></span><br><span class="line"><span class="code">    初始化逻辑的依赖</span></span><br><span class="line"><span class="code">        有些 .so 文件在加载后会执行初始化逻辑（比如通过 soinfo::call_constructors() 调用 .init 或 .init_array）。</span></span><br><span class="line"><span class="code">        如果你在初始化前替换函数，可能会干扰模块的正常初始化（比如反调试、校验逻辑），导致程序崩溃或行为异常。</span></span><br><span class="line"><span class="code">        通过在初始化开始前（比如 call_constructors 的 onEnter）替换函数，你可以更安全地介入。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">例如，一个常见的策略是：</span><br><span class="line">javascript</span><br><span class="line">Interceptor.attach(Module.getExportByName(&#x27;libdl.so&#x27;, &#x27;android<span class="emphasis">_dlopen_</span>ext&#x27;), &#123;</span><br><span class="line"><span class="code">    onEnter: function(args) &#123;</span></span><br><span class="line"><span class="code">        this.onLeave = function(retval) &#123;</span></span><br><span class="line"><span class="code">            hook_sub_1b924(); // 在模块加载后替换函数</span></span><br><span class="line"><span class="code">        &#125;;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">&#125;);</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    这里在 android_dlopen_ext 调用后（模块加载完成时）再执行替换，确保时机正确。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">总结：如何理解“Hook 陷阱”和替换时机</span><br><span class="line"></span><br><span class="line"><span class="code">    “Hook 陷阱”的含义</span></span><br><span class="line"><span class="code">        它是指在脚本运行时设置 Hook，但实际逻辑在目标函数调用时触发，就像“埋下陷阱”等待猎物。</span></span><br><span class="line"><span class="code">        比如通过 Interceptor.attach 设置的 onEnter 和 onLeave，都是在目标函数执行时才生效。</span></span><br><span class="line"><span class="code">    替换函数的时机</span></span><br><span class="line"><span class="code">        Interceptor.replace 在脚本运行时设置替换，但实际生效取决于模块是否加载。</span></span><br><span class="line"><span class="code">        如果目标函数所在的 .so 文件是动态加载的，你需要在模块加载后（比如通过 Hook android_dlopen_ext 或 soinfo::call_constructors()）再执行替换。</span></span><br><span class="line"><span class="code">    你的疑问解答</span></span><br><span class="line"><span class="code">        脚本运行后不会“第一时间”替换 Native 层函数，除非目标模块已经加载且函数地址可访问。</span></span><br><span class="line"><span class="code">        对于动态加载的模块，Frida 需要你手动控制替换时机，确保在正确的时间点介入。</span></span><br></pre></td></tr></table></figure>

<p>之后写的脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">fileName</span> = args[<span class="number">0</span>].<span class="title function_">readCString</span>()</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onEnter: <span class="subst">$&#123;<span class="variable language_">this</span>.fileName&#125;</span>`</span>)</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fileName</span> !== <span class="literal">undefined</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">fileName</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_linker_call_constructors</span>()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onLeave fileName: <span class="subst">$&#123;<span class="variable language_">this</span>.fileName&#125;</span>`</span>)</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fileName</span> != <span class="literal">null</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">fileName</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> JNI_OnLoad = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="variable language_">this</span>.<span class="property">fileName</span>, <span class="string">&#x27;JNI_OnLoad&#x27;</span>)</span><br><span class="line">                    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(JNI_OnLoad, &#123;</span><br><span class="line">                        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`JNI_OnLoad onLeave: <span class="subst">$&#123;retval&#125;</span>`</span>)</span><br><span class="line">                        &#125;    </span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onLeave JNI_OnLoad: <span class="subst">$&#123;JNI_OnLoad - Module.getBaseAddress(<span class="variable language_">this</span>.fileName)&#125;</span>`</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>)</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0x51BA8</span>    <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset)</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hook_linker_call_constructors onEnter&#x27;</span>)</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">// hook_pthred_create()</span></span><br><span class="line">                <span class="title function_">hook_sub_1c544</span>() <span class="comment">// 含检测</span></span><br><span class="line">                <span class="title function_">hook_sub_1b8d4</span>()</span><br><span class="line">                <span class="comment">// hook_sub_26e5c()</span></span><br><span class="line">                listener.<span class="title function_">detach</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthred_create</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libmsaoaidsec.so --- &quot;</span> + <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>).<span class="property">base</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>,<span class="string">&#x27;pthread_create&#x27;</span>),&#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> func_addr = args[<span class="number">2</span>]</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`The thread Called function address is: <span class="subst">$&#123;func_addr&#125;</span>`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_1c544</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1c544</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_1c544 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&quot;int64&quot;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_1b8d4</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1b8d4</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_1b8d4 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_26e5c</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x26e5c</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_26e5c &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;, <span class="string">&#x27;int64&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_dlopen)</span><br></pre></td></tr></table></figure>

<p>逻辑算比较清楚，之后还剩下对业务函数的hook、利用_sig构造包。</p>
<p>接着分析方法e0.d.A(Request request0)。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250312125816408.png" alt="image-20250312125816408"></p>
<p>然后写了这个函数，每次我将这个函数放到hook_dlopen的末尾，就无法正确hook上之前的3个线程。之后我发现，可以通过cmd行输入。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sig</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> clazz_d = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;e0.d&quot;</span>);</span><br><span class="line">        clazz_d.<span class="property">A</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">request</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`request-header: <span class="subst">$&#123;request.header(<span class="string">&quot;Authorization&quot;</span>)&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">A</span>(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250312125943864.png" alt="image-20250312125943864"></p>
<p>这里就获得了Authorization的值：93f4c257daea24dfbbde470790be6e9d。</p>
<p>在方法d.z中，将url、method、authorization进行加密</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250312130152471.png" alt="image-20250312130152471"></p>
<p>这里就不进去追踪了，直接获取返回值。</p>
<p>直接获取了_sig和_ts的值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sig</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> clazz_d = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;e0.d&quot;</span>);</span><br><span class="line">        clazz_d.<span class="property">A</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">request</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`request-header: <span class="subst">$&#123;request.header(<span class="string">&quot;Authorization&quot;</span>)&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">let</span> res = <span class="variable language_">this</span>.<span class="title function_">A</span>(request);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Pair-first: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">String</span>(res.first)&#125;</span>\nPair-second: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">String</span>(res.second)&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250312131159267.png" alt="image-20250312131159267"></p>
<p>之后要利用并构造包的话，只需要添加上自己生成的_sig参数，这里用js脚本，模仿jeb的代码构造_sig，最终，完整的代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url;</span><br><span class="line"><span class="keyword">var</span> method;</span><br><span class="line"><span class="keyword">var</span> authorization;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">fileName</span> = args[<span class="number">0</span>].<span class="title function_">readCString</span>()</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onEnter: <span class="subst">$&#123;<span class="variable language_">this</span>.fileName&#125;</span>`</span>)</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fileName</span> !== <span class="literal">undefined</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">fileName</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_linker_call_constructors</span>()</span><br><span class="line">                    listener.<span class="title function_">detach</span>()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// hook_sig()</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>)</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0x51BA8</span>    <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset)</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hook_linker_call_constructors onEnter&#x27;</span>)</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">// hook_pthred_create()</span></span><br><span class="line">                <span class="title function_">hook_sub_1c544</span>()</span><br><span class="line">                <span class="title function_">hook_sub_1b8d4</span>()</span><br><span class="line">                <span class="title function_">hook_sub_26e5c</span>()</span><br><span class="line">                listener.<span class="title function_">detach</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthred_create</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libmsaoaidsec.so --- &quot;</span> + <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>).<span class="property">base</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>,<span class="string">&#x27;pthread_create&#x27;</span>),&#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> func_addr = args[<span class="number">2</span>]</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`The thread Called function address is: <span class="subst">$&#123;func_addr&#125;</span>`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_1c544</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1c544</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_1c544 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&quot;int64&quot;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_1b8d4</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1b8d4</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_1b8d4 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_26e5c</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libmsaoaidsec.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(secmodule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x26e5c</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_sub_26e5c &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;, <span class="string">&#x27;int64&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sig</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> clazz_d = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;e0.d&quot;</span>);</span><br><span class="line">        clazz_d.<span class="property">A</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">request</span>) &#123;</span><br><span class="line">            authorization = request.<span class="title function_">header</span>(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">            authorization = authorization.<span class="title function_">substring</span>(<span class="number">7</span>);</span><br><span class="line">            url = request.<span class="title function_">url</span>().<span class="title function_">toString</span>();</span><br><span class="line">            method = request.<span class="title function_">method</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`request-header: <span class="subst">$&#123;authorization&#125;</span>`</span>); <span class="comment">// 打印Authorization</span></span><br><span class="line">            <span class="keyword">let</span> res = <span class="variable language_">this</span>.<span class="title function_">A</span>(request);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Pair-first: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">String</span>(res.first.value)&#125;</span>\nPair-second: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">String</span>(res.second.value)&#125;</span>`</span>); <span class="comment">// 打印Pair</span></span><br><span class="line">            <span class="comment">// MySig，自己模仿流程写一个</span></span><br><span class="line">            <span class="title function_">getMySig</span>();</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getMySig</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">HttpUrl</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;okhttp3.HttpUrl&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">StringBuilder</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.StringBuilder&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> clazz_a = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.support.v4.media.a&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Uri</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.net.Uri&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 临时硬编码 s3</span></span><br><span class="line">    <span class="keyword">var</span> s3 = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;bf7dddc7c9cfe6f7&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!url || !method || !authorization) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;url, method, or authorization is undefined&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> stringBuilder0 = clazz_a.<span class="title function_">g</span>(method);</span><br><span class="line">    <span class="keyword">if</span> (!stringBuilder0) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;clazz_a.g(method) returned null&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> s4 = <span class="title class_">HttpUrl</span>.<span class="title function_">parse</span>(url).<span class="title function_">encodedPath</span>();</span><br><span class="line">    <span class="keyword">if</span> (!s4) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;HttpUrl.parse failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> s5 = <span class="title class_">Uri</span>.<span class="title function_">decode</span>(s4);</span><br><span class="line">    <span class="keyword">if</span> (s5.<span class="title function_">endsWith</span>(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">        s5 = clazz_a.<span class="title function_">e</span>(s5, -<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stringBuilder0.<span class="title function_">append</span>(<span class="string">&quot;&amp;&quot;</span>).<span class="title function_">append</span>(<span class="title class_">Uri</span>.<span class="title function_">encode</span>(s5)).<span class="title function_">append</span>(<span class="string">&quot;&amp;&quot;</span>).<span class="title function_">append</span>(authorization);</span><br><span class="line">    <span class="keyword">var</span> v = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.System&quot;</span>).<span class="title function_">currentTimeMillis</span>().<span class="title function_">toString</span>();</span><br><span class="line">    v = v.<span class="title function_">substring</span>(<span class="number">0</span>, v.<span class="property">length</span> - <span class="number">3</span>);</span><br><span class="line">    stringBuilder0.<span class="title function_">append</span>(<span class="string">&quot;&amp;&quot;</span>).<span class="title function_">append</span>(v);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> mac0 = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;javax.crypto.Mac&quot;</span>).<span class="title function_">getInstance</span>(<span class="string">&quot;HmacSHA1&quot;</span>);</span><br><span class="line">    mac0.<span class="title function_">init</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;javax.crypto.spec.SecretKeySpec&quot;</span>).$new(s3.<span class="title function_">getBytes</span>(), <span class="string">&quot;HmacSHA1&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Base64</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Base64&quot;</span>);</span><br><span class="line"></span><br><span class="line">    stringBuilder0.<span class="title function_">toString</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> strrr = stringBuilder0.<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`typeof strrr: <span class="subst">$&#123;<span class="keyword">typeof</span> strrr&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> bytes = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(strrr).<span class="title function_">getBytes</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`typeof Java.use(&quot;java.lang.String&quot;).$new(strrr): <span class="subst">$&#123;<span class="keyword">typeof</span> Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(strrr)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> res = mac0.<span class="title function_">doFinal</span>(bytes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> s6 = <span class="title class_">Base64</span>.<span class="title function_">encodeToString</span>(res, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 确保 s6 和 v 是正确的 Java 字符串</span></span><br><span class="line">    <span class="keyword">var</span> pair = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Pair&quot;</span>).$new(</span><br><span class="line">        s6, v);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`MySig: <span class="subst">$&#123;pair.first&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> pair;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_dlopen)</span><br></pre></td></tr></table></figure>

<p>其中，有一个问题，如下代码卡了我很久。在我眼中，这里的strrr一定是一个js代理java的String类型，是一个属于java的字符串，但被frida自动转换成了JavaScript字符串，而JS字符串没有getBytes函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stringBuilder0.<span class="title function_">toString</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> strrr = stringBuilder0.<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> bytes = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(strrr).<span class="title function_">getBytes</span>();</span><br><span class="line"><span class="comment">// 原本写的是strrr.getBytes()</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://reverseengineering.stackexchange.com/questions/32790/convert-string-to-byte-array-in-frida-js-script">https://reverseengineering.stackexchange.com/questions/32790/convert-string-to-byte-array-in-frida-js-script</a></p>
<p>通过js的函数，typeof去查看区别，可以发现stringBuilder0.toString()的类型是string，而Java.use(“java.lang.String”).$new(strrr)的类型是object。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250313175050250.png" alt="image-20250313175050250"></p>
<p>至此，脚本也算是跑出了_sig签名。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/v380pro-apk%E7%9A%84%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/v380pro-apk%E7%9A%84%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">v380pro apk的分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:18:46 / 修改时间：17:31:59" itemprop="dateCreated datePublished" datetime="2025-05-18T17:18:46+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>436</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="v380摄像头的apk某加密数据包分析"><a href="#v380摄像头的apk某加密数据包分析" class="headerlink" title="v380摄像头的apk某加密数据包分析"></a>v380摄像头的apk某加密数据包分析</h1><p>先展示成果，原始数据内容通过了gzip压缩、AES（CBC模式）加密、base64编码，反过来就可以进行解密了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/440bb350e19efe0a1875d507dca14c85_.png" alt="440bb350e19efe0a1875d507dca14c85_"></p>
<p>先通过r0capture查看函数调用栈，然后在几个关键函数处，hook下来，打印对象值，看看具体是哪一块进行加密。发现call到a的过程中有一个加密。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/ea4f083bd8f337a6af2f47321cec2ed9_.png" alt="ea4f083bd8f337a6af2f47321cec2ed9_"></p>
<p>由于call函数的过程，涉及很多对象的初始化，数据其实也在其中进行初始化了，很难分析。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/44a00f659e44e8aed78903fb2f2eb975_.png" alt="44a00f659e44e8aed78903fb2f2eb975_"></p>
<p>这里因为打印某些对象的值（gson包），发现了加密后data属于BodyRequest的成员变量j。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/0cbae3daf4b83043c88619535bff848b_.png" alt="0cbae3daf4b83043c88619535bff848b_"></p>
<p>追踪这个j。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/709b8770f19f671dfa0b002c16daf2a7_.png" alt="709b8770f19f671dfa0b002c16daf2a7_"></p>
<p>判断j的赋值在Api.c(api)。这里又可以看到j的值由api.k得到的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/d4c09d3ffc515fa4654fbace709f3983_.png" alt="d4c09d3ffc515fa4654fbace709f3983_"></p>
<p>继续追踪k。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/0896cd869b7a3d63589fd05f418c88c5_.png" alt="0896cd869b7a3d63589fd05f418c88c5_"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250324104835752.png" alt="image-20250324104835752"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/1d2f14a451e917fbeb8602ade035485e_.png" alt="1d2f14a451e917fbeb8602ade035485e_"></p>
<p>搜索了一下，Kalle是一个开源sdk，body函数是用来填充负载部分的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/3e69a42994b597b0ae4483e739d98f1b_.png" alt="3e69a42994b597b0ae4483e739d98f1b_"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/b2cea87c97f306d4dd4b4125a2ad7f34_.png" alt="b2cea87c97f306d4dd4b4125a2ad7f34_"></p>
<p>这里很容易就知道AES_KEY和IV。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/81a77f0fba59b744b843db4d595f8c6a_.png" alt="81a77f0fba59b744b843db4d595f8c6a_"></p>
<p>直接用工具。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/68c71f761cc84d618bc4a69b93defa06_.png" alt="68c71f761cc84d618bc4a69b93defa06_" style="zoom:67%;" />

<p>如果要尝试使用分析libapk0000.so，我觉得可以解密字符串，然后进行dump下来查看，大概就可以判断加密模式了，如果是自定义的加密模式，那可能真要逆向了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/r2pay-v0-9%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/r2pay-v0-9%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">r2pay-v0.9分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:17:28 / 修改时间：17:30:49" itemprop="dateCreated datePublished" datetime="2025-05-18T17:17:28+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>18k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>32 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="r2pay-v0-9-apk"><a href="#r2pay-v0-9-apk" class="headerlink" title="r2pay-v0.9.apk"></a>r2pay-v0.9.apk</h1><p>安装完后，一打开就闪退。</p>
<p>通过adb logcat查看日志，筛选中下面的日志记录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">02-28 10:34:38.788 11795 11795 I Magisk  : zygisk64: [re.pwnme] is on the denylist</span><br><span class="line">02-28 10:34:38.823 11795 11795 I re.pwnme: Late-enabling -Xcheck:jni</span><br><span class="line">02-28 10:34:38.845  1187  1204 I adbd    : jdwp connection from 11795</span><br><span class="line">02-28 10:34:38.867 11795 11795 D ProcessState: Binder ioctl to enable oneway spam detection failed: Invalid argument</span><br><span class="line">02-28 10:34:38.785     0     0 I binder  : 11795:11795 ioctl 40046210 7fe5e224b4 returned -22</span><br><span class="line">02-28 10:34:38.881 11795 11795 D CompatibilityChangeReporter: Compat change id reported: 171979766; UID 10137; state: DISABLED</span><br><span class="line">02-28 10:34:38.887 11795 11795 D ApplicationLoaders: Returning zygote-cached class loader: /system/framework/android.test.base.jar</span><br><span class="line">02-28 10:34:38.909 11795 11795 V GraphicsEnvironment: ANGLE Developer option for &#x27;re.pwnme&#x27; set to: &#x27;default&#x27;</span><br><span class="line">02-28 10:34:38.909 11795 11795 V GraphicsEnvironment: ANGLE GameManagerService for re.pwnme: false</span><br><span class="line">02-28 10:34:38.909 11795 11795 V GraphicsEnvironment: Neither updatable production driver nor prerelease driver is supported.</span><br><span class="line">02-28 10:34:38.911 11795 11795 D NetworkSecurityConfig: No Network Security Config specified, using platform default</span><br><span class="line">02-28 10:34:38.912 11795 11795 D NetworkSecurityConfig: No Network Security Config specified, using platform default</span><br><span class="line">02-28 10:34:39.391  2400  3117 W FrameTracker: Missing HWUI jank callback for vsyncId: 84855</span><br><span class="line">02-28 10:34:39.612 11795 11795 W re.pwnme: type=1400 audit(0.0:371): avc: denied &#123; read &#125; for name=&quot;cache&quot; dev=&quot;sda14&quot; ino=16 scontext=u:r:untrusted_app_29:s0:c137,c256,c512,c768 tcontext=u:object_r:cache_file:s0 tclass=lnk_file permissive=0 app=re.pwnme</span><br><span class="line">02-28 10:34:39.612 11795 11795 W re.pwnme: type=1400 audit(0.0:372): avc: denied &#123; read &#125; for name=&quot;cache&quot; dev=&quot;sda14&quot; ino=16 scontext=u:r:untrusted_app_29:s0:c137,c256,c512,c768 tcontext=u:object_r:cache_file:s0 tclass=lnk_file permissive=0 app=re.pwnme</span><br><span class="line">02-28 10:34:39.612 11795 11795 W re.pwnme: type=1400 audit(0.0:373): avc: denied &#123; read &#125; for name=&quot;cache&quot; dev=&quot;sda14&quot; ino=16 scontext=u:r:untrusted_app_29:s0:c137,c256,c512,c768 tcontext=u:object_r:cache_file:s0 tclass=lnk_file permissive=0 app=re.pwnme</span><br><span class="line">02-28 10:34:39.678 11795 11795 W re.pwnme: Accessing hidden method Landroid/view/View;-&gt;computeFitSystemWindows(Landroid/graphics/Rect;Landroid/graphics/Rect;)Z (unsupported, reflection, allowed)</span><br><span class="line">02-28 10:34:39.678 11795 11795 W re.pwnme: Accessing hidden method Landroid/view/ViewGroup;-&gt;makeOptionalFitsSystemWindows()V (unsupported, reflection, allowed)</span><br><span class="line">02-28 10:34:39.725 11795 11795 E RootBeer: b: a() [249] - com.topjohnwu.magisk ROOT management app detected!</span><br><span class="line">02-28 10:34:39.725 11795 11795 E QLog    : b: a() [249] - com.topjohnwu.magisk ROOT management app detected!</span><br><span class="line">02-28 10:34:39.726 11795 11795 D AndroidRuntime: Shutting down VM</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime: FATAL EXCEPTION: main</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime: Process: re.pwnme, PID: 11795</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime: java.lang.RuntimeException: Unable to start activity ComponentInfo&#123;re.pwnme/re.pwnme.MainActivity&#125;: java.lang.ArithmeticException: divide by zero</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:3707)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:3864)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:103)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:135)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:95)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.ActivityThread$H.handleMessage(ActivityThread.java:2253)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.os.Looper.loopOnce(Looper.java:201)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.os.Looper.loop(Looper.java:288)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.ActivityThread.main(ActivityThread.java:7870)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:548)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:1003)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime: Caused by: java.lang.ArithmeticException: divide by zero</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at re.pwnme.MainActivity.onCreate(SourceFile:38)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.Activity.performCreate(Activity.java:8057)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.Activity.performCreate(Activity.java:8037)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1341)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:3688)</span><br><span class="line">02-28 10:34:39.727 11795 11795 E AndroidRuntime:        ... 12 more</span><br><span class="line">02-28 10:34:39.730  1045 11817 I DropBoxManagerService: add tag=data_app_crash isTagEnabled=true flags=0x2</span><br><span class="line">02-28 10:34:39.730  1045  5059 W ActivityTaskManager:   Force finishing activity re.pwnme/.MainActivity</span><br><span class="line">02-28 10:34:39.737 11795 11795 I Process : Sending signal. PID: 11795 SIG: 9</span><br></pre></td></tr></table></figure>

<p>我把日志丢给grok进行分析，似乎是调用了RootBeer库进行root检测，发现了magisk，因此退出了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250228132546057.png" alt="image-20250228132546057" style="zoom:80%;" />

<p>尝试搜索字符串 ROOT management app detected，这里的try catch就是用来检测root的，如果读包错误，就说明这个包不存在，不做任何处理；如果读到“危险”包，就会继续执行b.a.a.c.a.a，并将result置为true。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250228134713528.png" alt="image-20250228134713528" style="zoom:67%;" />

<p>追踪b.a.a.c.a.a进去看一下，发现就写了一个Log.e。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250228140326772.png" alt="image-20250228140326772"></p>
<p>查看方法b.a.a.b.a(List )的调用。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250228140623670.png" alt="image-20250228140623670" style="zoom: 80%;" />

<p>Index为0的方法b.a.a.b.a(String[] )如下，属于重载，可以看到，这里只是将字符串加入到packages里，并调用b.a.a.b.a(List )。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250228140601697.png" alt="image-20250228140601697"></p>
<p>而Index为1的方法b.a.a.b.b(String[] )如下，它调用了b.a.a.b.a(String[] )。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250228141911196.png" alt="image-20250228141911196"></p>
<p>之后又一直查看引用，找到b.a.a.j()，这里做了一堆检查root的内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250228142312579.png" alt="image-20250228142312579" style="zoom:80%;" />

<p>不如直接将函数j给hook了，也省得hook其它这么多函数，我观察了一下众多this.X，发现其中的this.e不仅仅在j()被调用，还在其它地方被调用。</p>
<p>总结了一下，需要hook的函数如下：</p>
<p>b.a.a.a()&#x2F;b.a.a.j()&#x2F;b.a.a.e()。</p>
<p>首先hook方法a，一般来说，可以根据参数列表不同hook特定的、存在同名的方法，但这里要hook的方法a属于无参方法，而且存在两个无参方法a。</p>
<p>下面是我找ds-r1生成的，不知道行不行得通，看得挺靠谱的，根据返回值类型来判断。（事后发现下面的脚本用不了，别学，这里作为错误示范）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> targetClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;b.a.a.b&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> methods = targetClass.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line">    </span><br><span class="line">    methods.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">method</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.<span class="title function_">getName</span>() === <span class="string">&quot;a&quot;</span> &amp;&amp; method.<span class="title function_">getParameterTypes</span>().<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> returnType = method.<span class="title function_">getReturnType</span>().<span class="title function_">getName</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Hook返回boolean的a方法</span></span><br><span class="line">            <span class="keyword">if</span> (returnType === <span class="string">&quot;boolean&quot;</span>) &#123;</span><br><span class="line">                method.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked boolean a() method&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Hook返回String数组的a方法</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (returnType === <span class="string">&quot;[Ljava.lang.String;&quot;</span>) &#123;</span><br><span class="line">                method.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked String[] a() method&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">a</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>不过既然要hook的方法都在b.a.a类中，不妨直接将hook的方法补充进上面这个脚本里，执行后，又闪退了，不过这回查看日志，并没看到之前的那几条记录了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">02-28 15:10:41.848  4531  4531 I crash_dump64: obtaining output fd from tombstoned, type: kDebuggerdTombstoneProto</span><br><span class="line">02-28 15:10:41.849   655   655 I tombstoned: received crash request for pid 4528</span><br><span class="line">02-28 15:10:41.850  4531  4531 I crash_dump64: performing dump of process 4498 (target tid = 4528)</span><br><span class="line">02-28 15:10:41.871  4531  4531 E DEBUG   : failed to read /proc/uptime: Permission denied</span><br><span class="line">02-28 15:10:42.485     0     0 I logd    : logdr: UID=10137 GID=10137 PID=4531 n tail=0 logMask=8 pid=4498 start=0ns deadline=0ns</span><br><span class="line">02-28 15:10:42.486     0     0 I logd    : logdr: UID=10137 GID=10137 PID=4531 n tail=0 logMask=1 pid=4498 start=0ns deadline=0ns</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : Build fingerprint: &#x27;OnePlus/OnePlus6/OnePlus6:8.1.0/OPM1.171019.011/06140300:user/release-keys&#x27;</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : Revision: &#x27;0&#x27;</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : ABI: &#x27;arm64&#x27;</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : Timestamp: 2025-02-28 15:10:41.870217324+0800</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : Process uptime: 0s</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : Cmdline: com.google.android.videos</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : pid: 4498, tid: 4528, name: re.pwnme  &gt;&gt;&gt; com.google.android.videos &lt;&lt;&lt;</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : uid: 10137</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   : signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0xfaba4975</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   :     x0  0000006fe4986670  x1  000000730a2a77cc  x2  00000071ceef6220  x3  0000006fe4986618</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   :     x4  00000000000010b0  x5  0000000000000001  x6  0000000000000000  x7  0000000000000000</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   :     x8  00000000000035b2  x9  00000000faba4975  x10 000000008ef93fe9  x11 000000006df6246c</span><br><span class="line">02-28 15:10:42.498  4531  4531 F DEBUG   :     x12 0000000000000001  x13 00000000fffffff6  x14 00000000cf86a786  x15 0000000000000001</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :     x16 000000730a2911f8  x17 000000730a20db40  x18 0000000000000000  x19 0000006fe4986670</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :     x20 0000000000000000  x21 0000006fe498acb0  x22 0000000000001192  x23 0000000000001192</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :     x24 0000006fe498acb0  x25 0000006fe498acb0  x26 0000006fe498aff8  x27 00000000000fc000</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :     x28 0000006fe4892000  x29 0000006fe498ac40</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :     lr  0000006fdffa2668  sp  0000006fe4986670  pc  0000006fdfe77f7c  pst 0000000060000000</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   : backtrace:</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :       #00 pc 0000000000038f7c  /data/app/~~IG0Dzbwr_V__IsLZxDqnLA==/re.pwnme-5cCb3aQP1IrcfKWzdCWgYQ==/lib/arm64/libnative-lib.so (BuildId: f87b3bd9fcae36e63939958f412d03a42e0ce406)</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :       #01 pc 00000000000b1810  /apex/com.android.runtime/lib64/bionic/libc.so!libc.so (__pthread_start(void*)+264) (BuildId: 6bfaf10f10e5ff343703efae2f1bdbdb)</span><br><span class="line">02-28 15:10:42.499  4531  4531 F DEBUG   :       #02 pc 00000000000512f0  /apex/com.android.runtime/lib64/bionic/libc.so!libc.so (__start_thread+64) (BuildId: 6bfaf10f10e5ff343703efae2f1bdbdb)</span><br></pre></td></tr></table></figure>

<p>查看调用栈，锁定在libnative-lib.so，偏移量是38f7c，用ida打开后，访问那块地址，结果说函数太大，无法进行f5，没辙了，没啥思绪了，看看博客。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_61253776/article/details/140026070">https://blog.csdn.net/qq_61253776/article/details/140026070</a></p>
<p>看来我的第一步分析是正确的，将函数j a e进行了hook，避免了java层的检测，但so层好难。</p>
<p>接下来找博客一步一步做了。</p>
<p>So层的检测针对了root权限和frida注入，下面主要写分析过程。</p>
<p>在re.pwnme.MainActivity类中，静态初始化块加载了native-lib，</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304081920396.png" alt="image-20250304081920396" style="zoom: 80%;" />

<p>然后声明了其中的一个native函数并用于MainActivity的页面代码中。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304082019387.png" alt="image-20250304082019387" style="zoom:80%;" />

<p>通过ida观察libnative-lib.so的export表，导出函数和全局变量都被加密了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304082137127.png" alt="image-20250304082137127"></p>
<p>点开.datadiv_decodexxxxxx，大部分这类函数只写了一个RET，对应的字节码是C0 03 5F D6。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304082448246.png" alt="image-20250304082448246"></p>
<p>根据观察，其中的函数datadiv_decode4432700155380705947，它存在函数体，并且大部分操作似乎在做解密。大部分资料显示，这里是在做全局字符串的解密操作。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304082642593.png" alt="image-20250304082642593" style="zoom:80%;" />

<p>除此之外，在.init_array段中，存在两个拥有函数体的函数，它们无法f5，反编译成c。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304082900458.png" alt="image-20250304082900458"></p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304082937873.png" alt="image-20250304082937873" style="zoom:67%;" />

<p>过了java层后，会在so层的某处断开，地址是38f7c。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250304083458534.png" alt="image-20250304083458534"></p>
<p>在ida中来到38f7c，一路跟踪交叉引用，最后判定，这段代码属于sub_83DC。</p>
<p>由于静态无法分析，只能动态分析了，博客中，这里使用了工具QBDI，QBDI是一个动态二进制插桩的DBI框架，可以追踪函数细节，如果只用frida的话，只能看到函数调用前的参数和调用后的结果。</p>
<p>但QBDI咋用啊，wtf，教程也太少了。</p>
<hr>
<p>时隔多天，在分析完豆瓣后，再次看看这个apk如何分析。</p>
<p>在分析豆瓣的过程中，学会了找退出点的一些方法。</p>
<p>比如：hook函数pthread_create，线程在跑起来后，如果是检测frida的线程，就会杀死frida，所以可以观察哪个线程跑起来后，导致frida退出了。因为libc.so是系统库，加载先于frida的spawn模式，无需担心过早hook。</p>
<p>对应的检测线程脚本如下，不是直接复制就能用，这里放在这仅供参考：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hook_linker_call_constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 打印模块信息</span></span><br><span class="line">            <span class="keyword">if</span> (libnative_module) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Module name: &quot;</span> + libnative_module.<span class="property">name</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Base address: 0x&quot;</span> + libnative_module.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Size: &quot;</span> + libnative_module.<span class="property">size</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Path: &quot;</span> + libnative_module.<span class="property">path</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="title function_">check_pthread_create</span>(libnative_module.<span class="property">base</span>);</span><br><span class="line">                <span class="comment">//hook_20954();</span></span><br><span class="line">                <span class="comment">//hook_7a660();</span></span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check_pthread_create</span>(<span class="params">baseaddr</span>)&#123;</span><br><span class="line">    <span class="comment">/* 找到函数pthread_create的地址 */</span></span><br><span class="line">    <span class="keyword">var</span> pthread_create = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pthread_create)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is exist&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is not exist&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* hook */</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is called&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg2: 0x&quot;</span> + (args[<span class="number">2</span>] - baseaddr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后应该就会看到几个函数的地址，然后尝试hook它们。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_20954</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(libnative_module.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x20954</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_20954 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_7a660</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(libnative_module.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x7a660</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_7a660 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再次跑frida脚本，发现提示除以0的报错，这个报错不是在之前的java层解决了吗？</p>
<p>下面<strong>这个脚本是错的</strong>，是我早期通过deepseek生成的，我还以为能用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_java</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> targetClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;b.a.a.b&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> methods = targetClass.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Methods found in b.a.a.b:&quot;</span>);</span><br><span class="line">        methods.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">method</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (method.<span class="title function_">getName</span>() === <span class="string">&quot;a&quot;</span> &amp;&amp; method.<span class="title function_">getParameterTypes</span>().<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> returnType = method.<span class="title function_">getReturnType</span>().<span class="title function_">getName</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Return type: &quot;</span> + <span class="keyword">typeof</span> returnType + <span class="string">&quot;, value: &quot;</span> + returnType);</span><br><span class="line">                <span class="keyword">if</span> (returnType === <span class="string">&quot;boolean&quot;</span>) &#123;</span><br><span class="line">                    method.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b.a.a.b.a() is called, res = &quot;</span>, <span class="variable language_">this</span>.<span class="title function_">a</span>());</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked boolean a() method&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (method.<span class="title function_">getName</span>() === <span class="string">&quot;j&quot;</span> &amp;&amp; method.<span class="title function_">getParameterTypes</span>().<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> returnType = method.<span class="title function_">getReturnType</span>().<span class="title function_">getName</span>();</span><br><span class="line">                <span class="keyword">if</span> (returnType === <span class="string">&quot;boolean&quot;</span>) &#123;</span><br><span class="line">                    method.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b.a.a.b.j() is called, res = &quot;</span>, <span class="variable language_">this</span>.<span class="title function_">j</span>());</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked boolean j() method&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (method.<span class="title function_">getName</span>() === <span class="string">&quot;e&quot;</span> &amp;&amp; method.<span class="title function_">getParameterTypes</span>().<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> returnType = method.<span class="title function_">getReturnType</span>().<span class="title function_">getName</span>();</span><br><span class="line">                <span class="keyword">if</span> (returnType === <span class="string">&quot;boolean&quot;</span>) &#123;</span><br><span class="line">                    method.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b.a.a.b.e() is called, res = &quot;</span>, <span class="variable language_">this</span>.<span class="title function_">e</span>());</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked boolean e() method&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将它修改成正常的、简单的脚本。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_java</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">var</span> targetClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;b.a.a.b&quot;</span>); </span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">a</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.a()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 强制返回 false</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">j</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.j()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">e</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.e()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后整理出来的脚本如下，执行完后能正常跑apk了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_java</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">var</span> targetClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;b.a.a.b&quot;</span>); </span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">a</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.a()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 强制返回 false</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">j</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.j()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        targetClass.<span class="property">e</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hooked b.a.a.b.e()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0x51BA8</span>; <span class="comment">// __dl__ZN6soinfo17call_constructorsEv</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset);</span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hook_linker_call_constructors onEnter&#x27;</span>);</span><br><span class="line">            <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 打印模块信息</span></span><br><span class="line">            <span class="keyword">if</span> (libnative_module) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Module name: &quot;</span> + libnative_module.<span class="property">name</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Base address: 0x&quot;</span> + libnative_module.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Size: &quot;</span> + libnative_module.<span class="property">size</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Path: &quot;</span> + libnative_module.<span class="property">path</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="title function_">check_pthread_create</span>(libnative_module.<span class="property">base</span>);</span><br><span class="line">                <span class="title function_">hook_20954</span>();</span><br><span class="line">                <span class="title function_">hook_7a660</span>();</span><br><span class="line">                listener.<span class="title function_">detach</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check_pthread_create</span>(<span class="params">baseaddr</span>)&#123;</span><br><span class="line">    <span class="comment">/* 找到函数pthread_create的地址 */</span></span><br><span class="line">    <span class="keyword">var</span> pthread_create = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pthread_create)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is exist&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is not exist&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* hook */</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create is called&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg2: 0x&quot;</span> + (args[<span class="number">2</span>] - baseaddr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_20954</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(libnative_module.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x20954</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_20954 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_7a660</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> libnative_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(libnative_module.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x7a660</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`hook_7a660 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; replace`</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Avoid_divide_by_zero</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> b = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;b.a.a.b&quot;</span>);</span><br><span class="line">    b[<span class="string">&quot;j&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">hook_linker_call_constructors</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_java);</span><br></pre></td></tr></table></figure>

<p>成功在豆瓣进修，hhhhhh。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/UnCrackable-Level3%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/UnCrackable-Level3%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">UnCrackable-Level3分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:16:25 / 修改时间：17:31:31" itemprop="dateCreated datePublished" datetime="2025-05-18T17:16:25+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="UnCrackable-Level3-apk"><a href="#UnCrackable-Level3-apk" class="headerlink" title="UnCrackable-Level3.apk"></a>UnCrackable-Level3.apk</h1><p>照常，安装并打开，被检测到了root，通过magisk进行root权限的隐藏。</p>
<p>之后还是输入正确的密码。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226195340118.png" alt="image-20250226195340118" style="zoom:50%;" />

<p>在输入错误的Secret后，会提示Nope…That’s not it. Try again.</p>
<p>在Jeb中搜索这个字符串，发现关键点在check_code上。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226195531902.png" alt="image-20250226195531902" style="zoom:67%;" />

<p>check_code调用了native层函数bar。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226195605177.png" alt="image-20250226195605177" style="zoom:67%;" />

<p>在ida中，检索函数bar，一个很明显的xor解密，密钥的长度为24。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226195656697.png" alt="image-20250226195656697"></p>
<p>为了获得正确的secret，需要将v8和qword_15038进行xor运算，得到最终的结果。</p>
<p>不难看出，v8的值来自于sub_10E0，这里考虑对sub_10E0进行hook，然后查看v8的值。</p>
<p>结果hook的过程遇到了反frida的检测，可以根据报错的调用栈定位到goodbye函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226195957335.png" alt="image-20250226195957335" style="zoom:67%;" />

<p>追溯到源头，发现在sub_30D0处，调用了goodbye()，检测的逻辑是，通过读取映射到内存的文件名，只要发现frida等字段就退出。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226200242118.png" alt="image-20250226200242118" style="zoom:80%;" />

<p>为了能够正常使用frida进行hook，有以下几种hook的方式，绕过反frida。</p>
<p>1.hook函数sub_30D0。</p>
<p>2.hook函数strstr。</p>
<p>Ⅰ.先讲hook sub_30D0：观察过函数sub_30D0，发现它被写在了.init_array节里，这个节里面的函数，会在库加载的时候依次被调用，因此，如果想要hook这个函数，必须在System.loadLibray执行过程中——因为执行完后，frida就hook不了了；而若是还没执行，libfoo.so还没加载，当然hook不了。</p>
<p>查阅了相关博客，so层的.init_array节里的函数，都是被模块linker64中的call_array调用的，所以要hook函数call_array，当下的核心目标是获得call_array在模块linker64中的偏移量。（方法随意，可以直接在ida中进行查看）</p>
<p>在hook后，流程变成：遇到加载的so是libfoo.so，在完成了内存映射后，call_array还没有执行，这个时候去修改内存中sub_30D0的内容，之后正常执行call_array。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取linker64模块的基地址</span></span><br><span class="line">    <span class="keyword">var</span> linker64_module = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&quot;linker64&quot;</span>);</span><br><span class="line">    <span class="comment">//使用拦截器附加linker64模块的偏移地址</span></span><br><span class="line">    <span class="comment">// 7D68B58764 - 7D68B38000 = 0x20764</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(linker64_module.<span class="title function_">add</span>(<span class="number">0x20764</span>),&#123;</span><br><span class="line">        <span class="comment">// 进入函数，代码检查参数args[3]指向的字符串是否匹配libfoo.so</span></span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span>(args[<span class="number">0</span>].<span class="title function_">readCString</span>().<span class="title function_">match</span>(<span class="string">&quot;libfoo.so&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// 获取libfoo.so的基地址</span></span><br><span class="line">                <span class="keyword">var</span> libfoo_module  = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libfoo.so&#x27;</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;获取libfoo.so的基地址==&gt;&quot;</span>+libfoo_module)</span><br><span class="line">                <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(libfoo_module.<span class="title function_">add</span>(<span class="number">0x30D0</span>),<span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;,<span class="string">&#x27;void&#x27;</span>,[]));</span><br><span class="line">           &#125;</span><br><span class="line">    &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">result</span>)&#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Ⅱ.hook strstr就比较简单，判断strstr的第1个参数里有没有frida字段，如果有，之后的返回值直接强制返回。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 反frida检测</span></span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;strstr&quot;</span>), &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">haystack</span> = args[<span class="number">0</span>];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">needle</span> = args[<span class="number">1</span>];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">frida</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法 1：使用 readCString（自动处理 NULL 结尾）</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> haystack = <span class="variable language_">this</span>.<span class="property">haystack</span>.<span class="title function_">isNull</span>() ? <span class="string">&quot;&quot;</span> : <span class="variable language_">this</span>.<span class="property">haystack</span>.<span class="title function_">readCString</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (haystack &amp;&amp; (haystack.<span class="title function_">includes</span>(<span class="string">&quot;frida&quot;</span>) || haystack.<span class="title function_">includes</span>(<span class="string">&quot;xposed&quot;</span>))) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">frida</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;读取字符串失败:&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">frida</span>) &#123;</span><br><span class="line">            retval.<span class="title function_">replace</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>ok，在解决了反frida后，继续对之前提到的sub_10E0进行解密，由于这个函数没有返回值，可以判断：这个函数会在v8所指向的地址处，修改24个字节。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">function</span> <span class="title function_">hookXor</span>(<span class="params"></span>)&#123;</span><br><span class="line">           <span class="comment">// hook xor的其中一个key</span></span><br><span class="line">       <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>((<span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libfoo.so&quot;</span>)).<span class="title function_">add</span>(<span class="string">&quot;0x010E0&quot;</span>), &#123;</span><br><span class="line">           <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">               <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;onEnter: hook xor key&quot;</span>);</span><br><span class="line">               <span class="variable language_">this</span>.<span class="property">key</span> = args[<span class="number">0</span>];</span><br><span class="line">           &#125;, </span><br><span class="line">       </span><br><span class="line">           <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">               <span class="keyword">var</span> key_ = <span class="keyword">new</span> <span class="title class_">NativePointer</span>(<span class="variable language_">this</span>.<span class="property">key</span>);</span><br><span class="line">               <span class="keyword">var</span> arr = key_.<span class="title function_">readByteArray</span>(<span class="number">24</span>);</span><br><span class="line">               <span class="variable language_">console</span>.<span class="title function_">log</span>(arr);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="built_in">setTimeout</span>(hookXor, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>这里为了避免hookXor未执行，特意延迟了1000ms再进行注入（方法比较简单）。</p>
<p>还有其它方法，在保证加载了libfoo.so后立马进行hook，而不用等待1000ms。（同样是在加载器上做文章，不过这里hook的是System.loadLibrary）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">System</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.System&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Runtime</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">SystemLoad</span>_2 = <span class="title class_">System</span>.<span class="property">loadLibrary</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">VMStack</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;dalvik.system.VMStack&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">SystemLoad</span>_2.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">library</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Loading dynamic library =&gt; &quot;</span> + library);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> loaded =     <span class="title class_">Runtime</span>.<span class="title function_">getRuntime</span>().<span class="title function_">loadLibrary0</span>( <span class="title class_">VMStack</span>.<span class="title function_">getCallingClassLoader</span>(), library);</span><br><span class="line">          <span class="keyword">if</span>(library.<span class="title function_">includes</span>(<span class="string">&quot;foo&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">//function that gets the xored value </span></span><br><span class="line">            <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libfoo.so&quot;</span>).<span class="title function_">add</span>(<span class="string">&#x27;0x00000fa0&#x27;</span>),&#123;</span><br><span class="line">              <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;getting other_key value&quot;</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">other_key_address</span> = args[<span class="number">0</span>];</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> other_key = <span class="keyword">new</span> <span class="title class_">NativePointer</span>(<span class="variable language_">this</span>.<span class="property">other_key_address</span>);</span><br><span class="line">                <span class="keyword">var</span> arr = other_key.<span class="title function_">readByteArray</span>(<span class="number">24</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(arr);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> loaded;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(ex) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(ex);</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(ex.<span class="property">stack</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>最后得到的结果如下，即：1d 08 11 13…</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226204101246.png" alt="image-20250226204101246" style="zoom:80%;" />

<p>同时，另一个密钥key是qword_15038，追踪后，发现是通过init函数进行初始化的，这个函数是一个jni函数，根据代码，可以发现它的值由java层传递。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226204325745.png" alt="image-20250226204325745"></p>
<p>因此，另一个key的值是pizzapizzapizzapizzapizz。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226204444346.png" alt="image-20250226204444346" style="zoom:80%;" />

<p>将两者做异或运算。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">xor_bytes</span>(<span class="params">str1, bytes2</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    对两个24字节的数据进行逐字节的异或运算。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">    str1: 长度为24字节的字符串</span></span><br><span class="line"><span class="string">    bytes2: 长度为24字节的字节数组</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">    result: 异或运算后的字节数组</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 确保输入长度为24字节</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(str1) != <span class="number">24</span> <span class="keyword">or</span> <span class="built_in">len</span>(bytes2) != <span class="number">24</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;输入必须是24字节长&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将字符串转换为字节数组</span></span><br><span class="line">    bytes1 = str1.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 进行逐字节的异或运算</span></span><br><span class="line">    result = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> b1, b2 <span class="keyword">in</span> <span class="built_in">zip</span>(bytes1, bytes2):</span><br><span class="line">        result.append(b1 ^ b2)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例用法</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 输入字符串和字节数组</span></span><br><span class="line">    str_input = <span class="string">&quot;pizzapizzapizzapizzapizz&quot;</span>  <span class="comment"># 24字节字符串</span></span><br><span class="line">    bytes_input = <span class="built_in">bytes</span>([<span class="number">0x1d</span>, <span class="number">0x08</span>, <span class="number">0x11</span>, <span class="number">0x13</span>, <span class="number">0x0f</span>, <span class="number">0x17</span>, <span class="number">0x49</span>, <span class="number">0x15</span>, <span class="number">0x0d</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x19</span>, <span class="number">0x5a</span>, <span class="number">0x1d</span>, <span class="number">0x13</span>, <span class="number">0x15</span>, <span class="number">0x08</span>, <span class="number">0x0e</span>, <span class="number">0x5a</span>, <span class="number">0x00</span>, <span class="number">0x17</span>, <span class="number">0x08</span>, <span class="number">0x13</span>, <span class="number">0x14</span>])  <span class="comment"># 24字节的字节数组 [0, 1, 2, ..., 23]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 执行异或运算</span></span><br><span class="line">    result = xor_bytes(str_input, bytes_input)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出结果</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;异或运算结果:&quot;</span>, result)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;十六进制表示:&quot;</span>, result.<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226205334111.png" alt="image-20250226205334111" style="zoom:67%;" />

<p>阿这，这个解密出来的结果有点6。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250226205420426.png" alt="image-20250226205420426" style="zoom:67%;" />

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/UnCrackable-Level2%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/UnCrackable-Level2%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">UnCrackable-Level2分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:15:48 / 修改时间：17:31:15" itemprop="dateCreated datePublished" datetime="2025-05-18T17:15:48+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="UnCrackable-Level2-apk"><a href="#UnCrackable-Level2-apk" class="headerlink" title="UnCrackable-Level2.apk"></a>UnCrackable-Level2.apk</h1><p>直接安装+打开，又是解密。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224185514939.png" alt="image-20250224185514939" style="zoom:67%;" />

<p>搜索Nope，定位到this.m.a(s)。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224185646063.png" alt="image-20250224185646063" style="zoom:67%;" />

<p>在类MainActivity中，有一个私有对象m，m属于类CodeCheck，调用了函数a，最后调用了native层函数bar。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224185828483.png" alt="image-20250224185828483" style="zoom:67%;" />

<p>native层需要ida进行静态分析，这里将apk进行解压，取出其中的arm64架构的so库放入ida中，可以看到两个导出函数。</p>
<p>Java_包名_类名_函数名，可以看出bar就是我们要找的函数。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224190249451.png" alt="image-20250224190249451"></p>
<p>一眼看出，v7对应的字符串就是正确的secret。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224191818314.png" alt="image-20250224191818314" style="zoom:67%;" />

<p>再看看导出的init函数，这里ida并没有给出JNIEnv和jobect，应该是反编译失误——这俩参数没用到，可能被优化了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224192734132.png" alt="image-20250224192734132" style="zoom:80%;" />

<p>在sub_918中，可以发现：fork出子进程，然后子进程通过ptrace附加到父进程，使得父进程无法其它调试器被再次附加，一个反调试技术。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224193151757.png" alt="image-20250224193151757" style="zoom:67%;" />

<p>Frida通过Interceptor模块，可以支持对Native层函数的hook。</p>
<p>下面这个脚本，先通过Module.findBaseAddress找到so模块的基地址，然后通过导出表符号Java_sg_vantagepoint_uncrackable2_MainActivity_init，找到它的函数地址，然后根据在文件中计算的文件偏移量，计算出要hook的无符号函数的地址。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">LIB_NAME</span> = <span class="string">&#x27;libfoo.so&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">EXPORT_SYMBOL</span> = <span class="string">&#x27;Java_sg_vantagepoint_uncrackable2_MainActivity_init&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">OFFSET</span> = <span class="title function_">ptr</span>(-<span class="number">1140</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">tryHook</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 获得模块基地址</span></span><br><span class="line">        <span class="keyword">const</span> moduleBase = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="variable constant_">LIB_NAME</span>);</span><br><span class="line">        <span class="keyword">if</span> (!moduleBase) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[!] <span class="subst">$&#123;LIB_NAME&#125;</span> 未加载，等待...`</span>);</span><br><span class="line">            <span class="built_in">setTimeout</span>(tryHook, <span class="number">1000</span>); <span class="comment">// 每秒检查一次</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] 模块基地址: <span class="subst">$&#123;moduleBase&#125;</span>`</span>);</span><br><span class="line">        <span class="comment">// 通过符号名获得函数实际地址</span></span><br><span class="line">        <span class="keyword">const</span> exportAddress = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="variable constant_">LIB_NAME</span>, <span class="variable constant_">EXPORT_SYMBOL</span>);</span><br><span class="line">        <span class="keyword">if</span> (!exportAddress) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[!] 未找到导出函数 <span class="subst">$&#123;EXPORT_SYMBOL&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] 导出函数地址: <span class="subst">$&#123;exportAddress&#125;</span>`</span>);</span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 根据偏移计算目标地址</span></span><br><span class="line">        <span class="keyword">const</span> targetAddress = exportAddress.<span class="title function_">add</span>(<span class="variable constant_">OFFSET</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] 目标函数地址: <span class="subst">$&#123;targetAddress&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印目标地址的前5个字节</span></span><br><span class="line">        <span class="keyword">const</span> bytes = <span class="title class_">Memory</span>.<span class="title function_">readByteArray</span>(targetAddress, <span class="number">5</span>);</span><br><span class="line">        <span class="keyword">const</span> byteArray = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(bytes);</span><br><span class="line">        <span class="keyword">const</span> hexBytes = <span class="title class_">Array</span>.<span class="title function_">from</span>(byteArray).<span class="title function_">map</span>(<span class="function"><span class="params">b</span> =&gt;</span> b.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)).<span class="title function_">join</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] 前5个字节: <span class="subst">$&#123;hexBytes&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(targetAddress, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`\n=== 函数调用开始 ===`</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="title class_">Process</span>.<span class="property">arch</span> === <span class="string">&#x27;arm64&#x27;</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`X0: <span class="subst">$&#123;args[<span class="number">0</span>]&#125;</span>, X1: <span class="subst">$&#123;args[<span class="number">1</span>]&#125;</span>, X2: <span class="subst">$&#123;args[<span class="number">2</span>]&#125;</span>`</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`R0: <span class="subst">$&#123;args[<span class="number">0</span>]&#125;</span>, R1: <span class="subst">$&#123;args[<span class="number">1</span>]&#125;</span>, R2: <span class="subst">$&#123;args[<span class="number">2</span>]&#125;</span>`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`返回值: <span class="subst">$&#123;retval&#125;</span>`</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`=== 函数调用结束 ===\n`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[√] Hook 安装成功`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setTimeout</span>(tryHook, <span class="number">1000</span>); <span class="comment">// 延迟1秒开始检查</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>然而还不够，即便hook住了这个函数，但这个函数早已经在MainActivity.onCreate阶段执行了，hook了也没用，因为已经执行过了一遍。</p>
<p>针对执行时机的问题，有以下解决方法：</p>
<p>1.使用spawn模式，默认的frida -U -f是“fork-and-attach”模式，可能错过早期逻辑。使用“spawn”模式可以在应用进程创建时注入Frida。</p>
<p>如：frida -U -l script.js –no-pause -f com.example.app –spawn</p>
<p>–spawn: 在进程创建时注入，而不是附加到已有进程。</p>
<p>2.hook系统类System，然后对loadLibrary做手脚，如果加载的是其它库，不做处理；如果加载的是foo.so，则立马进行覆盖。<strong>这个hook的时机发生在静态初始化块执行之前</strong>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">LIB_NAME</span> = <span class="string">&#x27;libfoo.so&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">EXPORT_SYMBOL</span> = <span class="string">&#x27;Java_sg_vantagepoint_uncrackable2_MainActivity_init&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">OFFSET</span> = <span class="title function_">ptr</span>(-<span class="number">1140</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hook System.loadLibrary</span></span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.System&#x27;</span>).<span class="property">loadLibrary</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">libName</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] 加载库: <span class="subst">$&#123;libName&#125;</span>`</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">loadLibrary</span>(libName); <span class="comment">// 调用原始方法</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (libName === <span class="string">&#x27;foo&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> moduleBase = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="variable constant_">LIB_NAME</span>);</span><br><span class="line">            <span class="keyword">if</span> (!moduleBase) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> exportAddress = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="variable constant_">LIB_NAME</span>, <span class="variable constant_">EXPORT_SYMBOL</span>);</span><br><span class="line">            <span class="keyword">const</span> targetAddress = exportAddress.<span class="title function_">add</span>(<span class="variable constant_">OFFSET</span>);</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(targetAddress, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`sub_918 被调用并覆盖`</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">            &#125;, <span class="string">&#x27;int64&#x27;</span>, []));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[√] sub_918 已替换`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>3.Hook MainActivity.onCreat。</p>
<p>所以接下来这段脚本执行时机如下，在静态初始化块执行后（System.loadLibrary导入libfoo.so），在onCreate执行前（调用Java_sg_vantagepoint_uncrackable2_MainActivity_init之前），hook了类MainActivity，然后在它执行前，将sub_918的内容做了替换。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">LIB_NAME</span> = <span class="string">&#x27;libfoo.so&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">EXPORT_SYMBOL</span> = <span class="string">&#x27;Java_sg_vantagepoint_uncrackable2_MainActivity_init&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">OFFSET</span> = <span class="title function_">ptr</span>(-<span class="number">1140</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">MainActivity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;sg.vantagepoint.uncrackable2.MainActivity&#x27;</span>);</span><br><span class="line">    <span class="title class_">MainActivity</span>.<span class="property">onCreate</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">savedInstanceState</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] MainActivity.onCreate 被调用&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在 onCreate 执行前替换 sub_918</span></span><br><span class="line">        <span class="keyword">const</span> moduleBase = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="variable constant_">LIB_NAME</span>);</span><br><span class="line">        <span class="keyword">if</span> (moduleBase) &#123;</span><br><span class="line">            <span class="keyword">const</span> exportAddress = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="variable constant_">LIB_NAME</span>, <span class="variable constant_">EXPORT_SYMBOL</span>);</span><br><span class="line">            <span class="keyword">const</span> targetAddress = exportAddress.<span class="title function_">add</span>(<span class="variable constant_">OFFSET</span>);</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(targetAddress, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`sub_918 被调用并覆盖`</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">            &#125;, <span class="string">&#x27;int64&#x27;</span>, []));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[√] sub_918 已替换`</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用原始 onCreate</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onCreate</span>(savedInstanceState);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>下图是安卓的初始化过程以及注入时机。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250225150528070.png" alt="image-20250225150528070" style="zoom: 67%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250225150505066.png" alt="image-20250225150505066" style="zoom:67%;" />

<p>之后尝试一下hook是否执行成功，先将脚本断掉，直接通过jeb调试进程。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250225150747031.png" alt="image-20250225150747031" style="zoom:67%;" />

<p>再试试通过frida进行hook后，能否attach上去调试。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250225150907624.png" alt="image-20250225150907624" style="zoom:80%;" />

<p>确实是attach上去了，但是手机上显示被检测到了调试，根据字符串搜索，发现问题来自于下图。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250225151147999.png" alt="image-20250225151147999" style="zoom:67%;" />

<p>有一个持续检测的进程，阿这，这么防着咱。。。</p>
<p>只需要hook Debug.isDebuggerConnected()即可，让它一直返回false，这里就不写了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/18/UnCrackable-Level1%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/18/UnCrackable-Level1%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">UnCrackable-Level1分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-18 17:13:45 / 修改时间：17:30:58" itemprop="dateCreated datePublished" datetime="2025-05-18T17:13:45+08:00">2025-05-18</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="UnCrackable-Level1-apk"><a href="#UnCrackable-Level1-apk" class="headerlink" title="UnCrackable-Level1.apk"></a>UnCrackable-Level1.apk</h1><p>下载并安装，打开；一上来就被检测出root权限了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224152934808.png" alt="image-20250224152934808" style="zoom:50%;" />

<p>将apk丢入jeb中查看，通过<code>ctrl + f</code>搜索字符串。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224153359358.png" alt="image-20250224153359358" style="zoom: 67%;" />

<p>c.a()、c.b()、c.c()的逻辑如下图，我发现，在我的&#x2F;system&#x2F;bin中，确实有一个su。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224153529149.png" alt="image-20250224153529149" style="zoom:67%;" />

<p>方案1，粗暴的解决方案，修改dex文件并重新签名。在onCreate的第一个if处，将判断结果改成false；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> root = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;sg.vantagepoint.util.RootDetection&quot;</span>);</span><br><span class="line">	root.<span class="property">checkRoot1</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	root.<span class="property">checkRoot2</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	root.<span class="property">checkRoot3</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>方案2，hook掉exit函数或者hook掉相关函数；</p>
<p>方案3，面具magisk里直接屏蔽掉UnCrackable-Level1.apk的root权限，让它检测不到root。</p>
<p>这里介绍一下第二个方法，js脚本如下，执行方法也如下，然后就绕过去了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">frida -U -f owasp.mstg.uncrackable1 -l .\uncrackable-level1.js</span></span><br><span class="line"></span><br><span class="line">Java.perform(function()&#123;</span><br><span class="line">    var temp = Java.use(&quot;java.lang.System&quot;); # 获得System类</span><br><span class="line">    # exit是静态函数，不需要实例化后再调用</span><br><span class="line">    # overload指定具体的重载版本</span><br><span class="line">    temp.exit.overload(&#x27;int&#x27;).implementation = function(arg0)&#123;</span><br><span class="line">        console.log(&quot;Exit called with &quot; + arg0);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224160548124.png" alt="image-20250224160548124"></p>
<p>通过jeb，可以发现在类a中，函数a会根据输入的内容进行比较，随后得出是否正确的答案。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224183527518.png" alt="image-20250224183527518"></p>
<p>下面是写的一个js脚本，直接return true，或者通过sg.vantagepoint.a.a.a得到解密的明文。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"># 直接改为<span class="literal">true</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获取目标类</span></span><br><span class="line">    <span class="keyword">var</span> targetClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;sg.vantagepoint.uncrackable1.a&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook 静态方法 a(String)</span></span><br><span class="line">    targetClass.<span class="property">a</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">s</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n[*] 拦截验证方法调用&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 打印原始输入</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;原始输入: &quot;</span> + s);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调用原始方法获取结果</span></span><br><span class="line">        <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">a</span>(s); <span class="comment">// [!code focus]</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 打印原始验证结果</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;原始验证结果: &quot;</span> + result);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 强制返回 true（绕过验证）</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] 强制返回 true&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 若需保留原始逻辑，直接返回 result</span></span><br><span class="line">        <span class="comment">// return result;</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"># 观察正确的输入</span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获取加密工具类</span></span><br><span class="line">    <span class="keyword">var</span> crypto = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;sg.vantagepoint.a.a&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取验证类</span></span><br><span class="line">    <span class="keyword">var</span> checker = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;sg.vantagepoint.uncrackable1.a&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hook a() 方法获取密钥和密文</span></span><br><span class="line">    checker.<span class="property">a</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">s</span>) &#123;</span><br><span class="line">        <span class="comment">// 原始密文（Base64）</span></span><br><span class="line">        <span class="keyword">var</span> ciphertext_b64 = <span class="string">&quot;5UJiFctbmgbDoLXmpL12mkno8HT4Lv8dlat8FxR2GOc=&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 硬编码密钥（处理负数为无符号字节）</span></span><br><span class="line">        <span class="keyword">var</span> key_bytes = [<span class="number">0x8D</span>, <span class="number">0x12</span>, <span class="number">0x76</span>, <span class="number">0x84</span>, <span class="number">0xCB</span>, <span class="number">0xC3</span>, <span class="number">0x7C</span>, <span class="number">0x17</span>, </span><br><span class="line">                         <span class="number">0x61</span>, <span class="number">0x6D</span>, <span class="number">0x80</span>, <span class="number">0x6C</span>, <span class="number">0xF5</span>, <span class="number">0x04</span>, <span class="number">0x73</span>, <span class="number">0xCC</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将密钥转换为 Java byte[]</span></span><br><span class="line">        <span class="keyword">var</span> jKey = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, key_bytes);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Base64 解码密文</span></span><br><span class="line">        <span class="keyword">var</span> ciphertext = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;android.util.Base64&#x27;</span>).<span class="title function_">decode</span>(ciphertext_b64, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 调用解密方法</span></span><br><span class="line">            <span class="keyword">var</span> decrypted_bytes = crypto.<span class="title function_">a</span>(jKey, ciphertext);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 转换为字符串</span></span><br><span class="line">            <span class="keyword">var</span> plaintext = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).$new(decrypted_bytes);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n[+] 解密成功！Secret String: &quot;</span> + plaintext);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[-] 解密失败: &quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回原始验证结果（或强制返回 true）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">a</span>(s);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行，得到结果。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250224185351087-1747559716287-11.png" alt="image-20250224185351087"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/default-index/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/default-index/">1</a><span class="page-number current">2</span><a class="page-number" href="/default-index/page/3/">3</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/default-index/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">X14Nuy</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">446k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">13:31</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
