<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="数字免费壳用的是大佬 oacia 加固的apk，需要的可以去大佬的博客中下载~ 将apk丢入jeb中，查看AndroidManifest.xml。   从整体壳开始看起，一般整体壳会在App类中重写方法attachBaseContext和onCreate，在这两个方法中，实现自脱壳。 先看attachBaseContext。 分析 通过反射，访问类**”android.content.pm.Pac">
<meta property="og:type" content="article">
<meta property="og:title" content="360免费壳分析复现">
<meta property="og:url" content="http://example.com/2025/05/27/360%E5%85%8D%E8%B4%B9%E5%A3%B3%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="数字免费壳用的是大佬 oacia 加固的apk，需要的可以去大佬的博客中下载~ 将apk丢入jeb中，查看AndroidManifest.xml。   从整体壳开始看起，一般整体壳会在App类中重写方法attachBaseContext和onCreate，在这两个方法中，实现自脱壳。 先看attachBaseContext。 分析 通过反射，访问类**”android.content.pm.Pac">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521191640996.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521193756011.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521193925825.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521194051603.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521194322034.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521195133236.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521201518518.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521202133001.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521203239178.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521220343528.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522121310523.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522145858137.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522163243458.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522163712631.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522164021033.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522182759789.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521220343528.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522183812989.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522163243458.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522192323619.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522192408776.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522210913892.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522211014029.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522211223432.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522213102676.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522213143598.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522213451658.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522214248568.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522125906310.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522215252155.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522215337793.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522215721040.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522215826312.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522125830770.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522130529768.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522130853416.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522131044479.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522131542842.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522133014663.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522133032024.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523131131946.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522134705450.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523131209960.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523131635457.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523131949048.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523132740721.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523143433747.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523143521988.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523145851806.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523152403741.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523152508833.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523152541657.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523152738670.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523153052668.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523160437480.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523162349320.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523163024028.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523164348276.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523165245625.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522182759789.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523183558728.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523184641892.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523190428752.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523193144378.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523214928222.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523200915894.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523201154653.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523220006379.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523220224280.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523220603855.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523220720253.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524093446012.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524152046692.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524153516529.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524154214898.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524215504808.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524154405943.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524154735343.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524154857110.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524154817260.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524214255632.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525103239983.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525110933159.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525111242312.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525112814418.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525112854039.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525113844217.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525115700120.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525132029227.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525133553692.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525133145413.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525142521149.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525143259739.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525150624560.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525152209680.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525162553594.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525155237926.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525155415726.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525155524905.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525163327040.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525163402407.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525163427141.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525163513117.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525164721162.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525163608632.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525170510570.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525201455502.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525201744955.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525201939099.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525202237290.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525202441708.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525202608074.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525203507669.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525204112819.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525203811167.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525204312795.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525210705157.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525211112557.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526092610332.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526092831748.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526093509859.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526100506048.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526103628785.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526103707527.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526103748834.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526103913279.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526120322384.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526120702211.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526121122466.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526121150955.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526132131214.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526132323546.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526134858141.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526135343573.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526135805308.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526135905993.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526140025579.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526140247694.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526141948951.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526143837983.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526143857946.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526100506048.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522133032024.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526150825957.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526151921387.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526152253621.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526155617908.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526163850323.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526164059339.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526164137748.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526180148434.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526180048792.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526180701496.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526181208584.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526184917507.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526185047625.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526193502474.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526195657484.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526200220622.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526202751628.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526202809100.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526203312634.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526205010061.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527095842692.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527121537670.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527133205197.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527133617161.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527134953849.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527135015190.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527143339957.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527133617161.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527153041340.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527154322756.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527155431502.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527160301779.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527155938623.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527164253814.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527161717098.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527162127366.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527163146812.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527163120637.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527164604090.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527165421138.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527181237282.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527181335376.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527181652626.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527182226096.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527183939347.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527184825546.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20240308004303427.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527193149268.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527193749337.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527194144192.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527194317120.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527200812044.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527200828145.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527201027621.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527201458653.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527202407163.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527202610910.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527205949901.png">
<meta property="og:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527210536218.png">
<meta property="article:published_time" content="2025-05-27T13:22:57.000Z">
<meta property="article:modified_time" content="2025-05-27T13:34:35.951Z">
<meta property="article:author" content="X14Nuy">
<meta property="article:tag" content="收获颇多hhh">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521191640996.png">


<link rel="canonical" href="http://example.com/2025/05/27/360%E5%85%8D%E8%B4%B9%E5%A3%B3%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2025/05/27/360%E5%85%8D%E8%B4%B9%E5%A3%B3%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/","path":"2025/05/27/360免费壳分析复现/","title":"360免费壳分析复现"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>360免费壳分析复现 | Hexo</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B0%E5%AD%97%E5%85%8D%E8%B4%B9%E5%A3%B3"><span class="nav-number">1.</span> <span class="nav-text">数字免费壳</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-number">1.1.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%84%9F%E6%83%B3"><span class="nav-number">1.2.</span> <span class="nav-text">感想</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.3.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E8%B6%B3%E4%B9%8B%E5%A4%84"><span class="nav-number">1.4.</span> <span class="nav-text">不足之处</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="nav-number">1.5.</span> <span class="nav-text">参考链接</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">X14Nuy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/27/360%E5%85%8D%E8%B4%B9%E5%A3%B3%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="X14Nuy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="360免费壳分析复现 | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          360免费壳分析复现
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-05-27 21:22:57 / 修改时间：21:34:35" itemprop="dateCreated datePublished" datetime="2025-05-27T21:22:57+08:00">2025-05-27</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>82k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2:29</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="数字免费壳"><a href="#数字免费壳" class="headerlink" title="数字免费壳"></a>数字免费壳</h1><p>用的是大佬 oacia 加固的apk，需要的可以去大佬的博客中下载~</p>
<p>将apk丢入jeb中，查看AndroidManifest.xml。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521191640996.png" alt="image-20250521191640996" style="zoom:67%;" />

<p>从整体壳开始看起，一般整体壳会在App类中重写方法attachBaseContext和onCreate，在这两个方法中，实现自脱壳。</p>
<p>先看attachBaseContext。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521193756011.png" alt="image-20250521193756011"></p>
<p>通过反射，访问类**”android.content.pm.PackageParser$Package”**，设置构造方法为可访问。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521193925825.png" alt="image-20250521193925825" style="zoom:80%;" />

<p>通过反射，获取当前线程的ActivityThread实例，然后设置mHiddenApiWarningShown字段为true，避免了日志中出现使用隐藏api时的警告信息。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521194051603.png" alt="image-20250521194051603"></p>
<p>StubApp是一个静态类，存储加固相关的全局状态。</p>
<p>StubApp.a保存上下文，供加固逻辑使用；StubApp.c保存当前对象实例（App类实例），确保只初始化一次。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521194322034.png" alt="image-20250521194322034"></p>
<p>在函数com.qihoo.util.a.a()中，通过下述3种方式判断当前的架构，若是x86架构，则返回true，然后加载X86Bridge；反之相反。</p>
<ol>
<li><p>检查 Build.SUPPORTED_32_BIT_ABIS 系统属性。</p>
</li>
<li><p>读取 &#x2F;system&#x2F;build.prop 文件中的 ro.product.cpu.abi 属性。</p>
</li>
<li><p>检查 &#x2F;system&#x2F;bin&#x2F;ls 的 ELF 文件头，判断其架构。</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521195133236.png" alt="image-20250521195133236"></p>
<p>com.qihoo.util.a.a(…)会检测…&#x2F;assets&#x2F;libjiagu.so和…&#x2F;.jiagu&#x2F;libjiagu.so是否完全一样，如果不一样，以assets的so为主，会把assets的so覆写.jiagu的so，假如之后我们patch了…&#x2F;.jiagu的so文件进行重打包，将不会有效果；libjiagu_64.so同等”待遇”。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521201518518.png" alt="image-20250521201518518"></p>
<p>随后来到方法interface5，跳转到native层执行。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521202133001.png" alt="image-20250521202133001" style="zoom:80%;" />

<p>不必多说，这个interface5肯定是在libjiaguxxx.so中注册的。</p>
<p>使用下面这个脚本跑一下试试。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">find_RegisterNatives</span>(<span class="params">params</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> symbols = <span class="title class_">Module</span>.<span class="title function_">enumerateSymbolsSync</span>(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> addrRegisterNatives = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> symbol = symbols[i];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//_ZN3art3JNI15RegisterNativesEP7_JNIEnvP7_jclassPK15JNINativeMethodi</span></span><br><span class="line">        <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;art&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;JNI&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; </span><br><span class="line">                symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;RegisterNatives&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; </span><br><span class="line">                symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            addrRegisterNatives = symbol.<span class="property">address</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;RegisterNatives is at &quot;</span>, symbol.<span class="property">address</span>, symbol.<span class="property">name</span>);</span><br><span class="line">            <span class="title function_">hook_RegisterNatives</span>(addrRegisterNatives)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_RegisterNatives</span>(<span class="params">addrRegisterNatives</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addrRegisterNatives != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addrRegisterNatives, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[RegisterNatives] method_count:&quot;</span>, args[<span class="number">3</span>]);</span><br><span class="line">                <span class="keyword">let</span> java_class = args[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">let</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getClassName</span>(java_class);</span><br><span class="line">                <span class="comment">//console.log(class_name);</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> methods_ptr = <span class="title function_">ptr</span>(args[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> method_count = <span class="built_in">parseInt</span>(args[<span class="number">3</span>]);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; method_count; i++) &#123;</span><br><span class="line">                    <span class="keyword">let</span> name_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span>));</span><br><span class="line">                    <span class="keyword">let</span> sig_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span>));</span><br><span class="line">                    <span class="keyword">let</span> fnPtr_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">let</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(name_ptr);</span><br><span class="line">                    <span class="keyword">let</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(sig_ptr);</span><br><span class="line">                    <span class="keyword">let</span> symbol = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(fnPtr_ptr)</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[RegisterNatives] java_class:&quot;</span>, class_name, <span class="string">&quot;name:&quot;</span>, name, <span class="string">&quot;sig:&quot;</span>, sig, <span class="string">&quot;fnPtr:&quot;</span>, fnPtr_ptr,  <span class="string">&quot; fnOffset:&quot;</span>, symbol, <span class="string">&quot; callee:&quot;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(<span class="variable language_">this</span>.<span class="property">returnAddress</span>), <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(find_RegisterNatives);</span><br></pre></td></tr></table></figure>

<p>结果如图，暂时忽视那个Bad access….目标函数在libjiagu_64.so offset为0x11be00的位置。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521203239178.png" alt="image-20250521203239178"></p>
<p>先不着急分析interface5，先走完libjiagu_64.so的初始化，用IDA打开assets下的libjiagu_a64.so。</p>
<p>打开一看，天塌了，导入表、导出表全是空的。</p>
<p>使用System.loadLibray加载一个so文件的流程是这样的（大致操作应该没问题，如果细节有误，就是我学术不精）。</p>
<ol start="0">
<li><p>动态链接器会映射这个so文件的PT_LOAD段到内存中；</p>
</li>
<li><p>解析so文件，映射所有其他依赖的共享库；</p>
</li>
<li><p>完成符号解析、动态重定位等操作；</p>
</li>
<li><p>动态库初始化：init_proc -&gt; .init_array(函数指针) -&gt; JNI_OnLoad；</p>
</li>
<li><p>完成加载，等待调用。</p>
</li>
</ol>
<p>一般来说，一个普通的so文件是没有start的（注意，_start和_dl_start不是一个函数），只有可执行文件有，而libjiagu_64.so的导出表有start，而且只有一个start，甚至被标记为了main_entry。但对于so文件来说，main_entry应该是用不着的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521220343528.png" alt="image-20250521220343528"></p>
<p>上述种种特征说明，它不是一个普通的so文件，而是一个类似于自加载器的so文件，壳so负责将加固后的so文件解密，解析并加载，然后链接重定位。</p>
<p>那么问题来了，何时进行加载、何时重定位呢？</p>
<p><strong>得先找到壳的程序入口点。</strong></p>
<p>按照我们的常规思路，先去看看有没有函数叫init_proc（旧版本的才有的函数，一般情况下已经见不到这个函数）、再看init_array上有没有函数指针列表、最后找JNI_OnLoad。</p>
<p>结果，在IDA中看不到init_proc、init_array节、JNI_OnLoad。</p>
<p>后来，我通过readelf -a读到了INIT_ARRAY的偏移。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522121310523.png" alt="image-20250522121310523"></p>
<p>跳转到0x2d760，没有看到函数指针。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522145858137.png" alt="image-20250522145858137" style="zoom:80%;" />

<p>360壳对so文件的结构字段做了很多修改，有一些字段是用来观察so文件结构的，他们属于对动态链接器加载流程不构成影响的字段，这些字段要么给删了，要么给加密了。</p>
<p>事实上，完全可以从内存中dump一个已经加载好的so文件，但我想看看一般这种情况要如何进行下一步分析。</p>
<p>重新理一下思路——360壳对ELF文件做了手脚，通过工具无法查看某些字段的信息，但对于动态链接器来说，它依旧可以正确调用init_array上的函数和JNI_OnLoad。</p>
<p><strong>因此，下一个切入点是：动态链接器是如何获得到init_array和JNI_OnLoad地址的。</strong></p>
<p><strong>动态链接器找init_array节地址的流程</strong>是这样的：</p>
<ol>
<li><p>查找.dynamic节的位置，.dynamic节是一个由Elf_Dyn结构体组成的数组，每个Elf_Dyn包含2个主要成员。</p>
<ul>
<li>d_tag：一个标记（tag），表示这个条目的类型，比如，当前这个条目指向符号表或重定位表等。</li>
<li>d_un：一个联合体，根据d_tag的不同，它可以是一个值，或者指向一个虚拟地址。</li>
</ul>
</li>
<li><p>查找特定的d_tag，对于.init_array来说，有2个相关的d_tag标记。</p>
<ul>
<li>d_tag &#x3D;&#x3D; DT_INIT_ARRAY，此时d_un包含了.init_array节的偏移地址。</li>
<li>d_tag &#x3D;&#x3D; DT_INIT_ARRAYSZ，此时d_un包含了.init_array节的总大小。（以字节为单位）</li>
</ul>
</li>
<li><p>动态链接器会找到.init_array的位置，并根据.init_array的大小，得到函数指针的数目，执行上面的函数指针。</p>
</li>
</ol>
<p>实操如下。</p>
<p>通过010editor，找到节头表，然后根据节头表找到.dynamic节的偏移。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522163243458.png" alt="image-20250522163243458" style="zoom:67%;" />

<p>下面这个网址，给出了d_tag的值与含义。</p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E23824_01/html/819-0690/chapter6-42444.html">https://docs.oracle.com/cd/E23824_01/html/819-0690/chapter6-42444.html</a></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522163712631.png" alt="image-20250522163712631"></p>
<p>一个Elf_Dyn元素占16个字节，前8个字节是d_tag，后8个字节是d_un。</p>
<p>接下来，在010editor中，从0x1DAD0开始，搜索d_tag &#x3D;&#x3D; 25（0x19）或27（0x1B）的地方。</p>
<p>翻译一下，.init_array的地址是0x2D760，和之前readelf看到的一样；而.init_array的大小是0x10字节，可以存放2个函数指针。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522164021033.png" alt="image-20250522164021033"></p>
<p>我们之前跳转到了0x2D760，发现.init_array上没有任何内容，这2个函数指针是哪里来的？突然想起来，在一个so文件加载的流程中，会先进行动态重定位，那大概率是在重定位的过程，为.init_array赋了2个函数指针。</p>
<p>重定位表（RELA类型）相关的d_tag如下：</p>
<ul>
<li>DT_RELA：此时d_un指向了重定位表的地址。</li>
<li>DT_RELASZ：此时d_un指定了重定位表的总大小。</li>
<li>DT_RELAENT：此时d_un指定了每个重定位条目的大小（一般24字节）。</li>
</ul>
<p>而重定位表（RELA类型）中的每个元素的结构（Elf_Rela）是这样的：</p>
<ul>
<li>r_offset：需要修改的、需要重定位的地址偏移量。（字节）</li>
<li>r_info：这个成员变量包含2个信息——高4字节表示符号表索引，指向动态符号表（.dynsym）中的符号条目，该符号的地址将用于重定位计算；低4字节表示修正规则，用于判断执行哪种类型的地址修正操作。</li>
<li>r_addend：一个显式的加数，一个有符号的常量，它会参与重定位的计算中，比如说：写入r_offset的位置的值可能是符号地址 + r_addend。</li>
</ul>
<p>而如果是REL类型的重定位表，相关的d_tag则是少了一个A，比如说，DT_REL、DT_RELSZ、DT_RELENT。</p>
<p>而REL类型重定位表每个元素的的结构只有：r_offset和r_info。</p>
<p>接下来是实操。</p>
<p>通过 <strong>readelf -r libjiagu_a64.so –use-dynamic</strong>，可以获得重定位表表项的信息。</p>
<p>第一条表项，是不是很眼熟？正是我们.init_array的地址，（除此之外，没找到0x2d768），由于r_info的低32位是0403，代表修正操作是R_AARCH64_RELATIV，这个修正规则的符号索引通常是0（指向空符号），因为这种重定位规则是相对于模块自身的加载基址，不依赖于其他特定符号。</p>
<p>因此，.init_array的第一个函数指针是sub_98a0。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522182759789.png" alt="image-20250522182759789"></p>
<p>别着急找JNI_OnLoad，还没完，突然注意到RELA表中，第二项的Type也是R_AARCH64_RELATIV，并且r_addend是0x2e20，这不正是我们之前看到的start函数的地址吗？</p>
<p>它被存放到了0x2d770的位置，这个地址离.init_array就差16个字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250521220343528.png" alt="image-20250521220343528"></p>
<p>还记得我们之前使用readelf -a读到了.init_array的地址，其实当时还读到了.fini_array的地址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522183812989.png" alt="image-20250522183812989"></p>
<p>也就是说，这个start是.fini_array上的函数指针，很有迷惑性，.fini_array上的函数指针，是当程序退出的时候执行的，却取名叫了start。</p>
<p>至此，我们找到了.init_array上的函数指针：<strong>sub_98a0</strong>。</p>
<p><strong>下一步，动态链接器是如何找到JNI_OnLoad的呢？</strong></p>
<p>动态链接器在执行完.init_array上函数指针的函数后，会调用dlsym(handle, “JNI_OnLoad”)，用于在库中查找一个名为”JNI_OnLoad”的<strong>导出符号</strong>，具体来说，dlsym()回到库的动态符号表(.dynsym)中搜索这个名称，如果找到了这个符号，就会返回这个符号的内存地址，由Dalvik&#x2F;ART虚拟机传递JavaVM*指针和一个保留参数并执行这个指向JNI_OnLoad的函数。</p>
<p>实操如下。</p>
<p>通过.dynamic的节表找到.dynamic节在文件中的偏移。</p>
<p>通过010editor，找到节头表（动态链接器会根据PHT来找，节表在装载过程可有可无），然后根据节头表找到.dynamic节的偏移。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522163243458.png" alt="image-20250522163243458" style="zoom:67%;" />

<p>然后从0x1DAD0的位置，寻找d_tag &#x3D;&#x3D; DT_SYMTAB（0x6）的表项。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522192323619.png" alt="image-20250522192323619"></p>
<p>可以从d_un知道，动态符号表的偏移是0x4E8。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522192408776.png" alt="image-20250522192408776"></p>
<p>**动态符号表（.dynsym）**每个元素的结构（Elf64_Sym）是这样的。</p>
<ul>
<li>一共24个字节。</li>
<li>st_name：4个字节，表示相对于动态字符串表起始地址（.dynstr）中的偏移，如果该值为0，表示该符号没有名称。</li>
<li>st_info：1个字节，表示符号的<strong>类型</strong>和<strong>绑定属性</strong>（根据这1个字节的不同位区分），类型：函数还是对象；绑定属性：全局还是局部。</li>
<li>st_other：1个字节，定义符号的可见性。</li>
<li>st_shndx：2个字节，符号相关的节头表索引，指明了该符号定义在哪个节区（特殊值有：未定义符号-SHN_UNDEF、绝对符号-SHN_ABS）。</li>
<li>st_value：8个字节，符号的值，通常是符号的虚拟地址。</li>
<li>st_size：8个字节，符号关联的数据的大小，以字节为单位，例如：函数体的大小或者数据对象的大小。</li>
</ul>
<p>而动态字符串表（.dynstr）里面，全部放着字符串，动态符号表的st_name的索引，对应着动态字符串表首地址的偏移量。</p>
<p>在动态符号表中，每个数据对象占24（0x18）个字节，我们假设JNI_OnLoad这个字符串一定存在于.dynstr里，先去计算它相对于.dynstr的首地址的偏移量。</p>
<p>找动态字符串表有个快捷的方式，直接在IDA中shift + f12，起始地址是0xFB0。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522210913892.png" alt="image-20250522210913892" style="zoom:80%;" />

<p>然后搜索”JNI_OnLoad”，先考虑第1个JNI_OnLoad的偏移吧，如果根据第1个的偏移找不到，再考虑第2个。（仅仅根据字符串，无法通过交叉引用追踪到JNI_OnLoad的函数地址）</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522211014029.png" alt="image-20250522211014029"></p>
<p>计算偏移，得出0x230。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522211223432.png" alt="image-20250522211223432"></p>
<p>接下来，从动态符号表（从0x4E8开始找）中，每次查看24字节的前4个字节，寻找0x230，然后根据st_value，找到符号的虚拟地址。——由于是小端排序，可以直接在010editor搜索，30 02。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522213102676.png" alt="image-20250522213102676" style="zoom:80%;" />

<p>根据st_value在结构体中的偏移量，st_value &#x3D; 0x8AFC。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522213143598.png" alt="image-20250522213143598"></p>
<p>接下来我们去看看0x8AFC符不符合JNI_OnLoad的特征。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522213451658.png" alt="image-20250522213451658" style="zoom: 67%;" />

<p>其中，sub_8C74里面有关于JNI_OnLoad字符串的出现。</p>
<p>sub_4c70像不像dlsym？dlsym根据动态链接库操作句柄(pHandle)与符号(symbol)，返回符号对应的地址，也就是一个函数指针，为什么有2个JNI_OnLoad呢？我<strong>猜测</strong>是壳so加载了一个so（暂且叫做主so），而这个主so负责JNI动态注册，简单来说，壳so的JNI_OnLoad调用了主so的JNI_OnLoad。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522214248568.png" alt="image-20250522214248568"></p>
<p>至此，做个小总结，.init_array节上有函数指针sub_98a0，而壳so的JNI_OnLoad地址是0x8AFC，为了验证猜想，我们可以dump一个内存中加载好的libjiagu_64.so进行验证。</p>
<p>通过frida进行dump。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">my_hook_dlopen</span>(<span class="params">soName = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;准备加载&quot;</span>)</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="title function_">dump_so</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump_so</span>(<span class="params">so_name</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(so_name)</span><br><span class="line">    <span class="keyword">var</span> libso = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(so_name);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[name]:&quot;</span>, libso.<span class="property">name</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[base]:&quot;</span>, libso.<span class="property">base</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[size]:&quot;</span>, <span class="title function_">ptr</span>(libso.<span class="property">size</span>));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[path]:&quot;</span>, libso.<span class="property">path</span>);</span><br><span class="line">    <span class="keyword">var</span> file_path = <span class="string">&quot;/data/data/com.oacia.apk_protect/&quot;</span> + libso.<span class="property">name</span> + <span class="string">&quot;_&quot;</span> + libso.<span class="property">base</span> + <span class="string">&quot;_&quot;</span> + <span class="title function_">ptr</span>(libso.<span class="property">size</span>) + <span class="string">&quot;.so&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="title function_">ptr</span>(libso.<span class="property">base</span>), libso.<span class="property">size</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> libso_buffer = <span class="title function_">ptr</span>(libso.<span class="property">base</span>).<span class="title function_">readByteArray</span>(libso.<span class="property">size</span>);</span><br><span class="line">        file_handle.<span class="title function_">write</span>(libso_buffer);</span><br><span class="line">        file_handle.<span class="title function_">flush</span>();</span><br><span class="line">        file_handle.<span class="title function_">close</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump]:&quot;</span>, file_path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="title function_">my_hook_dlopen</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>然后使用elf修复工具进行修复，再用ida打开，这回导入、导出表的内容恢复了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522125906310.png" alt="image-20250522125906310" style="zoom:50%;" />

<p>来查看.init_array和JNI_OnLoad的地址。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522215252155.png" alt="image-20250522215252155" style="zoom: 67%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522215337793.png" alt="image-20250522215337793"></p>
<p>下图是壳so的JNI_OnLoad。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522215721040.png" alt="image-20250522215721040"></p>
<p>下图是主so的JNI_OnLoad。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522215826312.png" alt="image-20250522215826312" style="zoom:80%;" />

<p>暂且就不去分析sub_98a0和壳so的JNI_OnLoad的代码了，应该是修复导入、导出表，执行JNI_OnLoad、反调等操作。接下来会使用frida对这一块内容进行分析。</p>
<hr>
<p>注意到，在frida注入代码，dump了so文件之后，进程会立即退出。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522125830770.png" alt="image-20250522125830770" style="zoom:80%;" />

<p>hook了android_dlopen_ext，发现进程在加载了libjiagu_64.so后就退出了，说明检测frida的代码大概率在这个so文件里。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522130529768.png" alt="image-20250522130529768"></p>
<p>通过hook发现，libjiagu_64.so的某段代码一直在检测maps文件，应该是这里在检测调试器。</p>
<p>解决办法：可以hook函数open，每当要执行函数open时，判断目标文件是否为maps文件，如果是，重定位到一个不存在的文件。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522130853416.png" alt="image-20250522130853416" style="zoom:80%;" />

<p>hook的脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">my_hook_dlopen</span>(<span class="params">soName = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_proc_self_maps</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_proc_self_maps</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> openPtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> open = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fakePath = <span class="string">&quot;/data/data/com.oacia.apk_protect/maps&quot;</span>;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(openPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">pathnameptr, flag</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> pathname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(pathnameptr);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;open&quot;</span>, pathname);</span><br><span class="line">        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;maps&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find&quot;</span>,pathname,<span class="string">&quot;,redirect to&quot;</span>,fakePath);</span><br><span class="line">            <span class="keyword">var</span> filename = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(fakePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">open</span>(filename, flag);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> fd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(my_hook_dlopen,<span class="string">&quot;libjiagu&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>虽然还是退出了，但这次有了新的收获，可以看到打开了3个dex文件。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522131044479.png" alt="image-20250522131044479" style="zoom:80%;" />

<p>用010editor打开，发现第一个dex处于加密状态，而其它的dex是空的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522131542842.png" alt="image-20250522131542842"></p>
<p>为了判断是哪里的代码open了dex文件，可以打印一下堆栈，常规的打印堆栈的方式是加下面这句代码，但我们前面将maps文件重定位了，所以不能使用DebugSymbol.fromAddress（用到了maps文件）了，得自己实现一个函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;RegisterNatives called from:\\n&#x27;</span> + <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">FUZZY</span>).<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&#x27;\\n&#x27;</span>) + <span class="string">&#x27;\\n&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>修改后的完整代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">addr_in_so</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> process_Obj_Module_Arr = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; process_Obj_Module_Arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(addr&gt;process_Obj_Module_Arr[i].<span class="property">base</span> &amp;&amp; addr&lt;process_Obj_Module_Arr[i].<span class="property">base</span>.<span class="title function_">add</span>(process_Obj_Module_Arr[i].<span class="property">size</span>))&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(addr.<span class="title function_">toString</span>(<span class="number">16</span>),<span class="string">&quot;is in&quot;</span>,process_Obj_Module_Arr[i].<span class="property">name</span>,<span class="string">&quot;offset: 0x&quot;</span>+(addr-process_Obj_Module_Arr[i].<span class="property">base</span>).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_proc_self_maps</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> openPtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> open = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fakePath = <span class="string">&quot;/data/data/com.oacia.apk_protect/maps_nonexistent&quot;</span>;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(openPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">pathnameptr, flag</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> pathname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(pathnameptr);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;open&quot;</span>,pathname);<span class="comment">//,Process.getCurrentThreadId()</span></span><br><span class="line">        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;maps&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find&quot;</span>,pathname+<span class="string">&quot;, redirect to&quot;</span>,fakePath);</span><br><span class="line">            <span class="keyword">var</span> filename = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(fakePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">open</span>(filename, flag);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;dex&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">FUZZY</span>).<span class="title function_">map</span>(addr_in_so);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> fd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">my_hook_dlopen</span>(<span class="params">soName=<span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="comment">//console.log(path);</span></span><br><span class="line">                    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_proc_self_maps</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(my_hook_dlopen,<span class="string">&#x27;libjiagu&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>可以看到3个dex文件被打开时的调用栈了，鉴于3个dex文件的调用栈基本一样，大概率是在一个循环中依次加载的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522133014663.png" alt="image-20250522133014663" style="zoom: 67%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522133032024.png" alt="image-20250522133032024" style="zoom:67%;" />

<p>来到0x19b780，发现都是0，应该是在加载完dex文件后，将这块空间清空了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523131131946.png" alt="image-20250523131131946" style="zoom:50%;" />

<p>为了分析这块代码的逻辑，需要在open dex文件的时候，将so文件dump下来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hook_once = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">my_hook_dlopen</span>(<span class="params">soName = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;准备加载&quot;</span>)</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="comment">// 获得open的地址</span></span><br><span class="line">                    <span class="keyword">const</span> openPtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">                    <span class="comment">// 准备替换的open</span></span><br><span class="line">                    <span class="keyword">const</span> open = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">                    <span class="comment">// hook</span></span><br><span class="line">                    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(openPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">pathnameptr, flag</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> pathname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(pathnameptr);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;open&quot;</span>, pathname);<span class="comment">//,Process.getCurrentThreadId()</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;maps&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> fakePath = <span class="string">&quot;/data/data/com.oacia.apk_protect/maps_nonexistent&quot;</span>;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find&quot;</span>,pathname+<span class="string">&quot;, redirect to&quot;</span>,fakePath);</span><br><span class="line">                            <span class="keyword">var</span> filename = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(fakePath);</span><br><span class="line">                            <span class="keyword">return</span> <span class="title function_">open</span>(filename, flag);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;/data/data/com.oacia.apk_protect/.jiagu/classes&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span>(hook_once == <span class="number">0</span>)&#123;</span><br><span class="line">                                <span class="title function_">dump_so</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>);</span><br><span class="line">                                hook_once = <span class="number">1</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">var</span> fd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">                        <span class="keyword">return</span> fd;</span><br><span class="line">                    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump_so</span>(<span class="params">so_name</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(so_name)</span><br><span class="line">    <span class="keyword">var</span> libso = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(so_name);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[name]:&quot;</span>, libso.<span class="property">name</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[base]:&quot;</span>, libso.<span class="property">base</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[size]:&quot;</span>, <span class="title function_">ptr</span>(libso.<span class="property">size</span>));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[path]:&quot;</span>, libso.<span class="property">path</span>);</span><br><span class="line">    <span class="keyword">var</span> file_path = <span class="string">&quot;/data/data/com.oacia.apk_protect/&quot;</span> + libso.<span class="property">name</span> + <span class="string">&quot;_&quot;</span> + libso.<span class="property">base</span> + <span class="string">&quot;_&quot;</span> + <span class="title function_">ptr</span>(libso.<span class="property">size</span>) + <span class="string">&quot;.so&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="title function_">ptr</span>(libso.<span class="property">base</span>), libso.<span class="property">size</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> libso_buffer = <span class="title function_">ptr</span>(libso.<span class="property">base</span>).<span class="title function_">readByteArray</span>(libso.<span class="property">size</span>);</span><br><span class="line">        file_handle.<span class="title function_">write</span>(libso_buffer);</span><br><span class="line">        file_handle.<span class="title function_">flush</span>();</span><br><span class="line">        file_handle.<span class="title function_">close</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump]:&quot;</span>, file_path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="title function_">my_hook_dlopen</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>脚本执行结果。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522134705450.png" alt="image-20250522134705450" style="zoom:67%;" />

<p> 修复之后，用IDA打开，定位到0x19b780。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523131209960.png" alt="image-20250523131209960" style="zoom:80%;" />

<p>可以使用winmerge查看两个文件的区别。分析被抽空的数据，是从哪里开始抽空的</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523131635457.png" alt="image-20250523131635457"></p>
<p>往上滚动，直到0xe7000，两边的文件才基本一模一样。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523131949048.png" alt="image-20250523131949048"></p>
<p>注意到，0xe7000存放的是.ELF，这是ELF文件的魔数。也就是说，壳so里面藏了一个so（主so）。</p>
<p>使用下面这个脚本，将壳so里的ELF文件读出来，放入010editor查看。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;libjiagu_64.so_0x6f71613000_0x274000.so&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    s=f.read()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;libjiagu_0xe7000.so&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(s[<span class="number">0xe7000</span>::])</span><br></pre></td></tr></table></figure>

<p>除了ELF头，段头表和节表都被加密了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523132740721.png" alt="image-20250523132740721"></p>
<p>因此，IDA无法对这个ELF文件进行正常的分析。</p>
<p>根据前人的分析，壳ELF会对加密的主ELF进行解密，并且自己实现了linker，对主ELF进行解析，再将解析结果赋值到soinfo结构体中，然后调用dlopen进行手动加载。</p>
<p>先简单介绍一下什么是dlopen、dlsym和soinfo。</p>
<p><strong><code>dlopen</code> (Dynamic Load Open)</strong></p>
<ul>
<li><strong>是什么</strong>：<code>dlopen</code> 是一个标准 C 库函数（定义在 <code>dlfcn.h</code> 中，通常由 <code>libdl.so</code> 提供）。它允许程序在运行时（而不是在程序启动时）显式地加载指定的共享对象（SO文件）到其地址空间。</li>
<li><strong>作用</strong>：当程序调用 <code>dlopen(&quot;path/to/your_library.so&quot;, flags)</code> 时，它会请求动态链接器加载这个库。如果加载成功，<code>dlopen</code> 会返回一个“句柄 (handle)”，后续可以使用这个句柄通过 <code>dlsym</code> 查找库中的符号（函数或变量），或者通过 <code>dlclose</code>卸载该库。</li>
<li><strong>谁调用它</strong>：应用程序代码可以直接调用 <code>dlopen</code> 来实现插件系统、按需加载功能模块等。在Java&#x2F;Kotlin层面，<code>System.loadLibrary()</code> 或 <code>System.load()</code> 在底层通常也是通过调用 <code>dlopen</code> 来加载JNI库的。</li>
</ul>
<p><strong><code>soinfo</code> (Shared Object Information)</strong></p>
<ul>
<li><strong>是什么</strong>：<code>soinfo</code> 是<strong>Android动态链接器内部使用的一个非常重要的数据结构</strong>。对于加载到进程中的<strong>每一个SO文件</strong>，动态链接器都会在内部创建一个对应的 <code>soinfo</code> 实例来管理它。其他类Unix系统的动态链接器也会有类似的内部结构来跟踪已加载的库，但 <code>soinfo</code> 这个名称特指Android的实现（源于Bionic C库的链接器）。</li>
<li><strong>作用</strong>：soinfo结构体存储了关于一个已加载SO文件的所有关键运行时信息，例如：<ul>
<li>库的名称和完整路径。</li>
<li>库在内存中的加载基地址 (base address) 和大小。</li>
<li>指向其ELF动态段 (<code>.dynamic</code> section) 的指针。</li>
<li>指向其动态符号表 (<code>.dynsym</code>)、字符串表 (<code>.dynstr</code>)、哈希表 (<code>.hash</code> 或 <code>.gnu.hash</code>) 的指针。</li>
<li>重定位表的信息。</li>
<li>依赖的其他 <code>soinfo</code> 实例的列表。</li>
<li>库的句柄 (handle)、引用计数。</li>
<li>初始化状态（例如，构造函数&#x2F;<code>.init_array</code> 是否已运行）。</li>
<li>标志位（例如，是否是主可执行程序、是否是PIE等）。</li>
</ul>
</li>
</ul>
<p>应用程序通过dlopen函数请求加载一个so文件，dlopen会将这个请求传递给动态链接器linker，动态链接器linker负责实际执行加载so文件的所有底层工作（查找文件、映射内存、解析依赖、重定位符号、运行初始化代码等）。在加载so文件的过程中，动态链接器会为这个新加载的so文件创建一个soinfo结构体实例，这个soinfo包含了管理该so所需的所有元数据和状态信息。</p>
<p>而当后续调用dlsym查找该库某个符号时，链接器会查阅对应soinfo中记录的符号表等信息——dlopen获得的handle，实际上就是soinfo结构体实例的指针。</p>
<p>因此，可以理解壳ELF的行为：对主ELF文件进行解析、映射、重定位…创建soinfo结构实例，然后供dlsym使用，获得符号的地址。</p>
<p>主so是壳so加载起来的，但要是连依赖项也由壳处理，就过于麻烦了，所以前人分析会用到dlopen，于是进行交叉引用追踪。</p>
<p>在函数sub_3C94中，用到了dlopen，同时会发现，这里的代码和aosp源码的预链接十分相似，下图是sub_3C94的代码。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523143433747.png" alt="image-20250523143433747"></p>
<p>下图是AOSP源码中的预链接（直接用oacia大佬的图）。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523143521988.png" alt="image-20250523143521988" style="zoom: 50%;" />

<p>添加前人准备好的关于soinfo的结构体，然后将参数a1类型改成soinfo *。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ELF64 启用该宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LP64__ 1</span></span><br><span class="line"><span class="comment">// ELF32 启用该宏</span></span><br><span class="line"><span class="comment">//#define __work_around_b_24465209__ 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">https://android.googlesource.com/platform/bionic/+/master/linker/Android.bp</span></span><br><span class="line"><span class="comment">架构为 32 位 定义__work_around_b_24465209__宏arch: &#123;</span></span><br><span class="line"><span class="comment">    arm: &#123;cflags: [&quot; D__work_around_b_24465209__&quot;],&#125;,</span></span><br><span class="line"><span class="comment">    x86: &#123;cflags: [&quot; D__work_around_b_24465209__&quot;],&#125;,</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 ELF 文件的基本类型，根据架构决定使用 ELF32 或 ELF64 类型</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__LP64__)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> ElfW(type) Elf64_ ## type</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> ElfW(type) Elf32_ ## type</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 32 位和 64 位重定位和符号表数据结构</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Elf32 和 Elf64 基本类型</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">signed</span> <span class="type">char</span> __s8;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> __u8;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">signed</span> <span class="type">short</span> __s16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">short</span> __u16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">signed</span> <span class="type">int</span> __s32;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> __u32;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">signed</span> <span class="type">long</span> <span class="type">long</span> __s64;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> __u64;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 32 位 ELF 基本类型</span></span><br><span class="line"><span class="keyword">typedef</span> __u32 Elf32_Addr;</span><br><span class="line"><span class="keyword">typedef</span> __u16 Elf32_Half;</span><br><span class="line"><span class="keyword">typedef</span> __u32 Elf32_Off;</span><br><span class="line"><span class="keyword">typedef</span> __s32 Elf32_Sword;</span><br><span class="line"><span class="keyword">typedef</span> __u32 Elf32_Word;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 64 位 ELF 基本类型</span></span><br><span class="line"><span class="keyword">typedef</span> __u64 Elf64_Addr;</span><br><span class="line"><span class="keyword">typedef</span> __u16 Elf64_Half;</span><br><span class="line"><span class="keyword">typedef</span> __s16 Elf64_SHalf;</span><br><span class="line"><span class="keyword">typedef</span> __u64 Elf64_Off;</span><br><span class="line"><span class="keyword">typedef</span> __s32 Elf64_Sword;</span><br><span class="line"><span class="keyword">typedef</span> __u32 Elf64_Word;</span><br><span class="line"><span class="keyword">typedef</span> __u64 Elf64_Xword;</span><br><span class="line"><span class="keyword">typedef</span> __s64 Elf64_Sxword;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态段数据结构（Elf32 和 Elf64）</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dynamic</span> &#123;</span></span><br><span class="line">    Elf32_Sword d_tag;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        Elf32_Sword d_val;</span><br><span class="line">        Elf32_Addr d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf64_Sxword d_tag; <span class="comment">/* entry tag value */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        Elf64_Xword d_val;</span><br><span class="line">        Elf64_Addr d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf64_Dyn;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重定位数据结构（Elf32 和 Elf64）</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf32_rel</span> &#123;</span></span><br><span class="line">    Elf32_Addr r_offset;</span><br><span class="line">    Elf32_Word r_info;</span><br><span class="line">&#125; Elf32_Rel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf64_rel</span> &#123;</span></span><br><span class="line">    Elf64_Addr r_offset; <span class="comment">/* Location at which to apply the action */</span></span><br><span class="line">    Elf64_Xword r_info;  <span class="comment">/* index and type of relocation */</span></span><br><span class="line">&#125; Elf64_Rel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf32_rela</span> &#123;</span></span><br><span class="line">    Elf32_Addr r_offset;</span><br><span class="line">    Elf32_Word r_info;</span><br><span class="line">    Elf32_Sword r_addend;</span><br><span class="line">&#125; Elf32_Rela;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf64_rela</span> &#123;</span></span><br><span class="line">    Elf64_Addr r_offset;  <span class="comment">/* Location at which to apply the action */</span></span><br><span class="line">    Elf64_Xword r_info;   <span class="comment">/* index and type of relocation */</span></span><br><span class="line">    Elf64_Sxword r_addend; <span class="comment">/* Constant addend used to compute value */</span></span><br><span class="line">&#125; Elf64_Rela;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 符号表数据结构（Elf32 和 Elf64）</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf32_sym</span> &#123;</span></span><br><span class="line">    Elf32_Word st_name;</span><br><span class="line">    Elf32_Addr st_value;</span><br><span class="line">    Elf32_Word st_size;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> st_info;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> st_other;</span><br><span class="line">    Elf32_Half st_shndx;</span><br><span class="line">&#125; Elf32_Sym;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf64_sym</span> &#123;</span></span><br><span class="line">    Elf64_Word st_name;     <span class="comment">/* Symbol name, index in string tbl */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> st_info;  <span class="comment">/* Type and binding attributes */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> st_other; <span class="comment">/* No defined meaning, 0 */</span></span><br><span class="line">    Elf64_Half st_shndx;    <span class="comment">/* Associated section index */</span></span><br><span class="line">    Elf64_Addr st_value;    <span class="comment">/* Value of the symbol */</span></span><br><span class="line">    Elf64_Xword st_size;    <span class="comment">/* Associated symbol size */</span></span><br><span class="line">&#125; Elf64_Sym;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ELF 文件头数据结构（Elf32 和 Elf64）</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EI_NIDENT 16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf32_hdr</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> e_ident[EI_NIDENT];</span><br><span class="line">    Elf32_Half e_type;</span><br><span class="line">    Elf32_Half e_machine;</span><br><span class="line">    Elf32_Word e_version;</span><br><span class="line">    Elf32_Addr e_entry; <span class="comment">/* Entry point */</span></span><br><span class="line">    Elf32_Off e_phoff;</span><br><span class="line">    Elf32_Off e_shoff;</span><br><span class="line">    Elf32_Word e_flags;</span><br><span class="line">    Elf32_Half e_ehsize;</span><br><span class="line">    Elf32_Half e_phentsize;</span><br><span class="line">    Elf32_Half e_phnum;</span><br><span class="line">    Elf32_Half e_shentsize;</span><br><span class="line">    Elf32_Half e_shnum;</span><br><span class="line">    Elf32_Half e_shstrndx;</span><br><span class="line">&#125; Elf32_Ehdr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf64_hdr</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> e_ident[EI_NIDENT]; <span class="comment">/* ELF &quot;magic number&quot; */</span></span><br><span class="line">    Elf64_Half e_type;</span><br><span class="line">    Elf64_Half e_machine;</span><br><span class="line">    Elf64_Word e_version;</span><br><span class="line">    Elf64_Addr e_entry;  <span class="comment">/* Entry point virtual address */</span></span><br><span class="line">    Elf64_Off e_phoff;   <span class="comment">/* Program header table file offset */</span></span><br><span class="line">    Elf64_Off e_shoff;   <span class="comment">/* Section header table file offset */</span></span><br><span class="line">    Elf64_Word e_flags;</span><br><span class="line">    Elf64_Half e_ehsize;</span><br><span class="line">    Elf64_Half e_phentsize;</span><br><span class="line">    Elf64_Half e_phnum;</span><br><span class="line">    Elf64_Half e_shentsize;</span><br><span class="line">    Elf64_Half e_shnum;</span><br><span class="line">    Elf64_Half e_shstrndx;</span><br><span class="line">&#125; Elf64_Ehdr;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 程序头数据结构（Elf32 和 Elf64）</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf32_phdr</span> &#123;</span></span><br><span class="line">    Elf32_Word p_type;</span><br><span class="line">    Elf32_Off p_offset;</span><br><span class="line">    Elf32_Addr p_vaddr;</span><br><span class="line">    Elf32_Addr p_paddr;</span><br><span class="line">    Elf32_Word p_filesz;</span><br><span class="line">    Elf32_Word p_memsz;</span><br><span class="line">    Elf32_Word p_flags;</span><br><span class="line">    Elf32_Word p_align;</span><br><span class="line">&#125; Elf32_Phdr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf64_phdr</span> &#123;</span></span><br><span class="line">    Elf64_Word p_type;</span><br><span class="line">    Elf64_Word p_flags;</span><br><span class="line">    Elf64_Off p_offset;  <span class="comment">/* Segment file offset */</span></span><br><span class="line">    Elf64_Addr p_vaddr;  <span class="comment">/* Segment virtual address */</span></span><br><span class="line">    Elf64_Addr p_paddr;  <span class="comment">/* Segment physical address */</span></span><br><span class="line">    Elf64_Xword p_filesz; <span class="comment">/* Segment size in file */</span></span><br><span class="line">    Elf64_Xword p_memsz;  <span class="comment">/* Segment size in memory */</span></span><br><span class="line">    Elf64_Xword p_align;  <span class="comment">/* Segment alignment, file &amp; memory */</span></span><br><span class="line">&#125; Elf64_Phdr;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 节头数据结构（Elf32 和 Elf64）</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf32_shdr</span> &#123;</span></span><br><span class="line">    Elf32_Word sh_name;</span><br><span class="line">    Elf32_Word sh_type;</span><br><span class="line">    Elf32_Word sh_flags;</span><br><span class="line">    Elf32_Addr sh_addr;</span><br><span class="line">    Elf32_Off sh_offset;</span><br><span class="line">    Elf32_Word sh_size;</span><br><span class="line">    Elf32_Word sh_link;</span><br><span class="line">    Elf32_Word sh_info;</span><br><span class="line">    Elf32_Word sh_addralign;</span><br><span class="line">    Elf32_Word sh_entsize;</span><br><span class="line">&#125; Elf32_Shdr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf64_shdr</span> &#123;</span></span><br><span class="line">    Elf64_Word sh_name;       <span class="comment">/* Section name, index in string tbl */</span></span><br><span class="line">    Elf64_Word sh_type;       <span class="comment">/* Type of section */</span></span><br><span class="line">    Elf64_Xword sh_flags;     <span class="comment">/* Miscellaneous section attributes */</span></span><br><span class="line">    Elf64_Addr sh_addr;       <span class="comment">/* Section virtual addr at execution */</span></span><br><span class="line">    Elf64_Off sh_offset;      <span class="comment">/* Section file offset */</span></span><br><span class="line">    Elf64_Xword sh_size;      <span class="comment">/* Size of section in bytes */</span></span><br><span class="line">    Elf64_Word sh_link;       <span class="comment">/* Index of another section */</span></span><br><span class="line">    Elf64_Word sh_info;       <span class="comment">/* Additional section information */</span></span><br><span class="line">    Elf64_Xword sh_addralign; <span class="comment">/* Section alignment */</span></span><br><span class="line">    Elf64_Xword sh_entsize;   <span class="comment">/* Entry size if section holds table */</span></span><br><span class="line">&#125; Elf64_Shdr;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态链接信息结构（Android 特有）</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*<span class="type">linker_dtor_function_t</span>)</span><span class="params">()</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*<span class="type">linker_ctor_function_t</span>)</span><span class="params">(<span class="type">int</span>, <span class="type">char</span>**, <span class="type">char</span>**)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__work_around_b_24465209__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOINFO_NAME_LEN 128</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Android 中的 soinfo 结构体，用于表示动态链接库信息</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">soinfo</span> &#123;</span></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> defined(__work_around_b_24465209__)</span></span><br><span class="line">    <span class="type">char</span> old_name_[SOINFO_NAME_LEN];</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Phdr)</span>* phdr;</span><br><span class="line">    <span class="type">size_t</span> phnum;</span><br><span class="line">    ElfW(Addr) base;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    ElfW(Dyn)* dynamic;</span><br><span class="line">    soinfo* next;</span><br><span class="line">    <span class="type">uint32_t</span> flags_;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* strtab_;</span><br><span class="line">    ElfW(Sym)* symtab_;</span><br><span class="line">    <span class="type">size_t</span> nbucket_;</span><br><span class="line">    <span class="type">size_t</span> nchain_;</span><br><span class="line">    <span class="type">uint32_t</span>* bucket_;</span><br><span class="line">    <span class="type">uint32_t</span>* chain_;</span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> !defined(__LP64__)</span></span><br><span class="line">    ElfW(Addr)** unused4; <span class="comment">// DO NOT USE, maintained for compatibility</span></span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> defined(USE_RELA)</span></span><br><span class="line">    ElfW(Rela)* plt_rela_;</span><br><span class="line">    <span class="type">size_t</span> plt_rela_count_;</span><br><span class="line">    ElfW(Rela)* rela_;</span><br><span class="line">    <span class="type">size_t</span> rela_count_;</span><br><span class="line">    <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    ElfW(Rel)* plt_rel_;</span><br><span class="line">    <span class="type">size_t</span> plt_rel_count_;</span><br><span class="line">    ElfW(Rel)* rel_;</span><br><span class="line">    <span class="type">size_t</span> rel_count_;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">linker_ctor_function_t</span>* preinit_array_;</span><br><span class="line">    <span class="type">size_t</span> preinit_array_count_;</span><br><span class="line">    <span class="type">linker_ctor_function_t</span>* init_array_;</span><br><span class="line">    <span class="type">size_t</span> init_array_count_;</span><br><span class="line">    <span class="type">linker_dtor_function_t</span>* fini_array_;</span><br><span class="line">    <span class="type">size_t</span> fini_array_count_;</span><br><span class="line">    <span class="type">linker_ctor_function_t</span> init_func_;</span><br><span class="line">    <span class="type">linker_dtor_function_t</span> fini_func_;</span><br><span class="line">    <span class="type">size_t</span> ref_count_;</span><br><span class="line">    link_map link_map_head;</span><br><span class="line">    <span class="type">bool</span> constructors_called;</span><br><span class="line">    ElfW(Addr) load_bias;</span><br><span class="line">    <span class="type">bool</span> has_text_relocations;</span><br><span class="line">    <span class="type">bool</span> has_DT_SYMBOLIC;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如果是一个标准的soinfo结构，不会出现a1[1]，只能说壳ELF的soinfo魔改了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523145851806.png" alt="image-20250523145851806"></p>
<p>简单分析一下sub_3C94做了什么：</p>
<ol>
<li>构建soinfo实例，从一些硬编码的信息中，将soinfo实例进行初始化；</li>
<li>加载主so的依赖库；</li>
</ol>
<p>这些硬编码信息的偏移量是从a1获得的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523152403741.png" alt="image-20250523152403741" style="zoom: 67%;" />

<p>sub_49F0调用了sub_3C94。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523152508833.png" alt="image-20250523152508833" style="zoom:80%;" />

<p>v5的值与v1有关，v1的值与a1有关，a1的值来自sub_49f0的调用者——sub_4B54。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523152541657.png" alt="image-20250523152541657" style="zoom:80%;" />

<p>a1的值与a2有关，但在函数sub_6128中，a2的值是由a1得来的，因此，还得继续追踪sub_4B54的调用者。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523152738670.png" alt="image-20250523152738670"></p>
<p>sub_4B54有2个调用者，其中，sub_8c74很眼熟。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523153052668.png" alt="image-20250523153052668"></p>
<p>0x8AFC是JNI_OnLoad的函数地址，其实之前交叉引用sub_8C74的时候，发现没有函数引用sub_8C74，但JNI_OnLoad的伪代码里突然发现了sub_8c74。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523160437480.png" alt="image-20250523160437480" style="zoom: 50%;" />

<p>通过汇编代码，可以看到，BL指令的下一条指令就是sub_8C74，<strong>这种方式的调用可能让IDA无法正常分析了</strong>。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523162349320.png" alt="image-20250523162349320" style="zoom:80%;" />

<p>言归正传，也就是说，当壳so被加载起来后，会通过JNI_OnLoad，最终将主so进行解析并加载。</p>
<p>回到sub_3C94的调用者——sub_49F0。</p>
<p>只有当sub_3C94的返回值是奇数，才能进一步执行sub_4918，而sub_3C94的作用我们前面分析过了（将主so的元数据填到soinfo实例，然后加载主so的依赖），这里的sub_4918大概率是进一步完成主so的加载。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523163024028.png" alt="image-20250523163024028" style="zoom:80%;" />

<p>看到关于dynamic的字眼，大概率是重定位阶段。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523164348276.png" alt="image-20250523164348276"></p>
<p>点进sub_4000。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523165245625.png" alt="image-20250523165245625"></p>
<p>看到0x403，有点眼熟，搜了一下之前的内容，果然，v8是r_info的低32位，代表重定位过程，地址的修正规则，进一步说明当前函数是在进行重定位了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522182759789.png" alt="image-20250522182759789"></p>
<p>一般情况下，动态链接器会先对处理通用重定位（.rela.dyn或.rel.dyn），再处理 PLT 重定位（.rela.plt或.rel.plt）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523183558728.png" alt="image-20250523183558728"></p>
<p>再进入sub_5e6c观察。</p>
<ol>
<li><p>观察到0x38（56个字节），刚好是一个段表的大小。</p>
</li>
<li><p>调用了mprotect。</p>
</li>
</ol>
<p>基本可以确定，大概率是在处理各个LOAD段。</p>
<p>将begin_addr_pht_1类型改成elf64_phdr，IDA的伪代码将会更加清晰，下图是我分析后的sub_5E6C。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523184641892.png" alt="image-20250523184641892"></p>
<p>0x6474E552换成十进制是1685382482，可以通过010Editor知道其含义是PT_GNU_RELRO。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523190428752.png" alt="image-20250523190428752" style="zoom:80%;" />

<p>sub_5E6C 函数在处理 PT_GNU_RELRO 段。它的作用就是在“主SO”的重定位完成后，找到所有标记为 PT_GNU_RELRO 的程序段，并将这些段在内存中的对应区域设置为只读。这是ELF动态链接中的一个标准安全步骤，称为<strong>RELRO (Relocation Read-Only)</strong>，<strong>目的是保护那些在重定位后不应再被修改的数据段</strong>（如部分GOT表、.data.rel.ro段）免遭篡改。</p>
<p>既然，这里将RELRO的段设置成了只读，说明这个时候，所有的PHT都应该处于解密状态，尝试在这个时候读取PHT，将它们dump下来。</p>
<p>第1个参数代表程序头表（们）的起始地址，第2个参数代表数量，第3个参数还没分析。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523193144378.png" alt="image-20250523193144378"></p>
<p>使用frida脚本进行dump，需要注意，sub_5E6C是在壳so的JNI_OnLoad调用的，如果hook android_dlopen_ext，在onLeave回调时，hook sub_5E6C，那时就太晚了，JNI_OnLoad都执行完了，不会触发Interceptor.attach的trap。</p>
<p>因此，得hook call_constructors，在onEnter时进一步hook sub_5E6C，这个hook的时机是：壳so的内容映射到了内存中，但尚未执行init_proc、.init_array上的函数、JNI_OnLoad，这个时机就很完美。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 针对 call_constructors 进行 Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// 你手机的 linker64 中 call_constructors 的偏移量</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>); <span class="comment">// 目标 SO 文件</span></span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Hook 目标函数 sub_5E6C</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span>, <span class="string">&quot;Module libjiagu_64.so base_addr: &quot;</span>, secmodule.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>(); <span class="comment">// Hook 完成后解除</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 目标函数 sub_5E6C</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="comment">// sub_5E6C 的偏移</span></span><br><span class="line">    <span class="keyword">let</span> target_offset = <span class="number">0x5E6C</span>;</span><br><span class="line">    <span class="keyword">let</span> target_func = baseaddr.<span class="title function_">add</span>(target_offset);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_func, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] Hooking sub_5E6C at:&#x27;</span>, target_func);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取参数</span></span><br><span class="line">            <span class="keyword">let</span> begin_addr_pht = args[<span class="number">0</span>]; <span class="comment">// 第一个 PHT 条目的地址</span></span><br><span class="line">            <span class="keyword">let</span> nums_pht = args[<span class="number">1</span>]; <span class="comment">// PHT 条目数量</span></span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] PHT Parameters:&#x27;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;  - begin_addr_pht:&#x27;</span>, begin_addr_pht);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;  - nums_pht:&#x27;</span>, nums_pht);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;  - a3: 0x&#x27;</span> + args[<span class="number">2</span>].<span class="title function_">toString</span>(<span class="number">16</span>))</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 验证 PHT 条目数量</span></span><br><span class="line">            <span class="keyword">if</span> (nums_pht &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[-] Invalid PHT count:&#x27;</span>, nums_pht);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 计算 PHT 结束地址</span></span><br><span class="line">            <span class="keyword">let</span> pht_size_per_entry = <span class="number">56</span>; <span class="comment">// Elf64_Phdr 的大小为 56 字节</span></span><br><span class="line">            <span class="keyword">let</span> end_addr_pht = begin_addr_pht.<span class="title function_">add</span>(nums_pht * pht_size_per_entry);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 准备保存 PHT 数据</span></span><br><span class="line">            <span class="keyword">let</span> pht_data = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(nums_pht * pht_size_per_entry);</span><br><span class="line">            <span class="title class_">Memory</span>.<span class="title function_">copy</span>(pht_data, begin_addr_pht, nums_pht * pht_size_per_entry);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 保存到文件</span></span><br><span class="line">            <span class="keyword">let</span> file_path = <span class="string">&#x27;/data/data/com.oacia.apk_protect/pht_decrypt.bin&#x27;</span>;</span><br><span class="line">            <span class="keyword">let</span> file = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&#x27;wb&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (file &amp;&amp; file !== <span class="literal">null</span>) &#123;</span><br><span class="line">                file.<span class="title function_">write</span>(pht_data.<span class="title function_">readByteArray</span>(nums_pht * pht_size_per_entry));</span><br><span class="line">                file.<span class="title function_">flush</span>();</span><br><span class="line">                file.<span class="title function_">close</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] PHT dumped to:&#x27;</span>, file_path);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[-] Failed to open file:&#x27;</span>, file_path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] sub_5E6C returned:&#x27;</span>, retval);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动 Hook</span></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>结果如下（忽视掉进程终止^_^）。</p>
<p>可以发现：0x70089b4000 - 0x70088cd000 &#x3D; 0xe7000，而之前我们的分析中，偏移量0xe7000处是主so的起始地址，所以这里的a3是主so在内存中的基址。</p>
<p>同时，也可以看出来解密后的PHT的存放地址，和主so的ELF头并不在内存上相连（在之后的操作后就明白了，这里PHT的地址是堆的地址，主so的PHT是垃圾数据），与ELF头相连的PHT是垃圾数据填充的，或者说是加密的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523214928222.png" alt="image-20250523214928222"></p>
<p>将文件pull出来观察，看样子确实解密了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523200915894.png" alt="image-20250523200915894" style="zoom:67%;" />

<p>修改到之前脱掉的主so里去，现在可以清晰看到段表的内容了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523201154653.png" alt="image-20250523201154653"></p>
<p>至此，拿到了解密后的PHT，也知道了sub_5E6C的参数意义。</p>
<p>问题又来了，既然参数的意义分别是：第1个参数代表程序头表（们）的起始地址，第2个参数代表数量，第3个参数代表主so的基址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523220006379.png" alt="image-20250523220006379"></p>
<p>而soinfo的结构体是这样的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523220224280.png" alt="image-20250523220224280" style="zoom:80%;" />

<p>按理来说，soinfo偏移量为0的地方就是PHT的地址，而这里的a1-&gt;link_map_head.l_next实则指向了((byte*) a1) + 232，这说明在成员变量const Elf64_Phdr *phdr的前面，还有232字节，这232字节应该是360壳自定义的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523220603855.png" alt="image-20250523220603855"></p>
<p>添加后，第1个参数的位置对了，但第2个参数和第3个参数还是错的，说明还需要插入一些字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250523220720253.png" alt="image-20250523220720253"></p>
<p>正常情况应该是这样。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_5E6C(a1-&gt;phdr, a1-&gt;phnum, a1-&gt;base)</span><br></pre></td></tr></table></figure>

<p>为了知道壳ELF是怎么解密出来的，大佬oacia写了一个IDA插件：stalker_trace_so，这个脚本可以追踪native函数的执行顺序，但似乎不分线程，而且也没有调用关系，下图是截的大佬oacia博客的图。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524093446012.png" alt="image-20250524093446012" style="zoom: 67%;" />

<p>我对这个脚本进行了二开，让打印更美观一点，而且要展示调用关系。</p>
<p>修改后，打印的内容好看了很多，能清晰地看到调用链。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">[ONEPLUS A6003::com.oacia.apk_protect ]-&gt; start Stalker on thread 11793</span><br><span class="line">Stalker started!</span><br><span class="line">[180 ms] [TID:11793] ENTER: JNI_OnLoad</span><br><span class="line">  [180 ms] [TID:11793] ENTER: .interpreter_wrap_int64_t</span><br><span class="line">    [180 ms] [TID:11793] ENTER: interpreter_wrap_int64_t</span><br><span class="line">      [181 ms] [TID:11793] ENTER: ._Znwm</span><br><span class="line">      [181 ms] [TID:11793] EXIT: ._Znwm</span><br><span class="line">    [181 ms] [TID:11793] EXIT: interpreter_wrap_int64_t</span><br><span class="line">    [182 ms] [TID:11793] ENTER: sub_13908</span><br><span class="line">      [182 ms] [TID:11793] ENTER: ._Znam</span><br><span class="line">      [182 ms] [TID:11793] EXIT: ._Znam</span><br><span class="line">      [184 ms] [TID:11793] ENTER: sub_11220</span><br><span class="line">        [184 ms] [TID:11793] ENTER: .memset</span><br><span class="line">        [185 ms] [TID:11793] EXIT: .memset</span><br><span class="line">        [186 ms] [TID:11793] ENTER: sub_9DD8</span><br><span class="line">        [186 ms] [TID:11793] EXIT: sub_9DD8</span><br><span class="line">      [187 ms] [TID:11793] EXIT: sub_11220</span><br><span class="line">      [190 ms] [TID:11793] ENTER: sub_E3E0</span><br><span class="line">      [190 ms] [TID:11793] EXIT: sub_E3E0</span><br><span class="line">      [190 ms] [TID:11793] ENTER: .calloc</span><br><span class="line">      [191 ms] [TID:11793] EXIT: .calloc</span><br><span class="line">    [191 ms] [TID:11793] EXIT: sub_13908</span><br><span class="line">  [191 ms] [TID:11793] EXIT: .interpreter_wrap_int64_t</span><br><span class="line">[193 ms] [TID:11793] EXIT: JNI_OnLoad</span><br><span class="line">[204 ms] [TID:11793] ENTER: .malloc</span><br><span class="line">  [204 ms] [TID:11793] ENTER: .free</span><br><span class="line">  [204 ms] [TID:11793] EXIT: .free</span><br><span class="line">[207 ms] [TID:11793] EXIT: .malloc</span><br><span class="line">[208 ms] [TID:11793] ENTER: sub_E648</span><br><span class="line">[209 ms] [TID:11793] EXIT: sub_E648</span><br><span class="line">[209 ms] [TID:11793] ENTER: ._ZdaPv</span><br><span class="line">[213 ms] [TID:11793] EXIT: ._ZdaPv</span><br><span class="line">[213 ms] [TID:11793] ENTER: sub_C918</span><br><span class="line">[213 ms] [TID:11793] EXIT: sub_C918</span><br><span class="line">[214 ms] [TID:11793] ENTER: sub_9988</span><br><span class="line">[214 ms] [TID:11793] EXIT: sub_9988</span><br><span class="line">[214 ms] [TID:11793] ENTER: sub_9964</span><br><span class="line">[214 ms] [TID:11793] EXIT: sub_9964</span><br><span class="line">[215 ms] [TID:11793] ENTER: sub_9AC4</span><br><span class="line">[216 ms] [TID:11793] EXIT: sub_9AC4</span><br><span class="line">[216 ms] [TID:11793] ENTER: .ffi_prep_cif</span><br><span class="line">  [216 ms] [TID:11793] ENTER: ffi_prep_cif</span><br><span class="line">    [217 ms] [TID:11793] ENTER: .ffi_prep_cif_machdep</span><br><span class="line">      [217 ms] [TID:11793] ENTER: ffi_prep_cif_machdep</span><br><span class="line">      [218 ms] [TID:11793] EXIT: ffi_prep_cif_machdep</span><br><span class="line">      [218 ms] [TID:11793] ENTER: .ffi_call</span><br><span class="line">        [218 ms] [TID:11793] ENTER: ffi_call</span><br><span class="line">          [218 ms] [TID:11793] ENTER: sub_1674C</span><br><span class="line">          [219 ms] [TID:11793] EXIT: sub_1674C</span><br><span class="line">          [219 ms] [TID:11793] ENTER: .ffi_call_SYSV</span><br><span class="line">            [219 ms] [TID:11793] ENTER: ffi_call_SYSV</span><br><span class="line">              [219 ms] [TID:11793] ENTER: sub_167BC</span><br><span class="line">                [220 ms] [TID:11793] ENTER: sub_1647C</span><br><span class="line">                [220 ms] [TID:11793] EXIT: sub_1647C</span><br><span class="line">                [220 ms] [TID:11793] ENTER: sub_163DC</span><br><span class="line">                [220 ms] [TID:11793] EXIT: sub_163DC</span><br><span class="line">              [221 ms] [TID:11793] EXIT: sub_167BC</span><br><span class="line">            [221 ms] [TID:11793] EXIT: ffi_call_SYSV</span><br><span class="line">            [221 ms] [TID:11793] ENTER: sub_9900</span><br><span class="line">            [222 ms] [TID:11793] EXIT: sub_9900</span><br><span class="line">          [222 ms] [TID:11793] EXIT: .ffi_call_SYSV</span><br><span class="line">        [222 ms] [TID:11793] EXIT: ffi_call</span><br><span class="line">      [222 ms] [TID:11793] EXIT: .ffi_call</span><br><span class="line">    [223 ms] [TID:11793] EXIT: .ffi_prep_cif_machdep</span><br><span class="line">    [224 ms] [TID:11793] ENTER: sub_94BC</span><br><span class="line">      [224 ms] [TID:11793] ENTER: .dladdr</span><br><span class="line">      [226 ms] [TID:11793] EXIT: .dladdr</span><br><span class="line">    [226 ms] [TID:11793] EXIT: sub_94BC</span><br><span class="line">  [226 ms] [TID:11793] EXIT: ffi_prep_cif</span><br><span class="line">[226 ms] [TID:11793] EXIT: .ffi_prep_cif</span><br><span class="line">[226 ms] [TID:11793] ENTER: .strstr</span><br><span class="line">[227 ms] [TID:11793] EXIT: .strstr</span><br><span class="line">[231 ms] [TID:11793] ENTER: .setenv</span><br><span class="line">[232 ms] [TID:11793] EXIT: .setenv</span><br><span class="line">[235 ms] [TID:11793] ENTER: _Z9__arm_a_1P7_JavaVMP7_JNIEnvPvRi</span><br><span class="line">[239 ms] [TID:11793] EXIT: _Z9__arm_a_1P7_JavaVMP7_JNIEnvPvRi</span><br><span class="line">[241 ms] [TID:11793] ENTER: sub_9E58</span><br><span class="line">  [242 ms] [TID:11793] ENTER: sub_999C</span><br><span class="line">  [242 ms] [TID:11793] EXIT: sub_999C</span><br><span class="line">[242 ms] [TID:11793] EXIT: sub_9E58</span><br><span class="line">[242 ms] [TID:11793] ENTER: sub_10964</span><br><span class="line">  [243 ms] [TID:11793] ENTER: j_._ZdlPv_1</span><br><span class="line">    [243 ms] [TID:11793] ENTER: ._ZdlPv</span><br><span class="line">      [245 ms] [TID:11793] ENTER: sub_96E0</span><br><span class="line">      [246 ms] [TID:11793] EXIT: sub_96E0</span><br><span class="line">    [246 ms] [TID:11793] EXIT: ._ZdlPv</span><br><span class="line">    [246 ms] [TID:11793] ENTER: sub_8000</span><br><span class="line">      [246 ms] [TID:11793] ENTER: .strncpy</span><br><span class="line">      [247 ms] [TID:11793] EXIT: .strncpy</span><br><span class="line">      [247 ms] [TID:11793] ENTER: sub_60E0</span><br><span class="line">      [247 ms] [TID:11793] EXIT: sub_60E0</span><br><span class="line">      [247 ms] [TID:11793] ENTER: sub_6544</span><br><span class="line">      [248 ms] [TID:11793] EXIT: sub_6544</span><br><span class="line">      [248 ms] [TID:11793] ENTER: sub_4B54</span><br><span class="line">        [248 ms] [TID:11793] ENTER: sub_6128</span><br><span class="line">        [248 ms] [TID:11793] EXIT: sub_6128</span><br><span class="line">        [248 ms] [TID:11793] ENTER: _ZN9__arm_c_19__arm_c_0Ev</span><br><span class="line">        [250 ms] [TID:11793] EXIT: _ZN9__arm_c_19__arm_c_0Ev</span><br><span class="line">        [250 ms] [TID:11793] ENTER: sub_A3EC</span><br><span class="line">          [250 ms] [TID:11793] ENTER: sub_99CC</span><br><span class="line">            [250 ms] [TID:11793] ENTER: sub_9944</span><br><span class="line">            [250 ms] [TID:11793] EXIT: sub_9944</span><br><span class="line">          [251 ms] [TID:11793] EXIT: sub_99CC</span><br><span class="line">        [251 ms] [TID:11793] EXIT: sub_A3EC</span><br><span class="line">      [252 ms] [TID:11793] EXIT: sub_4B54</span><br><span class="line">    [254 ms] [TID:11793] EXIT: sub_8000</span><br><span class="line">  [254 ms] [TID:11793] EXIT: j_._ZdlPv_1</span><br><span class="line">[254 ms] [TID:11793] EXIT: sub_10964</span><br><span class="line">[257 ms] [TID:11793] ENTER: sub_6484</span><br><span class="line">  [257 ms] [TID:11793] ENTER: sub_6590</span><br><span class="line">    [257 ms] [TID:11793] ENTER: .memcpy</span><br><span class="line">    [258 ms] [TID:11793] EXIT: .memcpy</span><br><span class="line">    [258 ms] [TID:11793] ENTER: sub_6698</span><br><span class="line">      [260 ms] [TID:11793] ENTER: sub_9FFC</span><br><span class="line">      [261 ms] [TID:11793] EXIT: sub_9FFC</span><br><span class="line">    [268 ms] [TID:11793] EXIT: sub_6698</span><br><span class="line">    [268 ms] [TID:11793] ENTER: j_._ZdlPv_3</span><br><span class="line">      [268 ms] [TID:11793] ENTER: j_._ZdlPv_2</span><br><span class="line">        [269 ms] [TID:11793] ENTER: j_._ZdlPv_0</span><br><span class="line">          [269 ms] [TID:11793] ENTER: sub_A3A0</span><br><span class="line">            [269 ms] [TID:11793] ENTER: sub_9A90</span><br><span class="line">            [269 ms] [TID:11793] EXIT: sub_9A90</span><br><span class="line">          [269 ms] [TID:11793] EXIT: sub_A3A0</span><br><span class="line">        [270 ms] [TID:11793] EXIT: j_._ZdlPv_0</span><br><span class="line">      [270 ms] [TID:11793] EXIT: j_._ZdlPv_2</span><br><span class="line">      [270 ms] [TID:11793] ENTER: sub_5F20</span><br><span class="line">      [271 ms] [TID:11793] EXIT: sub_5F20</span><br><span class="line">    [271 ms] [TID:11793] EXIT: j_._ZdlPv_3</span><br><span class="line">    [271 ms] [TID:11793] ENTER: sub_6044</span><br><span class="line">    [276 ms] [TID:11793] EXIT: sub_6044</span><br><span class="line">  [276 ms] [TID:11793] EXIT: sub_6590</span><br><span class="line">  [276 ms] [TID:11793] ENTER: sub_3574</span><br><span class="line">    [276 ms] [TID:11793] ENTER: .uncompress</span><br><span class="line">    [279 ms] [TID:11793] EXIT: .uncompress</span><br><span class="line">  [279 ms] [TID:11793] EXIT: sub_3574</span><br><span class="line">[281 ms] [TID:11793] EXIT: sub_6484</span><br><span class="line">[316 ms] [TID:11793] ENTER: sub_49F0</span><br><span class="line">  [316 ms] [TID:11793] ENTER: sub_5400</span><br><span class="line">  [316 ms] [TID:11793] EXIT: sub_5400</span><br><span class="line">  [316 ms] [TID:11793] ENTER: sub_5478</span><br><span class="line">    [316 ms] [TID:11793] ENTER: sub_5B08</span><br><span class="line">    [318 ms] [TID:11793] EXIT: sub_5B08</span><br><span class="line">  [320 ms] [TID:11793] EXIT: sub_5478</span><br><span class="line">  [320 ms] [TID:11793] ENTER: sub_5650</span><br><span class="line">  [321 ms] [TID:11793] EXIT: sub_5650</span><br><span class="line">  [321 ms] [TID:11793] ENTER: sub_580C</span><br><span class="line">    [322 ms] [TID:11793] ENTER: .mprotect</span><br><span class="line">    [322 ms] [TID:11793] EXIT: .mprotect</span><br><span class="line">  [324 ms] [TID:11793] EXIT: sub_580C</span><br><span class="line">[324 ms] [TID:11793] EXIT: sub_49F0</span><br><span class="line">[325 ms] [TID:11793] ENTER: .strlen</span><br><span class="line">[325 ms] [TID:11793] EXIT: .strlen</span><br><span class="line">[325 ms] [TID:11793] ENTER: sub_3C94</span><br><span class="line">  [327 ms] [TID:11793] ENTER: .dlopen</span><br><span class="line">  [328 ms] [TID:11793] EXIT: .dlopen</span><br><span class="line">[330 ms] [TID:11793] EXIT: sub_3C94</span><br><span class="line">[352 ms] [TID:11793] ENTER: sub_4918</span><br><span class="line">  [353 ms] [TID:11793] ENTER: sub_4000</span><br><span class="line">    [353 ms] [TID:11793] ENTER: sub_41B4</span><br><span class="line">      [354 ms] [TID:11793] ENTER: sub_35AC</span><br><span class="line">      [355 ms] [TID:11793] EXIT: sub_35AC</span><br><span class="line">    [355 ms] [TID:11793] EXIT: sub_41B4</span><br><span class="line">    [356 ms] [TID:11793] ENTER: .dlsym</span><br><span class="line">    [357 ms] [TID:11793] EXIT: .dlsym</span><br><span class="line">  [358 ms] [TID:11793] EXIT: sub_4000</span><br><span class="line">[359 ms] [TID:11793] EXIT: sub_4918</span><br><span class="line">[369 ms] [TID:11793] ENTER: sub_5E6C</span><br><span class="line">[370 ms] [TID:11793] EXIT: sub_5E6C</span><br><span class="line">[370 ms] [TID:11793] ENTER: sub_5444</span><br><span class="line">[370 ms] [TID:11793] EXIT: sub_5444</span><br><span class="line">[386 ms] [TID:11793] ENTER: sub_633C</span><br><span class="line">[386 ms] [TID:11793] EXIT: sub_633C</span><br><span class="line">[386 ms] [TID:11793] ENTER: sub_8130</span><br><span class="line">  [387 ms] [TID:11793] ENTER: sub_4C70</span><br><span class="line">  [387 ms] [TID:11793] EXIT: sub_4C70</span><br><span class="line">[388 ms] [TID:11793] EXIT: sub_8130</span><br><span class="line">[388 ms] [TID:11793] ENTER: sub_825C</span><br><span class="line">[389 ms] [TID:11793] EXIT: sub_825C</span><br><span class="line">[389 ms] [TID:11793] ENTER: sub_8B50</span><br><span class="line">[390 ms] [TID:11793] EXIT: sub_8B50</span><br><span class="line">[390 ms] [TID:11793] ENTER: sub_8ED4</span><br><span class="line">[391 ms] [TID:11793] EXIT: sub_8ED4</span><br><span class="line">[391 ms] [TID:11793] ENTER: sub_8430</span><br><span class="line">[394 ms] [TID:11793] EXIT: sub_8430</span><br><span class="line">[395 ms] [TID:11793] ENTER: interpreter_wrap_int64_t_bridge</span><br><span class="line">  [397 ms] [TID:11793] ENTER: sub_9D60</span><br><span class="line">  [398 ms] [TID:11793] EXIT: sub_9D60</span><br><span class="line">[398 ms] [TID:11793] EXIT: interpreter_wrap_int64_t_bridge</span><br><span class="line">[780 ms] [TID:11793] ENTER: sub_166C4</span><br><span class="line">[781 ms] [TID:11793] EXIT: sub_166C4</span><br><span class="line">[782 ms] [TID:11793] ENTER: .puts</span><br><span class="line">[787 ms] [TID:11793] EXIT: .puts</span><br><span class="line">[1642 ms] [TID:11793] ENTER: sub_115AA0</span><br><span class="line">[1643 ms] [TID:11793] EXIT: sub_115AA0</span><br><span class="line">[1781 ms] [TID:11793] ENTER: _Z9__arm_a_2PcmS_Rii</span><br><span class="line">[1790 ms] [TID:11793] EXIT: _Z9__arm_a_2PcmS_Rii</span><br><span class="line">[2069 ms] [TID:11793] ENTER: .ffi_prep_cif_var</span><br><span class="line">  [2070 ms] [TID:11793] ENTER: ffi_prep_cif_var</span><br><span class="line">  [2070 ms] [TID:11793] EXIT: ffi_prep_cif_var</span><br><span class="line">[2070 ms] [TID:11793] EXIT: .ffi_prep_cif_var</span><br></pre></td></tr></table></figure>

<p>脚本链接：<strong><a target="_blank" rel="noopener" href="https://github.com/X14Nuy/Call_Trace">Call_Trace</a></strong>，如果觉得好用，麻烦点个星星，┭┮﹏┭┮这对我找工作真的很重要。——脚本是有局限的，在github里写了，如果只想要观察调用顺序而不需要调用关系，可以把打印内容的EXIT全部去掉，再把缩进也去掉，这样就恢复成原来oacia大佬的脚本了。<strong>由于这是360壳，有些调用不是标准的RET退栈，所以调用关系可能会有问题</strong>。</p>
<p>继续分析。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524152046692.png" alt="image-20250524152046692" style="zoom:67%;" />

<p>在解压缩操作附近的函数进行查看，发现存在RC4加密。</p>
<p>下面这个是标准RC4的KSA步骤。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524153516529.png" alt="image-20250524153516529" style="zoom: 67%;" />

<p>修改一下变量名，简单明了，和标准RC4一模一样，如果想得到密钥的值，hook sub_5F20，然后得到第1个参数的值即可。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524154214898.png" alt="image-20250524154214898"></p>
<p>hook rc4的密钥脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 针对 call_constructors 进行 Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// 你手机的 linker64 中 call_constructors 的偏移量</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>); <span class="comment">// 目标 SO 文件</span></span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Hook 目标函数 sub_5E6C</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span>, <span class="string">&quot;Module libjiagu_64.so base_addr: &quot;</span>, secmodule.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>(); <span class="comment">// Hook 完成后解除</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 目标函数 sub_5f20</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="comment">// sub_5E6C 的偏移</span></span><br><span class="line">    <span class="keyword">let</span> target_offset = <span class="number">0x5f20</span>;</span><br><span class="line">    <span class="keyword">let</span> target_func = baseaddr.<span class="title function_">add</span>(target_offset);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_func, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] Hooking sub_5f20 at:&#x27;</span>, target_func);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;rc4 key:&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">0</span>], &#123;<span class="attr">length</span>: <span class="number">64</span>&#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] sub_5f20 returned:&#x27;</span>, retval);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动 Hook</span></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>结果如下图所示，提取密钥，如果之后要用就方便了。0x76,0x55,0x56,0x34,0x23,0x91,0x23,0x53,0x56,0x74。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524215504808.png" alt="image-20250524215504808" style="zoom:80%;" />

<p>按理来说，在ksa之后，应该会调用rc4的PRGA算法，然后进行rc4解密，再进行压缩，所以这里继续追踪sub_6044和sub_3574进行查看。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524154405943.png" alt="image-20250524154405943"></p>
<p>先看sub_3574，这里直接调用了uncompress，那大概率sub_6044就是rc4_PRGA算法。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524154735343.png" alt="image-20250524154735343" style="zoom:80%;" />

<p>标准的RC4_PRGA算法是这样的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524154857110.png" alt="image-20250524154857110" style="zoom: 67%;" />

<p>而sub_6044是这样的。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524154817260.png" alt="image-20250524154817260"></p>
<p>修改变量名后，如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250524214255632.png" alt="image-20250524214255632"></p>
<p>在进行rc4解密后，主so的内容仍然是不可用的，还需要进行解压缩。sub_6044的下一个函数调用是sub_3574，而sub_3574直接调用uncompress，然后发现uncompress位于导入表，那大概率就是zlib库的uncompress了。</p>
<p>下面是uncompress的函数签名。</p>
<p><em><strong>int uncompress(Bytef *dest, uLongf *destLen, const Bytef *source, uLong sourceLen);</strong></em></p>
<p>根据这个函数签名，我们可以hook它，得到解压缩后的内容。</p>
<p>但在hook uncompress之前，先hook rc4_prga，通过它，可以获得加密主so的地址和内容的大小。</p>
<p>脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 针对 call_constructors 进行 Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// 手机的 linker64 中 call_constructors 的偏移量</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>); <span class="comment">// 目标 SO 文件</span></span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Hook 目标函数 sub_6044</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span>, <span class="string">&quot;Module libjiagu_64.so base_addr: &quot;</span>, secmodule.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>(); <span class="comment">// Hook 完成后解除</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 目标函数 sub_6044</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="comment">// sub_6044 的偏移</span></span><br><span class="line">    <span class="keyword">let</span> target_offset = <span class="number">0x6044</span>;</span><br><span class="line">    <span class="keyword">let</span> target_func = baseaddr.<span class="title function_">add</span>(target_offset);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_func, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] Hooking sub_6044 at:&#x27;</span>, target_func);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;encrypt 主elf addr:&quot;</span>, <span class="string">&quot;0x&quot;</span> + (args[<span class="number">0</span>] - baseaddr).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;encrypt 主elf size:&quot;</span>, <span class="string">&quot;0x&quot;</span> + args[<span class="number">1</span>].<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;解密前:&quot;</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">0</span>], &#123;<span class="attr">length</span>: <span class="number">64</span>&#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;解密后:&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>, &#123;<span class="attr">length</span>: <span class="number">64</span>&#125;))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动 Hook</span></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_linker_call_constructors);</span><br></pre></td></tr></table></figure>

<p>打印结果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525103239983.png" alt="image-20250525103239983"></p>
<p>0x74783ff0肯定不是一个正常的偏移量，估计做过转移（比如malloc申请空间，存到别的地方去了），真正的主so加密数据应该是在壳so的某个偏移。</p>
<p>尝试在壳so文件搜索加密前的内容——用010editor在文件中在搜索 01 18 25 e7…</p>
<p>可以发现，加密数据存放于libjiagu_64_after_open_fixed.so的0x2e270的位置，这是我之前趁着open(“…&#x2F;xxx.dex”)的时候dump下来的libjiagu_a64.so。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525110933159.png" alt="image-20250525110933159" style="zoom:80%;" />

<p>而在assets目录下的libjiagu_a64.so中，这段加密内容位于0x1E270的位置。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525111242312.png" alt="image-20250525111242312" style="zoom: 80%;" />

<p>估计是加载过程中对齐的缘故，又或者是360壳把把主so的基址设在了64K位置（0x10000）。</p>
<p>如果之后我们想直接从壳so中获得主so，用的是0x1E270，但分析的时候，继续用0x2e270。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525112814418.png" alt="image-20250525112814418"></p>
<p>对这个变量名交叉引用，只有函数sub_8000引用了它。</p>
<p>可以发现，0xB8010正是sub_6044第2个参数的值，代表着RC4加密后主so的大小。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525112854039.png" alt="image-20250525112854039" style="zoom:67%;" />

<p>接着hook uncompress，由于uncompress是系统库的函数，不需要考虑360壳做手脚，直接hook。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 针对 call_constructors 进行 Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// 手机的 linker64 中 call_constructors 的偏移量</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>); <span class="comment">// 目标 SO 文件</span></span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Hook 目标函数 sub_6044</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span>, <span class="string">&quot;Module libjiagu_64.so base_addr: &quot;</span>, secmodule.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>(); <span class="comment">// Hook 完成后解除</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook 目标函数 sub_6044</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line">    <span class="comment">// sub_6044 的偏移</span></span><br><span class="line">    <span class="keyword">let</span> target_offset = <span class="number">0x6044</span>;</span><br><span class="line">    <span class="keyword">let</span> target_func = baseaddr.<span class="title function_">add</span>(target_offset);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_func, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[+] Hooking sub_6044 at:&#x27;</span>, target_func);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;encrypt 主elf在内存中的实际位置:&quot;</span>, <span class="string">&quot;0x&quot;</span> + args[<span class="number">0</span>].<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;encrypt 主elf在rc4加密后的大小:&quot;</span>, <span class="string">&quot;0x&quot;</span> + args[<span class="number">1</span>].<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;解密前:&quot;</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">0</span>], &#123;<span class="attr">length</span>: <span class="number">64</span>&#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;解密后:&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>, &#123;<span class="attr">length</span>: <span class="number">64</span>&#125;))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_uncompress_res</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;uncompress&quot;</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hook uncompress&quot;</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;解压缩前:&quot;</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">2</span>], &#123;</span><br><span class="line">              <span class="attr">offset</span>: <span class="number">0</span>,<span class="comment">// 相对偏移</span></span><br><span class="line">              <span class="attr">length</span>: <span class="number">64</span>,<span class="comment">//dump 的大小</span></span><br><span class="line">              <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">            &#125;));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;解压缩前的大小:&quot;</span>,args[<span class="number">3</span>])</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动 Hook</span></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_linker_call_constructors</span>();</span><br><span class="line">    <span class="title function_">hook_uncompress_res</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>打印的结果如下。</p>
<p>很容易猜到，rc4解密后的数据的前4个字节用来表示解压后的主so的大小（<strong>0x1a0eb9</strong>）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525113844217.png" alt="image-20250525113844217"></p>
<p>现在我们已经知道了主so的位置（0x1e270）、加密的算法与密钥（rc4和”0x76,0x55,0x56,0x34,0x23,0x91,0x23,0x53,0x56,0x74”）、解压用的函数及解压后的大小（zlib的uncompress和0x1a0eb9），现在可以很轻易地从壳so中直接得到主so解密的内容。</p>
<p>写脚本脱下来看看——这边直接抄了oacia大佬的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">RC4</span>(<span class="params">data, key</span>):</span><br><span class="line">    S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    out = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># KSA Phase</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># PRGA Phase</span></span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> data:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + S[i]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">        out.append(ch ^ S[(S[i] + S[j]) % <span class="number">256</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">RC4decrypt</span>(<span class="params">ciphertext, key</span>):</span><br><span class="line">    <span class="keyword">return</span> RC4(ciphertext, key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wrap_elf_start = <span class="number">0x1e270</span></span><br><span class="line">wrap_elf_size = <span class="number">0xb8010</span></span><br><span class="line">key = <span class="string">b&quot;vUV4#\x91#SVt&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;com.oacia.apk_protect/assets/libjiagu_a64.so&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    wrap_elf = f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对密文进行解密</span></span><br><span class="line">dec_compress_elf = RC4decrypt(wrap_elf[wrap_elf_start:wrap_elf_start+wrap_elf_size], key)</span><br><span class="line">dec_elf = zlib.decompress(<span class="built_in">bytes</span>(dec_compress_elf[<span class="number">4</span>::]))</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;wrap_elf&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(dec_elf)</span><br></pre></td></tr></table></figure>

<p>将得到的wrap_elf放到010editor查看，一大堆D3。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525115700120.png" alt="image-20250525115700120" style="zoom: 80%;" />

<p>往下面看，发现存在ELF文件的特征，而ELF文件之前导出都是D3。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525132029227.png" alt="image-20250525132029227" style="zoom:67%;" />

<p>可以将这里理解为2段数据，part1为D3相关的加密，part2为ELF文件头（可能还有其它内容）。</p>
<p>这里对wrap_elf进行切割。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;wrap_elf&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    wrap_elf = f.read()</span><br><span class="line">ELF_magic = <span class="built_in">bytes</span>([<span class="number">0x7F</span>, <span class="number">0x45</span>, <span class="number">0x4C</span>, <span class="number">0x46</span>])</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(wrap_elf) - <span class="built_in">len</span>(ELF_magic) + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">if</span> wrap_elf[i:i + <span class="built_in">len</span>(ELF_magic)] == ELF_magic:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(i))</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;wrap_elf_part1&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(wrap_elf[<span class="number">0</span>:i])</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;wrap_elf_part2&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(wrap_elf[i::])</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>打开wrap_elf_part2，发现PHT填充了一堆垃圾数据（可能是加密数据，但我更倾向于PHT放在了别的地方）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525133553692.png" alt="image-20250525133553692"></p>
<p>往下分析，要进行重定位的话，要么是part2的PHT解密了，要么是PHT放在了其它地方。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525133145413.png" alt="image-20250525133145413"></p>
<p>对其中的函数进行分析。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525142521149.png" alt="image-20250525142521149"></p>
<p>一般加载一个so的时候，申请mmap空间之前需要有PHT，先读取PHT上写着的LOAD加载地址、大小、对齐方式等，再调用mmap进行申请。</p>
<p>因此，sub_5B08大概率在获得正确的PHT，点进来一看，发现存在常量0x38，刚好是一个PHT的大小，更说明猜测是对的了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525143259739.png" alt="image-20250525143259739" style="zoom:67%;" />

<p>pht_buffer与xor_key进行异或，异或的xor_key来自于a2+16。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525150624560.png" alt="image-20250525150624560" style="zoom:80%;" />

<p>hook一下，查看xor_key的内容是多少。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 针对 call_constructors 进行 Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_linker_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> linker64_base_addr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&#x27;linker64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> offset_call = <span class="number">0x51BA8</span>; <span class="comment">// 手机的 linker64 中 call_constructors 的偏移量</span></span><br><span class="line">    <span class="keyword">let</span> call_constructors = linker64_base_addr.<span class="title function_">add</span>(offset_call);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> listener = <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> secmodule = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>); <span class="comment">// 目标 SO 文件</span></span><br><span class="line">            <span class="keyword">if</span> (secmodule != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] &quot;</span>, <span class="string">&quot;Module libjiagu_64.so base_addr: &quot;</span>, secmodule.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                <span class="title function_">hook_target_func</span>(secmodule.<span class="property">base</span>);</span><br><span class="line">                listener.<span class="title function_">detach</span>(); <span class="comment">// Hook 完成后解除</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_target_func</span>(<span class="params">baseaddr</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> target_offset = <span class="number">0x5B08</span>;</span><br><span class="line">    <span class="keyword">let</span> target_func = baseaddr.<span class="title function_">add</span>(target_offset);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_func, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[xor_key]:&quot;</span>, <span class="string">&quot;0x&quot;</span>+args[<span class="number">1</span>].<span class="title function_">add</span>(<span class="number">16</span>).<span class="title function_">readPointer</span>().<span class="title function_">readU8</span>().<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动 Hook</span></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_linker_call_constructors</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>脚本执行结果是0xd3，说明真正的PHT很可能就是part1解密后的内容。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525152209680.png" alt="image-20250525152209680"></p>
<p>除了异或，解密的循环还有arm64的neon运算。</p>
<p>NEON 是 ARM 架构的 SIMD 扩展，提供一组专用的寄存器和指令，用于并行处理多个数据元素。</p>
<p>下面两个链接介绍了sub_5B08中出现的vdupq_n_s8和veorq_s8。</p>
<p><a target="_blank" rel="noopener" href="https://developer.arm.com/architectures/instruction-sets/intrinsics/#q=vdupq_n_s8">https://developer.arm.com/architectures/instruction-sets/intrinsics/#q=vdupq_n_s8</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.arm.com/architectures/instruction-sets/intrinsics/#q=veorq_s8">https://developer.arm.com/architectures/instruction-sets/intrinsics/#q=veorq_s8</a></p>
<p>简单来说，一个字节一个字节的异或效率太低，而neon可以一次性异或16个字节。——根本不影响阅读。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525162553594.png" alt="image-20250525162553594" style="zoom:80%;" />

<p>分析了一下，突然意识到v2似乎指向part2。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525155237926.png" alt="image-20250525155237926"></p>
<p>打印一下看看。（脚本就不提供了，跟查看xor_key的脚本差不多）</p>
<p>下面这内容不就是part1的内容？</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525155415726.png" alt="image-20250525155415726"></p>
<p>也就是说，part1的第1个字节是xor_key，接下来的4个字节是长度（0x150），再接下来的0x150个字节是待异或的内容，注意到，我们之前分析的主so有6个pht，每个pht大小是0x38，加起来不就是0x150个字节吗？所以说，part1的前0x155字节与pht相关。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525155524905.png" alt="image-20250525155524905"></p>
<p>整理了一下，假如每次要处理的数据量都很小，那每次的处理数据的方式都是逐字节异或，然后goto到下一块要处理的数据，整个sub_5B08有4个这样子的结构，因此有4块数据。</p>
<p>数据的分布结构是这样的：xor_key（1个字节）、data1_len（4个字节）、data1、data2_len（4个字节）、data2、data3_len（4个字节）、data3、data4_len、data4。</p>
<p>之前提过，soinfo中存在一些360壳的字段，而在sub_5B08可以推测一些字段了。</p>
<p>关于data1的相关字段。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525163327040.png" alt="image-20250525163327040" style="zoom:67%;" />

<p>关于data2的相关字段。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525163402407.png" alt="image-20250525163402407" style="zoom: 67%;" />

<p>关于data3的相关字段。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525163427141.png" alt="image-20250525163427141" style="zoom: 67%;" />

<p>关于data4的相关字段。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525163513117.png" alt="image-20250525163513117" style="zoom:67%;" />

<p>最后还有elf的相关字段，这里的v16、v27、v38、pht_total_size有3个是数据的大小，还有有一个是基址；17是1个字节的xor_key和4个4字节的data_len。</p>
<p>想想wrap_elf，part1基本都是0xD3，而part2是ELF文件，不难想出，a1的第152个字节指向elf起始地址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525164721162.png" alt="image-20250525164721162"></p>
<p>原先的soinfo是这样的。前232字节由于不知道是什么，直接当成一个char数组，暂时没做处理。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525163608632.png" alt="image-20250525163608632" style="zoom:80%;" />

<p>根据分析，可以这么设置。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525170510570.png" alt="image-20250525170510570" style="zoom:80%;" />

<p>但是想了想，似乎不太合适，这样子先入为主地认为之前的那个数据结构是soinfo了，虽然的确很像，如果如上图这么设置，pht_buffer和phdr是同一个意思，应该不会这么设计。</p>
<p>依照其它人的博客的意思，老老实实创建当前这个结构体即可，不要往soinfo去想，因为一开始的soinfo也是猜测。</p>
<p>因此，这里的Four_Section不需要凑232个字节了，只需要满足偏移量在对应的地方即可，结构体应该如下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525201455502.png" alt="image-20250525201455502" style="zoom:80%;" />

<p>既然sub_5B08的第1个参数是Four_Section，查看它的引用函数，传参的那个变量的类型也应该是Four_Section。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525201744955.png" alt="image-20250525201744955"></p>
<p>继续查看引用sub_5478函数，将v14变量的类型改成Four_Section*，然后发现不对，存在2个问题。</p>
<ol>
<li>v14的类型是Four_Section*，为什么还要取地址再转成(Four_Section*)？</li>
<li>v7_1[29] &#x3D; v9，v9 &#x3D; v16，但v16的值呢？</li>
</ol>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525201939099.png" alt="image-20250525201939099"></p>
<p>针对上述两个问题，其实说明v14的类型取错了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525202237290.png" alt="image-20250525202237290"></p>
<p>这里的v15-v23找不到赋值的地方，它们很有可能是和v14作为一个完整的结构体对象，一起作为参数赋值的，而我们这边将v14设置成指针类型，导致将v14与v15-v23进行了切割。只需要把v14的指针符号去掉即可。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525202441708.png" alt="image-20250525202441708" style="zoom:80%;" />

<p>再根据下图的逻辑，定义新的结构体。v7_1申请了0x1E0个空间，因此，我们需要创建的结构体大小应该也是0x1E0。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525202608074.png" alt="image-20250525202608074"></p>
<p>创建的结构体是这样的，注：168个字节中，可能有好几个成员变量类型。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525203507669.png" alt="image-20250525203507669"></p>
<p>其实到这一步，也能看出之前想的soinfo是错误的，因此要回到用到了soinfo的地方，把类型改成FourSection_t，然后观察section2&#x2F;3&#x2F;4到底是什么。</p>
<p>sub_3c94是设置重定位表、符号表等内容的函数，可以看出来section4存放的是.dynamic节（一般DT_DYNAMIC只含一个.dynamic节）。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525204112819.png" alt="image-20250525204112819" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525203811167.png" alt="image-20250525203811167"></p>
<p>而在函数sub_4918中，我们判断第1次调用sub_4000是进行常规重定位（对数据和指令的重定位），第2次调用sub_4000是进行plt重定位（大部分情况是对符号的重定位）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525204312795.png" alt="image-20250525204312795"></p>
<p>快有点模糊d_tag和r_info的区别了…这里的0x402和0x403分别是R_AARCH64_JUMP_SLOT、R_AARCH64_RELATIVE，是一种计算修正地址的规则，而这种规则分别常用于.rela.plt和.rela.dyn，<strong>因此认为这里的section3和2分别指向.rela.dyn和.rela.plt</strong>。</p>
<p>区分.rela.plt和.rela.dyn的方式是d_tag，d_tag &#x3D;&#x3D; DT_RELA是后者，d_tag &#x3D;&#x3D; DT_JMPREL是前者。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525210705157.png" alt="image-20250525210705157"></p>
<p>至此，重命名一下。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250525211112557.png" alt="image-20250525211112557" style="zoom: 80%;" />

<p>总结一下释放主so的流程：</p>
<ol>
<li><p>wrap_elf位于assets&#x2F;libjiagu_a64.so的0x1e270的位置。</p>
</li>
<li><p>wrap_elf经过rc4解密（密钥：b”vUV4#\x91#SVt”）后，是一个长度为0xb8010的压缩数据A，真正参与解压的数据是A[4:]，也就是说，参与解压的数据的大小是0xb800C，前4个字节描述了解压后数据的大小。</p>
</li>
<li><p>解压后的数据视作wrap_elf，而wrap_elf里分为part1和part2两部分，part1被0xD3异或加密，part2指向一个ELF文件，但PHT、.dynamic节的等内容均被垃圾数据占满。</p>
</li>
<li><p>part1里有<strong>4组</strong>数据，它的<strong>数据结构</strong>是这样：xor_key（1个字节）、data1_len（4个字节）、data1、data2_len（4个字节）、data2、data3_len（4个字节）、data3、data4_len、data4；</p>
</li>
<li><p>data1-data4分别是被0xD3异或加密的PHT、.rela.plt、.rela.dyn、.dynamic。</p>
</li>
</ol>
<p>需要注意，<strong>0x1e270是在壳so文件里wrap_elf的偏移，而在内存中，wrap_elf的偏移来到了0x2e270，原0x1e270被清空了；之后的主so加载的基址是0xe7000。</strong></p>
<p>通过下面这个脚本，可以从壳so里直接获得4个解密后的section。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">RC4</span>(<span class="params">data, key</span>):</span><br><span class="line">    S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    out = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># KSA Phase</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># PRGA Phase</span></span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> data:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + S[i]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">        out.append(ch ^ S[(S[i] + S[j]) % <span class="number">256</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">RC4decrypt</span>(<span class="params">ciphertext, key</span>):</span><br><span class="line">    <span class="keyword">return</span> RC4(ciphertext, key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wrap_elf_start = <span class="number">0x1e270</span></span><br><span class="line">wrap_elf_size = <span class="number">0xb8010</span></span><br><span class="line">key = <span class="string">b&quot;vUV4#\x91#SVt&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;com.oacia.apk_protect/assets/libjiagu_a64.so&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    wrap_elf = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对密文进行解密</span></span><br><span class="line">dec_compress_elf = RC4decrypt(wrap_elf[wrap_elf_start:wrap_elf_start + wrap_elf_size], key)</span><br><span class="line">dec_elf = zlib.decompress(<span class="built_in">bytes</span>(dec_compress_elf[<span class="number">4</span>::]))</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;wrap_elf&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(dec_elf)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">part</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.value = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="variable language_">self</span>.offset = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.size = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">index = <span class="number">1</span></span><br><span class="line">extra_part = [part() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>)]</span><br><span class="line"></span><br><span class="line">seg = [<span class="string">&quot;phdr&quot;</span>, <span class="string">&quot;.rela.plt&quot;</span>, <span class="string">&quot;.rela.dyn&quot;</span>, <span class="string">&quot;.dynamic&quot;</span>]</span><br><span class="line">v_xor = dec_elf[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    size = <span class="built_in">int</span>.from_bytes(dec_elf[index:index + <span class="number">4</span>], <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    index += <span class="number">4</span></span><br><span class="line">    extra_part[i + <span class="number">1</span>].name = seg[i]</span><br><span class="line">    extra_part[i + <span class="number">1</span>].value = <span class="built_in">bytes</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: x ^ v_xor, dec_elf[index:index + size]))</span><br><span class="line">    extra_part[i + <span class="number">1</span>].size = size</span><br><span class="line">    index += size</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> extra_part:</span><br><span class="line">    <span class="keyword">if</span> p.value!=<span class="string">b&#x27;&#x27;</span>:</span><br><span class="line">        filename = <span class="string">f&quot;libjiagu.so_<span class="subst">&#123;<span class="built_in">hex</span>(p.size)&#125;</span>_<span class="subst">&#123;p.name&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;p.name&#125;</span>] get <span class="subst">&#123;filename&#125;</span>, size: <span class="subst">&#123;<span class="built_in">hex</span>(p.size)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(filename,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(p.value)</span><br></pre></td></tr></table></figure>

<p>至于修复，很简单，把part2的主so放到010editor，用得到的4个section进行覆盖就行。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526092610332.png" alt="image-20250526092610332"></p>
<p>覆盖pht，其它的覆盖方法，需要找.dynamic节，然后得到.rela.plt和.rela.dyn节的偏移是多少，这里不过多赘述。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526092831748.png" alt="image-20250526092831748" style="zoom: 50%;" />

<p>在修复之后，基址设为0xe7000。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526093509859.png" alt="image-20250526093509859" style="zoom:67%;" />

<p>在获得主so文件之后，<strong>下一个主线任务就是找到主dex是如何加载并被解密的</strong>，然后获取主dex。</p>
<p>之前我们在hook函数open的时候，发现open会打开dex文件，通过打印调用函数栈，我们发现主so位于偏移量为0xE7000的位置，现在回顾一下在打开dex文件时的函数调用栈。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526100506048.png" alt="image-20250526100506048" style="zoom:80%;" />

<p>这里看到的调用栈其实只是部分，因为主so的函数列表并没有添加到壳so生成的脚本里，我之前写的脚本并没有测试过，所以这里还是用大佬oacia的吧。</p>
<p>在IDA中打开主so，然后使用插件stalker_trace_so，然后将主so的函数列表插回壳so的脚本里，这是佬oacia的截图。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526103628785.png" alt="image-20250526103628785"></p>
<p>这里我将名字改成keke了hhhhh。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526103707527.png" alt="image-20250526103707527"></p>
<p>然后插入1个判断即可。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526103748834.png" alt="image-20250526103748834"></p>
<p>前面在大量地执行壳so的函数，后面基本都在调用主so的函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526103913279.png" alt="image-20250526103913279" style="zoom:80%;" />

<p>在主so中搜索0x19b780，发现这个指令位于函数sub_19B760中，然后在trace.log中，发现没找到sub_19B760，应该是因为没hook maps文件，进程检测到frida，提前退出了。</p>
<p>在hook了maps文件后，发现获得的日志信息反而变少了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br></pre></td><td class="code"><pre><span class="line">[ONEPLUS A6003::com.oacia.apk_protect ]-&gt; start Stalker!</span><br><span class="line">Stalker end!</span><br><span class="line">[keke] call1:JNI_OnLoad</span><br><span class="line">[keke] call2:.interpreter_wrap_int64_t</span><br><span class="line">[keke] call3:interpreter_wrap_int64_t</span><br><span class="line">[keke] call4:._Znwm</span><br><span class="line">[keke] call5:sub_13908</span><br><span class="line">[keke] call6:._Znam</span><br><span class="line">[keke] call7:sub_11220</span><br><span class="line">[keke] call8:.memset</span><br><span class="line">[keke] call9:sub_9DD8</span><br><span class="line">[keke] call10:sub_E3E0</span><br><span class="line">[keke] call11:.calloc</span><br><span class="line">[keke] call12:.malloc</span><br><span class="line">[keke] call13:.free</span><br><span class="line">[keke] call14:sub_E648</span><br><span class="line">[keke] call15:._ZdaPv</span><br><span class="line">[keke] call16:sub_C918</span><br><span class="line">[keke] call17:sub_9988</span><br><span class="line">[keke] call18:sub_9964</span><br><span class="line">[keke] call19:sub_9AC4</span><br><span class="line">[keke] call20:.ffi_prep_cif</span><br><span class="line">[keke] call21:ffi_prep_cif</span><br><span class="line">[keke] call22:.ffi_prep_cif_machdep</span><br><span class="line">[keke] call23:ffi_prep_cif_machdep</span><br><span class="line">[keke] call24:.ffi_call</span><br><span class="line">[keke] call25:ffi_call</span><br><span class="line">[keke] call26:sub_1674C</span><br><span class="line">[keke] call27:.ffi_call_SYSV</span><br><span class="line">[keke] call28:ffi_call_SYSV</span><br><span class="line">[keke] call29:sub_167BC</span><br><span class="line">[keke] call30:sub_1647C</span><br><span class="line">[keke] call31:sub_163DC</span><br><span class="line">[keke] call32:sub_9900</span><br><span class="line">[keke] call33:sub_94BC</span><br><span class="line">[keke] call34:.dladdr</span><br><span class="line">[keke] call35:.strstr</span><br><span class="line">[keke] call36:.setenv</span><br><span class="line">[keke] call37:_Z9__arm_a_1P7_JavaVMP7_JNIEnvPvRi</span><br><span class="line">[keke] call38:sub_9E58</span><br><span class="line">[keke] call39:sub_999C</span><br><span class="line">[keke] call40:sub_10964</span><br><span class="line">[keke] call41:j_._ZdlPv_1</span><br><span class="line">[keke] call42:._ZdlPv</span><br><span class="line">[keke] call43:sub_96E0</span><br><span class="line">[keke] call44:sub_8000</span><br><span class="line">[keke] call45:.strncpy</span><br><span class="line">[keke] call46:sub_60E0</span><br><span class="line">[keke] call47:sub_6544</span><br><span class="line">[keke] call48:sub_4B54</span><br><span class="line">[keke] call49:sub_6128</span><br><span class="line">[keke] call50:_ZN9__arm_c_19__arm_c_0Ev</span><br><span class="line">[keke] call51:sub_A3EC</span><br><span class="line">[keke] call52:sub_99CC</span><br><span class="line">[keke] call53:sub_9944</span><br><span class="line">[keke] call54:sub_6484</span><br><span class="line">[keke] call55:sub_6590</span><br><span class="line">[keke] call56:.memcpy</span><br><span class="line">[keke] call57:sub_6698</span><br><span class="line">[keke] call58:sub_9FFC</span><br><span class="line">[keke] call59:j_._ZdlPv_3</span><br><span class="line">[keke] call60:j_._ZdlPv_2</span><br><span class="line">[keke] call61:j_._ZdlPv_0</span><br><span class="line">[keke] call62:sub_A3A0</span><br><span class="line">[keke] call63:sub_9A90</span><br><span class="line">[keke] call64:sub_5F20</span><br><span class="line">[keke] call65:sub_6044</span><br><span class="line">[keke] call66:sub_3574</span><br><span class="line">[keke] call67:.uncompress</span><br><span class="line">[keke] call68:sub_49F0</span><br><span class="line">[keke] call69:sub_5400</span><br><span class="line">[keke] call70:sub_5478</span><br><span class="line">[keke] call71:sub_5B08</span><br><span class="line">[keke] call72:sub_5650</span><br><span class="line">[keke] call73:sub_580C</span><br><span class="line">[keke] call74:.mprotect</span><br><span class="line">[keke] call75:.strlen</span><br><span class="line">[keke] call76:sub_3C94</span><br><span class="line">[keke] call77:.dlopen</span><br><span class="line">[keke] call78:sub_4918</span><br><span class="line">[keke] call79:sub_4000</span><br><span class="line">[keke] call80:sub_41B4</span><br><span class="line">[keke] call81:sub_35AC</span><br><span class="line">[keke] call82:.dlsym</span><br><span class="line">[keke] call83:sub_5E6C</span><br><span class="line">[keke] call84:sub_5444</span><br><span class="line">[main] call85:sub_11603C</span><br><span class="line">[main] call86:j__Znwm</span><br><span class="line">[main] call87:_Znwm</span><br><span class="line">[main] call88:malloc</span><br><span class="line">[main] call89:__cxa_atexit</span><br><span class="line">[main] call90:sub_1160B4</span><br><span class="line">[main] call91:sub_1160C4</span><br><span class="line">[main] call92:strlen</span><br><span class="line">[main] call93:memcpy</span><br><span class="line">[main] call94:sub_1161FC</span><br><span class="line">[main] call95:sub_1164AC</span><br><span class="line">[main] call96:sub_1164D8</span><br><span class="line">[main] call97:sub_116528</span><br><span class="line">[main] call98:sub_1165C8</span><br><span class="line">[main] call99:sub_1A32C0</span><br><span class="line">[main] call100:sub_1A3150</span><br><span class="line">[main] call101:sub_1A3204</span><br><span class="line">[main] call102:sub_1166FC</span><br><span class="line">[main] call103:sub_116728</span><br><span class="line">[main] call104:sub_116750</span><br><span class="line">[main] call105:sub_116830</span><br><span class="line">[main] call106:sub_116BA0</span><br><span class="line">[keke] call107:sub_633C</span><br><span class="line">[keke] call108:sub_8130</span><br><span class="line">[keke] call109:sub_4C70</span><br><span class="line">[keke] call110:sub_825C</span><br><span class="line">[keke] call111:sub_8B50</span><br><span class="line">[keke] call112:sub_8ED4</span><br><span class="line">[keke] call113:sub_8430</span><br><span class="line">[main] call114:JNI_OnLoad</span><br><span class="line">[main] call115:j_interpreter_wrap_int64_t</span><br><span class="line">[main] call116:interpreter_wrap_int64_t</span><br><span class="line">[keke] call117:interpreter_wrap_int64_t_bridge</span><br><span class="line">[keke] call118:sub_9D60</span><br><span class="line">[main] call119:sub_1B3F0C</span><br><span class="line">[main] call120:gettimeofday</span><br><span class="line">[main] call121:sub_11BD9C</span><br><span class="line">[main] call122:sub_1182D8</span><br><span class="line">[main] call123:sub_123970</span><br><span class="line">[main] call124:sub_1B6448</span><br><span class="line">[main] call125:getenv</span><br><span class="line">[main] call126:sub_11F130</span><br><span class="line">[main] call127:sub_12047C</span><br><span class="line">[main] call128:j__ZdlPv</span><br><span class="line">[main] call129:_ZdlPv</span><br><span class="line">[main] call130:free</span><br><span class="line">[main] call131:sub_1427E8</span><br><span class="line">[main] call132:dlopen</span><br><span class="line">[main] call133:sub_11BDA8</span><br><span class="line">[main] call134:sub_11BE58</span><br><span class="line">[main] call135:sub_11F69C</span><br><span class="line">[main] call136:sub_117BE0</span><br><span class="line">[main] call137:sub_117CA0</span><br><span class="line">[main] call138:fopen</span><br><span class="line">open /proc/self/maps</span><br><span class="line">find /proc/self/maps, redirect to /data/data/com.oacia.apk_protect/maps_nonexistent</span><br><span class="line">[main] call139:sub_117E90</span><br><span class="line">[main] call140:sub_14285C</span><br><span class="line">[main] call141:sub_1429CC</span><br><span class="line">[main] call142:sub_11C1AC</span><br><span class="line">[main] call143:sub_11C1B4</span><br><span class="line">[main] call144:sub_11C210</span><br><span class="line">[keke] call145:sub_166C4</span><br><span class="line">[keke] call146:.puts</span><br><span class="line">[main] call147:sub_123324</span><br><span class="line">[main] call148:sub_1205A0</span><br><span class="line">[main] call149:sub_11F768</span><br><span class="line">[main] call150:memcmp</span><br><span class="line">[main] call151:opendir</span><br><span class="line">[main] call152:closedir</span><br><span class="line">[main] call153:sub_11859C</span><br><span class="line">[main] call154:sub_11C268</span><br><span class="line">[main] call155:sub_11C300</span><br><span class="line">[main] call156:sub_117B68</span><br><span class="line">[main] call157:sub_1186B8</span><br><span class="line">[main] call158:sub_143964</span><br><span class="line">[main] call159:sub_1B66A8</span><br><span class="line">[main] call160:pthread_mutex_lock</span><br><span class="line">[main] call161:sub_142EA0</span><br><span class="line">[main] call162:sub_143A38</span><br><span class="line">[main] call163:sub_11CF8C</span><br><span class="line">[main] call164:sub_131D58</span><br><span class="line">[main] call165:sub_1B66D0</span><br><span class="line">[main] call166:pthread_mutex_unlock</span><br><span class="line">[main] call167:sub_1178E8</span><br><span class="line">[main] call168:sub_13D70C</span><br><span class="line">[main] call169:sub_19F984</span><br><span class="line">[main] call170:sub_11F1C8</span><br><span class="line">[main] call171:atoi</span><br><span class="line">[main] call172:sub_12D2F8</span><br><span class="line">[main] call173:sub_17ABE8</span><br><span class="line">[main] call174:sub_172660</span><br><span class="line">[main] call175:sub_13BFF0</span><br><span class="line">[main] call176:sub_172AA4</span><br><span class="line">[main] call177:sub_13BD80</span><br><span class="line">[main] call178:sub_13BE2C</span><br><span class="line">[main] call179:sub_13BE4C</span><br><span class="line">[main] call180:memmove</span><br><span class="line">[main] call181:sub_13BE64</span><br><span class="line">[main] call182:sub_172D78</span><br><span class="line">[main] call183:sub_13E510</span><br><span class="line">[main] call184:sub_1926F0</span><br><span class="line">[main] call185:sub_13DB7C</span><br><span class="line">[main] call186:sub_1B7A08</span><br><span class="line">[main] call187:sub_1B7ABC</span><br><span class="line">[main] call188:pthread_cond_broadcast</span><br><span class="line">open /proc/self/maps</span><br><span class="line">find /proc/self/maps, redirect to /data/data/com.oacia.apk_protect/maps_nonexistent</span><br><span class="line">open /proc/self/maps</span><br><span class="line">find /proc/self/maps, redirect to /data/data/com.oacia.apk_protect/maps_nonexistent</span><br><span class="line">[main] call189:sub_12FA34</span><br><span class="line">[main] call190:sub_120664</span><br><span class="line">[main] call191:sub_1332B8</span><br><span class="line">[main] call192:sub_13E0F8</span><br><span class="line">open /proc/self/maps</span><br><span class="line">find /proc/self/maps, redirect to /data/data/com.oacia.apk_protect/maps_nonexistent</span><br><span class="line">[main] call193:sub_12743C</span><br><span class="line">[main] call194:sub_124C68</span><br><span class="line">[main] call195:sub_125DC4</span><br><span class="line">[main] call196:sub_124510</span><br><span class="line">[main] call197:sub_126888</span><br><span class="line">[main] call198:strdup</span><br><span class="line">[main] call199:sub_126920</span><br><span class="line">[main] call200:sub_122180</span><br><span class="line">[main] call201:sub_11BC1C</span><br><span class="line">[main] call202:sub_13DF34</span><br><span class="line">[main] call203:getpid</span><br><span class="line">[main] call204:memset</span><br><span class="line">[main] call205:snprintf</span><br><span class="line">open /proc/25453/maps</span><br><span class="line">find /proc/25453/maps, redirect to /data/data/com.oacia.apk_protect/maps_nonexistent</span><br><span class="line">[main] call206:sub_124FA0</span><br><span class="line">[main] call207:sub_1B6498</span><br><span class="line">[main] call208:sub_1A0C88</span><br><span class="line">[main] call209:sub_217444</span><br><span class="line">[main] call210:sub_2175E0</span><br><span class="line">[main] call211:read</span><br><span class="line">[main] call212:strncmp</span><br><span class="line">[main] call213:close</span><br><span class="line">[main] call214:sub_1B578C</span><br><span class="line">[main] call215:j___self_lseek</span><br><span class="line">[main] call216:__self_lseek</span><br><span class="line">[main] call217:sub_1B586C</span><br><span class="line">[main] call218:j_j___read_self</span><br><span class="line">[main] call219:j___read_self</span><br><span class="line">[main] call220:__read_self</span><br><span class="line">[main] call221:sub_1B6528</span><br><span class="line">[main] call222:sub_1B6578</span><br><span class="line">[main] call223:mmap</span><br><span class="line">[main] call224:sub_1B5B50</span><br><span class="line">[main] call225:calloc</span><br><span class="line">[main] call226:memchr</span><br><span class="line">[main] call227:sub_1B5D04</span><br><span class="line">[main] call228:sub_1B5EC4</span><br><span class="line">[main] call229:sub_1B6270</span><br><span class="line">[main] call230:sub_1B6180</span><br><span class="line">[main] call231:sub_1B6678</span><br><span class="line">[main] call232:inflateInit2_</span><br><span class="line">[main] call233:inflate</span><br><span class="line">[main] call234:inflateEnd</span><br><span class="line">[main] call235:sub_1B6540</span><br><span class="line">[main] call236:munmap</span><br><span class="line">[main] call237:sub_1B56F8</span><br><span class="line">[main] call238:sub_19BC9C</span><br><span class="line">[main] call239:sub_19CCD4</span><br><span class="line">open /proc/self/maps</span><br><span class="line">find /proc/self/maps, redirect to /data/data/com.oacia.apk_protect/maps_nonexistent</span><br><span class="line">[main] call240:sub_12D470</span><br><span class="line">[main] call241:sub_142FE0</span><br><span class="line">[main] call242:sub_143008</span><br><span class="line">[main] call243:sub_142ABC</span><br><span class="line">[main] call244:sub_143848</span><br><span class="line">[main] call245:sub_143B48</span><br><span class="line">[main] call246:sub_143088</span><br><span class="line">[main] call247:sub_1222D0</span><br><span class="line">[main] call248:sub_14316C</span><br><span class="line">[main] call249:sub_142954</span><br><span class="line">[keke] call250:_Z9__arm_a_2PcmS_Rii</span><br><span class="line">[main] call251:sub_142894</span><br><span class="line">[main] call252:sub_1428BC</span><br><span class="line">[main] call253:sub_127DCC</span><br><span class="line">[main] call254:sub_14292C</span><br><span class="line">[main] call255:sub_121B78</span><br><span class="line">[main] call256:sub_121BE0</span><br><span class="line">[main] call257:sub_123CE8</span><br><span class="line">[main] call258:sub_123BC0</span><br><span class="line">[main] call259:sub_11959C</span><br><span class="line">[main] call260:sub_1AC170</span><br><span class="line">[main] call261:pthread_create</span><br><span class="line">[main] call262:sub_1AC210</span><br><span class="line">[main] call263:sub_1B5DE4</span><br><span class="line">[main] call264:sub_1B60E8</span><br><span class="line">[main] call265:sub_19F7C4</span><br><span class="line">[main] call266:sub_1B2DC8</span><br><span class="line">[main] call267:sub_1B1CE8</span><br><span class="line">open /proc/self/maps</span><br><span class="line">find /proc/self/maps, redirect to /data/data/com.oacia.apk_protect/maps_nonexistent</span><br><span class="line">[main] call268:sub_1B0974</span><br><span class="line">[main] call269:sub_1AFE6C</span><br><span class="line">[main] call270:sub_126ED8</span><br><span class="line">[main] call271:sub_1AFE8C</span><br><span class="line">[main] call272:sub_1AFE90</span><br><span class="line">[main] call273:sub_1AB87C</span><br><span class="line">[main] call274:sub_1B26D4</span><br><span class="line">[main] call275:sub_1B26F4</span><br><span class="line">[main] call276:sub_1B27C8</span><br><span class="line">[keke] call277:.ffi_prep_cif_var</span><br><span class="line">[keke] call278:ffi_prep_cif_var</span><br><span class="line">[main] call279:sub_1AAF48</span><br><span class="line">[main] call280:sub_1AAF54</span><br><span class="line">[main] call281:sub_2162D4</span><br><span class="line">[main] call282:sub_1B2898</span><br><span class="line">[main] call283:sub_1B2918</span><br><span class="line">[main] call284:sub_1ABE90</span><br><span class="line">[main] call285:sub_13E0EC</span><br><span class="line">Process terminated</span><br></pre></td></tr></table></figure>

<p>根据对日志的分析，发现有3个函数是zlib库中用来解压缩的函数——inflateInit2_、inflate、inflateEnd，大概率是用来解压dex文件的。</p>
<p>对inflateInit2_进行交叉引用，发现2个引用。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526120322384.png" alt="image-20250526120322384"></p>
<p>根据日志，先查看sub_1B6270。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526120702211.png" alt="image-20250526120702211" style="zoom:80%;" />

<p>注意到，inflate的参数是s和4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526121122466.png" alt="image-20250526121122466"></p>
<p>根据函数签名，可以知道s是z_streamp类型，需要在IDA中添加相应的结构体。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526121150955.png" alt="image-20250526121150955"></p>
<p>结构体如下，Bytef可以改成Byte*，指针都是8个字节，感觉不用太担心具体类型。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#  <span class="keyword">define</span> z_const const</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span>  Byte;  <span class="comment">/* 8 bits */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span>   uInt;  <span class="comment">/* 16 bits or more */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span>  uLong; <span class="comment">/* 32 bits or more */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">z_stream_s</span> &#123;</span></span><br><span class="line">    z_const Bytef *next_in;     <span class="comment">/* next input byte */</span></span><br><span class="line">    uInt     avail_in;  <span class="comment">/* number of bytes available at next_in */</span></span><br><span class="line">    uLong    total_in;  <span class="comment">/* total number of input bytes read so far */</span></span><br><span class="line"></span><br><span class="line">    Bytef    *next_out; <span class="comment">/* next output byte will go here */</span></span><br><span class="line">    uInt     avail_out; <span class="comment">/* remaining free space at next_out */</span></span><br><span class="line">    uLong    total_out; <span class="comment">/* total number of bytes output so far */</span></span><br><span class="line">&#125; z_stream;</span><br></pre></td></tr></table></figure>

<p>接下来hook inflate，看看解压缩后的数据是什么，这里有个问题，在主so还没解密时是hook不了的，大佬oacia给了一个思路：哦统计inflate调用的次数，壳ELF在调用uncompress的时候会执行1次inflate，而解压dex的时候就是第2次。</p>
<p>大佬的思路很好，学习到了，但是不知道为什么大佬的脚本hook的是汇编层指令的地址（可能会报错），而非函数序言地址，直接在onLeave回调时不一样可以dump和打印吗，还可以少定义一个函数。</p>
<p>下面是从佬博客标注的代码，不全。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dump_memory</span>(<span class="params">start,size,filename</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> file_path = <span class="string">&quot;/data/data/com.oacia.apk_protect/&quot;</span> + filename;</span><br><span class="line">    <span class="keyword">var</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> libso_buffer = start.<span class="title function_">readByteArray</span>(size.<span class="title function_">toUInt32</span>());</span><br><span class="line">        file_handle.<span class="title function_">write</span>(libso_buffer);</span><br><span class="line">        file_handle.<span class="title function_">flush</span>();</span><br><span class="line">        file_handle.<span class="title function_">close</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump]:&quot;</span>, file_path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_zlib_result</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1B63F0</span>), &#123;</span><br><span class="line">        <span class="comment">// fd, buff, len</span></span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;inflate result&quot;</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(next_in, &#123;</span><br><span class="line">              <span class="attr">offset</span>: <span class="number">0</span>,<span class="comment">// 相对偏移</span></span><br><span class="line">              <span class="attr">length</span>: <span class="number">0x50</span>,<span class="comment">//dump 的大小</span></span><br><span class="line">              <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">            &#125;));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(next_out, &#123;</span><br><span class="line">              <span class="attr">offset</span>: <span class="number">0</span>,<span class="comment">// 相对偏移</span></span><br><span class="line">              <span class="attr">length</span>: <span class="number">0x50</span>,<span class="comment">//dump 的大小</span></span><br><span class="line">              <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">            &#125;));</span><br><span class="line">            <span class="title function_">dump_memory</span>(next_out,avail_out,<span class="string">&quot;dex001&quot;</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> zlib_count=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> next_in,avail_in,next_out,avail_out;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_zlib</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;inflate&quot;</span>), &#123;</span><br><span class="line">        <span class="comment">// fd, buff, len</span></span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            zlib_count+=<span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(zlib_count&gt;<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="title function_">hook_zlib_result</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            next_in=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x0</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            avail_in=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x8</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            next_out=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x18</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            avail_out=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x20</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(next_in, &#123;</span><br><span class="line">              <span class="attr">offset</span>: <span class="number">0</span>,<span class="comment">// 相对偏移</span></span><br><span class="line">              <span class="attr">length</span>: <span class="number">0x50</span>,<span class="comment">//dump 的大小</span></span><br><span class="line">              <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">            &#125;));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">1</span>]);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是我对佬代码做的删减及必要的补充。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dump_memory</span>(<span class="params">start,size,filename</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> file_path = <span class="string">&quot;/data/data/com.oacia.apk_protect/&quot;</span> + filename;</span><br><span class="line">    <span class="keyword">var</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> libso_buffer = start.<span class="title function_">readByteArray</span>(size.<span class="title function_">toUInt32</span>());</span><br><span class="line">        file_handle.<span class="title function_">write</span>(libso_buffer);</span><br><span class="line">        file_handle.<span class="title function_">flush</span>();</span><br><span class="line">        file_handle.<span class="title function_">close</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump]:&quot;</span>, file_path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> zlib_count=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> next_in,avail_in,next_out,avail_out;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_zlib</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;inflate&quot;</span>), &#123;</span><br><span class="line">        <span class="comment">// fd, buff, len</span></span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            zlib_count+=<span class="number">1</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[inflate calls]&quot;</span>, zlib_count);</span><br><span class="line">            next_in=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x0</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            avail_in=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x8</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            next_out=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x18</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            avail_out=<span class="title function_">ptr</span>(args[<span class="number">0</span>].<span class="title function_">add</span>(<span class="number">0x20</span>).<span class="title function_">readS64</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(next_in, &#123;</span><br><span class="line">              <span class="attr">offset</span>: <span class="number">0</span>,<span class="comment">// 相对偏移</span></span><br><span class="line">              <span class="attr">length</span>: <span class="number">0x64</span>,<span class="comment">//dump 的大小</span></span><br><span class="line">              <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(zlib_count&gt;<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;inflate result&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(next_out, &#123;</span><br><span class="line">                  <span class="attr">offset</span>: <span class="number">0</span>,<span class="comment">// 相对偏移</span></span><br><span class="line">                  <span class="attr">length</span>: <span class="number">0x50</span>,<span class="comment">//dump 的大小</span></span><br><span class="line">                  <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">                  <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">                &#125;));</span><br><span class="line">                <span class="title function_">dump_memory</span>(next_out,avail_out,<span class="string">&quot;dex001&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">my_hook_dlopen</span>(<span class="params">soName=<span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="comment">//console.log(path);</span></span><br><span class="line">                    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_proc_self_maps</span>();</span><br><span class="line">                    <span class="title function_">hook_zlib</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_proc_self_maps</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> openPtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> open = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fakePath = <span class="string">&quot;/data/data/com.oacia.apk_protect/maps_nonexistent&quot;</span>;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(openPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">pathnameptr, flag</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> pathname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(pathnameptr);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;open&quot;</span>,pathname);<span class="comment">//,Process.getCurrentThreadId()</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;maps&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find&quot;</span>,pathname+<span class="string">&quot;, redirect to&quot;</span>,fakePath);</span><br><span class="line">            <span class="keyword">var</span> filename = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(fakePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">open</span>(filename, flag);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> fd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">my_hook_dlopen</span>(<span class="string">&#x27;libjiagu&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行效果如下，解压后的数据似乎是一个dex文件？</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526132131214.png" alt="image-20250526132131214" style="zoom:80%;" />

<p>难蚌，为什么解压后的数据与原dex完全相同。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526132323546.png" alt="image-20250526132323546"></p>
<p>博主根据原apk、加固后的apk，通过比较大小，发现壳dex的末尾附带了一大串加密数据，既然当前的sub_1B6270解压出了和原dex一样的<strong>数据A</strong>，说明接下来该对这个<strong>数据A</strong>的末尾进行解密了。</p>
<p>观察sub_1B6270，会发现，return是用来判断函数sub_1B6270是否执行成功的。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526134858141.png" alt="image-20250526134858141" style="zoom:80%;" />

<p>a3将缓冲区的地址传给了s.next_out，解压后的数据在a3，缓冲区的长度为v19。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526135343573.png" alt="image-20250526135343573" style="zoom:80%;" />

<p>追踪sub_1B6270，判断a3是在哪申请的缓冲区，根据日志，选择sub_1A0C88。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526135805308.png" alt="image-20250526135805308"></p>
<p>v10拿到了装有原dex的缓冲区，然后赋给了a3。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526135905993.png" alt="image-20250526135905993"></p>
<p>根据日志，这里选择追踪函数sub_124FA0。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526140025579.png" alt="image-20250526140025579"></p>
<p>这里返回值用来判断是否执行成功，s1获得了原dex。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526140247694.png" alt="image-20250526140247694"></p>
<p>s1会给v27传递一些信息，此后s1没出现过了。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526141948951.png" alt="image-20250526141948951"></p>
<p>对sub_19BC9C进行分析。</p>
<ol>
<li><p><strong>内部状态初始化</strong>：对 <code>a1</code> 指向的内存区域进行清零和内部指针设置。</p>
</li>
<li><p><strong>DEX文件处理</strong>：解析传入的 <code>s1</code>（壳dex文件），识别其具体类型（DEX, ODEX, CDEX），并调整 <code>a1</code> 中的指针以指向有效的DEX数据区域。这使得后续代码可以通过 <code>a1</code> 方便地访问DEX内容。</p>
</li>
<li><p><strong>构建JNI类型映射</strong>：在 <code>a1</code> 结构的某个区域（从偏移 <code>0x138</code> 开始）构建一个从JNI短类型签名到完整Java类名的映射表。这个映射表是执行JNI操作（如方法调用、字段访问）时进行类型匹配和转换的基础。</p>
</li>
</ol>
<p> 看来也没有壳dex末尾的加密数据进行解密，继续交叉引用sub_124FA0，结合日志，下一个追踪的函数是sub_1332B8。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526143837983.png" alt="image-20250526143837983" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526143857946.png" alt="image-20250526143857946"></p>
<p>调用链应该是这样的，除此之外，暂时没什么成果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_1332B8-&gt;sub_124FA0-&gt;sub_1A0C88-&gt;sub_1B6270-&gt;inflate</span><br></pre></td></tr></table></figure>

<p>回到函数open打开classes.dex时的函数调用栈，如下图。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526100506048.png" alt="image-20250526100506048" style="zoom:80%;" />

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250522133032024.png" alt="image-20250522133032024" style="zoom:67%;" />

<p>查看函数0x19b780的引用，发现有2次引用来自sub_1332b8，根据上面2个图，结合0x134680 &#x3D;&#x3D; 0x1332b8 + 0x13c4 + 0x4和0x134598 &#x3D;&#x3D; 0x1332b8 + 0x12dC + 0x4。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526150825957.png" alt="image-20250526150825957"></p>
<p>所以classes.dex对应的sub_19b760，在sub_1332B8+12DC处被调用。</p>
<p>而classes2.dex和classes3.dex对应的sub_19b760，在subsub_1332B8+13C4处被调用。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526151921387.png" alt="image-20250526151921387"></p>
<p>注意到，壳dex的中注入的加密数据位于0x3198h处，而大小是0x41FD18。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526152253621.png" alt="image-20250526152253621"></p>
<p>尝试hook一下sub_19b760，观察buffer和buffer_size是否有符合壳dex末尾加密数据的特征。</p>
<p>大佬没给脚本，自己写一个脚本吧。</p>
<p>考虑到sub_19b760是主so中的函数，如果hook得太早，主so还没有加载，这样hook不上，甚至可能会有报错；如果hook太晚，sub_19b70可能执行完了。</p>
<p>所以需要找一个时机，主so已经加载完，并且sub_19b70还没清空的时机——其实拿inflate第2次执行的时机就行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">my_hook_dlopen</span>(<span class="params">soName=<span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="comment">//console.log(path);</span></span><br><span class="line">                    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_proc_self_maps</span>();</span><br><span class="line"></span><br><span class="line">                    <span class="title function_">hook_zlib</span>();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_proc_self_maps</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> openPtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> open = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fakePath = <span class="string">&quot;/data/data/com.oacia.apk_protect/maps_nonexistent&quot;</span>;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(openPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">pathnameptr, flag</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> pathname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(pathnameptr);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;open&quot;</span>,pathname);<span class="comment">//,Process.getCurrentThreadId()</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pathname.<span class="title function_">indexOf</span>(<span class="string">&quot;maps&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find&quot;</span>,pathname+<span class="string">&quot;, redirect to&quot;</span>,fakePath);</span><br><span class="line">            <span class="keyword">var</span> filename = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(fakePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">open</span>(filename, flag);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> fd = <span class="title function_">open</span>(pathnameptr, flag);</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> zlib_count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_zlib</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;inflate&quot;</span>), &#123;</span><br><span class="line">        <span class="comment">// fd, buff, len</span></span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            zlib_count = zlib_count + <span class="number">1</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">            <span class="comment">// 此时的sub_19b760已经解密完成，而且没有被清空</span></span><br><span class="line">            <span class="keyword">if</span>(zlib_count == <span class="number">2</span>)&#123;</span><br><span class="line">                <span class="title function_">hook_sub_19b760</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_sub_19b760</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[so base]&quot;</span>, <span class="string">&quot;0x&quot;</span> + <span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">toString</span>(<span class="number">16</span>))</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x19b760</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[path]&quot;</span>, args[<span class="number">0</span>].<span class="title function_">readCString</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[buffer] size =&quot;</span>, <span class="string">&quot;0x&quot;</span>+args[<span class="number">2</span>].<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">1</span>], &#123;<span class="attr">length</span>: <span class="number">64</span>&#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">my_hook_dlopen</span>(<span class="string">&#x27;libjiagu&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行结果如下，可以看到，打开的classes.dex正是壳dex末尾的注入数据，连大小都是0x41fd18。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526155617908.png" alt="image-20250526155617908"></p>
<p>在sub_1332B8中，打开了classes.dex，已经确定了sub_19B760的3个参数的内容是什么，追踪dex_buffer。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526163850323.png" alt="image-20250526163850323"></p>
<p>dex_buffer会作为参数传递给sub_128D44。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526164059339.png" alt="image-20250526164059339"></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526164137748.png" alt="image-20250526164137748"></p>
<p>转到汇编层，可以看到j_interpreter_wrap_int64_t的参数不应该是0。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526180148434.png" alt="image-20250526180148434"></p>
<p>根据寄存器的大小，修改成下面这样。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526180048792.png" alt="image-20250526180048792"></p>
<p>接着，通过stalker_trace_so的日志可以发现，函数sub_128D44没执行。博主在这个问题上的解决办法是：在调用sub_128D44的位置，再调用一次trace_so()。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526180701496.png" alt="image-20250526180701496"></p>
<p>博主给出了脚本的片段，如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526181208584.png" alt="image-20250526181208584"></p>
<p>我试验了一下，进程还是退出了，可能是我hook的时机不对，干脆先把反调过了，然后再执行stalker_trace_so，使用下面这个脚本可以找到哪里调用了pthread_create。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">check_pthread_create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> pthread_create_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;pthread_create&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pthread_create = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(pthread_create_addr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(pthread_create_addr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">parg0, parg1, parg2, parg3</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> so_name = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(parg2).<span class="property">name</span>;</span><br><span class="line">        <span class="keyword">var</span> so_path = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(parg2).<span class="property">path</span>;</span><br><span class="line">        <span class="keyword">var</span> so_base = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(so_name);</span><br><span class="line">        <span class="keyword">var</span> offset = parg2 - so_base;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">PC</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((so_name.<span class="title function_">indexOf</span>(<span class="string">&quot;jiagu&quot;</span>) &gt; -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;======&quot;</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find thread func offset&quot;</span>, so_name, offset.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">            <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">ACCURATE</span>).<span class="title function_">map</span>(addr_in_so);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> check_list = []<span class="comment">//1769036,1771844</span></span><br><span class="line">            <span class="keyword">if</span> (check_list.<span class="title function_">indexOf</span>(offset)!==-<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;check bypass&quot;</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable constant_">PC</span> = <span class="title function_">pthread_create</span>(parg0, parg1, parg2, parg3);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable constant_">PC</span> = <span class="title function_">pthread_create</span>(parg0, parg1, parg2, parg3);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable constant_">PC</span>;</span><br><span class="line">    &#125;, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addr_in_so</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> process_Obj_Module_Arr = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; process_Obj_Module_Arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(addr&gt;process_Obj_Module_Arr[i].<span class="property">base</span> &amp;&amp; addr&lt;process_Obj_Module_Arr[i].<span class="property">base</span>.<span class="title function_">add</span>(process_Obj_Module_Arr[i].<span class="property">size</span>))&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(addr.<span class="title function_">toString</span>(<span class="number">16</span>),<span class="string">&quot;is in&quot;</span>,process_Obj_Module_Arr[i].<span class="property">name</span>,<span class="string">&quot;offset: 0x&quot;</span>+(addr-process_Obj_Module_Arr[i].<span class="property">base</span>).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">check_pthread_create</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526184917507.png" alt="image-20250526184917507" style="zoom:80%;" />

<p>由于无法判断是哪个线程检测了frida，这里并不方便把目标线程函数替换为空。</p>
<p>先来0x17710看看，并没有看到pthread_create，这里的X24里面应该存放了pthread_create的地址。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526185047625.png" alt="image-20250526185047625" style="zoom:80%;" />

<p>大佬oacia在这里写得有些模糊。这里X24不一定是pthread_create，还有可能是其它的函数，通过这种动态跳转的方式，避免在静态调试工具中暴露易被检测的函数。</p>
<p>大佬在这里一个一个改x0-x6，emmm，先判断X24跳转的函数是什么，然后查看对应的寄存器会更好吧。</p>
<p>这里借着大佬已经分析出的解决方案——修改x6指向的字符串，去思考为什么是修改x6。</p>
<p>之前我们hook maps文件，是因为存在读maps文件的操作，但要如何逐行检测frida呢？是靠strstr吗？这里的x6说明了参数的数目之多，strstr可没那么多参数。</p>
<p>我写了个脚本，hook x6寄存器，并根据x24跳转的地址，根据它的偏移量，计算跳转的目标函数是什么。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">anti_frida_check</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">module</span>) &#123;</span><br><span class="line">        <span class="comment">// console.log(&quot;[anti_frida_check] libjiagu_64.so not found.&quot;);</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1770C</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 确保 X6 是一个有效的指针再尝试读取</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x6</span> &amp;&amp; !<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x6</span>.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                    <span class="keyword">var</span> s = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        s = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x6</span>.<span class="title function_">readCString</span>();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (readError) &#123;</span><br><span class="line">                        <span class="comment">// console.log(&quot;[anti_frida_check] Error reading string from X6: &quot; + readError.message);</span></span><br><span class="line">                        <span class="keyword">return</span>; <span class="comment">// 如果无法读取字符串，则不继续</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (s &amp;&amp; (s.<span class="title function_">indexOf</span>(<span class="string">&#x27;frida&#x27;</span>) !== -<span class="number">1</span> ||</span><br><span class="line">                              s.<span class="title function_">indexOf</span>(<span class="string">&#x27;gum-js-loop&#x27;</span>) !== -<span class="number">1</span> ||</span><br><span class="line">                              s.<span class="title function_">indexOf</span>(<span class="string">&#x27;gmain&#x27;</span>) !== -<span class="number">1</span> ||</span><br><span class="line">                              s.<span class="title function_">indexOf</span>(<span class="string">&#x27;linjector&#x27;</span>) !== -<span class="number">1</span> ||</span><br><span class="line">                              s.<span class="title function_">indexOf</span>(<span class="string">&#x27;/proc/&#x27;</span>) !== -<span class="number">1</span>)) &#123;</span><br><span class="line">                        </span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n==================================================&quot;</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Frida-related string detected in X6!&quot;</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    Original string (s) from X6: \&quot;&quot;</span> + s + <span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">                        </span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;--- Register Dump (X0-X6) ---&quot;</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X0: &quot;</span> + <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X1: &quot;</span> + <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x1</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X2: &quot;</span> + <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x2</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X3: &quot;</span> + <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x3</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X4: &quot;</span> + <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x4</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X5: &quot;</span> + <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x5</span>);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X6: &quot;</span> + <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x6</span> + <span class="string">&quot; (Pointer value)&quot;</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;--- X24 Analysis ---&quot;</span>);</span><br><span class="line">                        <span class="keyword">var</span> x24_val = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x24</span>;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    X24 points to address: &quot;</span> + x24_val);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (x24_val &amp;&amp; !x24_val.<span class="title function_">isNull</span>()) &#123;</span><br><span class="line">                            <span class="keyword">var</span> symbolInfo = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(x24_val);</span><br><span class="line">                            <span class="keyword">if</span> (symbolInfo &amp;&amp; symbolInfo.<span class="property">name</span>) &#123;</span><br><span class="line">                                <span class="keyword">var</span> moduleName = symbolInfo.<span class="property">moduleName</span> || <span class="string">&quot;unknown module&quot;</span>;</span><br><span class="line">                                <span class="keyword">var</span> moduleBase = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(moduleName) || <span class="title function_">ptr</span>(<span class="number">0</span>);</span><br><span class="line">                                <span class="keyword">var</span> symbolOffset = symbolInfo.<span class="property">address</span>.<span class="title function_">sub</span>(moduleBase); <span class="comment">// Offset of symbol from module base</span></span><br><span class="line">                                <span class="keyword">var</span> pcOffsetFromSymbolStart = x24_val.<span class="title function_">sub</span>(symbolInfo.<span class="property">address</span>); <span class="comment">// Offset of PC from symbol start</span></span><br><span class="line"></span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    -&gt; Resolved Symbol: &quot;</span> + symbolInfo.<span class="property">name</span>);</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;       Module: &quot;</span> + moduleName + <span class="string">&quot; (Base: &quot;</span> + moduleBase + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;       Symbol Address: &quot;</span> + symbolInfo.<span class="property">address</span> + <span class="string">&quot; (Offset in module: 0x&quot;</span> + symbolOffset.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;       X24 is +0x&quot;</span> + pcOffsetFromSymbolStart.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot; bytes from symbol start.&quot;</span>);</span><br><span class="line"></span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="comment">// 如果 DebugSymbol 未直接找到名称，尝试通过 ModuleMap 查找模块</span></span><br><span class="line">                                <span class="keyword">var</span> moduleDetails = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(x24_val);</span><br><span class="line">                                <span class="keyword">if</span> (moduleDetails) &#123;</span><br><span class="line">                                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    -&gt; Address is within module: &quot;</span> + moduleDetails.<span class="property">name</span>);</span><br><span class="line">                                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;       Module Base: &quot;</span> + moduleDetails.<span class="property">base</span>);</span><br><span class="line">                                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;       Offset from module base: 0x&quot;</span> + x24_val.<span class="title function_">sub</span>(moduleDetails.<span class="property">base</span>).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    -&gt; Could not resolve X24 to a specific function or module.&quot;</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    -&gt; X24 is null or its value is invalid.&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;==================================================\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="comment">// 捕获外部 try-catch 的错误，例如 this.context 访问问题（虽然不太可能）</span></span><br><span class="line">                <span class="comment">// console.log(&quot;[anti_frida_check] General error in onEnter: &quot; + e.message);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">my_hook_dlopen</span>(<span class="params">soName = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span> &amp;&amp; !pathptr.<span class="title function_">isNull</span>()) &#123; <span class="comment">// 添加 !pathptr.isNull() 检查</span></span><br><span class="line">                    <span class="keyword">var</span> path = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        <span class="comment">// console.log(&quot;Error reading SO path: &quot; + e.message);</span></span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (path &amp;&amp; soName &amp;&amp; path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123; <span class="comment">// 确保 soName 也有效</span></span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="comment">// console.log(&quot;[my_hook_dlopen] Detected &quot; + (soName || &quot;target SO&quot;) + &quot;. Attaching anti_frida_check.&quot;);</span></span><br><span class="line">                    <span class="title function_">anti_frida_check</span>();</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">false</span>; <span class="comment">// 重置标志，避免重复附加</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 你可以在这里指定要监控的 soName，例如 &#x27;libjiagu_64.so&#x27;</span></span><br><span class="line">    <span class="comment">// 如果不指定，或者指定空字符串，my_hook_dlopen 默认的 soName=&#x27;&#x27;</span></span><br><span class="line">    <span class="comment">// path.indexOf(&#x27;&#x27;) 总是返回0（为真），这会导致对每个dlopen都尝试设置anti_frida_check</span></span><br><span class="line">    <span class="comment">// 建议明确指定 soName 来提高目标性，例如：</span></span><br><span class="line">    <span class="comment">// my_hook_dlopen(&#x27;libjiagu_64.so&#x27;); </span></span><br><span class="line">    <span class="comment">// 如果你希望保持原样，对所有SO加载（dlopen）后都调用 anti_frida_check（如果 libjiagu_64.so 已加载）</span></span><br><span class="line">    <span class="comment">// 那么下面的调用是正确的，但请注意 anti_frida_check 内部会找 libjiagu_64.so</span></span><br><span class="line">    <span class="title function_">my_hook_dlopen</span>(<span class="string">&#x27;libjiagu_64.so&#x27;</span>); <span class="comment">// 修改此处，明确指定目标SO，使anti_frida_check只在该SO加载后执行一次</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行结果如下，那应该很好猜了，sscanf是用来逐行解析maps文件的，然后比较对应的字段，判断是否有frida的痕迹。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526193502474.png" alt="image-20250526193502474" style="zoom:80%;" />

<p>接下来，只要将x6替换掉即可，博主给出了代码，添加一下执行时机即可使用，在这里就不写了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">anti_frida_check</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x1770C</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> s = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x6</span>.<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="keyword">if</span> (s.<span class="title function_">indexOf</span>(<span class="string">&#x27;frida&#x27;</span>)!==-<span class="number">1</span> ||</span><br><span class="line">                    s.<span class="title function_">indexOf</span>(<span class="string">&#x27;gum-js-loop&#x27;</span>)!==-<span class="number">1</span> ||</span><br><span class="line">                    s.<span class="title function_">indexOf</span>(<span class="string">&#x27;gmain&#x27;</span>)!==-<span class="number">1</span> ||</span><br><span class="line">                    s.<span class="title function_">indexOf</span>(<span class="string">&#x27;linjector&#x27;</span>)!==-<span class="number">1</span> ||</span><br><span class="line">                    s.<span class="title function_">indexOf</span>(<span class="string">&#x27;/proc/&#x27;</span>)!==-<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="comment">//console.log(s)</span></span><br><span class="line">                    <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>, <span class="title class_">Process</span>.<span class="property">pointerSize</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">                    <span class="keyword">var</span> replace_str=<span class="string">&quot;&quot;</span></span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;s.<span class="property">length</span>;i++)&#123;</span><br><span class="line">                        replace_str+=<span class="string">&quot;0&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>.<span class="title function_">writeUtf8String</span>(replace_str);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (e)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526195657484.png" alt="image-20250526195657484"></p>
<p>现在再试试能不能使用stalker_trace_so追踪所有函数了。</p>
<p>成功了，这回能够一直trace下去了，哈哈哈哈哈哈哈: &#x2F;</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526200220622.png" alt="image-20250526200220622"></p>
<p>顺着stalker_trace_so，沿着0x128D44继续往下分析，直到分析sub_18FEA8，这个函数内部存在大量的字符。</p>
<p>先hook这个函数的参数看看。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526202751628.png" alt="image-20250526202751628" style="zoom:80%;" />

<p>打印了3次，有理由去怀疑它与3个dex文件相关，感觉a1是数字、a2是地址、a3是大小，a4是地址，a5又是大小，a6暂时不知道。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526202809100.png" alt="image-20250526202809100" style="zoom:80%;" />

<p>修改一下，a2和a3分别代表着解密后的dex文件和文件大小。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526203312634.png" alt="image-20250526203312634"></p>
<p>根据oacia大佬的说明，函数sub_18FEA8里的字符串解密后，与dex文件的加载有关，这里就不深入了，主要还是关心dex文件是如何解密的。</p>
<p>我还是觉得sub_128d44很可疑，只输入一个加密的dex，加密的dex又不能提取什么信息，除了解密，还能干嘛？如果要解密，必须读取加密dex，所以可以在加密dex设置读写断点。</p>
<p>让gemini帮我写一个，脚本过于丑陋，就不外露了。</p>
<p>下面是打印结果。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250526205010061.png" alt="image-20250526205010061"></p>
<p>注意到，打印出来的内容基都是read的操作，而没有写的操作，说明解密后的dex放到了内存的另一个地方。——20250526-20:51，明天再看，看了一天了有点累了。</p>
<p>——早上好~现在是20250527-09:04，继续分析。</p>
<p>通过上图的hook，可以知道libjiagu_64.so偏移0xd364的位置访问了加密dex，而且这个偏移一眼是壳代码，偏移为0xd364的指令位于函数sub_C918内。</p>
<p>然而查看stalker_trace_so，发现sub_128D44后面没有跟着sub_C918，为什么？我的猜测如下：脚本hook的时机不对，frida_stalker_so hook的时机是当android_dlopen_ext检测到库libjiagu_64.so时，在onLeave回调时调用trace_so，对所有在func_addr列表上的地址进行追踪，然而，主so在没加载的时候，主so某些函数尚未解密，此时frida-stalker插的桩似乎并不有效，总之，可能会引起问题。</p>
<p>尝试验证一下：在第二次inflate的时候开始执行trace_so，第二次inflate的时候，主so应该是解密完成的。</p>
<p>下图是打印结果，看来猜对了。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527095842692.png" alt="image-20250527095842692" style="zoom:80%;" />

<p>hook一下sub_c918，根据观察，a1总为0，a2和a3应该是地址，a4不知道是什么；而且我明明写了onLeave回调，但这里没触发，说明函数sub_C918内访问了加密dex并调用了解密函数。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527121537670.png" alt="image-20250527121537670" style="zoom:80%;" />

<p>hook一下，查看执行到0xd364时，X19和X24的值。</p>
<p>也就是说x19 + x24 &#x3D;&#x3D; 0x7009ee4ce4，而[0x7009ee4ce4]的值为0x707aa982e0，0x707aa982e0刚好是0x707aa872d8 + 8的位置，因此访问了加密dex的缓冲区，触发了断点。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527133205197.png" alt="image-20250527133205197" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527133617161.png" alt="image-20250527133617161"></p>
<p>把脚本改了一下，验证一下，结果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527134953849.png" alt="image-20250527134953849"></p>
<p>和在010editor中加密dex的第2个8字节一样，说明思路是对的——但是注意，这里的汇编指令是STR W0，也就是传了4个字节，而非8个字节。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527135015190.png" alt="image-20250527135015190"></p>
<p>光看sub_c918，没发现解密内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527143339957.png" alt="image-20250527143339957" style="zoom:80%;" />

<p>而且似乎只访问了上图的内容，然后做了一个内存移动的操作，从将dex加密的第3个4字节从[x19, x24]移到[x19, x21]。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527133617161.png" alt="image-20250527133617161"></p>
<p>根据stalker_frida_so，继续往下分析其它的函数，寻找加密点。</p>
<p>在sub_143008发现了加解密的代码。</p>
<p>vaddq_s8，批量进行加法；veorq_s8，批量进行异或。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527153041340.png" alt="image-20250527153041340" style="zoom: 80%;" />

<p>hook sub_143008的形参。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527154322756.png" alt="image-20250527154322756"></p>
<p>结果如下。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527155431502.png" alt="image-20250527155431502"></p>
<p>arg1不知道是什么。</p>
<p>arg2指向着压缩的dex的第12个字节开始的地址。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527160301779.png" alt="image-20250527160301779"></p>
<p>arg2 &#x3D;&#x3D; 0x41e，这不正是偏移0xD364处的指令，所读取那4个字节吗？</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527155938623.png" alt="image-20250527155938623"></p>
<p>解密一下，发现是配置信息。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527164253814.png" alt="image-20250527164253814" style="zoom:80%;" />

<p>解密算法是：（加密字节 + 0x70）^0x36，但这仅仅针对0x41E个字节，并不足以解密整个dex文件。</p>
<p>接下来，大佬的思路是：在调用链中，发现用到了pthread_mutex_lock函数，说明有多个线程，当前的frida-stalker追踪的是某一线程，有可能是其它的线程完成了对dex的解密。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527161717098.png" alt="image-20250527161717098" style="zoom:80%;" />

<p>查看sub_143848、sub_1B66A8，看看是哪个函数调用了锁。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527162127366.png" alt="image-20250527162127366" style="zoom:80%;" />

<p>既然函数sub_143848涉及到锁，说明会有多个线程调用sub_143848，因此对函数sub_143848进行hook。</p>
<p>照着博客的代码，改了一下脚本，追踪非主线程的线程，只trace一次。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527163146812.png" alt="image-20250527163146812" style="zoom:80%;" />

<p>打印结果如下，和大佬博客的一模一样。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527163120637.png" alt="image-20250527163120637" style="zoom:80%;" />

<p>然后大佬发现sub_1A1D84是一个解密函数。</p>
<p>但是！其实我在主线程的trace.log中也看到了这个函数，可能是大佬没注意吧？</p>
<p>sub_1A1D84是一个典型的RC4算法函数，一眼a2是密钥，a3是长度。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527164604090.png" alt="image-20250527164604090" style="zoom:67%;" />

<p>hook一下，获得密钥的内容。长16字节，内容是：0x68,0x76,0x99,0x72,0x96,0x60,0x9f,0x63,0x96,0x2c,0x98,0x30,0xc2,0x36,0x51,0x42</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527165421138.png" alt="image-20250527165421138"></p>
<p>与sub_1A1D84的下一个函数调用是sub_1A1E74，明显的rc4解密。</p>
<p>hook一下，查看函数sub_1A1E74在对什么进行解密。</p>
<p>第一个加密内容如下所示。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527181237282.png" alt="image-20250527181237282"></p>
<p>将f7 4f e8 0e 62 19作为搜索关键词，在壳dex中进行搜索。</p>
<p>蓝色部分是不知道什么作用的8个字节，蓝色与红色直接是加密内容的长度，也就是0x10949f，红色部分是加密内容，因此，可以判断sub_1A1E74在对壳dex尾部的加密数据进行逐段解密。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527181335376.png" alt="image-20250527181335376"></p>
<p>同时注意到，先前先加0x70，再异或0x36的加密内容，同样源于壳dex的末尾，同样前8个字节不知道是什么，然后4个字节代表加密内容大小，0x31A4 + 0x41E &#x3D;&#x3D; 0x35C2，正好是上面那段加密内容的起始部分。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527181652626.png" alt="image-20250527181652626"></p>
<p>因此，可以猜测壳dex有多个段被加密，数据结构是这样的：不知道什么作用的8个字节 + 加密内容长度（4个字节） + 加密内容 + 不知道什么作用的8个字节…….</p>
<p>计算一下下一段加密内容的起始地址：0x10949F + 0x35CE &#x3D;&#x3D; 0x10CA6D，下一个加密内容的长度是0x31a3028，这个长度明显不肯，说明关于壳dex的数据结构猜测有问题，说明存在其它的加密方式。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527182226096.png" alt="image-20250527182226096"></p>
<p>观察我们的打印日志，只有f7 4f e8 0e 62开头encrypt_data在壳dex中，其它的加密内容，并没有出现在壳dex中。统计一下，有3个f7 4f e8 0e 62开头encrypt_data，还有3个长度为0x6400的encrypt_data，会不会代表着3个dex文件及其加密组件呢？</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527183939347.png" alt="image-20250527183939347" style="zoom:67%;" />

<p>把这3个内容解密看看，然而并没有出现dex的魔术。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527184825546.png" alt="image-20250527184825546" style="zoom:80%;" />

<p>总结一下，这3个rc加密的内容，分别在偏移<code>0x35CE</code> , <code>0x3A93AD</code> , <code>0x417064</code>的位置。</p>
<p>看了一眼博主的分析，好像确实是这样！</p>
<p>所以，加密dex的数据结构应该是这个样子：<strong>未知8个字节、配置信息长度（4字节）、配置信息、加密内容个数（4个字节）、加密内容1的总长度（4个字节）、加密内容1需要rc4解密的长度（4个字节）、加密内容1、加密内容2的总长度（4个字节）、加密内容2需要rc4解密的长度（4个字节）、加密内容2、加密内容3的总长度（4个字节）、加密内容3需要rc4解密的长度（4个字节）、加密内容3。</strong></p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20240308004303427.png" alt="image-20240308004303427"></p>
<p>如此，便可写一个脚本，尝试把加密内容脱下来并解密，如下图所示，下图是dex1的内容，仍然是加密内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527193149268.png" alt="image-20250527193149268" style="zoom:80%;" />

<p>跟着<del>博主</del>（函数调用链）继续分析，函数sub_18F6AC似乎在做解密。</p>
<p>其中，a3是加密内容被rc4解密后，从0xC开始的数据地址。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527193749337.png" alt="image-20250527193749337" style="zoom:80%;" />

<p>具体如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527194144192.png" alt="image-20250527194144192"></p>
<p>还有11个字节，在函数sub_18DCC0进行处理。以5、4、4字节的大小进行读取。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527194317120.png" alt="image-20250527194317120"></p>
<p>以dex1.dex为例，按照这种方式进行读取的话，内容在破折号后面，记作a1、a2、a3——0x 01 00 00 00 5D、0x 00 40 00 00、0x 00 10 94 92。</p>
<p>a2：</p>
<p>之前将加密内容分成了：1.rc4解密数据，2.未加密数据；而在更早之前，我们在hook maps文件的时候，曾获得了一个解密的dex文件，经过搜索未加密数据，发现未加密数据在dex的偏移量刚好是a2。</p>
<p>以dex1.dex为例，dex1的a2是0x400000，那未加密数据的内容，在dex1.dex中需要移动到偏移量为0x400000的地方。</p>
<p>下图是dex1.dex。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527200812044.png" alt="image-20250527200812044"></p>
<p>下图是未加密数据。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527200828145.png" alt="image-20250527200828145"></p>
<p>而a3，代表着第2次解密的长度（尚未知道是什么算法）。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527201027621.png" alt="image-20250527201027621"></p>
<p>随后，发现了一个很关键的信息——sub_128D44的返回值是一个3级指针，指向着解密之后的dex。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527201458653.png" alt="image-20250527201458653"></p>
<p>而且，这个dex数据的首地址是0x6ffeae3000，一般mmap申请空间才会这么规整，按照0x1000对齐来给空间。</p>
<p>发现，sub_19b73c调用了mmap。</p>
<p>那咱可以尝试在mmap调用完后，获得申请的空间地址，然后对这部分空间下读写断点，同时打印调用栈。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_mmap</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libjiagu_64.so&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x19B81C</span>), &#123;</span><br><span class="line">        <span class="comment">// fd, buff, len</span></span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;mmap!&quot;</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>);</span><br><span class="line">            <span class="title class_">MemoryAccessMonitor</span>.<span class="title function_">enable</span>(</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">base</span>:<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>,</span><br><span class="line">                    <span class="attr">size</span>:<span class="number">30</span></span><br><span class="line">                &#125;,&#123;</span><br><span class="line">                    <span class="attr">onAccess</span>: <span class="keyword">function</span> (<span class="params">details</span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(details.<span class="property">operation</span>)</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">get_addr_in_so</span>(details.<span class="property">from</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_addr_in_so</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> process_Obj_Module_Arr = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; process_Obj_Module_Arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(addr&gt;process_Obj_Module_Arr[i].<span class="property">base</span> &amp;&amp; addr&lt;process_Obj_Module_Arr[i].<span class="property">base</span>.<span class="title function_">add</span>(process_Obj_Module_Arr[i].<span class="property">size</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> addr.<span class="title function_">toString</span>(<span class="number">16</span>)+<span class="string">&quot; is in &quot;</span>+process_Obj_Module_Arr[i].<span class="property">name</span>+<span class="string">&quot; offset: 0x&quot;</span>+(addr-process_Obj_Module_Arr[i].<span class="property">base</span>).<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> addr.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>脚本执行结果如下，可以发现调用了3次mmap，对应3个dex的映射，同时通过写断点，找到了是哪里在给这块内容进行写操作——0x18ebd4。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527202407163.png" alt="image-20250527202407163" style="zoom:80%;" />

<p>定位过来，在函数sub_18E8D0内部，这个函数十分大，第2次解密算法是自定义的算法，一般自定义算法，我会通过trace，通过汇编指令逐步还原解密法。——实习还没着落，不太想花时间在这，暂时先搁置吧。</p>
<p>可以猜到v15是基址，v4是游标，v28是解密后的内容。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527202610910.png" alt="image-20250527202610910" style="zoom:80%;" />

<p>最后写一个脚本，判断一下这里的v28是不是解密后的dex。</p>
<img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527205949901.png" alt="image-20250527205949901" style="zoom:80%;" />

<p>还不是dex的魔数？但发现：a1 a0 bd cf f5 f6 fd c5与c5进行异或后。</p>
<p><img src="https://raw.githubusercontent.com/X14Nuy/Picture-Bed/master/img/image-20250527210536218.png" alt="image-20250527210536218"></p>
<p>原来还有一步异或。</p>
<h2 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h2><p>很感谢有这样的大佬愿意分享技术博客，光是复现就学到很多了，谢谢！</p>
<p>从我自己的角度来说，这一次分析360免费壳真是学到了很多，不仅对动态链接的流程更加深刻了，同时开阔了眼界——还能这么玩？</p>
<p>在复现的时候，对于主so的还原，我还有些思路，就算没思路了还可以看看大佬的博客；但在主dex的还原时，明显感觉到，我的分析缺乏目的性，虽然看了大佬的博客会有思路，但很多时候还是踩在巨人的肩膀上，我很难想象要是从头自己分析，要分析得有多崩溃（可能我太菜了吧）。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>数字壳的加固方案：壳DEX-&gt;壳ELF-&gt;主ELF-&gt;主DEX——具体的加固方式在上面的内容中。</li>
<li>反调使用了sscanf解读maps文件，读取相应字段对frida进行检测，这算是常规操作了。</li>
</ol>
<h2 id="不足之处"><a href="#不足之处" class="headerlink" title="不足之处"></a>不足之处</h2><p>1.学习如何写JEB脚本，oacia师傅写了一个JEB解密脚本，可以简单学习一下。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.client.api <span class="keyword">import</span> IScript, IconType, ButtonGroupType</span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.core <span class="keyword">import</span> RuntimeProjectUtil</span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.core.units.code.java <span class="keyword">import</span> IJavaSourceUnit</span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.core.units.code <span class="keyword">import</span> ICodeUnit, ICodeItem</span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.core.output.text <span class="keyword">import</span> ITextDocument</span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.core.units.code.java <span class="keyword">import</span> IJavaSourceUnit, IJavaStaticField, IJavaNewArray, IJavaConstant, IJavaCall, IJavaField, IJavaMethod, IJavaClass</span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.core.events <span class="keyword">import</span> JebEvent, J</span><br><span class="line"><span class="keyword">from</span> com.pnfsoftware.jeb.core.util <span class="keyword">import</span> DecompilerHelper</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解密字符串函数的类名以及方法名</span></span><br><span class="line">methodName = [<span class="string">&#x27;Lcom/qihoo/util/a;&#x27;</span>, <span class="string">&#x27;a&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">dec_str_360jiagu</span>(<span class="title class_ inherited__">IScript</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, ctx</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;start deal with strings&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.ctx = ctx</span><br><span class="line">        engctx = ctx.getEnginesContext()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> engctx:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Back-end engines not initialized&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        projects = engctx.getProjects()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> projects:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;There is no opened project&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        units = RuntimeProjectUtil.findUnitsByType(projects[<span class="number">0</span>], IJavaSourceUnit, <span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">for</span> unit <span class="keyword">in</span> units:</span><br><span class="line">            javaClass = unit.getClassElement()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[+] decrypt:&#x27;</span> + javaClass.getName())</span><br><span class="line">            <span class="variable language_">self</span>.cstbuilder = unit.getFactories().getConstantFactory()</span><br><span class="line">            <span class="variable language_">self</span>.processClass(javaClass)</span><br><span class="line">            unit.notifyListeners(JebEvent(J.UnitChange))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Done.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">processClass</span>(<span class="params">self, javaClass</span>):</span><br><span class="line">        <span class="keyword">if</span> javaClass.getName() == methodName[<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">for</span> method <span class="keyword">in</span> javaClass.getMethods():</span><br><span class="line">            block = method.getBody()</span><br><span class="line">            i = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> i &lt; block.size():</span><br><span class="line">                stm = block.get(i)</span><br><span class="line">                <span class="variable language_">self</span>.checkElement(block, stm)</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">checkElement</span>(<span class="params">self, parent, e</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(e, IJavaCall):</span><br><span class="line">                mmethod = e.getMethod()</span><br><span class="line">                mname = mmethod.getName()</span><br><span class="line">                msig = mmethod.getSignature()</span><br><span class="line">                <span class="keyword">if</span> mname == methodName[<span class="number">1</span>] <span class="keyword">and</span> methodName[<span class="number">0</span>] <span class="keyword">in</span> msig:</span><br><span class="line">                    v = []</span><br><span class="line">                    <span class="keyword">for</span> arg <span class="keyword">in</span> e.getArguments():</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">isinstance</span>(arg, IJavaConstant):</span><br><span class="line">                            v.append(arg.getString())</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(v) == <span class="number">1</span>:</span><br><span class="line">                        decstr = <span class="variable language_">self</span>.decryptstring(v[<span class="number">0</span>])</span><br><span class="line">                        parent.replaceSubElement(e, <span class="variable language_">self</span>.cstbuilder.createString(decstr))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> subelt <span class="keyword">in</span> e.getSubElements():</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(subelt, IJavaClass) <span class="keyword">or</span> <span class="built_in">isinstance</span>(subelt, IJavaField) <span class="keyword">or</span> <span class="built_in">isinstance</span>(subelt, IJavaMethod):</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="variable language_">self</span>.checkElement(e, subelt)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;error&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decryptstring</span>(<span class="params">self, string</span>):</span><br><span class="line">        src = []</span><br><span class="line">        <span class="keyword">for</span> index, char <span class="keyword">in</span> <span class="built_in">enumerate</span>(string):</span><br><span class="line">            src.append(<span class="built_in">chr</span>(<span class="built_in">ord</span>(char) ^ <span class="number">16</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(src).decode(<span class="string">&#x27;unicode_escape&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>2.根据大佬的博客，在attachBaseContexr中会加载DtcLoader类，jeb中没显示出来，而在jadx中显示了，这是如何做到的？这个DtcLoader做了什么？</p>
<p>3.onCreate的vmp没分析。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="noopener" href="https://oacia.dev/360-jiagu/">https://oacia.dev/360-jiagu/</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%94%B6%E8%8E%B7%E9%A2%87%E5%A4%9Ahhh/" rel="tag"># 收获颇多hhh</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/05/21/%E6%9F%90%E5%92%96%E5%95%A1app%E5%8D%8F%E8%AE%AE%E5%AD%97%E6%AE%B5%E5%88%86%E6%9E%90%E2%80%94%E2%80%94sign%E3%80%81q/" rel="prev" title="某咖啡app协议字段分析——sign、q">
                  <i class="fa fa-angle-left"></i> 某咖啡app协议字段分析——sign、q
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/05/27/baidu%E5%85%8D%E8%B4%B9%E5%A3%B3%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/" rel="next" title="baidu免费壳分析复现">
                  baidu免费壳分析复现 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">X14Nuy</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">489k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">14:50</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
